!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).web=e()}(this,(function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function t(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{c(r.next(t))}catch(t){o(t)}}function a(t){try{c(r.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((r=r.apply(t,e||[])).next())}))}const e=(t,e)=>{let n=!1;return window.glue.contexts.subscribe(t,(t,r,i,o,s)=>{if(!n)return void(n=!0);s.updaterId===window.glue.interop.instance.instance||e(t,r,i,o,s)})},n=()=>t(void 0,void 0,void 0,(function*(){const t=yield window.glue.channels.all();return yield Promise.all(t.map(t=>window.glue.channels.get(t)))})),r=t=>0===Object.keys(t).length&&t.constructor===Object,i=!navigator.userAgent.toLowerCase().includes(" electron/"),o=t=>({unsubscribe(){t?"function"==typeof t?t():t.then(t=>t()):console.error("Could not unsubscribe!")}});class s{constructor(t){this.type="system",this.id=t.name,this.displayMetadata=t.meta}broadcast(t){return window.glue.channels.publish(t,this.id)}getCurrentContext(e){return t(this,void 0,void 0,(function*(){const t=yield window.glue.channels.get(this.id),{data:n}=t;return e?n&&n.type===e?n:null:n}))}addContextListener(t,e){const n=2===arguments.length&&t,r=2===arguments.length?e:t,i=window.glue.channels.subscribeFor(this.id,t=>{n?(null==t?void 0:t.type)===n&&r(t):r(t)});return{unsubscribe(){i.then(t=>t())}}}join(){return window.glue.channels.join(this.id)}leave(){return window.glue.channels.leave()}}class a{constructor(t){this.id=t,this.type="app"}broadcast(t){return window.glue.contexts.update(this.id,t)}getCurrentContext(e){return t(this,void 0,void 0,(function*(){const t=yield window.glue.contexts.get(this.id),{data:n}=t;return e?n&&n.type===e?n:null:n}))}addContextListener(t,n){const r=2===arguments.length&&t,i=2===arguments.length?n:t,o=e(this.id,t=>{r?(null==t?void 0:t.type)===r&&i(t):i(t)});return{unsubscribe:()=>{o.then(t=>t())}}}}const c=()=>{let c,u;const d={};let p=[];const h=e=>t(void 0,void 0,void 0,(function*(){return(yield window.glue.contexts.all()).some(t=>t===e)})),f=t=>!!t&&p.some(e=>e===t.id),l=t=>new a(t),v=t=>{void 0!==t&&I(d[t])},y=(t,e)=>{let n=()=>{u=null};return u={contextType:t,handler:e,setActualUnsub:t=>{n=t}},{unsubscribe:n}},g=t(void 0,void 0,void 0,(function*(){yield window.gluePromise,(yield n()).map(t=>{d[t.name]=new s(t)}),p=yield window.glue.channels.all();const t=yield window.glue.channels.current();i||(t&&v(t),window.glue.channels.changed(t=>{v(t)}))})),m=()=>t(void 0,void 0,void 0,(function*(){yield g;return p.map(t=>d[t])})),w=e=>t(void 0,void 0,void 0,(function*(){yield g;return(yield h(e))||(yield(e=>t(void 0,void 0,void 0,(function*(){yield window.glue.contexts.set(e,null)})))(e)),l(e)})),b=()=>t(void 0,void 0,void 0,(function*(){f(c)&&(yield c.leave())}));function _(t,n){const i=2===arguments.length&&t,s=2===arguments.length?n:t;if(!c){console.warn("You will start receiving broadcasts only after you join a channel !");const t=y(i,s);return window.gluePromise.then(()=>window.glue.windows.my().getContext()).then(t=>{r(t)||s(t)}),t}const{id:a,type:u}=c,d=t=>"system"===u?window.glue.channels.subscribe(t):e(a,t),p=t=>{i?t.type===i&&s(t):s(t)},h=d(p);return o(h)}const I=t=>{if(c=t,u){const{contextType:t,handler:e,setActualUnsub:n}=u;n(_(t,e).unsubscribe),u=null}};return{getSystemChannels:m,getOrCreateChannel:e=>t(void 0,void 0,void 0,(function*(){const t=(yield m()).find(t=>t.id===e);return void 0===t?w(e):t})),joinChannel:e=>t(void 0,void 0,void 0,(function*(){yield g;const n=d[e]||(yield(e=>t(void 0,void 0,void 0,(function*(){if(yield g,!(yield h(e)))throw new Error("NoChannelFound");const t=l(e);return d[e]=t,t})))(e));if(!n)throw new Error("NoChannelFound");f(n)?n.join():yield b(),I(n)})),getCurrentChannel:()=>t(void 0,void 0,void 0,(function*(){return yield g,c})),leaveCurrentChannel:()=>t(void 0,void 0,void 0,(function*(){yield g,yield b(),c=null})),broadcast:e=>t(void 0,void 0,void 0,(function*(){if(yield g,!c)return void console.error("You must join a channel first.");const{id:t,type:n}=c;"system"===n?window.glue.channels.publish(e):window.glue.contexts.update(t,e)})),addContextListener:_}},u=t=>{const{name:e,handlers:n}=t,r=n.filter(t=>"app"===t.type),i=n.filter(t=>"instance"===t.type&&!r.some(e=>e.applicationName===t.applicationName)),o=[...r,...i];return{intent:{name:e,displayName:n[0].displayName||""},apps:o.map(t=>{const e=t.applicationName,n=window.glue.appManager.application(e);return{name:e,title:t.applicationTitle||t.instanceTitle||e,tooltip:n.userProperties.tooltip||`${e} (${t.type})`,description:t.applicationDescription,icons:t.applicationIcon?[t.applicationIcon,...n.userProperties.icons||[]]:n.userProperties.icons,images:n.userProperties.images}})}},d=()=>({open:(...e)=>t(void 0,void 0,void 0,(function*(){return yield window.gluePromise,((e,n)=>t(void 0,void 0,void 0,(function*(){const t=window.glue.appManager.application(e);if(!t)throw new Error("AppNotFound");try{yield t.start(n)}catch(t){}})))(...e)})),findIntent:(...e)=>t(void 0,void 0,void 0,(function*(){return yield window.gluePromise,((e,n)=>t(void 0,void 0,void 0,(function*(){if("string"!=typeof e)throw new Error("Please provide the intent as a string!");if(void 0!==n&&"string"!=typeof n.type)throw new Error("Please provide the context.type as a string!");const t=yield window.glue.intents.find({name:e,contextType:null==n?void 0:n.type});if(void 0!==t&&0===t.length)throw new Error("NoAppsFound");return u(t[0])})))(...e)})),findIntentsByContext:(...e)=>t(void 0,void 0,void 0,(function*(){return yield window.gluePromise,(e=>t(void 0,void 0,void 0,(function*(){if(void 0!==e&&"string"!=typeof e.type)throw new Error("Please provide the context.type as a string!");const t=yield window.glue.intents.find({contextType:e.type});if(void 0!==t&&0===t.length)throw new Error("NoAppsFound");return t.map(t=>u(t))})))(...e)})),raiseIntent:(...e)=>t(void 0,void 0,void 0,(function*(){return yield window.gluePromise,((e,n,r)=>t(void 0,void 0,void 0,(function*(){if("string"!=typeof e)throw new Error("Please provide the intent as a string!");if(void 0!==n&&"string"!=typeof n.type)throw new Error("Please provide the context.type as a string!");if(void 0!==r&&"string"!=typeof r)throw new Error("Please provide the target as a string!");let t="reuse";if(void 0!==r){const e=window.glue.appManager.application(r);if(void 0===e)throw new Error(`Application ${r} not found.`);const n=e.instances;t=0===n.length?{app:r}:{instance:n[0].id}}const i=yield window.glue.intents.raise({intent:e,context:n,target:t});return{source:i.handler.applicationName,version:"1.0.0",data:i.result}})))(...e)})),addIntentListener:(t,e)=>{if("string"!=typeof t)throw new Error("Please provide the intent as a string!");if("function"!=typeof e)throw new Error("Please provide the handler as a function!");const n={unsubscribe:()=>console.error("Could not unsubscribe!")};return window.gluePromise.then(()=>{n.unsubscribe=window.glue.intents.addIntentListener(t,e).unsubscribe}),n}});
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */
var p=function(t,e){return(p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function h(t,e){function n(){this.constructor=t}p(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var f=function(){return(f=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function l(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{c(r.next(t))}catch(t){o(t)}}function a(t){try{c(r.throw(t))}catch(t){o(t)}}function c(t){t.done?i(t.value):new n((function(e){e(t.value)})).then(s,a)}c((r=r.apply(t,e||[])).next())}))}function v(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var y=function(t,e){return(y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function g(t,e){function n(){this.constructor=t}y(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var m=function(){return(m=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function w(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{c(r.next(t))}catch(t){o(t)}}function a(t){try{c(r.throw(t))}catch(t){o(t)}}function c(t){t.done?i(t.value):new n((function(e){e(t.value)})).then(s,a)}c((r=r.apply(t,e||[])).next())}))}function b(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function _(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r}var I=1,S=2,x=3,k=4;function C(t){return t.type===x?"timestamp":t.type===S?"number":t.type===I?"string":t.type===k?"object":"unknown"}function A(t){return t.constructor===Date?"timestamp":"number"==typeof t?"number":"string"==typeof t?"string":"object"==typeof t?"object":"string"}function T(t){var e={},n=C(t);if("object"===n){var r=Object.keys(t.value).reduce((function(e,n){var r=A(t.value[n]);if("object"===r){var i=function t(e){return Object.keys(e).reduce((function(n,r){var i=A(e[r]);return n[r]="object"===i?{type:"object",description:"",context:{},composite:t(e[r])}:{type:i,description:"",context:{}},n}),{})}(t.value[n]);e[n]={type:"object",description:"",context:{},composite:i}}else e[n]={type:r,description:"",context:{}};return e}),{});e.composite=r}return e.name=P(t.path.join("/")+"/"+t.name),e.type=n,e.description=t.description,e.context={},e}function P(t){return void 0!==t&&t.length>0&&"/"!==t[0]?"/"+t:t}function M(t){return"timestamp"===C(t)?Date.now():function t(e){if("object"!=typeof e)return e;return Object.keys(e).reduce((function(n,r){var i=e[r];return"object"==typeof i&&i.constructor!==Date?n[r]=t(i):i.constructor===Date?n[r]=new Date(i).getTime():i.constructor===Boolean?n[r]=i.toString():n[r]=i,n}),{})}(t.value)}function j(t){var e=function t(e){return e.reduce((function(e,n){return e.concat(Array.isArray(n)?t(n):n)}),[])}(t.root.getAggregateState()),n=e.sort((function(t,e){return t.state?e.state?e.state-t.state:-1:1}))[0];return{description:function(t){var e="";return t.forEach((function(t,n,r){var i=t.path.join(".");n===r.length-1?e+=i+"."+t.name+": "+t.description:e+=i+"."+t.name+": "+t.description+","})),e.length>100?e.slice(0,100)+"...":e}(e),value:n.state}}var E=function(t,e,n){if(null===t||"object"!=typeof t)throw new Error("Missing definition");if(null===e||"object"!=typeof e)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")},O=function(){function t(t,e,n,r,i){this.definition=t,this.system=e,this.transport=n,this.value=r,this.type=i,this.path=[],E(t,e,n),this.path=e.path.slice(0),this.path.push(e.name),this.name=t.name,this.description=t.description,n.createMetric(this)}return Object.defineProperty(t.prototype,"repo",{get:function(){var t;return null===(t=this.system)||void 0===t?void 0:t.repo},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),t.prototype.update=function(t){return this.value=t,this.transport.updateMetric(this)},t}(),R=function(t){function e(e,n,r,i){return t.call(this,e,n,r,i,S)||this}return g(e,t),e.prototype.incrementBy=function(t){this.update(this.value+t)},e.prototype.increment=function(){this.incrementBy(1)},e.prototype.decrement=function(){this.incrementBy(-1)},e.prototype.decrementBy=function(t){this.incrementBy(-1*t)},e}(O),N=function(t){function e(e,n,r,i){return t.call(this,e,n,r,i,k)||this}return g(e,t),e.prototype.update=function(t){return this.mergeValues(t),this.transport.updateMetric(this)},e.prototype.mergeValues=function(t){var e=this;return Object.keys(this.value).forEach((function(n){void 0!==t[n]&&(e.value[n]=t[n])}))},e}(O),L=function(t){function e(e,n,r,i){return t.call(this,e,n,r,i,I)||this}return g(e,t),e}(O),W=function(t){function e(e,n,r,i){return t.call(this,e,n,r,i,x)||this}return g(e,t),e.prototype.now=function(){this.update(new Date)},e}(O);var D=function(){function t(t,e){e.init(this),this.root=function t(e,n,r,i,o){if(!n)throw new Error("Repository is required");if(!r)throw new Error("Transport is required");var s,a,c=r,u=e,d=o||"",p=n,h=i,f=function t(e){if(!e||!e.parent)return[];var n=t(e.parent);return n.push(e.name),n}(i),l={},v=(a="/",((s=f)&&s.length>0?s.join(a):"")+e),y=n.root,g=[],m=[];function w(t,e,n,r){var i={name:""};i="string"==typeof t?{name:t}:t;var o=m.filter((function(t){return t.name===i.name}));if(o.length>0){var s=o[0];if(s.type!==e)throw new Error("A metric named "+i.name+" is already defined with different type.");return void 0!==n&&s.update(n).catch((function(){})),s}var a=r(i);return m.push(a),a}var b={get name(){return u},get description(){return d},get repo(){return p},get parent(){return h},path:f,id:v,root:y,get subSystems(){return g},get metrics(){return m},subSystem:function(e,n){if(!e||0===e.length)throw new Error("name is required");var r=g.filter((function(t){return t.name===e}));if(r.length>0)return r[0];var i=t(e,p,c,b,n);return g.push(i),i},getState:function(){return l},setState:function(t,e){l={state:t,description:e},c.updateSystem(b,l)},stringMetric:function(t,e){return w(t,I,e,(function(t){return new L(t,b,c,e)}))},timestampMetric:function(t,e){return w(t,x,e,(function(t){return new W(t,b,c,e)}))},objectMetric:function(t,e){return w(t,k,e,(function(t){return new N(t,b,c,e)}))},numberMetric:function(t,e){return w(t,S,e,(function(t){return new R(t,b,c,e)}))},getAggregateState:function(){var t=[];return Object.keys(l).length>0&&t.push({name:u,path:f,state:l.state,description:l.description}),g.forEach((function(e){var n=e.getAggregateState();n.length>0&&t.push.apply(t,n)})),t}};return c.createSystem(b),b}("",this,e),this.addSystemMetrics(this.root,t.clickStream||void 0===t.clickStream)}return t.prototype.addSystemMetrics=function(t,e){if("undefined"!=typeof navigator&&t.stringMetric("UserAgent",navigator.userAgent),e&&"undefined"!=typeof document){var n=t.subSystem("ClickStream"),r=function(t){if(t.target){var e=t.target;n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:t.target?e.className:"",id:e.id,type:"<"+e.tagName.toLowerCase()+">",href:e.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",r):document.attachEvent("onclick",r)}t.stringMetric("StartTime",(new Date).toString());var i=t.stringMetric("StartURL",""),o=t.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;i.update(s)}void 0!==window.glue42gd&&o.update(window.glue42gd.appName)}},t}(),F=function(){function t(){}return t.prototype.init=function(t){},t.prototype.createSystem=function(t){return Promise.resolve()},t.prototype.updateSystem=function(t,e){return Promise.resolve()},t.prototype.createMetric=function(t){return Promise.resolve()},t.prototype.updateMetric=function(t){return Promise.resolve()},t}(),B=function(){function t(t,e,n){this.api=t,this.lastCount=0,this.initialPublishTimeout=1e4,this.publishInterval=6e4,this.initialPublishTimeout=null!=e?e:this.initialPublishTimeout,this.publishInterval=null!=n?n:this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}return t.prototype.scheduleCollection=function(){var t=this;setTimeout((function(){t.collect(),setInterval((function(){t.collect()}),t.publishInterval)}),this.initialPublishTimeout)},t.prototype.collect=function(){try{this.collectMemory(),this.collectEntries()}catch(t){}},t.prototype.collectMemory=function(){var t=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:t.totalJSHeapSize,usedJSHeapSize:t.usedJSHeapSize}))},t.prototype.collectEntries=function(){var t=window.performance.getEntries();t.length<=this.lastCount||(this.lastCount=t.length,this.system.stringMetric("entries",JSON.stringify(t)))},t}(),q=function(t){var e;e=t.connection&&"object"==typeof t.connection?function(t,e){var n,r,i=this;if(!t||"object"!=typeof t)throw new Error("Connection is required parameter");var o=function(t){s(t.root)},s=function(t){a(t),t.metrics.forEach((function(t){c(t)})),t.subSystems.forEach((function(t){s(t)}))},a=function(t){return w(i,void 0,void 0,(function(){var e,i;return b(this,(function(o){switch(o.label){case 0:return void 0===t.parent?[2]:[4,n];case 1:return o.sent(),e={name:P(t.path.join("/")+"/"+t.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}},i={type:"define",metrics:[e]},r.send(i),[2]}}))}))},c=function(t){return w(i,void 0,void 0,(function(){var e,i,o;return b(this,(function(s){switch(s.label){case 0:return e=d(t),[4,n];case 1:return s.sent(),i=T(e),o={type:"define",metrics:[i]},r.send(o),void 0!==e.value&&u(e),[2]}}))}))},u=function(t){if(p()){var e=M(t),n={type:"publish",values:[{name:P(t.path.join("/")+"/"+t.name),value:e,timestamp:Date.now()}]};return r.send(n)}return Promise.resolve()},d=function(t){var e=m({},t);return"object"==typeof t.value&&null!==t.value&&(e.value=m({},t.value)),e},p=function(){var t;try{return(null!==(t=e.canUpdateMetric)&&void 0!==t?t:function(){return!0})()}catch(t){return!0}};return{init:function(i){var s;n=new Promise((function(t){s=t})),(r=t.domain("metrics")).onJoined((function(t){!t&&s&&(s(),s=void 0);var e={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};r.send(e),t&&o(i)})),r.join({system:e.system,service:e.service,instance:e.instance})},createSystem:a,updateSystem:function(e,o){return w(i,void 0,void 0,(function(){var i,s,a;return b(this,(function(c){switch(c.label){case 0:return[4,n];case 1:return c.sent(),i={type:"publish",values:[{name:P(e.path.join("/")+"/"+e.name+"/State"),value:{Description:o.description,Value:o.state},timestamp:Date.now()}]},r.send(i),s=j(e),a={type:"publish",peer_id:t.peerId,values:[{name:"/State",value:{Description:s.description,Value:s.value},timestamp:Date.now()}]},r.send(a),[2]}}))}))},createMetric:c,updateMetric:function(t){return w(i,void 0,void 0,(function(){var e;return b(this,(function(r){switch(r.label){case 0:return e=d(t),[4,n];case 1:return r.sent(),u(e),[2]}}))}))}}}(t.connection,t):new F;var n=new D(t,e).root;t.disableAutoAppSystem||(n=n.subSystem("App"));var r=function(t){var e,n=t.subSystem("reporting"),r={name:"features"},i=function(t,i,o){if(void 0===t||""===t)throw new Error("name is mandatory");if(void 0===i||""===i)throw new Error("action is mandatory");if(void 0===o||""===o)throw new Error("payload is mandatory");e?e.update({name:t,action:i,payload:o}):e=n.objectMetric(r,{name:t,action:i,payload:o})};return t.featureMetric=i,t}(n);return function(t,e){var n,r;if("undefined"==typeof window)return;var i=null===(r=null===(n=null===window||void 0===window?void 0:window.glue42gd)||void 0===n?void 0:n.metrics)||void 0===r?void 0:r.pagePerformanceMetrics;i&&(e=i);(null==e?void 0:e.enabled)&&new B(t,e.initialPublishTimeout,e.publishInterval)}(r,t.pagePerformanceMetrics),r};function G(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function r(n,r){var i=n instanceof Error?n:new Error(n);if(e)e(i);else{var o='[ERROR] callback-registry: User callback for key "'+r+'" failed: '+i.stack;if(t)switch(t.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(t,e,i){var o=n[t];return o||(o=[],n[t]=o),o.push(e),i&&setTimeout((function(){i.forEach((function(i){var o;if(null===(o=n[t])||void 0===o?void 0:o.includes(e))try{Array.isArray(i)?e.apply(void 0,i):e.apply(void 0,[i])}catch(e){r(e,t)}}))}),0),function(){var r=n[t];r&&(r=r.reduce((function(t,n,r){return n===e&&t.length===r||t.push(n),t}),[]),n[t]=r)}},execute:function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var o=n[t];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var i=n.apply(void 0,e);s.push(i)}catch(e){s.push(void 0),r(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}G.default=G;var H=G,U=function(){function t(t,e){var n=this;this.registry=H(),this.gw=t.facade,this.gw.connect((function(t,e){n.messageHandler(e)})).then((function(t){n.client=t}))}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.client?(this.client.send(t),Promise.resolve(void 0)):Promise.reject("not connected")},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"in-memory"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),V=function(){function t(t,e){var n=this;this.logger=e,this.registry=H(),this.worker=new SharedWorker(t),this.worker.port.onmessage=function(t){n.messageHandler(t.data)}}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.worker.port.postMessage(t),Promise.resolve()},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"shared-worker"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),J=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?void 0:t}},t.isNode=function(){if(void 0!==t._isNode)return t._isNode;if("undefined"!=typeof window)return t._isNode=!1,!1;try{t._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(e){t._isNode=!1}return t._isNode},t}(),z=function(){function t(){var t=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(e,n){t.resolve=function(n){t.resolved=!0,e(n)},t.reject=function(e){t.rejected=!0,n(e)}}))}return t.delay=function(t){return new Promise((function(e){return setTimeout(e,t)}))},Object.defineProperty(t.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),t}(),K={};function Y(t){var e=K[t];if(e)return e;var n=[];function r(){return(new Date).getTime()}var i,o,s=r();function a(t,e){var i=null!=e?e:r(),o=0;n.length>0&&(o=i-n[n.length-1].time),n.push({name:t,time:i,diff:o})}a("start",s);var c={get startTime(){return s},get endTime(){return i},get period(){return o},stop:function(){return a("end",i=r()),o=i-s},mark:a,marks:n};return K[t]=c,c}var Z=J.isNode()?require:function(){},X=J.isNode()?Z("ws"):window.WebSocket,$=function(){function t(t,e){if(this.startupTimer=Y("connection"),this._running=!0,this._registry=H(),this.wsRequests=[],this.settings=t,this.logger=e,!this.settings.ws)throw new Error("ws is missing")}return t.prototype.onMessage=function(t){return this._registry.add("onMessage",t)},t.prototype.send=function(t,e){var n=this;return new Promise((function(e,r){n.waitForSocketConnection((function(){var i;try{null===(i=n.ws)||void 0===i||i.send(t),e()}catch(t){r(t)}}),r)}))},t.prototype.open=function(){var t=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(e,n){t.waitForSocketConnection(e,n)}))},t.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},t.prototype.onConnectedChanged=function(t){return this._registry.add("onConnectedChanged",t)},t.prototype.name=function(){return"ws "+this.settings.ws},t.prototype.reconnect=function(){var t;null===(t=this.ws)||void 0===t||t.close();var e=new z;return this.waitForSocketConnection((function(){e.resolve()})),e.promise},t.prototype.waitForSocketConnection=function(t,e){var n;e=null!=e?e:function(){},this._running?1!==(null===(n=this.ws)||void 0===n?void 0:n.readyState)?(this.wsRequests.push({callback:t,failed:e}),this.wsRequests.length>1||this.openSocket()):t():e("wait for socket on "+this.settings.ws+" failed - socket closed by user")},t.prototype.openSocket=function(t,e){return w(this,void 0,void 0,(function(){var n=this;return b(this,(function(r){switch(r.label){case 0:if(this.startupTimer.mark("opening-socket"),void 0===t&&(t=this.settings.reconnectInterval),void 0!==e){if(0===e)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+e+" more times (every "+t+" ms)")}r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return r.sent(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState(),[3,4];case 3:return r.sent(),setTimeout((function(){var r=void 0===e?void 0:e-1;n.openSocket(t,r)}),t),[3,4];case 4:return[2]}}))}))},t.prototype.initiateSocket=function(){var t=this,e=new z;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new X(this.settings.ws||""),this.ws.onerror=function(n){var r="";try{r=JSON.stringify(n)}catch(t){var i=new WeakSet;r=JSON.stringify(n,(function(t,e){if("object"==typeof e&&null!==e){if(i.has(e))return;i.add(e)}return e}))}e.reject("error"),t.notifyStatusChanged(!1,r)},this.ws.onclose=function(n){t.logger.info("ws closed "+n),e.reject("closed"),t.notifyStatusChanged(!1)},this.ws.onopen=function(){var n;t.startupTimer.mark("ws-opened"),t.logger.info("ws opened "+(null===(n=t.settings.identity)||void 0===n?void 0:n.application)),e.resolve(),t.notifyStatusChanged(!0)},this.ws.onmessage=function(e){t._registry.execute("onMessage",e.data)},e.promise},t.prototype.notifyForSocketState=function(t){this.wsRequests.forEach((function(e){t?e.failed&&e.failed(t):e.callback()})),this.wsRequests=[]},t.prototype.notifyStatusChanged=function(t,e){this._registry.execute("onConnectedChanged",t,e)},t}();var Q=1;var tt,et,nt,rt={nextValue:function(){return(Q=(9301*Q+49297)%233280)/233280},seed:function(t){Q=t}},it="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function ot(){nt=!1}function st(t){if(t){if(t!==tt){if(t.length!==it.length)throw new Error("Custom alphabet for shortid must be "+it.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+it.length+" unique characters. These characters were not unique: "+e.join(", "));tt=t,ot()}}else tt!==it&&(tt=it,ot())}function at(){return nt||(nt=function(){tt||st(it);for(var t,e=tt.split(""),n=[],r=rt.nextValue();e.length>0;)r=rt.nextValue(),t=Math.floor(r*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var ct={characters:function(t){return st(t),tt},seed:function(t){rt.seed(t),et!==t&&(ot(),et=t)},lookup:function(t){return at()[t]},shuffled:at},ut="object"==typeof window&&(window.crypto||window.msCrypto);var dt=function(){if(!ut||!ut.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return ut.getRandomValues(t),48&t[0]};var pt=function(t,e){for(var n,r=0,i="";!n;)i+=t(e>>4*r&15|dt()),n=e<Math.pow(16,r+1),r++;return i};var ht=function(t){var e=ct.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var ft=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=ct.characters(),n=t.length,r=0;r<n;r++)if(-1===e.indexOf(t[r]))return!1;return!0},lt=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e,n,r=0;function i(){var t="",i=Math.floor(.001*(Date.now()-1459707606518));return i===n?e++:(e=0,n=i),t+=pt(ct.lookup,6),t+=pt(ct.lookup,r),e>0&&(t+=pt(ct.lookup,e)),t+=pt(ct.lookup,i)}t.exports=i,t.exports.generate=i,t.exports.seed=function(e){return ct.seed(e),t.exports},t.exports.worker=function(e){return r=e,t.exports},t.exports.characters=function(t){return void 0!==t&&ct.characters(t),ct.shuffled()},t.exports.decode=ht,t.exports.isValid=ft})),vt=(lt.generate,lt.seed,lt.worker,lt.characters,lt.decode,lt.isValid,lt);function yt(t,e,n,r,i){null==t&&(t="global"),r=r||["success"],i=i||["error"];var o,s=!1,a=!1,c=!1,u=H();e.disconnected((function(){c=!1,n.debug("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),e.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),p(o))})),e.on("success",(function(t){return f(t)})),e.on("error",(function(t){return h(t)})),e.on("result",(function(t){return f(t)})),r&&r.forEach((function(t){e.on(t,(function(t){return f(t)}))})),i&&i.forEach((function(t){e.on(t,(function(t){return h(t)}))}));var d={};function p(e){return o=e,new Promise((function(r,i){if(s)r();else{var o;if("global"===t)o=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining domain "+t),o=v({type:"join",destination:t,domain:"global",options:e});o.then((function(){!function(){n.debug("did join "+t),s=!0;var e=a;a=!1,u.execute("onJoined",e)}(),r()})).catch((function(e){n.debug("error joining "+t+" domain: "+JSON.stringify(e)),i(e)}))}}))}function h(e){if(t===e.domain){var n=e.request_id;if(n){var r=d[n];r&&r.error(e)}}}function f(e){if(e.domain===t){var n=e.request_id;if(n){var r=d[n];r&&r.success(e)}}}function l(){return vt()}function v(r,i,o){o=o||{},r.request_id=r.request_id||l(),r.domain=r.domain||t,o.skipPeerId||(r.peer_id=e.peerId);var s=r.request_id;return new Promise((function(t,a){d[s]={success:function(e){delete d[s],e._tag=i,t(e)},error:function(t){n.warn("GW error - "+JSON.stringify(t)+" for request "+JSON.stringify(r)),delete d[s],t._tag=i,a(t)}},e.send(r,o).catch((function(t){d[s].error({err:t})}))}))}return{join:p,leave:function(){return"global"===t?Promise.resolve():(n.debug("stopping session "+t+"..."),a=!1,v({type:"leave",destination:t,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})))},onJoined:function(t){return s&&t(!1),u.add("onJoined",t)},onLeft:function(t){return s||t(),u.add("onLeft",t)},send:v,sendFireAndForget:function(n){n.request_id=n.request_id?n.request_id:l(),n.domain=n.domain||t,n.peer_id=e.peerId,e.send(n)},on:function(r,i){e.on(r,(function(e){if(e.domain===t)try{i(e)}catch(t){n.error("Callback  failed: "+t+" \n "+t.stack+" \n msg was: "+JSON.stringify(e),t)}}))},loggedIn:function(t){return e.loggedIn(t)},connected:function(t){return e.connected(t)},disconnected:function(t){return e.disconnected(t)},get peerId(){return e.peerId},get domain(){return t}}}var gt=function(){function t(t,e,n){var r=this;this.connection=t,this.settings=e,this.logger=n,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=H(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],t.disconnected((function(){r.handleDisconnected()})),this.ping()}return Object.defineProperty(t.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.processStringMessage=function(t){var e=this,n=JSON.parse(t,(function(t,n){if("string"!=typeof n)return n;if(n.length<e.dateMinLen)return n;if(n[0]!==e.datePrefixFirstChar)return n;if(n.substring(0,e.datePrefixLen)!==e.datePrefix)return n;try{var r=parseInt(n.substring(e.datePrefixLen,n.length),10);return isNaN(r)?n:new Date(r)}catch(t){return n}}));return{msg:n,msgType:n.type}},t.prototype.createStringMessage=function(t){var e=Date.prototype.toJSON;try{var n=this.datePrefix;return Date.prototype.toJSON=function(){return n+this.getTime()},JSON.stringify(t)}finally{Date.prototype.toJSON=e}},t.prototype.processObjectMessage=function(t){if(!t.type)throw new Error("Object should have type property");return{msg:t,msgType:t.type}},t.prototype.createObjectMessage=function(t){return t},t.prototype.login=function(t,e){return w(this,void 0,void 0,(function(){var n,r,i,o,s,a,c,u,d,p;return b(this,(function(h){switch(h.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=t,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,n={},this.connection.gatewayToken=t.gatewayToken,!t.gatewayToken)return[3,5];if(!e)return[3,4];h.label=1;case 1:return h.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return u=h.sent(),t.gatewayToken=u,[3,4];case 3:return r=h.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==r?void 0:r.message)||r)),[3,4];case 4:return n.method="gateway-token",n.token=t.gatewayToken,this.connection.gatewayToken=t.gatewayToken,[3,10];case 5:return"sspi"!==t.flowName?[3,9]:(n.provider="win",n.method="access-token",t.flowCallback&&t.sessionId?(i=n,[4,t.flowCallback(t.sessionId,null)]):[3,7]);case 6:return i.token=h.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(t.token)n.method="access-token",n.token=t.token;else{if(!t.username)throw new Error("invalid auth message"+JSON.stringify(t));n.method="secret",n.login=t.username,n.secret=t.password}h.label=10;case 10:o={type:"hello",identity:this.settings.identity,authentication:n},t.sessionId&&(o.request_id=t.sessionId),this.globalDomain=yt("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),s={skipPeerId:!0},this.initialLogin&&(s.retryInterval=this.settings.reconnectInterval,s.maxRetries=this.settings.reconnectAttempts),h.label=11;case 11:h.trys.push([11,19,20,21]),a=void 0,h.label=12;case 12:return[4,this.globalDomain.send(o,void 0,s)];case 13:return"authentication-request"!==(c=h.sent()).type?[3,16]:(u=Buffer.from(c.authentication.token,"base64"),t.flowCallback&&t.sessionId?(d=o.authentication,[4,t.flowCallback(t.sessionId,u)]):[3,15]);case 14:d.token=h.sent().data.toString("base64"),h.label=15;case 15:return o.request_id=t.sessionId,[3,12];case 16:if("welcome"===c.type)return a=c,[3,18];throw"error"===c.type?new Error("Authentication failed: "+c.reason):new Error("Unexpected message type during authentication: "+c.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.info("login successful with peerId "+a.peer_id),this.connection.peerId=a.peer_id,this.connection.resolvedIdentity=a.resolved_identity,this.connection.availableDomains=a.available_domains,a.options&&(this.connection.token=a.options.access_token,this.connection.info=a.options.info),this.setLoggedIn(!0),[2,a.resolved_identity];case 19:throw p=h.sent(),this.logger.error("error sending hello message - "+(p.message||p.msg||p.reason||p),p),p;case 20:return t&&t.flowCallback&&t.sessionId&&t.flowCallback(t.sessionId,null),[7];case 21:return[2]}}))}))},t.prototype.logout=function(){return w(this,void 0,void 0,(function(){var t;return b(this,(function(e){switch(e.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),t=this.sessions.map((function(t){t.leave()})),[4,Promise.all(t)];case 1:return e.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this._isLoggedIn&&t(),this.registry.add("onLoggedIn",t)},t.prototype.domain=function(t,e,n,r){var i=this.sessions.filter((function(e){return e.domain===t}))[0];return i||(i=yt(t,this.connection,e,n,r),this.sessions.push(i)),i},t.prototype.handleDisconnected=function(){var t=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(t.handleDisconnected,1e3)}))}},t.prototype.setLoggedIn=function(t){this._isLoggedIn=t,this._isLoggedIn&&this.registry.execute("onLoggedIn")},t.prototype.ping=function(){var t=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){t.ping()}),3e4))},t.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(t){return t.token})):Promise.reject(new Error("no global domain session"))},t.prototype.getNewGWToken=function(){if(void 0!==typeof window){var t=window.glue42gd;if(t)return t.getGWToken()}return Promise.reject(new Error("not running in GD"))},t}(),mt=function(){function t(t){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var e=0,n=t;e<n.length;e++){var r=n[e];this.specs[r.name]=r,this.specsNames.push(r.name)}}return t.prototype.init=function(t){var e=this;this.connection=t;for(var n=0,r=this.specsNames;n<r.length;n++)for(var i=r[n],o=function(n){var r=s.subsRefCount[n];if(r||(r=0),r+=1,s.subsRefCount[n]=r,r>1)return"continue";var i=t.on(n,(function(t){return e.processMessage(n,t)}));s.subs[n]=i},s=this,a=0,c=this.specs[i].types;a<c.length;a++){o(c[a])}},t.prototype.processMessage=function(t,e){if(!this.isDone&&e)for(var n=0,r=this.specsNames;n<r.length;n++){var i=r[n];if(-1!==this.specs[i].types.indexOf(t)){var o=this.messages[i]||[];this.messages[i]=o,o.push(e)}}},t.prototype.drain=function(t,e){var n;e&&(this.messages[t]||[]).forEach(e),delete this.messages[t];for(var r=0,i=this.specs[t].types;r<i.length;r++){var o=i[r];this.subsRefCount[o]-=1,this.subsRefCount[o]<=0&&(null===(n=this.connection)||void 0===n||n.off(this.subs[o]),delete this.subs[o],delete this.subsRefCount[o])}delete this.specs[t],this.specs.length||(this.isDone=!0)},t}(),wt=function(){function t(t,e){if(this.settings=t,this.logger=e,this.messageHandlers={},this.ids=1,this.registry=H(),this._connected=!1,this.isTrace=!1,(t=t||{}).reconnectAttempts=t.reconnectAttempts||10,t.reconnectInterval=t.reconnectInterval||1e3,t.inproc)this.transport=new U(t.inproc,e.subLogger("inMemory"));else if(t.sharedWorker)this.transport=new V(t.sharedWorker,e.subLogger("shared-worker"));else{if(void 0===t.ws)throw new Error("No connection information specified");this.transport=new $(t,e.subLogger("ws"))}this.isTrace=e.canPublish("trace"),e.info("starting with "+this.transport.name()+" transport"),this.protocol=new gt(this,t,e.subLogger("protocol")),this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this.transport.onMessage(this.handleTransportMessage.bind(this)),t.replaySpecs&&t.replaySpecs.length&&(this.replayer=new mt(t.replaySpecs),this.replayer.init(this))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;return null===(t=this.protocol)||void 0===t?void 0:t.protocolVersion},enumerable:!0,configurable:!0}),t.prototype.send=function(t,e){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var n=this.protocol.createObjectMessage(t);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(n)),this.transport.sendObject(n,e)}var r=this.protocol.createStringMessage(t);return this.isTrace&&this.logger.trace(">> "+r),this.transport.send(r,e)},t.prototype.on=function(t,e){t=t.toLowerCase(),void 0===this.messageHandlers[t]&&(this.messageHandlers[t]={});var n=this.ids++;return this.messageHandlers[t][n]=e,{type:t,id:n}},t.prototype.off=function(t){delete this.messageHandlers[t.type.toLowerCase()][t.id]},Object.defineProperty(t.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.connected=function(t){var e=this;return this.protocol.loggedIn((function(){t(e.settings.ws||e.settings.sharedWorker||"")}))},t.prototype.disconnected=function(t){return this.registry.add("disconnected",t)},t.prototype.login=function(t,e){return w(this,void 0,void 0,(function(){var n;return b(this,(function(r){switch(r.label){case 0:return[4,this.transport.open()];case 1:return r.sent(),Y("connection").mark("transport-opened"),n=this.protocol.login(t,e),Y("connection").mark("protocol-logged-in"),[2,n]}}))}))},t.prototype.logout=function(){return w(this,void 0,void 0,(function(){return b(this,(function(t){switch(t.label){case 0:return[4,this.protocol.logout()];case 1:return t.sent(),[4,this.transport.close()];case 2:return t.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this.protocol.loggedIn(t)},t.prototype.domain=function(t,e,n){return this.protocol.domain(t,this.logger.subLogger("domain="+t),e,n)},t.prototype.authToken=function(){return this.protocol.authToken()},t.prototype.reconnect=function(){return this.transport.reconnect()},t.prototype.distributeMessage=function(t,e){var n=this,r=this.messageHandlers[e.toLowerCase()];void 0!==r&&Object.keys(r).forEach((function(e){var i=r[e];if(void 0!==i)try{i(t)}catch(t){try{n.logger.error("Message handler failed with "+t.stack,t)}catch(e){console.log("Message handler failed",t)}}}))},t.prototype.handleConnectionChanged=function(t){this._connected!==t&&(this._connected=t,t?this.registry.execute("connected"):this.registry.execute("disconnected"))},t.prototype.handleTransportMessage=function(t){var e;e="string"==typeof t?this.protocol.processStringMessage(t):this.protocol.processObjectMessage(t),this.isTrace&&this.logger.trace("<< "+JSON.stringify(e)),this.distributeMessage(e.msg,e.msgType)},t}(),bt=["trace","debug","info","warn","error","off"],_t=function(){function t(t,e,n){this.name=t,this.parent=e,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=t,this.path=e?e.path+"."+t:t,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}return t.prototype.subLogger=function(e){var n=this.subLoggers.filter((function(t){return t.name===e}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(t){if(t===e)throw new Error("This sub logger name is not allowed.")}));var r=new t(e,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(r),r},t.prototype.publishLevel=function(t){var e;return t&&(this._publishLevel=t),this._publishLevel||(null===(e=this.parent)||void 0===e?void 0:e.publishLevel())},t.prototype.consoleLevel=function(t){var e;return t&&(this._consoleLevel=t),this._consoleLevel||(null===(e=this.parent)||void 0===e?void 0:e.consoleLevel())},t.prototype.log=function(t,e,n){this.publishMessage(e||"info",t,n)},t.prototype.trace=function(t){this.log(t,"trace")},t.prototype.debug=function(t){this.log(t,"debug")},t.prototype.info=function(t){this.log(t,"info")},t.prototype.warn=function(t){this.log(t,"warn")},t.prototype.error=function(t,e){this.log(t,"error")},t.prototype.canPublish=function(t,e){return bt.indexOf(t)>=bt.indexOf(e||this.consoleLevel()||"trace")},t.prototype.publishMessage=function(e,n,r){var i=this.loggerFullName;if("error"===e&&!r){var o=new Error;o.stack&&(n=n+"\n"+o.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(e,this.publishLevel())){var s=t.Interop;if(s)try{s.methods({name:t.InteropMethodName}).length>0&&s.invoke(t.InteropMethodName,{msg:""+n,logger:i,level:e})}catch(t){}}if(this.canPublish(e)){var a="";if(this.includeTimeAndLevel){var c=new Date;a="["+(c.getHours()+":"+c.getMinutes()+":"+c.getSeconds()+":"+c.getMilliseconds())+"] ["+e+"] "}var u=""+a+i+": "+n;switch(e){case"trace":this.logFn.debug(u);break;case"debug":this.logFn.debug?this.logFn.debug(u):this.logFn.log(u);break;case"info":this.logFn.info(u);break;case"warn":this.logFn.warn(u);break;case"error":this.logFn.error(u,r)}}},t.InteropMethodName="T42.AppLogger.Log",t}(),It="create-context",St="created",xt="destroyed",kt="context-created",Ct="context-added",At="subscribe-context",Tt="subscribed-context",Pt="unsubscribe-context",Mt="destroy-context",jt="context-destroyed",Et="update-context",Ot="context-updated",Rt="joined",Nt={get name(){return"context"},get types(){return[It,St,xt,kt,Ct,At,Tt,Pt,Mt,jt,Et,Ot,Rt]}},Lt="5.2.3";function Wt(t,e,n){var r,i,o,s,a;if(J.isNode()){var c=process.env._GD_STARTING_CONTEXT_;if(c)try{a=JSON.parse(c)}catch(t){}}var u=function(){var r,i,o,s,c,u,d,p,h,f=t.gateway,l=null!==(r=null==f?void 0:f.protocolVersion)&&void 0!==r?r:3,v=null==f?void 0:f.reconnectInterval,y=null==f?void 0:f.reconnectAttempts,g=null==f?void 0:f.ws,m=null==f?void 0:f.sharedWorker,w=null==f?void 0:f.inproc;n&&(g=n.gwURL),J.isNode()&&a&&a.gwURL&&(g=a.gwURL),g||m||w||(g="ws://localhost:8385");var b=function(){if(t.application)return t.application;if(n)return n.applicationName;var e=vt();if(J.isNode())return a?a.applicationConfig.name:"NodeJS"+e;if("undefined"!=typeof window&&"undefined"!=typeof document)return document.title+" ("+e+")";return e}(),_=b;void 0!==n?(u=n.windowId,d=n.pid,n.env&&(p=n.env.env,h=n.env.region),_=null!==(i=n.application)&&void 0!==i?i:"glue-app",c=n.appInstanceId):J.isNode()?(d=process.pid,a&&(p=a.env,h=a.region,c=a.instanceId)):u=window.name||vt();var I=null!==(s=null===(o=t.gateway)||void 0===o?void 0:o.replaySpecs)&&void 0!==s?s:[];return I.push(Nt),{identity:{application:_,applicationName:b,windowId:u,instance:c,process:d,region:h,environment:p,api:e.version||Lt},reconnectInterval:v,ws:g,sharedWorker:m,inproc:w,protocolVersion:l,reconnectAttempts:y,replaySpecs:I}}();return{bus:null!==(r=t.bus)&&void 0!==r&&r,auth:function(){var e,n;return"string"==typeof t.auth?{token:t.auth}:t.auth?t.auth:J.isNode()&&a&&a.gwToken?{gatewayToken:a.gwToken}:(null===(e=t.gateway)||void 0===e?void 0:e.inproc)||(null===(n=t.gateway)||void 0===n?void 0:n.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var e,r,i,o=t.logger,s="warn";return o||(o=s),n&&(i=n.consoleLogLevel),"string"==typeof o?{console:null!=i?i:o,publish:s}:{console:null!==(e=null!=i?i:o.console)&&void 0!==e?e:s,publish:null!==(r=o.publish)&&void 0!==r?r:s}}(),connection:u,metrics:null===(i=t.metrics)||void 0===i||i,contexts:null===(o=t.contexts)||void 0===o||o,version:e.version||Lt,libs:null!==(s=e.libs)&&void 0!==s?s:[],customLogger:t.customLogger}}var Dt=function(){function t(t,e,n,r){this.updateCallbacks={},this.contextId=t,this.name=e,this.isAnnounced=n,this.activityId=r,this.context={}}return t.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},t.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},t}();function Ft(t,e,n){try{if((null==n?void 0:n.canPublish("trace"))&&(null==n||n.trace("applying context delta "+JSON.stringify(e)+" on context "+JSON.stringify(t))),!e)return t;if(e.reset)return t=m({},e.reset);if(t=Bt(t,void 0),e.commands){for(var r=0,i=e.commands;r<i.length;r++){var o=i[r];"remove"===o.type?Ut(t,o.path):"set"===o.type&&Ht(t,o.value,o.path)}return t}var s=e.added,a=e.updated,c=e.removed;return s&&Object.keys(s).forEach((function(e){t[e]=s[e]})),a&&Object.keys(a).forEach((function(e){qt(e,t,a)})),c&&c.forEach((function(e){delete t[e]})),t}catch(r){return null==n||n.error("error applying context delta "+JSON.stringify(e)+" on context "+JSON.stringify(t),r),t}}function Bt(t,e){if(e=e||new WeakMap,Object(t)!==t)return t;if(t instanceof Set)return new Set(t);if(e.has(t))return e.get(t);var n=t instanceof Date?new Date(t):t instanceof RegExp?new RegExp(t.source,t.flags):t.constructor?new t.constructor:Object.create(null);return e.set(t,n),Object.assign.apply(Object,_([n],Object.keys(t).map((function(n){var r;return(r={})[n]=Bt(t[n],e),r}))))}var qt=function(t,e,n){var r=n[t];if(void 0===r)return e;var i=e[t];return i&&r?"string"==typeof i||"number"==typeof i||"boolean"==typeof i||"string"==typeof r||"number"==typeof r||"boolean"==typeof r||Array.isArray(i)||Array.isArray(r)?(e[t]=r,e):(e[t]=Object.assign({},i,r),e):(e[t]=r,e)};function Gt(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;for(var n in t)if(t.hasOwnProperty(n)){if(!e.hasOwnProperty(n))return!1;if(t[n]!==e[n]){if("object"!=typeof t[n])return!1;if(!Gt(t[n],e[n]))return!1}}for(var n in e)if(e.hasOwnProperty(n)&&!t.hasOwnProperty(n))return!1;return!0}function Ht(t,e,n){var r,i=n.split(".");for(r=0;r<i.length-1;r++)t[i[r]]||(t[i[r]]={}),"object"!=typeof t[i[r]]&&(t[i[r]]={}),t=t[i[r]];t[i[r]]=e}function Ut(t,e){var n,r=e.split(".");for(n=0;n<r.length-1;n++){if(!t[r[n]])return;t=t[r[n]]}delete t[r[n]]}var Vt,Jt=function(){function t(t){var e,n=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._protocolVersion=void 0,this._connection=t.connection,this._logger=t.logger,this._gw3Session=this._connection.domain("global",[kt,Tt,jt,Ot]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(e=this._connection.replayer)||void 0===e||e.drain(Nt.name,(function(t){var e=t.type;e&&(e===kt||e===Ct||e===St?n.handleContextCreatedMessage(t):e===Tt||e===Ot||e===Rt?n.handleContextUpdatedMessage(t):e!==jt&&e!==xt||n.handleContextDestroyedMessage(t))}))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;if(!this._protocolVersion){var e=this._connection.availableDomains.find((function(t){return"context"===t.uri}));this._protocolVersion=null!==(t=null==e?void 0:e.version)&&void 0!==t?t:1}return this._protocolVersion},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"setPathSupported",{get:function(){return this.protocolVersion>=2},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){for(var t=0,e=this._gw3Subscriptions;t<e.length;t++){var n=e[t];this._connection.off(n)}for(var r in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(r)&&delete this._contextNameToData[r]},t.prototype.createContext=function(t,e){var n=this;return this._gw3Session.send({type:It,domain:"global",name:t,data:e,lifetime:"retained"}).then((function(r){n._contextNameToId[t]=r.context_id,n._contextIdToName[r.context_id]=t;var i=n._contextNameToData[t]||new Dt(r.context_id,t,!0,void 0);return i.isAnnounced=!0,i.name=t,i.contextId=r.context_id,i.context=e,n._contextNameToData[t]=i,r.context_id}))},t.prototype.all=function(){var t=this;return Object.keys(this._contextNameToData).filter((function(e){return t._contextNameToData[e].isAnnounced}))},t.prototype.update=function(t,e){var n;return w(this,void 0,void 0,(function(){var r,i,o,s=this;return b(this,(function(a){switch(a.label){case 0:return(r=this._contextNameToData[t])&&r.isAnnounced?(i=r.context,r.hasCallbacks()?[3,2]:[4,this.get(r.name)]):[2,this.createContext(t,e)];case 1:i=a.sent(),a.label=2;case 2:return o=2===this.protocolVersion?this.calculateContextDeltaV2(i,e):this.calculateContextDeltaV1(i,e),Object.keys(o.added).length||Object.keys(o.updated).length||o.removed.length||(null===(n=o.commands)||void 0===n?void 0:n.length)?[2,this._gw3Session.send({type:Et,domain:"global",context_id:r.contextId,delta:o},{},{skipPeerId:!1}).then((function(t){s.handleUpdated(r,o,{updaterId:t.peer_id})}))]:[2,Promise.resolve()]}}))}))},t.prototype.set=function(t,e){var n=this,r=this._contextNameToData[t];return r&&r.isAnnounced?this._gw3Session.send({type:Et,domain:"global",context_id:r.contextId,delta:{reset:e}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(r,{reset:e,added:{},removed:[],updated:{}},{updaterId:t.peer_id})})):this.createContext(t,e)},t.prototype.setPath=function(t,e,n){return this.setPathSupported?this.setPaths(t,[{path:e,value:n}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")},t.prototype.setPaths=function(t,e){var n=this;if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");var r=this._contextNameToData[t];if(!r||!r.isAnnounced){for(var i={},o=0,s=e;o<s.length;o++){Ht(i,(d=s[o]).value,d.path)}return this.createContext(t,i)}for(var a=[],c=0,u=e;c<u.length;c++){var d;null===(d=u[c]).value?a.push({type:"remove",path:d.path}):a.push({type:"set",path:d.path,value:d.value})}return this._gw3Session.send({type:Et,domain:"global",context_id:r.contextId,delta:{commands:a}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(r,{added:{},removed:[],updated:{},commands:a},{updaterId:t.peer_id})}))},t.prototype.get=function(t){var e,n=this,r=this._contextNameToData[t];if(!r||!r.isAnnounced)return Promise.resolve({});if(r&&!r.hasCallbacks())return new Promise((function(e,r){return w(n,void 0,void 0,(function(){var n=this;return b(this,(function(r){return this.subscribe(t,(function(t,r,i,o){n.unsubscribe(o),e(t)})),[2]}))}))}));var i=null!==(e=null==r?void 0:r.context)&&void 0!==e?e:{};return Promise.resolve(i)},t.prototype.subscribe=function(t,e){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var r=this._contextNameToData[t];if(!r||!r.isAnnounced)return r=r||new Dt(void 0,t,!1,void 0),this._contextNameToData[t]=r,r.updateCallbacks[n]=e,Promise.resolve(n);var i=r.hasCallbacks();return r.updateCallbacks[n]=e,i||r.joinedActivity||r.context&&r.sentExplicitSubscription?(e(r.context,r.context,[],n),Promise.resolve(n)):this.sendSubscribe(r).then((function(){return n}))},t.prototype.unsubscribe=function(t){for(var e=0,n=Object.keys(this._contextNameToData);e<n.length;e++){var r=n[e],i=(this._contextNameToId[r],this._contextNameToData[r]);if(!i)return;var o=i.hasCallbacks();delete i.updateCallbacks[t],i.isAnnounced&&o&&!i.hasCallbacks()&&i.sentExplicitSubscription&&this.sendUnsubscribe(i),i.isAnnounced||i.hasCallbacks()||delete this._contextNameToData[r]}},t.prototype.destroy=function(t){var e=this._contextNameToData[t];return e?this._gw3Session.send({type:Mt,domain:"global",context_id:e.contextId}).then((function(t){})):Promise.reject("context with "+t+" does not exist")},t.prototype.handleUpdated=function(t,e,n){var r=t.context;t.context=Ft(t.context,e,this._logger),this._contextNameToData[t.name]!==t||Gt(r,t.context)||this.invokeUpdateCallbacks(t,t.context,e,n)},t.prototype.subscribeToContextCreatedMessages=function(){for(var t=0,e=[Ct,kt,St];t<e.length;t++){var n=e[t],r=this._connection.on(n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(r)}},t.prototype.handleContextCreatedMessage=function(t){var e=t.type;e===St?(this._contextNameToId[t.activity_id]=t.context_id,this._contextIdToName[t.context_id]=t.activity_id):e===Ct&&(this._contextNameToId[t.name]=t.context_id,this._contextIdToName[t.context_id]=t.name);var n=this._contextIdToName[t.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+t.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+t.context_id);var r=this._contextNameToData[n];if(r){if(r.isAnnounced)return;if(!r.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");r.isAnnounced=!0,r.contextId=t.context_id,r.activityId=t.activity_id,r.sentExplicitSubscription||this.sendSubscribe(r)}else this._contextNameToData[n]=r=new Dt(t.context_id,n,!0,t.activity_id)},t.prototype.subscribeToContextUpdatedMessages=function(){for(var t=0,e=[Ot,Tt,Rt];t<e.length;t++){var n=e[t],r=this._connection.on(n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(r)}},t.prototype.handleContextUpdatedMessage=function(t){var e=t.type,n=t.context_id,r=this._contextNameToData[this._contextIdToName[n]],i=!r||!r.isAnnounced;if(e===Rt)r?(r.contextId=n,r.isAnnounced=!0,r.activityId=t.activity_id):(r=new Dt(n,t.activity_id,!0,t.activity_id),this._contextNameToData[t.activity_id]=r,this._contextIdToName[n]=t.activity_id,this._contextNameToId[t.activity_id]=n),r.joinedActivity=!0;else if(!r||!r.isAnnounced)return void(e===Tt?((r=r||new Dt(n,t.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[t.name]=r,this._contextIdToName[n]=t.name,this._contextNameToId[t.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var o=r.context;if(e===Tt)r.context=t.data||{};else if(e===Rt)r.context=t.context_snapshot||{};else{if(e!==Ot)throw new Error("Unrecognized context update message "+e);r.context=Ft(r.context,t.delta,this._logger)}!i&&Gt(r.context,o)&&e!==Tt||this.invokeUpdateCallbacks(r,r.context,t.delta,{updaterId:t.updater_id})},t.prototype.invokeUpdateCallbacks=function(t,e,n,r){if((n=n||{added:{},updated:{},reset:{},removed:[]}).commands){n.added=n.updated=n.reset={},n.removed=[];for(var i=0,o=n.commands;i<o.length;i++){var s=o[i];"remove"===s.type?(-1===s.path.indexOf(".")&&n.removed.push(s.path),Ht(n.updated,null,s.path)):"set"===s.type&&Ht(n.updated,s.value,s.path)}}for(var a in t.updateCallbacks)if(t.updateCallbacks.hasOwnProperty(a))try{(0,t.updateCallbacks[a])(Bt(e),Object.assign({},n.added||{},n.updated||{},n.reset||{}),n.removed,parseInt(a,10),r)}catch(t){this._logger.debug("callback error: "+JSON.stringify(t))}},t.prototype.subscribeToContextDestroyedMessages=function(){for(var t=0,e=[jt,xt];t<e.length;t++){var n=e[t],r=this._connection.on(n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(r)}},t.prototype.handleContextDestroyedMessage=function(t){var e,n;if(t.type===xt){if(n=t.activity_id,!(e=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+t.activity_id)}else if(e=t.context_id,!(n=this._contextIdToName[e]))return void this._logger.error("Received 'destroyed' for unknown context: "+t.context_id);delete this._contextIdToName[e],delete this._contextNameToId[n];var r=this._contextNameToData[n];delete this._contextNameToData[n],r&&r.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+e)},t.prototype.sendSubscribe=function(t){return t.sentExplicitSubscription=!0,this._gw3Session.send({type:At,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.sendUnsubscribe=function(t){return t.sentExplicitSubscription=!1,this._gw3Session.send({type:Pt,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.calculateContextDeltaV1=function(t,e){var n={added:{},updated:{},removed:[],reset:void 0};if(t)for(var r=0,i=Object.keys(t);r<i.length;r++){var o=i[r];-1===Object.keys(e).indexOf(o)||null===e[o]||Gt(t[o],e[o])||(n.updated[o]=e[o])}for(var s=0,a=Object.keys(e);s<a.length;s++){o=a[s];t&&-1!==Object.keys(t).indexOf(o)?null===e[o]&&n.removed.push(o):null!==e[o]&&(n.added[o]=e[o])}return n},t.prototype.calculateContextDeltaV2=function(t,e){for(var n,r,i={added:{},updated:{},removed:[],reset:void 0,commands:[]},o=0,s=Object.keys(e);o<s.length;o++){var a=s[o];if(null!==e[a])Gt(t?t[a]:null,e[a])||null===(n=i.commands)||void 0===n||n.push({type:"set",path:a,value:e[a]});else null===(r=i.commands)||void 0===r||r.push({type:"remove",path:a})}return i},t}(),zt=function(){function t(t){this._bridge=new Jt(t)}return t.prototype.all=function(){return this._bridge.all()},t.prototype.update=function(t,e){return this.checkName(t),this.checkData(e),this._bridge.update(t,e)},t.prototype.set=function(t,e){return this.checkName(t),this.checkData(e),this._bridge.set(t,e)},t.prototype.setPath=function(t,e,n){return this.checkName(t),this.checkPath(e),""===e?(this.checkData(n),this.set(t,n)):this._bridge.setPath(t,e,n)},t.prototype.setPaths=function(t,e){if(this.checkName(t),!Array.isArray(e))throw new Error("Please provide the paths as an array of PathValues!");for(var n=0,r=e;n<r.length;n++){var i=r[n],o=i.path,s=i.value;this.checkPath(o),""===o&&this.checkData(s)}return this._bridge.setPaths(t,e)},t.prototype.subscribe=function(t,e){var n=this;if(this.checkName(t),"function"!=typeof e)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(t,(function(t,r,i,o,s){return e(t,r,i,(function(){return n._bridge.unsubscribe(o)}),s)})).then((function(t){return function(){n._bridge.unsubscribe(t)}}))},t.prototype.get=function(t){return this.checkName(t),this._bridge.get(t)},t.prototype.ready=function(){return Promise.resolve(this)},t.prototype.destroy=function(t){return this.checkName(t),this._bridge.destroy(t)},Object.defineProperty(t.prototype,"setPathSupported",{get:function(){return this._bridge.setPathSupported},enumerable:!0,configurable:!0}),t.prototype.checkName=function(t){if("string"!=typeof t||""===t)throw new Error("Please provide the name as a non-empty string!")},t.prototype.checkPath=function(t){if("string"!=typeof t)throw new Error("Please provide the path as a dot delimited string!")},t.prototype.checkData=function(t){if("object"!=typeof t)throw new Error("Please provide the data as an object!")},t}();function Kt(t,e,n){return"function"!=typeof e&&"function"!=typeof n?t:("function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n))}function Yt(t,e,n){var r;return void 0===t&&(t=0),e.finally((function(){r&&clearTimeout(r)})),new Promise((function(e,i){r=setTimeout((function(){return i(n)}),t)}))}!function(t){t[t.Success=0]="Success",t[t.Error=1]="Error"}(Vt||(Vt={}));var Zt=function(){function t(t,e,n,r){this.protocol=t,this.repo=e,this.instance=n,this.configuration=r}return t.prototype.subscribe=function(t,e,n,r,i){var o=this,s=function(t,n,r,s){var a;e.methodResponseTimeout=null!==(a=e.methodResponseTimeout)&&void 0!==a?a:e.waitTimeoutMs,o.protocol.client.subscribe(n,e,t,r,s,i)};return Kt(new Promise((function(n,r){var i,a=function(t){n(t)},c=function(t){r(t)};if(t)if((i="string"==typeof t?{name:t}:t).name){void 0===e&&(e={});var u=e.target;if(void 0===u&&(u="best"),"string"!=typeof u||"all"===u||"best"===u){void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=e.method_response_timeout,void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=o.configuration.methodResponseTimeout)),void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=e.wait_for_method_timeout,void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=o.configuration.waitTimeoutMs));var d=0,p=o.getServerMethodsByFilterAndTarget(i,u);if(p.length>0)s(p,p[0].methods[0],a,c);else{var h=function(){if(u&&e.waitTimeoutMs)if(d+=500,(p=o.getServerMethodsByFilterAndTarget(i,u)).length>0){var n=p[0].methods[0];s(p,n,a,c)}else if(d>=e.waitTimeoutMs){s(p,"string"==typeof t?{name:t}:t,a,c)}else setTimeout(h,500)};setTimeout(h,500)}}else r(new Error('"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else r("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");else r("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.")})),n,r)},t.prototype.servers=function(t){var e=void 0===t?void 0:m({},t);return this.getServers(e).map((function(t){return t.server.instance}))},t.prototype.methods=function(t){return t="string"==typeof t?{name:t}:m({},t),this.getMethods(t)},t.prototype.methodsForInstance=function(t){return this.getMethodsForInstance(t)},t.prototype.methodAdded=function(t){return this.repo.onMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.repo.onMethodRemoved(t)},t.prototype.serverAdded=function(t){return this.repo.onServerAdded(t)},t.prototype.serverRemoved=function(t){return this.repo.onServerRemoved((function(e,n){t(e,n)}))},t.prototype.serverMethodAdded=function(t){return this.repo.onServerMethodAdded((function(e,n){t({server:e,method:n})}))},t.prototype.serverMethodRemoved=function(t){return this.repo.onServerMethodRemoved((function(e,n){t({server:e,method:n})}))},t.prototype.invoke=function(t,e,n,r,i,o){return w(this,void 0,void 0,(function(){var s=this;return b(this,(function(a){return[2,Kt(function(){return w(s,void 0,void 0,(function(){var i,o,s,a,c,u,d,p,h,f,l=this;return b(this,(function(v){switch(v.label){case 0:if(!(i="string"==typeof t?{name:t}:m({},t)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.")];if(e||(e={}),n||(n="best"),"string"==typeof n&&"all"!==n&&"best"!==n&&"skipMine"!==n)return[2,Promise.reject(new Error('"'+n+'" is not a valid target. Valid targets are "all" and "best".'))];if(r||(r={}),void 0===r.methodResponseTimeoutMs&&(r.methodResponseTimeoutMs=r.method_response_timeout,void 0===r.methodResponseTimeoutMs&&(r.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===r.waitTimeoutMs&&(r.waitTimeoutMs=r.wait_for_method_timeout,void 0===r.waitTimeoutMs&&(r.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==r.waitTimeoutMs&&"number"!=typeof r.waitTimeoutMs)return[2,Promise.reject(new Error('"'+r.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof e)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+i.name))];if(0!==(o=this.getServerMethodsByFilterAndTarget(i,n)).length)return[3,4];v.label=1;case 1:return v.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(i,n,r)];case 2:return o=v.sent(),[3,4];case 3:return v.sent(),s=m(m({},i),{getServers:function(){return[]},supportsStreaming:!1,objectTypes:null!==(f=i.objectTypes)&&void 0!==f?f:[]}),a={method:s,called_with:e,message:"Can not find a method matching "+JSON.stringify(t)+" with server filter "+JSON.stringify(n),executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(a)];case 4:return c=r.methodResponseTimeoutMs,u=r,d=o.map((function(t){var n=vt(),r=t.methods[0],i=t.server,o=l.protocol.client.invoke(n,r,e,i,u);return Promise.race([o,Yt(c,o,{invocationId:n,message:"Invocation timeout ("+c+" ms) reached for method name: "+(null==r?void 0:r.name)+", target instance: "+JSON.stringify(i.instance)+", options: "+JSON.stringify(u),status:Vt.Error})])})),[4,Promise.all(d)];case 5:return p=v.sent(),h=this.getInvocationResultObj(p,i,e),p.every((function(t){return t.status===Vt.Error}))?[2,Promise.reject(h)]:[2,h]}}))}))}(),i,o)]}))}))},t.prototype.getInvocationResultObj=function(t,e,n){var r=t.filter((function(t){return t.status===Vt.Success})).reduce((function(t,r){return t=_(t,[{executed_by:r.instance,returned:r.result,called_with:n,method:e,message:r.message,status:r.status}])}),[]),i=t.filter((function(t){return t.status===Vt.Error})).reduce((function(t,r){return t=_(t,[{executed_by:r.instance,called_with:n,name:e.name,message:r.message}])}),[]),o=t[0];return{method:e,called_with:n,returned:o.result,executed_by:o.instance,all_return_values:r,all_errors:i,message:o.message,status:o.status}},t.prototype.tryToAwaitForMethods=function(t,e,n){var r=this;return new Promise((function(i,o){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=r.getServerMethodsByFilterAndTarget(t,e);if(c.length>0)clearInterval(a),i(c);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(a),void o()}),500);else o()}))},t.prototype.filterByTarget=function(t,e){var n=this;if("string"!=typeof t){return(Array.isArray(t)?t:[t]).reduce((function(t,r){var i=e.filter((function(t){return n.instanceMatch(r,t.server.instance)}));return t.concat(i)}),[])}if("all"===t)return _(e);if("best"===t){var r=e.find((function(t){return t.server.instance.isLocal}));if(r)return[r];if(void 0!==e[0])return[e[0]]}else if("skipMine"===t)return e.filter((function(t){return t.server.instance.peerId!==n.instance.peerId}));return[]},t.prototype.instanceMatch=function(t,e){return this.containsProps(t,e)},t.prototype.methodMatch=function(t,e){return this.containsProps(t,e)},t.prototype.containsProps=function(t,e){return Object.keys(t).filter((function(e){return void 0!==t[e]&&"function"!=typeof t[e]&&"object_types"!==e&&"display_name"!==e&&"id"!==e&&"gatewayId"!==e&&"identifier"!==e&&"_"!==e[0]})).reduce((function(n,r){var i=t[r],o=e[r];if("objectTypes"===r){(i.length>o.length||!1===function(t,e){var n=t.reduce((function(t,e){return t[e]=!1,t}),{});e.forEach((function(t){void 0!==n[t]&&(n[t]=!0)}));return Object.keys(n).reduce((function(t,e){return n[e]||(t=!1),t}),!0)}(i,o))&&(n=!1)}else String(i).toLowerCase()!==String(o).toLowerCase()&&(n=!1);return n}),!0)},t.prototype.getMethods=function(t){var e=this;return void 0===t?this.repo.getMethods():this.repo.getMethods().filter((function(n){return e.methodMatch(t,n)}))},t.prototype.getMethodsForInstance=function(t){var e=this,n=this.repo.getServers().filter((function(n){return e.instanceMatch(t,n.instance)}));if(0===n.length)return[];var r={};return 1===n.length?r=n[0].methods:n.forEach((function(t){Object.keys(t.methods).forEach((function(e){var n=t.methods[e];r[n.identifier]=n}))})),Object.keys(r).map((function(t){return r[t]}))},t.prototype.getServers=function(t){var e=this,n=this.repo.getServers();return void 0===t?n.map((function(t){return{server:t,methods:[]}})):n.reduce((function(n,r){var i=e.repo.getServerMethodsById(r.id).filter((function(n){return e.methodMatch(t,n)}));return i.length>0&&n.push({server:r,methods:i}),n}),[])},t.prototype.getServerMethodsByFilterAndTarget=function(t,e){var n=this.getServers(t);return this.filterByTarget(e,n)},t}(),Xt=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.subscription=n}return Object.defineProperty(t.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),t.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},t.prototype.push=function(t){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,t)},t}(),$t=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return t.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},t.prototype.acceptOnBranch=function(t){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,t)},t.prototype.reject=function(t){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,t)},t}(),Qt=function(){function t(t,e){var n=this;this.protocol=t,this.server=e,t.server.onSubRequest((function(t,e){return n.handleSubRequest(t,e)})),t.server.onSubAdded((function(t,e){return n.handleSubAdded(t,e)})),t.server.onSubRemoved((function(t,e){return n.handleSubRemoved(t,e)}))}return t.prototype.handleSubRequest=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRequestHandler){var n=new $t(this.protocol,e,t);e.streamCallbacks.subscriptionRequestHandler(n)}},t.prototype.handleSubAdded=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionAddedHandler){var n=new Xt(this.protocol,e,t);e.streamCallbacks.subscriptionAddedHandler(n)}},t.prototype.handleSubRemoved=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRemovedHandler){var n=new Xt(this.protocol,e,t);e.streamCallbacks.subscriptionRemovedHandler(n)}},t}(),te=function(){function t(t,e,n){this.key=t,this.protocol=e,this.repoMethod=n}return t.prototype.subscriptions=function(){var t=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(e){return new Xt(t.protocol,t.repoMethod,e)}))},t.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},t.prototype.push=function(t){this.protocol.server.pushData(this.repoMethod,t,[this.key])},t}(),ee=function(){function t(t,e,n){this._protocol=t,this._repoMethod=e,this._server=n,this.name=this._repoMethod.definition.name}return t.prototype.branches=function(t){var e=this,n=this._protocol.server.getBranchList(this._repoMethod);return t?n.indexOf(t)>-1?new te(t,this._protocol,this._repoMethod):void 0:n.map((function(t){return new te(t,e._protocol,e._repoMethod)}))},t.prototype.branch=function(t){return this.branches(t)},t.prototype.subscriptions=function(){var t=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(e){return new Xt(t._protocol,t._repoMethod,e)}))},Object.defineProperty(t.prototype,"definition",{get:function(){var t=this._repoMethod.definition;return{accepts:t.accepts,description:t.description,displayName:t.displayName,name:t.name,objectTypes:t.objectTypes,returns:t.returns,supportsStreaming:t.supportsStreaming}},enumerable:!0,configurable:!0}),t.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},t.prototype.push=function(t,e){if("string"!=typeof e&&!Array.isArray(e)&&void 0!==e)throw new Error("invalid branches should be string or string array");if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,t,e)},t.prototype.updateRepoMethod=function(t){this._repoMethod=t},t}(),ne=function(){function t(t,e){this.protocol=t,this.serverRepository=e,this.invocations=0,this.currentlyUnregistering={},this.streaming=new Qt(t,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return t.prototype.createStream=function(t,e,n,r,i){var o=this;return Kt(new Promise((function(n,r){if(t){var s;if(!(s="string"==typeof t?{name:""+t}:m({},t)).name)return r("The “name” property is required for the “streamDefinition” object and must be unique. Stream definition: "+JSON.stringify(s));if(o.serverRepository.getList().some((function(t){return t.definition.name===s.name})))return r('A stream with the name "'+s.name+'" already exists! Please, provide a unique name for the stream.');s.supportsStreaming=!0,e||(e={}),"function"!=typeof e.subscriptionRequestHandler&&(e.subscriptionRequestHandler=function(t){t.accept()});var a=o.serverRepository.add({definition:s,streamCallbacks:e,protocolState:{}});o.protocol.server.createStream(a).then((function(){var t;i?(t=i,i.updateRepoMethod(a)):t=new ee(o.protocol,a,o),a.stream=t,n(t)})).catch((function(t){a.repoId&&o.serverRepository.remove(a.repoId),r(t)}))}else r("The stream name must be unique! Please, provide either a unique string for a stream name to “glue.interop.createStream()” or a “methodDefinition” object with a unique “name” property for the stream.")})),n,r)},t.prototype.register=function(t,e){var n=this;if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var r=function(t,r){return w(n,void 0,void 0,(function(){var n,i,o;return b(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),(n=e(t.args,t.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return i=s.sent(),r(void 0,i),[3,3];case 2:r(void 0,n),s.label=3;case 3:return[3,5];case 4:return(o=s.sent())||(o=""),r(o,o),[3,5];case 5:return[2]}}))}))};return r.userCallback=e,this.registerCore(t,r)},t.prototype.registerAsync=function(t,e){if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var n=function(t,n){try{var r=!1,i=function(t){r||n(void 0,t),r=!0},o=function(t){r||(t||(t=""),n(t,t)),r=!0},s=e(t.args,t.instance,i,o);s&&"function"==typeof s.then&&s.then(i).catch(o)}catch(t){n(t,void 0)}};return n.userCallbackAsync=e,this.registerCore(t,n)},t.prototype.unregister=function(t,e){return void 0===e&&(e=!1),w(this,void 0,void 0,(function(){var n,r;return b(this,(function(i){switch(i.label){case 0:return void 0===t?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a “name” property.")]:"function"!=typeof t?[3,2]:[4,this.unregisterWithPredicate(t,e)];case 1:return i.sent(),[2];case 2:return void 0===(n="string"==typeof t?{name:t}:t).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(r=this.serverRepository.getList().find((function(t){return t.definition.name===n.name&&(t.definition.supportsStreaming||!1)===e})))?[4,this.removeMethodsOrStreams([r])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return i.sent(),[2]}}))}))},t.prototype.unregisterWithPredicate=function(t,e){return w(this,void 0,void 0,(function(){var n;return b(this,(function(r){switch(r.label){case 0:return(n=this.serverRepository.getList().filter((function(e){return t(e.definition)})).filter((function(t){return(t.definition.supportsStreaming||!1)===e})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(e?"stream":"method")+" matching the specified condition!")];case 1:return r.sent(),[2]}}))}))},t.prototype.removeMethodsOrStreams=function(t){var e=this,n=[];return t.forEach((function(t){var r=e.protocol.server.unregister(t).then((function(){t.repoId&&e.serverRepository.remove(t.repoId)}));n.push(r),e.addAsCurrentlyUnregistering(t.definition.name,r)})),Promise.all(n)},t.prototype.addAsCurrentlyUnregistering=function(t,e){return w(this,void 0,void 0,(function(){var n,r=this;return b(this,(function(i){return n=new Promise((function(t){return setTimeout(t,5e3)})),this.currentlyUnregistering[t]=Promise.race([e,n]).then((function(){delete r.currentlyUnregistering[t]})),[2]}))}))},t.prototype.registerCore=function(t,e){return w(this,void 0,void 0,(function(){var n,r,i,o=this;return b(this,(function(s){switch(s.label){case 0:return(n="string"==typeof t?{name:""+t}:m({},t)).name?(r=this.currentlyUnregistering[n.name])?[4,r]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the “name” property in the “methodDefinition” object: "+JSON.stringify(t))];case 1:s.sent(),s.label=2;case 2:return this.serverRepository.getList().some((function(t){return t.definition.name===n.name}))?[2,Promise.reject('A method with the name "'+n.name+'" already exists! Please, provide a unique name for the method.')]:n.supportsStreaming?[2,Promise.reject("When you create methods with “glue.interop.register()” or “glue.interop.registerAsync()” the property “supportsStreaming” cannot be “true”. If you want “"+n.name+"” to be a stream, please use the “glue.interop.createStream()” method.")]:(i=this.serverRepository.add({definition:n,theFunction:e,protocolState:{}}),[2,this.protocol.server.register(i).catch((function(t){throw(null==i?void 0:i.repoId)&&o.serverRepository.remove(i.repoId),t}))])}}))}))},t.prototype.onMethodInvoked=function(t,e,n){var r=this;t&&t.theFunction&&t.theFunction(n,(function(n,i){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(t){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}i?("object"!=typeof i||Array.isArray(i))&&(i={_value:i}):i={},r.protocol.server.methodInvocationResult(t,e,n,i)}))},t}(),re=function(){function t(t,e){var n=this;this.wrapped={getMethods:ie,getStreams:oe},t&&this.refreshWrappedObject(t),e&&(e.loggedIn((function(){n.refresh(e)})),this.refresh(e))}return t.prototype.unwrap=function(){return this.wrapped},t.prototype.refresh=function(t){if(t){var e=null==t?void 0:t.resolvedIdentity,n=Object.assign({},null!=e?e:{},{peerId:null==t?void 0:t.peerId});this.refreshWrappedObject(n)}},t.prototype.refreshWrappedObject=function(t){var e,n,r;this.wrapped.user=t.user,this.wrapped.instance=t.instance,this.wrapped.application=null!==(e=t.application)&&void 0!==e?e:vt(),this.wrapped.applicationName=t.applicationName,this.wrapped.pid=null!==(r=null!==(n=t.pid)&&void 0!==n?n:t.process)&&void 0!==r?r:Math.floor(1e10*Math.random()),this.wrapped.machine=t.machine,this.wrapped.environment=t.environment,this.wrapped.region=t.region,this.wrapped.windowId=t.windowId,this.wrapped.isLocal=!0,this.wrapped.api=t.api,this.wrapped.service=t.service,this.wrapped.peerId=t.peerId},t}();function ie(){var t;return null===(t=re.API)||void 0===t?void 0:t.methodsForInstance(this)}function oe(){var t;return null===(t=re.API)||void 0===t?void 0:t.methodsForInstance(this).filter((function(t){return t.supportsStreaming}))}var se=function(){function t(t){this.logger=t,this.servers={},this.methodsCount={},this.callbacks=H()}return t.prototype.addServer=function(t,e){this.logger.debug("adding server "+e);var n=this.servers[e];if(n)return n.id;var r=new re(t),i={id:e,methods:{},instance:r.unwrap(),wrapper:r};return this.servers[e]=i,this.callbacks.execute("onServerAdded",i.instance),e},t.prototype.removeServerById=function(t,e){var n=this,r=this.servers[t];r?(this.logger.debug("removing server "+t),Object.keys(r.methods).forEach((function(e){n.removeServerMethod(t,e)})),delete this.servers[t],this.callbacks.execute("onServerRemoved",r.instance,e)):this.logger.warn("not aware of server "+t+", my state "+JSON.stringify(Object.keys(this.servers)))},t.prototype.addServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");if(!n.methods[e.id]){var r=this.createMethodIdentifier(e),i=this,o={identifier:r,gatewayId:e.id,name:e.name,displayName:e.display_name,description:e.description,version:e.version,objectTypes:e.object_types||[],accepts:e.input_signature,returns:e.result_signature,supportsStreaming:void 0!==e.flags&&e.flags.streaming,getServers:function(){return i.getServersByMethod(r)}};return o.object_types=o.objectTypes,o.display_name=o.displayName,o.version=o.version,n.methods[e.id]=o,this.methodsCount[r]||(this.methodsCount[r]=0,this.callbacks.execute("onMethodAdded",o)),this.methodsCount[r]=this.methodsCount[r]+1,this.callbacks.execute("onServerMethodAdded",n.instance,o),o}},t.prototype.removeServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");var r=n.methods[e];delete n.methods[e],this.methodsCount[r.identifier]=this.methodsCount[r.identifier]-1,0===this.methodsCount[r.identifier]&&this.callbacks.execute("onMethodRemoved",r),this.callbacks.execute("onServerMethodRemoved",n.instance,r)},t.prototype.getMethods=function(){var t=this,e={};return Object.keys(this.servers).forEach((function(n){var r=t.servers[n];Object.keys(r.methods).forEach((function(t){var n=r.methods[t];e[n.identifier]=n}))})),Object.keys(e).map((function(t){return e[t]}))},t.prototype.getServers=function(){var t=this,e=[];return Object.keys(this.servers).forEach((function(n){var r=t.servers[n];e.push(r)})),e},t.prototype.getServerMethodsById=function(t){var e=this.servers[t];return Object.keys(e.methods).map((function(t){return e.methods[t]}))},t.prototype.onServerAdded=function(t){var e=this.callbacks.add("onServerAdded",t),n=this.getServers().map((function(t){return t.instance}));return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onMethodAdded=function(t){var e=this.callbacks.add("onMethodAdded",t),n=this.getMethods();return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onServerMethodAdded=function(t){var e=this.callbacks.add("onServerMethodAdded",t),n=!1,r=this.getServers();return setTimeout((function(){r.forEach((function(e){var r=e.methods;Object.keys(r).forEach((function(i){n||t(e.instance,r[i])}))}))}),0),function(){n=!0,e()}},t.prototype.onMethodRemoved=function(t){return this.callbacks.add("onMethodRemoved",t)},t.prototype.onServerRemoved=function(t){return this.callbacks.add("onServerRemoved",t)},t.prototype.onServerMethodRemoved=function(t){return this.callbacks.add("onServerMethodRemoved",t)},t.prototype.getServerById=function(t){return this.servers[t]},t.prototype.reset=function(){var t=this;Object.keys(this.servers).forEach((function(e){t.removeServerById(e,"reset")})),this.servers={},this.methodsCount={}},t.prototype.createMethodIdentifier=function(t){var e=void 0!==t.input_signature?t.input_signature:"",n=void 0!==t.result_signature?t.result_signature:"";return(t.name+e+n).toLowerCase()},t.prototype.getServersByMethod=function(t){var e=this,n=[];return Object.keys(this.servers).forEach((function(r){var i=e.servers[r];Object.keys(i.methods).forEach((function(e){i.methods[e].identifier===t&&n.push(i.instance)}))})),n},t.prototype.returnUnsubWithDelayedReplay=function(t,e,n){var r=!1;return setTimeout((function(){e.forEach((function(t){r||n(t)}))}),0),function(){r=!0,t()}},t}(),ae=function(){function t(){this.nextId=0,this.methods=[]}return t.prototype.add=function(t){return t.repoId=String(this.nextId),this.nextId+=1,this.methods.push(t),t},t.prototype.remove=function(t){if("string"!=typeof t)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(e){return e.repoId!==t}))},t.prototype.getById=function(t){if("string"==typeof t)return this.methods.find((function(e){return e.repoId===t}))},t.prototype.getList=function(){return this.methods.map((function(t){return t}))},t.prototype.length=function(){return this.methods.length},t.prototype.reset=function(){this.methods=[]},t}(),ce="onSubscriptionRequest",ue="onSubscriptionAdded",de="onSubscriptionRemoved",pe=function(){function t(t,e,n){var r=this;this.session=t,this.repository=e,this.serverRepository=n,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=H(),this.nextStreamId=0,t.on("add-interest",(function(t){r.handleAddInterest(t)})),t.on("remove-interest",(function(t){r.handleRemoveInterest(t)}))}return t.prototype.acceptRequestOnBranch=function(t,e,n){if("string"!=typeof n&&(n=""),"object"!=typeof e.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(e.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var r=this.getStreamId(e,n),i=t.msg.subscription_id,o={id:i,arguments:t.arguments,instance:t.instance,branchKey:n,streamId:r,subscribeMsg:t.msg};e.protocolState.subscriptionsMap[i]=o,this.session.sendFireAndForget({type:"accepted",subscription_id:i,stream_id:r}),this.callbacks.execute(ue,o,e)},t.prototype.rejectRequest=function(t,e,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,t.msg.subscription_id)},t.prototype.pushData=function(t,e,n){var r=this;if("object"==typeof t&&Array.isArray(t.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]),t.protocolState.branchKeyToStreamIdMap.filter((function(t){return!n||0===n.length||n.indexOf(t.key)>=0})).map((function(t){return t.streamId})).forEach((function(t){var n={type:"publish",stream_id:t,data:e};r.session.sendFireAndForget(n)}))}},t.prototype.pushDataToSingle=function(t,e,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var r={type:"post",subscription_id:e.id,data:n};this.session.sendFireAndForget(r)},t.prototype.closeSingleSubscription=function(t,e){t.protocolState.subscriptionsMap&&delete t.protocolState.subscriptionsMap[e.id];var n={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);e.instance;this.callbacks.execute(de,e,t)},t.prototype.closeMultipleSubscriptions=function(t,e){var n=this;if("object"==typeof t&&"object"==typeof t.protocolState.subscriptionsMap&&t.protocolState.subscriptionsMap){var r=t.protocolState.subscriptionsMap,i=Object.keys(r).map((function(t){return r[t]}));"string"==typeof e&&(i=i.filter((function(t){return t.branchKey===e}))),i.forEach((function(t){delete r[t.id];var e={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping all subscriptions on stream_id: "+t.streamId};n.session.sendFireAndForget(e)}))}},t.prototype.getSubscriptionList=function(t,e){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var n=t.protocolState.subscriptionsMap,r=Object.keys(n).map((function(t){return n[t]}));return"string"!=typeof e?r:r.filter((function(t){return t.branchKey===e}))},t.prototype.getBranchList=function(t){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var e=t.protocolState.subscriptionsMap,n=Object.keys(e).map((function(t){return e[t]})),r=[];return n.forEach((function(t){var e="";"object"==typeof t&&"string"==typeof t.branchKey&&(e=t.branchKey),-1===r.indexOf(e)&&r.push(e)})),r},t.prototype.onSubAdded=function(t){this.onSubscriptionLifetimeEvent(ue,t)},t.prototype.onSubRequest=function(t){this.onSubscriptionLifetimeEvent(ce,t)},t.prototype.onSubRemoved=function(t){this.onSubscriptionLifetimeEvent(de,t)},t.prototype.handleRemoveInterest=function(t){var e=this.serverRepository.getById(t.method_id);if("string"==typeof t.subscription_id&&"object"==typeof e&&e.protocolState.subscriptionsMap&&"object"==typeof e.protocolState.subscriptionsMap[t.subscription_id]){var n=e.protocolState.subscriptionsMap[t.subscription_id];delete e.protocolState.subscriptionsMap[t.subscription_id],this.callbacks.execute(de,n,e)}},t.prototype.onSubscriptionLifetimeEvent=function(t,e){this.callbacks.add(t,e)},t.prototype.getNextStreamId=function(){return this.nextStreamId+++""},t.prototype.handleAddInterest=function(t){var e=this.repository.getServerById(t.caller_id).instance,n={msg:t,arguments:t.arguments_kv||{},instance:e},r=this.serverRepository.getById(t.method_id);if(void 0!==r)r.protocolState.subscriptionsMap&&r.protocolState.subscriptionsMap[t.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+t.subscription_id+" already exists.",t.subscription_id):this.callbacks.execute(ce,n,r);else{var i="No method with id "+t.method_id+" on this server.";this.sendSubscriptionFailed(i,t.subscription_id)}},t.prototype.sendSubscriptionFailed=function(t,e){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:t,request_id:e};this.session.sendFireAndForget(n)},t.prototype.getStreamId=function(t,e){if("string"!=typeof e&&(e=""),!t.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+t.definition.name+" method without protocol state");var n=t.protocolState.branchKeyToStreamIdMap.filter((function(t){return t.key===e}))[0],r=n?n.streamId:void 0;return"string"==typeof r&&""!==r||(r=this.getNextStreamId(),t.protocolState.branchKeyToStreamIdMap.push({key:e,streamId:r})),r},t}(),he=function(){function t(t,e,n,r){var i=this;this.session=t,this.clientRepository=e,this.serverRepository=n,this.logger=r,this.callbacks=H(),this.streaming=new pe(t,e,n),this.session.on("invoke",(function(t){return i.handleInvokeMessage(t)}))}return t.prototype.createStream=function(t){return t.protocolState.subscriptionsMap={},t.protocolState.branchKeyToStreamIdMap=[],this.register(t,!0)},t.prototype.register=function(t,e){var n=this,r=t.definition,i={streaming:e||!1},o={type:"register",methods:[{id:t.repoId,name:r.name,display_name:r.displayName,description:r.description,version:r.version,flags:i,object_types:r.objectTypes||r.object_types,input_signature:r.accepts,result_signature:r.returns,restrictions:void 0}]};return this.session.send(o,{methodId:t.repoId}).then((function(){n.logger.debug("registered method "+t.definition.name+" with id "+t.repoId)})).catch((function(e){throw n.logger.warn("failed to register method "+t.definition.name+" with id "+t.repoId+" - "+JSON.stringify(e)),e}))},t.prototype.onInvoked=function(t){this.callbacks.add("onInvoked",t)},t.prototype.methodInvocationResult=function(t,e,n,r){var i;i=n||""===n?{type:"error",request_id:e,reason_uri:"agm.errors.client_error",reason:n,context:r,peer_id:void 0}:{type:"yield",invocation_id:e,peer_id:this.session.peerId,result:r,request_id:void 0},this.session.sendFireAndForget(i)},t.prototype.unregister=function(t){return w(this,void 0,void 0,(function(){var e;return b(this,(function(n){switch(n.label){case 0:return e={type:"unregister",methods:[t.repoId]},[4,this.session.send(e)];case 1:return n.sent(),[2]}}))}))},t.prototype.getBranchList=function(t){return this.streaming.getBranchList(t)},t.prototype.getSubscriptionList=function(t,e){return this.streaming.getSubscriptionList(t,e)},t.prototype.closeAllSubscriptions=function(t,e){this.streaming.closeMultipleSubscriptions(t,e)},t.prototype.pushData=function(t,e,n){this.streaming.pushData(t,e,n)},t.prototype.pushDataToSingle=function(t,e,n){this.streaming.pushDataToSingle(t,e,n)},t.prototype.closeSingleSubscription=function(t,e){this.streaming.closeSingleSubscription(t,e)},t.prototype.acceptRequestOnBranch=function(t,e,n){this.streaming.acceptRequestOnBranch(t,e,n)},t.prototype.rejectRequest=function(t,e,n){this.streaming.rejectRequest(t,e,n)},t.prototype.onSubRequest=function(t){this.streaming.onSubRequest(t)},t.prototype.onSubAdded=function(t){this.streaming.onSubAdded(t)},t.prototype.onSubRemoved=function(t){this.streaming.onSubRemoved(t)},t.prototype.handleInvokeMessage=function(t){var e=t.invocation_id,n=t.caller_id,r=t.method_id,i=t.arguments_kv,o=this.serverRepository.getList().filter((function(t){return t.repoId===r}))[0];if(void 0!==o){var s={args:i,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",o,e,s)}},t}(),fe=function(){function t(t,e){this.repository=t,this.subscriptionData=e}return Object.defineProperty(t.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"servers",{get:function(){var t=this;return this.subscriptionData.trackedServers.filter((function(t){return t.subscriptionId})).map((function(e){return t.repository.getServerById(e.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),t.prototype.onData=function(t){if("function"!=typeof t)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(t),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(e){t(e)}))},t.prototype.onClosed=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(t)},t.prototype.onFailed=function(t){},t.prototype.onConnected=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(t)},t.prototype.close=function(){this.subscriptionData.close()},t.prototype.setNewSubscription=function(t){this.subscriptionData=t},t}(),le="awaitingAccept",ve="subscribed",ye="Subscription failed.",ge="ClientInitiated",me=function(){function t(t,e,n){var r=this;this.session=t,this.repository=e,this.logger=n,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(t){var e=t._tag,n=e.subLocalKey,i=r.subscriptionsList[n];if("object"==typeof i&&(i.trackedServers=i.trackedServers.filter((function(t){return t.serverId!==e.serverId})),i.trackedServers.length<=0)){if(clearTimeout(i.timeoutId),i.status===le){var o="string"==typeof t.reason&&""!==t.reason?' Publisher said "'+t.reason+'".':" No reason given.",s="object"==typeof i.params.arguments?JSON.stringify(i.params.arguments):"{}";i.error({message:"Subscription rejected."+o+" Called with:"+s,called_with:i.params.arguments,method:i.method})}else i.status===ve&&r.callOnClosedHandlers(i);delete r.subscriptionsList[n]}},this.handleSubscribed=function(t){var e=t._tag.subLocalKey,n=r.subscriptionsList[e];if("object"==typeof n){var i=t._tag.serverId,o=n.trackedServers.filter((function(t){return t.serverId===i}))[0];if("object"==typeof o){o.subscriptionId=t.subscription_id,r.subscriptionIdToLocalKeyMap[t.subscription_id]=e;var s=n.status===le;if(n.status=ve,s){var a=!1,c=n.subscription;c?(c.setNewSubscription(n),n.success(c),a=!0):(c=new fe(r.repository,n),n.subscription=c,n.success(c));for(var u=0,d=n.handlers.onConnected;u<d.length;u++){var p=d[u];try{p(c.serverInstance,a)}catch(t){}}}}}},this.handleEventData=function(t){var e=r.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=r.subscriptionsList[e];if("object"==typeof n){var i=n.trackedServers.filter((function(e){return e.subscriptionId===t.subscription_id}));if(1===i.length){var o=t.oob,s=i[0].serverId,a=function(){return{data:t.data,server:r.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:o}},c=n.handlers.onData,u=n.queued.data;c.length>0?c.forEach((function(t){"function"==typeof t&&t(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(t){var e=r.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=r.subscriptionsList[e];if("object"==typeof n){var i=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(e){return e.subscriptionId!==t.subscription_id||(n.queued.closers.push(e.serverId),!1)})),n.trackedServers.length===i&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),r.callOnClosedHandlers(n),delete r.subscriptionsList[e]),delete r.subscriptionIdToLocalKeyMap[t.subscription_id])}}},t.on("subscribed",this.handleSubscribed),t.on("event",this.handleEventData),t.on("subscription-cancelled",this.handleSubscriptionCancelled)}return t.prototype.subscribe=function(t,e,n,r,i,o){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,t,e,r,i,e.methodResponseTimeout||1e4,o);"object"==typeof c?n.forEach((function(n){var r=n.server.id,i=n.methods.find((function(e){return e.name===t.name}));if(i){c.trackedServers.push({serverId:r,subscriptionId:void 0});var o={type:"subscribe",server_id:r,method_id:i.gatewayId,arguments_kv:e.arguments};s.session.send(o,{serverId:r,subLocalKey:a}).then((function(t){return s.handleSubscribed(t)})).catch((function(t){return s.handleErrorSubscribing(t)}))}else s.logger.error("can not find method "+t.name+" for target "+n.server.id)})):i({method:t,called_with:e.arguments,message:ye+" Unable to register the user callbacks."})}else i({method:t,called_with:e.arguments,message:ye+" No available servers matched the target params."})},t.prototype.drainSubscriptions=function(){var t=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},t},t.prototype.getNextSubscriptionLocalKey=function(){var t=this.nextSubLocalKey;return this.nextSubLocalKey+=1,t},t.prototype.registerSubscription=function(t,e,n,r,i,o,s){var a=this,c={localKey:t,status:le,method:e,params:n,success:r,error:i,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(t)},subscription:null==s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[t]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[t]){var r=a.subscriptionsList[t];r.status===le?(i({method:e,called_with:n.arguments,message:ye+" Subscription attempt timed out after "+o+" ms."}),delete a.subscriptionsList[t]):r.status===ve&&r.trackedServers.length>0&&(r.trackedServers=r.trackedServers.filter((function(t){return void 0!==t.subscriptionId})),delete r.timeoutId,r.trackedServers.length<=0&&(a.callOnClosedHandlers(r),delete a.subscriptionsList[t]))}}),o),c},t.prototype.callOnClosedHandlers=function(t,e){var n,r=t.queued.closers.length,i=r>0?t.queued.closers[r-1]:null;void 0!==i&&"string"==typeof i&&(n=this.repository.getServerById(i).instance),t.handlers.onClosed.forEach((function(r){"function"==typeof r&&r({message:e||"ServerInitiated",requestArguments:t.params.arguments||{},server:n,stream:t.method})}))},t.prototype.closeSubscription=function(t){var e=this,n=this.subscriptionsList[t];"object"==typeof n&&(n.trackedServers.forEach((function(t){void 0!==t.subscriptionId&&(n.queued.closers.push(t.serverId),e.session.sendFireAndForget({type:"unsubscribe",subscription_id:t.subscriptionId,reason_uri:"",reason:ge}),delete e.subscriptionIdToLocalKeyMap[t.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,ge),delete this.subscriptionsList[t])},t}(),we=function(){function t(t,e,n){var r=this;this.session=t,this.repository=e,this.logger=n,t.on("peer-added",(function(t){return r.handlePeerAdded(t)})),t.on("peer-removed",(function(t){return r.handlePeerRemoved(t)})),t.on("methods-added",(function(t){return r.handleMethodsAddedMessage(t)})),t.on("methods-removed",(function(t){return r.handleMethodsRemovedMessage(t)})),this.streaming=new me(t,e,n)}return t.prototype.subscribe=function(t,e,n,r,i,o){this.streaming.subscribe(t,e,n,r,i,o)},t.prototype.invoke=function(t,e,n,r){var i=this,o=r.id,s={type:"call",server_id:o,method_id:e.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:t,serverId:o}).then((function(t){return i.handleResultMessage(t)})).catch((function(t){return i.handleInvocationError(t)}))},t.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},t.prototype.handlePeerAdded=function(t){var e=t.new_peer_id,n=t.identity,r=!t.meta||t.meta.local,i=Number(n.process),o={machine:n.machine,pid:isNaN(i)?n.process:i,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:e,api:n.api,isLocal:r};this.repository.addServer(o,e)},t.prototype.handlePeerRemoved=function(t){var e=t.removed_id,n=t.reason;this.repository.removeServerById(e,n)},t.prototype.handleMethodsAddedMessage=function(t){var e=this,n=t.server_id;t.methods.forEach((function(t){e.repository.addServerMethod(n,t)}))},t.prototype.handleMethodsRemovedMessage=function(t){var e=this,n=t.server_id,r=t.methods,i=this.repository.getServerById(n);Object.keys(i.methods).forEach((function(t){var o=i.methods[t];r.indexOf(o.gatewayId)>-1&&e.repository.removeServerMethod(n,t)}))},t.prototype.handleResultMessage=function(t){var e=t._tag.invocationId,n=t.result,r=t._tag.serverId;return{invocationId:e,result:n,instance:this.repository.getServerById(r).instance,status:Vt.Success,message:""}},t.prototype.handleInvocationError=function(t){if(this.logger.debug("handle invocation error "+JSON.stringify(t)),"_tag"in t){var e=t._tag.invocationId,n=t._tag.serverId,r=this.repository.getServerById(n),i=t.reason;return{invocationId:e,result:t.context,instance:r.instance,status:Vt.Error,message:i}}return{invocationId:"",message:t.message,status:Vt.Error,error:t}},t}();function be(t,e,n,r,i,o){var s,a=i.logger.subLogger("gw3-protocol"),c=new Promise((function(t){s=t})),u=e.domain("agm",["subscribed"]),d=new he(u,n,r,a.subLogger("server")),p=new we(u,n,a.subLogger("client"));return u.onJoined((function(i){n.addServer(t,e.peerId),i?function(){a.info("reconnected - will replay registered methods and subscriptions");for(var t=0,e=p.drainSubscriptions();t<e.length;t++){var n=e[t],i=n.method,s=Object.assign({},n.params);a.info("trying to re-subscribe to method "+i.name),o.client.subscribe(i,s,void 0,void 0,n)}var c=r.getList();r.reset();for(var u=0,d=c;u<d.length;u++){var h=d[u],f=h.definition;a.info("re-publishing method "+f.name),h.stream?o.server.createStream(f,h.streamCallbacks,void 0,void 0,h.stream):h.theFunction&&h.theFunction.userCallback?o.register(f,h.theFunction.userCallback):h.theFunction&&h.theFunction.userCallbackAsync&&o.registerAsync(f,h.theFunction.userCallbackAsync)}}():s&&(s({client:p,server:d}),s=void 0)})),u.onLeft((function(){n.reset()})),u.join(),c}var _e=function(){function t(t){var e=this;if(void 0===t)throw new Error("configuration is required");if(void 0===t.connection)throw new Error("configuration.connections is required");var n,r=t.connection;if("number"!=typeof t.methodResponseTimeout&&(t.methodResponseTimeout=3e4),"number"!=typeof t.waitTimeoutMs&&(t.waitTimeoutMs=3e4),re.API=this,this.instance=new re(void 0,r).unwrap(),this.clientRepository=new se(t.logger.subLogger("cRep")),this.serverRepository=new ae,3!==r.protocolVersion)throw new Error("protocol "+r.protocolVersion+" not supported");n=be(this.instance,r,this.clientRepository,this.serverRepository,t,this),this.readyPromise=n.then((function(n){return e.protocol=n,e.client=new Zt(e.protocol,e.clientRepository,e.instance,t),e.server=new ne(e.protocol,e.serverRepository),e}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.serverRemoved=function(t){return this.client.serverRemoved(t)},t.prototype.serverAdded=function(t){return this.client.serverAdded(t)},t.prototype.serverMethodRemoved=function(t){return this.client.serverMethodRemoved(t)},t.prototype.serverMethodAdded=function(t){return this.client.serverMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.client.methodRemoved(t)},t.prototype.methodAdded=function(t){return this.client.methodAdded(t)},t.prototype.methodsForInstance=function(t){return this.client.methodsForInstance(t)},t.prototype.methods=function(t){return this.client.methods(t)},t.prototype.servers=function(t){return this.client.servers(t)},t.prototype.subscribe=function(t,e,n,r){return this.client.subscribe(t,e,n,r)},t.prototype.createStream=function(t,e,n,r){return this.server.createStream(t,e,n,r)},t.prototype.unregister=function(t){return this.server.unregister(t)},t.prototype.registerAsync=function(t,e){return this.server.registerAsync(t,e)},t.prototype.register=function(t,e){return this.server.register(t,e)},t.prototype.invoke=function(t,e,n,r,i,o){return this.client.invoke(t,e,n,r,i,o)},t}(),Ie=["subscribed","success"],Se=function(){function t(t,e){var n=this;this.publish=function(t,e,r){var i=r||{},o=i.routingKey,s=i.target,a=n.removeEmptyValues({type:"publish",topic:t,data:e,peer_id:n.peerId,routing_key:o,target_identity:s});n.session.send(a)},this.subscribe=function(t,e,r){return new Promise((function(i,o){var s=r||{},a=s.routingKey,c=s.target,u=n.removeEmptyValues({type:"subscribe",topic:t,peer_id:n.peerId,routing_key:a,source:c});n.session.send(u).then((function(r){var o=r.subscription_id;n.subscriptions.push({subscription_id:o,topic:t,callback:e,source:c}),i({unsubscribe:function(){return n.session.send({type:"unsubscribe",subscription_id:o,peer_id:n.peerId}),n.subscriptions=n.subscriptions.filter((function(t){return t.subscription_id!==o})),Promise.resolve()}})})).catch((function(t){return o(t)}))}))},this.watchOnEvent=function(){n.session.on("event",(function(t){var e=t.data,r=t.subscription_id,i=t["publisher-identity"],o=n.subscriptions.find((function(t){return t.subscription_id===r}));o&&(o.source?n.keysMatch(o.source,i)&&o.callback(e,o.topic,i):o.callback(e,o.topic,i))}))},this.connection=t,this.logger=e,this.peerId=t.peerId,this.subscriptions=[],this.session=t.domain("bus",Ie),this.readyPromise=this.session.join(),this.readyPromise.then((function(){n.watchOnEvent()}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.removeEmptyValues=function(t){var e={};return Object.keys(t).forEach((function(n){void 0!==t[n]&&null!==t[n]&&(e[n]=t[n])})),e},t.prototype.keysMatch=function(t,e){var n=Object.keys(t),r=!0;return n.forEach((function(n){t[n]!==e[n]&&(r=!1)})),r},t}(),xe=function(t,e){var n,r=J.getGDMajorVersion(),i=Promise.resolve();if(r){if(r<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");r>=3&&(n=window.glue42gd,i=window.gdPreloadPromise||i)}var o,s,a,c,u,d,p,h=Y("glue"),f=Wt(t=t||{},e=e||{},n),l={};function v(t,e,n){(p=a.canPublish("trace"))&&a.trace("registering "+t+" module");var r=function(){e.initTime=n.stop(),e.initEndTime=n.endTime,e.marks=n.marks,p&&a.trace(t+" is ready - "+(n.endTime-n.startTime))};e.initStartTime=n.startTime,e.ready?e.ready().then((function(){r()})):r(),Array.isArray(t)||(t=[t]),t.forEach((function(t){l[t]=e,xe[t]=e}))}function y(){var t=Y("interop"),e={connection:o,logger:a.subLogger("interop")};return s=new _e(e),_t.Interop=s,v(["interop","agm"],s,t),Promise.resolve()}function g(){var t=f.activities&&3===o.protocolVersion;if(f.contexts||t){var e=Y("contexts");return v("contexts",u=new zt({connection:o,logger:a.subLogger("contexts")}),e),u}var n=o.replayer;n&&n.drain(Nt.name)}function m(){return w(this,void 0,void 0,(function(){var t;return b(this,(function(e){return f.bus?(t=Y("bus"),v("bus",d=new Se(o,a.subLogger("bus")),t),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function _(t){try{return t.forEach((function(t){!function(t,e){var n=Y(t),r=e(l);r&&v(t,r,n)}(t.name,t.create)})),Promise.resolve()}catch(t){return Promise.reject(t)}}return i.then((function(){var t,e=Y("logger");return(a=new _t(""+(null===(t=f.connection.identity)||void 0===t?void 0:t.application),void 0,f.customLogger)).consoleLevel(f.logger.console),a.publishLevel(f.logger.publish),a.canPublish("debug")&&a.debug("initializing glue..."),v("logger",a,e),Promise.resolve(void 0)})).then((function(){var t=Y("connection");o=new wt(f.connection,a.subLogger("connection"));var e=Promise.resolve(f.auth);return f.connection&&!f.auth&&(e=n?n.getGWToken().then((function(t){return{gatewayToken:t}})):Promise.reject("You need to provide auth information")),e.then((function(e){var n;if(t.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(e))throw new Error("Invalid auth object - "+JSON.stringify(e));return n=e,o.login(n)})).then((function(){return v("connection",o,t),f})).catch((function(t){throw o&&o.logout(),t}))})).then((function(){return Promise.all([(s=Y("metrics"),u=f.metrics,d=null==n?void 0:n.getMetricsPublishingEnabled,p=f.connection.identity,h=d||function(){return!0},l=null!==(t="boolean"!=typeof u&&u.disableAutoAppSystem)&&void 0!==t&&t,v("metrics",c=q({connection:u?o:void 0,logger:a.subLogger("metrics"),canUpdateMetric:h,system:"Glue42",service:null!==(e=null==p?void 0:p.service)&&void 0!==e?e:"metrics-service",instance:null!==(i=null!==(r=null==p?void 0:p.instance)&&void 0!==r?r:null==p?void 0:p.windowId)&&void 0!==i?i:vt(),disableAutoAppSystem:l,pagePerformanceMetrics:"boolean"!=typeof u?null==u?void 0:u.pagePerformanceMetrics:void 0}),s),Promise.resolve()),y(),g(),m()]);var t,e,r,i,s,u,d,p,h,l})).then((function(){return s.readyPromise})).then((function(){return _(f.libs||[])})).then((function(){var t=Object.keys(l).map((function(t){var e=l[t];return e.ready?e.ready():Promise.resolve()}));return Promise.all(t)})).then((function(){var r={coreVersion:Lt,version:f.version};h.stop();var i={feedback:function(t){s&&s.invoke("T42.ACS.Feedback",t,"best")},info:r,logger:a,interop:s,agm:s,connection:o,metrics:c,contexts:u,bus:d,version:f.version,userConfig:t,done:function(){return null==a||a.info("done called by user..."),o.logout()}};if(i.performance={get glueVer(){return f.version},get glueConfig(){return JSON.stringify(t)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var t=K;return Object.keys(t).map((function(e){var n=t[e];return{name:e,duration:n.endTime-n.startTime,marks:n.marks}}))}},Object.keys(l).forEach((function(t){var e=l[t];i[t]=e})),i.config={},Object.keys(f).forEach((function(t){i.config[t]=f[t]})),e&&e.extOptions&&Object.keys(e.extOptions).forEach((function(t){i.config[t]=null==e?void 0:e.extOptions[t]})),(null==e?void 0:e.enrichGlue)&&e.enrichGlue(i),n&&n.updatePerfData&&n.updatePerfData(i.performance),i.agm){var p=function(t,e,n){return function(){i.logger.warn("glue.js - 'glue.agm."+e+"' method is deprecated, use 'glue.interop."+n+"' instead."),t.apply(i.agm,arguments)}},v=i.agm;v.method_added=p(i.agm.methodAdded,"method_added","methodAdded"),v.method_removed=p(i.agm.methodRemoved,"method_removed","methodRemoved"),v.server_added=p(i.agm.serverAdded,"server_added","serverAdded"),v.server_method_aded=p(i.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),v.server_method_removed=p(i.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return i})).catch((function(t){return Promise.reject({err:t,libs:l})}))};"undefined"!=typeof window&&(window.GlueCore=xe),xe.version=Lt,xe.default=xe;var ke=function(){function t(t){this._id=t}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),t.prototype._update=function(t){if(t._id!==this._id)throw Error("Can not update from entity with different id.");this._updateCore(t)},t.prototype._updateCore=function(t){},t.prototype._beforeDelete=function(t){},t}();function Ce(t){return"string"==typeof t}function Ae(t){return Array.isArray?Array.isArray(t):"[object Array]"===toString.call(t)}function Te(t){return void 0===t}function Pe(t){return!t||void 0===t}function Me(t){return!!(t&&t.constructor&&t.call&&t.apply)}function je(t,e){void 0!==t&&e(t)}var Ee=function(t){function e(e,n,r,i){var o=t.call(this,e)||this;return o._name=e,o._description=i,o._ownerWindow=n,o._helperWindows=r||[],o}return h(e,t),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"description",{get:function(){return this._description},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"helperWindows",{get:function(){return this._helperWindows},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ownerWindow",{get:function(){return this._ownerWindow},enumerable:!0,configurable:!0}),e.prototype.initiate=function(t,e,n){return this._manager.initiate(this._name,t,e,n)},e.prototype._updateCore=function(e){var n=this;t.prototype._updateCore.call(this,e),je(e._description,(function(t){return n._description=t})),je(e._ownerWindow,(function(t){return n._ownerWindow=t})),je(e._helperWindows,(function(t){return n._helperWindows=t}))},e}(ke),Oe=function(t){function e(e,n){var r=t.call(this,e)||this;return r._name=e,r._appByWindowTypeGetter=n,r}return h(e,t),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"config",{get:function(){return this._appByWindowTypeGetter(this._name)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windows",{get:function(){return this._manager.getWindows({type:this._name})},enumerable:!0,configurable:!0}),e.prototype.create=function(t,e){var n=Object.assign({type:this.name,name:this.name,isIndependent:!1},e);return this._manager.createWindow(t,n)},e}(ke),Re=function(t,e){this.entity=t,this.context=e},Ne=function(t){this.type=t},Le=function(t){function e(e,n){var r=t.call(this,De.StatusChange)||this;return r.newStatus=e,r.oldStatus=n,r}return h(e,t),e}(Ne),We=function(t){function e(e,n,r){var i=t.call(this,De.ActivityContextChange)||this;return i.context="string"==typeof e?JSON.parse(e):e,i.updated=n,i.removed=r,i}return h(e,t),e}(Ne),De=function(){function t(){}return t.Added="added",t.Removed="removed",t.Updated="updated",t.Closed="closed",t.StatusChange="statusChange",t.ActivityContextChange="activityContextUpdate",t.ActivityWindowEvent="activityWindowEvent",t.ActivityWindowJoinedActivity="joined",t.ActivityWindowLeftActivity="left",t}(),Fe=function(){function t(){}return t.Created="created",t.Started="started",t.Destroyed="destroyed",t}(),Be=function(){function t(t){this._activity=t}return t.prototype.register=function(e,n){this._ensureHasAgm(),t.AGM.register(e,n)},t.prototype.servers=function(){return this._ensureHasAgm(),Pe(this._activity)?[]:this._activity.windows.map((function(t){return t.instance}))},t.prototype.methods=function(){var t=this;if(this._ensureHasAgm(),Pe(this._activity))return[];var e=this._activity.windows,n=[],r=[];return e.forEach((function(e){t.methodsForWindow(e).forEach((function(t){-1===n.indexOf(t.name)&&(n.push(t.name),r.push(t))}))})),r},t.prototype.methodsForWindow=function(e){return this._ensureHasAgm(),e.instance?t.AGM.methodsForInstance(e.instance):[]},t.prototype.invoke=function(e,n,r,i,o,s){this._ensureHasAgm();var a=this.servers();if(Pe(r)&&(r="activity.all"),Ce(r))if("activity.all"===r)a;else{if("activity.best"!==r){if("all"===r||"best"===r)return function(t,e,n){if("function"!=typeof e&&"function"!=typeof n)return t;"function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n)}(t.AGM.invoke(e,n,r,i),o,s);throw new Error("Invalid invoke target "+r)}var c=a.filter((function(n){return t.AGM.methodsForInstance(n).filter((function(t){return t.name===e})).length>0}));c.length>0&&[c[0]]}else if(Ae(r)){if(r.length>=0){var u=r[0];if(this._isInstance(u))r.map((function(t){return t}));else{if(!this._isActivityWindow(u))throw new Error("Unknown target object");r.map((function(t){return t.instance}))}}}else if(this._isInstance(r))[r];else{if(!this._isActivityWindow(r))throw new Error("Unknown target object");[r.instance]}throw new Error("Not implemented")},t.prototype.unregister=function(e){return this._ensureHasAgm(),t.AGM.unregister(e)},t.prototype.createStream=function(e,n,r){this._ensureHasAgm(),t.AGM.createStream(e,{subscriptionAddedHandler:n,subscriptionRemovedHandler:r,subscriptionRequestHandler:void 0})},t.prototype.subscribe=function(e,n,r){return this._ensureHasAgm(),t.AGM.subscribe(e,n)},t.prototype._ensureHasAgm=function(){if(Pe(t.AGM))throw new Error("Agm should be configured to be used in activity")},t.prototype._isInstance=function(t){return void 0!==t.application},t.prototype._isActivityWindow=function(t){return void 0!==t.instance},t}(),qe=function(){function t(t,e,n){this._manager=t,this._ownerActivityId=e,this._state=n}return Object.defineProperty(t.prototype,"ownerId",{get:function(){return this._state.ownerId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowIds",{get:function(){return this._state.windowIds},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frameColor",{get:function(){return this._state.frameColor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this._state.context},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tag",{get:function(){return this._state.tag},enumerable:!0,configurable:!0}),t.prototype.detach=function(t){var e=this;t=t||{};var n={};return Object.keys(this._state).forEach((function(t){n[t]=e._state[t]})),n.context=t.context||n.context,n.frameColor=t.frameColor||n.frameColor,this._manager.detachActivities(this._ownerActivityId,n)},t}(),Ge=function(t){setTimeout(t,0)};function He(t,e){if(!Me(e))return t;t.then((function(t){Ge((function(){e(null,t)}))}),(function(t){Ge((function(){e(t,null)}))}))}var Ue=function(t){function e(e,n,r,i,o){var s=t.call(this,e)||this;return s._id=e,s._actType=n,s._status=r,s._context=i,s._ownerId=o,s._agm=new Be(s),s}return h(e,t),Object.defineProperty(e.prototype,"type",{get:function(){if(this._manager)return this._manager.getActivityType(this._actType)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return this._context},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"status",{get:function(){return this._status},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"owner",{get:function(){return this._ownerId?this._manager.getWindows({id:this._ownerId})[0]:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windows",{get:function(){return this._manager.getWindows({activityId:this._id})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"agm",{get:function(){return this._agm},enumerable:!0,configurable:!0}),e.prototype.addWindow=function(t,e){return this._manager.addWindowToActivity(this,t,e)},e.prototype.createWindow=function(t,e){return this._manager.createWindow(this,t,e)},e.prototype.createStackedWindows=function(t,e,n){return this._manager.createStackedWindows(this,t,e,n)},e.prototype.leave=function(t,e){return this._manager.leaveWindowFromActivity(this,t,e)},e.prototype.getWindowsByType=function(t){var e={activityId:this._id,type:t};return this._manager.getWindows(e)},e.prototype.setContext=function(t,e){return this._manager.setActivityContext(this,t,e)},e.prototype.updateContext=function(t,e){return this._manager.updateActivityContext(this,t,e)},e.prototype.onStatusChange=function(t){var e=this;return this._manager.subscribeActivityEvents((function(n,r,i){n.id===e.id&&t(n,r,i)}))},e.prototype.onWindowEvent=function(t){var e=this;return this._manager.subscribeWindowEvents((function(n,r,i){n.id===e.id&&t(n,r,i)}))},e.prototype.onContextChanged=function(t){var e=this;this._manager.subscribeActivityContextChanged((function(n,r,i,o){n.id===e.id&&t(r,i,o,n)}));try{t(this.context,this.context,[],this)}catch(t){return}},e.prototype.stop=function(){this._manager.stopActivity(this)},e.prototype.clone=function(t){return this._manager.clone(this,t)},e.prototype.attach=function(t,e){var n;return n="string"==typeof t?t:t.id,this._manager.attachActivities(n,this.id,e)},e.prototype.onActivityAttached=function(t){var e=this;this._manager.subscribeActivitiesAttached((function(n,r,i){n===e._id&&t(i)}))},e.prototype.onDetached=function(t){var e=this;this._manager.subscribeActivitiesDetached((function(n,r,i){r.id===e._id&&t(n,i)}))},e.prototype._updateCore=function(e){var n=this;t.prototype._updateCore.call(this,e),je(e._actType,(function(t){return n._actType=t})),je(e._context,(function(t){return n._context=t})),je(e._ownerId,(function(t){return n._ownerId=t})),!e._status||this._status&&this._status.state===e._status.state||(this._status=e._status)},e.prototype._updateDescriptors=function(t){var e=this;this._attached=t.map((function(t){return new qe(e._manager,e._id,t)}))},Object.defineProperty(e.prototype,"attached",{get:function(){return this._attached},enumerable:!0,configurable:!0}),e.prototype.setFrameColor=function(t,e){var n=this;return He(new Promise((function(e,r){var i=n.windows.length;0===i&&e(n),n.windows.forEach((function(r){r.underlyingWindow.setFrameColor(t,(function(){--i<=0&&e(n)}))})),setTimeout((function(){i>0&&r(n.id+" - timed out waiting for setFrameColor with"+t)}),5e3)})),e)},e.prototype.getFrameColor=function(){return this.windows&&0!==this.windows.length?this.windows[0].underlyingWindow.frameColor:""},e}(ke),Ve=function(){function t(){}return t.Trace="trace",t.Debug="debug",t.Info="info",t.Warn="warn",t.Error="error",t}(),Je=function(){function t(e){this._name=e,Pe(t.GlueLogger)||(this._glueLogger=t.GlueLogger.subLogger(e))}return t.GetNamed=function(e){return new t(e)},t.Get=function(e){return new t(t.GetTypeName(e))},t.prototype.trace=function(e){Pe(this._glueLogger)?t.Level===Ve.Trace&&console.info(this._getMessage(e,Ve.Trace)):this._glueLogger.trace(e)},t.prototype.debug=function(e){Pe(this._glueLogger)?t.Level!==Ve.Debug&&t.Level!==Ve.Trace||console.info(this._getMessage(e,Ve.Debug)):this._glueLogger.debug(e)},t.prototype.info=function(e){Pe(this._glueLogger)?t.Level!==Ve.Debug&&t.Level!==Ve.Trace&&t.Level!==Ve.Info||console.info(this._getMessage(e,Ve.Info)):this._glueLogger.info(e)},t.prototype.warn=function(e){Pe(this._glueLogger)?t.Level!==Ve.Debug&&t.Level!==Ve.Trace&&t.Level!==Ve.Info&&t.Level!==Ve.Warn||console.info(this._getMessage(e,Ve.Info)):this._glueLogger.warn(e)},t.prototype.error=function(t){Pe(this._glueLogger)?(console.error(this._getMessage(t,Ve.Error)),console.trace()):this._glueLogger.error(t)},t.prototype._getMessage=function(t,e){return"["+e+"] "+this._name+" - "+t},t.GetTypeName=function(t){var e=/function (.{1,})\(/.exec(t.constructor.toString());return e&&e.length>1?e[1]:""},t.Level=Ve.Info,t}(),ze=function(t){function e(e,n,r,i,o,s,a,c){var u=t.call(this,e)||this;return u._logger=Je.Get("window"),u._type=r,u._activityId=i,u._name=n,u._instance=o,u._isIndependent=s,u._windowGetter=a,u._hcWindowId=c,u}return h(e,t),e.prototype.getBounds=function(){return this._manager.getWindowBounds(this.id)},Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isIndependent",{get:function(){return this._isIndependent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"type",{get:function(){if(this._manager)return this._manager.getWindowType(this._type)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"activity",{get:function(){if(!Te(this._activityId))return this._manager.getActivityById(this._activityId)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isOwner",{get:function(){var t=this.activity;return!Te(t)&&t.owner.id===this.id},enumerable:!0,configurable:!0}),e.prototype.setVisible=function(t,e){return this._manager.setWindowVisibility(this.id,t)},e.prototype.activate=function(t){return this._manager.activateWindow(this.id,t)},e.prototype.setBounds=function(t,e){return this._manager.setWindowBounds(this.id,t,e)},e.prototype.close=function(){return this._manager.closeWindow(this.id)},Object.defineProperty(e.prototype,"instance",{get:function(){return this._instance},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"underlyingWindow",{get:function(){var t=this._windowGetter();return t||{id:this._hcWindowId}},enumerable:!0,configurable:!0}),e.prototype.onActivityJoined=function(t){this._subscribeForActivityWindowEvent(De.ActivityWindowJoinedActivity,t)},e.prototype.onActivityRemoved=function(t){this._subscribeForActivityWindowEvent(De.ActivityWindowLeftActivity,t)},e.prototype._updateCore=function(t){var e=this;je(t._activityId,(function(t){return e._activityId=t})),je(t._isIndependent,(function(t){return e._isIndependent=t})),je(t._hcWindowId,(function(t){return e._hcWindowId=t})),je(t._type,(function(t){return e._type=t})),je(t._name,(function(t){return e._name=t})),Pe(t._instance)||(this._instance=t._instance)},e.prototype._subscribeForActivityWindowEvent=function(t,e){var n=this;this._manager.subscribeWindowEvents((function(r,i,o){i.id===n.id&&o===t&&e(r)}))},e.prototype._beforeDelete=function(t){this._hcWindowId=t._hcWindowId},e}(ke),Ke=function(){function t(t,e,n){this.state=t,this.message=e,this.time=n}return t.prototype.getState=function(){return this.state},t.prototype.getMessage=function(){return this.message},t.prototype.getTime=function(){return this.time},t}(),Ye="error",Ze="add-types",Xe="created",$e="destroyed",Qe="initiated",tn="joined",en="activity-joined",nn="left",rn="owner-changed",on="add-peer-factories",sn="peer-factories-added",an="peer-factories-removed",cn="peer-created",un=function(){function t(t){var e=this;if(this._activityChangeCallbacks=[],this._activityTypeStatusChangeCallbacks=[],this._activityWindowChangeCallbacks=[],this._windowTypeStatusChangeCallbacks=[],this._peerIdAndFactoryIdToPeerType={},this._peerFactoriesRegisteredByUs={},this._gw3Subscriptions=[],this._contextSubscriptions={},this._activityTypesInitiatedFromMe={},this._config=t,this._connection=t.connection,this._logger=t.logger,this._contexts=t.contexts,this._windows=t.windows,this._sessionJoinedPromise=new Promise((function(t){e._sessionJoinedPromiseResolve=t})),this._activityJoinedPromise=new Promise((function(t){e._activityJoinedPromiseResolve=t})),this._config.activityId||this._activityJoinedPromiseResolve({}),this._gw3Session=this._connection.domain("activity",["joined","initiated","peer-created","token"]),"undefined"!=typeof window){var n=window.glue42gd;n&&"function"==typeof n.addRefreshHandler&&n.addRefreshHandler((function(t,r){e._gw3Session.send({type:"reload"}).then((function(e){if(e.token){try{n.setGWToken(e.token)}catch(t){return void r(t.message||t)}t()}else r("Expected gateway token for refreshing.")}),r)}))}}return t.activityTypeGwMessageEntityToActivityType=function(t,e){var n=function(t){return new Oe(t,void 0)};return new Ee(t.name,t.owner_type&&n(t.owner_type),t.helper_types&&t.helper_types.map(n),e)},t.peerFactoryGwMessageEntityToWindowType=function(t){return new Oe(t.peer_type,(function(t){}))},t.activityGwMessageToActivity=function(t,e){var n=void 0!==t.owner?t.owner.peer_id:t.owner_id;return new Ue(t.activity_id,t.activity_type,e,t.context_snapshot,n)},t.activityToActivityStatusChangeEvent=function(t){return new Re(t,new Le(t.status,void 0))},Object.defineProperty(t.prototype,"bridgeType",{get:function(){return"GW3"},enumerable:!0,configurable:!0}),t.prototype.init=function(){var t=this;this.forwardActivityTypeMessagesToStatusEventHandlers(),this.subscribe(Xe,this.handleActivityCreatedMessage),this.subscribe($e,this.handleActivityDestroyedMessage),this.forwardActivityMessagesToStatusEventHandlers(),this.forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers(),this.forwardPeerFactoryMessagesToStatusEventHandlers(),this.forwardPeerFactoryMessagesToPeerFactoryRequests(),this.subscribe(sn,this.handlePeerFactoriesAdded),this.subscribe(an,this.handlePeerFactoriesRemoved),this.forwardActivityWindowMessagesToEventHandlers(),this.subscribe("dispose-peer",(function(){if("dispose"!==t._config.disposeRequestHandling){if("exit"===t._config.disposeRequestHandling){if(t._windows&&void 0!==t._windows.my())return void t._windows.my().close();if("undefined"!=typeof window&&"function"==typeof window.close)return void window.close();if("undefined"!=typeof process&&"function"==typeof process.exit)return void process.exit()}}else t.dispose()})),this._gw3Session.onJoined((function(){"trackMyOnly"===t._config.mode||"trackMyTypeAndInitiatedFromMe"===t._config.mode?t._sessionJoinedPromiseResolve(t):t._gw3Session.send({type:"subscribe",activity_types:"trackAll"===t._config.mode?[]:"trackTypes"===t._config.mode?t._config.typesToTrack:[]}).then((function(){t._sessionJoinedPromiseResolve(t)}))})),this._gw3Session.join()},t.prototype.dispose=function(){var t=this;this._gw3Subscriptions.forEach((function(e){return e&&t._connection.off(e)})),this._gw3Subscriptions.length=0},t.prototype.ready=function(){return Promise.all([this._sessionJoinedPromise,this._activityJoinedPromise])},t.prototype.initReady=function(){return this._sessionJoinedPromise},t.prototype.onActivityTypeStatusChange=function(t){this._activityTypeStatusChangeCallbacks.push(t)},t.prototype.registerActivityType=function(e,n,r,i,o){var s=this,a={};a.name=e;var c=function(t){return{type:t.type,name:t.name,configuration:t}};return a.owner_type=c(n),a.helper_types=r.map(c),this._gw3Session.send({type:Ze,types:[a]}).then((function(){var e=t.activityTypeGwMessageEntityToActivityType(a,o);return s.invokeCallbacks(s._activityTypeStatusChangeCallbacks,new Re(e,new Ne(De.Added)),Ze),e}))},t.prototype.unregisterActivityType=function(t){var e=this;return this._gw3Session.send({type:"remove-types",types:[t]}).then((function(){var n=new Ee(t,void 0,void 0,void 0);e.invokeCallbacks(e._activityTypeStatusChangeCallbacks,new Re(n,new Ne(De.Removed)),Ze)}))},t.prototype.onWindowTypeStatusChange=function(t){this._windowTypeStatusChangeCallbacks.push(t)},t.prototype.registerWindowFactory=function(e,n,r){var i=this;if(this._peerFactoriesRegisteredByUs[e])return Promise.reject(new Error("Factory for windowType "+e+" already registered."));this._peerFactoriesRegisteredByUs[e]=n;var o={id:e,peer_type:e,configuration:r};return this._gw3Session.send({type:on,factories:[o]}).then((function(){i.invokeCallbacks(i._windowTypeStatusChangeCallbacks,new Re(t.peerFactoryGwMessageEntityToWindowType(o),new Ne(De.Added)),on)})).catch((function(){delete i._peerFactoriesRegisteredByUs[e]}))},t.prototype.unregisterWindowFactory=function(t){var e=this;return this._peerFactoriesRegisteredByUs[t]?(delete this._peerFactoriesRegisteredByUs[t],this._gw3Session.send({type:"remove-peer-factories",factory_ids:[t]}).then((function(){e.invokeCallbacks(e._windowTypeStatusChangeCallbacks,new Re(new Oe(t,void 0),new Ne(De.Removed)),on)}))):Promise.reject(new Error("Factory for windowType "+t+" not registered."))},t.prototype.onActivityStatusChange=function(t){this._activityChangeCallbacks.push(t)},t.prototype.initiateActivity=function(t,e,n){var r=this,i={type:"create",activity_type:t,initial_context:e};return this.isOverrideTypeDefinition(n)?i.types_override={owner_type:{type:n.owner.type,name:n.owner.name,configuration:n.owner},helper_types:n.helpers&&n.helpers.map((function(t){return{type:t.type,name:t.name,configuration:t}}))}:i.configuration=n&&n.map((function(t){return{type:t.type,name:t.name,configuration:t}})),this.sendCreateAndMapResultingMessagesToPromise(i,Qe,(function(t,e){return t.request_id===e}),Xe,(function(t,e,n){return t.activity_id===n.activity_id}),$e,(function(t,e,n){return t.activity_id===n.activity_id}),(function(t){return t.activity_id})).then((function(e){return"trackMyTypeAndInitiatedFromMe"!==r._config.mode||r._activityTypesInitiatedFromMe[t]?e:(r._activityTypesInitiatedFromMe[t]=!0,r._gw3Session.send({type:"subscribe",activity_types:[t]}).then((function(){return e})))}))},t.prototype.stopActivity=function(t){return this._gw3Session.send({type:"destroy",activity_id:t.id,reason_uri:"com.tick42.glue.activity.constants.destroyReason.general",reason:"Destroying activity"}).then((function(t){return!0}))},t.prototype.updateActivityContext=function(t,e,n,r){if(n)return this._contexts.set(t.id,e);for(var i=0,o=r=r||[];i<o.length;i++){e[o[i]]=null}return this._contexts.update(t.id,e)},t.prototype.announceWindow=function(t,e){throw new Error("Invalid operation 'announceWindow' for GW3 protocol")},t.prototype.registerWindow=function(t,e,n){var r=void 0!==this._connection.gatewayToken,i=this._connection.peerId;if("undefined"!=typeof window){var o=window.glue42gd;o&&(r=void 0!==o.activityInfo)}return r&&this._gw3Session.send({type:"ready"}),this.invokeCallbacks(this._activityWindowChangeCallbacks,new Re(new ze(i,e,t,void 0,this.getAgmInstance(i),n,this.generateWindowGetter(i),void 0),new Ne(De.Added)),"register window"),Promise.resolve(i)},t.prototype.onActivityWindowChange=function(t){this._activityWindowChangeCallbacks.push(t)},t.prototype.createWindow=function(t,e){var n=this;return e.layout||(e.left||e.width||e.height||e.top)&&(e.layout={mode:"pixels",cellSize:1}),this.sendCreateAndMapResultingMessagesToPromise({type:"create-peer",peer_type:e.type,peer_name:e.name||e.type,configuration:e,activity_id:t},void 0,void 0,cn,(function(t,e){return t.request_id===e}),void 0,void 0,(function(t){return t.created_id})).then((function(r){if(t)return n.joinActivity(t,r,e.name).then((function(){return r}))}))},t.prototype.closeWindow=function(t){return this._gw3Session.send({type:"destroy-peer",destroy_peer_id:t}).then((function(t){}))},t.prototype.getAnnouncementInfo=function(){var t=this._config.activityId||this._config.announcementInfo&&this._config.announcementInfo.activityId,e=this._config.announcementInfo&&this._config.announcementInfo.activityWindowType,n=this._config.announcementInfo&&this._config.announcementInfo.activityWindowIndependent,r=this._config.announcementInfo&&this._config.announcementInfo.activityWindowName;if("undefined"!=typeof window&&void 0!==window.location&&window.location.search&&"function"==typeof URLSearchParams){var i=new URLSearchParams(location.search.slice(1));e=(e=e||i.get("t42PeerType"))||i.get("t42ActivityWindowType"),void 0===n&&(n=i.get("t42ActivityWindowIndependent")),r=r||i.get("t42ActivityWindowName"),t=t||i.get("t42ActivityId")}return{activityWindowId:void 0,activityId:t,activityWindowType:e=e||"unknown",activityWindowIndependent:n=n||!1,activityWindowName:r=r||this._connection.peerId}},t.prototype.joinActivity=function(t,e,n){var r=this,i=n&&{name:n}||{};return this._gw3Session.send(f({type:"join-activity",target_id:e,activity_id:t},i)).then((function(){r.invokeCallbacks(r._activityWindowChangeCallbacks,new Re(new ze(e,void 0,void 0,t,r.getAgmInstance(e),void 0,r.generateWindowGetter(e),void 0),new Ne(De.ActivityWindowJoinedActivity)),"activity joined - ActivityWindow"),r.invokeCallbacks(r._activityChangeCallbacks,new Re(new Ue(t,void 0,new Ke("created",void 0,void 0),void 0,void 0),new Ne(De.Updated)),"activity joined - Activity")}))},t.prototype.leaveActivity=function(t,e){var n=this;return this._gw3Session.send({type:"leave-activity",target_id:e,activity_id:t}).then((function(){n.invokeCallbacks(n._activityWindowChangeCallbacks,new Re(new ze(e,void 0,void 0,null,n.getAgmInstance(e),void 0,n.generateWindowGetter(e),void 0),new Ne(De.ActivityWindowLeftActivity)),"activity left - ActivityWindow"),n.invokeCallbacks(n._activityChangeCallbacks,new Re(new Ue(t,void 0,new Ke("created",void 0,void 0),void 0,void 0),new Ne(De.Updated)),"activity left - Activity")}))},t.prototype.getActivityTypes=function(){return Promise.resolve([])},t.prototype.getWindowTypes=function(){return Promise.resolve([])},t.prototype.getActivities=function(){return Promise.resolve([])},t.prototype.getActivityWindows=function(){return Promise.resolve([])},t.prototype.createStackedWindows=function(t,e,n){},t.prototype.getWindowBounds=function(t){},t.prototype.setWindowBounds=function(t,e){},t.prototype.activateWindow=function(t,e){},t.prototype.setWindowVisibility=function(t,e){},t.prototype.cloneActivity=function(t,e){},t.prototype.attachActivities=function(t,e,n){return this._gw3Session.send({type:"merge",into:e,merge:t})},t.prototype.detachActivities=function(t,e){return this._gw3Session.send({type:"split",from:t}).then((function(){return""}))},t.prototype.onActivitiesAttached=function(t){},t.prototype.onActivitiesDetached=function(t){},t.prototype.onActivityAttachedDescriptorsRefreshed=function(t){},t.prototype.getAttachedDescriptors=function(){return Promise.resolve([])},t.prototype.getRandomRequestId=function(){return this._connection.peerId+":"+Math.floor(1e9*Math.random())},t.prototype.forwardAddedAndRemovedMessagesToEventHandler=function(t,e,n,r){var i=function(t){return function(e){return new Re(e,new Ne(t?De.Added:De.Removed))}};return[t&&this.forwardMessageToEventHandler(t,(function(t){return n(t,!0)}),i(!0),r),e&&this.forwardMessageToEventHandler(e,(function(t){return n(t,!1)}),i(!1),r)].filter((function(t){return t}))},t.prototype.forwardMessageToEventHandler=function(t,e,n,r){return this.subscribe(t,(function(t){e(t).forEach((function(e){return r.forEach((function(r){return r(n(e,t))}))}))}))},t.prototype.sendCreateAndMapResultingMessagesToPromise=function(t,e,n,r,i,o,s,a){var c,u,d,p,h,f,l=this,v=this.getRandomRequestId(),y=new Promise((function(t,e){c=t,u=e})),g=null,m=function(){l.dropSubscription(d),l.dropSubscription(p),l.dropSubscription(h),l.dropSubscription(f)};d=e&&this.subscribe(e,(function(t){n(t,v)&&(g=t,l.dropSubscription(d))})),p=this.subscribe(r,(function(t){i(t,v,g)&&c(a(t))})),h=o&&this.subscribe(o,(function(t){s(t,v,g)&&u(t)})),f=o&&this.subscribe(Ye,(function(t){t.request_id===v&&u(t)})),t.request_id=v;var w=this._gw3Session.send(t).then((function(){return y}));return w.then(m,m),w},t.prototype.peerFactoryIdAndOwnerIdToWindowType=function(t,e){var n=this._peerIdAndFactoryIdToPeerType[e+":"+t];return n?new Oe(n,void 0):null},t.prototype.subscribe=function(t,e){var n=this,r=this._connection.on(t,(function(t){return e.bind(n)(t)}));return this._gw3Subscriptions.push(r),r},t.prototype.dropSubscription=function(t){t&&(this._connection.off(t),delete this._gw3Subscriptions[this._gw3Subscriptions.indexOf(t)])},t.prototype.invokeCallbacks=function(t,e,n){var r=this;t.forEach((function(t){try{t(e)}catch(t){r._logger.error("Error in "+(n||e.context.type)+" callback: "+JSON.stringify(t))}}))},t.prototype.handleActivityCreatedMessage=function(t){t.context_id?this._contextSubscriptions[t.activity_id]||this.subscribeToContext(t):this._logger.error("Activity created with unknown context_id: "+t.activity_id)},t.prototype.subscribeToContext=function(t){return l(this,void 0,void 0,(function(){var e,n,r,i=this;return v(this,(function(o){switch(o.label){case 0:return e=t.activity_id,n=this._contextSubscriptions,r=e,[4,this._contexts.subscribe(e,(function(t,n,r){var o=new Re(new Ue(e,void 0,void 0,t,void 0),new We(t,n,r));i.invokeCallbacks(i._activityChangeCallbacks,o,"context updated")}))];case 1:return n[r]=o.sent(),[2]}}))}))},t.prototype.handleActivityDestroyedMessage=function(t){var e=this._contextSubscriptions[t.activity_id];"function"==typeof e&&e(),delete this._contextSubscriptions[t.activity_id]},t.prototype.handlePeerFactoriesAdded=function(t){var e=this;t.factories.forEach((function(n){e._peerIdAndFactoryIdToPeerType[t.owner_id+":"+n.id]=n.peer_type}))},t.prototype.handlePeerFactoriesRemoved=function(t){var e=this;t.factory_ids.forEach((function(n){delete e._peerIdAndFactoryIdToPeerType[t.owner_id+":"+n]}))},t.prototype.forwardActivityTypeMessagesToStatusEventHandlers=function(){this.forwardAddedAndRemovedMessagesToEventHandler("types-added","types-removed",(function(e,n){return n?e.types.map((function(e){return t.activityTypeGwMessageEntityToActivityType(e,void 0)})):e.types.map((function(t){return new Ee(t.name,void 0,void 0,void 0)}))}),this._activityTypeStatusChangeCallbacks)},t.prototype.forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers=function(){for(var t=this,e=0,n=[Xe,tn,rn];e<n.length;e++){var r=n[e];this.forwardMessageToEventHandler(r,(function(e){return[e.owner||f(f({},e),{type:e.peer_type,name:e.peer_name,peer_id:e.owner_id})].concat(e.participants||[]).map((function(n){return new ze(n.peer_id,n.name,n.type,e.activity_id,t.getAgmInstance(n.peer_id),void 0,t.generateWindowGetter(n.peer_id),void 0)}))}),(function(t,e){return new Re(t,new Ne(De.ActivityWindowJoinedActivity))}),this._activityWindowChangeCallbacks)}},t.prototype.forwardActivityMessagesToStatusEventHandlers=function(){for(var e=0,n=[Xe,tn];e<n.length;e++){var r=n[e];this.forwardMessageToEventHandler(r,(function(e){return[t.activityGwMessageToActivity(e,new Ke("started","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks)}this.forwardMessageToEventHandler($e,(function(e){return[t.activityGwMessageToActivity(e,new Ke("destroyed",e.reason,new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks),this.forwardMessageToEventHandler(Qe,(function(e){return[t.activityGwMessageToActivity(e,new Ke("created","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks),this.forwardMessageToEventHandler(rn,(function(e){return[t.activityGwMessageToActivity(e,new Ke("created","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks)},t.prototype.forwardPeerFactoryMessagesToStatusEventHandlers=function(){var e=this;this.forwardAddedAndRemovedMessagesToEventHandler(sn,an,(function(n,r){return r?n.factories.map(t.peerFactoryGwMessageEntityToWindowType):n.factory_ids.map((function(t){return e.peerFactoryIdAndOwnerIdToWindowType(t,n.owner_id)})).filter((function(t){return null!=t}))}),this._windowTypeStatusChangeCallbacks)},t.prototype.forwardPeerFactoryMessagesToPeerFactoryRequests=function(){var t=this;this.subscribe("peer-requested",(function(e){var n=t._peerFactoriesRegisteredByUs[e.peer_factory];if(n)try{var r=e.configuration||{};r.gateway_token=r.gateway_token||e.gateway_token,r.peer_factory=r.peer_factory||e.peer_factory;var i=n({activityId:e.activity&&e.activity.id,activityType:e.activity&&e.activity.type,type:e.configuration&&e.configuration.type,gwToken:r.gateway_token,configuration:r});i&&i.then&&i.catch&&i.catch((function(n){return t._gw3Session.send({type:Ye,request_id:e.request_id,reason:n&&(n.message||JSON.stringify(n))})}))}catch(n){t._gw3Session.send({type:Ye,request_id:e.request_id,reason:n&&(n.message||JSON.stringify(n))})}else t._gw3Session.send({type:Ye,request_id:e.request_id,reason:"Unknown peer factory "+e.peer_factory})}))},t.prototype.forwardActivityWindowMessagesToEventHandlers=function(){for(var t=this,e=function(e){n.subscribe(e,(function(n){var r=e===en?n.joined_id:n.peer_id,i=e===en?n.joined_type:n.peer_type,o=e===en?n.joined_name:n.peer_name,s=new ze(r,o,i,n.activity_id,t.getAgmInstance(r),void 0,t.generateWindowGetter(r),void 0);t._contextSubscriptions[n.activity_id]?e===tn&&t._activityJoinedPromiseResolve({}):t.subscribeToContext(n).then((function(){e===tn&&t._activityJoinedPromiseResolve({})})),t.invokeCallbacks(t._activityWindowChangeCallbacks,new Re(s,new Ne(De.ActivityWindowJoinedActivity)),e)}))},n=this,r=0,i=[en,tn];r<i.length;r++){e(i[r])}this.subscribe(nn,(function(e){var n=new ze(e.left_id,void 0,void 0,null,t.getAgmInstance(e.left_id),void 0,t.generateWindowGetter(e.left_id),void 0);t.invokeCallbacks(t._activityWindowChangeCallbacks,new Re(n,new Ne(De.ActivityWindowLeftActivity)),nn)})),this.forwardAddedAndRemovedMessagesToEventHandler(cn,void 0,(function(e){return[new ze(e.created_id,void 0,void 0,void 0,void 0,void 0,t.generateWindowGetter(e.created_id),void 0)]}),this._activityWindowChangeCallbacks)},t.prototype.getAgmInstance=function(t){return this._config.agm.servers().find((function(e){return e.peerId===t||e.windowId===t}))},t.prototype.generateWindowGetter=function(t){var e=this;return function(){var n=e.getAgmInstance(t);if(n){var r=n.windowId;return e._config.windows.list().filter((function(t){return t.id===r}))[0]}}},t.prototype.isOverrideTypeDefinition=function(t){return void 0!==t&&!!t.owner},t}(),dn=function(){function t(t,e){var n=this;this._myAttached=[],this._myDetached=[],this._myAttachedTo=[],this._myDetachedFrom=[],this._myActivityFrameColorChanged=[],this._myActivityJoinedCallbacks=[],this._myActivityRemovedCallbacks=[],this._myContextUpdateCallbacks=[],this._logger=Je.Get(this),this._m=t,t.ready().then((function(t){t.subscribeActivityContextChanged(n._subscribeMyContextChanged.bind(n)),t.subscribeWindowEvents(n._subscribeMyWindowEvent.bind(n)),t.subscribeActivitiesAttached(n._subscribeActivitiesAttached.bind(n)),t.subscribeActivitiesDetached(n._subscribeActivitiesDetached.bind(n)),e&&e.onWindowFrameColorChanged(n._subscribeWindowFrameColorChanged.bind(n))}))}return Object.defineProperty(t.prototype,"window",{get:function(){if(Pe(this._w)){var t=this._m.announcedWindows;t.length>0&&(this._w=t[0])}return this._w},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activity",{get:function(){var t=this.window;if(!Pe(t))return t.activity},enumerable:!0,configurable:!0}),t.prototype.createWindow=function(t){return this._m.createWindow(this.activity,t)},t.prototype.createStackedWindows=function(t,e){return this._m.createStackedWindows(this.activity,t,e)},Object.defineProperty(t.prototype,"context",{get:function(){var t=this.activity;return Te(t)?{}:t.context},enumerable:!0,configurable:!0}),t.prototype.updateContext=function(t,e){var n=this.activity;return Te(n)?new Promise((function(t,e){e("Not in activity")})):n.updateContext(t,e)},t.prototype.setContext=function(t,e){var n=this.activity;return Te(n)?new Promise((function(t,e){e("Not in activity")})):n.setContext(t,e)},t.prototype.onActivityJoined=function(t){this._myActivityJoinedCallbacks.push(t);var e=this.window;Pe(e)||Pe(e.activity)||t(e.activity)},t.prototype.onActivityLeft=function(t){this._myActivityRemovedCallbacks.push(t)},t.prototype.onContextChanged=function(t){this._myContextUpdateCallbacks.push(t);var e=this.window;if(!Pe(e)){var n=e.activity;Pe(n)||t(n.context,n.context,[],n)}},t.prototype.clone=function(t,e){var n=this.activity;return this._m.clone(n,t,e)},t.prototype.attach=function(t,e){var n;return n="string"==typeof t?t:t.id,this._m.attachActivities(n,this.activity.id,e)},t.prototype.onActivityAttached=function(t){this._myAttached.push(t)},t.prototype.onActivityDetached=function(t){this._myDetached.push(t)},t.prototype.onAttachedToActivity=function(t){this._myAttachedTo.push(t)},t.prototype.onDetachedFromActivity=function(t){this._myDetachedFrom.push(t)},Object.defineProperty(t.prototype,"attached",{get:function(){return this.activity?this.activity.attached:[]},enumerable:!0,configurable:!0}),t.prototype.setFrameColor=function(t,e){return this.activity?this.activity.setFrameColor(t,e):Promise.resolve(null)},t.prototype.getFrameColor=function(){return this.activity?this.activity.getFrameColor():""},t.prototype.onFrameColorChanged=function(t){this._myActivityFrameColorChanged.push(t)},t.prototype._subscribeMyContextChanged=function(t,e,n,r){var i=this.window;if(!Pe(i)){var o=i.activity;Pe(o)||t.id===o.id&&this._notifyMyContextChanged(t,e,n,r)}},t.prototype._subscribeMyWindowEvent=function(t,e,n){Pe(this.window)||this.window.id===e.id&&(n===De.ActivityWindowJoinedActivity?(this._notifyMyWindowEvent(t,this._myActivityJoinedCallbacks),this._notifyMyContextChanged(t,t.context,null,null)):n===De.ActivityWindowLeftActivity&&this._notifyMyWindowEvent(t,this._myActivityRemovedCallbacks))},t.prototype._notifyMyWindowEvent=function(t,e){var n=this;e.forEach((function(e){try{e(t,event)}catch(t){n._logger.warn("error in user callback "+t)}}))},t.prototype._notifyMyContextChanged=function(t,e,n,r){var i=this;n=n||{},r=r||[],this._myContextUpdateCallbacks.forEach((function(o){try{o(e,n,r,t)}catch(t){i._logger.warn("error in user callback "+t)}}))},t.prototype._notifyAttached=function(t){var e=this;this._myAttached.forEach((function(n){try{n(t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyDetached=function(t){var e=this;this._myDetached.forEach((function(n){try{n(t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyAttachedTo=function(t){var e=this;this._myAttachedTo.forEach((function(n){try{n(e.activity,t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyDetachedFrom=function(t,e,n){var r=this;this._myDetachedFrom.forEach((function(i){try{i(t,e,n)}catch(t){r._logger.warn("error in user callback "+t)}}))},t.prototype._subscribeActivitiesAttached=function(t,e){var n=this.window;if(!Pe(n)){var r=n.activity;Pe(r)||t.id===r.id&&(e.windowIds.indexOf(n.id)>=0?this._notifyAttachedTo(e):this._notifyAttached(e))}},t.prototype._subscribeActivitiesDetached=function(t,e,n){var r=this.window;if(!Pe(r)){var i=r.activity;Pe(i)||(e.id===i.id&&this._notifyDetached(n),t.id===i.id&&this._notifyDetachedFrom(t,e,n))}},t.prototype._subscribeWindowFrameColorChanged=function(t){var e=this.activity;e&&e.owner&&e.owner.underlyingWindow.id===t.id&&this._myActivityFrameColorChanged.forEach((function(e){e(t.frameColor)}))},t}(),pn=function(){function t(t,e){if(this._logger=Je.Get("ReadyMarker ["+t+"]"),this._logger.debug("Initializing ready marker for '"+t+"' with "+e+" signals to wait"),e<=0)throw new Error("Invalid signal number. Should be > 0");this._signals=e,this._callbacks=[],this._name=t}return t.prototype.setCallback=function(t){this.isSet()?t(void 0):this.isError()?t(this._error):this._callbacks.push(t)},t.prototype.signal=function(t){if(this._logger.debug("Signaled - "+t+" - signals left "+(this._signals-1)),this._signals--,this._signals<0)throw new Error("Error in ready marker '"+this._name+" - signals are "+this._signals);this.isSet()&&this._callbacks.forEach((function(t){t(void 0)}))},t.prototype.error=function(t){this._error=t,this._callbacks.forEach((function(e){e(t)}))},t.prototype.isSet=function(){return!this.isError()&&0===this._signals},t.prototype.isError=function(){return!Te(this._error)},t.prototype.getError=function(){return this._error},t}(),hn=function(){function t(t){this._items={},this._listeners=[],this._processNew=t}return t.prototype.addOne=function(t){this.add([t])},t.prototype.add=function(t){var e=this;t.forEach((function(t){e.process(new Re(t,new Ne(De.Added)))}))},t.prototype.process=function(t){var e=t.context,n=e.type,r=t.entity;if(n===De.StatusChange&&!e.oldStatus){var i=this._items[r.id];i&&(e.oldStatus=i.status)}n===De.StatusChange&&e.oldStatus&&e.newStatus&&e.oldStatus.state===e.newStatus.state&&(e.type=De.Updated),"undefined"==typeof htmlContainer&&(n===De.ActivityWindowJoinedActivity&&this._items[r.id]&&this._items[r.id].activity&&(e.type=De.Updated),n===De.ActivityWindowLeftActivity&&this._items[r.id]&&!this._items[r.id].activity&&(e.type=De.Updated));var o=this._updateInternalCollections(r,n,e);return this._notifyListeners(o,e),o},t.prototype.get=function(){var t=[];for(var e in this._items)if(this._items.hasOwnProperty(e)){var n=this._items[e];t.push(n)}return t},t.prototype.getByName=function(t){for(var e in this._items)if(e===t)return this._items[e]},t.prototype.getOrWait=function(t){var e=this;return new Promise((function(n){var r=function(i){i.id===t&&(n(i),e.unsubscribe(r))};e.subscribe(r);var i=e.getByName(t);if(i)return e.unsubscribe(r),void n(i)}))},t.prototype.subscribe=function(t){var e=this;return this._listeners.push(t),Object.keys(this._items).forEach((function(n){var r=e._items[n];t(r,new Ne(De.Added.toString()))})),function(){e.unsubscribe(t)}},t.prototype.unsubscribe=function(t){var e=this._listeners.indexOf(t);-1!==e&&this._listeners.splice(e,1)},t.prototype._notifyListeners=function(t,e){this._listeners.forEach((function(n){try{n(t,e)}catch(t){return}}))},t.prototype._updateInternalCollections=function(t,e,n){var r=t,i=e===De.StatusChange&&r.status&&r.status.state===Fe.Destroyed||e===De.StatusChange&&n&&n.newStatus&&n.newStatus.state===Fe.Destroyed,o=e===De.Closed;if(e===De.Removed&&void 0===r.isIndependent||o||i){var s=this._items[t.id];return delete this._items[t.id],this._processNew(t),s&&t._beforeDelete(s),t}var a=t.id;return this._items.hasOwnProperty(a)?this._items[t.id]._update(t):(this._processNew(t),this._items[t.id]=t),this._items[t.id]},t}(),fn=function(){function t(t,e,n){var r=this;this._logger=Je.Get("activityManager"),this._announcedWindows=[],this._attachedCallbacks=[],this._detachedCallbacks=[],this._frameColorChangesCallbacks=[],this._windowHandlers=[],this._bridge=t,this._activityTypes=new hn((function(t){return r._grabEntity(t)})),this._windowTypes=new hn((function(t){return r._grabEntity(t)})),this._activities=new hn((function(t){return r._grabEntity(t)})),this._windows=new hn((function(t){return r._grabEntity(t)})),this._dataReadyMarker=new pn("Activity Manager Data",["GetActivityTypes","GetWindowTypes","GetActivities","GetWindows"].length),this._descriptorsMarker=new pn("Attached Activities Descriptors",["GetDescriptors"].length),e?(this._readyMarker=new pn("Activity Manager Announce",["Announcement"].length),this._dataReadyMarker.setCallback((function(t){t&&r._readyMarker.error(t),r._descriptorsMarker.setCallback((function(t){t&&r._readyMarker.error(t),r._logger.debug("Auto announcing window"),r.announceWindow().then((function(t){r._announcedWindows.push(t),r._readyMarker.signal("Successfully announced window with id '"+t.id+"'")})).catch((function(t){r._logger.debug("Will not announce window - "+t),r._readyMarker.signal()}))})),r.refreshDescriptors()}))):this._readyMarker=this._dataReadyMarker,this._bridge.onActivitiesAttached((function(t){r._handleActivitiesAttached(t)})),this._bridge.onActivitiesDetached((function(t){r._handleActivitiesDetached(t)})),this._bridge.onActivityAttachedDescriptorsRefreshed((function(t){r._handleActivityDescriptorsRefreshed(t)})),n&&n.onWindowFrameColorChanged(this._handleWindowFrameColorChanged.bind(this)),this._bridge.init(),this._subscribeForData(),this._bridge.initReady().then((function(t){r._getInitialData()})).catch((function(t){console.log(t)}))}return Object.defineProperty(t.prototype,"usingHc",{get:function(){return"HC"===this._bridge.bridgeType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"announcedWindows",{get:function(){return this._announcedWindows},set:function(t){throw new Error("not allowed")},enumerable:!0,configurable:!0}),t.prototype.ready=function(t){var e=this,n=new Promise((function(t,n){e._readyMarker.setCallback((function(r){r?n(e._readyMarker.getError()):t(e)}))}));return He(Promise.all([this._bridge.ready(),n]).then((function(){return e})),t)},t.prototype.getActivityTypes=function(){return this._activityTypes.get()},t.prototype.getActivityType=function(t){return this._activityTypes.getByName(t)},t.prototype.registerActivityType=function(t,e,n,r,i,o){var s=this;return He(new Promise((function(o,a){var c;if(Pe(t))a("activityTypeName argument can not be undefined");else if(Ce(t))if(Pe(s.getActivityType(t)))if(Te(e))a("Owner window type can not be undefined");else{c=Ce(e)?{type:e,name:"",isIndependent:!1,arguments:{}}:e;var u=[];if(!Te(n)&&Ae(n))for(var d in n){var p=n[d];if(Ce(p)){var h={type:p,name:"",isIndependent:!1,arguments:{},relativeTo:"",relativeDirection:"",windowStyleAttributes:{}};u.push(h)}else u.push(p)}s._bridge.registerActivityType(t,c,u,r,i).then((function(t){s._grabEntity(t),o(t)})).catch((function(t){a(t)}))}else a("Activity type '"+t+"' already exists");else a("activityTypeName should be string")})),o)},t.prototype.unregisterActivityType=function(t,e){var n=this;return He(new Promise((function(e,r){var i=n.getActivityType(t);Te(i)?r("Activity type '"+t+"' does not exists"):n._bridge.unregisterActivityType(t).then((function(){return e(i)}),r)})),e)},t.prototype.initiate=function(t,e,n,r){var i=this;return He(new Promise((function(n,o){Te(i.getActivityType(t))?o("Activity type '"+t+"' does not exists"):i._bridge.initiateActivity(t,e,r).then((function(t){i._activities.getOrWait(t).then((function(t){n(t)})).catch((function(t){return o(t)}))})).catch((function(t){o(t)}))})),n)},t.prototype.subscribeActivityTypeEvents=function(t){this._activityTypes.subscribe((function(e,n){t(e,n.type)}))},t.prototype.getWindowTypes=function(){return this._windowTypes.get()},t.prototype.getWindowType=function(t){return this._windowTypes.getByName(t)},t.prototype.registerWindowFactory=function(t,e,n){var r=this;return He(new Promise((function(n,i){if(Pe(t))i("no windowType specified");else{if("object"==typeof(o=t)&&null!==o)t=t.getName();else if(!Ce(t))return void i("windowType should be string or object that has getName method");var o;r._bridge.registerWindowFactory(t,e).then((function(t){n(t)})).catch((function(t){i(t)}))}})),n)},t.prototype.unregisterWindowFactory=function(t,e){var n=this;return He(new Promise((function(e,r){Pe(t)?r("no windowType specified"):Ce(t)?n._bridge.unregisterWindowFactory(t).then((function(t){e(t)})).catch((function(t){r(t)})):r("windowType should be a string")})),e)},t.prototype.getActivities=function(t){var e=this._activities.get();if(e=e.filter((function(t){return t._ownerId})),!t)return e;var n=t;if(Ce(t))n=[t];else if(t instanceof Ee)n=[t.name];else if(!(t instanceof Array))throw new Error("Invalid input argument 'activityType' = "+t);return e.filter((function(t){var e=t.type;return function(t,e){for(var n=0;n<t.length;n++)if(e(t[n],n))return!0;return!1}(n,(function(t){return e.id===t.id}))}))},t.prototype.getActivityById=function(t){return this._activities.getByName(t)},t.prototype.announceWindow=function(t,e){var n=this;return new Promise((function(r,i){var o=n._bridge.getAnnouncementInfo();if(Te(t)&&(t=o.activityWindowId),Te(e)&&(e=o.activityWindowType),Pe(e))throw new Error("Can not announce - unknown windowType");var s=o&&o.activityId;if(Pe(t))n._logger.debug("Registering window with type:'"+e+"', name:'"+o.activityWindowName+"', ind.:'"+o.activityWindowIndependent+"'"),n._bridge.registerWindow(e,o.activityWindowName,o.activityWindowIndependent).then(n._windows.getOrWait.bind(n._windows)).then((function(t){return s?n._activities.getOrWait(s).then((function(e){return t})):t})).then((function(t){r(t)})).catch((function(t){n._logger.error(t)}));else{n._logger.debug("Announcing window with id '"+t+"' and type '"+e+"'");var a=n._windows.getByName(t);if(!Pe(a))return n._logger.debug("Window with id '"+t+"' already announced - reusing the window"),void r(a);var c=function(e,o,s){t===o.id&&(s===De.ActivityWindowJoinedActivity&&(Te(o.activity)&&i("UNDEFINED ACTIVITY"),n._logger.trace("Got joined event for id '"+t+"'"),r(o),n.unsubscribeWindowEvents(c)))};n.subscribeWindowEvents(c),n._logger.trace("Waiting for joined event for id '"+t+"'"),n._bridge.announceWindow(e,t)}}))},t.prototype.subscribeWindowTypeEvents=function(t){this._windowTypes.subscribe((function(e,n){t(e,n.type)}))},t.prototype.subscribeActivityEvents=function(t){var e=this;return this._activities.subscribe((function(n,r){if(r.type===De.StatusChange){var i=r;t(n,i.newStatus,i.oldStatus)}if(r.type===De.Removed||r.type===De.StatusChange&&r.newStatus.getState()===Fe.Destroyed)for(var o=0,s=e._windows.get();o<s.length;o++){var a=s[o];a.activity&&a.activity.id===n.id&&e._windows.process(new Re(a,new Ne(De.ActivityWindowLeftActivity)))}}))},t.prototype.subscribeWindowEvents=function(t){var e=function(e,n){var r=n.type;r===De.Added&&(r="opened"),t(e.activity,e,r)};return this._windowHandlers.push([t,e]),this._windows.subscribe(e)},t.prototype.unsubscribeWindowEvents=function(t){var e=this._windowHandlers.find((function(e){return e[0]===t}));e&&(this._windowHandlers.splice(this._windowHandlers.indexOf(e),1),this._windows.unsubscribe(e[1]))},t.prototype.createWindow=function(t,e,n){var r=this;return He(new Promise((function(n,i){var o,s;if(Pe(e)&&i("windowType is undefined"),Ce(e))o={type:e,name:"",isIndependent:!1,arguments:{}};else if(e instanceof Oe)o={type:e.type||e.id,name:e.name||e.type||e.id,isIndependent:!1};else{var a=["url"],c={};Object.keys(e).forEach((function(t){-1===a.indexOf(t)&&(c[t]=e[t])})),o=c}if(!Pe(o.relativeTo))if("string"==typeof(s=o.relativeTo))!Pe(u=r.getWindows({type:s}))&&u.length>0&&(o.relativeTo=u[0].id);else if(Pe(s.type))Pe(s.windowId)||(o.relativeTo=s.windowId);else{var u;!Pe(u=r.getWindows({type:s.type}))&&u.length>0&&(o.relativeTo=u[0].id)}r._bridge.createWindow(t&&t.id,o).then((function(e){r._logger.debug("Window created, waiting for window entity with id "+e);var i=function(o,s){o.id!==e||t&&!o.activity||(r._logger.debug("Got entity window with id "+e),n(o),r._windows.unsubscribe(i))};r._windows.subscribe(i)})).catch((function(t){i(t)}))})),n)},t.prototype.createStackedWindows=function(t,e,n,r){var i=this;return He(new Promise((function(r,o){Pe(t)&&o("activity is undefined"),Pe(e)&&o("relativeWindowTypes is undefined"),Array.isArray(e)||o("relativeWindowTypes has to be an array"),Pe(n)&&(n=2e4);var s=[];e.forEach((function(t){var e,r;if((e=Ce(t)?{type:t,name:"",isIndependent:!1,arguments:{}}:t).stackedWindow=!0,e.timeout=n,!Pe(e.relativeTo))if(Pe((r=e.relativeTo).type)){if(!Pe(r.windowId)){var o=i.getWindows({id:r.windowId});!Pe(o)&&o.length>0&&(e.relativeTo=o[0].type.name)}}else e.relativeTo=r.type;s.push(e)}));var a=[];s.forEach((function(e){return a.push(i.createWindow(t,e))})),Promise.all(a).then(r).catch(o)})),r)},t.prototype.addWindowToActivity=function(t,e,n){var r=this._bridge.joinActivity(t.id,e.id).then((function(){return e}));return He(r,n),r},t.prototype.leaveWindowFromActivity=function(t,e,n){var r=this._bridge.leaveActivity(t.id,e.id).then((function(){return e}));return He(r,n),r},t.prototype.setActivityContext=function(t,e,n){var r=this;return He(new Promise((function(n,i){Pe(t)&&i("activity can not be null"),r._bridge.updateActivityContext(t,e,!0).then((function(e){n(t)})).catch((function(t){i(t)}))})),n)},t.prototype.updateActivityContext=function(t,e,n){var r=this;return He(new Promise((function(n,i){Pe(t)&&i("activity can not be null");var o=[];for(var s in e)e.hasOwnProperty(s)&&null===e[s]&&o.push(s);for(var a=0,c=o;a<c.length;a++){var u=c[a];delete e[u]}r._bridge.updateActivityContext(t,e,!1,o).then((function(e){n(t)})).catch((function(t){i(t)}))})),n)},t.prototype.subscribeActivityContextChanged=function(t){this._activities.subscribe((function(e,n){if(n.type===De.ActivityContextChange){var r=n;t(e,r.context,r.updated,r.removed)}}))},t.prototype.stopActivity=function(t,e){return He(this._bridge.stopActivity(t),e)},t.prototype.getWindows=function(t){return Te(t)?this._windows.get():Te(t.id)?this._windows.get().filter((function(e){if(!Te(t.type)&&e.type.id!==t.type)return!1;if(!Te(t.name)&&e.name!==t.name)return!1;if(!Te(t.activityId)){if(Pe(e.activity))return!1;if(e.activity.id!==t.activityId)return!1}return!0})):[this._windows.getByName(t.id)]},t.prototype.getWindowBounds=function(t){return this._bridge.getWindowBounds(t)},t.prototype.setWindowBounds=function(t,e,n){var r=this;return He(new Promise((function(n,i){r._bridge.setWindowBounds(t,e).then((function(){return n()})).catch((function(t){return i(t)}))})),n)},t.prototype.closeWindow=function(t){return this._bridge.closeWindow(t)},t.prototype.activateWindow=function(t,e){return this._bridge.activateWindow(t,e)},t.prototype.setWindowVisibility=function(t,e){return this._bridge.setWindowVisibility(t,e)},t.prototype.clone=function(t,e,n){var r=this;return He(new Promise((function(n,i){t||i("activity can not be null"),r._bridge.cloneActivity(t.id,e).then((function(t){r._activities.getOrWait(t).then((function(t){n(t)})).catch((function(t){return i(t)}))})).catch((function(t){return i(t)}))})),n)},t.prototype.attachActivities=function(t,e,n,r){var i=this;return n=n||{},He(new Promise((function(r,o){if(i._activities.getByName(t)){if(i._activities.getByName(e))return i._bridge.attachActivities(t,e,n).then((function(t){var e=t.to,n=t.descriptor,o=t.descriptors;i._activities.getOrWait(e).then((function(t){t._updateDescriptors(o);var e=t.attached.filter((function(t){return t.ownerId===n.ownerId}))[0];r(e)}))})).catch((function(t){o(t)}));o("can not find activity with id "+e)}else o("can not find activity with id "+t)})),r)},t.prototype.detachActivities=function(t,e,n){var r=this;return He(new Promise((function(n,i){return r._bridge.detachActivities(t,e).then((function(){r._activities.getOrWait(undefined).then((function(t){t._updateDescriptors(undefined),r._activities.getOrWait(undefined).then((function(t){n(t)}))})).catch((function(t){return i(t)}))})).catch((function(t){i(t)}))})),n)},t.prototype.subscribeActivitiesAttached=function(t){this._attachedCallbacks.push(t)},t.prototype.subscribeActivitiesDetached=function(t){this._detachedCallbacks.push(t)},t.prototype.subscribeActivityFrameColorChanged=function(t){this._frameColorChangesCallbacks.push(t)},t.prototype._grabEntity=function(t){t._manager=this},t.prototype._getInitialData=function(){var t=this;this._logger.debug("Request initial data..."),this._bridge.getActivityTypes().then((function(e){t._activityTypes.add(e),t._dataReadyMarker.signal("Got act types")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity types -"+e)})),this._bridge.getWindowTypes().then((function(e){t._windowTypes.add(e),t._dataReadyMarker.signal("Got window types")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting window types  "+e)})),this._bridge.getActivities().then((function(e){t._activities.add(e),t._dataReadyMarker.signal("Got activities")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity instances -"+e)})),this._bridge.getActivityWindows().then((function(e){t._windows.add(e),t._dataReadyMarker.signal("Got windows")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity windows -"+e)}))},t.prototype._subscribeForData=function(){var t=this;this._logger.debug("Subscribe for data..."),this._bridge.onActivityTypeStatusChange((function(e){t._activityTypes.process(e)})),this._bridge.onWindowTypeStatusChange((function(e){t._windowTypes.process(e)})),this._bridge.onActivityWindowChange((function(e){t._windows.process(e)})),this._bridge.onActivityStatusChange((function(e){t._activities.process(e)}))},t.prototype._handleActivitiesAttached=function(t){var e=this,n=t.to,r=t.descriptor,i=t.descriptors;this._activities.getOrWait(n).then((function(t){t._updateDescriptors(i);var n=t.attached.filter((function(t){return t.ownerId===r.ownerId}))[0];e._attachedCallbacks.forEach((function(e){try{e(t,n)}catch(t){return}}))}))},t.prototype._handleActivitiesDetached=function(t){var e=this,n=t.oldActivityId,r=t.newActivityId,i=t.descriptors,o=t.descriptor;this._activities.getOrWait(n).then((function(t){t._updateDescriptors(i),e._activities.getOrWait(r).then((function(n){e._detachedCallbacks.forEach((function(e){try{e(n,t,o)}catch(t){return}}))}))}))},t.prototype._handleActivityDescriptorsRefreshed=function(t){var e=t.id,n=t.descriptors,r=this._activities.getByName(e);r&&r._updateDescriptors(n)},t.prototype.refreshDescriptors=function(){var t=this;this._bridge.getAttachedDescriptors().then((function(e){e&&Object.keys(e).forEach((function(n){var r=n,i=e[n],o=t._activities.getByName(r);o&&o._updateDescriptors(i)})),t._descriptorsMarker.signal("Successfully got descriptors")})).catch((function(e){t._descriptorsMarker.error("failed to get descriptors - "+e)}))},t.prototype._handleWindowFrameColorChanged=function(t){if(t.activityId){var e=this._activities.getByName(t.activityId);e&&e.owner&&e.owner.underlyingWindow.id===t.id&&this._frameColorChangesCallbacks.forEach((function(n){try{n(e,t.frameColor)}catch(t){return}}))}},t}(),ln=function(){function t(t,e){this._m=t,this._my=e,this.activityTypes={get:this._getActivityTypesWrapper.bind(this),register:this._m.registerActivityType.bind(this._m),unregister:this._m.unregisterActivityType.bind(this._m),subscribe:this._m.subscribeActivityTypeEvents.bind(this._m),unsubscribe:void 0,initiate:this._m.initiate.bind(this._m)},this.windowTypes={get:this._getWindowTypesWrapper.bind(this),registerFactory:this._m.registerWindowFactory.bind(this._m),unregisterFactory:this._m.unregisterWindowFactory.bind(this._m),subscribe:this._m.subscribeWindowTypeEvents.bind(this._m),unsubscribe:void 0},this.windows={get:this._m.getWindows.bind(this._m),subscribe:this._m.subscribeWindowEvents.bind(this._m),announce:this._m.announceWindow.bind(this._m),unsubscribe:void 0,create:this._m.createWindow.bind(this._m)},this.instances={get:this._m.getActivities.bind(this._m),subscribe:this._m.subscribeActivityEvents.bind(this._m),unsubscribe:void 0}}return t.prototype.onAttached=function(t){this._m.subscribeActivitiesAttached(t)},t.prototype.onDetached=function(t){this._m.subscribeActivitiesDetached(t)},t.prototype.onActivityFrameColorChanged=function(t){this._m.subscribeActivityFrameColorChanged(t)},t.prototype._getActivityTypesWrapper=function(t){return Te(t)?this._m.getActivityTypes():this._m.getActivityType(t)},t.prototype._getWindowTypesWrapper=function(t){return Te(t)?this._m.getWindowTypes():this._m.getWindowType(t)},t}(),vn=function(){function t(t,e){this._mgr=t,this._my=e,this.all=new ln(t,e)}return t.prototype.ready=function(t){var e=this;return He(new Promise((function(t,n){e._mgr.ready().then((function(){t(e)})).catch((function(t){n(t)}))})),t)},Object.defineProperty(t.prototype,"my",{get:function(){return this._my},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"aware",{get:function(){return void 0!==this._my.window},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inActivity",{get:function(){return this.aware&&void 0!==this._my.activity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"agm",{get:function(){if(this.aware)return this.inActivity?this._my.activity.agm:new Be(null)},enumerable:!0,configurable:!0}),t.prototype.getAvailableFrameColors=function(){return[]},t}(),yn=function(){function t(e){var n,r=this;if(!e)throw new Error("config can not be null");if(Te(e.logLevel)||(Je.Level=e.logLevel),Pe(e.logger)||(Je.GlueLogger=e.logger),this._isUsingHCImplementation=2===e.gdMajorVersion,this._isUsingGW3Implementation=t.checkIsUsingGW3Implementation(e.connection),this._isUsingHCImplementation)throw new Error("GD2 not supported");if(!this._isUsingGW3Implementation)throw new Error("Unable to instantiate activity bridge implementation");if(!(n=new un(e)))throw new Error("A bridge to native activity is needed to create activity lib.");Be.AGM=e.agm;var i=new fn(n,!e.disableAutoAnnounce,e.windows),o=new dn(i,e.windows);this._api=new vn(i,o),this._readyPromise=i.ready().then((function(t){return r}))}return t.checkIsUsingGW3Implementation=function(t){return 3===t.protocolVersion},Object.defineProperty(t.prototype,"api",{get:function(){return this._api},set:function(t){this._api=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUsingHCImplementation",{get:function(){return this._isUsingHCImplementation},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUsingGW3Implementation",{get:function(){return this._isUsingGW3Implementation},enumerable:!0,configurable:!0}),t.prototype.ready=function(t){return He(this._readyPromise,t)},t}(),gn="T42.ACS.GetFunctionalEntitlement",mn="T42.ACS.CanI",wn="T42.ACS.OnEvent";function bn(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function r(n,r){var i=n instanceof Error?n:new Error(n);if(e)e(i);else{var o='[ERROR] callback-registry: User callback for key "'+r+'" failed: '+i.stack;if(t)switch(t.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(t,e){var r=n[t];return r||(r=[],n[t]=r),r.push(e),function(){var r=n[t];r&&(r=r.reduce((function(t,n,r){return n===e&&t.length===r||t.push(n),t}),[]),n[t]=r)}},execute:function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var o=n[t];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var i=n.apply(void 0,e);s.push(i)}catch(e){s.push(void 0),r(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}bn.default=bn;var _n=bn;function In(t){return t?Object.keys(t).map((function(e){return t[e]})):[]}function Sn(t){var e;try{e=JSON.parse(JSON.stringify(t||{}))}catch(t){e={}}return e}var xn=function(){function t(t,e,n){var r=this;this._appManager=t,this._name=e,this._agm=n,this._registry=_n(),t.onInstanceStarted((function(t){t.application&&t.application.name!==r._name||r._registry.execute("instanceStarted",t)})),t.onInstanceStopped((function(t){t.application&&t.application.name!==r._name||r._registry.execute("instanceStopped",t)})),t.onAppRemoved((function(t){t.name===r._name&&r._registry.execute("appRemoved",t)})),t.onAppChanged((function(t){t.name===r._name&&r._registry.execute("appChanged",t)})),t.onAppAvailable((function(t){t.name===r._name&&r._registry.execute("appAvailable",t)})),t.onAppUnavailable((function(t){t.name===r._name&&r._registry.execute("appUnavailable",t)}))}return Object.defineProperty(t.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._props.Title},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return this._props.Version},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"autoStart",{get:function(){return this._props.AutoStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isShell",{get:function(){return this._props.IsShell},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"caption",{get:function(){return this._props.Caption},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hidden",{get:function(){return this._props.IsHidden},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"container",{get:function(){return this._props.ApplicationName},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityType",{get:function(){return this._props.ActivityType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityWindowType",{get:function(){return this._props.ActivityWindowType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowSettings",{get:function(){return this._props.Arguments?Sn(this._props.Arguments):{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"allowMultiple",{get:function(){return this._props.AllowMultiple},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"available",{get:function(){return this._props.IsReady||!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"icon",{get:function(){return this._props.Icon},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"iconURL",{get:function(){return this._props.IconUrl},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sortOrder",{get:function(){return this._props.SortOrder},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"userProperties",{get:function(){return this._props.UserProperties?Sn(this._props.UserProperties):{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivity",{get:function(){return void 0!==this._props.ActivityType&&""!==this._props.ActivityType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"configuration",{get:function(){return{autoStart:this._props.AutoStart,caption:this._props.Caption,hidden:this._props.IsHidden,container:this._props.ApplicationName,activityType:this._props.ActivityType,allowMultiple:this._props.AllowMultiple}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return e.application.name===t._name}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"type",{get:function(){return this._props.Type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mode",{get:function(){if(!this._props)return"unknown";if(this._props.Mode&&"string"==typeof this._props.Mode)return this._props.Mode.toLowerCase();if(this.isActivity)return"unknown";if(this._props.Arguments&&this._props.Arguments.mode&&"string"==typeof this._props.Arguments.mode)return this._props.Arguments.mode.toLowerCase();var t=this._props.WindowStyleAttributes;if(t){var e='mode:"',n=(t=t.split(" ").join("")).indexOf(e);if(-1!==n){var r=n+e.length,i=t.indexOf('"',r),o=t.substr(r,i-r);if(o&&"string"==typeof o)return o.toLowerCase()}}return"flat"},enumerable:!0,configurable:!0}),t.prototype.updateFromProps=function(t){var e=this;this._props||(this._props={Name:t.Name}),Object.keys(t).forEach((function(n){e._props[n]=t[n]}))},t.prototype.start=function(t,e){var n=this,r=this._name;return new Promise((function(i,o){e=e||{},t=t||{};n._agm.invoke("T42.ACS.StartApplication",{Name:r,Context:t,Options:e},"best",{methodResponseTimeoutMs:1e4},(function(t){var e=t.returned&&t.returned.Instance_0?t.returned.Instance_0:t.returned;if(e&&e.Id)if("startOnly"===n._appManager.mode){var r=n._appManager.handleInstanceStarted(e);i(r)}else!function(t){var e,r=function(){var e,r=n._appManager.instances().filter((function(e){return e.id===t}));return(e=2===r.length?r[0].isActivityInstance?r[0]:r[1]:r[0])?e.agm?e:void 0:e},s=setTimeout((function(){e&&e(),o("timeout")}),1e4);e=n._appManager.onInstanceAgmServerReady((function(n){n.id===t&&(e&&(e(),e=void 0),clearTimeout(s),setTimeout((function(){i(r())}),1))}));var a=r();a&&(e&&(e(),e=void 0),clearTimeout(s),i(a))}(e.Id);else i(void 0)}),(function(t){o(t)}))}))},t.prototype.onInstanceStarted=function(t){this._registry.add("instanceStarted",t)},t.prototype.onInstanceStopped=function(t){this._registry.add("instanceStopped",t)},t.prototype.onAvailable=function(t){this._registry.add("appAvailable",t)},t.prototype.onUnavailable=function(t){this._registry.add("appUnavailable",t)},t.prototype.onChanged=function(t){this._registry.add("appChanged",t)},t.prototype.onRemoved=function(t){this._registry.add("appRemoved",t)},t}(),kn=function(){function t(t,e,n,r,i,o,s){var a=this;this._id=t,this._appName=e,this._appManager=n,this._agm=r,this._activities=i,this._windows=o,this.onAgmReady=this._addToRegistry("agmReady"),this.onStopped=this._addToRegistry("stopped"),this._registry=_n(),s||(this._unsubscribeInstanceStopped=this._appManager.onInstanceStopped((function(t){t.id===a._id&&a._registry.execute("stopped",t)})),this._unsubscribeInstanceAgmServerReady=this._appManager.onInstanceAgmServerReady((function(t){t.id===a._id&&a._registry.execute("agmReady",t)})))}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"application",{get:function(){return this._appManager.application(this._appName)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activity",{get:function(){var t=this;if(!this._activities)throw new Error("This method requires glue.activities library to be enabled.");return this._activities.all.instances.get().filter((function(e){return e.id===t._activityId}))[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityInstances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){var n;return(null===(n=e.activity)||void 0===n?void 0:n.id)===t._activityId}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityOwnerInstance",{get:function(){var t;if(this._activityId){var e=this.activity;if(!e)throw new Error("Can not find activity with id "+this._activityId);var n=null===(t=e.owner.underlyingWindow)||void 0===t?void 0:t.id;if(!n)throw new Error("Can not find owner wind underlyingWindow for activity with id "+this._activityId);return this._appManager.instances().filter((function(t){return t.id===n}))[0]}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"window",{get:function(){var t=this;if(!this._windows)throw new Error("This method requires glue.windows library to be enabled.");var e=this._windows.list().filter((function(e){return e.id===t._id}))[0];return!e&&this.activity&&this.activityOwnerInstance&&(e=this.activityOwnerInstance.window),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){var t,e,n;return null!=(n=null!=(t=this._startUpContext)?t:null===(e=this.window)||void 0===e?void 0:e.context)?n:{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._title},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivityInstance",{get:function(){return this._isActivityInstance},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityId",{get:function(){return this._activityId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inActivity",{get:function(){return this._inActivity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSingleWindowApp",{get:function(){return!this._inActivity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"agm",{get:function(){return this._agmInstance},enumerable:!0,configurable:!0}),t.prototype.updateFromProps=function(t){this._startUpContext=t.Context,this._title=t.Title,this._isActivityInstance=!1,t.ActivityId&&""!==t.ActivityId&&(this._activityId=t.ActivityId,this._isActivityInstance=!0),!this._activityId&&this._startUpContext&&this._startUpContext.activityId&&(this._activityId=this._startUpContext.activityId),this._inActivity=Boolean(this._activityId),this.updateAgmInstanceFromProps(t)},t.prototype.updateAgmInstanceFromProps=function(t){if(t.AgmServers)if(t.GD3){var e=t.AgmServers;e&&(this._agmInstance=e[0])}else{var n=t.AgmServers,r=Object.keys(n)[0];if(!r)return;var i=n[r];this._agmInstance={machine:i.machineName,user:i.userName,environment:i.environment,application:i.applicationName}}},t.prototype.stop=function(){var t=this;return new Promise((function(e,n){var r=t._appManager.onInstanceStopped((function(n){n.id===t._id&&(r(),e())}));t._agm.invoke("T42.ACS.StopApplication",{Name:t._appName,Id:t._id}).then((function(){"startOnly"===t._appManager.mode&&(t._appManager.handleInstanceStopped({Name:t._appName,Id:t.id,Context:void 0,Title:void 0,ActivityId:void 0,AgmServers:void 0}),e())})).catch((function(t){return n(t)}))}))},t.prototype.activate=function(){return this._agm.invoke("T42.ACS.ActivateApplication",{Name:this._appName,Id:this._id})},t.prototype.done=function(){this._registry.clear(),this._unsubscribeInstanceAgmServerReady(),this._unsubscribeInstanceStopped()},t.prototype._addToRegistry=function(t){var e=this;return function(n){e._registry.add(t,n)}},t}(),Cn=function(){function t(t,e,n,r,i,o){var s=this;this.mode=t,this._agm=e,this._activities=n,this._windows=r,this._logger=i,this._gdMajorVersion=o,this._apps={},this._instances=[],this._registry=_n(),this.application=function(t){return s._apps[t]},this.applications=function(){return Object.keys(s._apps).map((function(t){return s._apps[t]}))},this.instances=function(){return s._instances},this.getMyInstance=function(){if(s._gdMajorVersion>=3){var t=window.glue42gd.appInstanceId;return s._instances.filter((function(e){return e.id===t}))[0]}},this.handleAppAdded=function(t){var e=s._getAppId(t);s._logger.trace("adding app "+e),s._apps[e]=new xn(s,e,s._agm);var n=s._updateAppFromProps(t);s._registry.execute("appAdded",n)},this.handleAppUpdated=function(t){var e=s._updateAppFromProps(t);s._registry.execute("appChanged",e)},this.handleAppRemoved=function(t){var e=s._getAppId(t);s._logger.trace("removing app "+e);var n=s.application(e);s._instances=s._instances.filter((function(t){return t.application.name!==n.name})),delete s._apps[e],s._registry.execute("appRemoved",n)},this.handleAppReady=function(t){var e=s._getAppId(t),n=s._getAppOrThrow(e);n.updateFromProps(t),n.available?s._registry.execute("appAvailable",n):s._registry.execute("appUnavailable",n)},this.handleInstanceStarted=function(t){s._logger.trace("started app "+t.Name+" "+t.Id);var e=s._getInstanceId(t),n=s._getInstanceAppName(t),r=new kn(e,n,s,s._agm,s._activities,s._windows);return s._updateInstanceFromProps(r,t),s._instances.push(r),s._registry.execute("instanceStarted",r),r},this.handleInstanceStopped=function(t){s._logger.trace("failed to start app "+t.Name+" "+t.Id);var e=s._getInstanceId(t),n=s._getInstanceAppName(t),r=s._getInstanceOrThrow(e,n);s._instances=s._instances.filter((function(t){return!s._matchInstance(t,e,n)})),s._registry.execute("instanceStopped",r),r.done()},this.handleInstanceAgmServerReady=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),r=s._getInstanceOrThrow(e,n);r.updateAgmInstanceFromProps(t),s._registry.execute("instanceAgmServerReady",r)},this.handleInstanceStartFailed=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),r=new kn(e,n,void 0,void 0,void 0,void 0,!0);s._updateInstanceFromProps(r,t),s._registry.execute("instanceStartFailed",r)},this.handleInstanceUpdated=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),r=s._getInstanceOrThrow(e,n);s._updateInstanceFromProps(r,t)},this.onInstanceStarted=function(t){return s._replay(s._instances,t),s._registry.add("instanceStarted",t)},this.onInstanceStartFailed=function(t){return s._registry.add("instanceStartFailed",t)},this.onInstanceStopped=function(t){return s._registry.add("instanceStopped",t)},this.onInstanceUpdated=function(t){return s._registry.add("instanceChanged",t)},this.onInstanceAgmServerReady=function(t){return s._registry.add("instanceAgmServerReady",t)},this.onAppAdded=function(t){return s._replay(s._apps,t),s._registry.add("appAdded",t)},this.onAppRemoved=function(t){return s._registry.add("appRemoved",t)},this.onAppAvailable=function(t){return s._registry.add("appAvailable",t)},this.onAppUnavailable=function(t){return s._registry.add("appUnavailable",t)},this.onAppChanged=function(t){return s._registry.add("appChanged",t)}}return t.prototype._getAppOrThrow=function(t){var e=this.application(t);if(!e)throw Error("app with id "+t+" not found");return e},t.prototype._getAppId=function(t){return t.Name},t.prototype._matchInstance=function(t,e,n){return t.id===e&&t.application.name===n},t.prototype._getInstanceByIdAndName=function(t,e){var n=this;return this._instances.filter((function(r){return n._matchInstance(r,t,e)}))[0]},t.prototype._getInstanceOrThrow=function(t,e){var n=this._getInstanceByIdAndName(t,e);if(!n)throw Error("instance with id "+t+" not found");return n},t.prototype._getInstanceId=function(t){return t.Id},t.prototype._getInstanceAppName=function(t){return t.Name},t.prototype._updateAppFromProps=function(t){var e=this._getAppId(t);this._logger.trace("updating app with  + "+e+", "+t);var n=this._getAppOrThrow(e);return n.updateFromProps(t),n},t.prototype._updateInstanceFromProps=function(t,e){this._logger.trace("updating instance with "+this._getInstanceId(e)+" for app "+this._getInstanceAppName(e)),t.updateFromProps(e)},t.prototype._replay=function(t,e){t&&(Array.isArray(t)?t.forEach((function(t){return e(t)})):Object.keys(t).map((function(e){return t[e]})).forEach((function(t){return e(t)})))},t}();function An(t,e,n){var r=function(t){return!!(t&&t.constructor&&t.call&&t.apply)};if(!r(e)&&!r(n))return t;r(e)?r(n)||(n=function(){}):e=function(){},t.then(e,n)}var Tn=function(t){var e=this;this._agm=t,this._registry=_n(),this.handleBranchModified=function(t){e._registry.execute("branchChanged",t)},this.handleBranchesModified=function(t){e._registry.execute("branchesChanged",t)},this.getRegion=function(t,n){return An(e._agmInvoke("T42.ACS.GetConfigurationRegion",(function(t){return t.returned.Region})),t,n)},this.getBranches=function(t,n){return An(e._agmInvoke("T42.ACS.GetBranches",(function(t){var e=t.returned.Branches;return Object.keys(e).map((function(t){return e[t]}))})),t,n)},this.getCurrentBranch=function(t,n){return An(e._agmInvoke("T42.ACS.GetCurrentBranch",(function(t){return t.returned.Branch}),void 0),t,n)},this.setRegion=function(t,n,r){return An(e._agmInvoke("T42.ACS.SetConfigurationRegion",(function(t){return t.returned.ResultMessage}),{Region:t}),n,r)},this.setCurrentBranch=function(t,n,r){return An(e._agmInvoke("T42.ACS.SetCurrentBranch",(function(t){return t.returned.ResultMessage}),{Branch:t}),n,r)},this.currentUser=function(t,n){return An(e._agmInvoke("T42.ACS.GetUser"),t,n)},this.getFunctionalEntitlement=function(t,n,r){return An(e._agmInvoke(gn,(function(t){return t.returned.Entitlement}),{Function:t}),n,r)},this.getFunctionalEntitlementBranch=function(t,n,r,i){return An(e._agmInvoke(gn,(function(t){return t.returned.Entitlement}),{Function:t,Branch:n}),r,i)},this.canI=function(t,n,r){return An(e._agmInvoke(mn,(function(t){return t.returned.Result}),{Function:t}),n,r)},this.canIBranch=function(t,n,r,i){return An(e._agmInvoke(mn,(function(t){return t.returned.Result}),{Function:t,Branch:n}),r,i)},this.onBranchesChanged=function(t){e._registry.add("branchesChanged",t)},this.onBranchChanged=function(t){e._registry.add("branchChanged",t)},this.exit=function(t){return e._agmInvoke("T42.ACS.Shutdown",null,t)},this.restart=function(t){return e._agmInvoke("T42.ACS.Restart",null,t)},this._agmInvoke=function(t,n,r){return r=r||{},new Promise((function(i,o){e._agm.invoke(t,r).then((function(t){n||(n=function(t){return t.returned}),i(n(t))})).catch((function(t){return o(t)}))}))}};var Pn=function(t){if(!t)throw Error("config not set");if(!t.agm)throw Error("config.agm is missing");var e="startOnly",n="skipIcons",r=t.mode||e;if(r!==e&&r!==n&&"full"!==r)throw new Error("Invalid mode for appManager lib - "+r+" is not supported");var i,o=t.activities,s=t.agm,a=t.logger,c=t.windows,u=new Cn(r,s,o,c,a.subLogger("applications"),t.gdMajorVersion),d=new Tn(s);if(r===e)i=function(t,e){return new Promise((function(n,r){t.invoke("T42.ACS.GetApplications",{skipIcon:!0}).then((function(t){var r=t.returned;r||n();var i=r.applications;i||n(),In(i).map((function(t){return e.handleAppAdded(t)})),n()})).catch((function(t){return r("Error getting application snapshot: "+t.message)}))}))}(s,u);else{var p=function(t,e,n,r){var i;return{start:function(){var o,s,a=new Promise((function(t,e){o=t,s=e}));return t.subscribe(wn,{arguments:{skipIcon:r},waitTimeoutMs:1e4}).then((function(t){(i=t).onData((function(t){var r=t.data;In(r.OnApplicationAdded).map((function(t){return e.handleAppAdded(t)})),In(r.OnApplicationChanged).map((function(t){return e.handleAppUpdated(t)})),In(r.OnApplicationRemoved).map((function(t){return e.handleAppRemoved(t)})),In(r.OnApplicationReady).map((function(t){return e.handleAppReady(t)})),In(r.OnApplicationStarted).map((function(t){return e.handleInstanceStarted(t)})),In(r.OnApplicationStartFailed).map((function(t){return e.handleInstanceStartFailed(t)})),In(r.OnApplicationStopped).map((function(t){return e.handleInstanceStopped(t)})),In(r.OnApplicationUpdated).map((function(t){return e.handleInstanceUpdated(t)})),In(r.OnApplicationAgmServerReady).map((function(t){return e.handleInstanceAgmServerReady(t)})),In(r.OnBranchChanged).map((function(t){return n.handleBranchModified(t)})),In(r.OnBranchesModified).map((function(t){return n.handleBranchesModified(t)})),o()})),i.onFailed((function(t){return s(t)}))})).catch((function(t){return s("Error subscribing for T42.ACS.OnEvent stream. Err: "+t)})),a},stop:function(){i&&i.close()}}}(s,u,d,r===n);i=p.start()}return{ready:function(){return i},applications:u.applications,application:u.application,onAppAdded:u.onAppAdded,onAppRemoved:u.onAppRemoved,onAppChanged:u.onAppChanged,onAppAvailable:u.onAppAvailable,onAppUnavailable:u.onAppUnavailable,instances:u.instances,get myInstance(){return u.getMyInstance()},onInstanceStarted:u.onInstanceStarted,onInstanceStopped:u.onInstanceStopped,onInstanceUpdated:u.onInstanceUpdated,onInstanceStartFailed:u.onInstanceStartFailed,getRegion:d.getRegion,getBranches:d.getBranches,getCurrentBranch:d.getCurrentBranch,getFunctionalEntitlement:d.getFunctionalEntitlement,getFunctionalEntitlementBranch:d.getFunctionalEntitlementBranch,setCurrentBranch:d.setCurrentBranch,setRegion:d.setRegion,currentUser:d.currentUser,canI:d.canI,canIBranch:d.canIBranch,onBranchesChanged:d.onBranchesChanged,exit:d.exit,restart:d.restart}},Mn=new(function(){function t(){this.waitForTimeoutInMilliseconds=6e4,this._windows={},this._pendingWindows={},this._pendingWindowsStates={},this._registry=_n()}return t.prototype.init=function(t){this._logger=t},t.prototype.get=function(t){return this._windows[t]||this._pendingWindows[t]},t.prototype.getIfReady=function(t){return this._windows[t]},Object.defineProperty(t.prototype,"list",{get:function(){return this._windows},enumerable:!0,configurable:!0}),t.prototype.add=function(t){if(!!this._pendingWindows[t.API.id])this._logger.error("trying to add window with id "+t.API.id+" from windowStore, which already exists");else{var e="remote"===t.API.windowType;this._pendingWindows[t.API.id]=t,this._pendingWindowsStates[t.API.id]={ready:!1,urlChanged:e},this._registry.execute("on-added",t)}},t.prototype.remove=function(t){delete this._windows[t.API.id],delete this._pendingWindows[t.API.id],delete this._pendingWindowsStates[t.API.id],this._registry.execute("on-removed",t)},t.prototype.setReadyState=function(t){var e=this._pendingWindowsStates[t];void 0!==e&&(e.ready=!0,e.urlChanged&&this.markReadyToShow(t))},t.prototype.setUrlChangedState=function(t){var e=this._pendingWindowsStates[t];void 0!==e&&(e.urlChanged=!0,e.ready&&this.markReadyToShow(t))},t.prototype.waitFor=function(t){var e=this;return new Promise((function(n,r){var i,o=setTimeout((function(){i(),r("waitFor timed out.")}),e.waitForTimeoutInMilliseconds),s=e._windows[t];s?(clearTimeout(o),n(s)):i=e.onReadyWindow((function(e){e.API.id===t&&(clearTimeout(o),i(),n(e))}))}))},t.prototype.onReadyWindow=function(t){return this._registry.add("on-ready",t)},t.prototype.onAdded=function(t){return this._registry.add("on-added",t)},t.prototype.onRemoved=function(t){return this._registry.add("on-removed",t)},t.prototype.markReadyToShow=function(t){this._pendingWindows[t]&&(this._windows[t]=this._pendingWindows[t],delete this._pendingWindows[t],delete this._pendingWindowsStates[t]),this._registry.execute("on-ready",this._windows[t])},t}()),jn=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"==typeof window)return-1;if(!window.glueDesktop)return-1;if(!window.glueDesktop.version)return-1;var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?-1:t},t.callbackifyPromise=function(t,e,n){var r=function(t){var e=t;if(t instanceof Error&&(e=t.message),"function"!=typeof n)return Promise.reject(e);n(e)};try{return t().then((function(t){return"function"==typeof e&&e(t),t})).catch((function(t){return r(t)}))}catch(t){return r(t)}},t.getMonitor=function(t,e){var n=this;return e.map((function(e){var r=e.left,i=e.top,o=e.workingAreaWidth,s=e.workingAreaHeight;return{monitor:e,totalOverlap:n.calculateTotalOverlap({left:r,top:i,width:o,height:s},t)}})).sort((function(t,e){return e.totalOverlap-t.totalOverlap}))[0].monitor},t.getDisplayCenterOfScreen=function(t,e){var n=Math.floor(Math.max(e.left,e.left+(e.workingAreaWidth-t.width)/2));return{top:Math.floor(Math.max(e.top,e.top+(e.workingAreaHeight-t.height)/2)),left:n}},t.calculateTotalOverlap=function(t,e){var n=t.left,r=t.top,i=n+t.width,o=r+t.height,s=e.left,a=e.top,c=s+e.width,u=a+e.height;return Math.max(0,Math.min(i,c)-Math.max(n,s))*Math.max(0,Math.min(o,u)-Math.max(r,a))},t}(),En=function(t,e,n,r,i,o,s){var a,c,u=null!=s?s:_n(),d=r.subLogger("window "+t),p=e.name,h=e.mode,f=e.url,y=e.title,g=e.context||{},m=e.bounds,w=e.frameColor,b=e.focus,_=e.neighbours||{},I=e.groupId,S=e.isGroupHeaderVisible,x=e.isTabHeaderVisible,k=e.isTabSelected,C=e.settings,A=e.isVisible,T=e.isCollapsed,P=e.state,M=e.tabGroupId,j=e.isLocked,E=[],O=e.zoomFactor;function R(t,e,r){return new Promise((function(i,o){var s,a,u=$(t,m),d=!1,p=function(){d||(d=!0,"function"==typeof e&&e(c),i(c),a&&(a(),a=void 0),s&&(clearTimeout(s),s=void 0))};u||(a=z((function(e){e.id===c.id&&$(t,e.bounds)&&p()}))),n.moveResize(c,t).then((function(){u?p():s=setTimeout((function(){p()}),1e3)})).catch((function(t){"function"==typeof r&&r(t),o(t)}))}))}function N(e,r,i){return new Promise((function(o,s){n.setVisible(c,e).then((function(){var n=void 0===e?!0===A:A===e;if(n)return"function"==typeof r&&r(c),o(c);var i=V((function(s){n=void 0===e?!0===s.isVisible:s.isVisible===e,s.id===t&&n&&("function"==typeof r&&r(c),i(),o(c))}))})).catch((function(t){"function"==typeof i&&i(t),s(t)}))}))}function L(t,e,r){return new Promise((function(i,o){n.updateContext(c,t).then((function(){"function"==typeof e&&e(c),i(c)})).catch((function(t){"function"==typeof r&&r(t),o(t)}))}))}function W(){return new Promise((function(t){var e=J((function(n){n.id===c.id&&(e(),t())}))}))}function D(t){return u.add("onUrlChanged",t)}function F(t){return T&&t(c),u.add("collapsed",t)}function B(t){return T||t(c),u.add("expanded",t)}function q(t){return"maximized"===P&&t(c),u.add("maximized",t)}function G(t){return"minimized"===P&&t(c),u.add("minimized",t)}function H(t){return"normal"===P&&t(c),u.add("normal",t)}function U(t){return u.add("detached",t)}function V(t){return u.add("visibility-changed",t)}function J(t){return u.add("lock-changed",t)}function z(t){return u.add("bounds-changed",t)}function K(t){return u.add("tab-header-visibility-changed",t)}function Y(t){var e=_[t];if(void 0!==e)return e.reduce((function(t,e){var n=Mn.get(e);return n&&t.push(n.API),t}),[])}function Z(){if(g._APPLICATION_NAME)return g._APPLICATION_NAME;if(g&&g._t42&&g._t42.application)return g._t42.application;var t=X();return t?t.applicationName:void 0}function X(){if(void 0!==window.glue42gd&&window.glue42gd.getWindowInfo){var e=window.glue42gd.getWindowInfo(t);return e||void 0}}function $(t,e){var n=t.height,r=t.width;t.height<C.minHeight&&(n=C.minHeight),t.height>C.maxHeight&&(n=C.maxHeight),t.width<C.minWidth&&(r=C.minWidth),t.width>C.maxWidth&&(r=C.maxWidth);var i=!n||e.height===n,o=!r||e.width===r,s=!t.left||e.left===t.left,a=!t.top||e.top===t.top;return i&&o&&s&&a}var Q={handleWindowClose:function(){void 0!==c.id&&(c.id=void 0,u.execute("onClose",c))},handleWindowChangeState:function(t){"collapsed"===t?T=!0:"expanded"===t?T=!1:P=t,u.execute(t,c)},handleTitleChanged:function(t){y=t,u.execute("onTitleChanged",t,c)},handleVisibilityChanged:function(t){t!==A&&(A=t,u.execute("visibility-changed",c))},handleUrlChanged:function(t){f=t,u.execute("onUrlChanged",t,c)},handleWindowSettingsChanged:function(t){C=t,u.execute("settings-changed",c)},handleContextUpdated:function(t){g=t,u.execute("context-updated",g,c)},handleFrameIsLockedChanged:function(t){j=t,u.execute("lock-changed",c)},handleBoundsChanged:function(t){m.top===t.top&&m.left===t.left&&m.width===t.width&&m.height===t.height||(m.top=t.top,m.left=t.left,m.width=t.width,m.height=t.height,u.execute("bounds-changed",c))},handleFocusChanged:function(t){b=t,u.execute("focus-changed",c)},handleFrameButtonAdded:function(t){var e=["buttonId","imageBase64","order","tooltip"].reduce((function(e,n){return e[n]=t[n],e}),{});-1===E.map((function(t){return t.buttonId})).indexOf(t.buttonId)&&E.push(e),u.execute("onFrameButtonAdded",e,c)},handleFrameButtonRemoved:function(t){var e;E=E.reduce((function(n,r){return r.buttonId===t?e=r:n.push(r),n}),[]),void 0!==e&&u.execute("onFrameButtonRemoved",e,c)},handleFrameButtonClicked:function(t){var e=E.filter((function(e){return e.buttonId===t.buttonId}));e.length>0&&u.execute("onFrameButtonClicked",e[0],c)},handleFrameColorChanged:function(t){w=t,u.execute("frame-color-changed",c)},handleFrameAttached:function(t,e){M=t,x=e,u.execute("frame-attached",c)},handleFrameSelectionChanged:function(e,n){var r;void 0!==e&&e===t?(k=!0,r=c):(k=!1,r=Mn.get(e)?Mn.get(e).API:void 0);var i=Mn.get(n)?Mn.get(n).API:void 0;if(k&&i)var o=i.onTabSelectionChanged((function(t,e){(e&&e.id)===i.id&&(o(),u.execute("tab-selection-changed",r,i,c))}));else u.execute("tab-selection-changed",r,i,c)},handleCompositionChanged:function(t,e){_=t||{},I=e},handleGroupHeaderVisibilityChanged:function(t){S=t},handleTabHeaderVisibilityChanged:function(t){x!==t&&(x=t,u.execute("tab-header-visibility-changed",c))},handleGroupChanged:function(e,n){d.trace("handle group changed to win: "+t+" with group id: "+e.id),a=e,I=e.id,u.execute("group-changed",c,e,n)},handleGroupAssociation:function(e){e&&d.trace("setting group to win: "+t+" with group id: "+e.id),a=e},handleAttached:function(t,e){M=t,x=e,u.execute("attached",c)},handleDetached:function(e){M=e;var n=u.add("frame-attached",(function(e){e.id===t&&(n(),u.execute("detached",c))}))},handleWindowAttached:function(t){u.execute("window-attached",t)},handleWindowDetached:function(t){u.execute("window-detached",t)},handleZoomFactorChanged:function(t){O=t,u.execute("zoom-factor-changed",c)}};return{API:c={get name(){return p},get application(){var t=i();return t?t.application(Z()):void 0},get hostInstance(){return n.hostInstance},get agmInstance(){var t=this;if(window.glue42gd)return o.servers().find((function(e){return e.windowId===t.id}));var e=Z();return e?{application:e}:void 0},get url(){return f},id:t,get title(){return y},get windowStyleAttributes(){return C},get settings(){return C},get tabGroupId(){return"tab"===h.toLowerCase()?M:void 0},get frameButtons(){return E},get mode(){return h},get state(){return P},get isCollapsed(){return T},get isVisible(){return A},get isLocked(){return j},get context(){return g},get bounds(){return m},get minHeight(){return C.minHeight},get maxHeight(){return C.maxHeight},get minWidth(){return C.minWidth},get maxWidth(){return C.maxWidth},get isFocused(){return b},get frameColor(){return w},get opened(){return void 0!==c.id},get group(){return a},get groupId(){return I},get topNeighbours(){return Y("top")},get leftNeighbours(){return Y("left")},get rightNeighbours(){return Y("right")},get bottomNeighbours(){return Y("bottom")},get isGroupHeaderVisible(){return S},get activityId(){if(g._t42)return g._t42.activityId;var t=X();return t?t.activityId:void 0},get activityWindowId(){if(g._t42)return g._t42.activityWindowId;var t=X();return t?t.activityWindowId:void 0},get windowType(){return e.windowType||"electron"},get zoomFactor(){return O},get screen(){return jn.getMonitor(c.bounds,window.glue42gd.monitors)},maximize:function(e,r){return new Promise((function(i,o){n.maximize(c).then((function(){if("maximized"===P)return"function"==typeof e&&e(c),i(c);var n=q((function(r){r.id===t&&"maximized"===r.state&&("function"==typeof e&&e(c),n(),i(c))}))})).catch((function(t){"function"==typeof r&&r(t),o(t)}))}))},restore:function(e,r){return new Promise((function(i,o){n.restore(c).then((function(){if("normal"===P)return"function"==typeof e&&e(c),i(c);var n=H((function(r){t===r.id&&"normal"===r.state&&("function"==typeof e&&e(c),n(),i(c))}))})).catch((function(t){"function"==typeof r&&r(t),o(t)}))}))},minimize:function(e,r){return new Promise((function(i,o){n.minimize(c).then((function(){if("minimized"===P)return"function"==typeof e&&e(c),i(c);var n=G((function(r){if(t===r.id&&"minimized"===r.state)return"function"==typeof e&&e(c),n(),i(c)}))})).catch((function(t){"function"==typeof r&&r(t),o(t)}))}))},maximizeRestore:function(t,e){return new Promise((function(r,i){var o="normal"===P?q:H;n.maximizeRestore(c).then((function(){var e=o((function(){"function"==typeof t&&t(c),e&&e(),r(c)}))})).catch((function(t){"function"==typeof e&&e(t),i(t)}))}))},collapse:function(e,r){return new Promise((function(i,o){if(T)return"function"==typeof e&&e(c),i(c);n.collapse(c).then((function(){if(T)return"function"==typeof e&&e(c),i(c);var n=F((function(r){r.id===t&&("function"==typeof e&&e(c),n(),i(c))}))})).catch((function(t){"function"==typeof r&&r(t),o(t)}))}))},expand:function(e,r){return new Promise((function(i,o){if(!T)return"function"==typeof e&&e(c),i(c);n.expand(c).then((function(){if(!T)return"function"==typeof e&&e(c),i(c);var n=B((function(r){r.id===t&&("function"==typeof e&&e(c),n(),i(c))}))})).catch((function(t){"function"==typeof r&&r(t),o(t)}))}))},toggleCollapse:function(e,r){return new Promise((function(i,o){var s=T?B:F;n.toggleCollapse(c).then((function(){s((function(n){n.id===t&&("function"==typeof e&&e(c),i(c))}))})).catch((function(t){"function"==typeof r&&r(t),o(t)}))}))},focus:function(t,e){return new Promise((function(r,i){n.focus(c).then((function(){"function"==typeof t&&t(c),r(c)})).catch((function(t){"function"==typeof e&&e(t),i(t)}))}))},activate:function(t,e){return new Promise((function(r,i){n.activate(c).then((function(){"function"==typeof t&&t(c),r(c)})).catch((function(t){"function"==typeof e&&e(t),i(t)}))}))},moveResize:R,setTitle:function(t,e,r){return new Promise((function(i,o){n.setTitle(c,t).then((function(){"function"==typeof e&&e(c),i(c)})).catch((function(t){"function"==typeof r&&r(t),o(t)}))}))},setStyle:function(t,e,r){if(!t||0===Object.keys(t).length||Object.keys(t).every((function(t){return!t})))return r(i="Invalid style arguments: "+JSON.stringify(t)),Promise.reject(new Error(i));if(t&&void 0!==t.focus){var i;if("boolean"!=typeof t.focus)return r(i="Focus must be boolean. Currently only focus true is supported ! "+JSON.stringify(t)),Promise.reject(new Error(i));!1===t.focus&&d.warn("Focus false is not supported ! ")}return t&&void 0!==t.hidden&&"boolean"!=typeof t.hidden?(r(i="Hidden must be boolean ! provided: "+JSON.stringify(t)),Promise.reject(new Error(i))):jn.callbackifyPromise((function(){return n.setStyle(c,t)}),e,r)},setOnTop:function(t,e,r){if(this.onTop===t){var i="OnTop setting is already set to '"+t+"'";return r(i),Promise.reject(new Error(i))}return jn.callbackifyPromise((function(){return n.setOnTop(c,t)}),e,r)},resetButtons:function(t,e,r){return jn.callbackifyPromise((function(){return n.resetButtons(c,t)}),e,r)},setSizeConstraints:function(t,e,r){if(!t||Object.keys(t).every((function(t){return void 0===t}))){var i="Invalid Constraints: "+JSON.stringify(t);return r(i),Promise.reject(new Error(i))}return jn.callbackifyPromise((function(){return n.setSizeConstraints(c,t)}),e,r)},navigate:function(e,r,i){return new Promise((function(o,s){n.navigate(c,e).then((function(){if(e===f)return"function"==typeof r&&r(c),o(c);var n=D((function(e,i){i.id===t&&e===i.url&&("function"==typeof r&&r(c),n(),o(c))}))})).catch((function(t){"function"==typeof i&&i(t),s(t)}))}))},addFrameButton:function(t,e,r){return new Promise((function(i,o){return void 0===t?"function"==typeof r?void r("No button info"):void o("No button info"):void 0===t.buttonId?"function"==typeof r?void r("No buttonId"):void o("No buttonId"):void 0===t.imageBase64?"function"==typeof r?void r("No imageBase64"):void o("No imageBase64"):void n.addFrameButton(c,t).then((function(){"function"==typeof e&&e(c),i(c)})).catch((function(t){"function"==typeof r&&r(t),o(t)}))}))},removeFrameButton:function(t,e,r){return new Promise((function(i,o){if(void 0===t||""===t)return"function"==typeof r?void r("No buttonId"):void o("No buttonId");n.removeFrameButton(c,t).then((function(){"function"==typeof e&&e(c),i(c)})).catch((function(t){"function"==typeof r&&r(t),o(t)}))}))},setVisible:N,show:function(){return N(!0)},hide:function(){return N(!1)},center:function(t){return R(jn.getDisplayCenterOfScreen(c.bounds,t||c.screen))},close:function(t,e){return new Promise((function(r,i){n.close(c).then((function(){"function"==typeof t&&t(c),r(c)})).catch((function(t){"function"==typeof e&&e(t),i(t)}))}))},snap:function(t,e,r,i){var o,s;if(!t)return Promise.reject("Please specify a target window! calledWith: "+t);if("string"==typeof t){var a=Mn.get(t);if(!a)return Promise.reject(new Error("Invalid target parameter or no such window. Invoked with:  "+t));o=a.API.group}else o=t.group;return Promise.all([(s=o,new Promise((function(t,e){var n=s.onWindowAdded((function(e,r){c.id===r.id&&(n(),t())}))}))),n.snap(c,t,e)]).then((function(){return"function"==typeof r&&r(c),c})).catch((function(t){return"function"==typeof i&&i(t),t}))},showLoader:function(t){return new Promise((function(e,r){n.showLoader(c,t).then((function(){e(c)})).catch((function(t){r(t)}))}))},hideLoader:function(){return new Promise((function(t,e){n.hideLoader(c).then((function(){t(c)})).catch((function(t){e(t)}))}))},updateContext:L,lock:function(t,e){return c.isLocked?("function"==typeof t&&t(c),Promise.resolve(c)):new Promise((function(r,i){n.lock(c).then((function(){return W()})).then((function(){"function"==typeof t&&t(c),r(c)})).catch((function(t){"function"==typeof e&&e(t),i(t)}))}))},unlock:function(t,e){return c.isLocked?new Promise((function(r,i){n.unlock(c).then((function(){return W()})).then((function(){"function"==typeof t&&t(c),r(c)})).catch((function(t){"function"==typeof e&&e(t),i(t)}))})):("function"==typeof t&&t(c),Promise.resolve(c))},getIcon:function(t,e){return new Promise((function(r,i){n.getIcon(c).then((function(e){"function"==typeof t&&t(e),r(e)})).catch((function(t){"function"==typeof e&&e(t),i(t)}))}))},setIcon:function(t,e,r){return new Promise((function(i,o){n.setIcon(c,t).then((function(){"function"==typeof e&&e(c),i(c)})).catch((function(t){"function"==typeof r&&r(t),o(t)}))}))},setFrameColor:function(t,e,r){return new Promise((function(i,o){n.setFrameColor(c,t).then((function(){"function"==typeof e&&e(c),i(c)})).catch((function(t){"function"==typeof r&&r(t),o(t)}))}))},setTabTooltip:function(t){return l(this,void 0,void 0,(function(){return v(this,(function(e){if(!t)throw new Error(t+" is null or undefined");return[2,n.setTabTooltip(c,t)]}))}))},attachTab:function(t,e,r,i){return new Promise((function(o,s){var a,u=c.id,d="Invalid tab parameter - should be an object with property id or a string. Invoked for source window id:"+c.id;if(t){if("string"==typeof t)a=t;else{if(void 0===t.id)return void s(d);a=t.id}var p={sourceWindowId:a,targetWindowId:u};e&&(p.index=e);var h=Mn.get(p.sourceWindowId).API,f=h.onAttached((function(t){t.id===h.id&&("function"==typeof r&&r(c),f(),o(c))}));n.attachTab(c,p).catch((function(t){"function"==typeof i&&i(t),f(),s(t)}))}else s(d)}))},detachTab:function(e,r,i){return new Promise((function(o,s){var a={windowId:c.id},d=e||{};void 0!==d.relativeTo&&("string"==typeof d.relativeTo?a.relativeTo=d.relativeTo:void 0!==d.relativeTo.id&&(a.relativeTo=d.relativeTo.id),void 0!==d.relativeDirection&&(a.relativeDirection=d.relativeDirection),void 0!==d.width&&(a.width=d.width),void 0!==d.height&&(a.height=d.height)),void 0!==d.bounds&&(a.bounds=d.bounds),void 0!==d.hideTabHeader&&(a.hideTabHeader=d.hideTabHeader);var p=!1,h=!1,f=u.add("frame-attached",(function(e){var n=void 0===d.hideTabHeader||d.hideTabHeader!==e.isTabHeaderVisible;t===e.id&&n&&(p=!0,f(),h&&("function"==typeof r&&r(c),o(c),"function"==typeof l&&l()))})),l=U((function(e){t===e.id&&(h=!0,l(),p&&("function"==typeof r&&r(c),o(c),"function"==typeof f&&f()))}));n.detachTab(c,a).catch((function(t){"function"==typeof i&&i(t),l(),f(),s(t)}))}))},setTabHeaderVisible:function(e,r,i){return new Promise((function(o,s){n.setTabHeaderVisible(c,e).then((function(){if(x===e)return"function"==typeof r&&r(c),o(c);var n=K((function(i){i.id===t&&i.isTabHeaderVisible===e&&("function"==typeof r&&r(c),n(),o(c))}))})).catch((function(t){"function"==typeof i&&i(t),s(t)}))}))},showPopup:function(t){return n.showPopup(c,t)},createFlydown:function(t){return n.createFlydown(c.id,t)},setModalState:function(t){return n.setModalState(c.id,t||!1)},setZoomFactor:function(t,e,r){return jn.callbackifyPromise((function(){if(isNaN(t))throw new Error("zoomFactor is not a number");return n.setZoomFactor(c,t)}),e,r)},zoomIn:function(t,e){return jn.callbackifyPromise((function(){return n.zoomIn(c)}),t,e)},zoomOut:function(t,e){return jn.callbackifyPromise((function(){return n.zoomOut(c)}),t,e)},showDevTools:function(){return n.showDevTools(c)},capture:function(t){return n.capture(c,t)},flash:function(t){var e={shouldFlash:!0};return"boolean"==typeof t&&(e.shouldFlash=t),n.flash(c,e)},onClose:function(t){return u.add("onClose",t)},onUrlChanged:D,onTitleChanged:function(t){return t(c.title,c),u.add("onTitleChanged",t)},onFrameButtonAdded:function(t){return u.add("onFrameButtonAdded",t)},onFrameButtonRemoved:function(t){return u.add("onFrameButtonRemoved",t)},onFrameButtonClicked:function(t){return u.add("onFrameButtonClicked",t)},onCollapsed:F,onExpanded:B,onMinimized:G,onMaximized:q,onNormal:H,onAttached:function(t){return u.add("attached",t)},onDetached:U,onVisibilityChanged:V,onContextUpdated:function(t){return u.add("context-updated",t)},onLockingChanged:J,onBoundsChanged:z,onFrameColorChanged:function(t){return u.add("frame-color-changed",t)},onFocusChanged:function(t){return u.add("focus-changed",t)},onGroupChanged:function(t){return u.add("group-changed",t)},onWindowAttached:function(t){return u.add("window-attached",t)},onWindowDetached:function(t){return u.add("window-detached",t)},onTabSelectionChanged:function(t){return u.add("tab-selection-changed",t)},onTabHeaderVisibilityChanged:K,onClosing:function(e){if(!Me(e))throw new Error("callback should be a function");return n.onClosing((function(t,n){var r=e();r&&r.then?r.then(t).catch(n):t()}),t)},onRefreshing:function(e){if(!Me(e))throw new Error("callback should be a function");return n.onRefreshing((function(t,n,r){var i=e(r);i&&i.then?i.then(t).catch(n):t()}),t)},onZoomFactorChanged:function(t){if(!Me(t))throw new Error("callback should be a function");return u.add("zoom-factor-changed",t)},get tabs(){return t=Mn.list,"tab"!==h.toLowerCase()?[]:Object.keys(t).reduce((function(e,n){var r=t[n];return r&&r.API.tabGroupId&&void 0!==r.API.tabGroupId&&void 0!==c.tabGroupId&&r.API.tabGroupId===c.tabGroupId&&e.push(r.API),e}),[]);var t},get isTabHeaderVisible(){return x},get isTabSelected(){return k},getURL:function(){return Promise.resolve(f)},getTitle:function(){return Promise.resolve(y)},getBounds:function(){return Promise.resolve(m)},getContext:function(){return Promise.resolve(g)},setContext:function(t){return L(t)},resizeTo:function(t,e){return R({width:t,height:e})},moveTo:function(t,e){return R({top:t,left:e})},getParentWindow:function(){var t;return l(this,void 0,void 0,(function(){var e;return v(this,(function(n){return(e=C.parentInstanceId)?[2,null===(t=Mn.list[e])||void 0===t?void 0:t.API]:[2,void 0]}))}))},getChildWindows:function(){return l(this,void 0,void 0,(function(){return v(this,(function(e){return[2,Object.keys(Mn.list).map((function(t){return Mn.list[t].API})).filter((function(e){return e.settings.parentInstanceId===t}))]}))}))}},Events:Q,Registry:u}},On=new(function(){function t(){this._registry=_n()}return Object.defineProperty(t.prototype,"hostInstance",{get:function(){return this.agmTarget},enumerable:!0,configurable:!0}),t.prototype.init=function(t,e){this.agm=t,this.agmTarget=e},t.prototype.close=function(t){var e=this;return new Promise((function(n,r){e.execute("close",{windowId:t.id}).then((function(){n(t)})).catch((function(t){r(t)}))}))},t.prototype.navigate=function(t,e){var n=this;return new Promise((function(r,i){n.execute("navigate",{windowId:t.id,options:{url:e}}).then((function(){r(t)})).catch((function(t){i(t)}))}))},t.prototype.setStyle=function(t,e){var n;return l(this,void 0,void 0,(function(){var r,i,o,s,a,c,u,d,p,h,f,l,y;return v(this,(function(v){switch(v.label){case 0:return r=[],i=function(t){return r.push(t)},void 0===e.focus||t.isFocused||i(t.focus()),void 0!==e.hidden&&(o=!e.hidden,i(t.setVisible(o))),void 0!==e.onTop&&i(t.setOnTop(e.onTop)),void 0===e.tabTooltip&&void 0===e.tabToolTip||(n=e.tabTooltip,s=null!=n?n:e.tabToolTip,i(t.setTabTooltip(s))),a=e.maxWidth,c=e.maxHeight,u=e.minWidth,d=e.minHeight,p=e.allowClose,h=e.allowCollapse,f=e.allowLockUnlock,l=e.allowMaximize,y=e.allowMinimize,i(t.setSizeConstraints({maxWidth:a,maxHeight:c,minWidth:u,minHeight:d})),i(t.resetButtons({allowClose:p,allowCollapse:h,allowLockUnlock:f,allowMaximize:l,allowMinimize:y})),[4,Promise.all(r)];case 1:return v.sent(),[2,t]}}))}))},t.prototype.setSizeConstraints=function(t,e){var n=this;return new Promise((function(r,i){n.execute("setSizeConstraints",{windowId:t.id,options:e}).then((function(){r(t)})).catch(i)}))},t.prototype.setTabTooltip=function(t,e){return l(this,void 0,void 0,(function(){return v(this,(function(n){switch(n.label){case 0:return[4,this.execute("setTabTooltip",{windowId:t.id,options:{tabToolTip:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.resetButtons=function(t,e){var n=this;return new Promise((function(r,i){n.execute("resetButtons",{windowId:t.id,options:e}).then((function(){r(t)})).catch(i)}))},t.prototype.setOnTop=function(t,e){var n=this;return new Promise((function(r,i){n.execute("setOnTop",{windowId:t.id,options:{onTop:e}}).then((function(){r(t)})).catch(i)}))},t.prototype.setTitle=function(t,e){var n=this;return new Promise((function(r,i){var o={windowId:t.id,options:{title:e}};n.execute("setTitle",o).then((function(){r(t)})).catch((function(t){i(t)}))}))},t.prototype.moveResize=function(t,e){var n=this;return new Promise((function(r,i){n.execute("moveResize",{windowId:t.id,options:{bounds:e}}).then((function(){r(t)})).catch((function(t){i(t)}))}))},t.prototype.addFrameButton=function(t,e){var n=this;return new Promise((function(r,i){n.execute("addButton",{windowId:t.id,options:e}).then((function(){r(t)})).catch((function(t){i(t)}))}))},t.prototype.removeFrameButton=function(t,e){var n=this;return new Promise((function(r,i){n.execute("removeButton",{windowId:t.id,options:e}).then((function(){r(t)})).catch((function(t){i(t)}))}))},t.prototype.activate=function(t){var e=this;return new Promise((function(n,r){e.execute("activate",{windowId:t.id}).then((function(){n(t)})).catch((function(t){r(t)}))}))},t.prototype.focus=function(t){var e=this;return new Promise((function(n,r){e.execute("focus",{windowId:t.id}).then((function(){n(t)})).catch((function(t){r(t)}))}))},t.prototype.maximizeRestore=function(t){var e=this;return new Promise((function(n,r){e.execute("maximizeRestore",{windowId:t.id}).then((function(){n(t)})).catch((function(t){r(t)}))}))},t.prototype.maximize=function(t){var e=this;return new Promise((function(n,r){e.execute("maximize",{windowId:t.id}).then((function(){n(t)})).catch((function(t){r(t)}))}))},t.prototype.restore=function(t){var e=this;return new Promise((function(n,r){e.execute("restore",{windowId:t.id}).then((function(){n(t)})).catch((function(t){r(t)}))}))},t.prototype.minimize=function(t){var e=this;return new Promise((function(n,r){e.execute("minimize",{windowId:t.id}).then((function(){n(t)})).catch((function(t){r(t)}))}))},t.prototype.collapse=function(t){var e=this;return new Promise((function(n,r){e.execute("collapse",{windowId:t.id}).then((function(){n(t)})).catch((function(t){r(t)}))}))},t.prototype.expand=function(t){var e=this;return new Promise((function(n,r){e.execute("expand",{windowId:t.id}).then((function(){n(t)})).catch((function(t){r(t)}))}))},t.prototype.toggleCollapse=function(t){var e=this;return new Promise((function(n,r){e.execute("toggleCollapse",{windowId:t.id}).then((function(){n(t)})).catch((function(t){r(t)}))}))},t.prototype.snap=function(t,e,n){var r=this;return new Promise((function(i,o){t.id;var s,a="Invalid target parameter - should be an object with property id or a string. Invoked for source window id:"+t.id;if(e){if("string"==typeof e)s=e;else{if(void 0===e.id)return void o(a);s=e.id}var c={targetWindowId:s};n&&(c.snappingEdge=n),r.execute("snap",{windowId:t.id,options:c}).then((function(){i(t)})).catch((function(t){o(t)}))}else o(a)}))},t.prototype.attachTab=function(t,e){var n=this;return new Promise((function(r,i){n.execute("attachTab",{windowId:t.id,options:e}).then((function(){r(t)})).catch((function(t){i(t)}))}))},t.prototype.detachTab=function(t,e){var n=this;return new Promise((function(r,i){n.execute("detachTab",{windowId:t.id,options:e}).then((function(){r(t)})).catch((function(t){i(t)}))}))},t.prototype.setVisible=function(t,e){var n=this;return void 0===e&&(e=!0),new Promise((function(r,i){var o;o=e?"show":"hide",n.execute(o,{windowId:t.id}).then((function(){r(t)})).catch((function(t){i(t)}))}))},t.prototype.showLoader=function(t,e){var n=this;return new Promise((function(r,i){n.execute("showLoadingAnimation",{windowId:t.id,options:e}).then((function(){r(t)})).catch((function(t){i(t)}))}))},t.prototype.hideLoader=function(t){var e=this;return new Promise((function(n,r){e.execute("hideLoadingAnimation",{windowId:t.id}).then((function(){n(t)})).catch((function(t){r(t)}))}))},t.prototype.updateContext=function(t,e){var n=this;return new Promise((function(r,i){n.execute("updateContext",{windowId:t.id,context:e,replace:!(Object.keys(t.context).length>0)}).then((function(){r(t)})).catch((function(t){i(t)}))}))},t.prototype.lock=function(t){var e=this;return new Promise((function(n,r){e.execute("lockUnlock",{windowId:t.id,options:{lock:!0}}).then((function(){n(t)})).catch((function(t){r(t)}))}))},t.prototype.unlock=function(t){var e=this;return new Promise((function(n,r){e.execute("lockUnlock",{windowId:t.id,options:{lock:!1}}).then((function(){n(t)})).catch((function(t){r(t)}))}))},t.prototype.getIcon=function(t){var e=this;return new Promise((function(n,r){e.execute("getIcon",{windowId:t.id,options:{}}).then((function(t){n(t.icon)})).catch((function(t){r(t)}))}))},t.prototype.setIcon=function(t,e){var n=this;return new Promise((function(r,i){n.execute("setIcon",{windowId:t.id,options:{dataURL:e}}).then((function(){r(t)})).catch((function(t){i(t)}))}))},t.prototype.setFrameColor=function(t,e){var n=this;return new Promise((function(r,i){n.execute("setFrameColor",{windowId:t.id,options:{frameColor:e}}).then((function(){r(t)})).catch((function(t){i(t)}))}))},t.prototype.setTabHeaderVisible=function(t,e){var n=this;return new Promise((function(r,i){n.execute("setTabHeaderVisible",{windowId:t.id,options:{toShow:e}}).then((function(){r(t)})).catch((function(t){i(t)}))}))},t.prototype.showPopup=function(t,e){return l(this,void 0,void 0,(function(){var n,r;return v(this,(function(i){switch(i.label){case 0:return e?((n=f({},e)).targetLocation||(n.targetLocation="bottom"),r=f(f({},n),{popupBounds:n.size,targetId:t.id,popupId:n.windowId}),[4,this.execute("showPopupWindow",{windowId:t.id,options:r})]):[2,Promise.reject("The options object is not valid!")];case 1:return i.sent(),[2,t]}}))}))},t.prototype.createFlydown=function(t,e){return l(this,void 0,void 0,(function(){var n,r,i=this;return v(this,(function(o){return e?((n=f({},e)).horizontalOffset||(n.horizontalOffset=0),n.verticalOffset||(n.verticalOffset=0),r=this.reformatFlydownOptions(t,n),[2,this.execute("setFlydownArea",{windowId:t,options:r}).then((function(){var t=r.zones.map((function(t){return t.id}));return r.zones.forEach((function(t){var n="function"==typeof t.flydownSize?t.flydownSize:function(){return t.flydownSize};e.size instanceof Function&&t.flydownSize&&(n=function(n,r){return l(i,void 0,void 0,(function(){var i;return v(this,(function(o){switch(o.label){case 0:return e.size instanceof Function?[4,e.size(n,r)]:[3,2];case 1:i=o.sent(),o.label=2;case 2:return t.flydownSize instanceof Function&&t.flydownSize!==e.size?[4,t.flydownSize(n,r)]:[3,4];case 3:return[2,o.sent()||i];case 4:return[2,i||t.flydownSize]}}))}))}),i._registry.clearKey(r.targetId+"_"+t.id),i._registry.add(r.targetId+"_"+t.id,n)})),{destroy:function(){return i.clearFlydownArea(r.targetId,t)},options:n}}))]):[2,Promise.reject("The options object is not valid!")]}))}))},t.prototype.setModalState=function(t,e){return l(this,void 0,void 0,(function(){return v(this,(function(n){return[2,this.execute("setModalState",{windowId:t,options:{isModal:e}})]}))}))},t.prototype.handleFlydownBoundsRequested=function(t,e){return l(this,void 0,void 0,(function(){var n,r,i,o,s;return v(this,(function(a){switch(a.label){case 0:return n=function(){return e.cancel=!0},r={zoneId:e.flydownId,flydownWindowBounds:e.flydownWindowBounds,flydownWindowId:e.flydownWindowId},[4,Promise.all(this._registry.execute(t+"_"+e.flydownId,r,n))];case 1:return 1===(i=a.sent()).length?(o={height:0,width:0,top:0,left:0},s="object"!=typeof i[0]||Array.isArray(i[0])?o:i[0],[2,f(f({},e),{flydownWindowBounds:s})]):[2]}}))}))},t.prototype.zoomIn=function(t){return l(this,void 0,void 0,(function(){return v(this,(function(e){switch(e.label){case 0:return[4,this.execute("zoomIn",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.zoomOut=function(t){return l(this,void 0,void 0,(function(){return v(this,(function(e){switch(e.label){case 0:return[4,this.execute("zoomOut",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.setZoomFactor=function(t,e){return l(this,void 0,void 0,(function(){return v(this,(function(n){switch(n.label){case 0:return[4,this.execute("setZoomFactor",{windowId:t.id,options:{zoomFactor:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.showDevTools=function(t){return l(this,void 0,void 0,(function(){return v(this,(function(e){switch(e.label){case 0:return[4,this.execute("showDevTools",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.capture=function(t,e){return l(this,void 0,void 0,(function(){return v(this,(function(n){switch(n.label){case 0:return[4,this.execute("captureScreenshot",{windowId:t.id,options:f({},e)})];case 1:return[2,n.sent().data]}}))}))},t.prototype.captureGroup=function(t,e){return l(this,void 0,void 0,(function(){return v(this,(function(n){switch(n.label){case 0:return[4,this.execute("captureGroupScreenshot",{windowId:t[0],options:f({groupWindowIds:t},e)})];case 1:return[2,n.sent().data]}}))}))},t.prototype.flash=function(t,e){return l(this,void 0,void 0,(function(){return v(this,(function(n){switch(n.label){case 0:return[4,this.execute("flash",{windowId:t.id,options:f({},e)})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.configure=function(t,e){return l(this,void 0,void 0,(function(){return v(this,(function(n){return[2,this.execute("configure",{windowId:t,options:f({},e)})]}))}))},t.prototype.execute=function(t,e){var n=this;return new Promise((function(r,i){var o=f(f({},e),{command:t});n.agm.invoke("T42.Wnd.Execute",o,n.agmTarget).then((function(t){t.returned&&t.returned.errorMsg?i(t):r(t.returned)})).catch((function(t){i(t)}))}))},t.prototype.setGroupHeaderVisible=function(t,e){return this.execute("setGroupHeaderVisibility",{windowId:t,options:{toShow:e}})},t.prototype.getGroupTitle=function(t){return this.execute("getGroupTitle",{windowId:t,options:{}}).then((function(t){return t.title}))},t.prototype.setGroupTitle=function(t,e){return this.execute("setGroupTitle",{windowId:t,options:{title:e}})},t.prototype.onClosing=function(t,e){var n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addCloseHandler(t,e)},t.prototype.onRefreshing=function(t,e){var n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addRefreshHandler(t,e)},t.prototype.reformatFlydownOptions=function(t,e){var n=function(t,n){if(e[n]&&(void 0===t[n]||null===t[n])){var r=e[n];t[n]=r}},r=e.zones.map((function(t){return n(t,"windowId"),n(t,"targetLocation"),!e.size||void 0!==t.flydownSize&&null!==t.flydownSize||(t.flydownSize=e.size),t.flydownBounds=t.flydownSize,t.flydownId=t.windowId,t.targetLocation||(t.targetLocation="bottom"),t}));return f(f({},e),{zones:r,targetId:t,flydownBounds:e.size,flydownActiveArea:e.activeArea})},t.prototype.clearFlydownArea=function(t,e){var n=this;return this.execute("clearFlydownWindowArea",{windowId:t,options:{}}).then((function(){e.forEach((function(e){n._registry.clearKey(t+"_"+e)}))}))},t}());function Rn(t,e){var n=Mn.list;return Object.keys(n).reduce((function(r,i){var o=n[i];return o.API.tabGroupId===e&&o.API.id!==t&&(r[i]=o),r}),{})}var Nn=function(){function t(t,e,n,r,i){this._registry=_n(),this._waitTimeout=1e4,this._agm=t,this._logger=e.subLogger("gd-env"),this._agmInstance=this.normalizeInstance(r),this._windowId=i,this._appManagerGetter=n}return t.prototype.init=function(){var t=this;return new Promise((function(e,n){void 0===t._agmInstance&&(t._agmInstance="best"),t._agm.registerAsync("T42.Wnd.OnEventWithResponse",(function(e,n,r,i){t.respondToEvent(e).then(r).catch(i)}));new Promise((function(r,i){t._agm.subscribe("T42.Wnd.OnEvent",{waitTimeoutMs:t._waitTimeout,target:t._agmInstance,onData:function(n){t.updateWindow(n.data,e)},onConnected:function(e){t._agmInstance=t.normalizeInstance(e),On.init(t._agm,t._agmInstance)}}).catch((function(t){n("Can not subscribe for stream T42.Wnd.OnEvent. Err: "+t)}))}))}))},Object.defineProperty(t.prototype,"executor",{get:function(){return On},enumerable:!0,configurable:!0}),t.prototype.open=function(t,e,n,r,i){var o=f({},n=n||{});void 0!==t?(void 0!==o.relativeTo&&"string"!=typeof o.relativeTo&&(o.relativeTo=o.relativeTo.id||""),o.name=t,o.url=e,o.windowState=n.windowState||n.state,delete o.state,this._agm.invoke("T42.Wnd.Create",o,this._agmInstance).then((function(t){if(void 0!==t.returned){var e=t.returned.id;r(e)}else i({message:"failed to execute T42.Wnd.Create - unknown reason"})})).catch(i)):i({message:"The name is undefined"})},t.prototype.createFlydown=function(t,e){return this.executor.createFlydown(t,e)},t.prototype.showPopup=function(t,e){return l(this,void 0,void 0,(function(){var n;return v(this,(function(r){switch(r.label){case 0:return n=Mn.get(t),[4,this.executor.showPopup(n.API,e)];case 1:return r.sent(),[2]}}))}))},t.prototype.tabAttached=function(t){return this._registry.add("tab-attached",t)},t.prototype.tabDetached=function(t){return this._registry.add("tab-detached",t)},t.prototype.onWindowFrameColorChanged=function(t){return this._registry.add("frame-color-changed",t)},t.prototype.onEvent=function(t){return this._registry.add("window-event",t)},t.prototype.my=function(){return this._windowId},t.prototype.execute=function(t,e,n){return this._agm.invoke("T42.Wnd.Execute",{command:t,options:n,windowId:e})},t.prototype.setGroupHeaderVisible=function(t,e){return this._agm.invoke("T42.Wnd.SetGroupHeaderVisible",{windowId:t,toShow:e},this._agmInstance)},t.prototype.onCompositionChanged=function(t){return this._registry.add("composition-changed",t)},t.prototype.onGroupHeaderVisibilityChanged=function(t){return this._registry.add("group-header-changed",t)},t.prototype.onWindowGotFocus=function(t){return this._registry.add("got-focus",t)},t.prototype.onWindowLostFocus=function(t){return this._registry.add("lost-focus",t)},t.prototype.normalizeInstance=function(t){if(t)return{application:t.application,machine:t.machine,user:t.user}},t.prototype.respondToEvent=function(t){return"ShowFlydownBoundsRequested"===t.type?this.executor.handleFlydownBoundsRequested(t.data.windowId,t.data):Promise.reject("There isn't a handler for "+t.type)},t.prototype.updateWindow=function(t,e){var n=this,r=this.getExtendedStreamEvent(t);if("Snapshot"===t.type)return t.windows.forEach((function(t){var e=n.createWindow(t.id,t);Mn.markReadyToShow(e.API.id),n._registry.execute("window-event",r)})),void e(this);if("Created"===t.type){var i=t,o=this.createWindow(i.windowId,i.data||{});return Mn.setReadyState(o.API.id),void this._registry.execute("window-event",r)}var s=Mn.get(t.windowId);if(s){var a=s.API,c=s.Events;if("BoundsChanged"===t.type){var u=t;c.handleBoundsChanged(u.data)}if("UrlChanged"===t.type){var d=t;Mn.setUrlChangedState(d.windowId),c.handleUrlChanged(d.data)}if("TitleChanged"===t.type){var p=t;c.handleTitleChanged(p.data)}if("VisibilityChanged"===t.type&&c.handleVisibilityChanged(t.data),"ContextChanged"===t.type&&c.handleContextUpdated(t.data),"StateChanged"===t.type&&c.handleWindowChangeState(t.data),"FrameColorChanged"===t.type&&(c.handleFrameColorChanged(t.data),this._registry.execute("frame-color-changed",a)),"CompositionChanged"===t.type){var h=t;c.handleCompositionChanged(h.data.neighbors,h.data.groupId),this._registry.execute("composition-changed",h.data)}if("GroupHeaderVisibilityChanged"===t.type){var f=t;c.handleGroupHeaderVisibilityChanged(f.data.groupHeaderVisible),this._registry.execute("group-header-changed",f.data)}if("FocusChanged"===t.type){var l=t;this.focusChanged(c,a,l.data)}if("WindowFrameChanged"===t.type&&(c.handleFrameAttached(t.data.frameId,t.data.isTabHeaderVisible),this._registry.execute("frame-changed")),"WindowFrameAdded"===t.type){c.handleAttached(t.data.frameId,t.data.isTabHeaderVisible);var v=Rn(a.id,t.data.frameId);Object.keys(v).forEach((function(t){v[t].Events.handleWindowAttached(a)})),this._registry.execute("tab-attached",a,t.data.frameId,t.data.isTabHeaderVisible)}if("WindowFrameRemoved"===t.type){var y=a.tabGroupId;c.handleDetached(t.data.frameId);var g=Rn(a.id,y);Object.keys(g).forEach((function(t){g[t].Events.handleWindowDetached(a)}));var m=this._registry.add("frame-changed",(function(){m(),n._registry.execute("tab-detached",a,t.data.frameId,a.tabGroupId)}))}"TabHeaderVisibilityChanged"===t.type&&c.handleTabHeaderVisibilityChanged(t.data.isTabHeaderVisible),"FrameSelectionChanged"===t.type&&c.handleFrameSelectionChanged(t.data.newWindowId,t.data.prevWindowId),"ButtonClicked"===t.type&&c.handleFrameButtonClicked(t.data),"ButtonAdded"===t.type&&c.handleFrameButtonAdded(t.data),"ButtonRemoved"===t.type&&c.handleFrameButtonRemoved(t.data),"WindowZoomFactorChanged"===t.type&&c.handleZoomFactorChanged(t.data),"Closed"===t.type&&(Mn.remove(s),c.handleWindowClose()),"FrameIsLockedChanged"===t.type&&c.handleFrameIsLockedChanged(t.data),this._registry.execute("window-event",r)}else this._logger.error("received update for unknown window. Stream:', "+JSON.stringify(t,null,4))},t.prototype.createWindow=function(t,e){var n,r=Mn.get(t),i=En(t,this.mapToWindowConstructorOptions(e),On,this._logger,this._appManagerGetter,this._agm,null===(n=r)||void 0===n?void 0:n.Registry);return Mn.add(i),i},t.prototype.focusChanged=function(t,e,n){t.handleFocusChanged(n),n?this._registry.execute("got-focus",e):this._registry.execute("lost-focus",e)},t.prototype.mapToWindowConstructorOptions=function(t){return{name:t.name,context:t.context,bounds:t.bounds,url:t.url,title:t.title,isVisible:t.isVisible,focus:t.isFocused,state:t.state,frameColor:t.frameColor,groupId:t.groupId,neighbours:t.neighbors,isFocused:t.isFocused,isGroupHeaderVisible:t.groupHeaderVisible,isCollapsed:t.isCollapsed,tabGroupId:t.frameId,mode:t.mode,isTabHeaderVisible:t.isTabHeaderVisible,isTabSelected:t.isActiveTab,settings:t.settings,windowType:t.windowType,zoomFactor:t.zoomFactor,isLocked:t.isLocked}},t.prototype.getExtendedStreamEvent=function(t){try{var e=f({state:t.type,windowName:Mn.get(t.windowId).API.name},t);return"WindowFrameAdded"===e.state&&(e.state="TabAttached"),"StateChanged"===e.state&&(e.state=e.data.charAt(0).toUpperCase()+e.data.slice(1)),"ButtonAdded"===e.state&&(e.state="FrameButtonAdded"),"ButtonRemoved"===e.state&&(e.state="FrameButtonRemoved"),e}catch(e){return t}},t}(),Ln=function(t,e){var n=_n(),r=[];function i(){return new Promise((function(t,e){var n=c((function(e){n(),t()}))}))}function o(t,n,r,i){return new Promise((function(i,o){e.execute(t,n).then((function(t){"function"==typeof r&&r(u),i(u)})).catch((function(t){o(t)}))}))}function s(){var t=[];return r.forEach((function(e){var n=a(e);void 0!==n&&t.push(n)})),t}function a(t){return Mn.get(t)?Mn.get(t).API:void 0}function c(t){return n.add("header-visibility-changed",t)}var u={id:t,get windows(){return e=s(),"function"==typeof t&&t(e),e;var t,e},find:function(t,e){var n;n="string"==typeof t?t:t.id;var i=r.indexOf(n);if(-1!==i){var o=a(r[i]);return"function"==typeof e&&e(o),o}},get isHeaderVisible(){return void 0===s().find((function(t){return!t.isGroupHeaderVisible}))},showHeader:function(t,n){return new Promise((function(n,o){Promise.all([e.setGroupHeaderVisible(r[0],!0),i()]).then((function(){"function"==typeof t&&t(u),n(u)})).catch((function(t){o(t)}))}))},hideHeader:function(t,n){return new Promise((function(n,o){Promise.all([e.setGroupHeaderVisible(r[0],!1),i()]).then((function(){"function"==typeof t&&t(u),n(u)})).catch((function(t){}))}))},getTitle:function(){return e.getGroupTitle(r[0])},setTitle:function(t){return e.setGroupTitle(r[0],t)},capture:function(t){return e.captureGroup(r,t)},maximize:function(e,n){return o("maximize",{groupId:t},e)},restore:function(e,n){return o("restore",{groupId:t},e)},onHeaderVisibilityChanged:c,onWindowAdded:function(t){return n.add("window-added",t)},onWindowRemoved:function(t){return n.add("window-removed",t)}};return{groupAPI:u,groupInternal:{addWindow:function(t){if(-1===r.indexOf(t)){r.push(t);var e=Mn.get(t);e.Events.handleGroupAssociation(u),n.execute("window-added",u,e.API)}},removeWindow:function(t){var e=r.indexOf(t);if(-1!==e){r.splice(e,1);var i=a(t);n.execute("window-removed",u,i)}},handleGroupHeaderVisibilityChanged:function(t){n.execute("header-visibility-changed",u)}}}},Wn=function(t,e){var n=e.subLogger("groups"),r=_n(),i={},o=-1,s=Mn.list;function a(t,n){var r,o;if(void 0!==t)return r="string"==typeof t?t:t.id,Object.keys(i).forEach((function(t){var e=i[t].groupAPI;void 0===e.find(r)||(o=e)})),"function"==typeof n&&n(o),o;e.debug("trying to find a group by a window, but winId is undefined")}function c(t){n.trace("Adding new window "+t.API.id+" to win.API.groupId "+t.API.groupId);var e=u(t);e&&(n.trace("handleGroupAssociation "+t.API.id+" to group.groupAPI.id "+e.groupAPI.id),t.Events.handleGroupAssociation(e.groupAPI))}function u(e,r){var o=r||e.API.groupId,s=e.API.id;if(void 0!==o&&void 0!==s){var a=function(e){if(i.hasOwnProperty(e))return i[e];var n=Ln(e,t.executor);return i[e]=n,n}(o);return a.groupInternal.addWindow(s),a}n.debug("trying to add a window without group - winId: "+s)}function d(t,e){var n=t.API.id,r=e||t.API.groupId;void 0!==r&&(i[r].groupInternal.removeWindow(n),t.Events.handleGroupAssociation(void 0),function(t){i.hasOwnProperty(t)&&void 0!==i[t]&&0===i[t].groupAPI.windows.length&&delete i[t]}(r))}return Object.keys(s).forEach((function(t){c(s[t])})),t.onCompositionChanged((function(t){!function(t){var e=t.groupId,i=t.windowId,o=a(i),s=o?o.id:void 0;if(n.trace("handleCompositionChanged newGroupId: "+e+" windowId: "+i+" oldGroup: "+s),s===e)return void n.trace("handleCompositionChanged newGroupId: "+e+" windowId: "+i+" oldGroup: "+s+" are the same - returning...");var c=Mn.get(i)||Mn.get(i),p=u(c,e);o&&(d(c,s),r.execute("window-moved",i,o,e));c.Events.handleGroupChanged(p.groupAPI,o)}(t)})),t.onGroupHeaderVisibilityChanged((function(t){var e=a(t.windowId);if(void 0!==e){var n=i[e.id];-1===o&&(o=e.windows.length),0===--o&&(o=-1,n.groupInternal.handleGroupHeaderVisibilityChanged(t))}})),Mn.onAdded((function(t){c(t)})),Mn.onRemoved((function(t){d(t)})),{groupsAPI:{get my(){return a(t.my())},list:function(t){var e=Object.keys(i).map((function(t){if(i[t])return i[t].groupAPI}));return"function"==typeof t&&t(e),e},findGroupByWindow:a},groupsEvents:{onWindowMoved:function(t){return r.add("window-moved",t)}}}},Dn=function(t,e,n,r){var i,o,s=_n(),a=e;Mn.init(a);var c=new Promise((function(e,s){(function(t,e,n,r){var i=e;return new Promise((function(e,o){if(2===r)throw i.trace("running in HC"),new Error("GD2 not supported");if(r>=3)i.trace("running in GD 3"),new Nn(t,i,n,void 0,window.glue42gd.windowId).init().then(e).catch(o);else{var s=new Nn(t,i,n).init();Promise.race([s,(a=1e4,new Promise((function(t,e){return setTimeout((function(){e("timeout waiting for streams")}),a)})))]).then(e).catch(o)}var a}))})(t,a,n,r).then((function(t){o=t,i=Wn(t,a),e()})).catch((function(t){var e="Environment detector fails with: "+t;a.error(e),s(e)}))}));function u(){var t=Mn.getIfReady(o.my());return t?t.API:void 0}function d(t){return s.add("window-added",t)}function p(t){return s.add("window-removed",t)}return Mn.onReadyWindow((function(t){s.execute("window-added",t.API)})),Mn.onRemoved((function(t){s.execute("window-removed",t.API)})),{my:u,open:function(t,e,n,r,i){return new Promise((function(s,a){var c=function(t){"function"==typeof i&&i(t),a(t)};o.open(t,e,n,(function(t){Mn.waitFor(t).then((function(t){"function"==typeof r&&r(t.API),s(t.API),"electron"===t.API.windowType&&t.Events.handleUrlChanged(t.API.url)})).catch(c)}),c)}))},find:function(t,e,n){var r=Mn.list,i=Object.keys(r).reduce((function(e,n){var i=r[n];return i&&i.API.name===t&&e.push(i.API),e}),[]);if("function"!=typeof e)return i[0];i.length>0?e(i[0]):"function"==typeof n&&n("There is no window with name:"+t)},findById:function(t,e,n){var r=Mn.list,i=Object.keys(r).reduce((function(e,n){var i=r[n];return void 0!==i&&i.API.id===t&&e.push(i.API),e}),[]);if("function"!=typeof e)return i[0];i.length>0?e(i[0]):"function"==typeof n&&n("There is no window with such id:"+t)},list:function(t){var e=Mn.list,n=Object.keys(e).map((function(t){return e[t].API}));if("function"!=typeof t)return n;t(n)},ready:function(){return c},onWindowAdded:d,windowAdded:d,onWindowRemoved:p,windowRemoved:p,onTabAttached:function(t){return c.then((function(){o.tabAttached(t)}))},onTabDetached:function(t){return c.then((function(){o.tabDetached(t)}))},onWindowFrameColorChanged:function(t){return c.then((function(){return o.onWindowFrameColorChanged(t)}))},get groups(){return i.groupsAPI},onWindowGotFocus:function(t){var e;return c.then((function(){e=o.onWindowGotFocus(t)})),function(){e&&e()}},onWindowLostFocus:function(t){var e;return c.then((function(){e=o.onWindowLostFocus(t)})),function(){e&&e()}},onEvent:function(t){var e,n=!1;return c.then((function(){n||(e=o.onEvent(t))})),function(){n=!0,e&&e()}},createFlydown:function(t,e){return o.createFlydown(t,e)},showPopup:function(t,e){return o.showPopup(t,e)},configure:function(t){var e=u(),n=e?e.id:"";return On.configure(n,t)}}},Fn=new(function(){function t(){this.layouts=[]}return t.prototype.removeWhere=function(t){this.layouts=this.layouts.filter(t)},t.prototype.add=function(t){this.layouts.push(t)},Object.defineProperty(t.prototype,"all",{get:function(){return this.layouts},enumerable:!0,configurable:!0}),t.prototype.where=function(t){return this.layouts.filter(t)},t.prototype.first=function(t){return this.where(t)[0]},t}());var Bn=1;var qn,Gn,Hn,Un={nextValue:function(){return(Bn=(9301*Bn+49297)%233280)/233280},seed:function(t){Bn=t}},Vn="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function Jn(){Hn=!1}function zn(t){if(t){if(t!==qn){if(t.length!==Vn.length)throw new Error("Custom alphabet for shortid must be "+Vn.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+Vn.length+" unique characters. These characters were not unique: "+e.join(", "));qn=t,Jn()}}else qn!==Vn&&(qn=Vn,Jn())}function Kn(){return Hn||(Hn=function(){qn||zn(Vn);for(var t,e=qn.split(""),n=[],r=Un.nextValue();e.length>0;)r=Un.nextValue(),t=Math.floor(r*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var Yn={characters:function(t){return zn(t),qn},seed:function(t){Un.seed(t),Gn!==t&&(Jn(),Gn=t)},lookup:function(t){return Kn()[t]},shuffled:Kn},Zn="object"==typeof window&&(window.crypto||window.msCrypto);var Xn=function(){if(!Zn||!Zn.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return Zn.getRandomValues(t),48&t[0]};var $n=function(t,e){for(var n,r=0,i="";!n;)i+=t(e>>4*r&15|Xn()),n=e<Math.pow(16,r+1),r++;return i};var Qn,tr,er=function(t){var e=Yn.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var nr=function(t){var e="",n=Math.floor(.001*(Date.now()-1459707606518));return n===tr?Qn++:(Qn=0,tr=n),e+=$n(Yn.lookup,6),e+=$n(Yn.lookup,t),Qn>0&&(e+=$n(Yn.lookup,Qn)),e+=$n(Yn.lookup,n)};var rr=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=Yn.characters(),n=t.length,r=0;r<n;r++)if(-1===e.indexOf(t[r]))return!1;return!0},ir=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e=0;function n(){return nr(e)}t.exports=n,t.exports.generate=n,t.exports.seed=function(e){return Yn.seed(e),t.exports},t.exports.worker=function(n){return e=n,t.exports},t.exports.characters=function(t){return void 0!==t&&Yn.characters(t),Yn.shuffled()},t.exports.decode=er,t.exports.isValid=rr})),or=(ir.generate,ir.seed,ir.worker,ir.characters,ir.decode,ir.isValid,ir),sr=function(){function t(t,e,n,r){this.config=t,this.activitiesGetter=e,this.callbacks=n,this.logger=r,this.interop=t.agm,this.registerRequestMethods()}return t.prototype.onSaveRequested=function(t){return this.callbacks.add("saveRequested",t)},t.prototype.isActivityOwner=function(){if("undefined"!=typeof htmlContainer){var t=htmlContainer.getContext();return t&&t._t42&&t._t42.activityIsOwner}var e=this.activitiesGetter();if(!e)return!1;if(!e.inActivity)return!1;var n=e.my.window,r=e.my.activity;return!(!r&&!n)&&r.owner.id===n.id},t.prototype.registerRequestMethods=function(){var t=this;this.interop.register("T42.HC.GetSaveContext",(function(e){var n,r,i,o=t.callbacks.execute("saveRequested",e);(null===(n=o)||void 0===n?void 0:n.length)>1&&t.logger.warn('Multiple subscriptions for "glue.layouts.onSaveRequested" - only the first one will be used');var s=o[0],a=t.config.autoSaveWindowContext;if(a)return{autoSaveWindowContext:a};var c={windowContext:null===(r=s)||void 0===r?void 0:r.windowContext,activityContext:void 0};return t.isActivityOwner()&&(c.activityContext=null===(i=s)||void 0===i?void 0:i.activityContext),c}))},t}();function ar(t){if(!t)return t;if(Array.isArray(t))return t.map((function(t){return ar(t)}));if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return t;return Object.keys(t).reduce((function(e,n){var r=ar(t[n]),i=n;return n[0].toLowerCase()!==n[0]&&(i=n[0].toLowerCase()+n.substr(1)),e[i]=r,e}),{})}var cr=function(t){this.name=t.name,this.type=t.type,this.components=t.components,this.context=t.context,this.metadata=t.metadata,this.version=t.version},ur=function(){function t(t,e,n,r){this.config=t,this.stream=e,this.callbacks=n,this.appManager=t.appManager,this.onEvent=e.onEvent,this.provider=new sr(t,t.activityGetter,n,r),e.subscribe()}return t.prototype.setDefaultGlobal=function(t){return l(this,void 0,void 0,(function(){return v(this,(function(e){switch(e.label){case 0:return[4,this.config.agm.invoke("T42.ACS.SelectDefaultLayout",{name:t})];case 1:return e.sent(),[2]}}))}))},t.prototype.clearDefaultGlobal=function(){return l(this,void 0,void 0,(function(){return v(this,(function(t){switch(t.label){case 0:return[4,this.config.agm.invoke("T42.ACS.DeselectDefaultLayout")];case 1:return t.sent(),[2]}}))}))},t.prototype.getDefaultGlobal=function(){return l(this,void 0,void 0,(function(){var t,e;return v(this,(function(n){switch(n.label){case 0:return[4,this.config.agm.invoke("T42.ACS.GetDefaultLayout")];case 1:return t=n.sent(),(e=t.returned)?this.isSlimMode()?[2,e]:[2,this.list().find((function(t){return t.name===e.name&&"Global"===t.type}))]:[2,void 0]}}))}))},t.prototype.ready=function(){return"fullWaitSnapshot"===this.config.mode?this.stream.gotSnapshot:this.stream.ready},t.prototype.save=function(t){var e=this;return new Promise((function(n,r){if(e.verifyNotSlimMode(),!t.name)throw Error("layout.name argument is required");t.type||(t.type="Global"),t.activityId&&(t.type="Activity"),void 0===t.ignoreHidden&&(t.ignoreHidden=!0);var i={name:t.name,actIds:[],appIds:[],type:t.type,context:t.context,metadata:t.metadata||{},options:{ignoreLayoutRestrictions:!1}};if("Activity"===t.type){var o=t.activityId;if(!o){if(!e.appManager.myInstance.inActivity)throw new Error("Current application is not in activity. Can not save activity layout for it");o=e.appManager.myInstance.activityId}i.actIds.push(o),i.options={ignoreLayoutRestrictions:!0}}else{if("Global"!==t.type)throw new Error("layout type "+t.type+" not supported");if(2===e.config.gdMajorVersion){var s=e.appManager.instances();t.ignoreHidden&&(s=s.filter((function(t){return e.isVisibleWindow(t)}))),t.ignoreMyInstance&&e.appManager.myInstance&&(s=s.filter((function(t){return t.id!==e.appManager.myInstance.id}))),s.reduce((function(t,e){if(!e.id)return t;if(e.inActivity){var n=e.activityId;-1===t.actIds.indexOf(n)&&t.actIds.push(n)}else t.appIds.push(e.id);return t}),i)}else i.autoCollectApps=!0}e.invokeMethodAndTrack("T42.ACS.SaveLayout",i,n,r)}))},t.prototype.restore=function(t){var e=this;return new Promise((function(n,r){if(e.verifyNotSlimMode(),void 0===t)throw Error("options argument is required");if(!t.name)throw Error("options.name argument is required");t.type||(t.type="Global"),t.activityIdToJoin&&(t.type="Activity"),void 0===t.restoreActivityOwner&&(t.restoreActivityOwner=!1),void 0===t.ignoreActivityWindowTypes&&(t.ignoreActivityWindowTypes=[]),void 0===t.setActivityContext&&(t.setActivityContext=!0),void 0===t.closeRunningInstance&&("Global"===t.type?t.closeRunningInstance=!0:"Activity"===t.type&&(t.closeRunningInstance=!1)),void 0===t.reuseWindows&&(t.reuseWindows=!0),t.context=t.context||{};var i={restoreOptions:{activityToJoin:t.activityIdToJoin,setActivityContext:t.setActivityContext,ignoreActivityWindowTypes:t.ignoreActivityWindowTypes,restoreActivityOwner:t.restoreActivityOwner,closeOldWindows:t.closeRunningInstance,reuseExistingWindows:t.reuseWindows}},o={type:t.type,name:t.name,context:t.context,toClose:[],splash:t.splash};2===e.config.gdMajorVersion&&t.closeRunningInstance&&(o.toClose=e.getInstancesToClose(t)),t.timeout&&(o.timeout=t.timeout),o.context._t42=i,e.invokeMethodAndTrack("T42.ACS.RestoreLayout",o,n,r,!0)}))},t.prototype.remove=function(t,e){var n=this;return new Promise((function(r,i){if(n.verifyNotSlimMode(),!e)throw Error("name argument is required");if(!t)throw Error("type argument is required");var o={type:t,name:e};n.invokeMethodAndTrack("T42.ACS.RemoveLayout",o,r,i)}))},t.prototype.list=function(){return this.verifyNotSlimMode(),Fn.all},t.prototype.import=function(t,e){var n=this;return new Promise((function(r,i){n.verifyNotSlimMode();var o={mode:e||"replace",layouts:t};n.invokeMethodAndTrack("T42.ACS.ImportLayouts",o,r,i,!0)}))},t.prototype.export=function(){var t=this;return new Promise((function(e,n){t.invokeMethodAndTrack("T42.ACS.ExportLayouts",{},(function(n){var r=t.getObjectValues(n.Layouts).map((function(t){return new cr(ar(t))}));e(r)}),n,!0)}))},t.prototype.rename=function(t,e){var n=this;return new Promise((function(r,i){if(n.verifyNotSlimMode(),!t)throw Error("layout argument is required");if(!t.name)throw Error("name argument is required");if(!t.type)throw Error("type argument is required");var o={type:t.type,oldName:t.name,newName:e};n.invokeMethodAndTrack("T42.ACS.RenameLayout",o,r,i)}))},t.prototype.updateMetadata=function(t){var e=this;return new Promise((function(n,r){if(!t)throw Error("layout argument is required");if(!t.name)throw Error("name argument is required");if(!t.type)throw Error("type argument is required");if(!t.metadata)throw Error("metadata argument is required");var i={name:t.name,type:t.type,metadata:t.metadata};e.invokeMethodAndTrack("T42.ACS.UpdateMetadata",i,n,r,!0)}))},t.prototype.hibernate=function(t,e){var n=this;return new Promise((function(r,i){if(!t)return i("name cannot be empty");var o={name:t,type:"Global",context:(e=e||{}).context||{},metadata:e.metadata||{}};n.invokeMethodAndTrack("T42.ACS.HibernateLayout",o,r,i,!0)}))},t.prototype.resume=function(t,e,n){var r=this;return new Promise((function(i,o){if(!t)return o("name cannot be empty");var s=f({name:t,type:"Global",context:e},n);r.invokeMethodAndTrack("T42.ACS.ResumeLayout",s,i,o,!0)}))},t.prototype.getCurrentLayout=function(){return l(this,void 0,void 0,(function(){var t,e;return v(this,(function(n){switch(n.label){case 0:return[4,this.config.agm.invoke("T42.ACS.GetCurrentLayout",{},"best",{methodResponseTimeoutMs:12e4})];case 1:return t=n.sent(),(e=t.returned.layout)?(this.isSlimMode()||(e=this.list().find((function(t){return t.name===e.name&&t.type===e.type}))),[2,e]):[2,void 0]}}))}))},t.prototype.onAdded=function(t){var e=this.callbacks.add("added",t);return Fn.all.length>0&&Fn.all.forEach((function(e){try{t(e)}catch(t){}})),e},t.prototype.onRemoved=function(t){return this.callbacks.add("removed",t)},t.prototype.onChanged=function(t){return this.callbacks.add("changed",t)},t.prototype.onRestored=function(t){return this.callbacks.add("restored",t)},t.prototype.onRenamed=function(t){return this.callbacks.add("renamed",t)},t.prototype.onEvent=function(t){return this.stream.onEvent(t)},t.prototype.onSaveRequested=function(t){return this.provider.onSaveRequested(t)},t.prototype.updateAppContextInCurrent=function(t){var e=this;return new Promise((function(n,r){t&&"object"!=typeof t&&r("context must be an object");var i={context:t=null!=t?t:{}};e.invokeMethodAndTrack("T42.ACS.UpdateLayoutComponentContext",i,n,r,!0)}))},t.prototype.updateDefaultContext=function(t){var e=this;return new Promise((function(n,r){t&&"object"!=typeof t&&r("context must be an object");var i={context:t=null!=t?t:{}};e.invokeMethodAndTrack("T42.ACS.UpdateDefaultContext",i,n,r,!0)}))},t.prototype.isSlimMode=function(){return"slim"===this.config.mode},t.prototype.verifyNotSlimMode=function(){if(this.isSlimMode())throw Error("Operation not allowed in slim mode. Run in full mode.")},t.prototype.isVisibleWindow=function(t){return"exe"===t.application.type||"node"===t.application.type||("activity"===t.application.type||!(!t||!t.window)&&t.window.isVisible)},t.prototype.invokeMethodAndTrack=function(t,e,n,r,i){var o,s=i,a=or();e.token=a;var c=function(){s&&o&&n(o)};i||this.stream.waitFor(a).then((function(){s=!0,c()})).catch((function(t){r(t)}));this.config.agm.invoke(t,e,"best",{methodResponseTimeoutMs:12e4}).then((function(e){e.returned||r("No result from method "+t),e.returned.status&&"Success"!==e.returned.status&&"PartialSuccess"!==e.returned.status&&r(e.returned),o=e.returned,c()})).catch((function(t){return r(t)}))},t.prototype.getInstancesToClose=function(t){var e=this,n=[],r=this.appManager.applications().filter((function(t){return t.isShell}))[0],i=r?r.name:"AppManager";return this.appManager.instances().forEach((function(r){e.appManager.myInstance&&r.id===e.appManager.myInstance.id||r.application.name!==i&&e.isVisibleWindow(r)&&("Activity"===t.type&&r.activityId!==t.activityIdToJoin||n.push({application:r.application.name,instance:r.id}))})),n},t.prototype.getObjectValues=function(t){return t?Object.keys(t).map((function(e){return t[e]})):[]},t}(),dr=function(){function t(t,e){var n=this;this.agm=t,this.callbacks=e,this.ready=new Promise((function(t,e){n.resolveReady=t,n.rejectReady=e})),this.gotSnapshot=new Promise((function(t,e){n.resolveGotSnapshot=t,n.rejectGotSnapshot=e}))}return t.prototype.subscribe=function(t){var e=this,n=function(t){return e.getObjectValues(t).map((function(t){return ar(t)}))};this.checkForLayoutEventMethod()?this.agm.subscribe("T42.ACS.OnLayoutEvent",{waitTimeoutMs:1e4}).then((function(t){t.onData((function(t){var r=t.data;r.IsSnapshot&&e.resolveGotSnapshot(),e.addLayouts(n(r.OnLayoutAdded)),e.removeLayouts(n(r.OnLayoutRemoved)),e.changeLayouts(n(r.OnLayoutChanged)),e.renameLayouts(n(r.OnLayoutRenamed)),e.restoredLayout(n(r.OnLayoutRestored)),e.callbacks.execute("streamEvent",r)})),t.onFailed((function(t){var n="can not subscribe to T42.ACS.OnLayoutEvent "+t;e.rejectReady(n),e.rejectGotSnapshot(n)})),e.resolveReady()})).catch((function(t){var n="Error subscribing for T42.ACS.OnLayoutEvent stream. Err: "+t;e.rejectReady(n),e.rejectGotSnapshot(n)})):(t&&this.resolveReady(),setTimeout((function(){e.subscribe(!0)}),500))},t.prototype.onEvent=function(t){return this.callbacks.add("streamEvent",t)},t.prototype.waitFor=function(t,e){var n=this;return e||(e=1e4),new Promise((function(r,i){var o=!1,s=n.onEvent((function(e){e.Token===t&&(o=!0,s(),r())}));setTimeout((function(){o||i("timed out")}),e)}))},t.prototype.checkForLayoutEventMethod=function(){try{return-1!==this.agm.methods().map((function(t){return t.name})).indexOf("T42.ACS.OnLayoutEvent")}catch(t){return!1}},t.prototype.addLayouts=function(t){var e=this;t&&t.forEach((function(t){var n=new cr(t);Fn.add(n),e.callbacks.execute("added",n)}))},t.prototype.removeLayouts=function(t){var e=this;t&&t.forEach((function(t){Fn.removeWhere((function(n){return!e.compareLayouts(n,t)})),e.callbacks.execute("removed",t)}))},t.prototype.changeLayouts=function(t){var e=this;t&&t.forEach((function(t){Fn.removeWhere((function(n){return!e.compareLayouts(n,t)})),Fn.add(new cr(t)),e.callbacks.execute("changed",t)}))},t.prototype.renameLayouts=function(t){var e=this;t&&t.forEach((function(t){var n=Fn.first((function(n){return e.compareLayouts(n,{type:t.type,name:t.oldName})}));if(!n)throw Error("received rename event for unknown layout with type "+t.type+" and name "+t.oldName);n.name=t.newName,e.callbacks.execute("renamed",n)}))},t.prototype.compareLayouts=function(t,e){return t.name===e.name&&t.type===e.type},t.prototype.getObjectValues=function(t){return t?Object.keys(t).map((function(e){return t[e]})):[]},t.prototype.restoredLayout=function(t){var e=this;t&&t.forEach((function(t){var n=Fn.first((function(n){return e.compareLayouts(n,{type:t.type,name:t.name})}));e.callbacks.execute("restored",n)}))},t}();function pr(t){if(!t.agm)throw Error("config.agm is required");if(!t.logger)throw Error("config.logger is required");t.mode=t.mode||"slim";var e,n=t.logger,r=_n();return t.mode,e=new dr(t.agm,r),new ur(t,e,r,n)}var hr,fr,lr,vr=function(t,e){var n=this;this._agm=t,this._logger=e,this.all=function(){return l(n,void 0,void 0,(function(){return v(this,(function(t){switch(t.label){case 0:return[4,this.callGD(hr.GetAll,{})];case 1:return[2,t.sent().map(this.decorateDisplay)]}}))}))},this.get=function(t){return l(n,void 0,void 0,(function(){var e;return v(this,(function(n){switch(n.label){case 0:return[4,this.callGD(hr.Get,{id:t})];case 1:return e=n.sent(),[2,this.decorateDisplay(e)]}}))}))},this.getPrimary=function(){return l(n,void 0,void 0,(function(){return v(this,(function(t){switch(t.label){case 0:return[4,this.all()];case 1:return[2,t.sent().find((function(t){return t.isPrimary}))]}}))}))},this.capture=function(t){return l(n,void 0,void 0,(function(){return v(this,(function(e){switch(e.label){case 0:return[4,this.callGD(hr.Capture,f({},t))];case 1:return[2,e.sent()]}}))}))},this.captureAll=function(t){return l(n,void 0,void 0,(function(){return v(this,(function(e){switch(e.label){case 0:return[4,this.callGD(hr.CaptureAll,f({},t))];case 1:return[2,e.sent()]}}))}))},this.getMousePosition=function(){return l(n,void 0,void 0,(function(){return v(this,(function(t){switch(t.label){case 0:return[4,this.callGD(hr.GetMousePosition)];case 1:return[2,t.sent()]}}))}))},this.callGD=function(t,e){return l(n,void 0,void 0,(function(){return v(this,(function(n){switch(n.label){case 0:return[4,this._agm.invoke("T42.Displays.Command",{options:f({},e),command:t})];case 1:return[2,n.sent().returned.data]}}))}))},this.decorateDisplay=function(t){return f(f({},t),{capture:function(e){return n.capture({id:t.id,size:e})}})}};function yr(t,e){return l(this,void 0,void 0,(function(){return v(this,(function(n){return fr.invoke("T42.Channels.Announce",{swId:null!=e?e:lr,command:"switchChannel",data:{newChannel:t}}),[2]}))}))}!function(t){t.Capture="capture",t.CaptureAll="captureAll",t.GetAll="getAll",t.Get="get",t.GetMousePosition="getMousePosition"}(hr||(hr={}));var gr="___channel___",mr=function(){function t(t){this.contexts=t}return t.prototype.subscribe=function(t){this.callback=t},t.prototype.subscribeFor=function(t,e){if(!this.isChannel(t))return Promise.reject(new Error("Channel with name: "+t+" doesn't exist!"));var n=this.createContextName(t);return this.contexts.subscribe(n,(function(t,n,r,i,o){var s;e(t.data,t,null===(s=o)||void 0===s?void 0:s.updaterId)}))},t.prototype.switchChannel=function(t){return l(this,void 0,void 0,(function(){var e,n,r=this;return v(this,(function(i){switch(i.label){case 0:return this.unsubscribe(),e=this.createContextName(t),n=this,[4,this.contexts.subscribe(e,(function(t,e,n,i,o){var s;r.callback&&r.callback(t.data,t,null===(s=o)||void 0===s?void 0:s.updaterId)}))];case 1:return n.unsubscribeFunc=i.sent(),[2]}}))}))},t.prototype.unsubscribe=function(){this.unsubscribeFunc&&this.unsubscribeFunc()},t.prototype.all=function(){return this.contexts.all().filter((function(t){return t.startsWith(gr)})).map((function(t){return t.substr(gr.length)}))},t.prototype.getContextData=function(t){var e=this;return new Promise((function(n,r){if(!e.isChannel(t))return r(new Error("A channel with name: "+t+" doesn't exist!"));var i=e.createContextName(t);e.contexts.subscribe(i,(function(t){n(t)})).then((function(t){return t()}))}))},t.prototype.updateChannel=function(t,e){var n=this.createContextName(t);return this.contexts.update(n,e)},t.prototype.updateData=function(t,e){var n=this.createContextName(t);if(this.contexts.setPathSupported){var r=Object.keys(e).map((function(t){return{path:"data."+t,value:e[t]}}));return this.contexts.setPaths(n,r)}return this.contexts.update(n,{data:e})},t.prototype.isChannel=function(t){return this.all().some((function(e){return e===t}))},t.prototype.createContextName=function(t){return gr+t},t}(),wr=function(){function t(t){this.shared=t,this.subsKey="subs",this.changedKey="changed",this.registry=_n(),this.shared.subscribe(this.handler.bind(this))}return t.prototype.subscribe=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.subsKey,t)},t.prototype.subscribeFor=function(t,e){return l(this,void 0,void 0,(function(){return v(this,(function(n){switch(n.label){case 0:if("string"!=typeof t)throw new Error("Please provide the name as a string!");if("function"!=typeof e)throw new Error("Please provide the callback as a function!");return[4,this.shared.subscribeFor(t,e)];case 1:return[2,n.sent()]}}))}))},t.prototype.publish=function(t,e){return l(this,void 0,void 0,(function(){return v(this,(function(n){if("object"!=typeof t)throw new Error("Please provide the data as an object!");if(e){if("string"!=typeof e)throw new Error("Please provide the name as a string!");return this.shared.isChannel(e)?[2,this.shared.updateData(e,t)]:[2,Promise.reject(new Error("A channel with name: "+e+" doesn't exist!"))]}if(!this.currentContext)throw new Error("Not joined to any channel!");return[2,this.shared.updateData(this.currentContext,t)]}))}))},t.prototype.all=function(){var t=this.shared.all();return Promise.resolve(t)},t.prototype.list=function(){return l(this,void 0,void 0,(function(){var t,e=this;return v(this,(function(n){switch(n.label){case 0:return[4,this.all()];case 1:return t=n.sent(),[4,Promise.all(t.map((function(t){return e.get(t)})))];case 2:return[2,n.sent()]}}))}))},t.prototype.get=function(t){return"string"!=typeof t?Promise.reject(new Error("Please provide the channel name as a string!")):this.shared.getContextData(t)},t.prototype.join=function(t){return l(this,void 0,void 0,(function(){return v(this,(function(e){return[2,this.joinCore(t)]}))}))},t.prototype.joinNoSelectorSwitch=function(t){return l(this,void 0,void 0,(function(){return v(this,(function(e){return[2,this.joinCore(t,!1)]}))}))},t.prototype.leave=function(){return this.leaveCore()},t.prototype.leaveNoSelectorSwitch=function(){return this.leaveCore(!1)},t.prototype.current=function(){return this.currentContext},t.prototype.my=function(){return this.current()},t.prototype.changed=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.changedKey,t)},t.prototype.onChanged=function(t){return this.changed(t)},t.prototype.add=function(t){return l(this,void 0,void 0,(function(){var e;return v(this,(function(n){switch(n.label){case 0:if("object"!=typeof t)throw new Error("Please provide the info as an object!");if(void 0===t.name)throw new Error("info.name is missing!");if("string"!=typeof t.name)throw new Error("Please provide the info.name as a string!");if(void 0===t.meta)throw new Error("info.meta is missing!");if("object"!=typeof t.meta)throw new Error("Please provide the info.meta as an object!");if(void 0===t.meta.color)throw new Error("info.meta.color is missing!");if("string"!=typeof t.meta.color)throw new Error("Please provide the info.meta.color as a string!");return e={name:t.name,meta:t.meta||{},data:t.data||{}},[4,this.shared.updateChannel(t.name,e)];case 1:return n.sent(),[2,e]}}))}))},t.prototype.handler=function(t,e,n){this.registry.execute(this.subsKey,t,e,n)},t.prototype.joinCore=function(t,e){return void 0===e&&(e=!0),l(this,void 0,void 0,(function(){var n,r=this;return v(this,(function(i){switch(i.label){case 0:if("string"!=typeof t)throw new Error("Please provide the channel name as a string!");return t===this.currentContext?[2]:(n=function(t){return r.shared.all().includes(t)})(t)?[3,2]:[4,new Promise((function(e,r){var i,o=setInterval((function(){n(t)&&(clearTimeout(i),clearInterval(o),e())}),100);i=setTimeout((function(){return clearInterval(o),r(new Error("A channel with name: "+t+" doesn't exist!"))}),3e3)}))];case 1:i.sent(),i.label=2;case 2:return this.currentContext=t,[4,this.shared.switchChannel(t)];case 3:return i.sent(),e&&yr(t),this.registry.execute(this.changedKey,t),[2]}}))}))},t.prototype.leaveCore=function(t){return void 0===t&&(t=!0),this.currentContext=void 0,this.registry.execute(this.changedKey,void 0),this.shared.unsubscribe(),t&&yr(),Promise.resolve()},t}();function br(t,e){var n=new mr(t),r=new wr(n);return function(t,e){l(this,void 0,void 0,(function(){return v(this,(function(n){switch(n.label){case 0:return fr=t,"undefined"!=typeof window&&window.glue42gd&&(lr=window.glue42gd.windowId),lr?[4,fr.register("T42.Channels.Command",(function(t){var n=t.command;if(!n)throw new Error("missing command argument");if("join"!==n){if("leave"!==n){if("get"===n)return{id:r=e.current()};throw new Error("unknown command "+n)}e.leaveNoSelectorSwitch()}else{var r;if(!(r=t.channel))throw new Error("missing argument id");e.joinNoSelectorSwitch(r)}}))]:[2];case 1:return n.sent(),fr.invoke("T42.Channels.Announce",{swId:lr,instance:fr.instance.instance}),[2]}}))}))}(e,r),{subscribe:r.subscribe.bind(r),subscribeFor:r.subscribeFor.bind(r),publish:r.publish.bind(r),all:r.all.bind(r),list:r.list.bind(r),get:r.get.bind(r),join:r.join.bind(r),leave:r.leave.bind(r),current:r.current.bind(r),my:r.my.bind(r),changed:r.changed.bind(r),onChanged:r.onChanged.bind(r),add:r.add.bind(r),ready:function(){return t.ready()}}}var _r="T42.Hotkeys.Command",Ir=function(){function t(t){this.agm=t,this.registry=_n(),this.firstHotkey=!0,this.hotkeys=new Map}return t.prototype.register=function(t,e){return l(this,void 0,void 0,(function(){var n;return v(this,(function(r){switch(r.label){case 0:if(void 0===t)throw new Error("Hotkey parameter missing");if("string"==typeof t)t={hotkey:t};else{if(!t.hotkey)throw new Error("Info's hotkey parameter missing");t={hotkey:t.hotkey,description:t.description}}if(n=this.formatHotkey(t.hotkey),this.hotkeys.has(n))throw new Error("Shortcut for "+n+" already registered");return this.firstHotkey?(this.firstHotkey=!1,[4,this.registerInvokeAGMMethod()]):[3,2];case 1:r.sent(),r.label=2;case 2:return this.registry.add(n,e),[4,this.agm.invoke(_r,{command:"register",hotkey:n,description:t.description})];case 3:return r.sent(),this.hotkeys.set(n,t),[2]}}))}))},t.prototype.unregister=function(t){return l(this,void 0,void 0,(function(){var e;return v(this,(function(n){switch(n.label){case 0:if(void 0===t)throw new Error("hotkey parameter missing");if("string"!=typeof t)throw new Error("hotkey parameter must be string");return e=this.formatHotkey(t),[4,this.agm.invoke(_r,{command:"unregister",hotkey:e})];case 1:return n.sent(),this.hotkeys.delete(e),this.registry.clearKey(e),[2]}}))}))},t.prototype.unregisterAll=function(){return l(this,void 0,void 0,(function(){return v(this,(function(t){switch(t.label){case 0:return[4,this.agm.invoke(_r,{command:"unregisterAll"})];case 1:return t.sent(),this.hotkeys.clear(),this.registry.clear(),[2]}}))}))},t.prototype.isRegistered=function(t){var e=this.formatHotkey(t);return this.hotkeys.has(e)},t.prototype.registerInvokeAGMMethod=function(){var t=this;this.agm.register("T42.Hotkeys.Invoke",(function(e){var n=e.key.toLowerCase(),r=t.hotkeys.get(n);t.registry.execute(n,r)}))},t.prototype.formatHotkey=function(t){if(t)return t.replace(/\s/g,"").toLowerCase()},t}();var Sr="5.2.4",xr=function(t){function e(t,e,n){if("boolean"!=typeof t||t){var r=function t(e,n,r){if("object"==typeof e)return t(e.mode,n,r)+"";if(void 0===e)return"boolean"!=typeof n||n?n+"":void 0;if("boolean"==typeof e)return e?(void 0===r?n:r)+"":void 0;return e+""}(t,e,n);return"object"==typeof t?(t.mode=r,t):{mode:r}}}return{layouts:e(t.layouts,"slim"),activities:e(t.activities,"trackMyTypeAndInitiatedFromMe"),appManager:e(t.appManager,!1,"startOnly"),windows:e(t.windows,!0),channels:e(t.channels||!1,!1),displays:e(t.displays,!0)}},kr=function(){function t(t){this.options=t,this.callbacks=_n(),this.actions=t.actions,this.body=t.body,this.badge=t.badge,this.data=t.data,this.dir=t.dir,this.icon=t.icon,this.image=t.image,this.lang=t.lang,this.renotify=t.renotify,this.requireInteraction=t.requireInteraction,this.silent=t.silent,this.tag=t.tag,this.timestamp=t.timestamp,this.title=t.title}return t.prototype.close=function(){throw new Error("Method not implemented.")},t.prototype.addEventListener=function(t,e,n){this.callbacks.add(t,e)},t.prototype.removeEventListener=function(t,e,n){},t.prototype.dispatchEvent=function(t){return this.callbacks.execute(t.type,t),!0},t}(),Cr=function(){function t(t){this.interop=t,this.methodsRegistered=!1,this.methodNameRoot="T42.Notifications.Handler-"+or(),this.nextId=0,this.notifications={}}return Object.defineProperty(t.prototype,"maxActions",{get:function(){return 2},enumerable:!0,configurable:!0}),t.prototype.raise=function(t){var e,n;return l(this,void 0,void 0,(function(){var r,i,o,s,a,c,u,d,p,h,f;return v(this,(function(l){switch(l.label){case 0:if(!t)throw new Error("invalid options - should be an object");if(!t.title)throw new Error("invalid options - should have title");if(this.methodsRegistered)return[3,2];for(r=[],a=0;a<this.maxActions;a++)r.push(this.interop.register(this.methodNameRoot+"_"+a,this.handleNotificationAction.bind(this)));return[4,Promise.all(r)];case 1:l.sent(),this.methodsRegistered=!0,l.label=2;case 2:if(i=String(this.nextId++),o={title:t.title,severity:"Medium",description:t.body,glueRoutingDetailMethodName:this.methodNameRoot+"_0",actions:[],source:i},t.actions)for(s=t.actions.slice(0,this.maxActions),a=0,c=function(t){var r={g42notificationId:i,g42action:t.action,g42interopMethod:null===(e=t.interop)||void 0===e?void 0:e.method,g42interopTarget:null===(n=t.interop)||void 0===n?void 0:n.target},s=Object.keys(r).map((function(t){return{name:t,value:{stringValue:r[t]}}})),c={name:u.methodNameRoot+"_"+a,description:t.title,displayName:t.title,parameters:s};o.actions.push(c),a++},u=this,d=0,p=s;d<p.length;d++)h=p[d],c(h);return[4,this.interop.invoke("T42.GNS.Publish.RaiseNotification",{notification:o})];case 3:return l.sent(),f=new kr(t),this.notifications[i]=f,[2,f]}}))}))},t.prototype.handleNotificationAction=function(t){if(t.g42notificationId){var e=t,n=e.g42notificationId;if(!(o=this.notifications[n]))return;var r=new Event("onaction");r.action=e.g42action,o.onaction&&o.onaction(r);var i=(o.actions||[]).find((function(t){return t.action===e.g42action})).interop;i&&this.interop.invoke(i.method,i.arguments||{},i.target||"best"),o.dispatchEvent(r)}else if(t.notification&&t.notification.source){var o;n=t.notification.source;if(!(o=this.notifications[n]))return;var s=new Event("onclick");o.onclick&&o.onclick(s);var a=o.options.clickInterop;a&&this.interop.invoke(a.method,a.arguments||{},a.target||"best"),o.dispatchEvent(s)}},t}(),Ar=function(){function t(t){this.core=t,this.registry=_n(),this.isSubscribed=!1,this.getConfiguration()}return t.prototype.list=function(){return l(this,void 0,void 0,(function(){return v(this,(function(t){switch(t.label){case 0:return[4,this.getConfiguration()];case 1:if(t.sent(),!this.getMethodName)throw new Error("not supported");return[4,this.getAll()];case 2:return[2,t.sent().returned.all]}}))}))},t.prototype.getCurrent=function(){return l(this,void 0,void 0,(function(){var t;return v(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:if(e.sent(),!this.getMethodName)throw new Error("not supported");return[4,this.getAll()];case 2:return[2,(t=e.sent()).returned.all.find((function(e){return e.name===t.returned.selected}))]}}))}))},t.prototype.select=function(t){return l(this,void 0,void 0,(function(){return v(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:if(e.sent(),!this.setMethodName)throw new Error("not supported");return[4,this.core.interop.invoke(this.setMethodName,{theme:t})];case 2:return e.sent(),[2]}}))}))},t.prototype.onChanged=function(t){return this.subscribe(),this.registry.add("changed",t)},t.prototype.getConfiguration=function(){return l(this,void 0,void 0,(function(){var t;return v(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),this.sharedContextName?[2]:[4,this.core.interop.invoke("T42.Themes.Configuration")];case 1:return t=e.sent(),this.sharedContextName=t.returned.sharedContextName,this.getMethodName=t.returned.getThemesMethodName,this.setMethodName=t.returned.setThemesMethodName,[3,3];case 2:return e.sent(),[2];case 3:return[2]}}))}))},t.prototype.getAll=function(){return l(this,void 0,void 0,(function(){return v(this,(function(t){switch(t.label){case 0:return[4,this.getConfiguration()];case 1:return t.sent(),[4,this.core.interop.invoke(this.getMethodName)];case 2:return[2,t.sent()]}}))}))},t.prototype.subscribe=function(){return l(this,void 0,void 0,(function(){var t=this;return v(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:return e.sent(),this.isSubscribed?[2]:(this.isSubscribed=!0,this.core.contexts.subscribe(this.sharedContextName,(function(e){e&&e.all&&e.selected&&t.registry.execute("changed",e.all.find((function(t){return t.name===e.selected})))})),[2])}}))}))},t}();var Tr="Tick42.FDC3.Intents.",Pr=function(){function t(t,e,n){this.interop=t,this.windows=e,this.logger=n}return t.prototype.find=function(t){return l(this,void 0,void 0,(function(){var e,n;return v(this,(function(r){switch(r.label){case 0:return[4,this.all()];case 1:if(e=r.sent(),void 0===t)return[2,e];if("string"==typeof t)return[2,e.filter((function(e){return e.name===t}))];if("object"!=typeof t)throw new Error("Please provide the intentFilter as a string or an object!");return t.contextType&&(n=t.contextType.toLowerCase(),e=e.filter((function(t){return t.handlers.some((function(t){var e;return null===(e=t.contextTypes)||void 0===e?void 0:e.some((function(t){return t.toLowerCase()===n}))}))}))),t.name&&(e=e.filter((function(e){return e.name===t.name}))),[2,e]}}))}))},t.prototype.raise=function(t){return l(this,void 0,void 0,(function(){var e,n,r,i,o,s,a,c,u;return v(this,(function(d){switch(d.label){case 0:if("string"!=typeof t&&"object"!=typeof t||"object"==typeof t&&"string"!=typeof t.intent)throw new Error("Please provide the intent as a string or an object with an intent property!");return"string"==typeof t&&(t={intent:t}),e=t.intent,[4,this.get(e)];case 1:if(void 0===(n=d.sent()))throw new Error("Intent "+e+" not found.");if(r=!n.handlers.some((function(t){return"app"===t.type})),i=t.target||(r?"reuse":"startNew"),s=n.handlers.find((function(t){return"app"===t.type})),"startNew"===i)o=s;else if("reuse"===i)a=n.handlers.find((function(t){return"instance"===t.type})),o=a||s;else if(i.instance)o=n.handlers.find((function(t){return"instance"===t.type&&t.instanceId===i.instance}));else{if(!i.app)throw new Error("Invalid intent target: "+JSON.stringify(i));o=n.handlers.find((function(t){return"app"===t.type&&t.applicationName===i.app}))}if(!o)throw new Error("Can not raise intent for request "+JSON.stringify(t)+" - can not find intent handler.");return c=o.instanceId,"app"!==o.type?[3,3]:[4,this.startApp(o.applicationName,t.options)];case 2:c=d.sent(),d.label=3;case 3:return[4,this.raiseIntentToInstance(c,e,t.context)];case 4:return(u=d.sent()).request=t,u.handler=o,[2,u]}}))}))},t.prototype.all=function(){return l(this,void 0,void 0,(function(){var t,e,n,r,i,o,s,a,c,u,d,p,h,f,y,g,m,w=this;return v(this,(function(b){switch(b.label){case 0:return b.trys.push([0,6,,7]),[4,this.interop.invoke("T42.ACS.GetApplications",{withIntentsInfo:!0})];case 1:for(t=b.sent(),e=t.returned.applications,n={},r=e.filter((function(t){return t.intents&&t.intents.length>0})),i=0,o=r;i<o.length;i++)for(s=o[i],a=0,c=s.intents;a<c.length;a++)u=c[a],(d=n[u.name])||(d={name:u.name,handlers:[]},n[u.name]=d),p={applicationName:s.name,applicationTitle:s.title,applicationDescription:s.caption,displayName:u.displayName,contextTypes:u.contexts,applicationIcon:s.icon,type:"app"},d.handlers.push(p);h=function(t){return v(this,(function(r){switch(r.label){case 0:return[4,Promise.all(t.getMethods().filter((function(t){return t.name.startsWith(Tr)})).map((function(r){return l(w,void 0,void 0,(function(){var i,o,s,a,c,u,d,p,h,f,l,y,g,m,w,b,_,I;return v(this,(function(v){switch(v.label){case 0:if(i=r.name.replace(Tr,""),(o=n[i])||(o={name:i,handlers:[]},n[i]=o),r.description)try{s=JSON.parse(r.description)}catch(t){}return(a=e.find((function(e){return e.name===t.application})))&&a.intents&&(c=a.intents.find((function(t){return t.name===i}))),u=this.windows.findById(t.windowId),[4,null===(h=u)||void 0===h?void 0:h.getTitle()];case 1:return d=v.sent(),p={instanceId:t.instance,applicationName:t.application,applicationIcon:(null===(f=s)||void 0===f?void 0:f.icon)||(null===(l=a)||void 0===l?void 0:l.icon),applicationTitle:null===(y=a)||void 0===y?void 0:y.title,applicationDescription:(null===(g=s)||void 0===g?void 0:g.description)||(null===(m=a)||void 0===m?void 0:m.caption),displayName:(null===(w=s)||void 0===w?void 0:w.displayName)||(null===(b=c)||void 0===b?void 0:b.displayName),contextTypes:(null===(_=s)||void 0===_?void 0:_.contextTypes)||(null===(I=c)||void 0===I?void 0:I.contexts),instanceTitle:d,type:"instance"},o.handlers.push(p),[2]}}))}))})))];case 1:return r.sent(),[2]}}))},f=0,y=this.interop.servers(),b.label=2;case 2:return f<y.length?(g=y[f],[5,h(g)]):[3,5];case 3:b.sent(),b.label=4;case 4:return f++,[3,2];case 5:return[2,Object.values(n)];case 6:return m=b.sent(),this.logger.error("Failed to get the applications!",m),[2,[]];case 7:return[2]}}))}))},t.prototype.addIntentListener=function(t,e){var n=this;if("string"!=typeof t&&"object"!=typeof t||"object"==typeof t&&"string"!=typeof t.intent)throw new Error("Please provide the intent as a string or an object with an intent property!");if("function"!=typeof e)throw new Error("Please provide the handler as a function!");var r={unsubscribe:function(){return console.log("Could not unsubscribe!")}},i="Tick42.FDC3.Intents."+("string"==typeof t?t:t.intent),o="string"==typeof t?void 0:JSON.stringify(t);return this.interop.register({name:i,description:o},(function(t){return e(t)})).then((function(){r.unsubscribe=function(){n.interop.unregister(i)}})),r},t.prototype.get=function(t){return l(this,void 0,void 0,(function(){return v(this,(function(e){switch(e.label){case 0:return[4,this.all()];case 1:return[2,e.sent().find((function(e){return e.name===t}))]}}))}))},t.prototype.startApp=function(t,e){return l(this,void 0,void 0,(function(){return v(this,(function(n){switch(n.label){case 0:return[4,this.interop.invoke("T42.ACS.StartApplication",{Name:t,options:e})];case 1:return[2,n.sent().returned.Id]}}))}))},t.prototype.raiseIntentToInstance=function(t,e,n){return l(this,void 0,void 0,(function(){var r,i,o=this;return v(this,(function(s){switch(s.label){case 0:return r="Tick42.FDC3.Intents."+e,(i=this.interop.servers().find((function(e){return e.instance===t})))?[3,2]:[4,new Promise((function(e,n){var r,s=o.interop.serverAdded((function(n){n.instance===t&&(i=n,e(),clearTimeout(r),s())}));r=setTimeout((function(){s(),n(new Error("Can not find interop server for instance "+t))}),3e4)}))];case 1:s.sent(),s.label=2;case 2:return i.getMethods().find((function(t){return t.name===r}))?[3,4]:[4,new Promise((function(e,n){var i,s=o.interop.methodAdded((function(t){t.name===r&&(e(),clearTimeout(i),s())}));i=setTimeout((function(){s(),n(new Error("Can not find interop method "+r+" for instance "+t))}),1e4)}))];case 3:s.sent(),s.label=4;case 4:return[4,this.interop.invoke(r,n,{instance:t})];case 5:return[2,{result:s.sent().returned}]}}))}))},t}(),Mr=[],jr=function(t){return l(void 0,void 0,void 0,(function(){function e(t){if(y.windows){var e=p("windows",t.logger,y.windows);return h(w=Dn(t.agm,e,(function(){return g}),l)),w}}function n(t){if(y.activities&&yn.checkIsUsingGW3Implementation&&yn.checkIsUsingGW3Implementation(t.connection)){var e=p("activity",t.logger,y.activities);return h(m=new yn({connection:t.connection,contexts:t.contexts,agm:t.agm,logger:e,logLevel:"info",disableAutoAnnounce:!1,disposeRequestHandling:"exit",announcementInfo:null,windows:w,appManagerGetter:function(){return g},mode:y.activities.mode,typesToTrack:y.activities.typesToTrack,activityId:f.activityInfo&&f.activityInfo.activityId,gdMajorVersion:l}).api),m}}function r(t){if(y.appManager){var e=p("appManager",t.logger,y.appManager);return h(g=Pn({agm:t.agm,windows:w,logger:e,activities:m,mode:y.appManager.mode,gdMajorVersion:l})),g}}function i(t){var e;if(y.layouts){var n=p("layouts",t.logger,y.layouts),r=y.layouts,i=pr({agm:t.agm,appManager:g,activityGetter:function(){return m},logger:n,mode:r.mode,autoSaveWindowContext:(e=r.autoSaveWindowContext,null!=e&&e),gdMajorVersion:l});return h(i),i}}function o(t){if(y.channels&&t.contexts){var e=br(t.contexts,t.agm);return h(e),e}}function s(t){var e,n,r=(e=t.agm,{register:(n=new Ir(e)).register.bind(n),unregister:n.unregister.bind(n),unregisterAll:n.unregisterAll.bind(n),isRegistered:n.isRegistered.bind(n),ready:function(){return Promise.resolve()}});return h(r),r}function a(t){var e=new Pr(t.agm,w,t.logger.subLogger("intents"));return h(e),e}function c(t){var e=new Cr(t.interop);return h(e),e}function u(t){if(y.displays){var e=p("displays",t.logger,y.displays);return h(b=new vr(t.agm,e)),b}}function d(t){if(t.contexts){var e=function(t){var e=new Ar(t);return{list:e.list.bind(e),getCurrent:e.getCurrent.bind(e),select:e.select.bind(e),onChanged:e.onChanged.bind(e),ready:function(){return Promise.resolve()}}}(t);return h(e),e}}function p(t,e,n){var r=e.subLogger(t);if(n&&n.logger){var i=n.logger;i.console&&r.consoleLevel(i.console),i.publish&&r.publishLevel(i.publish)}return r}function h(t){I.push(t)}var f,l,y,g,m,w,b,_,I,S,x;return v(this,(function(p){switch(p.label){case 0:return(f="undefined"!=typeof window&&window.glue42gd)&&Mr.length>0?[2,Mr[0]]:(l=jn.getGDMajorVersion(),y=xr(t=t||{}),t.gateway=t.gateway||{},_={libs:[{name:"windows",create:e},{name:"activities",create:n},{name:"appManager",create:r},{name:"layouts",create:i},{name:"channels",create:o},{name:"hotkeys",create:s},{name:"displays",create:u},{name:"intents",create:a},{name:"notifications",create:c},{name:"themes",create:d}],version:Sr,enrichGlue:function(t){t.config.activities=y.activities,t.config.windows=y.windows,t.config.appManager=y.appManager,t.config.layouts=y.layouts,t.config.channels=y.channels,t.config.displays=y.displays}},I=[],"undefined"!=typeof window&&(window.glueFactoryLog||(window.glueFactoryLog=[]),window.glueFactoryLog.push(I)),[4,xe(t,_)]);case 1:return S=p.sent(),Mr.push(S),Array.isArray(null===(x=t)||void 0===x?void 0:x.libraries)&&t.libraries.length?[4,Promise.all(t.libraries.map((function(e){return e(S,t)})))]:[3,3];case 2:p.sent(),p.label=3;case 3:return[2,S]}}))}))};jr.coreVersion=xe.version,jr.version=Sr,jr.instances=Mr;var Er=jr,Or=!0;if("undefined"!=typeof window){var Rr=window.glue42gd;Rr&&Rr.autoInjected&&(Er=window.Glue,Or=!1),Or&&(window.Glue=Er),delete window.GlueCore}Er.default=Er;var Nr=Er,Lr=function(t,e){return(Lr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var Wr=function(){return(Wr=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function Dr(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{c(r.next(t))}catch(t){o(t)}}function a(t){try{c(r.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((r=r.apply(t,e||[])).next())}))}function Fr(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var Br="1.6.1";var qr=1;var Gr,Hr,Ur,Vr={nextValue:function(){return(qr=(9301*qr+49297)%233280)/233280},seed:function(t){qr=t}},Jr="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function zr(){Ur=!1}function Kr(t){if(t){if(t!==Gr){if(t.length!==Jr.length)throw new Error("Custom alphabet for shortid must be "+Jr.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+Jr.length+" unique characters. These characters were not unique: "+e.join(", "));Gr=t,zr()}}else Gr!==Jr&&(Gr=Jr,zr())}function Yr(){return Ur||(Ur=function(){Gr||Kr(Jr);for(var t,e=Gr.split(""),n=[],r=Vr.nextValue();e.length>0;)r=Vr.nextValue(),t=Math.floor(r*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var Zr={get:function(){return Gr||Jr},characters:function(t){return Kr(t),Gr},seed:function(t){Vr.seed(t),Hr!==t&&(zr(),Hr=t)},lookup:function(t){return Yr()[t]},shuffled:Yr},Xr="object"==typeof window&&(window.crypto||window.msCrypto),$r=Xr&&Xr.getRandomValues?function(t){return Xr.getRandomValues(new Uint8Array(t))}:function(t){for(var e=[],n=0;n<t;n++)e.push(Math.floor(256*Math.random()));return e},Qr=function(t,e,n){for(var r=(2<<Math.log(e.length-1)/Math.LN2)-1,i=-~(1.6*r*n/e.length),o="";;)for(var s=t(i),a=i;a--;)if((o+=e[s[a]&r]||"").length===+n)return o};var ti,ei,ni=function(t){for(var e,n=0,r="";!e;)r+=Qr($r,Zr.get(),1),e=t<Math.pow(16,n+1),n++;return r};var ri=function(t){var e="",n=Math.floor(.001*(Date.now()-1567752802062));return n===ei?ti++:(ti=0,ei=n),e+=ni(7),e+=ni(t),ti>0&&(e+=ni(ti)),e+=ni(n)};var ii=function(t){return!(!t||"string"!=typeof t||t.length<6)&&!new RegExp("[^"+Zr.get().replace(/[|\\{}()[\]^$+*?.-]/g,"\\$&")+"]").test(t)},oi=function(t,e,n){return t(n={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&n.path)}},n.exports),n.exports}((function(t){var e=0;function n(){return ri(e)}t.exports=n,t.exports.generate=n,t.exports.seed=function(e){return Zr.seed(e),t.exports},t.exports.worker=function(n){return e=n,t.exports},t.exports.characters=function(t){return void 0!==t&&Zr.characters(t),Zr.shuffled()},t.exports.isValid=ii})),si=function(){function t(t,e,n,r){this.id=t,this.name=e,this.control=n,this.windows=r}return t.prototype.getURL=function(){var t;return Dr(this,void 0,void 0,(function(){var e;return Fr(this,(function(n){switch(n.label){case 0:return[4,this.callControl("getURL",{})];case 1:return e=n.sent(),[2,null===(t=null==e?void 0:e.returned)||void 0===t?void 0:t._value]}}))}))},t.prototype.moveResize=function(t){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(e){switch(e.label){case 0:return[4,this.callControl("moveResize",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.close=function(){return Dr(this,void 0,void 0,(function(){var t=this;return Fr(this,(function(e){return[2,new Promise((function(e,n){var r=function(){o&&clearTimeout(o),i&&i()},i=t.windows.onWindowRemoved((function(n){n.id===t.id&&(e(t),r())})),o=setTimeout((function(){n("can not close window - probably not opened by your window"),r()}),5e3);t.callControl("close",{},!0).catch((function(){}))}))]}))}))},t.prototype.setTitle=function(t){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(e){switch(e.label){case 0:return"string"==typeof t&&(t={title:t}),[4,this.callControl("setTitle",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.resizeTo=function(t,e){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(n){switch(n.label){case 0:return[4,this.callControl("moveResize",{width:t,height:e},!0)];case 1:return n.sent(),[2,this]}}))}))},t.prototype.moveTo=function(t,e){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(n){switch(n.label){case 0:return[4,this.callControl("moveResize",{top:t,left:e},!0)];case 1:return n.sent(),[2,this]}}))}))},t.prototype.focus=function(){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(t){switch(t.label){case 0:return[4,this.callControl("focus",{},!0)];case 1:return t.sent(),[2,this]}}))}))},t.prototype.getBounds=function(){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(t){switch(t.label){case 0:return[4,this.callControl("getBounds",{})];case 1:return[2,t.sent().returned]}}))}))},t.prototype.getContext=function(){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(t){switch(t.label){case 0:return[4,this.callControl("getContext",{})];case 1:return[2,t.sent().returned]}}))}))},t.prototype.getTitle=function(){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(t){switch(t.label){case 0:return[4,this.callControl("getTitle",{})];case 1:return[2,t.sent().returned._value]}}))}))},t.prototype.onContextUpdated=function(t){throw new Error("Method not implemented.")},t.prototype.updateContext=function(t){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(e){switch(e.label){case 0:return[4,this.callControl("updateContext",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.setContext=function(t){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(e){switch(e.label){case 0:return[4,this.callControl("setContext",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.callControl=function(t,e,n){return void 0===n&&(n=!1),Dr(this,void 0,void 0,(function(){return Fr(this,(function(r){switch(r.label){case 0:return[4,this.control.send({command:t,domain:"windows",args:e,skipResult:n},{windowId:this.id})];case 1:return[2,r.sent()]}}))}))},t}();function ai(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function r(n,r){var i=n instanceof Error?n:new Error(n);if(e)e(i);else{var o='[ERROR] callback-registry: User callback for key "'+r+'" failed: '+i.stack;if(t)switch(t.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(t,e,i){var o=n[t];return o||(o=[],n[t]=o),o.push(e),i&&setTimeout((function(){i.forEach((function(i){var o;if(null===(o=n[t])||void 0===o?void 0:o.includes(e))try{Array.isArray(i)?e.apply(void 0,i):e.apply(void 0,[i])}catch(e){r(e,t)}}))}),0),function(){var r=n[t];r&&(r=r.reduce((function(t,n,r){return n===e&&t.length===r||t.push(n),t}),[]),n[t]=r)}},execute:function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var o=n[t];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var i=n.apply(void 0,e);s.push(i)}catch(e){s.push(void 0),r(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}ai.default=ai;var ci=ai,ui=function(){function t(){this.callbacks={},this.registry=ci()}return t.prototype.start=function(e,n){return Dr(this,void 0,void 0,(function(){var r=this;return Fr(this,(function(i){switch(i.label){case 0:return this.interop=e,this.logger=n,[4,this.interop.register(t.CONTROL_METHOD,(function(t){return Dr(r,void 0,void 0,(function(){var e,r,i;return Fr(this,(function(o){return e=t,n.trace("received control command "+JSON.stringify(e)),"windows"===e.domain?this.myWindow?(r=this.myWindow[e.command].call(this.myWindow,e.args),e.skipResult?[2,{}]:[2,r]):[2]:"appManager"===e.domain?this.myInstance?(r=this.myInstance[e.command].call(this.myInstance,e.args),e.skipResult?[2,{}]:[2,r]):[2]:("layouts"===e.domain&&(i=this.callbacks[e.domain])&&i(e),[2])}))}))}))];case 1:return i.sent(),this.registry.execute("started"),[2]}}))}))},t.prototype.send=function(e,n){if(!this.interop)throw new Error("Control not started");return this.logger.info("sending control command "+JSON.stringify(e)+" to "+JSON.stringify(n)+"}"),this.interop.invoke(t.CONTROL_METHOD,e,n)},t.prototype.subscribe=function(t,e){this.callbacks[t]=e},t.prototype.setLocalWindow=function(t){this.myWindow=t},t.prototype.setLocalInstance=function(t){this.myInstance=t},t.prototype.onStart=function(t){return this.registry.add("started",t)},t.CONTROL_METHOD="GC.Control",t}(),di=function(){function t(t,e,n,r,i){this.id=t,this.name=e,this.window=n,this.control=r,this.interop=i,this.context={},this.registry=ci(),r.setLocalWindow(this)}return t.prototype.getURL=function(){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(t){return[2,this.window.location.href]}))}))},t.prototype.moveResize=function(t){var e=t.left,n=t.top,r=t.width,i=t.height;return Dr(this,void 0,void 0,(function(){return Fr(this,(function(t){return e=null!=e?e:window.screenLeft,n=null!=n?n:window.screenTop,r=null!=r?r:window.outerWidth,i=null!=i?i:window.outerHeight,window.moveTo(e,n),window.resizeTo(r,i),[2,this]}))}))},t.prototype.close=function(){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(t){if(!this.parent)throw new Error("can not close window if it's not opened by script");try{window.close()}catch(t){console.log("what")}return[2,this]}))}))},t.prototype.setTitle=function(t){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(e){return"object"==typeof t&&null!==t&&(t=t.title),document.title=t,[2,this]}))}))},t.prototype.resizeTo=function(t,e){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(n){switch(n.label){case 0:return[4,this.moveResize({width:t,height:e})];case 1:return n.sent(),[2,this]}}))}))},t.prototype.moveTo=function(t,e){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(n){switch(n.label){case 0:return[4,this.moveResize({top:t,left:e})];case 1:return n.sent(),[2,this]}}))}))},t.prototype.focus=function(){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(t){return window.focus(),[2,this]}))}))},t.prototype.getBounds=function(){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(t){return[2,this.getBoundsSync()]}))}))},t.prototype.getContext=function(){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(t){return[2,this.getContextSync()]}))}))},t.prototype.getContextSync=function(){return this.context},t.prototype.getTitle=function(){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(t){return[2,this.window.document.title]}))}))},t.prototype.onContextUpdated=function(t){return this.registry.add("context-updated",t)},t.prototype.updateContext=function(t){var e=this.context;return this.context=Object.assign({},e,t),this.registry.execute("context-updated",this.context,e),Promise.resolve(this)},t.prototype.setContext=function(t){return Dr(this,void 0,void 0,(function(){var e;return Fr(this,(function(n){return e=this.context,this.context=Object.assign({},t),this.registry.execute("context-updated",t,e),[2,Promise.resolve(this)]}))}))},t.prototype.getBoundsSync=function(){return{left:this.window.screenLeft,top:this.window.screenTop,width:this.window.outerWidth,height:this.window.outerHeight}},t}(),pi=function(t){function e(e,n,r,i,o){var s=t.call(this,n,r,i,o)||this;return s.window=e,s.id=n,s.name=r,s}return function(t,e){function n(){this.constructor=t}Lr(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}(e,t),e}(si),hi=function(t){return'"GC.Wnd."'+t},fi=function(t,e,n){return Dr(void 0,void 0,void 0,(function(){var r,i;return Fr(this,(function(o){switch(o.label){case 0:return r=hi(t.id),e.methods().find((function(t){return t.name===r}))?[4,e.invoke(r)]:[3,2];case 1:i=o.sent(),t&&(t.setContext(i.returned.context),t.name=i.returned.name,t.parent=i.returned.parent,n&&(n.startedByScript=!0,n.context=i.returned.context)),o.label=2;case 2:return[2]}}))}))},li=function(){function t(t,e){this.interop=t,this.control=e,this.registry=ci(),this.childWindows=[];var n=t.instance.windowId,r="document.title ("+oi()+")";this.myWindow=new di(n,r,window,this.control,this.interop),this.trackWindowsLifetime()}return t.prototype.list=function(){var t=this,e=this.interop.methods({name:ui.CONTROL_METHOD})[0];return e?(e.getServers?e.getServers():[]).reduce((function(e,n){var r=t.remoteFromServer(n);return r&&e.push(r),e}),[]):[]},t.prototype.findById=function(t){return this.list().find((function(e){return e.id===t}))},t.prototype.my=function(){return this.myWindow},t.prototype.open=function(t,e,n){var r,i,o,s,a;return Dr(this,void 0,void 0,(function(){var c,u,d,p,h,f,l,v,y,g,m,w,b;return Fr(this,(function(_){switch(_.label){case 0:return c=null!==(r=null==n?void 0:n.width)&&void 0!==r?r:400,u=null!==(i=null==n?void 0:n.height)&&void 0!==i?i:400,d=null!==(o=null==n?void 0:n.left)&&void 0!==o?o:window.screen.availWidth-window.screenLeft,p=null!==(s=null==n?void 0:n.top)&&void 0!==s?s:0,h=oi(),function(t,e,n,r,i){var o,s=hi(n),a={context:null!==(o=null==i?void 0:i.context)&&void 0!==o?o:{},name:r,parent:e};t.register(s,(function(){return a}))}(this.interop,this.my().id,h,t,n),(null==n?void 0:n.relativeTo)?(f=n.relativeTo,(l=this.list().find((function(t){return t.id===f})))?[4,l.getBounds()]:[3,2]):[3,2];case 1:v=_.sent(),y=null!==(a=n.relativeDirection)&&void 0!==a?a:"right",g=this.getRelativeBounds({width:c,height:u,left:d,top:p},v,y),c=g.width,u=g.height,d=g.left,p=g.top,_.label=2;case 2:if(m="width="+c+",height="+u+",left="+d+",top="+p+",scrollbars=none,location=no,status=no,menubar=no",!(w=window.open(e,h,m)))throw new Error("failed to open a window with url="+e+" and options="+m);return w.focus(),w.moveTo(d,p),w.resizeTo(c,u),b=new pi(w,h,t,this.control,this),this.childWindows.push(b),[2,b]}}))}))},t.prototype.onWindowAdded=function(t){return this.registry.add("window-added",t)},t.prototype.onWindowRemoved=function(t){return this.registry.add("window-removed",t)},t.prototype.getChildWindows=function(){return this.childWindows=this.childWindows.filter((function(t){return!t.window.closed})),this.childWindows},t.prototype.remoteFromServer=function(t){var e;if(t.windowId)return new si(t.windowId,null!==(e=t.application)&&void 0!==e?e:"",this.control,this)},t.prototype.getRelativeBounds=function(t,e,n){switch(n){case"bottom":return{left:e.left,top:e.top+e.height+0,width:e.width,height:t.height};case"top":return{left:e.left,top:e.top-t.height-0,width:e.width,height:t.height};case"right":return{left:e.left+e.width+0,top:e.top,width:t.width,height:e.height};case"left":return{left:e.left-t.width-0,top:e.top,width:t.width,height:e.height}}throw new Error("invalid relativeDirection")},t.prototype.trackWindowsLifetime=function(){var t=this;this.interop.serverMethodAdded((function(e){var n=e.server;if(e.method.name===ui.CONTROL_METHOD){var r=t.remoteFromServer(n);r&&t.registry.execute("window-added",r)}})),this.interop.serverRemoved((function(e){var n=t.remoteFromServer(e);n&&t.registry.execute("window-removed",n)}))},t}(),vi=function(t){return{ok:!0,result:t}},yi=function(t){return{ok:!1,error:t}},gi=function(t){return!0===t.ok?Promise.resolve(t.result):Promise.reject(t.error)},mi=function(t,e){return!0===e.ok?e.result:t},wi=function(t){if(!0===t.ok)return t.result;throw t.error},bi=function(t,e){return!0===e.ok?vi(t(e.result)):e},_i=function(t,e,n){return!1===e.ok?e:!1===n.ok?n:vi(t(e.result,n.result))},Ii=function(t,e){return!0===e.ok?e:yi(t(e.error))},Si=function(t,e){return!0===e.ok?t(e.result):e},xi=(Object.freeze({ok:vi,isOk:function(t){return!0===t.ok},err:yi,isErr:function(t){return!1===t.ok},asPromise:gi,withDefault:mi,withException:wi,successes:function(t){return t.reduce((function(t,e){return!0===e.ok?t.concat(e.result):t}),[])},map:bi,map2:_i,mapError:Ii,andThen:Si}),function(){return(xi=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)});var ki=function(t){return Array.isArray(t)},Ci=function(t){return"object"==typeof t&&null!==t&&!ki(t)},Ai=function(t,e){return"expected "+t+", got "+function(t){switch(typeof t){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return t instanceof Array?"an array":null===t?"null":"an object";default:return JSON.stringify(t)}}(e)},Ti=function(t){return t.map((function(t){return"string"==typeof t?"."+t:"["+t+"]"})).join("")},Pi=function(t,e){var n=e.at,r=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(t,r[i])&&(n[r[i]]=t[r[i]])}return n}(e,["at"]);return xi({at:t+(n||"")},r)},Mi=function(){function t(e){var n=this;this.decode=e,this.run=function(t){return Ii((function(e){return{kind:"DecoderError",input:t,at:"input"+(e.at||""),message:e.message||""}}),n.decode(t))},this.runPromise=function(t){return gi(n.run(t))},this.runWithException=function(t){return wi(n.run(t))},this.map=function(e){return new t((function(t){return bi(e,n.decode(t))}))},this.andThen=function(e){return new t((function(t){return Si((function(n){return e(n).decode(t)}),n.decode(t))}))},this.where=function(e,r){return n.andThen((function(n){return e(n)?t.succeed(n):t.fail(r)}))}}return t.string=function(){return new t((function(t){return"string"==typeof t?vi(t):yi({message:Ai("a string",t)})}))},t.number=function(){return new t((function(t){return"number"==typeof t?vi(t):yi({message:Ai("a number",t)})}))},t.boolean=function(){return new t((function(t){return"boolean"==typeof t?vi(t):yi({message:Ai("a boolean",t)})}))},t.constant=function(e){return new t((function(t){return function t(e,n){if(e===n)return!0;if(null===e&&null===n)return!0;if(typeof e!=typeof n)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(n))return!1;if(e.length!==n.length)return!1;for(var r=0;r<e.length;r++)if(!t(e[r],n[r]))return!1;return!0}var i=Object.keys(e);if(i.length!==Object.keys(n).length)return!1;for(r=0;r<i.length;r++){if(!n.hasOwnProperty(i[r]))return!1;if(!t(e[i[r]],n[i[r]]))return!1}return!0}}(t,e)?vi(e):yi({message:"expected "+JSON.stringify(e)+", got "+JSON.stringify(t)})}))},t.object=function(e){return new t((function(t){if(Ci(t)&&e){var n={};for(var r in e)if(e.hasOwnProperty(r)){var i=e[r].decode(t[r]);if(!0!==i.ok)return void 0===t[r]?yi({message:"the key '"+r+"' is required but was not present"}):yi(Pi("."+r,i.error));void 0!==i.result&&(n[r]=i.result)}return vi(n)}return Ci(t)?vi(t):yi({message:Ai("an object",t)})}))},t.array=function(e){return new t((function(t){if(ki(t)&&e){return t.reduce((function(t,n,r){return _i((function(t,e){return t.concat([e])}),t,function(t,n){return Ii((function(t){return Pi("["+n+"]",t)}),e.decode(t))}(n,r))}),vi([]))}return ki(t)?vi(t):yi({message:Ai("an array",t)})}))},t.tuple=function(e){return new t((function(t){if(ki(t)){if(t.length!==e.length)return yi({message:"expected a tuple of length "+e.length+", got one of length "+t.length});for(var n=[],r=0;r<e.length;r++){var i=e[r].decode(t[r]);if(!i.ok)return yi(Pi("["+r+"]",i.error));n[r]=i.result}return vi(n)}return yi({message:Ai("a tuple of length "+e.length,t)})}))},t.union=function(e,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return t.oneOf.apply(t,[e,n].concat(r))},t.intersection=function(e,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return new t((function(t){return[e,n].concat(r).reduce((function(e,n){return _i(Object.assign,e,n.decode(t))}),vi({}))}))},t.anyJson=function(){return new t((function(t){return vi(t)}))},t.unknownJson=function(){return new t((function(t){return vi(t)}))},t.dict=function(e){return new t((function(t){if(Ci(t)){var n={};for(var r in t)if(t.hasOwnProperty(r)){var i=e.decode(t[r]);if(!0!==i.ok)return yi(Pi("."+r,i.error));n[r]=i.result}return vi(n)}return yi({message:Ai("an object",t)})}))},t.optional=function(e){return new t((function(t){return void 0===t?vi(void 0):e.decode(t)}))},t.oneOf=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return new t((function(t){for(var n=[],r=0;r<e.length;r++){var i=e[r].decode(t);if(!0===i.ok)return i;n[r]=i.error}var o=n.map((function(t){return"at error"+(t.at||"")+": "+t.message})).join('", "');return yi({message:'expected a value matching one of the decoders, got the errors ["'+o+'"]'})}))},t.withDefault=function(e,n){return new t((function(t){return vi(mi(e,n.decode(t)))}))},t.valueAt=function(e,n){return new t((function(t){for(var r=t,i=0;i<e.length;i++){if(void 0===r)return yi({at:Ti(e.slice(0,i+1)),message:"path does not exist"});if("string"==typeof e[i]&&!Ci(r))return yi({at:Ti(e.slice(0,i+1)),message:Ai("an object",r)});if("number"==typeof e[i]&&!ki(r))return yi({at:Ti(e.slice(0,i+1)),message:Ai("an array",r)});r=r[e[i]]}return Ii((function(t){return void 0===r?{at:Ti(e),message:"path does not exist"}:Pi(Ti(e),t)}),n.decode(r))}))},t.succeed=function(e){return new t((function(t){return vi(e)}))},t.fail=function(e){return new t((function(t){return yi({message:e})}))},t.lazy=function(e){return new t((function(t){return e().decode(t)}))},t}(),ji=Mi.string,Ei=Mi.number,Oi=Mi.boolean,Ri=Mi.anyJson,Ni=Mi.constant,Li=Mi.object,Wi=Mi.array,Di=Mi.optional,Fi=Mi.oneOf,Bi=Mi.lazy,qi=ji().where((function(t){return t.length>0}),"Expected a non-empty string"),Gi=Li({type:Ni("window"),config:Li({appName:qi,url:Di(qi)})}),Hi=Li({type:Ni("group"),config:Ri(),children:Wi(Fi(Gi))}),Ui=Li({type:Ni("column"),config:Ri(),children:Wi(Fi(Hi,Gi,Bi((function(){return Ui})),Bi((function(){return Vi}))))}),Vi=Li({type:Ni("row"),config:Ri(),children:Wi(Fi(Ui,Hi,Gi,Bi((function(){return Vi}))))}),Ji=Li({type:Ni("Workspace"),state:Li({config:Ri(),context:Ri(),children:Wi(Fi(Vi,Ui,Hi,Gi))})}),zi=Li({type:Ni("window"),componentType:Ni("application"),state:Li({name:Ri(),context:Ri(),url:qi,bounds:Ri(),id:qi,parentId:Di(qi),main:Oi()})}),Ki=Fi(Ni("Global"),Ni("Workspace")),Yi=Li({name:qi,context:Di(Ri()),metadata:Di(Ri())}),Zi=Li({name:qi,context:Di(Ri()),closeRunningInstance:Di(Oi())}),Xi=Li({name:qi,type:Ki,context:Di(Ri()),metadata:Di(Ri()),components:Wi(Fi(Ji,zi))}),$i=function(){function t(t){this.controller=t}return t.prototype.ready=function(){return this.controller.ready()},t.prototype.getAll=function(t){return Ki.runWithException(t),this.controller.getAll(t)},t.prototype.get=function(t,e){return qi.runWithException(t),Ki.runWithException(e),this.controller.get(t,e)},t.prototype.export=function(t){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(e){return t&&Ki.runWithException(t),[2,this.controller.export(t)]}))}))},t.prototype.import=function(t){return t.forEach((function(t){return Xi.runWithException(t)})),this.controller.import(t)},t.prototype.save=function(t){return Yi.runWithException(t),this.controller.save(t)},t.prototype.restore=function(t){return Zi.runWithException(t),this.controller.restore(t)},t.prototype.remove=function(t,e){return qi.runWithException(e),Ki.runWithException(t),this.controller.remove(t,e)},t.prototype.onAdded=function(t){if("function"!=typeof t)throw new Error("The provided callback must be of type 'function'");return this.controller.onLayoutAdded(t)},t.prototype.onChanged=function(t){if("function"!=typeof t)throw new Error("The provided callback must be of type 'function'");return this.controller.onLayoutChanged(t)},t.prototype.onRemoved=function(t){if("function"!=typeof t)throw new Error("The provided callback must be of type 'function'");return this.controller.onLayoutRemoved(t)},t}(),Qi="___channel___",to=function(){function t(t){this.contexts=t,this.setContextDataToEmptyObjIfMissing=function(t){return Wr(Wr({},t),{data:t.data||{}})}}return t.prototype.subscribe=function(t){this.callback=t},t.prototype.subscribeFor=function(t,e){var n=this;if(!this.isChannel(t))return Promise.reject(new Error("Channel with name: "+t+" doesn't exist!"));var r=this.createContextName(t);return this.contexts.subscribe(r,(function(t,r,i,o,s){var a=n.setContextDataToEmptyObjIfMissing(t);e(a.data,a,null==s?void 0:s.updaterId)}))},t.prototype.switchChannel=function(t){return Dr(this,void 0,void 0,(function(){var e,n,r=this;return Fr(this,(function(i){switch(i.label){case 0:return this.unsubscribe(),e=this.createContextName(t),n=this,[4,this.contexts.subscribe(e,(function(t,e,n,i,o){var s=r.setContextDataToEmptyObjIfMissing(t);r.callback&&r.callback(s.data,s,null==o?void 0:o.updaterId)}))];case 1:return n.unsubscribeFunc=i.sent(),[2]}}))}))},t.prototype.unsubscribe=function(){this.unsubscribeFunc&&this.unsubscribeFunc()},t.prototype.add=function(t,e){var n=this.createContextName(t);return this.contexts.set(n,e)},t.prototype.all=function(){return this.contexts.all().filter((function(t){return t.startsWith(Qi)})).map((function(t){return t.substr(Qi.length)}))},t.prototype.getContextData=function(t){var e=this;return new Promise((function(n,r){if(!e.isChannel(t))return r(new Error("A channel with name: "+t+" doesn't exist!"));var i=e.createContextName(t);e.contexts.subscribe(i,(function(t){var r=e.setContextDataToEmptyObjIfMissing(t);n(r)})).then((function(t){return t()}))}))},t.prototype.updateChannel=function(t,e){var n=this.createContextName(t),r={name:e.name,meta:e.meta};return(null==e?void 0:e.data)&&!this.isEmptyObject(e.data)&&(r.data=e.data),this.contexts.update(n,r)},t.prototype.updateData=function(t,e){var n=this.createContextName(t);if(this.contexts.setPathSupported){var r=Object.keys(e).map((function(t){return{path:"data."+t,value:e[t]}}));return this.contexts.setPaths(n,r)}return this.contexts.update(n,{data:e})},t.prototype.isChannel=function(t){return this.all().some((function(e){return e===t}))},t.prototype.createContextName=function(t){return"___channel___"+t},t.prototype.isEmptyObject=function(t){return 0===Object.keys(t).length&&t.constructor===Object},t}(),eo=function(){function t(t,e){var n=this;this.subsKey="subs",this.changedKey="changed",this.registry=ci(),this.shared=new to(t),this.shared.subscribe(this.handler.bind(this)),this.readyPromise=Promise.resolve(null==e?void 0:e.reduce((function(t,e){return t.then((function(){return n.add(e)}))}),Promise.resolve({})))}return t.prototype.subscribe=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.subsKey,t)},t.prototype.subscribeFor=function(t,e){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(n){switch(n.label){case 0:if("string"!=typeof t)throw new Error("Please provide the name as a string!");if("function"!=typeof e)throw new Error("Please provide the callback as a function!");return[4,this.shared.subscribeFor(t,e)];case 1:return[2,n.sent()]}}))}))},t.prototype.publish=function(t,e){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(n){if("object"!=typeof t)throw new Error("Please provide the data as an object!");if(e){if("string"!=typeof e)throw new Error("Please provide the name as a string!");if(!this.shared.isChannel(e))throw new Error("A channel with name: "+e+" doesn't exist!");return[2,this.shared.updateData(e,t)]}if(!this.currentContext)throw new Error("Not joined to any channel!");return[2,this.shared.updateData(this.currentContext,t)]}))}))},t.prototype.all=function(){var t=this.shared.all();return Promise.resolve(t)},t.prototype.list=function(){return Dr(this,void 0,void 0,(function(){var t,e=this;return Fr(this,(function(n){switch(n.label){case 0:return[4,this.all()];case 1:return t=n.sent(),[4,Promise.all(t.map((function(t){return e.get(t)})))];case 2:return[2,n.sent()]}}))}))},t.prototype.get=function(t){return"string"!=typeof t?Promise.reject(new Error("Please provide the channel name as a string!")):this.shared.getContextData(t)},t.prototype.join=function(t){return Dr(this,void 0,void 0,(function(){var e,n=this;return Fr(this,(function(r){switch(r.label){case 0:if("string"!=typeof t)throw new Error("Please provide the channel name as a string!");return(e=function(t){return n.shared.all().includes(t)})(t)?[3,2]:[4,new Promise((function(n,r){var i,o=setInterval((function(){e(t)&&(clearTimeout(i),clearInterval(o),n())}),100);i=setTimeout((function(){return clearInterval(o),r(new Error("A channel with name: "+t+" doesn't exist!"))}),3e3)}))];case 1:r.sent(),r.label=2;case 2:return this.currentContext=t,[4,this.shared.switchChannel(t)];case 3:return r.sent(),this.registry.execute(this.changedKey,t),[2]}}))}))},t.prototype.leave=function(){return this.currentContext=void 0,this.registry.execute(this.changedKey,void 0),this.shared.unsubscribe(),Promise.resolve()},t.prototype.current=function(){return this.currentContext},t.prototype.my=function(){return this.current()},t.prototype.changed=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.changedKey,t)},t.prototype.onChanged=function(t){return this.changed(t)},t.prototype.add=function(t){return Dr(this,void 0,void 0,(function(){var e;return Fr(this,(function(n){switch(n.label){case 0:if("object"!=typeof t)throw new Error("Please provide the info as an object!");if(void 0===t.name)throw new Error("info.name is missing!");if("string"!=typeof t.name)throw new Error("Please provide the info.name as a string!");if(void 0===t.meta)throw new Error("info.meta is missing!");if("object"!=typeof t.meta)throw new Error("Please provide the info.meta as an object!");if(void 0===t.meta.color)throw new Error("info.meta.color is missing!");if("string"!=typeof t.meta.color)throw new Error("Please provide the info.meta.color as a string!");return e={name:t.name,meta:t.meta,data:t.data||{}},[4,this.shared.updateChannel(t.name,e)];case 1:return n.sent(),[2,e]}}))}))},t.prototype.ready=function(){return this.readyPromise},t.prototype.handler=function(t,e,n){this.registry.execute(this.subsKey,t,e,n)},t}(),no=function(t,e){return void 0===e&&(e=1e3),new Promise((function(n,r){var i=!1,o=setTimeout((function(){i=!0,r(new Error("Fetch request for: "+t+" timed out at: "+e+" milliseconds"))}),e);fetch(t).then((function(t){i||(clearTimeout(o),n(t))})).catch((function(t){i||(clearTimeout(o),r(t))}))}))},ro=function(t,e,n){return new Promise((function(r,i){var o=setTimeout((function(){i(n||"Promise timeout hit: "+e)}),e);t().then((function(t){clearTimeout(o),r(t)})).catch((function(t){clearTimeout(o),i(t)}))}))},io=function(){function t(t,e,n){var r,i,o,s,a=this;if(this._appManager=t,this._props=e,this._windows=n,this._registry=ci(),this.start=function(t,e){return ro((function(){return a.startWithoutTimeout(t,e)}),3e3,'Application "'+a.name+'" start timeout!')},void 0===(null===(r=null==e?void 0:e.userProperties)||void 0===r?void 0:r.manifest))this._url=null===(o=null===(i=null==e?void 0:e.userProperties)||void 0===i?void 0:i.details)||void 0===o?void 0:o.url;else{var c=JSON.parse(e.userProperties.manifest);this._url=(null===(s=c.details)||void 0===s?void 0:s.url)||c.url}t.onInstanceStarted((function(t){t.application.name===a.name&&a._registry.execute("instanceStarted",t)})),t.onInstanceStopped((function(t){t.application.name===a.name&&a._registry.execute("instanceStopped",t)}))}return Object.defineProperty(t.prototype,"name",{get:function(){return this._props.name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._props.title||""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return this._props.version||""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"icon",{get:function(){return this._props.icon||""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"caption",{get:function(){return this._props.caption||""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"userProperties",{get:function(){return this._props.userProperties||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return e.application.name===t.name}))},enumerable:!0,configurable:!0}),t.prototype.onInstanceStarted=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");this._registry.add("instanceStarted",t)},t.prototype.onInstanceStopped=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");this._registry.add("instanceStopped",t)},t.prototype.updateFromProps=function(t){var e,n,r=this,i=void 0!==(null===(e=null==t?void 0:t.userProperties)||void 0===e?void 0:e.manifest)?JSON.parse(null==t?void 0:t.userProperties.manifest).url:null===(n=null==t?void 0:t.userProperties)||void 0===n?void 0:n.details.url;this._url=i,Object.keys(t).forEach((function(e){r._props[e]=t[e]}))},t.prototype.startWithoutTimeout=function(t,e){var n,r;return Dr(this,void 0,void 0,(function(){var i,o,s,a,c,u,d,p=this;return Fr(this,(function(h){switch(h.label){case 0:if(i=Wr(Wr(Wr({},null===(r=null===(n=this._props)||void 0===n?void 0:n.userProperties)||void 0===r?void 0:r.details),e),{context:t||(null==e?void 0:e.context)}),!this._url)throw new Error("Application "+this.name+" doesn't have a URL.");return c={},u=function(){if(void 0!==o){var t=c[o.id];if(void 0!==t)return s(),a(t)}},d=new Promise((function(t){a=t,s=p._appManager.onInstanceStarted((function(t){var e=t.agm.windowId;void 0!==e&&(c[e]=t,u())}))})),[4,this._windows.open(this.name,this._url,i)];case 1:return o=h.sent(),u(),[2,d]}}))}))},t}(),oo=function(){function t(t,e,n,r,i){this.id=t,this.application=e,this.control=n,this.context=r,this.agm=i,this.WINDOW_DID_NOT_HAVE_TIME_TO_RESPOND="Peer has left while waiting for result"}return t.prototype.stop=function(){return Dr(this,void 0,void 0,(function(){var t;return Fr(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.callControl("stop",{},!1)];case 1:return e.sent(),[3,3];case 2:if((t=e.sent()).message!==this.WINDOW_DID_NOT_HAVE_TIME_TO_RESPOND)throw new Error(t);return[3,3];case 3:return[2]}}))}))},t.prototype.callControl=function(t,e,n){return void 0===n&&(n=!1),this.control.send({command:t,domain:"appManager",args:e,skipResult:n},{instance:this.id})},t}(),so=function(){function t(t,e,n,r){this.id=t,this.control=e,this._appManager=n,this.agm=r,this.context={},this.startedByScript=!1,this.application=void 0,e.setLocalInstance(this)}return t.prototype.stop=function(){var t=this;return new Promise((function(e,n){if(t.startedByScript){var r=t._appManager.onInstanceStopped((function(n){n.id===t.id&&(r(),e())}));window.close()}else n("Can't close a window that wasn't started by a script.")}))},t}(),ao=ji().where((function(t){return t.length>0}),"Expected a non-empty string"),co=Li({url:Di(ao)}),uo=Li({icon:Di(ao)}),po=Li({name:ao,displayName:Di(ji()),contexts:Di(Wi(ji())),customConfig:Di(Li())}),ho=Li({url:Di(ao),top:Di(Ei()),left:Di(Ei()),width:Di(Ei()),height:Di(Ei()),context:Di(Ri()),relativeTo:Di(ao),relativeDirection:Di(Fi(Ni("top"),Ni("left"),Ni("right"),Ni("bottom")))}),fo=Li({name:ao,title:Di(ji()),version:Di(ji()),appId:ao,manifest:ao,manifestType:ao,tooltip:Di(ji()),description:Di(ji()),contactEmail:Di(ji()),supportEmail:Di(ji()),publisher:Di(ji()),images:Di(Wi(co)),icons:Di(Wi(uo)),customConfig:Di(Li()),intents:Di(Wi(po))}),lo=Li({name:ao,title:Di(ji()),version:Di(ji()),details:ho,customProperties:Di(Li()),icon:Di(ji()),caption:Di(ji())}),vo=function(){function t(t,e,n,r,i){var o,s,a=this;this.windows=t,this.interop=e,this.control=n,this.config=r,this.appName=i,this._apps={},this._instances=[],this.registry=ci(),this.DEFAULT_POLLING_INTERVAL=3e3,this.OKAY_MESSAGE="OK",this.LOCAL_SOURCE="LOCAL_SOURCE";var c=e.instance.instance;if(this._myInstance=new so(c,this.control,this,this.interop.instance),(null===(o=this.config)||void 0===o?void 0:o.remoteSources)&&(this.readyPromise=this.subscribeForRemoteApplications(this.config.remoteSources)),null===(s=this.config)||void 0===s?void 0:s.localApplications){var u=this.getValidatedApplications(this.config.localApplications);this.addApplications(u)}n.onStart((function(){a.trackInstanceLifetime()}))}return Object.defineProperty(t.prototype,"myInstance",{get:function(){return this.appName||console.warn("application wasn't provided to the GlueWeb factory function!"),this._myInstance||console.warn("The application isn't defined in any of the local/remote application sources!"),this._myInstance},enumerable:!0,configurable:!0}),t.prototype.application=function(t){var e;if("string"!=typeof t)throw new Error("Please provide the name as a string!");return null===(e=this._apps[t])||void 0===e?void 0:e.application},t.prototype.applications=function(){var t=this;return Object.keys(this._apps).map((function(e){return t._apps[e].application}))},t.prototype.instances=function(){return this._instances},t.prototype.onAppAdded=function(t){var e=this;if("function"!=typeof t)throw new Error("Please provide the callback as a function!");var n=Object.keys(this._apps).map((function(t){return e._apps[t].application}));return this.registry.add("appAdded",t,n)},t.prototype.onAppRemoved=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add("appRemoved",t)},t.prototype.onAppChanged=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add("appChanged",t)},t.prototype.onInstanceStarted=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add("instanceStarted",t,this._instances)},t.prototype.onInstanceStopped=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add("instanceStopped",t)},t.prototype.ready=function(){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,this.readyPromise];case 1:return t.sent(),[3,3];case 2:return t.sent(),[3,3];case 3:return[2]}}))}))},t.prototype.getValidatedApplications=function(t){return t.filter((function(t){var e;return(e=void 0!==t.manifest?fo.run(t).ok:lo.run(t).ok)||console.warn('Validation failed for application "'+t.name+'"!'),e}))},t.prototype.subscribeForRemoteApplications=function(t){return Dr(this,void 0,void 0,(function(){var e,n,r,i,o,s,a=this;return Fr(this,(function(c){switch(c.label){case 0:for(e=[],n=function(t){var n=t.url,i=function(){return Dr(a,void 0,void 0,(function(){var t,e;return Fr(this,(function(r){switch(r.label){case 0:return[4,no(n,1e3)];case 1:return[4,r.sent().json()];case 2:return(t=r.sent()).message===this.OKAY_MESSAGE&&(e=this.getValidatedApplications(t.applications),this.addApplications(e,n)),[2]}}))}))};e.push(i()),setInterval((function(){return i().catch(console.warn)}),t.pollingInterval||r.DEFAULT_POLLING_INTERVAL)},r=this,i=0,o=t;i<o.length;i++)s=o[i],n(s);return[4,Promise.all(e)];case 1:return c.sent(),[2]}}))}))},t.prototype.getAppProps=function(t){var e=["name","title","version","customProperties","icon","caption"],n=Object.fromEntries(Object.entries(t).filter((function(t){var n=t[0];return!e.includes(n)})));return{name:t.name,title:t.title,version:t.version,icon:t.icon,caption:t.caption,userProperties:Wr(Wr({},n),t.customProperties)}},t.prototype.handleAppsChanged=function(t,e){for(var n=this,r=function(t){var r=Object.keys(i._apps).find((function(r){return r===t.name&&n._apps[r].source===e})),o=Object.keys(i._apps).find((function(r){return r===t.name&&n._apps[r].source!==e}));if(r){var s=i._apps[r],a=i.getAppProps(t);if(JSON.stringify(s.appProps)!==JSON.stringify(a)){var c=new io(i,a,i.windows);i.registry.execute("appChanged",c),i._apps[t.name]={source:s.source,application:c,appProps:a}}}else o&&console.warn('Application "'+t.name+'" already defined by source "'+i._apps[o].source+'". Skipping application definition from source '+e+".")},i=this,o=0,s=t;o<s.length;o++){r(s[o])}},t.prototype.handleAppsAdded=function(t,e){for(var n=Object.keys(this._apps),r=0,i=t.filter((function(t){return!n.includes(t.name)}));r<i.length;r++){var o=i[r],s=this.getAppProps(o),a=new io(this,s,this.windows);this.registry.execute("appAdded",a),this._apps[o.name]={source:e||this.LOCAL_SOURCE,application:a,appProps:s}}},t.prototype.handleAppsRemoved=function(t,e){for(var n=this,r=Object.keys(this._apps).filter((function(t){return n._apps[t].source===e})).map((function(t){return n._apps[t].application})),i=t.map((function(t){return t.name})),o=0,s=r.filter((function(t){return!i.includes(t.name)}));o<s.length;o++){var a=s[o];this.registry.execute("appRemoved",a),delete this._apps[a.name]}},t.prototype.tryPopulateMyInstanceApplication=function(){var t,e=this;if(this.appName){var n=null===(t=Object.values(this._apps).find((function(t){return t.application.name===e.appName})))||void 0===t?void 0:t.application;n&&(n.title&&(document.title=n.title),this._myInstance.application=n)}},t.prototype.addApplications=function(t,e){this.handleAppsChanged(t,e),this.handleAppsAdded(t,e),this.handleAppsRemoved(t,e),this._myInstance.application||this.tryPopulateMyInstanceApplication()},t.prototype.remoteFromServer=function(t){return Dr(this,void 0,void 0,(function(){var e,n,r,i,o;return Fr(this,(function(s){switch(s.label){case 0:return e=t.application,t.instance&&e&&this._apps[e]?(n=t.instance,r=this._apps[e].application,[4,null==(i=this.windows.list().find((function(e){return e.id===t.windowId})))?void 0:i.getContext()]):[2,void 0];case 1:return o=s.sent(),[2,new oo(n,r,this.control,o,t)]}}))}))},t.prototype.trackInstanceLifetime=function(){var t=this;this.interop.serverMethodAdded((function(e){var n=e.server,r=e.method;return Dr(t,void 0,void 0,(function(){var t;return Fr(this,(function(e){switch(e.label){case 0:return r.name!==ui.CONTROL_METHOD?[2]:[4,this.remoteFromServer(n)];case 1:return(t=e.sent())&&(this._instances.push(t),this.registry.execute("instanceStarted",t)),[2]}}))}))})),this.interop.serverRemoved((function(e){return Dr(t,void 0,void 0,(function(){var t;return Fr(this,(function(n){switch(n.label){case 0:return[4,this.remoteFromServer(e)];case 1:return(t=n.sent())&&(this._instances=this._instances.filter((function(e){return e.id!==t.id})),this.registry.execute("instanceStopped",t)),[2]}}))}))}))},t}(),yo=ji().where((function(t){return t.length>0}),"Expected a non-empty string"),go=Li({url:Di(yo),top:Di(Ei()),left:Di(Ei()),width:Di(Ei()),height:Di(Ei()),context:Di(Ri()),relativeTo:Di(yo),relativeDirection:Di(Fi(Ni("top"),Ni("left"),Ni("right"),Ni("bottom")))}),mo=Li({type:Di(yo),data:Di(Li())}),wo=Fi(Li({name:Di(ji()),contextType:Di(ji())}),yo),bo=Fi(Li({intent:yo,contextTypes:Di(Wi(ji())),displayName:Di(ji())}),yo),_o=Fi(Li({intent:yo,target:Di(Fi(Ni("startNew"),Ni("reuse"),Li({app:Di(ji()),instance:Di(ji())}))),context:Di(mo),options:Di(go)}),yo),Io="Tick42.FDC3.Intents.",So=function(){function t(t,e,n){this.interop=t,this.windows=e,this.appManager=n}return t.prototype.find=function(t){return Dr(this,void 0,void 0,(function(){var e,n;return Fr(this,(function(r){switch(r.label){case 0:return wo.runWithException(t),[4,this.all()];case 1:return e=r.sent(),void 0===t?[2,e]:"string"==typeof t?[2,e.filter((function(e){return e.name===t}))]:(t.contextType&&(n=t.contextType.toLowerCase(),e=e.filter((function(t){return t.handlers.some((function(t){var e;return null===(e=t.contextTypes)||void 0===e?void 0:e.some((function(t){return t.toLowerCase()===n}))}))}))),t.name&&(e=e.filter((function(e){return e.name===t.name}))),[2,e])}}))}))},t.prototype.raise=function(t){return Dr(this,void 0,void 0,(function(){var e,n,r,i,o,s,a,c,u;return Fr(this,(function(d){switch(d.label){case 0:return _o.runWithException(t),"string"==typeof t&&(t={intent:t}),e=t.intent,[4,this.get(e)];case 1:if(void 0===(n=d.sent()))throw new Error("Intent "+e+" not found.");if(r=!n.handlers.some((function(t){return"app"===t.type})),i=t.target||(r?"reuse":"startNew"),s=n.handlers.find((function(t){return"app"===t.type})),"startNew"===i)o=s;else if("reuse"===i)a=n.handlers.find((function(t){return"instance"===t.type})),o=a||s;else if(i.instance)o=n.handlers.find((function(t){return"instance"===t.type&&t.instanceId===i.instance}));else{if(!i.app)throw new Error("Invalid intent target: "+JSON.stringify(i));o=n.handlers.find((function(t){return"app"===t.type&&t.applicationName===i.app}))}if(!o)throw new Error("Can not raise intent for request "+JSON.stringify(t)+" - can not find intent handler.");return c=o.instanceId,"app"!==o.type?[3,3]:[4,this.startApp(o.applicationName,t.options)];case 2:c=d.sent(),d.label=3;case 3:return[4,this.raiseIntentToInstance(c,e,t.context)];case 4:return(u=d.sent()).request=t,u.handler=o,[2,u]}}))}))},t.prototype.all=function(){return Dr(this,void 0,void 0,(function(){var t,e,n,r,i,o,s,a,c,u,d,p,h,f,l,v=this;return Fr(this,(function(y){switch(y.label){case 0:for(t=this.appManager.applications().map((function(t){return{name:t.name,title:t.title,icon:t.icon,caption:t.caption,intents:t.userProperties.intents}})),e={},n=t.filter((function(t){return t.intents&&t.intents.length>0})),r=0,i=n;r<i.length;r++)for(o=i[r],s=0,a=o.intents;s<a.length;s++)c=a[s],(u=e[c.name])||(u={name:c.name,handlers:[]},e[c.name]=u),d={applicationName:o.name,applicationTitle:o.title,applicationDescription:o.caption,displayName:c.displayName,contextTypes:c.contexts,applicationIcon:o.icon,type:"app"},u.handlers.push(d);p=function(n){return Fr(this,(function(r){switch(r.label){case 0:return[4,Promise.all(n.getMethods().filter((function(t){return t.name.startsWith(Io)})).map((function(r){return Dr(v,void 0,void 0,(function(){var i,o,s,a,c,u,d,p;return Fr(this,(function(h){switch(h.label){case 0:if(i=r.name.replace(Io,""),(o=e[i])||(o={name:i,handlers:[]},e[i]=o),r.description)try{s=JSON.parse(r.description)}catch(t){}return(a=t.find((function(t){return t.name===n.application})))&&a.intents&&(c=a.intents.find((function(t){return t.name===i}))),[4,null==(u=this.windows.findById(n.windowId))?void 0:u.getTitle()];case 1:return d=h.sent(),p={instanceId:n.instance,applicationName:n.application,applicationIcon:(null==s?void 0:s.icon)||(null==a?void 0:a.icon),applicationTitle:null==a?void 0:a.title,applicationDescription:(null==s?void 0:s.description)||(null==a?void 0:a.caption),displayName:(null==s?void 0:s.displayName)||(null==c?void 0:c.displayName),contextTypes:(null==s?void 0:s.contextTypes)||(null==c?void 0:c.contexts),instanceTitle:d,type:"instance"},o.handlers.push(p),[2]}}))}))})))];case 1:return r.sent(),[2]}}))},h=0,f=this.interop.servers(),y.label=1;case 1:return h<f.length?(l=f[h],[5,p(l)]):[3,4];case 2:y.sent(),y.label=3;case 3:return h++,[3,1];case 4:return[2,Object.values(e)]}}))}))},t.prototype.addIntentListener=function(t,e){var n=this;if(bo.runWithException(t),"function"!=typeof e)throw new Error("Please provide the handler as a function!");var r={unsubscribe:function(){return console.log("Could not unsubscribe!")}},i="Tick42.FDC3.Intents."+("string"==typeof t?t:t.intent),o="string"==typeof t?void 0:JSON.stringify(t);return this.interop.register({name:i,description:o},(function(t){return e(t)})).then((function(){r.unsubscribe=function(){n.interop.unregister(i)}})),r},t.prototype.get=function(t){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(e){switch(e.label){case 0:return[4,this.all()];case 1:return[2,e.sent().find((function(e){return e.name===t}))]}}))}))},t.prototype.startApp=function(t,e){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(n){switch(n.label){case 0:return[4,this.appManager.application(t).start({},e)];case 1:return[2,n.sent().id]}}))}))},t.prototype.raiseIntentToInstance=function(t,e,n){return Dr(this,void 0,void 0,(function(){var r,i,o=this;return Fr(this,(function(s){switch(s.label){case 0:return r="Tick42.FDC3.Intents."+e,(i=this.interop.servers().find((function(e){return e.instance===t})))?[3,2]:[4,new Promise((function(e,n){var r,s=o.interop.serverAdded((function(n){n.instance===t&&(i=n,e(),clearTimeout(r),s())}));r=setTimeout((function(){s(),n(new Error("Can not find interop server for instance "+t))}),3e4)}))];case 1:s.sent(),s.label=2;case 2:return i.getMethods().find((function(t){return t.name===r}))?[3,4]:[4,new Promise((function(e,n){var i,s=o.interop.methodAdded((function(t){t.name===r&&(e(),clearTimeout(i),s())}));i=setTimeout((function(){s(),n(new Error("Can not find interop method "+r+" for instance "+t))}),1e4)}))];case 3:s.sent(),s.label=4;case 4:return[4,this.interop.invoke(r,n,{instance:t})];case 5:return[2,{result:s.sent().returned}]}}))}))},t}(),xo=function(){function t(t){this.interop=t}return t.prototype.raise=function(t){return Dr(this,void 0,void 0,(function(){var e,n,r=this;return Fr(this,(function(i){switch(i.label){case 0:if(!("Notification"in window))throw new Error("this browser does not support desktop notification");return[4,"granted"===Notification.permission?Promise.resolve("granted"):"denied"===Notification.permission?Promise.reject("no permissions from user"):Notification.requestPermission()];case 1:return i.sent(),e=this.raiseUsingWebApi(t),t.clickInterop&&(n=t.clickInterop,e.onclick=function(){var t,e;r.interop.invoke(n.method,null!==(t=null==n?void 0:n.arguments)&&void 0!==t?t:{},null!==(e=null==n?void 0:n.target)&&void 0!==e?e:"best")}),[2,e]}}))}))},t.prototype.raiseUsingWebApi=function(t){return new Notification(t.title,t)},t}(),ko="/glue",Co="worker.js",Ao="glue.config.json",To={layouts:{autoRestore:!1,autoSaveWindowContext:!1},logger:"error",assets:{location:ko},channels:!1,appManager:!1,libraries:[]},Po=function(t){return Dr(void 0,void 0,void 0,(function(){var e,n,r,i,o;return Fr(this,(function(s){switch(s.label){case 0:if(!1===(null===(i=t.assets)||void 0===i?void 0:i.extendConfig)||!1===t.extends)return[2,{}];e=(null===(o=t.assets)||void 0===o?void 0:o.location)?t.assets.location+"/"+Ao:"string"==typeof t.extends?t.extends:"/glue/glue.config.json",s.label=1;case 1:return s.trys.push([1,4,,5]),[4,no(e)];case 2:return(n=s.sent()).ok?[4,n.json()]:[2,{}];case 3:return[2,null!=(r=s.sent())?r:{}];case 4:return s.sent(),[2,{}];case 5:return[2]}}))}))},Mo="T42.HC.GetSaveContext",jo="T42.Layouts.Events",Eo=function(){function t(t,e,n,r,i){var o,s;this.storage=t,this.windows=e,this.control=n,this.interop=r,this._registry=ci(),this.autoSaveContext=null!==(s=null===(o=null==i?void 0:i.layouts)||void 0===o?void 0:o.autoSaveWindowContext)&&void 0!==s&&s,this.control.subscribe("layouts",this.handleControlMessage.bind(this)),this.readyPromise=Promise.all([this.registerRequestMethods(),this.registerEventsMethod()]).then((function(){console.log("methods are live")}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.export=function(t){return Dr(this,void 0,void 0,(function(){var e,n,r;return Fr(this,(function(i){switch(i.label){case 0:return t?[2,this.storage.getAll(t)]:[4,Promise.all([this.storage.getAll("Global"),this.storage.getAll("Workspace")])];case 1:return e=i.sent(),n=e[0],r=e[1],[2,n.concat(r)]}}))}))},t.prototype.import=function(t){return Dr(this,void 0,void 0,(function(){var e=this;return Fr(this,(function(n){switch(n.label){case 0:return[4,Promise.all(t.map((function(t){return Dr(e,void 0,void 0,(function(){var e;return Fr(this,(function(n){switch(n.label){case 0:return[4,this.get(t.name,t.type)];case 1:return e=n.sent()?"layoutChanged":"layoutAdded",[4,this.storage.store(t,t.type)];case 2:return n.sent(),this.emitLayoutEvent(e,t),[2]}}))}))})))];case 1:return n.sent(),[2]}}))}))},t.prototype.save=function(t,e){return void 0===e&&(e=!1),Dr(this,void 0,void 0,(function(){var n,r,i,o;return Fr(this,(function(s){switch(s.label){case 0:return n=this.windows.getChildWindows().map((function(t){return t.id})),[4,this.getRemoteWindowsInfo(n)];case 1:return(r=s.sent()).push(this.getLocalLayoutComponent(t.context,!0)),i={type:"Global",name:t.name,components:r,context:t.context||{},metadata:t.metadata||{}},[4,this.get(t.name,"Global")];case 2:return o=s.sent()?"layoutChanged":"layoutAdded",e?(this.storage.storeAutoLayout(i),[3,5]):[3,3];case 3:return[4,this.storage.store(i,"Global")];case 4:s.sent(),s.label=5;case 5:return this.emitLayoutEvent(o,i),[2,i]}}))}))},t.prototype.autoSave=function(t){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(e){return[2,this.save(t,!0)]}))}))},t.prototype.restore=function(t){return Dr(this,void 0,void 0,(function(){var e;return Fr(this,(function(n){switch(n.label){case 0:return[4,this.storage.get(t.name,"Global")];case 1:if(!(e=n.sent()))throw new Error("can not find layout with name "+t.name);return this.restoreComponents(e),[2]}}))}))},t.prototype.restoreAutoSavedLayout=function(){return Dr(this,void 0,void 0,(function(){var t,e,n,r;return Fr(this,(function(i){switch(i.label){case 0:return t="_auto_"+document.location.href,[4,this.storage.getAutoLayout(t)];case 1:if(!(e=i.sent()))return[2,Promise.resolve()];if((n=this.windows.my()).parent)return[2];r=e.components.find((function(t){return t.state.main})),n.setContext(null==r?void 0:r.state.context);try{this.restoreComponents(e)}catch(t){return[2]}return[2]}}))}))},t.prototype.remove=function(t,e){return Dr(this,void 0,void 0,(function(){var n;return Fr(this,(function(r){switch(r.label){case 0:return[4,this.get(e,t)];case 1:return n=r.sent(),[4,this.storage.remove(e,t)];case 2:return r.sent(),n&&this.emitLayoutEvent("layoutRemoved",n),[2]}}))}))},t.prototype.getAll=function(t){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(e){switch(e.label){case 0:return[4,this.storage.getAll(t)];case 1:return[2,e.sent().map((function(t){return{name:t.name,type:t.type,context:t.context,metadata:t.metadata}}))]}}))}))},t.prototype.get=function(t,e){return this.storage.get(t,e)},t.prototype.getLocalLayoutComponent=function(t,e){var n;void 0===e&&(e=!1);var r=this.windows.my();try{this.autoSaveContext&&(n={windowContext:r.getContextSync()})}catch(t){}return{type:"window",componentType:"application",state:{name:r.name,context:(null==n?void 0:n.windowContext)||{},bounds:r.getBoundsSync(),url:window.document.location.href,id:r.id,parentId:r.parent,main:e}}},t.prototype.onLayoutAdded=function(t){return this._registry.add("layoutAdded",t)},t.prototype.onLayoutChanged=function(t){return this._registry.add("layoutChanged",t)},t.prototype.onLayoutRemoved=function(t){return this._registry.add("layoutRemoved",t)},t.prototype.restoreComponents=function(t){var e=this;t.components.forEach((function(t){if("window"===t.type){var n=t.state;if(n.main)return;var r=Wr(Wr({},n.bounds),{context:n.context});e.windows.open(n.name,n.url,r)}}))},t.prototype.getRemoteWindowsInfo=function(t){return Dr(this,void 0,void 0,(function(){var e,n,r,i,o,s;return Fr(this,(function(a){switch(a.label){case 0:for(e=[],n=function(t){var n=r.interop.servers().find((function(e){return e.windowId===t}));if(!n||!n.getMethods)return"continue";if(n.getMethods().find((function(t){return t.name===Mo})))try{e.push(r.interop.invoke(Mo,{},{windowId:t}))}catch(t){}},r=this,i=0,o=t;i<o.length;i++)s=o[i],n(s);return[4,Promise.all(e)];case 1:return[2,a.sent().map((function(t){return t.returned}))]}}))}))},t.prototype.registerRequestMethods=function(){var t=this;return this.interop.register(Mo,(function(e){return t.getLocalLayoutComponent(e)}))},t.prototype.handleControlMessage=function(t){return Dr(this,void 0,void 0,(function(){var e,n,r,i=this;return Fr(this,(function(o){switch(o.label){case 0:return"saveLayoutAndClose"!==(e=t).command?[3,3]:(n=e.args,[4,this.getRemoteWindowsInfo(n.childWindows)]);case 1:return(r=o.sent()).push(n.parentInfo),[4,this.storage.storeAutoLayout({type:"Global",name:n.layoutName,components:r,context:n.context||{},metadata:n.metadata||{}})];case 2:o.sent(),n.childWindows.forEach((function(t){var e;null===(e=i.windows.findById(t))||void 0===e||e.close()})),o.label=3;case 3:return[2]}}))}))},t.prototype.registerEventsMethod=function(){var t=this;return this.interop.register(jo,(function(e){t._registry.execute(e.event,e.layout)}))},t.prototype.emitLayoutEvent=function(t,e){this.interop.methods().some((function(t){return t.name===jo}))&&this.interop.invoke(jo,{event:t,layout:e},"all").catch((function(){}))},t}(),Oo=function(){function t(t,e,n){this.localStore=t,this.autoStore=e,this.remoteStore=n}return t.prototype.get=function(t,e){var n;return Dr(this,void 0,void 0,(function(){var r,i;return Fr(this,(function(o){switch(o.label){case 0:return[4,null===(n=this.remoteStore)||void 0===n?void 0:n.get(t,e)];case 1:return r=o.sent(),[4,this.localStore.get(t,e)];case 2:return i=o.sent(),r&&i?[2,r]:[2,r||i]}}))}))},t.prototype.getAll=function(t){return Dr(this,void 0,void 0,(function(){var e,n,r,i,o=this;return Fr(this,(function(s){switch(s.label){case 0:return[4,Promise.all([this.localStore.getAll(t),new Promise((function(e){if(o.remoteStore)return o.remoteStore.getAll(t).then(e);e([])}))])];case 1:return e=s.sent(),n=e[0],r=e[1],i=n.filter((function(t){return!r.some((function(e){return e.name===t.name}))})),[2,r.concat(i)]}}))}))},t.prototype.store=function(t,e){var n;return Dr(this,void 0,void 0,(function(){return Fr(this,(function(r){switch(r.label){case 0:return[4,null===(n=this.remoteStore)||void 0===n?void 0:n.get(t.name,e)];case 1:if(r.sent())throw new Error("Cannot save layout with name: "+t.name+" and type: "+e+", because it is present in the remote store and is treated as readonly");return t.metadata?t.metadata.allowSave=!0:t.metadata={allowSave:!0},[4,this.localStore.store(t,e)];case 2:return r.sent(),[2]}}))}))},t.prototype.remove=function(t,e){var n;return Dr(this,void 0,void 0,(function(){return Fr(this,(function(r){switch(r.label){case 0:return[4,null===(n=this.remoteStore)||void 0===n?void 0:n.get(t,e)];case 1:if(r.sent())throw new Error("Cannot remove layout with name: "+t+" and type: "+e+", because it is present in the remote store and is treated as readonly");return[4,this.localStore.delete(t,e)];case 2:return r.sent(),[2]}}))}))},t.prototype.getAutoLayout=function(t){return this.autoStore.get(t,"Global")},t.prototype.storeAutoLayout=function(t){this.autoStore.save(t)},t}();let Ro,No;const Lo=new WeakMap,Wo=new WeakMap,Do=new WeakMap,Fo=new WeakMap,Bo=new WeakMap;let qo={get(t,e,n){if(t instanceof IDBTransaction){if("done"===e)return Wo.get(t);if("objectStoreNames"===e)return t.objectStoreNames||Do.get(t);if("store"===e)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return Uo(t[e])},set:(t,e,n)=>(t[e]=n,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function Go(t){return t!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(No||(No=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(Vo(this),e),Uo(Lo.get(this))}:function(...e){return Uo(t.apply(Vo(this),e))}:function(e,...n){const r=t.call(Vo(this),e,...n);return Do.set(r,e.sort?e.sort():[e]),Uo(r)}}function Ho(t){return"function"==typeof t?Go(t):(t instanceof IDBTransaction&&function(t){if(Wo.has(t))return;const e=new Promise((e,n)=>{const r=()=>{t.removeEventListener("complete",i),t.removeEventListener("error",o),t.removeEventListener("abort",o)},i=()=>{e(),r()},o=()=>{n(t.error||new DOMException("AbortError","AbortError")),r()};t.addEventListener("complete",i),t.addEventListener("error",o),t.addEventListener("abort",o)});Wo.set(t,e)}(t),((t,e)=>e.some(e=>t instanceof e))(t,Ro||(Ro=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(t,qo):t)}function Uo(t){if(t instanceof IDBRequest)return function(t){const e=new Promise((e,n)=>{const r=()=>{t.removeEventListener("success",i),t.removeEventListener("error",o)},i=()=>{e(Uo(t.result)),r()},o=()=>{n(t.error),r()};t.addEventListener("success",i),t.addEventListener("error",o)});return e.then(e=>{e instanceof IDBCursor&&Lo.set(e,t)}).catch(()=>{}),Bo.set(e,t),e}(t);if(Fo.has(t))return Fo.get(t);const e=Ho(t);return e!==t&&(Fo.set(t,e),Bo.set(e,t)),e}const Vo=t=>Bo.get(t);const Jo=["get","getKey","getAll","getAllKeys","count"],zo=["put","add","delete","clear"],Ko=new Map;function Yo(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(Ko.get(e))return Ko.get(e);const n=e.replace(/FromIndex$/,""),r=e!==n,i=zo.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!i&&!Jo.includes(n))return;const o=async function(t,...e){const o=this.transaction(t,i?"readwrite":"readonly");let s=o.store;r&&(s=s.index(e.shift()));const a=await s[n](...e);return i&&await o.done,a};return Ko.set(e,o),o}qo=(t=>({...t,get:(e,n,r)=>Yo(e,n)||t.get(e,n,r),has:(e,n)=>!!Yo(e,n)||t.has(e,n)}))(qo);var Zo=function(){function t(){if(!("indexedDB"in window))throw new Error("Cannot initialize the local storage, because IndexedDb is not supported")}return Object.defineProperty(t.prototype,"database",{get:function(){var t=this;return this._database?Promise.resolve(this._database):new Promise((function(e){(function(t,e,{blocked:n,upgrade:r,blocking:i,terminated:o}={}){const s=indexedDB.open(t,e),a=Uo(s);return r&&s.addEventListener("upgradeneeded",t=>{r(Uo(s.result),t.oldVersion,t.newVersion,Uo(s.transaction))}),n&&s.addEventListener("blocked",()=>n()),a.then(t=>{o&&t.addEventListener("close",()=>o()),i&&t.addEventListener("versionchange",()=>i())}).catch(()=>{}),a})("glue42core",1,{upgrade:t.setUpDb.bind(t)}).then((function(n){t._database=n,e(t._database)}))}))},enumerable:!0,configurable:!0}),t.prototype.getAll=function(t){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(e){switch(e.label){case 0:switch(t){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,e.sent().getAll("workspaceLayouts")];case 3:return[4,this.database];case 4:return[2,e.sent().getAll("globalLayouts")];case 5:throw new Error("The provided layout type is not recognized: "+t)}}))}))},t.prototype.delete=function(t,e){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(n){switch(n.label){case 0:switch(e){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,n.sent().delete("workspaceLayouts",t)];case 3:return[4,this.database];case 4:return[2,n.sent().delete("globalLayouts",t)];case 5:throw new Error("The provided layout type is not recognized: "+e)}}))}))},t.prototype.get=function(t,e){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(n){switch(n.label){case 0:switch(e){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,n.sent().get("workspaceLayouts",t)];case 3:return[4,this.database];case 4:return[2,n.sent().get("globalLayouts",t)];case 5:throw new Error("The provided layout type is not recognized: "+e)}}))}))},t.prototype.store=function(t,e){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(n){switch(n.label){case 0:switch(Xi.runWithException(t),Ki.runWithException(e),e){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,n.sent().put("workspaceLayouts",t,t.name)];case 3:return[4,this.database];case 4:return[2,n.sent().put("globalLayouts",t,t.name)];case 5:throw new Error("The provided layout type is not recognized: "+e)}}))}))},t.prototype.setUpDb=function(t){t.objectStoreNames.contains("workspaceLayouts")||t.createObjectStore("workspaceLayouts"),t.objectStoreNames.contains("globalLayouts")||t.createObjectStore("globalLayouts")},t}(),Xo=function(){function t(t){this.storeBaseUrl=t}return t.prototype.getAll=function(t){return Dr(this,void 0,void 0,(function(){var e,n,r;return Fr(this,(function(i){switch(i.label){case 0:return Ki.runWithException(t),e=this.storeBaseUrl+"/glue.layouts.json",[4,this.fetchTimeout(e)];case 1:if(!(n=i.sent()).ok)return[2,[]];i.label=2;case 2:return i.trys.push([2,4,,5]),[4,n.json()];case 3:return r=i.sent(),[3,5];case 4:return i.sent(),[2,[]];case 5:return r?[2,(r["Global"===t?"globals":"workspaces"]||[]).filter((function(t){var e=Xi.run(t);return e.ok||console.warn("Fetched layout: "+t.name+" is discarded, because it failed the validation: "+JSON.stringify(e)),e.ok}))]:[2,[]]}}))}))},t.prototype.get=function(t,e){return Dr(this,void 0,void 0,(function(){return Fr(this,(function(n){switch(n.label){case 0:return[4,this.getAll(e)];case 1:return[2,n.sent().find((function(e){return e.name===t}))]}}))}))},t.prototype.fetchTimeout=function(t,e){return void 0===e&&(e=1e3),new Promise((function(n,r){var i=!1,o=setTimeout((function(){i=!0,r(new Error("Fetch request for: "+t+" timed out at: "+e+" milliseconds"))}),e);fetch(t).then((function(t){i||(clearTimeout(o),n(t))})).catch((function(t){i||(clearTimeout(o),r(t))}))}))},t}(),$o=function(){function t(){}return t.prototype.get=function(t,e){return this.getObjectFromLocalStorage()[this.getKey(t,e)]},t.prototype.save=function(t){var e=this.getObjectFromLocalStorage();return e[this.getKey(t.name,t.type)]=t,this.setObjectToLocalStorage(e),t},t.prototype.remove=function(t,e){delete this.getObjectFromLocalStorage()[this.getKey(t,e)]},t.prototype.getObjectFromLocalStorage=function(){var e=window.localStorage.getItem(t.KEY);return e?JSON.parse(e):{}},t.prototype.setObjectToLocalStorage=function(e){window.localStorage.setItem(t.KEY,JSON.stringify(e))},t.prototype.getKey=function(t,e){return e+"_"+t},t.KEY="G0_layouts",t}(),Qo=function(t,e,n,r){var i=!1;window.addEventListener("beforeunload",(function(){Dr(void 0,void 0,void 0,(function(){var o,s,a,c,u;return Fr(this,(function(d){return i||(i=!0,(null===(u=null==e?void 0:e.layouts)||void 0===u?void 0:u.autoRestore)&&(o=t.windows.getChildWindows().map((function(t){return t.id})),s=o[0],a="_auto_"+document.location.href,o.length>0?(c={domain:"layouts",command:"saveLayoutAndClose",args:{childWindows:o,closeEveryone:!0,layoutName:a,context:{},metadata:{},parentInfo:null==r?void 0:r.getLocalLayoutComponent({},!0)}},n.send(c,{windowId:s})):null==r||r.autoSave({name:a})),t.done()),[2]}))}))}))},ts=function(t,e){return(ts=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function es(t,e){function n(){this.constructor=t}ts(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var ns=function(){return(ns=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function rs(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{c(r.next(t))}catch(t){o(t)}}function a(t){try{c(r.throw(t))}catch(t){o(t)}}function c(t){t.done?i(t.value):new n((function(e){e(t.value)})).then(s,a)}c((r=r.apply(t,e||[])).next())}))}function is(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function os(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r}var ss=1,as=2,cs=3,us=4;function ds(t){return t.type===cs?"timestamp":t.type===as?"number":t.type===ss?"string":t.type===us?"object":"unknown"}function ps(t){return t.constructor===Date?"timestamp":"number"==typeof t?"number":"string"==typeof t?"string":"object"==typeof t?"object":"string"}function hs(t){var e={},n=ds(t);if("object"===n){var r=Object.keys(t.value).reduce((function(e,n){var r=ps(t.value[n]);if("object"===r){var i=function t(e){return Object.keys(e).reduce((function(n,r){var i=ps(e[r]);return n[r]="object"===i?{type:"object",description:"",context:{},composite:t(e[r])}:{type:i,description:"",context:{}},n}),{})}(t.value[n]);e[n]={type:"object",description:"",context:{},composite:i}}else e[n]={type:r,description:"",context:{}};return e}),{});e.composite=r}return e.name=fs(t.path.join("/")+"/"+t.name),e.type=n,e.description=t.description,e.context={},e}function fs(t){return void 0!==t&&t.length>0&&"/"!==t[0]?"/"+t:t}function ls(t){return"timestamp"===ds(t)?Date.now():function t(e){if("object"!=typeof e)return e;return Object.keys(e).reduce((function(n,r){var i=e[r];return"object"==typeof i&&i.constructor!==Date?n[r]=t(i):i.constructor===Date?n[r]=new Date(i).getTime():i.constructor===Boolean?n[r]=i.toString():n[r]=i,n}),{})}(t.value)}function vs(t){var e=function t(e){return e.reduce((function(e,n){return e.concat(Array.isArray(n)?t(n):n)}),[])}(t.root.getAggregateState()),n=e.sort((function(t,e){return t.state?e.state?e.state-t.state:-1:1}))[0];return{description:function(t){var e="";return t.forEach((function(t,n,r){var i=t.path.join(".");n===r.length-1?e+=i+"."+t.name+": "+t.description:e+=i+"."+t.name+": "+t.description+","})),e.length>100?e.slice(0,100)+"...":e}(e),value:n.state}}var ys=function(t,e,n){if(null===t||"object"!=typeof t)throw new Error("Missing definition");if(null===e||"object"!=typeof e)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")},gs=function(){function t(t,e,n,r,i){this.definition=t,this.system=e,this.transport=n,this.value=r,this.type=i,this.path=[],ys(t,e,n),this.path=e.path.slice(0),this.path.push(e.name),this.name=t.name,this.description=t.description,n.createMetric(this)}return Object.defineProperty(t.prototype,"repo",{get:function(){var t;return null===(t=this.system)||void 0===t?void 0:t.repo},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),t.prototype.update=function(t){return this.value=t,this.transport.updateMetric(this)},t}(),ms=function(t){function e(e,n,r,i){return t.call(this,e,n,r,i,as)||this}return es(e,t),e.prototype.incrementBy=function(t){this.update(this.value+t)},e.prototype.increment=function(){this.incrementBy(1)},e.prototype.decrement=function(){this.incrementBy(-1)},e.prototype.decrementBy=function(t){this.incrementBy(-1*t)},e}(gs),ws=function(t){function e(e,n,r,i){return t.call(this,e,n,r,i,us)||this}return es(e,t),e.prototype.update=function(t){return this.mergeValues(t),this.transport.updateMetric(this)},e.prototype.mergeValues=function(t){var e=this;return Object.keys(this.value).forEach((function(n){void 0!==t[n]&&(e.value[n]=t[n])}))},e}(gs),bs=function(t){function e(e,n,r,i){return t.call(this,e,n,r,i,ss)||this}return es(e,t),e}(gs),_s=function(t){function e(e,n,r,i){return t.call(this,e,n,r,i,cs)||this}return es(e,t),e.prototype.now=function(){this.update(new Date)},e}(gs);var Is=function(){function t(t,e){e.init(this),this.root=function t(e,n,r,i,o){if(!n)throw new Error("Repository is required");if(!r)throw new Error("Transport is required");var s,a,c=r,u=e,d=o||"",p=n,h=i,f=function t(e){if(!e||!e.parent)return[];var n=t(e.parent);return n.push(e.name),n}(i),l={},v=(a="/",((s=f)&&s.length>0?s.join(a):"")+e),y=n.root,g=[],m=[];function w(t,e,n,r){var i={name:""};i="string"==typeof t?{name:t}:t;var o=m.filter((function(t){return t.name===i.name}));if(o.length>0){var s=o[0];if(s.type!==e)throw new Error("A metric named "+i.name+" is already defined with different type.");return void 0!==n&&s.update(n).catch((function(){})),s}var a=r(i);return m.push(a),a}var b={get name(){return u},get description(){return d},get repo(){return p},get parent(){return h},path:f,id:v,root:y,get subSystems(){return g},get metrics(){return m},subSystem:function(e,n){if(!e||0===e.length)throw new Error("name is required");var r=g.filter((function(t){return t.name===e}));if(r.length>0)return r[0];var i=t(e,p,c,b,n);return g.push(i),i},getState:function(){return l},setState:function(t,e){l={state:t,description:e},c.updateSystem(b,l)},stringMetric:function(t,e){return w(t,ss,e,(function(t){return new bs(t,b,c,e)}))},timestampMetric:function(t,e){return w(t,cs,e,(function(t){return new _s(t,b,c,e)}))},objectMetric:function(t,e){return w(t,us,e,(function(t){return new ws(t,b,c,e)}))},numberMetric:function(t,e){return w(t,as,e,(function(t){return new ms(t,b,c,e)}))},getAggregateState:function(){var t=[];return Object.keys(l).length>0&&t.push({name:u,path:f,state:l.state,description:l.description}),g.forEach((function(e){var n=e.getAggregateState();n.length>0&&t.push.apply(t,n)})),t}};return c.createSystem(b),b}("",this,e),this.addSystemMetrics(this.root,t.clickStream||void 0===t.clickStream)}return t.prototype.addSystemMetrics=function(t,e){if("undefined"!=typeof navigator&&t.stringMetric("UserAgent",navigator.userAgent),e&&"undefined"!=typeof document){var n=t.subSystem("ClickStream"),r=function(t){if(t.target){var e=t.target;n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:t.target?e.className:"",id:e.id,type:"<"+e.tagName.toLowerCase()+">",href:e.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",r):document.attachEvent("onclick",r)}t.stringMetric("StartTime",(new Date).toString());var i=t.stringMetric("StartURL",""),o=t.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;i.update(s)}void 0!==window.glue42gd&&o.update(window.glue42gd.appName)}},t}(),Ss=function(){function t(){}return t.prototype.init=function(t){},t.prototype.createSystem=function(t){return Promise.resolve()},t.prototype.updateSystem=function(t,e){return Promise.resolve()},t.prototype.createMetric=function(t){return Promise.resolve()},t.prototype.updateMetric=function(t){return Promise.resolve()},t}(),xs=function(){function t(t,e,n){this.api=t,this.lastCount=0,this.initialPublishTimeout=1e4,this.publishInterval=6e4,this.initialPublishTimeout=null!=e?e:this.initialPublishTimeout,this.publishInterval=null!=n?n:this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}return t.prototype.scheduleCollection=function(){var t=this;setTimeout((function(){t.collect(),setInterval((function(){t.collect()}),t.publishInterval)}),this.initialPublishTimeout)},t.prototype.collect=function(){try{this.collectMemory(),this.collectEntries()}catch(t){}},t.prototype.collectMemory=function(){var t=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:t.totalJSHeapSize,usedJSHeapSize:t.usedJSHeapSize}))},t.prototype.collectEntries=function(){var t=window.performance.getEntries();t.length<=this.lastCount||(this.lastCount=t.length,this.system.stringMetric("entries",JSON.stringify(t)))},t}(),ks=function(t){var e;e=t.connection&&"object"==typeof t.connection?function(t,e){var n,r,i=this;if(!t||"object"!=typeof t)throw new Error("Connection is required parameter");var o=function(t){s(t.root)},s=function(t){a(t),t.metrics.forEach((function(t){c(t)})),t.subSystems.forEach((function(t){s(t)}))},a=function(t){return rs(i,void 0,void 0,(function(){var e,i;return is(this,(function(o){switch(o.label){case 0:return void 0===t.parent?[2]:[4,n];case 1:return o.sent(),e={name:fs(t.path.join("/")+"/"+t.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}},i={type:"define",metrics:[e]},r.send(i),[2]}}))}))},c=function(t){return rs(i,void 0,void 0,(function(){var e,i,o;return is(this,(function(s){switch(s.label){case 0:return e=d(t),[4,n];case 1:return s.sent(),i=hs(e),o={type:"define",metrics:[i]},r.send(o),void 0!==e.value&&u(e),[2]}}))}))},u=function(t){if(p()){var e=ls(t),n={type:"publish",values:[{name:fs(t.path.join("/")+"/"+t.name),value:e,timestamp:Date.now()}]};return r.send(n)}return Promise.resolve()},d=function(t){var e=ns({},t);return"object"==typeof t.value&&null!==t.value&&(e.value=ns({},t.value)),e},p=function(){var t;try{return(null!==(t=e.canUpdateMetric)&&void 0!==t?t:function(){return!0})()}catch(t){return!0}};return{init:function(i){var s;n=new Promise((function(t){s=t})),(r=t.domain("metrics")).onJoined((function(t){!t&&s&&(s(),s=void 0);var e={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};r.send(e),t&&o(i)})),r.join({system:e.system,service:e.service,instance:e.instance})},createSystem:a,updateSystem:function(e,o){return rs(i,void 0,void 0,(function(){var i,s,a;return is(this,(function(c){switch(c.label){case 0:return[4,n];case 1:return c.sent(),i={type:"publish",values:[{name:fs(e.path.join("/")+"/"+e.name+"/State"),value:{Description:o.description,Value:o.state},timestamp:Date.now()}]},r.send(i),s=vs(e),a={type:"publish",peer_id:t.peerId,values:[{name:"/State",value:{Description:s.description,Value:s.value},timestamp:Date.now()}]},r.send(a),[2]}}))}))},createMetric:c,updateMetric:function(t){return rs(i,void 0,void 0,(function(){var e;return is(this,(function(r){switch(r.label){case 0:return e=d(t),[4,n];case 1:return r.sent(),u(e),[2]}}))}))}}}(t.connection,t):new Ss;var n=new Is(t,e).root;t.disableAutoAppSystem||(n=n.subSystem("App"));var r=function(t){var e,n=t.subSystem("reporting"),r={name:"features"},i=function(t,i,o){if(void 0===t||""===t)throw new Error("name is mandatory");if(void 0===i||""===i)throw new Error("action is mandatory");if(void 0===o||""===o)throw new Error("payload is mandatory");e?e.update({name:t,action:i,payload:o}):e=n.objectMetric(r,{name:t,action:i,payload:o})};return t.featureMetric=i,t}(n);return function(t,e){var n,r;if("undefined"==typeof window)return;var i=null===(r=null===(n=null===window||void 0===window?void 0:window.glue42gd)||void 0===n?void 0:n.metrics)||void 0===r?void 0:r.pagePerformanceMetrics;i&&(e=i);(null==e?void 0:e.enabled)&&new xs(t,e.initialPublishTimeout,e.publishInterval)}(r,t.pagePerformanceMetrics),r};function Cs(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function r(n,r){var i=n instanceof Error?n:new Error(n);if(e)e(i);else{var o='[ERROR] callback-registry: User callback for key "'+r+'" failed: '+i.stack;if(t)switch(t.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(t,e,i){var o=n[t];return o||(o=[],n[t]=o),o.push(e),i&&setTimeout((function(){i.forEach((function(i){var o;if(null===(o=n[t])||void 0===o?void 0:o.includes(e))try{Array.isArray(i)?e.apply(void 0,i):e.apply(void 0,[i])}catch(e){r(e,t)}}))}),0),function(){var r=n[t];r&&(r=r.reduce((function(t,n,r){return n===e&&t.length===r||t.push(n),t}),[]),n[t]=r)}},execute:function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var o=n[t];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var i=n.apply(void 0,e);s.push(i)}catch(e){s.push(void 0),r(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}Cs.default=Cs;var As=Cs,Ts=function(){function t(t,e){var n=this;this.registry=As(),this.gw=t.facade,this.gw.connect((function(t,e){n.messageHandler(e)})).then((function(t){n.client=t}))}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.client?(this.client.send(t),Promise.resolve(void 0)):Promise.reject("not connected")},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"in-memory"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),Ps=function(){function t(t,e){var n=this;this.logger=e,this.registry=As(),this.worker=new SharedWorker(t),this.worker.port.onmessage=function(t){n.messageHandler(t.data)}}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.worker.port.postMessage(t),Promise.resolve()},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"shared-worker"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),Ms=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?void 0:t}},t.isNode=function(){if(void 0!==t._isNode)return t._isNode;if("undefined"!=typeof window)return t._isNode=!1,!1;try{t._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(e){t._isNode=!1}return t._isNode},t}(),js=function(){function t(){var t=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(e,n){t.resolve=function(n){t.resolved=!0,e(n)},t.reject=function(e){t.rejected=!0,n(e)}}))}return t.delay=function(t){return new Promise((function(e){return setTimeout(e,t)}))},Object.defineProperty(t.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),t}(),Es={};function Os(t){var e=Es[t];if(e)return e;var n=[];function r(){return(new Date).getTime()}var i,o,s=r();function a(t,e){var i=null!=e?e:r(),o=0;n.length>0&&(o=i-n[n.length-1].time),n.push({name:t,time:i,diff:o})}a("start",s);var c={get startTime(){return s},get endTime(){return i},get period(){return o},stop:function(){return a("end",i=r()),o=i-s},mark:a,marks:n};return Es[t]=c,c}var Rs=Ms.isNode()?require:function(){},Ns=Ms.isNode()?Rs("ws"):window.WebSocket,Ls=function(){function t(t,e){if(this.startupTimer=Os("connection"),this._running=!0,this._registry=As(),this.wsRequests=[],this.settings=t,this.logger=e,!this.settings.ws)throw new Error("ws is missing")}return t.prototype.onMessage=function(t){return this._registry.add("onMessage",t)},t.prototype.send=function(t,e){var n=this;return new Promise((function(e,r){n.waitForSocketConnection((function(){var i;try{null===(i=n.ws)||void 0===i||i.send(t),e()}catch(t){r(t)}}),r)}))},t.prototype.open=function(){var t=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(e,n){t.waitForSocketConnection(e,n)}))},t.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},t.prototype.onConnectedChanged=function(t){return this._registry.add("onConnectedChanged",t)},t.prototype.name=function(){return"ws "+this.settings.ws},t.prototype.reconnect=function(){var t;null===(t=this.ws)||void 0===t||t.close();var e=new js;return this.waitForSocketConnection((function(){e.resolve()})),e.promise},t.prototype.waitForSocketConnection=function(t,e){var n;e=null!=e?e:function(){},this._running?1!==(null===(n=this.ws)||void 0===n?void 0:n.readyState)?(this.wsRequests.push({callback:t,failed:e}),this.wsRequests.length>1||this.openSocket()):t():e("wait for socket on "+this.settings.ws+" failed - socket closed by user")},t.prototype.openSocket=function(t,e){return rs(this,void 0,void 0,(function(){var n=this;return is(this,(function(r){switch(r.label){case 0:if(this.startupTimer.mark("opening-socket"),void 0===t&&(t=this.settings.reconnectInterval),void 0!==e){if(0===e)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+e+" more times (every "+t+" ms)")}r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return r.sent(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState(),[3,4];case 3:return r.sent(),setTimeout((function(){var r=void 0===e?void 0:e-1;n.openSocket(t,r)}),t),[3,4];case 4:return[2]}}))}))},t.prototype.initiateSocket=function(){var t=this,e=new js;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new Ns(this.settings.ws||""),this.ws.onerror=function(n){var r="";try{r=JSON.stringify(n)}catch(t){var i=new WeakSet;r=JSON.stringify(n,(function(t,e){if("object"==typeof e&&null!==e){if(i.has(e))return;i.add(e)}return e}))}e.reject("error"),t.notifyStatusChanged(!1,r)},this.ws.onclose=function(n){t.logger.info("ws closed "+n),e.reject("closed"),t.notifyStatusChanged(!1)},this.ws.onopen=function(){var n;t.startupTimer.mark("ws-opened"),t.logger.info("ws opened "+(null===(n=t.settings.identity)||void 0===n?void 0:n.application)),e.resolve(),t.notifyStatusChanged(!0)},this.ws.onmessage=function(e){t._registry.execute("onMessage",e.data)},e.promise},t.prototype.notifyForSocketState=function(t){this.wsRequests.forEach((function(e){t?e.failed&&e.failed(t):e.callback()})),this.wsRequests=[]},t.prototype.notifyStatusChanged=function(t,e){this._registry.execute("onConnectedChanged",t,e)},t}();var Ws=1;var Ds,Fs,Bs,qs={nextValue:function(){return(Ws=(9301*Ws+49297)%233280)/233280},seed:function(t){Ws=t}},Gs="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function Hs(){Bs=!1}function Us(t){if(t){if(t!==Ds){if(t.length!==Gs.length)throw new Error("Custom alphabet for shortid must be "+Gs.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+Gs.length+" unique characters. These characters were not unique: "+e.join(", "));Ds=t,Hs()}}else Ds!==Gs&&(Ds=Gs,Hs())}function Vs(){return Bs||(Bs=function(){Ds||Us(Gs);for(var t,e=Ds.split(""),n=[],r=qs.nextValue();e.length>0;)r=qs.nextValue(),t=Math.floor(r*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var Js={characters:function(t){return Us(t),Ds},seed:function(t){qs.seed(t),Fs!==t&&(Hs(),Fs=t)},lookup:function(t){return Vs()[t]},shuffled:Vs},zs="object"==typeof window&&(window.crypto||window.msCrypto);var Ks=function(){if(!zs||!zs.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return zs.getRandomValues(t),48&t[0]};var Ys=function(t,e){for(var n,r=0,i="";!n;)i+=t(e>>4*r&15|Ks()),n=e<Math.pow(16,r+1),r++;return i};var Zs=function(t){var e=Js.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var Xs=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=Js.characters(),n=t.length,r=0;r<n;r++)if(-1===e.indexOf(t[r]))return!1;return!0},$s=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e,n,r=0;function i(){var t="",i=Math.floor(.001*(Date.now()-1459707606518));return i===n?e++:(e=0,n=i),t+=Ys(Js.lookup,6),t+=Ys(Js.lookup,r),e>0&&(t+=Ys(Js.lookup,e)),t+=Ys(Js.lookup,i)}t.exports=i,t.exports.generate=i,t.exports.seed=function(e){return Js.seed(e),t.exports},t.exports.worker=function(e){return r=e,t.exports},t.exports.characters=function(t){return void 0!==t&&Js.characters(t),Js.shuffled()},t.exports.decode=Zs,t.exports.isValid=Xs})),Qs=($s.generate,$s.seed,$s.worker,$s.characters,$s.decode,$s.isValid,$s);function ta(t,e,n,r,i){null==t&&(t="global"),r=r||["success"],i=i||["error"];var o,s=!1,a=!1,c=!1,u=As();e.disconnected((function(){c=!1,n.debug("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),e.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),p(o))})),e.on("success",(function(t){return f(t)})),e.on("error",(function(t){return h(t)})),e.on("result",(function(t){return f(t)})),r&&r.forEach((function(t){e.on(t,(function(t){return f(t)}))})),i&&i.forEach((function(t){e.on(t,(function(t){return h(t)}))}));var d={};function p(e){return o=e,new Promise((function(r,i){if(s)r();else{var o;if("global"===t)o=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining domain "+t),o=v({type:"join",destination:t,domain:"global",options:e});o.then((function(){!function(){n.debug("did join "+t),s=!0;var e=a;a=!1,u.execute("onJoined",e)}(),r()})).catch((function(e){n.debug("error joining "+t+" domain: "+JSON.stringify(e)),i(e)}))}}))}function h(e){if(t===e.domain){var n=e.request_id;if(n){var r=d[n];r&&r.error(e)}}}function f(e){if(e.domain===t){var n=e.request_id;if(n){var r=d[n];r&&r.success(e)}}}function l(){return Qs()}function v(r,i,o){o=o||{},r.request_id=r.request_id||l(),r.domain=r.domain||t,o.skipPeerId||(r.peer_id=e.peerId);var s=r.request_id;return new Promise((function(t,a){d[s]={success:function(e){delete d[s],e._tag=i,t(e)},error:function(t){n.warn("GW error - "+JSON.stringify(t)+" for request "+JSON.stringify(r)),delete d[s],t._tag=i,a(t)}},e.send(r,o).catch((function(t){d[s].error({err:t})}))}))}return{join:p,leave:function(){return"global"===t?Promise.resolve():(n.debug("stopping session "+t+"..."),a=!1,v({type:"leave",destination:t,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})))},onJoined:function(t){return s&&t(!1),u.add("onJoined",t)},onLeft:function(t){return s||t(),u.add("onLeft",t)},send:v,sendFireAndForget:function(n){n.request_id=n.request_id?n.request_id:l(),n.domain=n.domain||t,n.peer_id=e.peerId,e.send(n)},on:function(r,i){e.on(r,(function(e){if(e.domain===t)try{i(e)}catch(t){n.error("Callback  failed: "+t+" \n "+t.stack+" \n msg was: "+JSON.stringify(e),t)}}))},loggedIn:function(t){return e.loggedIn(t)},connected:function(t){return e.connected(t)},disconnected:function(t){return e.disconnected(t)},get peerId(){return e.peerId},get domain(){return t}}}var ea=function(){function t(t,e,n){var r=this;this.connection=t,this.settings=e,this.logger=n,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=As(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],t.disconnected((function(){r.handleDisconnected()})),this.ping()}return Object.defineProperty(t.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.processStringMessage=function(t){var e=this,n=JSON.parse(t,(function(t,n){if("string"!=typeof n)return n;if(n.length<e.dateMinLen)return n;if(n[0]!==e.datePrefixFirstChar)return n;if(n.substring(0,e.datePrefixLen)!==e.datePrefix)return n;try{var r=parseInt(n.substring(e.datePrefixLen,n.length),10);return isNaN(r)?n:new Date(r)}catch(t){return n}}));return{msg:n,msgType:n.type}},t.prototype.createStringMessage=function(t){var e=Date.prototype.toJSON;try{var n=this.datePrefix;return Date.prototype.toJSON=function(){return n+this.getTime()},JSON.stringify(t)}finally{Date.prototype.toJSON=e}},t.prototype.processObjectMessage=function(t){if(!t.type)throw new Error("Object should have type property");return{msg:t,msgType:t.type}},t.prototype.createObjectMessage=function(t){return t},t.prototype.login=function(t,e){return rs(this,void 0,void 0,(function(){var n,r,i,o,s,a,c,u,d,p;return is(this,(function(h){switch(h.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=t,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,n={},this.connection.gatewayToken=t.gatewayToken,!t.gatewayToken)return[3,5];if(!e)return[3,4];h.label=1;case 1:return h.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return u=h.sent(),t.gatewayToken=u,[3,4];case 3:return r=h.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==r?void 0:r.message)||r)),[3,4];case 4:return n.method="gateway-token",n.token=t.gatewayToken,this.connection.gatewayToken=t.gatewayToken,[3,10];case 5:return"sspi"!==t.flowName?[3,9]:(n.provider="win",n.method="access-token",t.flowCallback&&t.sessionId?(i=n,[4,t.flowCallback(t.sessionId,null)]):[3,7]);case 6:return i.token=h.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(t.token)n.method="access-token",n.token=t.token;else{if(!t.username)throw new Error("invalid auth message"+JSON.stringify(t));n.method="secret",n.login=t.username,n.secret=t.password}h.label=10;case 10:o={type:"hello",identity:this.settings.identity,authentication:n},t.sessionId&&(o.request_id=t.sessionId),this.globalDomain=ta("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),s={skipPeerId:!0},this.initialLogin&&(s.retryInterval=this.settings.reconnectInterval,s.maxRetries=this.settings.reconnectAttempts),h.label=11;case 11:h.trys.push([11,19,20,21]),a=void 0,h.label=12;case 12:return[4,this.globalDomain.send(o,void 0,s)];case 13:return"authentication-request"!==(c=h.sent()).type?[3,16]:(u=Buffer.from(c.authentication.token,"base64"),t.flowCallback&&t.sessionId?(d=o.authentication,[4,t.flowCallback(t.sessionId,u)]):[3,15]);case 14:d.token=h.sent().data.toString("base64"),h.label=15;case 15:return o.request_id=t.sessionId,[3,12];case 16:if("welcome"===c.type)return a=c,[3,18];throw"error"===c.type?new Error("Authentication failed: "+c.reason):new Error("Unexpected message type during authentication: "+c.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.info("login successful with peerId "+a.peer_id),this.connection.peerId=a.peer_id,this.connection.resolvedIdentity=a.resolved_identity,this.connection.availableDomains=a.available_domains,a.options&&(this.connection.token=a.options.access_token,this.connection.info=a.options.info),this.setLoggedIn(!0),[2,a.resolved_identity];case 19:throw p=h.sent(),this.logger.error("error sending hello message - "+(p.message||p.msg||p.reason||p),p),p;case 20:return t&&t.flowCallback&&t.sessionId&&t.flowCallback(t.sessionId,null),[7];case 21:return[2]}}))}))},t.prototype.logout=function(){return rs(this,void 0,void 0,(function(){var t;return is(this,(function(e){switch(e.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),t=this.sessions.map((function(t){t.leave()})),[4,Promise.all(t)];case 1:return e.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this._isLoggedIn&&t(),this.registry.add("onLoggedIn",t)},t.prototype.domain=function(t,e,n,r){var i=this.sessions.filter((function(e){return e.domain===t}))[0];return i||(i=ta(t,this.connection,e,n,r),this.sessions.push(i)),i},t.prototype.handleDisconnected=function(){var t=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(t.handleDisconnected,1e3)}))}},t.prototype.setLoggedIn=function(t){this._isLoggedIn=t,this._isLoggedIn&&this.registry.execute("onLoggedIn")},t.prototype.ping=function(){var t=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){t.ping()}),3e4))},t.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(t){return t.token})):Promise.reject(new Error("no global domain session"))},t.prototype.getNewGWToken=function(){if(void 0!==typeof window){var t=window.glue42gd;if(t)return t.getGWToken()}return Promise.reject(new Error("not running in GD"))},t}(),na=function(){function t(t){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var e=0,n=t;e<n.length;e++){var r=n[e];this.specs[r.name]=r,this.specsNames.push(r.name)}}return t.prototype.init=function(t){var e=this;this.connection=t;for(var n=0,r=this.specsNames;n<r.length;n++)for(var i=r[n],o=function(n){var r=s.subsRefCount[n];if(r||(r=0),r+=1,s.subsRefCount[n]=r,r>1)return"continue";var i=t.on(n,(function(t){return e.processMessage(n,t)}));s.subs[n]=i},s=this,a=0,c=this.specs[i].types;a<c.length;a++){o(c[a])}},t.prototype.processMessage=function(t,e){if(!this.isDone&&e)for(var n=0,r=this.specsNames;n<r.length;n++){var i=r[n];if(-1!==this.specs[i].types.indexOf(t)){var o=this.messages[i]||[];this.messages[i]=o,o.push(e)}}},t.prototype.drain=function(t,e){var n;e&&(this.messages[t]||[]).forEach(e),delete this.messages[t];for(var r=0,i=this.specs[t].types;r<i.length;r++){var o=i[r];this.subsRefCount[o]-=1,this.subsRefCount[o]<=0&&(null===(n=this.connection)||void 0===n||n.off(this.subs[o]),delete this.subs[o],delete this.subsRefCount[o])}delete this.specs[t],this.specs.length||(this.isDone=!0)},t}(),ra=function(){function t(t,e){if(this.settings=t,this.logger=e,this.messageHandlers={},this.ids=1,this.registry=As(),this._connected=!1,this.isTrace=!1,(t=t||{}).reconnectAttempts=t.reconnectAttempts||10,t.reconnectInterval=t.reconnectInterval||1e3,t.inproc)this.transport=new Ts(t.inproc,e.subLogger("inMemory"));else if(t.sharedWorker)this.transport=new Ps(t.sharedWorker,e.subLogger("shared-worker"));else{if(void 0===t.ws)throw new Error("No connection information specified");this.transport=new Ls(t,e.subLogger("ws"))}this.isTrace=e.canPublish("trace"),e.info("starting with "+this.transport.name()+" transport"),this.protocol=new ea(this,t,e.subLogger("protocol")),this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this.transport.onMessage(this.handleTransportMessage.bind(this)),t.replaySpecs&&t.replaySpecs.length&&(this.replayer=new na(t.replaySpecs),this.replayer.init(this))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;return null===(t=this.protocol)||void 0===t?void 0:t.protocolVersion},enumerable:!0,configurable:!0}),t.prototype.send=function(t,e){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var n=this.protocol.createObjectMessage(t);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(n)),this.transport.sendObject(n,e)}var r=this.protocol.createStringMessage(t);return this.isTrace&&this.logger.trace(">> "+r),this.transport.send(r,e)},t.prototype.on=function(t,e){t=t.toLowerCase(),void 0===this.messageHandlers[t]&&(this.messageHandlers[t]={});var n=this.ids++;return this.messageHandlers[t][n]=e,{type:t,id:n}},t.prototype.off=function(t){delete this.messageHandlers[t.type.toLowerCase()][t.id]},Object.defineProperty(t.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.connected=function(t){var e=this;return this.protocol.loggedIn((function(){t(e.settings.ws||e.settings.sharedWorker||"")}))},t.prototype.disconnected=function(t){return this.registry.add("disconnected",t)},t.prototype.login=function(t,e){return rs(this,void 0,void 0,(function(){var n;return is(this,(function(r){switch(r.label){case 0:return[4,this.transport.open()];case 1:return r.sent(),Os("connection").mark("transport-opened"),n=this.protocol.login(t,e),Os("connection").mark("protocol-logged-in"),[2,n]}}))}))},t.prototype.logout=function(){return rs(this,void 0,void 0,(function(){return is(this,(function(t){switch(t.label){case 0:return[4,this.protocol.logout()];case 1:return t.sent(),[4,this.transport.close()];case 2:return t.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this.protocol.loggedIn(t)},t.prototype.domain=function(t,e,n){return this.protocol.domain(t,this.logger.subLogger("domain="+t),e,n)},t.prototype.authToken=function(){return this.protocol.authToken()},t.prototype.reconnect=function(){return this.transport.reconnect()},t.prototype.distributeMessage=function(t,e){var n=this,r=this.messageHandlers[e.toLowerCase()];void 0!==r&&Object.keys(r).forEach((function(e){var i=r[e];if(void 0!==i)try{i(t)}catch(t){try{n.logger.error("Message handler failed with "+t.stack,t)}catch(e){console.log("Message handler failed",t)}}}))},t.prototype.handleConnectionChanged=function(t){this._connected!==t&&(this._connected=t,t?this.registry.execute("connected"):this.registry.execute("disconnected"))},t.prototype.handleTransportMessage=function(t){var e;e="string"==typeof t?this.protocol.processStringMessage(t):this.protocol.processObjectMessage(t),this.isTrace&&this.logger.trace("<< "+JSON.stringify(e)),this.distributeMessage(e.msg,e.msgType)},t}(),ia=["trace","debug","info","warn","error","off"],oa=function(){function t(t,e,n){this.name=t,this.parent=e,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=t,this.path=e?e.path+"."+t:t,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}return t.prototype.subLogger=function(e){var n=this.subLoggers.filter((function(t){return t.name===e}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(t){if(t===e)throw new Error("This sub logger name is not allowed.")}));var r=new t(e,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(r),r},t.prototype.publishLevel=function(t){var e;return t&&(this._publishLevel=t),this._publishLevel||(null===(e=this.parent)||void 0===e?void 0:e.publishLevel())},t.prototype.consoleLevel=function(t){var e;return t&&(this._consoleLevel=t),this._consoleLevel||(null===(e=this.parent)||void 0===e?void 0:e.consoleLevel())},t.prototype.log=function(t,e,n){this.publishMessage(e||"info",t,n)},t.prototype.trace=function(t){this.log(t,"trace")},t.prototype.debug=function(t){this.log(t,"debug")},t.prototype.info=function(t){this.log(t,"info")},t.prototype.warn=function(t){this.log(t,"warn")},t.prototype.error=function(t,e){this.log(t,"error")},t.prototype.canPublish=function(t,e){return ia.indexOf(t)>=ia.indexOf(e||this.consoleLevel()||"trace")},t.prototype.publishMessage=function(e,n,r){var i=this.loggerFullName;if("error"===e&&!r){var o=new Error;o.stack&&(n=n+"\n"+o.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(e,this.publishLevel())){var s=t.Interop;if(s)try{s.methods({name:t.InteropMethodName}).length>0&&s.invoke(t.InteropMethodName,{msg:""+n,logger:i,level:e})}catch(t){}}if(this.canPublish(e)){var a="";if(this.includeTimeAndLevel){var c=new Date;a="["+(c.getHours()+":"+c.getMinutes()+":"+c.getSeconds()+":"+c.getMilliseconds())+"] ["+e+"] "}var u=""+a+i+": "+n;switch(e){case"trace":this.logFn.debug(u);break;case"debug":this.logFn.debug?this.logFn.debug(u):this.logFn.log(u);break;case"info":this.logFn.info(u);break;case"warn":this.logFn.warn(u);break;case"error":this.logFn.error(u,r)}}},t.InteropMethodName="T42.AppLogger.Log",t}(),sa="create-context",aa="created",ca="destroyed",ua="context-created",da="context-added",pa="subscribe-context",ha="subscribed-context",fa="unsubscribe-context",la="destroy-context",va="context-destroyed",ya="update-context",ga="context-updated",ma="joined",wa={get name(){return"context"},get types(){return[sa,aa,ca,ua,da,pa,ha,fa,la,va,ya,ga,ma]}},ba="5.2.4";function _a(t,e,n){var r,i,o,s,a;if(Ms.isNode()){var c=process.env._GD_STARTING_CONTEXT_;if(c)try{a=JSON.parse(c)}catch(t){}}var u=function(){var r,i,o,s,c,u,d,p,h,f=t.gateway,l=null!==(r=null==f?void 0:f.protocolVersion)&&void 0!==r?r:3,v=null==f?void 0:f.reconnectInterval,y=null==f?void 0:f.reconnectAttempts,g=null==f?void 0:f.ws,m=null==f?void 0:f.sharedWorker,w=null==f?void 0:f.inproc;n&&(g=n.gwURL),Ms.isNode()&&a&&a.gwURL&&(g=a.gwURL),g||m||w||(g="ws://localhost:8385");var b=function(){if(t.application)return t.application;if(n)return n.applicationName;var e=Qs();if(Ms.isNode())return a?a.applicationConfig.name:"NodeJS"+e;if("undefined"!=typeof window&&"undefined"!=typeof document)return document.title+" ("+e+")";return e}(),_=b;void 0!==n?(u=n.windowId,d=n.pid,n.env&&(p=n.env.env,h=n.env.region),_=null!==(i=n.application)&&void 0!==i?i:"glue-app",c=n.appInstanceId):Ms.isNode()?(d=process.pid,a&&(p=a.env,h=a.region,c=a.instanceId)):u=window.name||Qs();var I=null!==(s=null===(o=t.gateway)||void 0===o?void 0:o.replaySpecs)&&void 0!==s?s:[];return I.push(wa),{identity:{application:_,applicationName:b,windowId:u,instance:c,process:d,region:h,environment:p,api:e.version||ba},reconnectInterval:v,ws:g,sharedWorker:m,inproc:w,protocolVersion:l,reconnectAttempts:y,replaySpecs:I}}();return{bus:null!==(r=t.bus)&&void 0!==r&&r,auth:function(){var e,n;return"string"==typeof t.auth?{token:t.auth}:t.auth?t.auth:Ms.isNode()&&a&&a.gwToken?{gatewayToken:a.gwToken}:(null===(e=t.gateway)||void 0===e?void 0:e.inproc)||(null===(n=t.gateway)||void 0===n?void 0:n.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var e,r,i,o=t.logger,s="warn";return o||(o=s),n&&(i=n.consoleLogLevel),"string"==typeof o?{console:null!=i?i:o,publish:s}:{console:null!==(e=null!=i?i:o.console)&&void 0!==e?e:s,publish:null!==(r=o.publish)&&void 0!==r?r:s}}(),connection:u,metrics:null===(i=t.metrics)||void 0===i||i,contexts:null===(o=t.contexts)||void 0===o||o,version:e.version||ba,libs:null!==(s=e.libs)&&void 0!==s?s:[],customLogger:t.customLogger}}var Ia=function(){function t(t,e,n,r){this.updateCallbacks={},this.contextId=t,this.name=e,this.isAnnounced=n,this.activityId=r,this.context={}}return t.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},t.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},t}();function Sa(t,e,n){try{if((null==n?void 0:n.canPublish("trace"))&&(null==n||n.trace("applying context delta "+JSON.stringify(e)+" on context "+JSON.stringify(t))),!e)return t;if(e.reset)return t=ns({},e.reset);if(t=xa(t,void 0),e.commands){for(var r=0,i=e.commands;r<i.length;r++){var o=i[r];"remove"===o.type?Ta(t,o.path):"set"===o.type&&Aa(t,o.value,o.path)}return t}var s=e.added,a=e.updated,c=e.removed;return s&&Object.keys(s).forEach((function(e){t[e]=s[e]})),a&&Object.keys(a).forEach((function(e){ka(e,t,a)})),c&&c.forEach((function(e){delete t[e]})),t}catch(r){return null==n||n.error("error applying context delta "+JSON.stringify(e)+" on context "+JSON.stringify(t),r),t}}function xa(t,e){if(e=e||new WeakMap,Object(t)!==t)return t;if(t instanceof Set)return new Set(t);if(e.has(t))return e.get(t);var n=t instanceof Date?new Date(t):t instanceof RegExp?new RegExp(t.source,t.flags):t.constructor?new t.constructor:Object.create(null);return e.set(t,n),Object.assign.apply(Object,os([n],Object.keys(t).map((function(n){var r;return(r={})[n]=xa(t[n],e),r}))))}var ka=function(t,e,n){var r=n[t];if(void 0===r)return e;var i=e[t];return i&&r?"string"==typeof i||"number"==typeof i||"boolean"==typeof i||"string"==typeof r||"number"==typeof r||"boolean"==typeof r||Array.isArray(i)||Array.isArray(r)?(e[t]=r,e):(e[t]=Object.assign({},i,r),e):(e[t]=r,e)};function Ca(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;for(var n in t)if(t.hasOwnProperty(n)){if(!e.hasOwnProperty(n))return!1;if(t[n]!==e[n]){if("object"!=typeof t[n])return!1;if(!Ca(t[n],e[n]))return!1}}for(var n in e)if(e.hasOwnProperty(n)&&!t.hasOwnProperty(n))return!1;return!0}function Aa(t,e,n){var r,i=n.split(".");for(r=0;r<i.length-1;r++)t[i[r]]||(t[i[r]]={}),"object"!=typeof t[i[r]]&&(t[i[r]]={}),t=t[i[r]];t[i[r]]=e}function Ta(t,e){var n,r=e.split(".");for(n=0;n<r.length-1;n++){if(!t[r[n]])return;t=t[r[n]]}delete t[r[n]]}var Pa,Ma=function(){function t(t){var e,n=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._protocolVersion=void 0,this._connection=t.connection,this._logger=t.logger,this._gw3Session=this._connection.domain("global",[ua,ha,va,ga]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(e=this._connection.replayer)||void 0===e||e.drain(wa.name,(function(t){var e=t.type;e&&(e===ua||e===da||e===aa?n.handleContextCreatedMessage(t):e===ha||e===ga||e===ma?n.handleContextUpdatedMessage(t):e!==va&&e!==ca||n.handleContextDestroyedMessage(t))}))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;if(!this._protocolVersion){var e=this._connection.availableDomains.find((function(t){return"context"===t.uri}));this._protocolVersion=null!==(t=null==e?void 0:e.version)&&void 0!==t?t:1}return this._protocolVersion},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"setPathSupported",{get:function(){return this.protocolVersion>=2},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){for(var t=0,e=this._gw3Subscriptions;t<e.length;t++){var n=e[t];this._connection.off(n)}for(var r in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(r)&&delete this._contextNameToData[r]},t.prototype.createContext=function(t,e){var n=this;return this._gw3Session.send({type:sa,domain:"global",name:t,data:e,lifetime:"retained"}).then((function(r){n._contextNameToId[t]=r.context_id,n._contextIdToName[r.context_id]=t;var i=n._contextNameToData[t]||new Ia(r.context_id,t,!0,void 0);return i.isAnnounced=!0,i.name=t,i.contextId=r.context_id,i.context=e,n._contextNameToData[t]=i,r.context_id}))},t.prototype.all=function(){var t=this;return Object.keys(this._contextNameToData).filter((function(e){return t._contextNameToData[e].isAnnounced}))},t.prototype.update=function(t,e){var n;return rs(this,void 0,void 0,(function(){var r,i,o,s=this;return is(this,(function(a){switch(a.label){case 0:return(r=this._contextNameToData[t])&&r.isAnnounced?(i=r.context,r.hasCallbacks()?[3,2]:[4,this.get(r.name)]):[2,this.createContext(t,e)];case 1:i=a.sent(),a.label=2;case 2:return o=2===this.protocolVersion?this.calculateContextDeltaV2(i,e):this.calculateContextDeltaV1(i,e),Object.keys(o.added).length||Object.keys(o.updated).length||o.removed.length||(null===(n=o.commands)||void 0===n?void 0:n.length)?[2,this._gw3Session.send({type:ya,domain:"global",context_id:r.contextId,delta:o},{},{skipPeerId:!1}).then((function(t){s.handleUpdated(r,o,{updaterId:t.peer_id})}))]:[2,Promise.resolve()]}}))}))},t.prototype.set=function(t,e){var n=this,r=this._contextNameToData[t];return r&&r.isAnnounced?this._gw3Session.send({type:ya,domain:"global",context_id:r.contextId,delta:{reset:e}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(r,{reset:e,added:{},removed:[],updated:{}},{updaterId:t.peer_id})})):this.createContext(t,e)},t.prototype.setPath=function(t,e,n){return this.setPathSupported?this.setPaths(t,[{path:e,value:n}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")},t.prototype.setPaths=function(t,e){var n=this;if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");var r=this._contextNameToData[t];if(!r||!r.isAnnounced){for(var i={},o=0,s=e;o<s.length;o++){Aa(i,(d=s[o]).value,d.path)}return this.createContext(t,i)}for(var a=[],c=0,u=e;c<u.length;c++){var d;null===(d=u[c]).value?a.push({type:"remove",path:d.path}):a.push({type:"set",path:d.path,value:d.value})}return this._gw3Session.send({type:ya,domain:"global",context_id:r.contextId,delta:{commands:a}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(r,{added:{},removed:[],updated:{},commands:a},{updaterId:t.peer_id})}))},t.prototype.get=function(t){var e,n=this,r=this._contextNameToData[t];if(!r||!r.isAnnounced)return Promise.resolve({});if(r&&!r.hasCallbacks())return new Promise((function(e,r){return rs(n,void 0,void 0,(function(){var n=this;return is(this,(function(r){return this.subscribe(t,(function(t,r,i,o){n.unsubscribe(o),e(t)})),[2]}))}))}));var i=null!==(e=null==r?void 0:r.context)&&void 0!==e?e:{};return Promise.resolve(i)},t.prototype.subscribe=function(t,e){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var r=this._contextNameToData[t];if(!r||!r.isAnnounced)return r=r||new Ia(void 0,t,!1,void 0),this._contextNameToData[t]=r,r.updateCallbacks[n]=e,Promise.resolve(n);var i,o=r.hasCallbacks();return r.updateCallbacks[n]=e,o||r.joinedActivity||r.context&&r.sentExplicitSubscription?(e(i=xa(r.context),i,[],n),Promise.resolve(n)):this.sendSubscribe(r).then((function(){return n}))},t.prototype.unsubscribe=function(t){for(var e=0,n=Object.keys(this._contextNameToData);e<n.length;e++){var r=n[e],i=(this._contextNameToId[r],this._contextNameToData[r]);if(!i)return;var o=i.hasCallbacks();delete i.updateCallbacks[t],i.isAnnounced&&o&&!i.hasCallbacks()&&i.sentExplicitSubscription&&this.sendUnsubscribe(i),i.isAnnounced||i.hasCallbacks()||delete this._contextNameToData[r]}},t.prototype.destroy=function(t){var e=this._contextNameToData[t];return e?this._gw3Session.send({type:la,domain:"global",context_id:e.contextId}).then((function(t){})):Promise.reject("context with "+t+" does not exist")},t.prototype.handleUpdated=function(t,e,n){var r=t.context;t.context=Sa(t.context,e,this._logger),this._contextNameToData[t.name]!==t||Ca(r,t.context)||this.invokeUpdateCallbacks(t,e,n)},t.prototype.subscribeToContextCreatedMessages=function(){for(var t=0,e=[da,ua,aa];t<e.length;t++){var n=e[t],r=this._connection.on(n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(r)}},t.prototype.handleContextCreatedMessage=function(t){var e=t.type;e===aa?(this._contextNameToId[t.activity_id]=t.context_id,this._contextIdToName[t.context_id]=t.activity_id):e===da&&(this._contextNameToId[t.name]=t.context_id,this._contextIdToName[t.context_id]=t.name);var n=this._contextIdToName[t.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+t.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+t.context_id);var r=this._contextNameToData[n];if(r){if(r.isAnnounced)return;if(!r.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");r.isAnnounced=!0,r.contextId=t.context_id,r.activityId=t.activity_id,r.sentExplicitSubscription||this.sendSubscribe(r)}else this._contextNameToData[n]=r=new Ia(t.context_id,n,!0,t.activity_id)},t.prototype.subscribeToContextUpdatedMessages=function(){for(var t=0,e=[ga,ha,ma];t<e.length;t++){var n=e[t],r=this._connection.on(n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(r)}},t.prototype.handleContextUpdatedMessage=function(t){var e=t.type,n=t.context_id,r=this._contextNameToData[this._contextIdToName[n]],i=!r||!r.isAnnounced;if(e===ma)r?(r.contextId=n,r.isAnnounced=!0,r.activityId=t.activity_id):(r=new Ia(n,t.activity_id,!0,t.activity_id),this._contextNameToData[t.activity_id]=r,this._contextIdToName[n]=t.activity_id,this._contextNameToId[t.activity_id]=n),r.joinedActivity=!0;else if(!r||!r.isAnnounced)return void(e===ha?((r=r||new Ia(n,t.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[t.name]=r,this._contextIdToName[n]=t.name,this._contextNameToId[t.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var o=r.context;if(e===ha)r.context=t.data||{};else if(e===ma)r.context=t.context_snapshot||{};else{if(e!==ga)throw new Error("Unrecognized context update message "+e);r.context=Sa(r.context,t.delta,this._logger)}!i&&Ca(r.context,o)&&e!==ha||this.invokeUpdateCallbacks(r,t.delta,{updaterId:t.updater_id})},t.prototype.invokeUpdateCallbacks=function(t,e,n){if((e=e||{added:{},updated:{},reset:{},removed:[]}).commands){e.added=e.updated=e.reset={},e.removed=[];for(var r=0,i=e.commands;r<i.length;r++){var o=i[r];"remove"===o.type?(-1===o.path.indexOf(".")&&e.removed.push(o.path),Aa(e.updated,null,o.path)):"set"===o.type&&Aa(e.updated,o.value,o.path)}}for(var s in t.updateCallbacks)if(t.updateCallbacks.hasOwnProperty(s))try{(0,t.updateCallbacks[s])(xa(t.context),Object.assign({},e.added||{},e.updated||{},e.reset||{}),e.removed,parseInt(s,10),n)}catch(t){this._logger.debug("callback error: "+JSON.stringify(t))}},t.prototype.subscribeToContextDestroyedMessages=function(){for(var t=0,e=[va,ca];t<e.length;t++){var n=e[t],r=this._connection.on(n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(r)}},t.prototype.handleContextDestroyedMessage=function(t){var e,n;if(t.type===ca){if(n=t.activity_id,!(e=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+t.activity_id)}else if(e=t.context_id,!(n=this._contextIdToName[e]))return void this._logger.error("Received 'destroyed' for unknown context: "+t.context_id);delete this._contextIdToName[e],delete this._contextNameToId[n];var r=this._contextNameToData[n];delete this._contextNameToData[n],r&&r.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+e)},t.prototype.sendSubscribe=function(t){return t.sentExplicitSubscription=!0,this._gw3Session.send({type:pa,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.sendUnsubscribe=function(t){return t.sentExplicitSubscription=!1,this._gw3Session.send({type:fa,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.calculateContextDeltaV1=function(t,e){var n={added:{},updated:{},removed:[],reset:void 0};if(t)for(var r=0,i=Object.keys(t);r<i.length;r++){var o=i[r];-1===Object.keys(e).indexOf(o)||null===e[o]||Ca(t[o],e[o])||(n.updated[o]=e[o])}for(var s=0,a=Object.keys(e);s<a.length;s++){o=a[s];t&&-1!==Object.keys(t).indexOf(o)?null===e[o]&&n.removed.push(o):null!==e[o]&&(n.added[o]=e[o])}return n},t.prototype.calculateContextDeltaV2=function(t,e){for(var n,r,i={added:{},updated:{},removed:[],reset:void 0,commands:[]},o=0,s=Object.keys(e);o<s.length;o++){var a=s[o];if(null!==e[a])Ca(t?t[a]:null,e[a])||null===(n=i.commands)||void 0===n||n.push({type:"set",path:a,value:e[a]});else null===(r=i.commands)||void 0===r||r.push({type:"remove",path:a})}return i},t}(),ja=function(){function t(t){this._bridge=new Ma(t)}return t.prototype.all=function(){return this._bridge.all()},t.prototype.update=function(t,e){return this.checkName(t),this.checkData(e),this._bridge.update(t,e)},t.prototype.set=function(t,e){return this.checkName(t),this.checkData(e),this._bridge.set(t,e)},t.prototype.setPath=function(t,e,n){return this.checkName(t),this.checkPath(e),""===e?(this.checkData(n),this.set(t,n)):this._bridge.setPath(t,e,n)},t.prototype.setPaths=function(t,e){if(this.checkName(t),!Array.isArray(e))throw new Error("Please provide the paths as an array of PathValues!");for(var n=0,r=e;n<r.length;n++){var i=r[n],o=i.path,s=i.value;this.checkPath(o),""===o&&this.checkData(s)}return this._bridge.setPaths(t,e)},t.prototype.subscribe=function(t,e){var n=this;if(this.checkName(t),"function"!=typeof e)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(t,(function(t,r,i,o,s){return e(t,r,i,(function(){return n._bridge.unsubscribe(o)}),s)})).then((function(t){return function(){n._bridge.unsubscribe(t)}}))},t.prototype.get=function(t){return this.checkName(t),this._bridge.get(t)},t.prototype.ready=function(){return Promise.resolve(this)},t.prototype.destroy=function(t){return this.checkName(t),this._bridge.destroy(t)},Object.defineProperty(t.prototype,"setPathSupported",{get:function(){return this._bridge.setPathSupported},enumerable:!0,configurable:!0}),t.prototype.checkName=function(t){if("string"!=typeof t||""===t)throw new Error("Please provide the name as a non-empty string!")},t.prototype.checkPath=function(t){if("string"!=typeof t)throw new Error("Please provide the path as a dot delimited string!")},t.prototype.checkData=function(t){if("object"!=typeof t)throw new Error("Please provide the data as an object!")},t}();function Ea(t,e,n){return"function"!=typeof e&&"function"!=typeof n?t:("function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n))}function Oa(t,e,n){var r;return void 0===t&&(t=0),e.finally((function(){r&&clearTimeout(r)})),new Promise((function(e,i){r=setTimeout((function(){return i(n)}),t)}))}!function(t){t[t.Success=0]="Success",t[t.Error=1]="Error"}(Pa||(Pa={}));var Ra=function(){function t(t,e,n,r){this.protocol=t,this.repo=e,this.instance=n,this.configuration=r}return t.prototype.subscribe=function(t,e,n,r,i){var o=this,s=function(t,n,r,s){var a;e.methodResponseTimeout=null!==(a=e.methodResponseTimeout)&&void 0!==a?a:e.waitTimeoutMs,o.protocol.client.subscribe(n,e,t,r,s,i)};return Ea(new Promise((function(n,r){var i,a=function(t){n(t)},c=function(t){r(t)};if(t)if((i="string"==typeof t?{name:t}:t).name){void 0===e&&(e={});var u=e.target;if(void 0===u&&(u="best"),"string"!=typeof u||"all"===u||"best"===u){void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=e.method_response_timeout,void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=o.configuration.methodResponseTimeout)),void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=e.wait_for_method_timeout,void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=o.configuration.waitTimeoutMs));var d=0,p=o.getServerMethodsByFilterAndTarget(i,u);if(p.length>0)s(p,p[0].methods[0],a,c);else{var h=function(){if(u&&e.waitTimeoutMs)if(d+=500,(p=o.getServerMethodsByFilterAndTarget(i,u)).length>0){var n=p[0].methods[0];s(p,n,a,c)}else if(d>=e.waitTimeoutMs){s(p,"string"==typeof t?{name:t}:t,a,c)}else setTimeout(h,500)};setTimeout(h,500)}}else r(new Error('"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else r("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");else r("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.")})),n,r)},t.prototype.servers=function(t){var e=void 0===t?void 0:ns({},t);return this.getServers(e).map((function(t){return t.server.instance}))},t.prototype.methods=function(t){return t="string"==typeof t?{name:t}:ns({},t),this.getMethods(t)},t.prototype.methodsForInstance=function(t){return this.getMethodsForInstance(t)},t.prototype.methodAdded=function(t){return this.repo.onMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.repo.onMethodRemoved(t)},t.prototype.serverAdded=function(t){return this.repo.onServerAdded(t)},t.prototype.serverRemoved=function(t){return this.repo.onServerRemoved((function(e,n){t(e,n)}))},t.prototype.serverMethodAdded=function(t){return this.repo.onServerMethodAdded((function(e,n){t({server:e,method:n})}))},t.prototype.serverMethodRemoved=function(t){return this.repo.onServerMethodRemoved((function(e,n){t({server:e,method:n})}))},t.prototype.invoke=function(t,e,n,r,i,o){return rs(this,void 0,void 0,(function(){var s=this;return is(this,(function(a){return[2,Ea(function(){return rs(s,void 0,void 0,(function(){var i,o,s,a,c,u,d,p,h,f,l=this;return is(this,(function(v){switch(v.label){case 0:if(!(i="string"==typeof t?{name:t}:ns({},t)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.")];if(e||(e={}),n||(n="best"),"string"==typeof n&&"all"!==n&&"best"!==n&&"skipMine"!==n)return[2,Promise.reject(new Error('"'+n+'" is not a valid target. Valid targets are "all" and "best".'))];if(r||(r={}),void 0===r.methodResponseTimeoutMs&&(r.methodResponseTimeoutMs=r.method_response_timeout,void 0===r.methodResponseTimeoutMs&&(r.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===r.waitTimeoutMs&&(r.waitTimeoutMs=r.wait_for_method_timeout,void 0===r.waitTimeoutMs&&(r.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==r.waitTimeoutMs&&"number"!=typeof r.waitTimeoutMs)return[2,Promise.reject(new Error('"'+r.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof e)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+i.name))];if(0!==(o=this.getServerMethodsByFilterAndTarget(i,n)).length)return[3,4];v.label=1;case 1:return v.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(i,n,r)];case 2:return o=v.sent(),[3,4];case 3:return v.sent(),s=ns(ns({},i),{getServers:function(){return[]},supportsStreaming:!1,objectTypes:null!==(f=i.objectTypes)&&void 0!==f?f:[]}),a={method:s,called_with:e,message:"Can not find a method matching "+JSON.stringify(t)+" with server filter "+JSON.stringify(n),executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(a)];case 4:return c=r.methodResponseTimeoutMs,u=r,d=o.map((function(t){var n=Qs(),r=t.methods[0],i=t.server,o=l.protocol.client.invoke(n,r,e,i,u);return Promise.race([o,Oa(c,o,{invocationId:n,message:"Invocation timeout ("+c+" ms) reached for method name: "+(null==r?void 0:r.name)+", target instance: "+JSON.stringify(i.instance)+", options: "+JSON.stringify(u),status:Pa.Error})])})),[4,Promise.all(d)];case 5:return p=v.sent(),h=this.getInvocationResultObj(p,i,e),p.every((function(t){return t.status===Pa.Error}))?[2,Promise.reject(h)]:[2,h]}}))}))}(),i,o)]}))}))},t.prototype.getInvocationResultObj=function(t,e,n){var r=t.filter((function(t){return t.status===Pa.Success})).reduce((function(t,r){return t=os(t,[{executed_by:r.instance,returned:r.result,called_with:n,method:e,message:r.message,status:r.status}])}),[]),i=t.filter((function(t){return t.status===Pa.Error})).reduce((function(t,r){return t=os(t,[{executed_by:r.instance,called_with:n,name:e.name,message:r.message}])}),[]),o=t[0];return{method:e,called_with:n,returned:o.result,executed_by:o.instance,all_return_values:r,all_errors:i,message:o.message,status:o.status}},t.prototype.tryToAwaitForMethods=function(t,e,n){var r=this;return new Promise((function(i,o){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=r.getServerMethodsByFilterAndTarget(t,e);if(c.length>0)clearInterval(a),i(c);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(a),void o()}),500);else o()}))},t.prototype.filterByTarget=function(t,e){var n=this;if("string"!=typeof t){return(Array.isArray(t)?t:[t]).reduce((function(t,r){var i=e.filter((function(t){return n.instanceMatch(r,t.server.instance)}));return t.concat(i)}),[])}if("all"===t)return os(e);if("best"===t){var r=e.find((function(t){return t.server.instance.isLocal}));if(r)return[r];if(void 0!==e[0])return[e[0]]}else if("skipMine"===t)return e.filter((function(t){return t.server.instance.peerId!==n.instance.peerId}));return[]},t.prototype.instanceMatch=function(t,e){return this.containsProps(t,e)},t.prototype.methodMatch=function(t,e){return this.containsProps(t,e)},t.prototype.containsProps=function(t,e){return Object.keys(t).filter((function(e){return void 0!==t[e]&&"function"!=typeof t[e]&&"object_types"!==e&&"display_name"!==e&&"id"!==e&&"gatewayId"!==e&&"identifier"!==e&&"_"!==e[0]})).reduce((function(n,r){var i=t[r],o=e[r];if("objectTypes"===r){(i.length>o.length||!1===function(t,e){var n=t.reduce((function(t,e){return t[e]=!1,t}),{});e.forEach((function(t){void 0!==n[t]&&(n[t]=!0)}));return Object.keys(n).reduce((function(t,e){return n[e]||(t=!1),t}),!0)}(i,o))&&(n=!1)}else String(i).toLowerCase()!==String(o).toLowerCase()&&(n=!1);return n}),!0)},t.prototype.getMethods=function(t){var e=this;return void 0===t?this.repo.getMethods():this.repo.getMethods().filter((function(n){return e.methodMatch(t,n)}))},t.prototype.getMethodsForInstance=function(t){var e=this,n=this.repo.getServers().filter((function(n){return e.instanceMatch(t,n.instance)}));if(0===n.length)return[];var r={};return 1===n.length?r=n[0].methods:n.forEach((function(t){Object.keys(t.methods).forEach((function(e){var n=t.methods[e];r[n.identifier]=n}))})),Object.keys(r).map((function(t){return r[t]}))},t.prototype.getServers=function(t){var e=this,n=this.repo.getServers();return void 0===t?n.map((function(t){return{server:t,methods:[]}})):n.reduce((function(n,r){var i=e.repo.getServerMethodsById(r.id).filter((function(n){return e.methodMatch(t,n)}));return i.length>0&&n.push({server:r,methods:i}),n}),[])},t.prototype.getServerMethodsByFilterAndTarget=function(t,e){var n=this.getServers(t);return this.filterByTarget(e,n)},t}(),Na=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.subscription=n}return Object.defineProperty(t.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),t.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},t.prototype.push=function(t){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,t)},t}(),La=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return t.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},t.prototype.acceptOnBranch=function(t){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,t)},t.prototype.reject=function(t){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,t)},t}(),Wa=function(){function t(t,e){var n=this;this.protocol=t,this.server=e,t.server.onSubRequest((function(t,e){return n.handleSubRequest(t,e)})),t.server.onSubAdded((function(t,e){return n.handleSubAdded(t,e)})),t.server.onSubRemoved((function(t,e){return n.handleSubRemoved(t,e)}))}return t.prototype.handleSubRequest=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRequestHandler){var n=new La(this.protocol,e,t);e.streamCallbacks.subscriptionRequestHandler(n)}},t.prototype.handleSubAdded=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionAddedHandler){var n=new Na(this.protocol,e,t);e.streamCallbacks.subscriptionAddedHandler(n)}},t.prototype.handleSubRemoved=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRemovedHandler){var n=new Na(this.protocol,e,t);e.streamCallbacks.subscriptionRemovedHandler(n)}},t}(),Da=function(){function t(t,e,n){this.key=t,this.protocol=e,this.repoMethod=n}return t.prototype.subscriptions=function(){var t=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(e){return new Na(t.protocol,t.repoMethod,e)}))},t.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},t.prototype.push=function(t){this.protocol.server.pushData(this.repoMethod,t,[this.key])},t}(),Fa=function(){function t(t,e,n){this._protocol=t,this._repoMethod=e,this._server=n,this.name=this._repoMethod.definition.name}return t.prototype.branches=function(t){var e=this,n=this._protocol.server.getBranchList(this._repoMethod);return t?n.indexOf(t)>-1?new Da(t,this._protocol,this._repoMethod):void 0:n.map((function(t){return new Da(t,e._protocol,e._repoMethod)}))},t.prototype.branch=function(t){return this.branches(t)},t.prototype.subscriptions=function(){var t=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(e){return new Na(t._protocol,t._repoMethod,e)}))},Object.defineProperty(t.prototype,"definition",{get:function(){var t=this._repoMethod.definition;return{accepts:t.accepts,description:t.description,displayName:t.displayName,name:t.name,objectTypes:t.objectTypes,returns:t.returns,supportsStreaming:t.supportsStreaming}},enumerable:!0,configurable:!0}),t.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},t.prototype.push=function(t,e){if("string"!=typeof e&&!Array.isArray(e)&&void 0!==e)throw new Error("invalid branches should be string or string array");if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,t,e)},t.prototype.updateRepoMethod=function(t){this._repoMethod=t},t}(),Ba=function(){function t(t,e){this.protocol=t,this.serverRepository=e,this.invocations=0,this.currentlyUnregistering={},this.streaming=new Wa(t,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return t.prototype.createStream=function(t,e,n,r,i){var o=this;return Ea(new Promise((function(n,r){if(t){var s;if(!(s="string"==typeof t?{name:""+t}:ns({},t)).name)return r("The “name” property is required for the “streamDefinition” object and must be unique. Stream definition: "+JSON.stringify(s));if(o.serverRepository.getList().some((function(t){return t.definition.name===s.name})))return r('A stream with the name "'+s.name+'" already exists! Please, provide a unique name for the stream.');s.supportsStreaming=!0,e||(e={}),"function"!=typeof e.subscriptionRequestHandler&&(e.subscriptionRequestHandler=function(t){t.accept()});var a=o.serverRepository.add({definition:s,streamCallbacks:e,protocolState:{}});o.protocol.server.createStream(a).then((function(){var t;i?(t=i,i.updateRepoMethod(a)):t=new Fa(o.protocol,a,o),a.stream=t,n(t)})).catch((function(t){a.repoId&&o.serverRepository.remove(a.repoId),r(t)}))}else r("The stream name must be unique! Please, provide either a unique string for a stream name to “glue.interop.createStream()” or a “methodDefinition” object with a unique “name” property for the stream.")})),n,r)},t.prototype.register=function(t,e){var n=this;if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var r=function(t,r){return rs(n,void 0,void 0,(function(){var n,i,o;return is(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),(n=e(t.args,t.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return i=s.sent(),r(void 0,i),[3,3];case 2:r(void 0,n),s.label=3;case 3:return[3,5];case 4:return(o=s.sent())||(o=""),r(o,o),[3,5];case 5:return[2]}}))}))};return r.userCallback=e,this.registerCore(t,r)},t.prototype.registerAsync=function(t,e){if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var n=function(t,n){try{var r=!1,i=function(t){r||n(void 0,t),r=!0},o=function(t){r||(t||(t=""),n(t,t)),r=!0},s=e(t.args,t.instance,i,o);s&&"function"==typeof s.then&&s.then(i).catch(o)}catch(t){n(t,void 0)}};return n.userCallbackAsync=e,this.registerCore(t,n)},t.prototype.unregister=function(t,e){return void 0===e&&(e=!1),rs(this,void 0,void 0,(function(){var n,r;return is(this,(function(i){switch(i.label){case 0:return void 0===t?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a “name” property.")]:"function"!=typeof t?[3,2]:[4,this.unregisterWithPredicate(t,e)];case 1:return i.sent(),[2];case 2:return void 0===(n="string"==typeof t?{name:t}:t).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(r=this.serverRepository.getList().find((function(t){return t.definition.name===n.name&&(t.definition.supportsStreaming||!1)===e})))?[4,this.removeMethodsOrStreams([r])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return i.sent(),[2]}}))}))},t.prototype.unregisterWithPredicate=function(t,e){return rs(this,void 0,void 0,(function(){var n;return is(this,(function(r){switch(r.label){case 0:return(n=this.serverRepository.getList().filter((function(e){return t(e.definition)})).filter((function(t){return(t.definition.supportsStreaming||!1)===e})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(e?"stream":"method")+" matching the specified condition!")];case 1:return r.sent(),[2]}}))}))},t.prototype.removeMethodsOrStreams=function(t){var e=this,n=[];return t.forEach((function(t){var r=e.protocol.server.unregister(t).then((function(){t.repoId&&e.serverRepository.remove(t.repoId)}));n.push(r),e.addAsCurrentlyUnregistering(t.definition.name,r)})),Promise.all(n)},t.prototype.addAsCurrentlyUnregistering=function(t,e){return rs(this,void 0,void 0,(function(){var n,r=this;return is(this,(function(i){return n=new Promise((function(t){return setTimeout(t,5e3)})),this.currentlyUnregistering[t]=Promise.race([e,n]).then((function(){delete r.currentlyUnregistering[t]})),[2]}))}))},t.prototype.registerCore=function(t,e){return rs(this,void 0,void 0,(function(){var n,r,i,o=this;return is(this,(function(s){switch(s.label){case 0:return(n="string"==typeof t?{name:""+t}:ns({},t)).name?(r=this.currentlyUnregistering[n.name])?[4,r]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the “name” property in the “methodDefinition” object: "+JSON.stringify(t))];case 1:s.sent(),s.label=2;case 2:return this.serverRepository.getList().some((function(t){return t.definition.name===n.name}))?[2,Promise.reject('A method with the name "'+n.name+'" already exists! Please, provide a unique name for the method.')]:n.supportsStreaming?[2,Promise.reject("When you create methods with “glue.interop.register()” or “glue.interop.registerAsync()” the property “supportsStreaming” cannot be “true”. If you want “"+n.name+"” to be a stream, please use the “glue.interop.createStream()” method.")]:(i=this.serverRepository.add({definition:n,theFunction:e,protocolState:{}}),[2,this.protocol.server.register(i).catch((function(t){throw(null==i?void 0:i.repoId)&&o.serverRepository.remove(i.repoId),t}))])}}))}))},t.prototype.onMethodInvoked=function(t,e,n){var r=this;t&&t.theFunction&&t.theFunction(n,(function(n,i){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(t){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}i?("object"!=typeof i||Array.isArray(i))&&(i={_value:i}):i={},r.protocol.server.methodInvocationResult(t,e,n,i)}))},t}(),qa=function(){function t(t,e){var n=this;this.wrapped={getMethods:Ga,getStreams:Ha},t&&this.refreshWrappedObject(t),e&&(e.loggedIn((function(){n.refresh(e)})),this.refresh(e))}return t.prototype.unwrap=function(){return this.wrapped},t.prototype.refresh=function(t){if(t){var e=null==t?void 0:t.resolvedIdentity,n=Object.assign({},null!=e?e:{},{peerId:null==t?void 0:t.peerId});this.refreshWrappedObject(n)}},t.prototype.refreshWrappedObject=function(t){var e,n,r;this.wrapped.user=t.user,this.wrapped.instance=t.instance,this.wrapped.application=null!==(e=t.application)&&void 0!==e?e:Qs(),this.wrapped.applicationName=t.applicationName,this.wrapped.pid=null!==(r=null!==(n=t.pid)&&void 0!==n?n:t.process)&&void 0!==r?r:Math.floor(1e10*Math.random()),this.wrapped.machine=t.machine,this.wrapped.environment=t.environment,this.wrapped.region=t.region,this.wrapped.windowId=t.windowId,this.wrapped.isLocal=!0,this.wrapped.api=t.api,this.wrapped.service=t.service,this.wrapped.peerId=t.peerId},t}();function Ga(){var t;return null===(t=qa.API)||void 0===t?void 0:t.methodsForInstance(this)}function Ha(){var t;return null===(t=qa.API)||void 0===t?void 0:t.methodsForInstance(this).filter((function(t){return t.supportsStreaming}))}var Ua=function(){function t(t){this.logger=t,this.servers={},this.methodsCount={},this.callbacks=As()}return t.prototype.addServer=function(t,e){this.logger.debug("adding server "+e);var n=this.servers[e];if(n)return n.id;var r=new qa(t),i={id:e,methods:{},instance:r.unwrap(),wrapper:r};return this.servers[e]=i,this.callbacks.execute("onServerAdded",i.instance),e},t.prototype.removeServerById=function(t,e){var n=this,r=this.servers[t];r?(this.logger.debug("removing server "+t),Object.keys(r.methods).forEach((function(e){n.removeServerMethod(t,e)})),delete this.servers[t],this.callbacks.execute("onServerRemoved",r.instance,e)):this.logger.warn("not aware of server "+t+", my state "+JSON.stringify(Object.keys(this.servers)))},t.prototype.addServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");if(!n.methods[e.id]){var r=this.createMethodIdentifier(e),i=this,o={identifier:r,gatewayId:e.id,name:e.name,displayName:e.display_name,description:e.description,version:e.version,objectTypes:e.object_types||[],accepts:e.input_signature,returns:e.result_signature,supportsStreaming:void 0!==e.flags&&e.flags.streaming,getServers:function(){return i.getServersByMethod(r)}};return o.object_types=o.objectTypes,o.display_name=o.displayName,o.version=o.version,n.methods[e.id]=o,this.methodsCount[r]||(this.methodsCount[r]=0,this.callbacks.execute("onMethodAdded",o)),this.methodsCount[r]=this.methodsCount[r]+1,this.callbacks.execute("onServerMethodAdded",n.instance,o),o}},t.prototype.removeServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");var r=n.methods[e];delete n.methods[e],this.methodsCount[r.identifier]=this.methodsCount[r.identifier]-1,0===this.methodsCount[r.identifier]&&this.callbacks.execute("onMethodRemoved",r),this.callbacks.execute("onServerMethodRemoved",n.instance,r)},t.prototype.getMethods=function(){var t=this,e={};return Object.keys(this.servers).forEach((function(n){var r=t.servers[n];Object.keys(r.methods).forEach((function(t){var n=r.methods[t];e[n.identifier]=n}))})),Object.keys(e).map((function(t){return e[t]}))},t.prototype.getServers=function(){var t=this,e=[];return Object.keys(this.servers).forEach((function(n){var r=t.servers[n];e.push(r)})),e},t.prototype.getServerMethodsById=function(t){var e=this.servers[t];return Object.keys(e.methods).map((function(t){return e.methods[t]}))},t.prototype.onServerAdded=function(t){var e=this.callbacks.add("onServerAdded",t),n=this.getServers().map((function(t){return t.instance}));return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onMethodAdded=function(t){var e=this.callbacks.add("onMethodAdded",t),n=this.getMethods();return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onServerMethodAdded=function(t){var e=this.callbacks.add("onServerMethodAdded",t),n=!1,r=this.getServers();return setTimeout((function(){r.forEach((function(e){var r=e.methods;Object.keys(r).forEach((function(i){n||t(e.instance,r[i])}))}))}),0),function(){n=!0,e()}},t.prototype.onMethodRemoved=function(t){return this.callbacks.add("onMethodRemoved",t)},t.prototype.onServerRemoved=function(t){return this.callbacks.add("onServerRemoved",t)},t.prototype.onServerMethodRemoved=function(t){return this.callbacks.add("onServerMethodRemoved",t)},t.prototype.getServerById=function(t){return this.servers[t]},t.prototype.reset=function(){var t=this;Object.keys(this.servers).forEach((function(e){t.removeServerById(e,"reset")})),this.servers={},this.methodsCount={}},t.prototype.createMethodIdentifier=function(t){var e=void 0!==t.input_signature?t.input_signature:"",n=void 0!==t.result_signature?t.result_signature:"";return(t.name+e+n).toLowerCase()},t.prototype.getServersByMethod=function(t){var e=this,n=[];return Object.keys(this.servers).forEach((function(r){var i=e.servers[r];Object.keys(i.methods).forEach((function(e){i.methods[e].identifier===t&&n.push(i.instance)}))})),n},t.prototype.returnUnsubWithDelayedReplay=function(t,e,n){var r=!1;return setTimeout((function(){e.forEach((function(t){r||n(t)}))}),0),function(){r=!0,t()}},t}(),Va=function(){function t(){this.nextId=0,this.methods=[]}return t.prototype.add=function(t){return t.repoId=String(this.nextId),this.nextId+=1,this.methods.push(t),t},t.prototype.remove=function(t){if("string"!=typeof t)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(e){return e.repoId!==t}))},t.prototype.getById=function(t){if("string"==typeof t)return this.methods.find((function(e){return e.repoId===t}))},t.prototype.getList=function(){return this.methods.map((function(t){return t}))},t.prototype.length=function(){return this.methods.length},t.prototype.reset=function(){this.methods=[]},t}(),Ja="onSubscriptionRequest",za="onSubscriptionAdded",Ka="onSubscriptionRemoved",Ya=function(){function t(t,e,n){var r=this;this.session=t,this.repository=e,this.serverRepository=n,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=As(),this.nextStreamId=0,t.on("add-interest",(function(t){r.handleAddInterest(t)})),t.on("remove-interest",(function(t){r.handleRemoveInterest(t)}))}return t.prototype.acceptRequestOnBranch=function(t,e,n){if("string"!=typeof n&&(n=""),"object"!=typeof e.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(e.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var r=this.getStreamId(e,n),i=t.msg.subscription_id,o={id:i,arguments:t.arguments,instance:t.instance,branchKey:n,streamId:r,subscribeMsg:t.msg};e.protocolState.subscriptionsMap[i]=o,this.session.sendFireAndForget({type:"accepted",subscription_id:i,stream_id:r}),this.callbacks.execute(za,o,e)},t.prototype.rejectRequest=function(t,e,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,t.msg.subscription_id)},t.prototype.pushData=function(t,e,n){var r=this;if("object"==typeof t&&Array.isArray(t.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]),t.protocolState.branchKeyToStreamIdMap.filter((function(t){return!n||0===n.length||n.indexOf(t.key)>=0})).map((function(t){return t.streamId})).forEach((function(t){var n={type:"publish",stream_id:t,data:e};r.session.sendFireAndForget(n)}))}},t.prototype.pushDataToSingle=function(t,e,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var r={type:"post",subscription_id:e.id,data:n};this.session.sendFireAndForget(r)},t.prototype.closeSingleSubscription=function(t,e){t.protocolState.subscriptionsMap&&delete t.protocolState.subscriptionsMap[e.id];var n={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);e.instance;this.callbacks.execute(Ka,e,t)},t.prototype.closeMultipleSubscriptions=function(t,e){var n=this;if("object"==typeof t&&"object"==typeof t.protocolState.subscriptionsMap&&t.protocolState.subscriptionsMap){var r=t.protocolState.subscriptionsMap,i=Object.keys(r).map((function(t){return r[t]}));"string"==typeof e&&(i=i.filter((function(t){return t.branchKey===e}))),i.forEach((function(t){delete r[t.id];var e={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping all subscriptions on stream_id: "+t.streamId};n.session.sendFireAndForget(e)}))}},t.prototype.getSubscriptionList=function(t,e){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var n=t.protocolState.subscriptionsMap,r=Object.keys(n).map((function(t){return n[t]}));return"string"!=typeof e?r:r.filter((function(t){return t.branchKey===e}))},t.prototype.getBranchList=function(t){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var e=t.protocolState.subscriptionsMap,n=Object.keys(e).map((function(t){return e[t]})),r=[];return n.forEach((function(t){var e="";"object"==typeof t&&"string"==typeof t.branchKey&&(e=t.branchKey),-1===r.indexOf(e)&&r.push(e)})),r},t.prototype.onSubAdded=function(t){this.onSubscriptionLifetimeEvent(za,t)},t.prototype.onSubRequest=function(t){this.onSubscriptionLifetimeEvent(Ja,t)},t.prototype.onSubRemoved=function(t){this.onSubscriptionLifetimeEvent(Ka,t)},t.prototype.handleRemoveInterest=function(t){var e=this.serverRepository.getById(t.method_id);if("string"==typeof t.subscription_id&&"object"==typeof e&&e.protocolState.subscriptionsMap&&"object"==typeof e.protocolState.subscriptionsMap[t.subscription_id]){var n=e.protocolState.subscriptionsMap[t.subscription_id];delete e.protocolState.subscriptionsMap[t.subscription_id],this.callbacks.execute(Ka,n,e)}},t.prototype.onSubscriptionLifetimeEvent=function(t,e){this.callbacks.add(t,e)},t.prototype.getNextStreamId=function(){return this.nextStreamId+++""},t.prototype.handleAddInterest=function(t){var e=this.repository.getServerById(t.caller_id).instance,n={msg:t,arguments:t.arguments_kv||{},instance:e},r=this.serverRepository.getById(t.method_id);if(void 0!==r)r.protocolState.subscriptionsMap&&r.protocolState.subscriptionsMap[t.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+t.subscription_id+" already exists.",t.subscription_id):this.callbacks.execute(Ja,n,r);else{var i="No method with id "+t.method_id+" on this server.";this.sendSubscriptionFailed(i,t.subscription_id)}},t.prototype.sendSubscriptionFailed=function(t,e){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:t,request_id:e};this.session.sendFireAndForget(n)},t.prototype.getStreamId=function(t,e){if("string"!=typeof e&&(e=""),!t.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+t.definition.name+" method without protocol state");var n=t.protocolState.branchKeyToStreamIdMap.filter((function(t){return t.key===e}))[0],r=n?n.streamId:void 0;return"string"==typeof r&&""!==r||(r=this.getNextStreamId(),t.protocolState.branchKeyToStreamIdMap.push({key:e,streamId:r})),r},t}(),Za=function(){function t(t,e,n,r){var i=this;this.session=t,this.clientRepository=e,this.serverRepository=n,this.logger=r,this.callbacks=As(),this.streaming=new Ya(t,e,n),this.session.on("invoke",(function(t){return i.handleInvokeMessage(t)}))}return t.prototype.createStream=function(t){return t.protocolState.subscriptionsMap={},t.protocolState.branchKeyToStreamIdMap=[],this.register(t,!0)},t.prototype.register=function(t,e){var n=this,r=t.definition,i={streaming:e||!1},o={type:"register",methods:[{id:t.repoId,name:r.name,display_name:r.displayName,description:r.description,version:r.version,flags:i,object_types:r.objectTypes||r.object_types,input_signature:r.accepts,result_signature:r.returns,restrictions:void 0}]};return this.session.send(o,{methodId:t.repoId}).then((function(){n.logger.debug("registered method "+t.definition.name+" with id "+t.repoId)})).catch((function(e){throw n.logger.warn("failed to register method "+t.definition.name+" with id "+t.repoId+" - "+JSON.stringify(e)),e}))},t.prototype.onInvoked=function(t){this.callbacks.add("onInvoked",t)},t.prototype.methodInvocationResult=function(t,e,n,r){var i;i=n||""===n?{type:"error",request_id:e,reason_uri:"agm.errors.client_error",reason:n,context:r,peer_id:void 0}:{type:"yield",invocation_id:e,peer_id:this.session.peerId,result:r,request_id:void 0},this.session.sendFireAndForget(i)},t.prototype.unregister=function(t){return rs(this,void 0,void 0,(function(){var e;return is(this,(function(n){switch(n.label){case 0:return e={type:"unregister",methods:[t.repoId]},[4,this.session.send(e)];case 1:return n.sent(),[2]}}))}))},t.prototype.getBranchList=function(t){return this.streaming.getBranchList(t)},t.prototype.getSubscriptionList=function(t,e){return this.streaming.getSubscriptionList(t,e)},t.prototype.closeAllSubscriptions=function(t,e){this.streaming.closeMultipleSubscriptions(t,e)},t.prototype.pushData=function(t,e,n){this.streaming.pushData(t,e,n)},t.prototype.pushDataToSingle=function(t,e,n){this.streaming.pushDataToSingle(t,e,n)},t.prototype.closeSingleSubscription=function(t,e){this.streaming.closeSingleSubscription(t,e)},t.prototype.acceptRequestOnBranch=function(t,e,n){this.streaming.acceptRequestOnBranch(t,e,n)},t.prototype.rejectRequest=function(t,e,n){this.streaming.rejectRequest(t,e,n)},t.prototype.onSubRequest=function(t){this.streaming.onSubRequest(t)},t.prototype.onSubAdded=function(t){this.streaming.onSubAdded(t)},t.prototype.onSubRemoved=function(t){this.streaming.onSubRemoved(t)},t.prototype.handleInvokeMessage=function(t){var e=t.invocation_id,n=t.caller_id,r=t.method_id,i=t.arguments_kv,o=this.serverRepository.getList().filter((function(t){return t.repoId===r}))[0];if(void 0!==o){var s={args:i,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",o,e,s)}},t}(),Xa=function(){function t(t,e){this.repository=t,this.subscriptionData=e}return Object.defineProperty(t.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"servers",{get:function(){var t=this;return this.subscriptionData.trackedServers.filter((function(t){return t.subscriptionId})).map((function(e){return t.repository.getServerById(e.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),t.prototype.onData=function(t){if("function"!=typeof t)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(t),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(e){t(e)}))},t.prototype.onClosed=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(t)},t.prototype.onFailed=function(t){},t.prototype.onConnected=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(t)},t.prototype.close=function(){this.subscriptionData.close()},t.prototype.setNewSubscription=function(t){this.subscriptionData=t},t}(),$a="awaitingAccept",Qa="subscribed",tc="ClientInitiated",ec=function(){function t(t,e,n){var r=this;this.session=t,this.repository=e,this.logger=n,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(t){var e=t._tag,n=e.subLocalKey,i=r.subscriptionsList[n];if("object"==typeof i&&(i.trackedServers=i.trackedServers.filter((function(t){return t.serverId!==e.serverId})),i.trackedServers.length<=0)){if(clearTimeout(i.timeoutId),i.status===$a){var o="string"==typeof t.reason&&""!==t.reason?' Publisher said "'+t.reason+'".':" No reason given.",s="object"==typeof i.params.arguments?JSON.stringify(i.params.arguments):"{}";i.error({message:"Subscription rejected."+o+" Called with:"+s,called_with:i.params.arguments,method:i.method})}else i.status===Qa&&r.callOnClosedHandlers(i);delete r.subscriptionsList[n]}},this.handleSubscribed=function(t){var e=t._tag.subLocalKey,n=r.subscriptionsList[e];if("object"==typeof n){var i=t._tag.serverId,o=n.trackedServers.filter((function(t){return t.serverId===i}))[0];if("object"==typeof o){o.subscriptionId=t.subscription_id,r.subscriptionIdToLocalKeyMap[t.subscription_id]=e;var s=n.status===$a;if(n.status=Qa,s){var a=!1,c=n.subscription;c?(c.setNewSubscription(n),n.success(c),a=!0):(c=new Xa(r.repository,n),n.subscription=c,n.success(c));for(var u=0,d=n.handlers.onConnected;u<d.length;u++){var p=d[u];try{p(c.serverInstance,a)}catch(t){}}}}}},this.handleEventData=function(t){var e=r.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=r.subscriptionsList[e];if("object"==typeof n){var i=n.trackedServers.filter((function(e){return e.subscriptionId===t.subscription_id}));if(1===i.length){var o=t.oob,s=i[0].serverId,a=function(){return{data:t.data,server:r.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:o}},c=n.handlers.onData,u=n.queued.data;c.length>0?c.forEach((function(t){"function"==typeof t&&t(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(t){var e=r.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=r.subscriptionsList[e];if("object"==typeof n){var i=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(e){return e.subscriptionId!==t.subscription_id||(n.queued.closers.push(e.serverId),!1)})),n.trackedServers.length===i&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),r.callOnClosedHandlers(n),delete r.subscriptionsList[e]),delete r.subscriptionIdToLocalKeyMap[t.subscription_id])}}},t.on("subscribed",this.handleSubscribed),t.on("event",this.handleEventData),t.on("subscription-cancelled",this.handleSubscriptionCancelled)}return t.prototype.subscribe=function(t,e,n,r,i,o){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,t,e,r,i,e.methodResponseTimeout||1e4,o);"object"==typeof c?n.forEach((function(n){var r=n.server.id,i=n.methods.find((function(e){return e.name===t.name}));if(i){c.trackedServers.push({serverId:r,subscriptionId:void 0});var o={type:"subscribe",server_id:r,method_id:i.gatewayId,arguments_kv:e.arguments};s.session.send(o,{serverId:r,subLocalKey:a}).then((function(t){return s.handleSubscribed(t)})).catch((function(t){return s.handleErrorSubscribing(t)}))}else s.logger.error("can not find method "+t.name+" for target "+n.server.id)})):i({method:t,called_with:e.arguments,message:"Subscription failed. Unable to register the user callbacks."})}else i({method:t,called_with:e.arguments,message:"Subscription failed. No available servers matched the target params."})},t.prototype.drainSubscriptions=function(){var t=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},t},t.prototype.getNextSubscriptionLocalKey=function(){var t=this.nextSubLocalKey;return this.nextSubLocalKey+=1,t},t.prototype.registerSubscription=function(t,e,n,r,i,o,s){var a=this,c={localKey:t,status:$a,method:e,params:n,success:r,error:i,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(t)},subscription:null==s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[t]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[t]){var r=a.subscriptionsList[t];r.status===$a?(i({method:e,called_with:n.arguments,message:"Subscription failed. Subscription attempt timed out after "+o+" ms."}),delete a.subscriptionsList[t]):r.status===Qa&&r.trackedServers.length>0&&(r.trackedServers=r.trackedServers.filter((function(t){return void 0!==t.subscriptionId})),delete r.timeoutId,r.trackedServers.length<=0&&(a.callOnClosedHandlers(r),delete a.subscriptionsList[t]))}}),o),c},t.prototype.callOnClosedHandlers=function(t,e){var n,r=t.queued.closers.length,i=r>0?t.queued.closers[r-1]:null;void 0!==i&&"string"==typeof i&&(n=this.repository.getServerById(i).instance),t.handlers.onClosed.forEach((function(r){"function"==typeof r&&r({message:e||"ServerInitiated",requestArguments:t.params.arguments||{},server:n,stream:t.method})}))},t.prototype.closeSubscription=function(t){var e=this,n=this.subscriptionsList[t];"object"==typeof n&&(n.trackedServers.forEach((function(t){void 0!==t.subscriptionId&&(n.queued.closers.push(t.serverId),e.session.sendFireAndForget({type:"unsubscribe",subscription_id:t.subscriptionId,reason_uri:"",reason:tc}),delete e.subscriptionIdToLocalKeyMap[t.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,tc),delete this.subscriptionsList[t])},t}(),nc=function(){function t(t,e,n){var r=this;this.session=t,this.repository=e,this.logger=n,t.on("peer-added",(function(t){return r.handlePeerAdded(t)})),t.on("peer-removed",(function(t){return r.handlePeerRemoved(t)})),t.on("methods-added",(function(t){return r.handleMethodsAddedMessage(t)})),t.on("methods-removed",(function(t){return r.handleMethodsRemovedMessage(t)})),this.streaming=new ec(t,e,n)}return t.prototype.subscribe=function(t,e,n,r,i,o){this.streaming.subscribe(t,e,n,r,i,o)},t.prototype.invoke=function(t,e,n,r){var i=this,o=r.id,s={type:"call",server_id:o,method_id:e.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:t,serverId:o}).then((function(t){return i.handleResultMessage(t)})).catch((function(t){return i.handleInvocationError(t)}))},t.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},t.prototype.handlePeerAdded=function(t){var e=t.new_peer_id,n=t.identity,r=!t.meta||t.meta.local,i=Number(n.process),o={machine:n.machine,pid:isNaN(i)?n.process:i,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:e,api:n.api,isLocal:r};this.repository.addServer(o,e)},t.prototype.handlePeerRemoved=function(t){var e=t.removed_id,n=t.reason;this.repository.removeServerById(e,n)},t.prototype.handleMethodsAddedMessage=function(t){var e=this,n=t.server_id;t.methods.forEach((function(t){e.repository.addServerMethod(n,t)}))},t.prototype.handleMethodsRemovedMessage=function(t){var e=this,n=t.server_id,r=t.methods,i=this.repository.getServerById(n);Object.keys(i.methods).forEach((function(t){var o=i.methods[t];r.indexOf(o.gatewayId)>-1&&e.repository.removeServerMethod(n,t)}))},t.prototype.handleResultMessage=function(t){var e=t._tag.invocationId,n=t.result,r=t._tag.serverId;return{invocationId:e,result:n,instance:this.repository.getServerById(r).instance,status:Pa.Success,message:""}},t.prototype.handleInvocationError=function(t){if(this.logger.debug("handle invocation error "+JSON.stringify(t)),"_tag"in t){var e=t._tag.invocationId,n=t._tag.serverId,r=this.repository.getServerById(n),i=t.reason;return{invocationId:e,result:t.context,instance:r.instance,status:Pa.Error,message:i}}return{invocationId:"",message:t.message,status:Pa.Error,error:t}},t}();function rc(t,e,n,r,i,o){var s,a=i.logger.subLogger("gw3-protocol"),c=new Promise((function(t){s=t})),u=e.domain("agm",["subscribed"]),d=new Za(u,n,r,a.subLogger("server")),p=new nc(u,n,a.subLogger("client"));return u.onJoined((function(i){n.addServer(t,e.peerId),i?function(){a.info("reconnected - will replay registered methods and subscriptions");for(var t=0,e=p.drainSubscriptions();t<e.length;t++){var n=e[t],i=n.method,s=Object.assign({},n.params);a.info("trying to re-subscribe to method "+i.name),o.client.subscribe(i,s,void 0,void 0,n)}var c=r.getList();r.reset();for(var u=0,d=c;u<d.length;u++){var h=d[u],f=h.definition;a.info("re-publishing method "+f.name),h.stream?o.server.createStream(f,h.streamCallbacks,void 0,void 0,h.stream):h.theFunction&&h.theFunction.userCallback?o.register(f,h.theFunction.userCallback):h.theFunction&&h.theFunction.userCallbackAsync&&o.registerAsync(f,h.theFunction.userCallbackAsync)}}():s&&(s({client:p,server:d}),s=void 0)})),u.onLeft((function(){n.reset()})),u.join(),c}var ic=function(){function t(t){var e=this;if(void 0===t)throw new Error("configuration is required");if(void 0===t.connection)throw new Error("configuration.connections is required");var n,r=t.connection;if("number"!=typeof t.methodResponseTimeout&&(t.methodResponseTimeout=3e4),"number"!=typeof t.waitTimeoutMs&&(t.waitTimeoutMs=3e4),qa.API=this,this.instance=new qa(void 0,r).unwrap(),this.clientRepository=new Ua(t.logger.subLogger("cRep")),this.serverRepository=new Va,3!==r.protocolVersion)throw new Error("protocol "+r.protocolVersion+" not supported");n=rc(this.instance,r,this.clientRepository,this.serverRepository,t,this),this.readyPromise=n.then((function(n){return e.protocol=n,e.client=new Ra(e.protocol,e.clientRepository,e.instance,t),e.server=new Ba(e.protocol,e.serverRepository),e}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.serverRemoved=function(t){return this.client.serverRemoved(t)},t.prototype.serverAdded=function(t){return this.client.serverAdded(t)},t.prototype.serverMethodRemoved=function(t){return this.client.serverMethodRemoved(t)},t.prototype.serverMethodAdded=function(t){return this.client.serverMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.client.methodRemoved(t)},t.prototype.methodAdded=function(t){return this.client.methodAdded(t)},t.prototype.methodsForInstance=function(t){return this.client.methodsForInstance(t)},t.prototype.methods=function(t){return this.client.methods(t)},t.prototype.servers=function(t){return this.client.servers(t)},t.prototype.subscribe=function(t,e,n,r){return this.client.subscribe(t,e,n,r)},t.prototype.createStream=function(t,e,n,r){return this.server.createStream(t,e,n,r)},t.prototype.unregister=function(t){return this.server.unregister(t)},t.prototype.registerAsync=function(t,e){return this.server.registerAsync(t,e)},t.prototype.register=function(t,e){return this.server.register(t,e)},t.prototype.invoke=function(t,e,n,r,i,o){return this.client.invoke(t,e,n,r,i,o)},t}(),oc=["subscribed","success"],sc=function(){function t(t,e){var n=this;this.publish=function(t,e,r){var i=r||{},o=i.routingKey,s=i.target,a=n.removeEmptyValues({type:"publish",topic:t,data:e,peer_id:n.peerId,routing_key:o,target_identity:s});n.session.send(a)},this.subscribe=function(t,e,r){return new Promise((function(i,o){var s=r||{},a=s.routingKey,c=s.target,u=n.removeEmptyValues({type:"subscribe",topic:t,peer_id:n.peerId,routing_key:a,source:c});n.session.send(u).then((function(r){var o=r.subscription_id;n.subscriptions.push({subscription_id:o,topic:t,callback:e,source:c}),i({unsubscribe:function(){return n.session.send({type:"unsubscribe",subscription_id:o,peer_id:n.peerId}),n.subscriptions=n.subscriptions.filter((function(t){return t.subscription_id!==o})),Promise.resolve()}})})).catch((function(t){return o(t)}))}))},this.watchOnEvent=function(){n.session.on("event",(function(t){var e=t.data,r=t.subscription_id,i=t["publisher-identity"],o=n.subscriptions.find((function(t){return t.subscription_id===r}));o&&(o.source?n.keysMatch(o.source,i)&&o.callback(e,o.topic,i):o.callback(e,o.topic,i))}))},this.connection=t,this.logger=e,this.peerId=t.peerId,this.subscriptions=[],this.session=t.domain("bus",oc),this.readyPromise=this.session.join(),this.readyPromise.then((function(){n.watchOnEvent()}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.removeEmptyValues=function(t){var e={};return Object.keys(t).forEach((function(n){void 0!==t[n]&&null!==t[n]&&(e[n]=t[n])})),e},t.prototype.keysMatch=function(t,e){var n=Object.keys(t),r=!0;return n.forEach((function(n){t[n]!==e[n]&&(r=!1)})),r},t}(),ac=function(t,e){var n,r=Ms.getGDMajorVersion(),i=Promise.resolve();if(r){if(r<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");r>=3&&(n=window.glue42gd,i=window.gdPreloadPromise||i)}var o,s,a,c,u,d,p,h=Os("glue"),f=_a(t=t||{},e=e||{},n),l={};function v(t,e,n){(p=a.canPublish("trace"))&&a.trace("registering "+t+" module");var r=function(){e.initTime=n.stop(),e.initEndTime=n.endTime,e.marks=n.marks,p&&a.trace(t+" is ready - "+(n.endTime-n.startTime))};e.initStartTime=n.startTime,e.ready?e.ready().then((function(){r()})):r(),Array.isArray(t)||(t=[t]),t.forEach((function(t){l[t]=e,ac[t]=e}))}function y(){var t=Os("interop"),e={connection:o,logger:a.subLogger("interop")};return s=new ic(e),oa.Interop=s,v(["interop","agm"],s,t),Promise.resolve()}function g(){var t=f.activities&&3===o.protocolVersion;if(f.contexts||t){var e=Os("contexts");return v("contexts",u=new ja({connection:o,logger:a.subLogger("contexts")}),e),u}var n=o.replayer;n&&n.drain(wa.name)}function m(){return rs(this,void 0,void 0,(function(){var t;return is(this,(function(e){return f.bus?(t=Os("bus"),v("bus",d=new sc(o,a.subLogger("bus")),t),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function w(t){try{return t.forEach((function(t){!function(t,e){var n=Os(t),r=e(l);r&&v(t,r,n)}(t.name,t.create)})),Promise.resolve()}catch(t){return Promise.reject(t)}}return i.then((function(){var t,e=Os("logger");return(a=new oa(""+(null===(t=f.connection.identity)||void 0===t?void 0:t.application),void 0,f.customLogger)).consoleLevel(f.logger.console),a.publishLevel(f.logger.publish),a.canPublish("debug")&&a.debug("initializing glue..."),v("logger",a,e),Promise.resolve(void 0)})).then((function(){var t=Os("connection");o=new ra(f.connection,a.subLogger("connection"));var e=Promise.resolve(f.auth);return f.connection&&!f.auth&&(e=n?n.getGWToken().then((function(t){return{gatewayToken:t}})):Promise.reject("You need to provide auth information")),e.then((function(e){var n;if(t.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(e))throw new Error("Invalid auth object - "+JSON.stringify(e));return n=e,o.login(n)})).then((function(){return v("connection",o,t),f})).catch((function(t){throw o&&o.logout(),t}))})).then((function(){return Promise.all([(s=Os("metrics"),u=f.metrics,d=null==n?void 0:n.getMetricsPublishingEnabled,p=f.connection.identity,h=d||function(){return!0},l=null!==(t="boolean"!=typeof u&&u.disableAutoAppSystem)&&void 0!==t&&t,v("metrics",c=ks({connection:u?o:void 0,logger:a.subLogger("metrics"),canUpdateMetric:h,system:"Glue42",service:null!==(e=null==p?void 0:p.service)&&void 0!==e?e:"metrics-service",instance:null!==(i=null!==(r=null==p?void 0:p.instance)&&void 0!==r?r:null==p?void 0:p.windowId)&&void 0!==i?i:Qs(),disableAutoAppSystem:l,pagePerformanceMetrics:"boolean"!=typeof u?null==u?void 0:u.pagePerformanceMetrics:void 0}),s),Promise.resolve()),y(),g(),m()]);var t,e,r,i,s,u,d,p,h,l})).then((function(){return s.readyPromise})).then((function(){return w(f.libs||[])})).then((function(){var t=Object.keys(l).map((function(t){var e=l[t];return e.ready?e.ready():Promise.resolve()}));return Promise.all(t)})).then((function(){var r={coreVersion:ba,version:f.version};h.stop();var i={feedback:function(t){s&&s.invoke("T42.ACS.Feedback",t,"best")},info:r,logger:a,interop:s,agm:s,connection:o,metrics:c,contexts:u,bus:d,version:f.version,userConfig:t,done:function(){return null==a||a.info("done called by user..."),o.logout()}};if(i.performance={get glueVer(){return f.version},get glueConfig(){return JSON.stringify(t)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var t=Es;return Object.keys(t).map((function(e){var n=t[e];return{name:e,duration:n.endTime-n.startTime,marks:n.marks}}))}},Object.keys(l).forEach((function(t){var e=l[t];i[t]=e})),i.config={},Object.keys(f).forEach((function(t){i.config[t]=f[t]})),e&&e.extOptions&&Object.keys(e.extOptions).forEach((function(t){i.config[t]=null==e?void 0:e.extOptions[t]})),(null==e?void 0:e.enrichGlue)&&e.enrichGlue(i),n&&n.updatePerfData&&n.updatePerfData(i.performance),i.agm){var p=function(t,e,n){return function(){i.logger.warn("glue.js - 'glue.agm."+e+"' method is deprecated, use 'glue.interop."+n+"' instead."),t.apply(i.agm,arguments)}},v=i.agm;v.method_added=p(i.agm.methodAdded,"method_added","methodAdded"),v.method_removed=p(i.agm.methodRemoved,"method_removed","methodRemoved"),v.server_added=p(i.agm.serverAdded,"server_added","serverAdded"),v.server_method_aded=p(i.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),v.server_method_removed=p(i.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return i})).catch((function(t){return Promise.reject({err:t,libs:l})}))};"undefined"!=typeof window&&(window.GlueCore=ac),ac.version=ba,ac.default=ac;var cc,uc=(cc=ac,function(t){return Dr(void 0,void 0,void 0,(function(){var e,n,r,i,o,s,a,c,u,d,p,h,f,l,v,y,g,m,w,b,_,I,S,x,k,C,A,T,P,M;return Fr(this,(function(j){switch(j.label){case 0:return[4,(E=t,Dr(void 0,void 0,void 0,(function(){var t,e,n,r;return Fr(this,(function(i){switch(i.label){case 0:return[4,Po(E=null!=E?E:{})];case 1:return t=i.sent(),(e=Wr(Wr(Wr({},To),t.glue),E)).worker=e.assets.location+"/"+Co,"string"==typeof(null==e?void 0:e.extends)&&(n=e.extends.lastIndexOf("/"),r=e.extends.substr(0,n+1)+Co,e.worker=r),t.layouts||(t.layouts={remoteType:"json"}),[2,Wr(Wr({},t),{glue:e})]}}))})))];case 1:if(e=j.sent(),n="undefined"!=typeof window,r=(null===(y=e.glue)||void 0===y?void 0:y.channels)||!1,i=(null===(g=e.glue)||void 0===g?void 0:g.appManager)||!1,n&&(null==(o=window)?void 0:o.glue42gd)&&(null==o?void 0:o.Glue))return[2,o.Glue({windows:!0,logger:null===(m=e.glue)||void 0===m?void 0:m.logger,channels:r,layouts:!0,appManager:i,libraries:t.libraries})];if(s=new ui,d={libs:[{name:"notifications",create:function(t){return new xo(t.interop)}}],version:Br},r&&(p={name:"channels",create:function(t){return new eo(t.contexts,e.channels)}},null===(w=d.libs)||void 0===w||w.push(p)),n&&(null===(b=d.libs)||void 0===b||b.push({name:"windows",create:function(t){return a=new li(t.interop,s)}},{name:"layouts",create:function(t){var n,r,i;if("json"===(null===(n=e.layouts)||void 0===n?void 0:n.remoteType)){var o=(null===(r=null==e?void 0:e.glue.assets)||void 0===r?void 0:r.location)||ko;i=new Xo(o)}var c=new Zo,d=new $o,p=new Oo(c,d,i);return u=new Eo(p,a,s,t.interop,null==e?void 0:e.glue),new $i(u)}}),h={name:"appManager",create:function(t){var n;return c=new vo(a,t.interop,s,e.appManager,null===(n=e.glue)||void 0===n?void 0:n.application),i?c:void 0}},f={name:"intents",create:function(t){return new So(t.interop,a,c)}},null===(_=d.libs)||void 0===_||_.push(h,f)),l={gateway:{sharedWorker:null!==(S=null===(I=e.glue)||void 0===I?void 0:I.worker)&&void 0!==S?S:"/glue/worker.js",inproc:null===(x=e.glue)||void 0===x?void 0:x.inproc},logger:null===(k=e.glue)||void 0===k?void 0:k.logger,application:null===(C=e.glue)||void 0===C?void 0:C.application},n&&!window.SharedWorker)throw new Error("Cannot initialize Glue Web, because this environment does not support Shared Workers");return[4,ro((function(){return cc(l,d)}),1e4,"Glue Web initialization timed out")];case 2:return v=j.sent(),(null==t?void 0:t.libraries)?[4,Promise.all(t.libraries.map((function(t){return t(v,null==e?void 0:e.glue)})))]:[3,4];case 3:j.sent(),j.label=4;case 4:return s.start(v.interop,v.logger.subLogger("control")),n?[4,fi(v.windows.my(),v.interop,null===(A=v.appManager)||void 0===A?void 0:A.myInstance)]:[3,9];case 5:return j.sent(),(null===(P=null===(T=e.glue)||void 0===T?void 0:T.layouts)||void 0===P?void 0:P.autoRestore)?[4,null==u?void 0:u.restoreAutoSavedLayout()]:[3,7];case 6:j.sent(),j.label=7;case 7:return[4,Qo(v,null!==(M=e.glue)&&void 0!==M?M:{},s,u)];case 8:j.sent(),j.label=9;case 9:return[2,v]}var E}))}))});if("undefined"!=typeof window){var dc=window;dc.GlueWeb=uc,delete dc.GlueCore}uc.default=uc,uc.version=Br;const pc={application:window.fdc3AppName,appManager:!0,context:!0,intents:!0,channels:!0,agm:!0},hc=()=>new Promise(e=>{let i;const o=()=>t(void 0,void 0,void 0,(function*(){const t=yield n();0!==t.length&&r(t[0])||(clearInterval(i),e())}));i=setInterval(o,300),o()}),fc=(()=>{(t=>{if(i)window.gluePromise=uc(pc).then(t=>(window.glue=t,hc())).then(()=>window.glue);else{const e=new Promise(t=>{let e;const n=()=>{window.glue42gd&&(clearInterval(e),t())};e=setInterval(n,300),n()});window.gluePromise=e.then(()=>(window.Glue||Nr)(t||pc)).then(t=>(window.glue=t,hc())).then(()=>window.glue)}})();const t=(()=>{const t=d(),e=c();return Object.assign(Object.assign({},t),e)})();return Object.assign(Object.assign({},t),{version:"1.2.1"})})();return window.fdc3=fc,fc.default=fc,fc}));
//# sourceMappingURL=fdc3-glue42.js.map
