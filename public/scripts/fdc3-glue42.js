!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).web=e()}(this,(function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function t(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))}var e,n,i,r,o;!function(t){t.AppNotFound="AppNotFound",t.ErrorOnLaunch="ErrorOnLaunch",t.AppTimeout="AppTimeout",t.ResolverUnavailable="ResolverUnavailable"}(e||(e={})),function(t){t.NoAppsFound="NoAppsFound",t.ResolverUnavailable="ResolverUnavailable",t.ResolverTimeout="ResolverTimeout"}(n||(n={})),function(t){t.NoChannelFound="NoChannelFound",t.AccessDenied="AccessDenied",t.CreationFailed="CreationFailed"}(i||(i={})),function(t){t.Contact="fdc3.contact",t.ContactList="fdc3.contactList",t.Country="fdc3.country",t.Instrument="fdc3.instrument",t.Organization="fdc3.organization",t.Portfolio="fdc3.portfolio",t.Position="fdc3.position"}(r||(r={})),function(t){t.StartCall="StartCall",t.StartChart="StartChart",t.ViewChart="ViewChart",t.ViewContact="ViewContact",t.ViewQuote="ViewQuote",t.ViewNews="ViewNews",t.ViewInstrument="ViewInstrument",t.ViewAnalysis="ViewAnalysis"}(o||(o={}));const s=(t,e)=>{let n=!1;return window.glue.contexts.subscribe(t,((t,i,r,o,s)=>{if(!n)return void(n=!0);s.updaterId===window.glue.interop.instance.instance||e(t,i,r,o,s)}))},a=t=>0===Object.keys(t).length&&t.constructor===Object,c=!navigator.userAgent.toLowerCase().includes(" electron/"),u=t=>({unsubscribe(){t?"function"==typeof t?t():t.then((t=>t())):console.error("Failed to unsubscribe!")}}),d=(t,e,n)=>new Promise((i=>{const r=()=>{void 0!==n?i(n()):i()};if(t())r();else{let n;n=setInterval((()=>{t()&&(clearInterval(n),r())}),e)}}));class p{constructor(t){this.type="system",this.id=t.name,this.displayMetadata=t.meta}broadcast(t){return window.glue.channels.publish(t,this.id)}getCurrentContext(e){return t(this,void 0,void 0,(function*(){const t=yield window.glue.channels.get(this.id),{data:n}=t;return e?n&&n.type===e?n:null:n}))}addContextListener(t,e){const n=2===arguments.length&&t,i=2===arguments.length?e:t,r=window.glue.channels.subscribeFor(this.id,(t=>{n?(null==t?void 0:t.type)===n&&i(t):i(t)}));return{unsubscribe(){r.then((t=>t()))}}}join(){return window.glue.channels.join(this.id)}leave(){return window.glue.channels.leave()}}class h{constructor(t){this.id=t,this.type="app"}broadcast(t){return window.glue.contexts.update(this.id,t)}getCurrentContext(e){return t(this,void 0,void 0,(function*(){const t=yield window.glue.contexts.get(this.id),{data:n}=t;return e?n&&n.type===e?n:null:n}))}addContextListener(t,e){const n=2===arguments.length&&t,i=2===arguments.length?e:t,r=s(this.id,(t=>{n?(null==t?void 0:t.type)===n&&i(t):i(t)}));return{unsubscribe:()=>{r.then((t=>t()))}}}}const f=()=>{let e,n;const r={};let o=[];const d=window.fdc3GluePromise.then((()=>{const e=window.glue.channels.current();c||(void 0!==e&&g(e),window.glue.channels.changed((t=>{g(t)})));const n=t(void 0,void 0,void 0,(function*(){const t=yield window.glue.channels.all();return yield Promise.all(t.map((t=>window.glue.channels.get(t))))})).then((t=>{t.map((t=>{r[t.name]=v(t)}))})),i=window.glue.channels.all().then((t=>{o=t}));return Promise.all([n,i])})),f=e=>t(void 0,void 0,void 0,(function*(){return(yield window.glue.contexts.all()).some((t=>t===e))})),l=t=>!!t&&o.some((e=>e===t.id)),v=t=>new p(t),y=t=>new h(t),g=e=>t(void 0,void 0,void 0,(function*(){yield d,void 0!==e&&S(r[e])})),m=(t,e)=>{let i=()=>{n=null};return n={contextType:t,handler:e,setActualUnsub:t=>{i=t}},{unsubscribe:i}},w=()=>t(void 0,void 0,void 0,(function*(){yield d;return o.map((t=>r[t]))})),b=e=>t(void 0,void 0,void 0,(function*(){yield d;return(yield f(e))||(yield(e=>t(void 0,void 0,void 0,(function*(){yield window.glue.contexts.set(e,null)})))(e)),y(e)})),_=()=>t(void 0,void 0,void 0,(function*(){l(e)&&(yield e.leave())}));function I(t,n){const i=2===arguments.length&&t,r=2===arguments.length?n:t;if(!e){console.warn("You need to join a channel in order to start receiving broadcasted contexts!");const t=m(i,r);return window.fdc3GluePromise.then((()=>window.glue.windows.my().getContext())).then((t=>{a(t)||r(t)})),t}const{id:o,type:c}=e,d=t=>"system"===c?window.glue.channels.subscribe(t):s(o,t),p=t=>{i?t.type===i&&r(t):r(t)},h=d(p);return u(h)}const S=t=>{if(e=t,n){const{contextType:t,handler:e,setActualUnsub:i}=n;i(I(t,e).unsubscribe),n=null}};return{getSystemChannels:w,getOrCreateChannel:e=>t(void 0,void 0,void 0,(function*(){const t=(yield w()).find((t=>t.id===e));return void 0===t?b(e):t})),joinChannel:e=>t(void 0,void 0,void 0,(function*(){yield d;const n=r[e]||(yield(e=>t(void 0,void 0,void 0,(function*(){if(yield d,!(yield f(e)))throw new Error(i.NoChannelFound);const t=y(e);return r[e]=t,t})))(e));if(!n)throw new Error(i.NoChannelFound);l(n)?n.join():yield _(),S(n)})),getCurrentChannel:()=>t(void 0,void 0,void 0,(function*(){return yield d,e})),leaveCurrentChannel:()=>t(void 0,void 0,void 0,(function*(){yield d,yield _(),e=null})),broadcast:n=>t(void 0,void 0,void 0,(function*(){if(yield d,!e)return void console.error("You need to join a channel in order to broadcast.");const{id:t,type:i}=e;"system"===i?window.glue.channels.publish(n):window.glue.contexts.update(t,n)})),addContextListener:I}},l=t=>{const{name:e,handlers:n}=t,i=n.filter((t=>"app"===t.type)),r=n.filter((t=>"instance"===t.type&&!i.some((e=>e.applicationName===t.applicationName)))),o=[...i,...r];return{intent:{name:e,displayName:n[0].displayName||""},apps:o.map((t=>{const e=t.applicationName,n=window.glue.appManager.application(e);return{name:e,title:t.applicationTitle||t.instanceTitle||e,tooltip:(null==n?void 0:n.userProperties.tooltip)||`${e} (${t.type})`,description:t.applicationDescription,icons:t.applicationIcon?[t.applicationIcon,...(null==n?void 0:n.userProperties.icons)||[]]:null==n?void 0:n.userProperties.icons,images:null==n?void 0:n.userProperties.images}}))}},v=()=>({open:(...n)=>t(void 0,void 0,void 0,(function*(){return yield window.fdc3GluePromise,((n,i)=>t(void 0,void 0,void 0,(function*(){const t=window.glue.appManager.application(n);if(void 0===t)throw new Error(e.AppNotFound);try{yield t.start(i)}catch(t){}})))(...n)})),findIntent:(...e)=>t(void 0,void 0,void 0,(function*(){return yield window.fdc3GluePromise,((e,i)=>t(void 0,void 0,void 0,(function*(){if("string"!=typeof e)throw new Error("Please provide the intent as a string!");if(void 0!==i&&"string"!=typeof i.type)throw new Error("Please provide the context.type as a string!");const t=yield window.glue.intents.find({name:e,contextType:null==i?void 0:i.type});if(void 0!==t&&0===t.length)throw new Error(n.NoAppsFound);return l(t[0])})))(...e)})),findIntentsByContext:(...e)=>t(void 0,void 0,void 0,(function*(){return yield window.fdc3GluePromise,(e=>t(void 0,void 0,void 0,(function*(){if(void 0!==e&&"string"!=typeof e.type)throw new Error("Please provide the context.type as a string!");const t=yield window.glue.intents.find({contextType:e.type});if(void 0!==t&&0===t.length)throw new Error(n.NoAppsFound);return t.map((t=>l(t)))})))(...e)})),raiseIntent:(...n)=>t(void 0,void 0,void 0,(function*(){return yield window.fdc3GluePromise,((n,i,r)=>t(void 0,void 0,void 0,(function*(){if("string"!=typeof n)throw new Error("Please provide the intent as a string!");if(void 0!==i&&"string"!=typeof i.type)throw new Error("Please provide the context.type as a string!");if(void 0!==r&&"string"!=typeof r)throw new Error("Please provide the target as a string!");let t="reuse";if(void 0!==r){const n=window.glue.appManager.application(r);if(void 0===n)throw new Error(e.AppNotFound);const i=n.instances;t=0===i.length?{app:r}:{instance:i[0].id}}const o=yield window.glue.intents.raise({intent:n,context:i,target:t});return{source:o.handler.applicationName,version:"1.0.0",data:o.result}})))(...n)})),addIntentListener:(t,e)=>{if("string"!=typeof t)throw new Error("Please provide the intent as a string!");if("function"!=typeof e)throw new Error("Please provide the handler as a function!");const n={unsubscribe:()=>console.error("Failed to unsubscribe!")};return window.fdc3GluePromise.then((()=>{n.unsubscribe=window.glue.intents.addIntentListener(t,e).unsubscribe})),n}});
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */
var y=function(t,e){return(y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function g(t,e){function n(){this.constructor=t}y(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var m=function(){return(m=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function w(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){t.done?r(t.value):new n((function(e){e(t.value)})).then(s,a)}c((i=i.apply(t,e||[])).next())}))}function b(t,e){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var _=function(t,e){return(_=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function I(t,e){function n(){this.constructor=t}_(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var S=function(){return(S=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function x(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){t.done?r(t.value):new n((function(e){e(t.value)})).then(s,a)}c((i=i.apply(t,e||[])).next())}))}function k(t,e){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function C(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var i=Array(t),r=0;for(e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,r++)i[r]=o[s];return i}var A=1,T=2,P=3,M=4;function j(t){return t.type===P?"timestamp":t.type===T?"number":t.type===A?"string":t.type===M?"object":"unknown"}function E(t){return t.constructor===Date?"timestamp":"number"==typeof t?"number":"string"==typeof t?"string":"object"==typeof t?"object":"string"}function O(t){var e={},n=j(t);if("object"===n){var i=Object.keys(t.value).reduce((function(e,n){var i=E(t.value[n]);if("object"===i){var r=R(t.value[n]);e[n]={type:"object",description:"",context:{},composite:r}}else e[n]={type:i,description:"",context:{}};return e}),{});e.composite=i}return e.name=N(t.path.join("/")+"/"+t.name),e.type=n,e.description=t.description,e.context={},e}function R(t){return Object.keys(t).reduce((function(e,n){var i=E(t[n]);return e[n]="object"===i?{type:"object",description:"",context:{},composite:R(t[n])}:{type:i,description:"",context:{}},e}),{})}function N(t){return void 0!==t&&t.length>0&&"/"!==t[0]?"/"+t:t}function L(t){return"timestamp"===j(t)?Date.now():W(t.value)}function W(t){return"object"!=typeof t?t:Object.keys(t).reduce((function(e,n){var i=t[n];return"object"==typeof i&&i.constructor!==Date?e[n]=W(i):i.constructor===Date?e[n]=new Date(i).getTime():i.constructor===Boolean?e[n]=i.toString():e[n]=i,e}),{})}function D(t){return t.reduce((function(t,e){return t.concat(Array.isArray(e)?D(e):e)}),[])}function F(t){var e=D(t.root.getAggregateState()),n=e.sort((function(t,e){return t.state?e.state?e.state-t.state:-1:1}))[0];return{description:function(t){var e="";return t.forEach((function(t,n,i){var r=t.path.join(".");n===i.length-1?e+=r+"."+t.name+": "+t.description:e+=r+"."+t.name+": "+t.description+","})),e.length>100?e.slice(0,100)+"...":e}(e),value:n.state}}var B=function(t,e,n){if(null===t||"object"!=typeof t)throw new Error("Missing definition");if(null===e||"object"!=typeof e)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")},G=function(){function t(t,e,n,i,r){this.definition=t,this.system=e,this.transport=n,this.value=i,this.type=r,this.path=[],B(t,e,n),this.path=e.path.slice(0),this.path.push(e.name),this.name=t.name,this.description=t.description,n.createMetric(this)}return Object.defineProperty(t.prototype,"repo",{get:function(){var t;return null===(t=this.system)||void 0===t?void 0:t.repo},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),t.prototype.update=function(t){return this.value=t,this.transport.updateMetric(this)},t}(),q=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,T)||this}return I(e,t),e.prototype.incrementBy=function(t){this.update(this.value+t)},e.prototype.increment=function(){this.incrementBy(1)},e.prototype.decrement=function(){this.incrementBy(-1)},e.prototype.decrementBy=function(t){this.incrementBy(-1*t)},e}(G),H=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,M)||this}return I(e,t),e.prototype.update=function(t){return this.mergeValues(t),this.transport.updateMetric(this)},e.prototype.mergeValues=function(t){var e=this;return Object.keys(this.value).forEach((function(n){void 0!==t[n]&&(e.value[n]=t[n])}))},e}(G),U=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,A)||this}return I(e,t),e}(G),V=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,P)||this}return I(e,t),e.prototype.now=function(){this.update(new Date)},e}(G);function J(t,e,n,i,r){if(!e)throw new Error("Repository is required");if(!n)throw new Error("Transport is required");var o,s,a=n,c=t,u=r||"",d=e,p=i,h=function t(e){if(!e||!e.parent)return[];var n=t(e.parent);return n.push(e.name),n}(i),f={},l=(s="/",((o=h)&&o.length>0?o.join(s):"")+t),v=e.root,y=[],g=[];function m(t,e,n,i){var r={name:""};r="string"==typeof t?{name:t}:t;var o=g.filter((function(t){return t.name===r.name}));if(o.length>0){var s=o[0];if(s.type!==e)throw new Error("A metric named "+r.name+" is already defined with different type.");return void 0!==n&&s.update(n).catch((function(){})),s}var a=i(r);return g.push(a),a}var w={get name(){return c},get description(){return u},get repo(){return d},get parent(){return p},path:h,id:l,root:v,get subSystems(){return y},get metrics(){return g},subSystem:function(t,e){if(!t||0===t.length)throw new Error("name is required");var n=y.filter((function(e){return e.name===t}));if(n.length>0)return n[0];var i=J(t,d,a,w,e);return y.push(i),i},getState:function(){return f},setState:function(t,e){f={state:t,description:e},a.updateSystem(w,f)},stringMetric:function(t,e){return m(t,A,e,(function(t){return new U(t,w,a,e)}))},timestampMetric:function(t,e){return m(t,P,e,(function(t){return new V(t,w,a,e)}))},objectMetric:function(t,e){return m(t,M,e,(function(t){return new H(t,w,a,e)}))},numberMetric:function(t,e){return m(t,T,e,(function(t){return new q(t,w,a,e)}))},getAggregateState:function(){var t=[];return Object.keys(f).length>0&&t.push({name:c,path:h,state:f.state,description:f.description}),y.forEach((function(e){var n=e.getAggregateState();n.length>0&&t.push.apply(t,n)})),t}};return a.createSystem(w),w}var z=function(){function t(t,e){e.init(this),this.root=J("",this,e),this.addSystemMetrics(this.root,t.clickStream||void 0===t.clickStream)}return t.prototype.addSystemMetrics=function(t,e){if("undefined"!=typeof navigator&&t.stringMetric("UserAgent",navigator.userAgent),e&&"undefined"!=typeof document){var n=t.subSystem("ClickStream"),i=function(t){if(t.target){var e=t.target;n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:t.target?e.className:"",id:e.id,type:"<"+e.tagName.toLowerCase()+">",href:e.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",i):document.attachEvent("onclick",i)}t.stringMetric("StartTime",(new Date).toString());var r=t.stringMetric("StartURL",""),o=t.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;r.update(s)}void 0!==window.glue42gd&&o.update(window.glue42gd.appName)}},t}(),K=function(){function t(){}return t.prototype.init=function(t){},t.prototype.createSystem=function(t){return Promise.resolve()},t.prototype.updateSystem=function(t,e){return Promise.resolve()},t.prototype.createMetric=function(t){return Promise.resolve()},t.prototype.updateMetric=function(t){return Promise.resolve()},t}(),Y=function(){function t(t,e,n){this.api=t,this.lastCount=0,this.initialPublishTimeout=1e4,this.publishInterval=6e4,this.initialPublishTimeout=null!=e?e:this.initialPublishTimeout,this.publishInterval=null!=n?n:this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}return t.prototype.scheduleCollection=function(){var t=this;setTimeout((function(){t.collect(),setInterval((function(){t.collect()}),t.publishInterval)}),this.initialPublishTimeout)},t.prototype.collect=function(){try{this.collectMemory(),this.collectEntries()}catch(t){}},t.prototype.collectMemory=function(){var t=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:t.totalJSHeapSize,usedJSHeapSize:t.usedJSHeapSize}))},t.prototype.collectEntries=function(){var t=window.performance.getEntries();t.length<=this.lastCount||(this.lastCount=t.length,this.system.stringMetric("entries",JSON.stringify(t)))},t}(),Z=function(t){var e;e=t.connection&&"object"==typeof t.connection?function(t,e){var n,i,r=this;if(!t||"object"!=typeof t)throw new Error("Connection is required parameter");var o=function(t){s(t.root)},s=function(t){a(t),t.metrics.forEach((function(t){c(t)})),t.subSystems.forEach((function(t){s(t)}))},a=function(t){return x(r,void 0,void 0,(function(){var e,r;return k(this,(function(o){switch(o.label){case 0:return void 0===t.parent?[2]:[4,n];case 1:return o.sent(),e={name:N(t.path.join("/")+"/"+t.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}},r={type:"define",metrics:[e]},i.send(r),[2]}}))}))},c=function(t){return x(r,void 0,void 0,(function(){var e,r,o;return k(this,(function(s){switch(s.label){case 0:return e=d(t),[4,n];case 1:return s.sent(),r=O(e),o={type:"define",metrics:[r]},i.send(o),void 0!==e.value&&u(e),[2]}}))}))},u=function(t){if(p()){var e=L(t),n={type:"publish",values:[{name:N(t.path.join("/")+"/"+t.name),value:e,timestamp:Date.now()}]};return i.sendFireAndForget(n)}return Promise.resolve()},d=function(t){var e=S({},t);return"object"==typeof t.value&&null!==t.value&&(e.value=S({},t.value)),e},p=function(){var t;try{return(null!==(t=e.canUpdateMetric)&&void 0!==t?t:function(){return!0})()}catch(t){return!0}};return{init:function(r){var s;n=new Promise((function(t){s=t})),(i=t.domain("metrics")).onJoined((function(t){!t&&s&&(s(),s=void 0);var e={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};i.send(e),t&&o(r)})),i.join({system:e.system,service:e.service,instance:e.instance})},createSystem:a,updateSystem:function(e,o){return x(r,void 0,void 0,(function(){var r,s,a;return k(this,(function(c){switch(c.label){case 0:return[4,n];case 1:return c.sent(),r={type:"publish",values:[{name:N(e.path.join("/")+"/"+e.name+"/State"),value:{Description:o.description,Value:o.state},timestamp:Date.now()}]},i.send(r),s=F(e),a={type:"publish",peer_id:t.peerId,values:[{name:"/State",value:{Description:s.description,Value:s.value},timestamp:Date.now()}]},i.send(a),[2]}}))}))},createMetric:c,updateMetric:function(t){return x(r,void 0,void 0,(function(){var e;return k(this,(function(i){switch(i.label){case 0:return e=d(t),[4,n];case 1:return i.sent(),u(e),[2]}}))}))}}}(t.connection,t):new K;var n=new z(t,e).root;t.disableAutoAppSystem||(n=n.subSystem("App"));var i=function(t){var e,n=t.subSystem("reporting"),i={name:"features"},r=function(t,r,o){if(void 0===t||""===t)throw new Error("name is mandatory");if(void 0===r||""===r)throw new Error("action is mandatory");if(void 0===o||""===o)throw new Error("payload is mandatory");e?e.update({name:t,action:r,payload:o}):e=n.objectMetric(i,{name:t,action:r,payload:o})};return t.featureMetric=r,t}(n);return function(t,e){var n,i;if("undefined"==typeof window)return;var r=null===(i=null===(n=null===window||void 0===window?void 0:window.glue42gd)||void 0===n?void 0:n.metrics)||void 0===i?void 0:i.pagePerformanceMetrics;r&&(e=r);(null==e?void 0:e.enabled)&&new Y(t,e.initialPublishTimeout,e.publishInterval)}(i,t.pagePerformanceMetrics),i};function Q(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function i(n,i){var r=n instanceof Error?n:new Error(n);if(e)e(r);else{var o='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+r.stack;if(t)switch(t.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(t,e,r){var o=n[t];return o||(o=[],n[t]=o),o.push(e),r&&setTimeout((function(){r.forEach((function(r){var o;if(null===(o=n[t])||void 0===o?void 0:o.includes(e))try{Array.isArray(r)?e.apply(void 0,r):e.apply(void 0,[r])}catch(e){i(e,t)}}))}),0),function(){var i=n[t];i&&(0===(i=i.reduce((function(t,n,i){return n===e&&t.length===i||t.push(n),t}),[])).length?delete n[t]:n[t]=i)}},execute:function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var o=n[t];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var r=n.apply(void 0,e);s.push(r)}catch(e){s.push(void 0),i(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}Q.default=Q;var X=Q,$=function(){function t(t,e){var n=this;this.registry=X(),this.gw=t.facade,this.gw.connect((function(t,e){n.messageHandler(e)})).then((function(t){n.client=t}))}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.client?(this.client.send(t),Promise.resolve(void 0)):Promise.reject("not connected")},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"in-memory"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),tt=function(){function t(t,e){var n=this;this.logger=e,this.registry=X(),this.worker=new SharedWorker(t),this.worker.port.onmessage=function(t){n.messageHandler(t.data)}}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.worker.port.postMessage(t),Promise.resolve()},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"shared-worker"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),et=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?void 0:t}},t.isNode=function(){if(void 0!==t._isNode)return t._isNode;if("undefined"!=typeof window)return t._isNode=!1,!1;try{t._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(e){t._isNode=!1}return t._isNode},t}(),nt=function(){function t(){var t=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(e,n){t.resolve=function(n){t.resolved=!0,e(n)},t.reject=function(e){t.rejected=!0,n(e)}}))}return t.delay=function(t){return new Promise((function(e){return setTimeout(e,t)}))},Object.defineProperty(t.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),t}(),it={};function rt(t){var e=it[t];if(e)return e;var n=[];function i(){return(new Date).getTime()}var r,o,s=i();function a(t,e){var r=null!=e?e:i(),o=0;n.length>0&&(o=r-n[n.length-1].time),n.push({name:t,time:r,diff:o})}a("start",s);var c={get startTime(){return s},get endTime(){return r},get period(){return o},stop:function(){return a("end",r=i()),o=r-s},mark:a,marks:n};return it[t]=c,c}var ot=et.isNode()?require("ws"):window.WebSocket,st=function(){function t(t,e){if(this.startupTimer=rt("connection"),this._running=!0,this._registry=X(),this.wsRequests=[],this.settings=t,this.logger=e,!this.settings.ws)throw new Error("ws is missing")}return t.prototype.onMessage=function(t){return this._registry.add("onMessage",t)},t.prototype.send=function(t,e){var n=this;return new Promise((function(e,i){n.waitForSocketConnection((function(){var r;try{null===(r=n.ws)||void 0===r||r.send(t),e()}catch(t){i(t)}}),i)}))},t.prototype.open=function(){var t=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(e,n){t.waitForSocketConnection(e,n)}))},t.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},t.prototype.onConnectedChanged=function(t){return this._registry.add("onConnectedChanged",t)},t.prototype.name=function(){return"ws "+this.settings.ws},t.prototype.reconnect=function(){var t;null===(t=this.ws)||void 0===t||t.close();var e=new nt;return this.waitForSocketConnection((function(){e.resolve()})),e.promise},t.prototype.waitForSocketConnection=function(t,e){var n;e=null!=e?e:function(){},this._running?1!==(null===(n=this.ws)||void 0===n?void 0:n.readyState)?(this.wsRequests.push({callback:t,failed:e}),this.wsRequests.length>1||this.openSocket()):t():e("wait for socket on "+this.settings.ws+" failed - socket closed by user")},t.prototype.openSocket=function(t,e){return x(this,void 0,void 0,(function(){var n=this;return k(this,(function(i){switch(i.label){case 0:if(this.startupTimer.mark("opening-socket"),void 0===t&&(t=this.settings.reconnectInterval),void 0!==e){if(0===e)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+e+" more times (every "+t+" ms)")}i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return i.sent(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState(),[3,4];case 3:return i.sent(),setTimeout((function(){var i=void 0===e?void 0:e-1;n.openSocket(t,i)}),t),[3,4];case 4:return[2]}}))}))},t.prototype.initiateSocket=function(){var t=this,e=new nt;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new ot(this.settings.ws||""),this.ws.onerror=function(n){var i="";try{i=JSON.stringify(n)}catch(t){var r=new WeakSet;i=JSON.stringify(n,(function(t,e){if("object"==typeof e&&null!==e){if(r.has(e))return;r.add(e)}return e}))}e.reject("error"),t.notifyStatusChanged(!1,i)},this.ws.onclose=function(n){t.logger.info("ws closed "+n),e.reject("closed"),t.notifyStatusChanged(!1)},this.ws.onopen=function(){var n;t.startupTimer.mark("ws-opened"),t.logger.info("ws opened "+(null===(n=t.settings.identity)||void 0===n?void 0:n.application)),e.resolve(),t.notifyStatusChanged(!0)},this.ws.onmessage=function(e){t._registry.execute("onMessage",e.data)},e.promise},t.prototype.notifyForSocketState=function(t){this.wsRequests.forEach((function(e){t?e.failed&&e.failed(t):e.callback()})),this.wsRequests=[]},t.prototype.notifyStatusChanged=function(t,e){this._registry.execute("onConnectedChanged",t,e)},t}();var at=1;var ct,ut,dt,pt={nextValue:function(){return(at=(9301*at+49297)%233280)/233280},seed:function(t){at=t}},ht="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function ft(){dt=!1}function lt(t){if(t){if(t!==ct){if(t.length!==ht.length)throw new Error("Custom alphabet for shortid must be "+ht.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+ht.length+" unique characters. These characters were not unique: "+e.join(", "));ct=t,ft()}}else ct!==ht&&(ct=ht,ft())}function vt(){return dt||(dt=function(){ct||lt(ht);for(var t,e=ct.split(""),n=[],i=pt.nextValue();e.length>0;)i=pt.nextValue(),t=Math.floor(i*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var yt={characters:function(t){return lt(t),ct},seed:function(t){pt.seed(t),ut!==t&&(ft(),ut=t)},lookup:function(t){return vt()[t]},shuffled:vt},gt="object"==typeof window&&(window.crypto||window.msCrypto);var mt=function(){if(!gt||!gt.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return gt.getRandomValues(t),48&t[0]};var wt=function(t,e){for(var n,i=0,r="";!n;)r+=t(e>>4*i&15|mt()),n=e<Math.pow(16,i+1),i++;return r};var bt=function(t){var e=yt.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var _t=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=yt.characters(),n=t.length,i=0;i<n;i++)if(-1===e.indexOf(t[i]))return!1;return!0},It=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e,n,i=0;function r(){var t="",r=Math.floor(.001*(Date.now()-1459707606518));return r===n?e++:(e=0,n=r),t+=wt(yt.lookup,6),t+=wt(yt.lookup,i),e>0&&(t+=wt(yt.lookup,e)),t+=wt(yt.lookup,r)}t.exports=r,t.exports.generate=r,t.exports.seed=function(e){return yt.seed(e),t.exports},t.exports.worker=function(e){return i=e,t.exports},t.exports.characters=function(t){return void 0!==t&&yt.characters(t),yt.shuffled()},t.exports.decode=bt,t.exports.isValid=_t})),St=(It.generate,It.seed,It.worker,It.characters,It.decode,It.isValid,It);function xt(t,e,n,i,r){null==t&&(t="global"),i=i||["success"],r=r||["error"];var o,s=!1,a=!1,c=!1,u=X();e.disconnected((function(){c=!1,n.debug("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),e.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),p(o))})),e.on("success",(function(t){return f(t)})),e.on("error",(function(t){return h(t)})),e.on("result",(function(t){return f(t)})),i&&i.forEach((function(t){e.on(t,(function(t){return f(t)}))})),r&&r.forEach((function(t){e.on(t,(function(t){return h(t)}))}));var d={};function p(e){return o=e,new Promise((function(i,r){if(s)i();else{var o;if("global"===t)o=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining domain "+t),o=v({type:"join",destination:t,domain:"global",options:e});o.then((function(){!function(){n.debug("did join "+t),s=!0;var e=a;a=!1,u.execute("onJoined",e)}(),i()})).catch((function(e){n.debug("error joining "+t+" domain: "+JSON.stringify(e)),r(e)}))}}))}function h(e){if(t===e.domain){var n=e.request_id;if(n){var i=d[n];i&&i.error(e)}}}function f(e){if(e.domain===t){var n=e.request_id;if(n){var i=d[n];i&&i.success(e)}}}function l(){return St()}function v(i,r,o){o=o||{},i.request_id=i.request_id||l(),i.domain=i.domain||t,o.skipPeerId||(i.peer_id=e.peerId);var s=i.request_id;return new Promise((function(t,a){d[s]={success:function(e){delete d[s],e._tag=r,t(e)},error:function(t){n.warn("GW error - "+JSON.stringify(t)+" for request "+JSON.stringify(i)),delete d[s],t._tag=r,a(t)}},e.send(i,o).catch((function(t){d[s].error({err:t})}))}))}return{join:p,leave:function(){return"global"===t?Promise.resolve():(n.debug("stopping session "+t+"..."),a=!1,v({type:"leave",destination:t,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})))},onJoined:function(t){return s&&t(!1),u.add("onJoined",t)},onLeft:function(t){return s||t(),u.add("onLeft",t)},send:v,sendFireAndForget:function(n){return n.request_id=n.request_id?n.request_id:l(),n.domain=n.domain||t,n.peer_id=e.peerId,e.send(n)},on:function(i,r){e.on(i,(function(e){if(e.domain===t)try{r(e)}catch(t){n.error("Callback  failed: "+t+" \n "+t.stack+" \n msg was: "+JSON.stringify(e),t)}}))},loggedIn:function(t){return e.loggedIn(t)},connected:function(t){return e.connected(t)},disconnected:function(t){return e.disconnected(t)},get peerId(){return e.peerId},get domain(){return t}}}var kt=function(){function t(t,e,n){var i=this;this.connection=t,this.settings=e,this.logger=n,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=X(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],t.disconnected((function(){i.handleDisconnected()})),this.ping()}return Object.defineProperty(t.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.processStringMessage=function(t){var e=this,n=JSON.parse(t,(function(t,n){if("string"!=typeof n)return n;if(n.length<e.dateMinLen)return n;if(n[0]!==e.datePrefixFirstChar)return n;if(n.substring(0,e.datePrefixLen)!==e.datePrefix)return n;try{var i=parseInt(n.substring(e.datePrefixLen,n.length),10);return isNaN(i)?n:new Date(i)}catch(t){return n}}));return{msg:n,msgType:n.type}},t.prototype.createStringMessage=function(t){var e=Date.prototype.toJSON;try{var n=this.datePrefix;return Date.prototype.toJSON=function(){return n+this.getTime()},JSON.stringify(t)}finally{Date.prototype.toJSON=e}},t.prototype.processObjectMessage=function(t){if(!t.type)throw new Error("Object should have type property");return{msg:t,msgType:t.type}},t.prototype.createObjectMessage=function(t){return t},t.prototype.login=function(t,e){return x(this,void 0,void 0,(function(){var n,i,r,o,s,a,c,u,d,p;return k(this,(function(h){switch(h.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=t,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,n={},this.connection.gatewayToken=t.gatewayToken,!t.gatewayToken)return[3,5];if(!e)return[3,4];h.label=1;case 1:return h.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return u=h.sent(),t.gatewayToken=u,[3,4];case 3:return i=h.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==i?void 0:i.message)||i)),[3,4];case 4:return n.method="gateway-token",n.token=t.gatewayToken,this.connection.gatewayToken=t.gatewayToken,[3,10];case 5:return"sspi"!==t.flowName?[3,9]:(n.provider="win",n.method="access-token",t.flowCallback&&t.sessionId?(r=n,[4,t.flowCallback(t.sessionId,null)]):[3,7]);case 6:return r.token=h.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(t.token)n.method="access-token",n.token=t.token;else{if(!t.username)throw new Error("invalid auth message"+JSON.stringify(t));n.method="secret",n.login=t.username,n.secret=t.password}h.label=10;case 10:o={type:"hello",identity:this.settings.identity,authentication:n},t.sessionId&&(o.request_id=t.sessionId),this.globalDomain=xt("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),s={skipPeerId:!0},this.initialLogin&&(s.retryInterval=this.settings.reconnectInterval,s.maxRetries=this.settings.reconnectAttempts),h.label=11;case 11:h.trys.push([11,19,20,21]),a=void 0,h.label=12;case 12:return[4,this.globalDomain.send(o,void 0,s)];case 13:return"authentication-request"!==(c=h.sent()).type?[3,16]:(u=Buffer.from(c.authentication.token,"base64"),t.flowCallback&&t.sessionId?(d=o.authentication,[4,t.flowCallback(t.sessionId,u)]):[3,15]);case 14:d.token=h.sent().data.toString("base64"),h.label=15;case 15:return o.request_id=t.sessionId,[3,12];case 16:if("welcome"===c.type)return a=c,[3,18];throw"error"===c.type?new Error("Authentication failed: "+c.reason):new Error("Unexpected message type during authentication: "+c.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.info("login successful with peerId "+a.peer_id),this.connection.peerId=a.peer_id,this.connection.resolvedIdentity=a.resolved_identity,this.connection.availableDomains=a.available_domains,a.options&&(this.connection.token=a.options.access_token,this.connection.info=a.options.info),this.setLoggedIn(!0),[2,a.resolved_identity];case 19:throw p=h.sent(),this.logger.error("error sending hello message - "+(p.message||p.msg||p.reason||p),p),p;case 20:return t&&t.flowCallback&&t.sessionId&&t.flowCallback(t.sessionId,null),[7];case 21:return[2]}}))}))},t.prototype.logout=function(){return x(this,void 0,void 0,(function(){var t;return k(this,(function(e){switch(e.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),t=this.sessions.map((function(t){t.leave()})),[4,Promise.all(t)];case 1:return e.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this._isLoggedIn&&t(),this.registry.add("onLoggedIn",t)},t.prototype.domain=function(t,e,n,i){var r=this.sessions.filter((function(e){return e.domain===t}))[0];return r||(r=xt(t,this.connection,e,n,i),this.sessions.push(r)),r},t.prototype.handleDisconnected=function(){var t=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(t.handleDisconnected,1e3)}))}},t.prototype.setLoggedIn=function(t){this._isLoggedIn=t,this._isLoggedIn&&this.registry.execute("onLoggedIn")},t.prototype.ping=function(){var t=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){t.ping()}),3e4))},t.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(t){return t.token})):Promise.reject(new Error("no global domain session"))},t.prototype.getNewGWToken=function(){if(void 0!==typeof window){var t=window.glue42gd;if(t)return t.getGWToken()}return Promise.reject(new Error("not running in GD"))},t}(),Ct=function(){function t(t){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var e=0,n=t;e<n.length;e++){var i=n[e];this.specs[i.name]=i,this.specsNames.push(i.name)}}return t.prototype.init=function(t){var e=this;this.connection=t;for(var n=0,i=this.specsNames;n<i.length;n++)for(var r=i[n],o=function(n){var i=s.subsRefCount[n];if(i||(i=0),i+=1,s.subsRefCount[n]=i,i>1)return"continue";var r=t.on(n,(function(t){return e.processMessage(n,t)}));s.subs[n]=r},s=this,a=0,c=this.specs[r].types;a<c.length;a++){o(c[a])}},t.prototype.processMessage=function(t,e){if(!this.isDone&&e)for(var n=0,i=this.specsNames;n<i.length;n++){var r=i[n];if(-1!==this.specs[r].types.indexOf(t)){var o=this.messages[r]||[];this.messages[r]=o,o.push(e)}}},t.prototype.drain=function(t,e){var n;e&&(this.messages[t]||[]).forEach(e),delete this.messages[t];for(var i=0,r=this.specs[t].types;i<r.length;i++){var o=r[i];this.subsRefCount[o]-=1,this.subsRefCount[o]<=0&&(null===(n=this.connection)||void 0===n||n.off(this.subs[o]),delete this.subs[o],delete this.subsRefCount[o])}delete this.specs[t],this.specs.length||(this.isDone=!0)},t}(),At=function(){function t(t,e){if(this.settings=t,this.logger=e,this.messageHandlers={},this.ids=1,this.registry=X(),this._connected=!1,this.isTrace=!1,(t=t||{}).reconnectAttempts=t.reconnectAttempts||10,t.reconnectInterval=t.reconnectInterval||1e3,t.inproc)this.transport=new $(t.inproc,e.subLogger("inMemory"));else if(t.sharedWorker)this.transport=new tt(t.sharedWorker,e.subLogger("shared-worker"));else{if(void 0===t.ws)throw new Error("No connection information specified");this.transport=new st(t,e.subLogger("ws"))}this.isTrace=e.canPublish("trace"),e.info("starting with "+this.transport.name()+" transport"),this.protocol=new kt(this,t,e.subLogger("protocol")),this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this.transport.onMessage(this.handleTransportMessage.bind(this)),t.replaySpecs&&t.replaySpecs.length&&(this.replayer=new Ct(t.replaySpecs),this.replayer.init(this))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;return null===(t=this.protocol)||void 0===t?void 0:t.protocolVersion},enumerable:!0,configurable:!0}),t.prototype.send=function(t,e){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var n=this.protocol.createObjectMessage(t);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(n)),this.transport.sendObject(n,e)}var i=this.protocol.createStringMessage(t);return this.isTrace&&this.logger.trace(">> "+i),this.transport.send(i,e)},t.prototype.on=function(t,e){t=t.toLowerCase(),void 0===this.messageHandlers[t]&&(this.messageHandlers[t]={});var n=this.ids++;return this.messageHandlers[t][n]=e,{type:t,id:n}},t.prototype.off=function(t){delete this.messageHandlers[t.type.toLowerCase()][t.id]},Object.defineProperty(t.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.connected=function(t){var e=this;return this.protocol.loggedIn((function(){t(e.settings.ws||e.settings.sharedWorker||"")}))},t.prototype.disconnected=function(t){return this.registry.add("disconnected",t)},t.prototype.login=function(t,e){return x(this,void 0,void 0,(function(){var n;return k(this,(function(i){switch(i.label){case 0:return[4,this.transport.open()];case 1:return i.sent(),rt("connection").mark("transport-opened"),n=this.protocol.login(t,e),rt("connection").mark("protocol-logged-in"),[2,n]}}))}))},t.prototype.logout=function(){return x(this,void 0,void 0,(function(){return k(this,(function(t){switch(t.label){case 0:return[4,this.protocol.logout()];case 1:return t.sent(),[4,this.transport.close()];case 2:return t.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this.protocol.loggedIn(t)},t.prototype.domain=function(t,e,n){return this.protocol.domain(t,this.logger.subLogger("domain="+t),e,n)},t.prototype.authToken=function(){return this.protocol.authToken()},t.prototype.reconnect=function(){return this.transport.reconnect()},t.prototype.distributeMessage=function(t,e){var n=this,i=this.messageHandlers[e.toLowerCase()];void 0!==i&&Object.keys(i).forEach((function(e){var r=i[e];if(void 0!==r)try{r(t)}catch(t){try{n.logger.error("Message handler failed with "+t.stack,t)}catch(e){console.log("Message handler failed",t)}}}))},t.prototype.handleConnectionChanged=function(t){this._connected!==t&&(this._connected=t,t?this.registry.execute("connected"):this.registry.execute("disconnected"))},t.prototype.handleTransportMessage=function(t){var e;e="string"==typeof t?this.protocol.processStringMessage(t):this.protocol.processObjectMessage(t),this.isTrace&&this.logger.trace("<< "+JSON.stringify(e)),this.distributeMessage(e.msg,e.msgType)},t}(),Tt=["trace","debug","info","warn","error","off"],Pt=function(){function t(t,e,n){this.name=t,this.parent=e,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=t,this.path=e?e.path+"."+t:t,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}return t.prototype.subLogger=function(e){var n=this.subLoggers.filter((function(t){return t.name===e}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(t){if(t===e)throw new Error("This sub logger name is not allowed.")}));var i=new t(e,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(i),i},t.prototype.publishLevel=function(t){var e;return t&&(this._publishLevel=t),this._publishLevel||(null===(e=this.parent)||void 0===e?void 0:e.publishLevel())},t.prototype.consoleLevel=function(t){var e;return t&&(this._consoleLevel=t),this._consoleLevel||(null===(e=this.parent)||void 0===e?void 0:e.consoleLevel())},t.prototype.log=function(t,e,n){this.publishMessage(e||"info",t,n)},t.prototype.trace=function(t){this.log(t,"trace")},t.prototype.debug=function(t){this.log(t,"debug")},t.prototype.info=function(t){this.log(t,"info")},t.prototype.warn=function(t){this.log(t,"warn")},t.prototype.error=function(t,e){this.log(t,"error")},t.prototype.canPublish=function(t,e){return Tt.indexOf(t)>=Tt.indexOf(e||this.consoleLevel()||"trace")},t.prototype.publishMessage=function(e,n,i){var r=this.loggerFullName;if("error"===e&&!i){var o=new Error;o.stack&&(n=n+"\n"+o.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(e,this.publishLevel())){var s=t.Interop;if(s)try{s.methods({name:t.InteropMethodName}).length>0&&s.invoke(t.InteropMethodName,{msg:""+n,logger:r,level:e})}catch(t){}}if(this.canPublish(e)){var a="";if(this.includeTimeAndLevel){var c=new Date;a="["+(c.getHours()+":"+c.getMinutes()+":"+c.getSeconds()+":"+c.getMilliseconds())+"] ["+e+"] "}var u=""+a+r+": "+n;switch(e){case"trace":this.logFn.debug(u);break;case"debug":this.logFn.debug?this.logFn.debug(u):this.logFn.log(u);break;case"info":this.logFn.info(u);break;case"warn":this.logFn.warn(u);break;case"error":this.logFn.error(u,i)}}},t.InteropMethodName="T42.AppLogger.Log",t}(),Mt="create-context",jt="created",Et="destroyed",Ot="context-created",Rt="context-added",Nt="subscribe-context",Lt="subscribed-context",Wt="unsubscribe-context",Dt="destroy-context",Ft="context-destroyed",Bt="update-context",Gt="context-updated",qt="joined",Ht={get name(){return"context"},get types(){return[Mt,jt,Et,Ot,Rt,Nt,Lt,Wt,Dt,Ft,Bt,Gt,qt]}},Ut="5.2.6";var Vt=function(){function t(t,e,n,i){this.updateCallbacks={},this.contextId=t,this.name=e,this.isAnnounced=n,this.activityId=i,this.context={}}return t.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},t.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},t}();function Jt(t,e,n){try{if((null==n?void 0:n.canPublish("trace"))&&(null==n||n.trace("applying context delta "+JSON.stringify(e)+" on context "+JSON.stringify(t))),!e)return t;if(e.reset)return t=S({},e.reset);if(t=zt(t,void 0),e.commands){for(var i=0,r=e.commands;i<r.length;i++){var o=r[i];"remove"===o.type?Qt(t,o.path):"set"===o.type&&Zt(t,o.value,o.path)}return t}var s=e.added,a=e.updated,c=e.removed;return s&&Object.keys(s).forEach((function(e){t[e]=s[e]})),a&&Object.keys(a).forEach((function(e){Kt(e,t,a)})),c&&c.forEach((function(e){delete t[e]})),t}catch(i){return null==n||n.error("error applying context delta "+JSON.stringify(e)+" on context "+JSON.stringify(t),i),t}}function zt(t,e){if(e=e||new WeakMap,Object(t)!==t)return t;if(t instanceof Set)return new Set(t);if(e.has(t))return e.get(t);var n=t instanceof Date?new Date(t):t instanceof RegExp?new RegExp(t.source,t.flags):t.constructor?new t.constructor:Object.create(null);return e.set(t,n),t instanceof Map&&Array.from(t,(function(t){var i=t[0],r=t[1];return n.set(i,zt(r,e))})),Object.assign.apply(Object,C([n],Object.keys(t).map((function(n){var i;return(i={})[n]=zt(t[n],e),i}))))}var Kt=function(t,e,n){var i=n[t];if(void 0===i)return e;var r=e[t];return r&&i?"string"==typeof r||"number"==typeof r||"boolean"==typeof r||"string"==typeof i||"number"==typeof i||"boolean"==typeof i||Array.isArray(r)||Array.isArray(i)?(e[t]=i,e):(e[t]=Object.assign({},r,i),e):(e[t]=i,e)};function Yt(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;for(var n in t)if(t.hasOwnProperty(n)){if(!e.hasOwnProperty(n))return!1;if(t[n]!==e[n]){if("object"!=typeof t[n])return!1;if(!Yt(t[n],e[n]))return!1}}for(var n in e)if(e.hasOwnProperty(n)&&!t.hasOwnProperty(n))return!1;return!0}function Zt(t,e,n){var i,r=n.split(".");for(i=0;i<r.length-1;i++)t[r[i]]||(t[r[i]]={}),"object"!=typeof t[r[i]]&&(t[r[i]]={}),t=t[r[i]];t[r[i]]=e}function Qt(t,e){var n,i=e.split(".");for(n=0;n<i.length-1;n++){if(!t[i[n]])return;t=t[i[n]]}delete t[i[n]]}var Xt,$t=function(){function t(t){var e,n=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._protocolVersion=void 0,this._connection=t.connection,this._logger=t.logger,this._gw3Session=this._connection.domain("global",[Ot,Lt,Ft,Gt]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(e=this._connection.replayer)||void 0===e||e.drain(Ht.name,(function(t){var e=t.type;e&&(e===Ot||e===Rt||e===jt?n.handleContextCreatedMessage(t):e===Lt||e===Gt||e===qt?n.handleContextUpdatedMessage(t):e!==Ft&&e!==Et||n.handleContextDestroyedMessage(t))}))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;if(!this._protocolVersion){var e=this._connection.availableDomains.find((function(t){return"context"===t.uri}));this._protocolVersion=null!==(t=null==e?void 0:e.version)&&void 0!==t?t:1}return this._protocolVersion},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"setPathSupported",{get:function(){return this.protocolVersion>=2},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){for(var t=0,e=this._gw3Subscriptions;t<e.length;t++){var n=e[t];this._connection.off(n)}for(var i in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(i)&&delete this._contextNameToData[i]},t.prototype.createContext=function(t,e){var n=this;return this._gw3Session.send({type:Mt,domain:"global",name:t,data:e,lifetime:"retained"}).then((function(i){n._contextNameToId[t]=i.context_id,n._contextIdToName[i.context_id]=t;var r=n._contextNameToData[t]||new Vt(i.context_id,t,!0,void 0);return r.isAnnounced=!0,r.name=t,r.contextId=i.context_id,r.context=e,n._contextNameToData[t]=r,i.context_id}))},t.prototype.all=function(){var t=this;return Object.keys(this._contextNameToData).filter((function(e){return t._contextNameToData[e].isAnnounced}))},t.prototype.update=function(t,e){var n;return x(this,void 0,void 0,(function(){var i,r,o,s=this;return k(this,(function(a){switch(a.label){case 0:return(i=this._contextNameToData[t])&&i.isAnnounced?(r=i.context,i.hasCallbacks()?[3,2]:[4,this.get(i.name)]):[2,this.createContext(t,e)];case 1:r=a.sent(),a.label=2;case 2:return o=2===this.protocolVersion?this.calculateContextDeltaV2(r,e):this.calculateContextDeltaV1(r,e),Object.keys(o.added).length||Object.keys(o.updated).length||o.removed.length||(null===(n=o.commands)||void 0===n?void 0:n.length)?[2,this._gw3Session.send({type:Bt,domain:"global",context_id:i.contextId,delta:o},{},{skipPeerId:!1}).then((function(t){s.handleUpdated(i,o,{updaterId:t.peer_id})}))]:[2,Promise.resolve()]}}))}))},t.prototype.set=function(t,e){var n=this,i=this._contextNameToData[t];return i&&i.isAnnounced?this._gw3Session.send({type:Bt,domain:"global",context_id:i.contextId,delta:{reset:e}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(i,{reset:e,added:{},removed:[],updated:{}},{updaterId:t.peer_id})})):this.createContext(t,e)},t.prototype.setPath=function(t,e,n){return this.setPathSupported?this.setPaths(t,[{path:e,value:n}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")},t.prototype.setPaths=function(t,e){var n=this;if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");var i=this._contextNameToData[t];if(!i||!i.isAnnounced){for(var r={},o=0,s=e;o<s.length;o++){Zt(r,(d=s[o]).value,d.path)}return this.createContext(t,r)}for(var a=[],c=0,u=e;c<u.length;c++){var d;null===(d=u[c]).value?a.push({type:"remove",path:d.path}):a.push({type:"set",path:d.path,value:d.value})}return this._gw3Session.send({type:Bt,domain:"global",context_id:i.contextId,delta:{commands:a}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(i,{added:{},removed:[],updated:{},commands:a},{updaterId:t.peer_id})}))},t.prototype.get=function(t){var e,n=this,i=this._contextNameToData[t];if(!i||!i.isAnnounced)return Promise.resolve({});if(i&&!i.hasCallbacks())return new Promise((function(e,i){return x(n,void 0,void 0,(function(){var n=this;return k(this,(function(i){return this.subscribe(t,(function(t,i,r,o){n.unsubscribe(o),e(t)})),[2]}))}))}));var r=null!==(e=null==i?void 0:i.context)&&void 0!==e?e:{};return Promise.resolve(r)},t.prototype.subscribe=function(t,e){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var i=this._contextNameToData[t];if(!i||!i.isAnnounced)return i=i||new Vt(void 0,t,!1,void 0),this._contextNameToData[t]=i,i.updateCallbacks[n]=e,Promise.resolve(n);var r,o=i.hasCallbacks();return i.updateCallbacks[n]=e,o||i.joinedActivity||i.context&&i.sentExplicitSubscription?(e(r=zt(i.context),r,[],n),Promise.resolve(n)):this.sendSubscribe(i).then((function(){return n}))},t.prototype.unsubscribe=function(t){for(var e=0,n=Object.keys(this._contextNameToData);e<n.length;e++){var i=n[e],r=(this._contextNameToId[i],this._contextNameToData[i]);if(!r)return;var o=r.hasCallbacks();delete r.updateCallbacks[t],r.isAnnounced&&o&&!r.hasCallbacks()&&r.sentExplicitSubscription&&this.sendUnsubscribe(r),r.isAnnounced||r.hasCallbacks()||delete this._contextNameToData[i]}},t.prototype.destroy=function(t){var e=this._contextNameToData[t];return e?this._gw3Session.send({type:Dt,domain:"global",context_id:e.contextId}).then((function(t){})):Promise.reject("context with "+t+" does not exist")},t.prototype.handleUpdated=function(t,e,n){var i=t.context;t.context=Jt(t.context,e,this._logger),this._contextNameToData[t.name]!==t||Yt(i,t.context)||this.invokeUpdateCallbacks(t,e,n)},t.prototype.subscribeToContextCreatedMessages=function(){for(var t=0,e=[Rt,Ot,jt];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextCreatedMessage=function(t){var e=t.type;e===jt?(this._contextNameToId[t.activity_id]=t.context_id,this._contextIdToName[t.context_id]=t.activity_id):e===Rt&&(this._contextNameToId[t.name]=t.context_id,this._contextIdToName[t.context_id]=t.name);var n=this._contextIdToName[t.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+t.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+t.context_id);var i=this._contextNameToData[n];if(i){if(i.isAnnounced)return;if(!i.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");i.isAnnounced=!0,i.contextId=t.context_id,i.activityId=t.activity_id,i.sentExplicitSubscription||this.sendSubscribe(i)}else this._contextNameToData[n]=i=new Vt(t.context_id,n,!0,t.activity_id)},t.prototype.subscribeToContextUpdatedMessages=function(){for(var t=0,e=[Gt,Lt,qt];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextUpdatedMessage=function(t){var e=t.type,n=t.context_id,i=this._contextNameToData[this._contextIdToName[n]],r=!i||!i.isAnnounced;if(e===qt)i?(i.contextId=n,i.isAnnounced=!0,i.activityId=t.activity_id):(i=new Vt(n,t.activity_id,!0,t.activity_id),this._contextNameToData[t.activity_id]=i,this._contextIdToName[n]=t.activity_id,this._contextNameToId[t.activity_id]=n),i.joinedActivity=!0;else if(!i||!i.isAnnounced)return void(e===Lt?((i=i||new Vt(n,t.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[t.name]=i,this._contextIdToName[n]=t.name,this._contextNameToId[t.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var o=i.context;if(e===Lt)i.context=t.data||{};else if(e===qt)i.context=t.context_snapshot||{};else{if(e!==Gt)throw new Error("Unrecognized context update message "+e);i.context=Jt(i.context,t.delta,this._logger)}!r&&Yt(i.context,o)&&e!==Lt||this.invokeUpdateCallbacks(i,t.delta,{updaterId:t.updater_id})},t.prototype.invokeUpdateCallbacks=function(t,e,n){if((e=e||{added:{},updated:{},reset:{},removed:[]}).commands){e.added=e.updated=e.reset={},e.removed=[];for(var i=0,r=e.commands;i<r.length;i++){var o=r[i];"remove"===o.type?(-1===o.path.indexOf(".")&&e.removed.push(o.path),Zt(e.updated,null,o.path)):"set"===o.type&&Zt(e.updated,o.value,o.path)}}for(var s in t.updateCallbacks)if(t.updateCallbacks.hasOwnProperty(s))try{(0,t.updateCallbacks[s])(zt(t.context),Object.assign({},e.added||{},e.updated||{},e.reset||{}),e.removed,parseInt(s,10),n)}catch(t){this._logger.debug("callback error: "+JSON.stringify(t))}},t.prototype.subscribeToContextDestroyedMessages=function(){for(var t=0,e=[Ft,Et];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextDestroyedMessage=function(t){var e,n;if(t.type===Et){if(n=t.activity_id,!(e=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+t.activity_id)}else if(e=t.context_id,!(n=this._contextIdToName[e]))return void this._logger.error("Received 'destroyed' for unknown context: "+t.context_id);delete this._contextIdToName[e],delete this._contextNameToId[n];var i=this._contextNameToData[n];delete this._contextNameToData[n],i&&i.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+e)},t.prototype.sendSubscribe=function(t){return t.sentExplicitSubscription=!0,this._gw3Session.send({type:Nt,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.sendUnsubscribe=function(t){return t.sentExplicitSubscription=!1,this._gw3Session.send({type:Wt,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.calculateContextDeltaV1=function(t,e){var n={added:{},updated:{},removed:[],reset:void 0};if(t)for(var i=0,r=Object.keys(t);i<r.length;i++){var o=r[i];-1===Object.keys(e).indexOf(o)||null===e[o]||Yt(t[o],e[o])||(n.updated[o]=e[o])}for(var s=0,a=Object.keys(e);s<a.length;s++){o=a[s];t&&-1!==Object.keys(t).indexOf(o)?null===e[o]&&n.removed.push(o):null!==e[o]&&(n.added[o]=e[o])}return n},t.prototype.calculateContextDeltaV2=function(t,e){for(var n,i,r={added:{},updated:{},removed:[],reset:void 0,commands:[]},o=0,s=Object.keys(e);o<s.length;o++){var a=s[o];if(null!==e[a])Yt(t?t[a]:null,e[a])||null===(n=r.commands)||void 0===n||n.push({type:"set",path:a,value:e[a]});else null===(i=r.commands)||void 0===i||i.push({type:"remove",path:a})}return r},t}(),te=function(){function t(t){this._bridge=new $t(t)}return t.prototype.all=function(){return this._bridge.all()},t.prototype.update=function(t,e){return this.checkName(t),this.checkData(e),this._bridge.update(t,e)},t.prototype.set=function(t,e){return this.checkName(t),this.checkData(e),this._bridge.set(t,e)},t.prototype.setPath=function(t,e,n){return this.checkName(t),this.checkPath(e),""===e?(this.checkData(n),this.set(t,n)):this._bridge.setPath(t,e,n)},t.prototype.setPaths=function(t,e){if(this.checkName(t),!Array.isArray(e))throw new Error("Please provide the paths as an array of PathValues!");for(var n=0,i=e;n<i.length;n++){var r=i[n],o=r.path,s=r.value;this.checkPath(o),""===o&&this.checkData(s)}return this._bridge.setPaths(t,e)},t.prototype.subscribe=function(t,e){var n=this;if(this.checkName(t),"function"!=typeof e)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(t,(function(t,i,r,o,s){return e(t,i,r,(function(){return n._bridge.unsubscribe(o)}),s)})).then((function(t){return function(){n._bridge.unsubscribe(t)}}))},t.prototype.get=function(t){return this.checkName(t),this._bridge.get(t)},t.prototype.ready=function(){return Promise.resolve(this)},t.prototype.destroy=function(t){return this.checkName(t),this._bridge.destroy(t)},Object.defineProperty(t.prototype,"setPathSupported",{get:function(){return this._bridge.setPathSupported},enumerable:!0,configurable:!0}),t.prototype.checkName=function(t){if("string"!=typeof t||""===t)throw new Error("Please provide the name as a non-empty string!")},t.prototype.checkPath=function(t){if("string"!=typeof t)throw new Error("Please provide the path as a dot delimited string!")},t.prototype.checkData=function(t){if("object"!=typeof t)throw new Error("Please provide the data as an object!")},t}();function ee(t,e,n){return"function"!=typeof e&&"function"!=typeof n?t:("function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n))}function ne(t,e,n){var i;return void 0===t&&(t=0),e.finally((function(){i&&clearTimeout(i)})),new Promise((function(e,r){i=setTimeout((function(){return r(n)}),t)}))}!function(t){t[t.Success=0]="Success",t[t.Error=1]="Error"}(Xt||(Xt={}));var ie=function(){function t(t,e,n,i){this.protocol=t,this.repo=e,this.instance=n,this.configuration=i}return t.prototype.subscribe=function(t,e,n,i,r){var o=this,s=function(t,n,i,s){var a;e.methodResponseTimeout=null!==(a=e.methodResponseTimeout)&&void 0!==a?a:e.waitTimeoutMs,o.protocol.client.subscribe(n,e,t,i,s,r)};return ee(new Promise((function(n,i){var r,a=function(t){n(t)},c=function(t){i(t)};if(t)if((r="string"==typeof t?{name:t}:t).name){void 0===e&&(e={});var u=e.target;if(void 0===u&&(u="best"),"string"!=typeof u||"all"===u||"best"===u){void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=e.method_response_timeout,void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=o.configuration.methodResponseTimeout)),void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=e.wait_for_method_timeout,void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=o.configuration.waitTimeoutMs));var d=0,p=o.getServerMethodsByFilterAndTarget(r,u);if(p.length>0)s(p,p[0].methods[0],a,c);else{var h=function(){if(u&&e.waitTimeoutMs)if(d+=500,(p=o.getServerMethodsByFilterAndTarget(r,u)).length>0){var n=p[0].methods[0];s(p,n,a,c)}else if(d>=e.waitTimeoutMs){s(p,"string"==typeof t?{name:t}:t,a,c)}else setTimeout(h,500)};setTimeout(h,500)}}else i(new Error('"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else i("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");else i("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")})),n,i)},t.prototype.servers=function(t){var e=void 0===t?void 0:S({},t);return this.getServers(e).map((function(t){return t.server.instance}))},t.prototype.methods=function(t){return t="string"==typeof t?{name:t}:S({},t),this.getMethods(t)},t.prototype.methodsForInstance=function(t){return this.getMethodsForInstance(t)},t.prototype.methodAdded=function(t){return this.repo.onMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.repo.onMethodRemoved(t)},t.prototype.serverAdded=function(t){return this.repo.onServerAdded(t)},t.prototype.serverRemoved=function(t){return this.repo.onServerRemoved((function(e,n){t(e,n)}))},t.prototype.serverMethodAdded=function(t){return this.repo.onServerMethodAdded((function(e,n){t({server:e,method:n})}))},t.prototype.serverMethodRemoved=function(t){return this.repo.onServerMethodRemoved((function(e,n){t({server:e,method:n})}))},t.prototype.invoke=function(t,e,n,i,r,o){return x(this,void 0,void 0,(function(){var s=this;return k(this,(function(a){return[2,ee(function(){return x(s,void 0,void 0,(function(){var r,o,s,a,c,u,d,p,h,f,l=this;return k(this,(function(v){switch(v.label){case 0:if(!(r="string"==typeof t?{name:t}:S({},t)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")];if(e||(e={}),n||(n="best"),"string"==typeof n&&"all"!==n&&"best"!==n&&"skipMine"!==n)return[2,Promise.reject(new Error('"'+n+'" is not a valid target. Valid targets are "all" and "best".'))];if(i||(i={}),void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=i.method_response_timeout,void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=i.wait_for_method_timeout,void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==i.waitTimeoutMs&&"number"!=typeof i.waitTimeoutMs)return[2,Promise.reject(new Error('"'+i.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof e)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+r.name))];if(0!==(o=this.getServerMethodsByFilterAndTarget(r,n)).length)return[3,4];v.label=1;case 1:return v.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(r,n,i)];case 2:return o=v.sent(),[3,4];case 3:return v.sent(),s=S(S({},r),{getServers:function(){return[]},supportsStreaming:!1,objectTypes:null!==(f=r.objectTypes)&&void 0!==f?f:[]}),a={method:s,called_with:e,message:"Can not find a method matching "+JSON.stringify(t)+" with server filter "+JSON.stringify(n),executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(a)];case 4:return c=i.methodResponseTimeoutMs,u=i,d=o.map((function(t){var n=St(),i=t.methods[0],r=t.server,o=l.protocol.client.invoke(n,i,e,r,u);return Promise.race([o,ne(c,o,{invocationId:n,message:"Invocation timeout ("+c+" ms) reached for method name: "+(null==i?void 0:i.name)+", target instance: "+JSON.stringify(r.instance)+", options: "+JSON.stringify(u),status:Xt.Error})])})),[4,Promise.all(d)];case 5:return p=v.sent(),h=this.getInvocationResultObj(p,r,e),p.every((function(t){return t.status===Xt.Error}))?[2,Promise.reject(h)]:[2,h]}}))}))}(),r,o)]}))}))},t.prototype.getInvocationResultObj=function(t,e,n){var i=t.filter((function(t){return t.status===Xt.Success})).reduce((function(t,i){return t=C(t,[{executed_by:i.instance,returned:i.result,called_with:n,method:e,message:i.message,status:i.status}])}),[]),r=t.filter((function(t){return t.status===Xt.Error})).reduce((function(t,i){return t=C(t,[{executed_by:i.instance,called_with:n,name:e.name,message:i.message}])}),[]),o=t[0];return{method:e,called_with:n,returned:o.result,executed_by:o.instance,all_return_values:i,all_errors:r,message:o.message,status:o.status}},t.prototype.tryToAwaitForMethods=function(t,e,n){var i=this;return new Promise((function(r,o){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=i.getServerMethodsByFilterAndTarget(t,e);if(c.length>0)clearInterval(a),r(c);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(a),void o()}),500);else o()}))},t.prototype.filterByTarget=function(t,e){var n=this;if("string"!=typeof t){return(Array.isArray(t)?t:[t]).reduce((function(t,i){var r=e.filter((function(t){return n.instanceMatch(i,t.server.instance)}));return t.concat(r)}),[])}if("all"===t)return C(e);if("best"===t){var i=e.find((function(t){return t.server.instance.isLocal}));if(i)return[i];if(void 0!==e[0])return[e[0]]}else if("skipMine"===t)return e.filter((function(t){return t.server.instance.peerId!==n.instance.peerId}));return[]},t.prototype.instanceMatch=function(t,e){return this.containsProps(t,e)},t.prototype.methodMatch=function(t,e){return this.containsProps(t,e)},t.prototype.containsProps=function(t,e){return Object.keys(t).filter((function(e){return void 0!==t[e]&&"function"!=typeof t[e]&&"object_types"!==e&&"display_name"!==e&&"id"!==e&&"gatewayId"!==e&&"identifier"!==e&&"_"!==e[0]})).reduce((function(n,i){var r=t[i],o=e[i];if("objectTypes"===i){(r.length>o.length||!1===function(t,e){var n=t.reduce((function(t,e){return t[e]=!1,t}),{});e.forEach((function(t){void 0!==n[t]&&(n[t]=!0)}));return Object.keys(n).reduce((function(t,e){return n[e]||(t=!1),t}),!0)}(r,o))&&(n=!1)}else String(r).toLowerCase()!==String(o).toLowerCase()&&(n=!1);return n}),!0)},t.prototype.getMethods=function(t){var e=this;return void 0===t?this.repo.getMethods():this.repo.getMethods().filter((function(n){return e.methodMatch(t,n)}))},t.prototype.getMethodsForInstance=function(t){var e=this,n=this.repo.getServers().filter((function(n){return e.instanceMatch(t,n.instance)}));if(0===n.length)return[];var i={};return 1===n.length?i=n[0].methods:n.forEach((function(t){Object.keys(t.methods).forEach((function(e){var n=t.methods[e];i[n.identifier]=n}))})),Object.keys(i).map((function(t){return i[t]}))},t.prototype.getServers=function(t){var e=this,n=this.repo.getServers();return void 0===t?n.map((function(t){return{server:t,methods:[]}})):n.reduce((function(n,i){var r=e.repo.getServerMethodsById(i.id).filter((function(n){return e.methodMatch(t,n)}));return r.length>0&&n.push({server:i,methods:r}),n}),[])},t.prototype.getServerMethodsByFilterAndTarget=function(t,e){var n=this.getServers(t);return this.filterByTarget(e,n)},t}(),re=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.subscription=n}return Object.defineProperty(t.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),t.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},t.prototype.push=function(t){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,t)},t}(),oe=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return t.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},t.prototype.acceptOnBranch=function(t){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,t)},t.prototype.reject=function(t){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,t)},t}(),se=function(){function t(t,e){var n=this;this.protocol=t,this.server=e,t.server.onSubRequest((function(t,e){return n.handleSubRequest(t,e)})),t.server.onSubAdded((function(t,e){return n.handleSubAdded(t,e)})),t.server.onSubRemoved((function(t,e){return n.handleSubRemoved(t,e)}))}return t.prototype.handleSubRequest=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRequestHandler){var n=new oe(this.protocol,e,t);e.streamCallbacks.subscriptionRequestHandler(n)}},t.prototype.handleSubAdded=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionAddedHandler){var n=new re(this.protocol,e,t);e.streamCallbacks.subscriptionAddedHandler(n)}},t.prototype.handleSubRemoved=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRemovedHandler){var n=new re(this.protocol,e,t);e.streamCallbacks.subscriptionRemovedHandler(n)}},t}(),ae=function(){function t(t,e,n){this.key=t,this.protocol=e,this.repoMethod=n}return t.prototype.subscriptions=function(){var t=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(e){return new re(t.protocol,t.repoMethod,e)}))},t.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},t.prototype.push=function(t){this.protocol.server.pushData(this.repoMethod,t,[this.key])},t}(),ce=function(){function t(t,e,n){this._protocol=t,this._repoMethod=e,this._server=n,this.name=this._repoMethod.definition.name}return t.prototype.branches=function(t){var e=this,n=this._protocol.server.getBranchList(this._repoMethod);return t?n.indexOf(t)>-1?new ae(t,this._protocol,this._repoMethod):void 0:n.map((function(t){return new ae(t,e._protocol,e._repoMethod)}))},t.prototype.branch=function(t){return this.branches(t)},t.prototype.subscriptions=function(){var t=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(e){return new re(t._protocol,t._repoMethod,e)}))},Object.defineProperty(t.prototype,"definition",{get:function(){var t=this._repoMethod.definition;return{accepts:t.accepts,description:t.description,displayName:t.displayName,name:t.name,objectTypes:t.objectTypes,returns:t.returns,supportsStreaming:t.supportsStreaming}},enumerable:!0,configurable:!0}),t.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},t.prototype.push=function(t,e){if("string"!=typeof e&&!Array.isArray(e)&&void 0!==e)throw new Error("invalid branches should be string or string array");if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,t,e)},t.prototype.updateRepoMethod=function(t){this._repoMethod=t},t}(),ue=function(){function t(t,e){this.protocol=t,this.serverRepository=e,this.invocations=0,this.currentlyUnregistering={},this.streaming=new se(t,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return t.prototype.createStream=function(t,e,n,i,r){var o=this;return ee(new Promise((function(n,i){if(t){var s;if(!(s="string"==typeof t?{name:""+t}:S({},t)).name)return i("The name property is required for the streamDefinition object and must be unique. Stream definition: "+JSON.stringify(s));if(o.serverRepository.getList().some((function(t){return t.definition.name===s.name})))return i('A stream with the name "'+s.name+'" already exists! Please, provide a unique name for the stream.');s.supportsStreaming=!0,e||(e={}),"function"!=typeof e.subscriptionRequestHandler&&(e.subscriptionRequestHandler=function(t){t.accept()});var a=o.serverRepository.add({definition:s,streamCallbacks:e,protocolState:{}});o.protocol.server.createStream(a).then((function(){var t;r?(t=r,r.updateRepoMethod(a)):t=new ce(o.protocol,a,o),a.stream=t,n(t)})).catch((function(t){a.repoId&&o.serverRepository.remove(a.repoId),i(t)}))}else i("The stream name must be unique! Please, provide either a unique string for a stream name to glue.interop.createStream() or a methodDefinition object with a unique name property for the stream.")})),n,i)},t.prototype.register=function(t,e){var n=this;if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var i=function(t,i){return x(n,void 0,void 0,(function(){var n,r,o;return k(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),(n=e(t.args,t.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return r=s.sent(),i(void 0,r),[3,3];case 2:i(void 0,n),s.label=3;case 3:return[3,5];case 4:return(o=s.sent())||(o=""),i(o,o),[3,5];case 5:return[2]}}))}))};return i.userCallback=e,this.registerCore(t,i)},t.prototype.registerAsync=function(t,e){if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var n=function(t,n){try{var i=!1,r=function(t){i||n(void 0,t),i=!0},o=function(t){i||(t||(t=""),n(t,t)),i=!0},s=e(t.args,t.instance,r,o);s&&"function"==typeof s.then&&s.then(r).catch(o)}catch(t){n(t,void 0)}};return n.userCallbackAsync=e,this.registerCore(t,n)},t.prototype.unregister=function(t,e){return void 0===e&&(e=!1),x(this,void 0,void 0,(function(){var n,i;return k(this,(function(r){switch(r.label){case 0:return void 0===t?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a name property.")]:"function"!=typeof t?[3,2]:[4,this.unregisterWithPredicate(t,e)];case 1:return r.sent(),[2];case 2:return void 0===(n="string"==typeof t?{name:t}:t).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(i=this.serverRepository.getList().find((function(t){return t.definition.name===n.name&&(t.definition.supportsStreaming||!1)===e})))?[4,this.removeMethodsOrStreams([i])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return r.sent(),[2]}}))}))},t.prototype.unregisterWithPredicate=function(t,e){return x(this,void 0,void 0,(function(){var n;return k(this,(function(i){switch(i.label){case 0:return(n=this.serverRepository.getList().filter((function(e){return t(e.definition)})).filter((function(t){return(t.definition.supportsStreaming||!1)===e})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(e?"stream":"method")+" matching the specified condition!")];case 1:return i.sent(),[2]}}))}))},t.prototype.removeMethodsOrStreams=function(t){var e=this,n=[];return t.forEach((function(t){var i=e.protocol.server.unregister(t).then((function(){t.repoId&&e.serverRepository.remove(t.repoId)}));n.push(i),e.addAsCurrentlyUnregistering(t.definition.name,i)})),Promise.all(n)},t.prototype.addAsCurrentlyUnregistering=function(t,e){return x(this,void 0,void 0,(function(){var n,i=this;return k(this,(function(r){return n=new Promise((function(t){return setTimeout(t,5e3)})),this.currentlyUnregistering[t]=Promise.race([e,n]).then((function(){delete i.currentlyUnregistering[t]})),[2]}))}))},t.prototype.registerCore=function(t,e){return x(this,void 0,void 0,(function(){var n,i,r,o=this;return k(this,(function(s){switch(s.label){case 0:return(n="string"==typeof t?{name:""+t}:S({},t)).name?(i=this.currentlyUnregistering[n.name])?[4,i]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the name property in the methodDefinition object: "+JSON.stringify(t))];case 1:s.sent(),s.label=2;case 2:return this.serverRepository.getList().some((function(t){return t.definition.name===n.name}))?[2,Promise.reject('A method with the name "'+n.name+'" already exists! Please, provide a unique name for the method.')]:n.supportsStreaming?[2,Promise.reject("When you create methods with glue.interop.register() or glue.interop.registerAsync() the property supportsStreaming cannot be true. If you want "+n.name+" to be a stream, please use the glue.interop.createStream() method.")]:(r=this.serverRepository.add({definition:n,theFunction:e,protocolState:{}}),[2,this.protocol.server.register(r).catch((function(t){throw(null==r?void 0:r.repoId)&&o.serverRepository.remove(r.repoId),t}))])}}))}))},t.prototype.onMethodInvoked=function(t,e,n){var i=this;t&&t.theFunction&&t.theFunction(n,(function(n,r){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(t){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}r?("object"!=typeof r||Array.isArray(r))&&(r={_value:r}):r={},i.protocol.server.methodInvocationResult(t,e,n,r)}))},t}(),de=function(){function t(t,e){var n=this;this.wrapped={getMethods:pe,getStreams:he},t&&this.refreshWrappedObject(t),e&&(e.loggedIn((function(){n.refresh(e)})),this.refresh(e))}return t.prototype.unwrap=function(){return this.wrapped},t.prototype.refresh=function(t){if(t){var e=null==t?void 0:t.resolvedIdentity,n=Object.assign({},null!=e?e:{},{peerId:null==t?void 0:t.peerId});this.refreshWrappedObject(n)}},t.prototype.refreshWrappedObject=function(t){var e,n,i;this.wrapped.user=t.user,this.wrapped.instance=t.instance,this.wrapped.application=null!==(e=t.application)&&void 0!==e?e:St(),this.wrapped.applicationName=t.applicationName,this.wrapped.pid=null!==(i=null!==(n=t.pid)&&void 0!==n?n:t.process)&&void 0!==i?i:Math.floor(1e10*Math.random()),this.wrapped.machine=t.machine,this.wrapped.environment=t.environment,this.wrapped.region=t.region,this.wrapped.windowId=t.windowId,this.wrapped.isLocal=!0,this.wrapped.api=t.api,this.wrapped.service=t.service,this.wrapped.peerId=t.peerId},t}();function pe(){var t;return null===(t=de.API)||void 0===t?void 0:t.methodsForInstance(this)}function he(){var t;return null===(t=de.API)||void 0===t?void 0:t.methodsForInstance(this).filter((function(t){return t.supportsStreaming}))}var fe=function(){function t(t){this.logger=t,this.servers={},this.methodsCount={},this.callbacks=X()}return t.prototype.addServer=function(t,e){this.logger.debug("adding server "+e);var n=this.servers[e];if(n)return n.id;var i=new de(t),r={id:e,methods:{},instance:i.unwrap(),wrapper:i};return this.servers[e]=r,this.callbacks.execute("onServerAdded",r.instance),e},t.prototype.removeServerById=function(t,e){var n=this,i=this.servers[t];i?(this.logger.debug("removing server "+t),Object.keys(i.methods).forEach((function(e){n.removeServerMethod(t,e)})),delete this.servers[t],this.callbacks.execute("onServerRemoved",i.instance,e)):this.logger.warn("not aware of server "+t+", my state "+JSON.stringify(Object.keys(this.servers)))},t.prototype.addServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");if(!n.methods[e.id]){var i=this.createMethodIdentifier(e),r=this,o={identifier:i,gatewayId:e.id,name:e.name,displayName:e.display_name,description:e.description,version:e.version,objectTypes:e.object_types||[],accepts:e.input_signature,returns:e.result_signature,supportsStreaming:void 0!==e.flags&&e.flags.streaming,getServers:function(){return r.getServersByMethod(i)}};return o.object_types=o.objectTypes,o.display_name=o.displayName,o.version=o.version,n.methods[e.id]=o,this.methodsCount[i]||(this.methodsCount[i]=0,this.callbacks.execute("onMethodAdded",o)),this.methodsCount[i]=this.methodsCount[i]+1,this.callbacks.execute("onServerMethodAdded",n.instance,o),o}},t.prototype.removeServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");var i=n.methods[e];delete n.methods[e],this.methodsCount[i.identifier]=this.methodsCount[i.identifier]-1,0===this.methodsCount[i.identifier]&&this.callbacks.execute("onMethodRemoved",i),this.callbacks.execute("onServerMethodRemoved",n.instance,i)},t.prototype.getMethods=function(){var t=this,e={};return Object.keys(this.servers).forEach((function(n){var i=t.servers[n];Object.keys(i.methods).forEach((function(t){var n=i.methods[t];e[n.identifier]=n}))})),Object.keys(e).map((function(t){return e[t]}))},t.prototype.getServers=function(){var t=this,e=[];return Object.keys(this.servers).forEach((function(n){var i=t.servers[n];e.push(i)})),e},t.prototype.getServerMethodsById=function(t){var e=this.servers[t];return Object.keys(e.methods).map((function(t){return e.methods[t]}))},t.prototype.onServerAdded=function(t){var e=this.callbacks.add("onServerAdded",t),n=this.getServers().map((function(t){return t.instance}));return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onMethodAdded=function(t){var e=this.callbacks.add("onMethodAdded",t),n=this.getMethods();return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onServerMethodAdded=function(t){var e=this.callbacks.add("onServerMethodAdded",t),n=!1,i=this.getServers();return setTimeout((function(){i.forEach((function(e){var i=e.methods;Object.keys(i).forEach((function(r){n||t(e.instance,i[r])}))}))}),0),function(){n=!0,e()}},t.prototype.onMethodRemoved=function(t){return this.callbacks.add("onMethodRemoved",t)},t.prototype.onServerRemoved=function(t){return this.callbacks.add("onServerRemoved",t)},t.prototype.onServerMethodRemoved=function(t){return this.callbacks.add("onServerMethodRemoved",t)},t.prototype.getServerById=function(t){return this.servers[t]},t.prototype.reset=function(){var t=this;Object.keys(this.servers).forEach((function(e){t.removeServerById(e,"reset")})),this.servers={},this.methodsCount={}},t.prototype.createMethodIdentifier=function(t){var e=void 0!==t.input_signature?t.input_signature:"",n=void 0!==t.result_signature?t.result_signature:"";return(t.name+e+n).toLowerCase()},t.prototype.getServersByMethod=function(t){var e=this,n=[];return Object.keys(this.servers).forEach((function(i){var r=e.servers[i];Object.keys(r.methods).forEach((function(e){r.methods[e].identifier===t&&n.push(r.instance)}))})),n},t.prototype.returnUnsubWithDelayedReplay=function(t,e,n){var i=!1;return setTimeout((function(){e.forEach((function(t){i||n(t)}))}),0),function(){i=!0,t()}},t}(),le=function(){function t(){this.nextId=0,this.methods=[]}return t.prototype.add=function(t){return t.repoId=String(this.nextId),this.nextId+=1,this.methods.push(t),t},t.prototype.remove=function(t){if("string"!=typeof t)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(e){return e.repoId!==t}))},t.prototype.getById=function(t){if("string"==typeof t)return this.methods.find((function(e){return e.repoId===t}))},t.prototype.getList=function(){return this.methods.map((function(t){return t}))},t.prototype.length=function(){return this.methods.length},t.prototype.reset=function(){this.methods=[]},t}(),ve="onSubscriptionRequest",ye="onSubscriptionAdded",ge="onSubscriptionRemoved",me=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.serverRepository=n,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=X(),this.nextStreamId=0,t.on("add-interest",(function(t){i.handleAddInterest(t)})),t.on("remove-interest",(function(t){i.handleRemoveInterest(t)}))}return t.prototype.acceptRequestOnBranch=function(t,e,n){if("string"!=typeof n&&(n=""),"object"!=typeof e.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(e.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var i=this.getStreamId(e,n),r=t.msg.subscription_id,o={id:r,arguments:t.arguments,instance:t.instance,branchKey:n,streamId:i,subscribeMsg:t.msg};e.protocolState.subscriptionsMap[r]=o,this.session.sendFireAndForget({type:"accepted",subscription_id:r,stream_id:i}),this.callbacks.execute(ye,o,e)},t.prototype.rejectRequest=function(t,e,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,t.msg.subscription_id)},t.prototype.pushData=function(t,e,n){var i=this;if("object"==typeof t&&Array.isArray(t.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]),t.protocolState.branchKeyToStreamIdMap.filter((function(t){return!n||0===n.length||n.indexOf(t.key)>=0})).map((function(t){return t.streamId})).forEach((function(t){var n={type:"publish",stream_id:t,data:e};i.session.sendFireAndForget(n)}))}},t.prototype.pushDataToSingle=function(t,e,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var i={type:"post",subscription_id:e.id,data:n};this.session.sendFireAndForget(i)},t.prototype.closeSingleSubscription=function(t,e){t.protocolState.subscriptionsMap&&delete t.protocolState.subscriptionsMap[e.id];var n={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);e.instance;this.callbacks.execute(ge,e,t)},t.prototype.closeMultipleSubscriptions=function(t,e){var n=this;if("object"==typeof t&&"object"==typeof t.protocolState.subscriptionsMap&&t.protocolState.subscriptionsMap){var i=t.protocolState.subscriptionsMap,r=Object.keys(i).map((function(t){return i[t]}));"string"==typeof e&&(r=r.filter((function(t){return t.branchKey===e}))),r.forEach((function(t){delete i[t.id];var e={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping all subscriptions on stream_id: "+t.streamId};n.session.sendFireAndForget(e)}))}},t.prototype.getSubscriptionList=function(t,e){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var n=t.protocolState.subscriptionsMap,i=Object.keys(n).map((function(t){return n[t]}));return"string"!=typeof e?i:i.filter((function(t){return t.branchKey===e}))},t.prototype.getBranchList=function(t){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var e=t.protocolState.subscriptionsMap,n=Object.keys(e).map((function(t){return e[t]})),i=[];return n.forEach((function(t){var e="";"object"==typeof t&&"string"==typeof t.branchKey&&(e=t.branchKey),-1===i.indexOf(e)&&i.push(e)})),i},t.prototype.onSubAdded=function(t){this.onSubscriptionLifetimeEvent(ye,t)},t.prototype.onSubRequest=function(t){this.onSubscriptionLifetimeEvent(ve,t)},t.prototype.onSubRemoved=function(t){this.onSubscriptionLifetimeEvent(ge,t)},t.prototype.handleRemoveInterest=function(t){var e=this.serverRepository.getById(t.method_id);if("string"==typeof t.subscription_id&&"object"==typeof e&&e.protocolState.subscriptionsMap&&"object"==typeof e.protocolState.subscriptionsMap[t.subscription_id]){var n=e.protocolState.subscriptionsMap[t.subscription_id];delete e.protocolState.subscriptionsMap[t.subscription_id],this.callbacks.execute(ge,n,e)}},t.prototype.onSubscriptionLifetimeEvent=function(t,e){this.callbacks.add(t,e)},t.prototype.getNextStreamId=function(){return this.nextStreamId+++""},t.prototype.handleAddInterest=function(t){var e=this.repository.getServerById(t.caller_id).instance,n={msg:t,arguments:t.arguments_kv||{},instance:e},i=this.serverRepository.getById(t.method_id);if(void 0!==i)i.protocolState.subscriptionsMap&&i.protocolState.subscriptionsMap[t.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+t.subscription_id+" already exists.",t.subscription_id):this.callbacks.execute(ve,n,i);else{var r="No method with id "+t.method_id+" on this server.";this.sendSubscriptionFailed(r,t.subscription_id)}},t.prototype.sendSubscriptionFailed=function(t,e){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:t,request_id:e};this.session.sendFireAndForget(n)},t.prototype.getStreamId=function(t,e){if("string"!=typeof e&&(e=""),!t.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+t.definition.name+" method without protocol state");var n=t.protocolState.branchKeyToStreamIdMap.filter((function(t){return t.key===e}))[0],i=n?n.streamId:void 0;return"string"==typeof i&&""!==i||(i=this.getNextStreamId(),t.protocolState.branchKeyToStreamIdMap.push({key:e,streamId:i})),i},t}(),we=function(){function t(t,e,n,i){var r=this;this.session=t,this.clientRepository=e,this.serverRepository=n,this.logger=i,this.callbacks=X(),this.streaming=new me(t,e,n),this.session.on("invoke",(function(t){return r.handleInvokeMessage(t)}))}return t.prototype.createStream=function(t){return t.protocolState.subscriptionsMap={},t.protocolState.branchKeyToStreamIdMap=[],this.register(t,!0)},t.prototype.register=function(t,e){var n=this,i=t.definition,r={streaming:e||!1},o={type:"register",methods:[{id:t.repoId,name:i.name,display_name:i.displayName,description:i.description,version:i.version,flags:r,object_types:i.objectTypes||i.object_types,input_signature:i.accepts,result_signature:i.returns,restrictions:void 0}]};return this.session.send(o,{methodId:t.repoId}).then((function(){n.logger.debug("registered method "+t.definition.name+" with id "+t.repoId)})).catch((function(e){throw n.logger.warn("failed to register method "+t.definition.name+" with id "+t.repoId+" - "+JSON.stringify(e)),e}))},t.prototype.onInvoked=function(t){this.callbacks.add("onInvoked",t)},t.prototype.methodInvocationResult=function(t,e,n,i){var r;r=n||""===n?{type:"error",request_id:e,reason_uri:"agm.errors.client_error",reason:n,context:i,peer_id:void 0}:{type:"yield",invocation_id:e,peer_id:this.session.peerId,result:i,request_id:void 0},this.session.sendFireAndForget(r)},t.prototype.unregister=function(t){return x(this,void 0,void 0,(function(){var e;return k(this,(function(n){switch(n.label){case 0:return e={type:"unregister",methods:[t.repoId]},[4,this.session.send(e)];case 1:return n.sent(),[2]}}))}))},t.prototype.getBranchList=function(t){return this.streaming.getBranchList(t)},t.prototype.getSubscriptionList=function(t,e){return this.streaming.getSubscriptionList(t,e)},t.prototype.closeAllSubscriptions=function(t,e){this.streaming.closeMultipleSubscriptions(t,e)},t.prototype.pushData=function(t,e,n){this.streaming.pushData(t,e,n)},t.prototype.pushDataToSingle=function(t,e,n){this.streaming.pushDataToSingle(t,e,n)},t.prototype.closeSingleSubscription=function(t,e){this.streaming.closeSingleSubscription(t,e)},t.prototype.acceptRequestOnBranch=function(t,e,n){this.streaming.acceptRequestOnBranch(t,e,n)},t.prototype.rejectRequest=function(t,e,n){this.streaming.rejectRequest(t,e,n)},t.prototype.onSubRequest=function(t){this.streaming.onSubRequest(t)},t.prototype.onSubAdded=function(t){this.streaming.onSubAdded(t)},t.prototype.onSubRemoved=function(t){this.streaming.onSubRemoved(t)},t.prototype.handleInvokeMessage=function(t){var e=t.invocation_id,n=t.caller_id,i=t.method_id,r=t.arguments_kv,o=this.serverRepository.getList().filter((function(t){return t.repoId===i}))[0];if(void 0!==o){var s={args:r,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",o,e,s)}},t}(),be=function(){function t(t,e){this.repository=t,this.subscriptionData=e}return Object.defineProperty(t.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"servers",{get:function(){var t=this;return this.subscriptionData.trackedServers.filter((function(t){return t.subscriptionId})).map((function(e){return t.repository.getServerById(e.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),t.prototype.onData=function(t){if("function"!=typeof t)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(t),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(e){t(e)}))},t.prototype.onClosed=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(t)},t.prototype.onFailed=function(t){},t.prototype.onConnected=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(t)},t.prototype.close=function(){this.subscriptionData.close()},t.prototype.setNewSubscription=function(t){this.subscriptionData=t},t}(),_e="awaitingAccept",Ie="subscribed",Se="Subscription failed.",xe="ClientInitiated",ke=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.logger=n,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(t){var e=t._tag,n=e.subLocalKey,r=i.subscriptionsList[n];if("object"==typeof r&&(r.trackedServers=r.trackedServers.filter((function(t){return t.serverId!==e.serverId})),r.trackedServers.length<=0)){if(clearTimeout(r.timeoutId),r.status===_e){var o="string"==typeof t.reason&&""!==t.reason?' Publisher said "'+t.reason+'".':" No reason given.",s="object"==typeof r.params.arguments?JSON.stringify(r.params.arguments):"{}";r.error({message:"Subscription rejected."+o+" Called with:"+s,called_with:r.params.arguments,method:r.method})}else r.status===Ie&&i.callOnClosedHandlers(r);delete i.subscriptionsList[n]}},this.handleSubscribed=function(t){var e=t._tag.subLocalKey,n=i.subscriptionsList[e];if("object"==typeof n){var r=t._tag.serverId,o=n.trackedServers.filter((function(t){return t.serverId===r}))[0];if("object"==typeof o){o.subscriptionId=t.subscription_id,i.subscriptionIdToLocalKeyMap[t.subscription_id]=e;var s=n.status===_e;if(n.status=Ie,s){var a=!1,c=n.subscription;c?(c.setNewSubscription(n),n.success(c),a=!0):(c=new be(i.repository,n),n.subscription=c,n.success(c));for(var u=0,d=n.handlers.onConnected;u<d.length;u++){var p=d[u];try{p(c.serverInstance,a)}catch(t){}}}}}},this.handleEventData=function(t){var e=i.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=i.subscriptionsList[e];if("object"==typeof n){var r=n.trackedServers.filter((function(e){return e.subscriptionId===t.subscription_id}));if(1===r.length){var o=t.oob,s=r[0].serverId,a=function(){return{data:t.data,server:i.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:o}},c=n.handlers.onData,u=n.queued.data;c.length>0?c.forEach((function(t){"function"==typeof t&&t(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(t){var e=i.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=i.subscriptionsList[e];if("object"==typeof n){var r=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(e){return e.subscriptionId!==t.subscription_id||(n.queued.closers.push(e.serverId),!1)})),n.trackedServers.length===r&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),i.callOnClosedHandlers(n),delete i.subscriptionsList[e]),delete i.subscriptionIdToLocalKeyMap[t.subscription_id])}}},t.on("subscribed",this.handleSubscribed),t.on("event",this.handleEventData),t.on("subscription-cancelled",this.handleSubscriptionCancelled)}return t.prototype.subscribe=function(t,e,n,i,r,o){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,t,e,i,r,e.methodResponseTimeout||1e4,o);"object"==typeof c?n.forEach((function(n){var i=n.server.id,r=n.methods.find((function(e){return e.name===t.name}));if(r){c.trackedServers.push({serverId:i,subscriptionId:void 0});var o={type:"subscribe",server_id:i,method_id:r.gatewayId,arguments_kv:e.arguments};s.session.send(o,{serverId:i,subLocalKey:a}).then((function(t){return s.handleSubscribed(t)})).catch((function(t){return s.handleErrorSubscribing(t)}))}else s.logger.error("can not find method "+t.name+" for target "+n.server.id)})):r({method:t,called_with:e.arguments,message:Se+" Unable to register the user callbacks."})}else r({method:t,called_with:e.arguments,message:Se+" No available servers matched the target params."})},t.prototype.drainSubscriptions=function(){var t=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},t},t.prototype.getNextSubscriptionLocalKey=function(){var t=this.nextSubLocalKey;return this.nextSubLocalKey+=1,t},t.prototype.registerSubscription=function(t,e,n,i,r,o,s){var a=this,c={localKey:t,status:_e,method:e,params:n,success:i,error:r,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(t)},subscription:null==s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[t]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[t]){var i=a.subscriptionsList[t];i.status===_e?(r({method:e,called_with:n.arguments,message:Se+" Subscription attempt timed out after "+o+" ms."}),delete a.subscriptionsList[t]):i.status===Ie&&i.trackedServers.length>0&&(i.trackedServers=i.trackedServers.filter((function(t){return void 0!==t.subscriptionId})),delete i.timeoutId,i.trackedServers.length<=0&&(a.callOnClosedHandlers(i),delete a.subscriptionsList[t]))}}),o),c},t.prototype.callOnClosedHandlers=function(t,e){var n,i=t.queued.closers.length,r=i>0?t.queued.closers[i-1]:null;void 0!==r&&"string"==typeof r&&(n=this.repository.getServerById(r).instance),t.handlers.onClosed.forEach((function(i){"function"==typeof i&&i({message:e||"ServerInitiated",requestArguments:t.params.arguments||{},server:n,stream:t.method})}))},t.prototype.closeSubscription=function(t){var e=this,n=this.subscriptionsList[t];"object"==typeof n&&(n.trackedServers.forEach((function(t){void 0!==t.subscriptionId&&(n.queued.closers.push(t.serverId),e.session.sendFireAndForget({type:"unsubscribe",subscription_id:t.subscriptionId,reason_uri:"",reason:xe}),delete e.subscriptionIdToLocalKeyMap[t.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,xe),delete this.subscriptionsList[t])},t}(),Ce=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.logger=n,t.on("peer-added",(function(t){return i.handlePeerAdded(t)})),t.on("peer-removed",(function(t){return i.handlePeerRemoved(t)})),t.on("methods-added",(function(t){return i.handleMethodsAddedMessage(t)})),t.on("methods-removed",(function(t){return i.handleMethodsRemovedMessage(t)})),this.streaming=new ke(t,e,n)}return t.prototype.subscribe=function(t,e,n,i,r,o){this.streaming.subscribe(t,e,n,i,r,o)},t.prototype.invoke=function(t,e,n,i){var r=this,o=i.id,s={type:"call",server_id:o,method_id:e.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:t,serverId:o}).then((function(t){return r.handleResultMessage(t)})).catch((function(t){return r.handleInvocationError(t)}))},t.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},t.prototype.handlePeerAdded=function(t){var e=t.new_peer_id,n=t.identity,i=!t.meta||t.meta.local,r=Number(n.process),o={machine:n.machine,pid:isNaN(r)?n.process:r,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:e,api:n.api,isLocal:i};this.repository.addServer(o,e)},t.prototype.handlePeerRemoved=function(t){var e=t.removed_id,n=t.reason;this.repository.removeServerById(e,n)},t.prototype.handleMethodsAddedMessage=function(t){var e=this,n=t.server_id;t.methods.forEach((function(t){e.repository.addServerMethod(n,t)}))},t.prototype.handleMethodsRemovedMessage=function(t){var e=this,n=t.server_id,i=t.methods,r=this.repository.getServerById(n);Object.keys(r.methods).forEach((function(t){var o=r.methods[t];i.indexOf(o.gatewayId)>-1&&e.repository.removeServerMethod(n,t)}))},t.prototype.handleResultMessage=function(t){var e=t._tag.invocationId,n=t.result,i=t._tag.serverId;return{invocationId:e,result:n,instance:this.repository.getServerById(i).instance,status:Xt.Success,message:""}},t.prototype.handleInvocationError=function(t){if(this.logger.debug("handle invocation error "+JSON.stringify(t)),"_tag"in t){var e=t._tag.invocationId,n=t._tag.serverId,i=this.repository.getServerById(n),r=t.reason;return{invocationId:e,result:t.context,instance:i.instance,status:Xt.Error,message:r}}return{invocationId:"",message:t.message,status:Xt.Error,error:t}},t}();function Ae(t,e,n,i,r,o){var s,a=r.logger.subLogger("gw3-protocol"),c=new Promise((function(t){s=t})),u=e.domain("agm",["subscribed"]),d=new we(u,n,i,a.subLogger("server")),p=new Ce(u,n,a.subLogger("client"));return u.onJoined((function(r){n.addServer(t,e.peerId),r?function(){a.info("reconnected - will replay registered methods and subscriptions");for(var t=0,e=p.drainSubscriptions();t<e.length;t++){var n=e[t],r=n.method,s=Object.assign({},n.params);a.info("trying to re-subscribe to method "+r.name),o.client.subscribe(r,s,void 0,void 0,n)}var c=i.getList();i.reset();for(var u=0,d=c;u<d.length;u++){var h=d[u],f=h.definition;a.info("re-publishing method "+f.name),h.stream?o.server.createStream(f,h.streamCallbacks,void 0,void 0,h.stream):h.theFunction&&h.theFunction.userCallback?o.register(f,h.theFunction.userCallback):h.theFunction&&h.theFunction.userCallbackAsync&&o.registerAsync(f,h.theFunction.userCallbackAsync)}}():s&&(s({client:p,server:d}),s=void 0)})),u.onLeft((function(){n.reset()})),u.join(),c}var Te=function(){function t(t){var e=this;if(void 0===t)throw new Error("configuration is required");if(void 0===t.connection)throw new Error("configuration.connections is required");var n,i=t.connection;if("number"!=typeof t.methodResponseTimeout&&(t.methodResponseTimeout=3e4),"number"!=typeof t.waitTimeoutMs&&(t.waitTimeoutMs=3e4),de.API=this,this.instance=new de(void 0,i).unwrap(),this.clientRepository=new fe(t.logger.subLogger("cRep")),this.serverRepository=new le,3!==i.protocolVersion)throw new Error("protocol "+i.protocolVersion+" not supported");n=Ae(this.instance,i,this.clientRepository,this.serverRepository,t,this),this.readyPromise=n.then((function(n){return e.protocol=n,e.client=new ie(e.protocol,e.clientRepository,e.instance,t),e.server=new ue(e.protocol,e.serverRepository),e}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.serverRemoved=function(t){return this.client.serverRemoved(t)},t.prototype.serverAdded=function(t){return this.client.serverAdded(t)},t.prototype.serverMethodRemoved=function(t){return this.client.serverMethodRemoved(t)},t.prototype.serverMethodAdded=function(t){return this.client.serverMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.client.methodRemoved(t)},t.prototype.methodAdded=function(t){return this.client.methodAdded(t)},t.prototype.methodsForInstance=function(t){return this.client.methodsForInstance(t)},t.prototype.methods=function(t){return this.client.methods(t)},t.prototype.servers=function(t){return this.client.servers(t)},t.prototype.subscribe=function(t,e,n,i){return this.client.subscribe(t,e,n,i)},t.prototype.createStream=function(t,e,n,i){return this.server.createStream(t,e,n,i)},t.prototype.unregister=function(t){return this.server.unregister(t)},t.prototype.registerAsync=function(t,e){return this.server.registerAsync(t,e)},t.prototype.register=function(t,e){return this.server.register(t,e)},t.prototype.invoke=function(t,e,n,i,r,o){return this.client.invoke(t,e,n,i,r,o)},t}(),Pe=["subscribed","success"],Me=function(){function t(t,e){var n=this;this.publish=function(t,e,i){var r=i||{},o=r.routingKey,s=r.target,a=n.removeEmptyValues({type:"publish",topic:t,data:e,peer_id:n.peerId,routing_key:o,target_identity:s});n.session.send(a)},this.subscribe=function(t,e,i){return new Promise((function(r,o){var s=i||{},a=s.routingKey,c=s.target,u=n.removeEmptyValues({type:"subscribe",topic:t,peer_id:n.peerId,routing_key:a,source:c});n.session.send(u).then((function(i){var o=i.subscription_id;n.subscriptions.push({subscription_id:o,topic:t,callback:e,source:c}),r({unsubscribe:function(){return n.session.send({type:"unsubscribe",subscription_id:o,peer_id:n.peerId}),n.subscriptions=n.subscriptions.filter((function(t){return t.subscription_id!==o})),Promise.resolve()}})})).catch((function(t){return o(t)}))}))},this.watchOnEvent=function(){n.session.on("event",(function(t){var e=t.data,i=t.subscription_id,r=t["publisher-identity"],o=n.subscriptions.find((function(t){return t.subscription_id===i}));o&&(o.source?n.keysMatch(o.source,r)&&o.callback(e,o.topic,r):o.callback(e,o.topic,r))}))},this.connection=t,this.logger=e,this.peerId=t.peerId,this.subscriptions=[],this.session=t.domain("bus",Pe),this.readyPromise=this.session.join(),this.readyPromise.then((function(){n.watchOnEvent()}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.removeEmptyValues=function(t){var e={};return Object.keys(t).forEach((function(n){void 0!==t[n]&&null!==t[n]&&(e[n]=t[n])})),e},t.prototype.keysMatch=function(t,e){var n=Object.keys(t),i=!0;return n.forEach((function(n){t[n]!==e[n]&&(i=!1)})),i},t}(),je=function(t,e){var n,i=et.getGDMajorVersion(),r=Promise.resolve();if(i){if(i<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");i>=3&&(n=window.glue42gd,r=window.gdPreloadPromise||r)}var o,s,a,c,u,d,p,h=rt("glue"),f=function(t,e,n){var i,r,o,s,a,c;if(et.isNode()){var u=process.env._GD_STARTING_CONTEXT_;if(u)try{c=JSON.parse(u)}catch(t){}}function d(){if(t.application)return t.application;if(n)return n.applicationName;var e=St();return et.isNode()?c?c.applicationConfig.name:"NodeJS"+e:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+" ("+e+")":e}var p=function(){var i,r,o,s,a,u,p,h,f,l=t.gateway,v=null!==(i=null==l?void 0:l.protocolVersion)&&void 0!==i?i:3,y=null==l?void 0:l.reconnectInterval,g=null==l?void 0:l.reconnectAttempts,m=null==l?void 0:l.ws,w=null==l?void 0:l.sharedWorker,b=null==l?void 0:l.inproc;n&&(m=n.gwURL),et.isNode()&&c&&c.gwURL&&(m=c.gwURL),m||w||b||(m="ws://localhost:8385");var _=d(),I=_;void 0!==n?(u=n.windowId,p=n.pid,n.env&&(h=n.env.env,f=n.env.region),I=null!==(r=n.application)&&void 0!==r?r:"glue-app",a=n.appInstanceId):et.isNode()?(p=process.pid,c&&(h=c.env,f=c.region,a=c.instanceId)):u=window.name||St();var S=null!==(s=null===(o=t.gateway)||void 0===o?void 0:o.replaySpecs)&&void 0!==s?s:[];return S.push(Ht),{identity:{application:I,applicationName:_,windowId:u,instance:a,process:p,region:f,environment:h,api:e.version||Ut},reconnectInterval:y,ws:m,sharedWorker:w,inproc:b,protocolVersion:v,reconnectAttempts:g,replaySpecs:S}}(),h=d();if("undefined"!=typeof window){var f=window,l=f.htmlContainer?f.htmlContainer.containerName+"."+f.htmlContainer.application:null===(i=null==f?void 0:f.glue42gd)||void 0===i?void 0:i.application;l&&(h=l)}return{bus:null!==(r=t.bus)&&void 0!==r&&r,application:h,auth:function(){var e,n;return"string"==typeof t.auth?{token:t.auth}:t.auth?t.auth:et.isNode()&&c&&c.gwToken?{gatewayToken:c.gwToken}:(null===(e=t.gateway)||void 0===e?void 0:e.inproc)||(null===(n=t.gateway)||void 0===n?void 0:n.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var e,i,r,o=t.logger,s="warn";return o||(o=s),n&&(r=n.consoleLogLevel),"string"==typeof o?{console:null!=r?r:o,publish:s}:{console:null!==(e=null!=r?r:o.console)&&void 0!==e?e:s,publish:null!==(i=o.publish)&&void 0!==i?i:s}}(),connection:p,metrics:null===(o=t.metrics)||void 0===o||o,contexts:null===(s=t.contexts)||void 0===s||s,version:e.version||Ut,libs:null!==(a=e.libs)&&void 0!==a?a:[],customLogger:t.customLogger}}(t=t||{},e=e||{},n),l={};function v(t,e,n){(p=a.canPublish("trace"))&&a.trace("registering "+t+" module");var i=function(){e.initTime=n.stop(),e.initEndTime=n.endTime,e.marks=n.marks,p&&a.trace(t+" is ready - "+(n.endTime-n.startTime))};e.initStartTime=n.startTime,e.ready?e.ready().then((function(){i()})):i(),Array.isArray(t)||(t=[t]),t.forEach((function(t){l[t]=e,je[t]=e}))}function y(){var t=rt("interop"),e={connection:o,logger:a.subLogger("interop")};return s=new Te(e),Pt.Interop=s,v(["interop","agm"],s,t),Promise.resolve()}function g(){var t=f.activities&&3===o.protocolVersion;if(f.contexts||t){var e=rt("contexts");return v("contexts",u=new te({connection:o,logger:a.subLogger("contexts")}),e),u}var n=o.replayer;n&&n.drain(Ht.name)}function m(){return x(this,void 0,void 0,(function(){var t;return k(this,(function(e){return f.bus?(t=rt("bus"),v("bus",d=new Me(o,a.subLogger("bus")),t),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function w(t){try{return t.forEach((function(t){!function(t,e){var n=rt(t),i=e(l);i&&v(t,i,n)}(t.name,t.create)})),Promise.resolve()}catch(t){return Promise.reject(t)}}return r.then((function(){var t,e=rt("logger");return(a=new Pt(""+(null===(t=f.connection.identity)||void 0===t?void 0:t.application),void 0,f.customLogger)).consoleLevel(f.logger.console),a.publishLevel(f.logger.publish),a.canPublish("debug")&&a.debug("initializing glue..."),v("logger",a,e),Promise.resolve(void 0)})).then((function(){var t=rt("connection");o=new At(f.connection,a.subLogger("connection"));var e=Promise.resolve(f.auth);return f.connection&&!f.auth&&(e=n?n.getGWToken().then((function(t){return{gatewayToken:t}})):Promise.reject("You need to provide auth information")),e.then((function(e){var n;if(t.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(e))throw new Error("Invalid auth object - "+JSON.stringify(e));return n=e,o.login(n)})).then((function(){return v("connection",o,t),f})).catch((function(t){throw o&&o.logout(),t}))})).then((function(){return Promise.all([(s=rt("metrics"),u=f.metrics,d=null==n?void 0:n.getMetricsPublishingEnabled,p=f.connection.identity,h=d||function(){return!0},l=null!==(t="boolean"!=typeof u&&u.disableAutoAppSystem)&&void 0!==t&&t,v("metrics",c=Z({connection:u?o:void 0,logger:a.subLogger("metrics"),canUpdateMetric:h,system:"Glue42",service:null!==(e=null==p?void 0:p.service)&&void 0!==e?e:"metrics-service",instance:null!==(r=null!==(i=null==p?void 0:p.instance)&&void 0!==i?i:null==p?void 0:p.windowId)&&void 0!==r?r:St(),disableAutoAppSystem:l,pagePerformanceMetrics:"boolean"!=typeof u?null==u?void 0:u.pagePerformanceMetrics:void 0}),s),Promise.resolve()),y(),g(),m()]);var t,e,i,r,s,u,d,p,h,l})).then((function(){return s.readyPromise})).then((function(){return w(f.libs||[])})).then((function(){var t=Object.keys(l).map((function(t){var e=l[t];return e.ready?e.ready():Promise.resolve()}));return Promise.all(t)})).then((function(){var i={coreVersion:Ut,version:f.version};h.stop();var r={feedback:function(t){s&&s.invoke("T42.ACS.Feedback",t,"best")},info:i,logger:a,interop:s,agm:s,connection:o,metrics:c,contexts:u,bus:d,version:f.version,userConfig:t,done:function(){return null==a||a.info("done called by user..."),o.logout()}};if(r.performance={get glueVer(){return f.version},get glueConfig(){return JSON.stringify(t)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var t=it;return Object.keys(t).map((function(e){var n=t[e];return{name:e,duration:n.endTime-n.startTime,marks:n.marks}}))}},Object.keys(l).forEach((function(t){var e=l[t];r[t]=e})),r.config={},Object.keys(f).forEach((function(t){r.config[t]=f[t]})),e&&e.extOptions&&Object.keys(e.extOptions).forEach((function(t){r.config[t]=null==e?void 0:e.extOptions[t]})),(null==e?void 0:e.enrichGlue)&&e.enrichGlue(r),n&&n.updatePerfData&&n.updatePerfData(r.performance),r.agm){var p=function(t,e,n){return function(){r.logger.warn("glue.js - 'glue.agm."+e+"' method is deprecated, use 'glue.interop."+n+"' instead."),t.apply(r.agm,arguments)}},v=r.agm;v.method_added=p(r.agm.methodAdded,"method_added","methodAdded"),v.method_removed=p(r.agm.methodRemoved,"method_removed","methodRemoved"),v.server_added=p(r.agm.serverAdded,"server_added","serverAdded"),v.server_method_aded=p(r.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),v.server_method_removed=p(r.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return r})).catch((function(t){return Promise.reject({err:t,libs:l})}))};"undefined"!=typeof window&&(window.GlueCore=je),je.version=Ut,je.default=je;var Ee=function(){function t(t){this._id=t}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),t.prototype._update=function(t){if(t._id!==this._id)throw Error("Can not update from entity with different id.");this._updateCore(t)},t.prototype._updateCore=function(t){},t.prototype._beforeDelete=function(t){},t}();function Oe(t){return"string"==typeof t}function Re(t){return Array.isArray?Array.isArray(t):"[object Array]"===toString.call(t)}function Ne(t){return void 0===t}function Le(t){return!t||void 0===t}function We(t){return!!(t&&t.constructor&&t.call&&t.apply)}function De(t,e){void 0!==t&&e(t)}var Fe=function(t){function e(e,n,i,r){var o=t.call(this,e)||this;return o._name=e,o._description=r,o._ownerWindow=n,o._helperWindows=i||[],o}return g(e,t),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"description",{get:function(){return this._description},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"helperWindows",{get:function(){var t=this;return this._helperWindows.map((function(e){return t.covertToWindowDef(e)}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ownerWindow",{get:function(){return this.covertToWindowDef(this._ownerWindow)},enumerable:!0,configurable:!0}),e.prototype.initiate=function(t,e,n){return this._manager.initiate(this._name,t,e,n)},e.prototype._updateCore=function(e){var n=this;t.prototype._updateCore.call(this,e),De(e._description,(function(t){return n._description=t})),De(e._ownerWindow,(function(t){return n._ownerWindow=t})),De(e._helperWindows,(function(t){return n._helperWindows=t}))},e.prototype.covertToWindowDef=function(t){var e,n,i,r;return{type:null===(n=null===(e=t)||void 0===e?void 0:e.id)||void 0===n?void 0:n.type,name:null===(r=null===(i=t)||void 0===i?void 0:i.id)||void 0===r?void 0:r.name}},e}(Ee),Be=function(t){function e(e,n){var i=t.call(this,e)||this;return i._name=e,i._appByWindowTypeGetter=n,i}return g(e,t),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"config",{get:function(){return this._appByWindowTypeGetter(this._name)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windows",{get:function(){return this._manager.getWindows({type:this._name})},enumerable:!0,configurable:!0}),e.prototype.create=function(t,e){var n=Object.assign({type:this.name,name:this.name,isIndependent:!1},e);return this._manager.createWindow(t,n)},e}(Ee),Ge=function(t,e){this.entity=t,this.context=e},qe=function(t){this.type=t},He=function(t){function e(e,n){var i=t.call(this,Ve.StatusChange)||this;return i.newStatus=e,i.oldStatus=n,i}return g(e,t),e}(qe),Ue=function(t){function e(e,n,i){var r=t.call(this,Ve.ActivityContextChange)||this;return r.context="string"==typeof e?JSON.parse(e):e,r.updated=n,r.removed=i,r}return g(e,t),e}(qe),Ve=function(){function t(){}return t.Added="added",t.Removed="removed",t.Updated="updated",t.Closed="closed",t.StatusChange="statusChange",t.ActivityContextChange="activityContextUpdate",t.ActivityWindowEvent="activityWindowEvent",t.ActivityWindowJoinedActivity="joined",t.ActivityWindowLeftActivity="left",t}(),Je=function(){function t(){}return t.Created="created",t.Started="started",t.Destroyed="destroyed",t}(),ze=function(){function t(t){this._activity=t}return t.prototype.register=function(e,n){this._ensureHasAgm(),t.AGM.register(e,n)},t.prototype.servers=function(){return this._ensureHasAgm(),Le(this._activity)?[]:this._activity.windows.map((function(t){return t.instance}))},t.prototype.methods=function(){var t=this;if(this._ensureHasAgm(),Le(this._activity))return[];var e=this._activity.windows,n=[],i=[];return e.forEach((function(e){t.methodsForWindow(e).forEach((function(t){-1===n.indexOf(t.name)&&(n.push(t.name),i.push(t))}))})),i},t.prototype.methodsForWindow=function(e){return this._ensureHasAgm(),e.instance?t.AGM.methodsForInstance(e.instance):[]},t.prototype.invoke=function(e,n,i,r,o,s){this._ensureHasAgm();var a=this.servers();if(Le(i)&&(i="activity.all"),Oe(i))if("activity.all"===i)a;else{if("activity.best"!==i){if("all"===i||"best"===i)return function(t,e,n){if("function"!=typeof e&&"function"!=typeof n)return t;"function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n)}(t.AGM.invoke(e,n,i,r),o,s);throw new Error("Invalid invoke target "+i)}var c=a.filter((function(n){return t.AGM.methodsForInstance(n).filter((function(t){return t.name===e})).length>0}));c.length>0&&[c[0]]}else if(Re(i)){if(i.length>=0){var u=i[0];if(this._isInstance(u))i.map((function(t){return t}));else{if(!this._isActivityWindow(u))throw new Error("Unknown target object");i.map((function(t){return t.instance}))}}}else if(this._isInstance(i))[i];else{if(!this._isActivityWindow(i))throw new Error("Unknown target object");[i.instance]}throw new Error("Not implemented")},t.prototype.unregister=function(e){return this._ensureHasAgm(),t.AGM.unregister(e)},t.prototype.createStream=function(e,n,i){this._ensureHasAgm(),t.AGM.createStream(e,{subscriptionAddedHandler:n,subscriptionRemovedHandler:i,subscriptionRequestHandler:void 0})},t.prototype.subscribe=function(e,n,i){return this._ensureHasAgm(),t.AGM.subscribe(e,n)},t.prototype._ensureHasAgm=function(){if(Le(t.AGM))throw new Error("Agm should be configured to be used in activity")},t.prototype._isInstance=function(t){return void 0!==t.application},t.prototype._isActivityWindow=function(t){return void 0!==t.instance},t}(),Ke=function(){function t(t,e,n){this._manager=t,this._ownerActivityId=e,this._state=n}return Object.defineProperty(t.prototype,"ownerId",{get:function(){return this._state.ownerId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowIds",{get:function(){return this._state.windowIds},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frameColor",{get:function(){return this._state.frameColor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this._state.context},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tag",{get:function(){return this._state.tag},enumerable:!0,configurable:!0}),t.prototype.detach=function(t){var e=this;t=t||{};var n={};return Object.keys(this._state).forEach((function(t){n[t]=e._state[t]})),n.context=t.context||n.context,n.frameColor=t.frameColor||n.frameColor,this._manager.detachActivities(this._ownerActivityId,n)},t}(),Ye=function(t){setTimeout(t,0)};function Ze(t,e){if(!We(e))return t;t.then((function(t){Ye((function(){e(null,t)}))}),(function(t){Ye((function(){e(t,null)}))}))}var Qe=function(t){function e(e,n,i,r,o){var s=t.call(this,e)||this;return s._id=e,s._actType=n,s._status=i,s._context=r,s._ownerId=o,s._agm=new ze(s),s}return g(e,t),Object.defineProperty(e.prototype,"type",{get:function(){if(this._manager)return this._manager.getActivityType(this._actType)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return this._context},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"status",{get:function(){return this._status},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"owner",{get:function(){return this._ownerId?this._manager.getWindows({id:this._ownerId})[0]:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windows",{get:function(){return this._manager.getWindows({activityId:this._id})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"agm",{get:function(){return this._agm},enumerable:!0,configurable:!0}),e.prototype.addWindow=function(t,e){return this._manager.addWindowToActivity(this,t,e)},e.prototype.createWindow=function(t,e){return this._manager.createWindow(this,t,e)},e.prototype.createStackedWindows=function(t,e,n){return this._manager.createStackedWindows(this,t,e,n)},e.prototype.leave=function(t,e){return this._manager.leaveWindowFromActivity(this,t,e)},e.prototype.getWindowsByType=function(t){var e={activityId:this._id,type:t};return this._manager.getWindows(e)},e.prototype.setContext=function(t,e){return this._manager.setActivityContext(this,t,e)},e.prototype.updateContext=function(t,e){return this._manager.updateActivityContext(this,t,e)},e.prototype.onStatusChange=function(t){var e=this;return this._manager.subscribeActivityEvents((function(n,i,r){n.id===e.id&&t(n,i,r)}))},e.prototype.onWindowEvent=function(t){var e=this;return this._manager.subscribeWindowEvents((function(n,i,r){n.id===e.id&&t(n,i,r)}))},e.prototype.onContextChanged=function(t){var e=this;this._manager.subscribeActivityContextChanged((function(n,i,r,o){n.id===e.id&&t(i,r,o,n)}));try{t(this.context,this.context,[],this)}catch(t){return}},e.prototype.stop=function(){this._manager.stopActivity(this)},e.prototype.clone=function(t){return this._manager.clone(this,t)},e.prototype.attach=function(t,e){var n;return n="string"==typeof t?t:t.id,this._manager.attachActivities(n,this.id,e)},e.prototype.onActivityAttached=function(t){var e=this;this._manager.subscribeActivitiesAttached((function(n,i,r){n===e._id&&t(r)}))},e.prototype.onDetached=function(t){var e=this;this._manager.subscribeActivitiesDetached((function(n,i,r){i.id===e._id&&t(n,r)}))},e.prototype._updateCore=function(e){var n=this;t.prototype._updateCore.call(this,e),De(e._actType,(function(t){return n._actType=t})),De(e._context,(function(t){return n._context=t})),De(e._ownerId,(function(t){return n._ownerId=t})),!e._status||this._status&&this._status.state===e._status.state||(this._status=e._status)},e.prototype._updateDescriptors=function(t){var e=this;this._attached=t.map((function(t){return new Ke(e._manager,e._id,t)}))},Object.defineProperty(e.prototype,"attached",{get:function(){return this._attached},enumerable:!0,configurable:!0}),e.prototype.setFrameColor=function(t,e){var n=this;return Ze(new Promise((function(e,i){var r=n.windows.length;0===r&&e(n),n.windows.forEach((function(i){i.underlyingWindow.setFrameColor(t,(function(){--r<=0&&e(n)}))})),setTimeout((function(){r>0&&i(n.id+" - timed out waiting for setFrameColor with"+t)}),5e3)})),e)},e.prototype.getFrameColor=function(){return this.windows&&0!==this.windows.length?this.windows[0].underlyingWindow.frameColor:""},e}(Ee),Xe=function(){function t(){}return t.Trace="trace",t.Debug="debug",t.Info="info",t.Warn="warn",t.Error="error",t}(),$e=function(){function t(e){this._name=e,Le(t.GlueLogger)||(this._glueLogger=t.GlueLogger.subLogger(e))}return t.GetNamed=function(e){return new t(e)},t.Get=function(e){return new t(t.GetTypeName(e))},t.prototype.trace=function(e){Le(this._glueLogger)?t.Level===Xe.Trace&&console.info(this._getMessage(e,Xe.Trace)):this._glueLogger.trace(e)},t.prototype.debug=function(e){Le(this._glueLogger)?t.Level!==Xe.Debug&&t.Level!==Xe.Trace||console.info(this._getMessage(e,Xe.Debug)):this._glueLogger.debug(e)},t.prototype.info=function(e){Le(this._glueLogger)?t.Level!==Xe.Debug&&t.Level!==Xe.Trace&&t.Level!==Xe.Info||console.info(this._getMessage(e,Xe.Info)):this._glueLogger.info(e)},t.prototype.warn=function(e){Le(this._glueLogger)?t.Level!==Xe.Debug&&t.Level!==Xe.Trace&&t.Level!==Xe.Info&&t.Level!==Xe.Warn||console.info(this._getMessage(e,Xe.Info)):this._glueLogger.warn(e)},t.prototype.error=function(t){Le(this._glueLogger)?(console.error(this._getMessage(t,Xe.Error)),console.trace()):this._glueLogger.error(t)},t.prototype._getMessage=function(t,e){return"["+e+"] "+this._name+" - "+t},t.GetTypeName=function(t){var e=/function (.{1,})\(/.exec(t.constructor.toString());return e&&e.length>1?e[1]:""},t.Level=Xe.Info,t}(),tn=function(t){function e(e,n,i,r,o,s,a,c){var u=t.call(this,e)||this;return u._logger=$e.Get("window"),u._type=i,u._activityId=r,u._name=n,u._instance=o,u._isIndependent=s,u._windowGetter=a,u._hcWindowId=c,u}return g(e,t),e.prototype.getBounds=function(){return this._manager.getWindowBounds(this.id)},Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isIndependent",{get:function(){return this._isIndependent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"type",{get:function(){if(this._manager)return this._manager.getWindowType(this._type)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"activity",{get:function(){if(!Ne(this._activityId))return this._manager.getActivityById(this._activityId)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isOwner",{get:function(){var t=this.activity;return!Ne(t)&&t.owner.id===this.id},enumerable:!0,configurable:!0}),e.prototype.setVisible=function(t,e){return this._manager.setWindowVisibility(this.id,t)},e.prototype.activate=function(t){return this._manager.activateWindow(this.id,t)},e.prototype.setBounds=function(t,e){return this._manager.setWindowBounds(this.id,t,e)},e.prototype.close=function(){return this._manager.closeWindow(this.id)},Object.defineProperty(e.prototype,"instance",{get:function(){return this._instance},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"underlyingWindow",{get:function(){var t=this._windowGetter();return t||{id:this._hcWindowId}},enumerable:!0,configurable:!0}),e.prototype.onActivityJoined=function(t){this._subscribeForActivityWindowEvent(Ve.ActivityWindowJoinedActivity,t)},e.prototype.onActivityRemoved=function(t){this._subscribeForActivityWindowEvent(Ve.ActivityWindowLeftActivity,t)},e.prototype._updateCore=function(t){var e=this;De(t._activityId,(function(t){return e._activityId=t})),De(t._isIndependent,(function(t){return e._isIndependent=t})),De(t._hcWindowId,(function(t){return e._hcWindowId=t})),De(t._type,(function(t){return e._type=t})),De(t._name,(function(t){return e._name=t})),Le(t._instance)||(this._instance=t._instance)},e.prototype._subscribeForActivityWindowEvent=function(t,e){var n=this;this._manager.subscribeWindowEvents((function(i,r,o){r.id===n.id&&o===t&&e(i)}))},e.prototype._beforeDelete=function(t){this._hcWindowId=t._hcWindowId},e}(Ee),en=function(){function t(t,e,n){this.state=t,this.message=e,this.time=n}return t.prototype.getState=function(){return this.state},t.prototype.getMessage=function(){return this.message},t.prototype.getTime=function(){return this.time},t}(),nn="error",rn="add-types",on="created",sn="destroyed",an="initiated",cn="joined",un="activity-joined",dn="left",pn="owner-changed",hn="add-peer-factories",fn="peer-factories-added",ln="peer-factories-removed",vn="peer-created",yn=function(){function t(t){var e=this;if(this._activityChangeCallbacks=[],this._activityTypeStatusChangeCallbacks=[],this._activityWindowChangeCallbacks=[],this._windowTypeStatusChangeCallbacks=[],this._peerIdAndFactoryIdToPeerType={},this._peerFactoriesRegisteredByUs={},this._gw3Subscriptions=[],this._contextSubscriptions={},this._activityTypesInitiatedFromMe={},this._config=t,this._connection=t.connection,this._logger=t.logger,this._contexts=t.contexts,this._windows=t.windows,this._sessionJoinedPromise=new Promise((function(t){e._sessionJoinedPromiseResolve=t})),this._activityJoinedPromise=new Promise((function(t){e._activityJoinedPromiseResolve=t})),this._config.activityId||this._activityJoinedPromiseResolve({}),this._gw3Session=this._connection.domain("activity",["joined","initiated","peer-created","token"]),"undefined"!=typeof window){var n=window.glue42gd;n&&"function"==typeof n.addRefreshHandler&&n.addRefreshHandler((function(t,i){e._gw3Session.send({type:"reload"}).then((function(e){if(e.token){try{n.setGWToken(e.token)}catch(t){return void i(t.message||t)}t()}else i("Expected gateway token for refreshing.")}),i)}))}}return t.activityTypeGwMessageEntityToActivityType=function(t,e){var n=function(t){return new Be(t,void 0)};return new Fe(t.name,t.owner_type&&n(t.owner_type),t.helper_types&&t.helper_types.map(n),e)},t.peerFactoryGwMessageEntityToWindowType=function(t){return new Be(t.peer_type,(function(t){}))},t.activityGwMessageToActivity=function(t,e){var n=void 0!==t.owner?t.owner.peer_id:t.owner_id;return new Qe(t.activity_id,t.activity_type,e,t.context_snapshot,n)},t.activityToActivityStatusChangeEvent=function(t){return new Ge(t,new He(t.status,void 0))},Object.defineProperty(t.prototype,"bridgeType",{get:function(){return"GW3"},enumerable:!0,configurable:!0}),t.prototype.init=function(){var t=this;this.forwardActivityTypeMessagesToStatusEventHandlers(),this.subscribe(on,this.handleActivityCreatedMessage),this.subscribe(sn,this.handleActivityDestroyedMessage),this.forwardActivityMessagesToStatusEventHandlers(),this.forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers(),this.forwardPeerFactoryMessagesToStatusEventHandlers(),this.forwardPeerFactoryMessagesToPeerFactoryRequests(),this.subscribe(fn,this.handlePeerFactoriesAdded),this.subscribe(ln,this.handlePeerFactoriesRemoved),this.forwardActivityWindowMessagesToEventHandlers(),this.subscribe("dispose-peer",(function(){if("dispose"!==t._config.disposeRequestHandling){if("exit"===t._config.disposeRequestHandling){if(t._windows&&void 0!==t._windows.my())return void t._windows.my().close();if("undefined"!=typeof window&&"function"==typeof window.close)return void window.close();if("undefined"!=typeof process&&"function"==typeof process.exit)return void process.exit()}}else t.dispose()})),this._gw3Session.onJoined((function(){"trackMyOnly"===t._config.mode||"trackMyTypeAndInitiatedFromMe"===t._config.mode?t._sessionJoinedPromiseResolve(t):t._gw3Session.send({type:"subscribe",activity_types:"trackAll"===t._config.mode?[]:"trackTypes"===t._config.mode?t._config.typesToTrack:[]}).then((function(){t._sessionJoinedPromiseResolve(t)}))})),this._gw3Session.join()},t.prototype.dispose=function(){var t=this;this._gw3Subscriptions.forEach((function(e){return e&&t._connection.off(e)})),this._gw3Subscriptions.length=0},t.prototype.ready=function(){return Promise.all([this._sessionJoinedPromise,this._activityJoinedPromise])},t.prototype.initReady=function(){return this._sessionJoinedPromise},t.prototype.onActivityTypeStatusChange=function(t){this._activityTypeStatusChangeCallbacks.push(t)},t.prototype.registerActivityType=function(e,n,i,r,o){var s=this,a={};a.name=e;var c=function(t){return{type:t.type,name:t.name,configuration:t}};return a.owner_type=c(n),a.helper_types=i.map(c),this._gw3Session.send({type:rn,types:[a]}).then((function(){var e=t.activityTypeGwMessageEntityToActivityType(a,o);return s.invokeCallbacks(s._activityTypeStatusChangeCallbacks,new Ge(e,new qe(Ve.Added)),rn),e}))},t.prototype.unregisterActivityType=function(t){var e=this;return this._gw3Session.send({type:"remove-types",types:[t]}).then((function(){var n=new Fe(t,void 0,void 0,void 0);e.invokeCallbacks(e._activityTypeStatusChangeCallbacks,new Ge(n,new qe(Ve.Removed)),rn)}))},t.prototype.onWindowTypeStatusChange=function(t){this._windowTypeStatusChangeCallbacks.push(t)},t.prototype.registerWindowFactory=function(e,n,i){var r=this;if(this._peerFactoriesRegisteredByUs[e])return Promise.reject(new Error("Factory for windowType "+e+" already registered."));this._peerFactoriesRegisteredByUs[e]=n;var o={id:e,peer_type:e,configuration:i};return this._gw3Session.send({type:hn,factories:[o]}).then((function(){r.invokeCallbacks(r._windowTypeStatusChangeCallbacks,new Ge(t.peerFactoryGwMessageEntityToWindowType(o),new qe(Ve.Added)),hn)})).catch((function(){delete r._peerFactoriesRegisteredByUs[e]}))},t.prototype.unregisterWindowFactory=function(t){var e=this;return this._peerFactoriesRegisteredByUs[t]?(delete this._peerFactoriesRegisteredByUs[t],this._gw3Session.send({type:"remove-peer-factories",factory_ids:[t]}).then((function(){e.invokeCallbacks(e._windowTypeStatusChangeCallbacks,new Ge(new Be(t,void 0),new qe(Ve.Removed)),hn)}))):Promise.reject(new Error("Factory for windowType "+t+" not registered."))},t.prototype.onActivityStatusChange=function(t){this._activityChangeCallbacks.push(t)},t.prototype.initiateActivity=function(t,e,n){var i=this,r={type:"create",activity_type:t,initial_context:e};return this.isOverrideTypeDefinition(n)?r.types_override={owner_type:{type:n.owner.type,name:n.owner.name,configuration:n.owner},helper_types:n.helpers&&n.helpers.map((function(t){return{type:t.type,name:t.name,configuration:t}}))}:r.configuration=n&&n.map((function(t){return{type:t.type,name:t.name,configuration:t}})),this.sendCreateAndMapResultingMessagesToPromise(r,an,(function(t,e){return t.request_id===e}),on,(function(t,e,n){return t.activity_id===n.activity_id}),sn,(function(t,e,n){return t.activity_id===n.activity_id}),(function(t){return t.activity_id})).then((function(e){return"trackMyTypeAndInitiatedFromMe"!==i._config.mode||i._activityTypesInitiatedFromMe[t]?e:(i._activityTypesInitiatedFromMe[t]=!0,i._gw3Session.send({type:"subscribe",activity_types:[t]}).then((function(){return e})))}))},t.prototype.stopActivity=function(t){return this._gw3Session.send({type:"destroy",activity_id:t.id,reason_uri:"com.tick42.glue.activity.constants.destroyReason.general",reason:"Destroying activity"}).then((function(t){return!0}))},t.prototype.updateActivityContext=function(t,e,n,i){if(n)return this._contexts.set(t.id,e);for(var r=0,o=i=i||[];r<o.length;r++){e[o[r]]=null}return this._contexts.update(t.id,e)},t.prototype.announceWindow=function(t,e){throw new Error("Invalid operation 'announceWindow' for GW3 protocol")},t.prototype.registerWindow=function(t,e,n){var i=void 0!==this._connection.gatewayToken,r=this._connection.peerId;if("undefined"!=typeof window){var o=window.glue42gd;o&&(i=void 0!==o.activityInfo)}return i&&this._gw3Session.send({type:"ready"}),this.invokeCallbacks(this._activityWindowChangeCallbacks,new Ge(new tn(r,e,t,void 0,this.getAgmInstance(r),n,this.generateWindowGetter(r),void 0),new qe(Ve.Added)),"register window"),Promise.resolve(r)},t.prototype.onActivityWindowChange=function(t){this._activityWindowChangeCallbacks.push(t)},t.prototype.createWindow=function(t,e){var n=this;return e.layout||(e.left||e.width||e.height||e.top)&&(e.layout={mode:"pixels",cellSize:1}),this.sendCreateAndMapResultingMessagesToPromise({type:"create-peer",peer_type:e.type,peer_name:e.name||e.type,configuration:e,activity_id:t},void 0,void 0,vn,(function(t,e){return t.request_id===e}),void 0,void 0,(function(t){return t.created_id})).then((function(i){if(t)return n.joinActivity(t,i,e.name).then((function(){return i}))}))},t.prototype.closeWindow=function(t){return this._gw3Session.send({type:"destroy-peer",destroy_peer_id:t}).then((function(t){}))},t.prototype.getAnnouncementInfo=function(){var t=this._config.activityId||this._config.announcementInfo&&this._config.announcementInfo.activityId,e=this._config.announcementInfo&&this._config.announcementInfo.activityWindowType,n=this._config.announcementInfo&&this._config.announcementInfo.activityWindowIndependent,i=this._config.announcementInfo&&this._config.announcementInfo.activityWindowName;if("undefined"!=typeof window&&void 0!==window.location&&window.location.search&&"function"==typeof URLSearchParams){var r=new URLSearchParams(location.search.slice(1));e=(e=e||r.get("t42PeerType"))||r.get("t42ActivityWindowType"),void 0===n&&(n=r.get("t42ActivityWindowIndependent")),i=i||r.get("t42ActivityWindowName"),t=t||r.get("t42ActivityId")}return{activityWindowId:void 0,activityId:t,activityWindowType:e=e||"unknown",activityWindowIndependent:n=n||!1,activityWindowName:i=i||this._connection.peerId}},t.prototype.joinActivity=function(t,e,n){var i=this,r=n&&{name:n}||{};return this._gw3Session.send(m({type:"join-activity",target_id:e,activity_id:t},r)).then((function(){i.invokeCallbacks(i._activityWindowChangeCallbacks,new Ge(new tn(e,void 0,void 0,t,i.getAgmInstance(e),void 0,i.generateWindowGetter(e),void 0),new qe(Ve.ActivityWindowJoinedActivity)),"activity joined - ActivityWindow"),i.invokeCallbacks(i._activityChangeCallbacks,new Ge(new Qe(t,void 0,new en("created",void 0,void 0),void 0,void 0),new qe(Ve.Updated)),"activity joined - Activity")}))},t.prototype.leaveActivity=function(t,e){var n=this;return this._gw3Session.send({type:"leave-activity",target_id:e,activity_id:t}).then((function(){n.invokeCallbacks(n._activityWindowChangeCallbacks,new Ge(new tn(e,void 0,void 0,null,n.getAgmInstance(e),void 0,n.generateWindowGetter(e),void 0),new qe(Ve.ActivityWindowLeftActivity)),"activity left - ActivityWindow"),n.invokeCallbacks(n._activityChangeCallbacks,new Ge(new Qe(t,void 0,new en("created",void 0,void 0),void 0,void 0),new qe(Ve.Updated)),"activity left - Activity")}))},t.prototype.getActivityTypes=function(){return Promise.resolve([])},t.prototype.getWindowTypes=function(){return Promise.resolve([])},t.prototype.getActivities=function(){return Promise.resolve([])},t.prototype.getActivityWindows=function(){return Promise.resolve([])},t.prototype.createStackedWindows=function(t,e,n){},t.prototype.getWindowBounds=function(t){},t.prototype.setWindowBounds=function(t,e){},t.prototype.activateWindow=function(t,e){},t.prototype.setWindowVisibility=function(t,e){},t.prototype.cloneActivity=function(t,e){},t.prototype.attachActivities=function(t,e,n){return this._gw3Session.send({type:"merge",into:e,merge:t})},t.prototype.detachActivities=function(t,e){return this._gw3Session.send({type:"split",from:t}).then((function(){return""}))},t.prototype.onActivitiesAttached=function(t){},t.prototype.onActivitiesDetached=function(t){},t.prototype.onActivityAttachedDescriptorsRefreshed=function(t){},t.prototype.getAttachedDescriptors=function(){return Promise.resolve([])},t.prototype.getRandomRequestId=function(){return this._connection.peerId+":"+Math.floor(1e9*Math.random())},t.prototype.forwardAddedAndRemovedMessagesToEventHandler=function(t,e,n,i){var r=function(t){return function(e){return new Ge(e,new qe(t?Ve.Added:Ve.Removed))}};return[t&&this.forwardMessageToEventHandler(t,(function(t){return n(t,!0)}),r(!0),i),e&&this.forwardMessageToEventHandler(e,(function(t){return n(t,!1)}),r(!1),i)].filter((function(t){return t}))},t.prototype.forwardMessageToEventHandler=function(t,e,n,i){return this.subscribe(t,(function(t){e(t).forEach((function(e){return i.forEach((function(i){return i(n(e,t))}))}))}))},t.prototype.sendCreateAndMapResultingMessagesToPromise=function(t,e,n,i,r,o,s,a){var c,u,d,p,h,f,l=this,v=this.getRandomRequestId(),y=new Promise((function(t,e){c=t,u=e})),g=null,m=function(){l.dropSubscription(d),l.dropSubscription(p),l.dropSubscription(h),l.dropSubscription(f)};d=e&&this.subscribe(e,(function(t){n(t,v)&&(g=t,l.dropSubscription(d))})),p=this.subscribe(i,(function(t){r(t,v,g)&&c(a(t))})),h=o&&this.subscribe(o,(function(t){s(t,v,g)&&u(t)})),f=o&&this.subscribe(nn,(function(t){t.request_id===v&&u(t)})),t.request_id=v;var w=this._gw3Session.send(t).then((function(){return y}));return w.then(m,m),w},t.prototype.peerFactoryIdAndOwnerIdToWindowType=function(t,e){var n=this._peerIdAndFactoryIdToPeerType[e+":"+t];return n?new Be(n,void 0):null},t.prototype.subscribe=function(t,e){var n=this,i=this._connection.on(t,(function(t){return e.bind(n)(t)}));return this._gw3Subscriptions.push(i),i},t.prototype.dropSubscription=function(t){t&&(this._connection.off(t),delete this._gw3Subscriptions[this._gw3Subscriptions.indexOf(t)])},t.prototype.invokeCallbacks=function(t,e,n){var i=this;t.forEach((function(t){try{t(e)}catch(t){i._logger.error("Error in "+(n||e.context.type)+" callback: "+JSON.stringify(t))}}))},t.prototype.handleActivityCreatedMessage=function(t){t.context_id?this._contextSubscriptions[t.activity_id]||this.subscribeToContext(t):this._logger.error("Activity created with unknown context_id: "+t.activity_id)},t.prototype.subscribeToContext=function(t){return w(this,void 0,void 0,(function(){var e,n,i,r=this;return b(this,(function(o){switch(o.label){case 0:return e=t.activity_id,n=this._contextSubscriptions,i=e,[4,this._contexts.subscribe(e,(function(t,n,i){var o=new Ge(new Qe(e,void 0,void 0,t,void 0),new Ue(t,n,i));r.invokeCallbacks(r._activityChangeCallbacks,o,"context updated")}))];case 1:return n[i]=o.sent(),[2]}}))}))},t.prototype.handleActivityDestroyedMessage=function(t){var e=this._contextSubscriptions[t.activity_id];"function"==typeof e&&e(),delete this._contextSubscriptions[t.activity_id]},t.prototype.handlePeerFactoriesAdded=function(t){var e=this;t.factories.forEach((function(n){e._peerIdAndFactoryIdToPeerType[t.owner_id+":"+n.id]=n.peer_type}))},t.prototype.handlePeerFactoriesRemoved=function(t){var e=this;t.factory_ids.forEach((function(n){delete e._peerIdAndFactoryIdToPeerType[t.owner_id+":"+n]}))},t.prototype.forwardActivityTypeMessagesToStatusEventHandlers=function(){this.forwardAddedAndRemovedMessagesToEventHandler("types-added","types-removed",(function(e,n){return n?e.types.map((function(e){return t.activityTypeGwMessageEntityToActivityType(e,void 0)})):e.types.map((function(t){return new Fe(t.name,void 0,void 0,void 0)}))}),this._activityTypeStatusChangeCallbacks)},t.prototype.forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers=function(){for(var t=this,e=0,n=[on,cn,pn];e<n.length;e++){var i=n[e];this.forwardMessageToEventHandler(i,(function(e){return[e.owner||m(m({},e),{type:e.peer_type,name:e.peer_name,peer_id:e.owner_id})].concat(e.participants||[]).map((function(n){return new tn(n.peer_id,n.name,n.type,e.activity_id,t.getAgmInstance(n.peer_id),void 0,t.generateWindowGetter(n.peer_id),void 0)}))}),(function(t,e){return new Ge(t,new qe(Ve.ActivityWindowJoinedActivity))}),this._activityWindowChangeCallbacks)}},t.prototype.forwardActivityMessagesToStatusEventHandlers=function(){for(var e=0,n=[on,cn];e<n.length;e++){var i=n[e];this.forwardMessageToEventHandler(i,(function(e){return[t.activityGwMessageToActivity(e,new en("started","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks)}this.forwardMessageToEventHandler(sn,(function(e){return[t.activityGwMessageToActivity(e,new en("destroyed",e.reason,new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks),this.forwardMessageToEventHandler(an,(function(e){return[t.activityGwMessageToActivity(e,new en("created","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks),this.forwardMessageToEventHandler(pn,(function(e){return[t.activityGwMessageToActivity(e,new en("created","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks)},t.prototype.forwardPeerFactoryMessagesToStatusEventHandlers=function(){var e=this;this.forwardAddedAndRemovedMessagesToEventHandler(fn,ln,(function(n,i){return i?n.factories.map(t.peerFactoryGwMessageEntityToWindowType):n.factory_ids.map((function(t){return e.peerFactoryIdAndOwnerIdToWindowType(t,n.owner_id)})).filter((function(t){return null!=t}))}),this._windowTypeStatusChangeCallbacks)},t.prototype.forwardPeerFactoryMessagesToPeerFactoryRequests=function(){var t=this;this.subscribe("peer-requested",(function(e){var n=t._peerFactoriesRegisteredByUs[e.peer_factory];if(n)try{var i=e.configuration||{};i.gateway_token=i.gateway_token||e.gateway_token,i.peer_factory=i.peer_factory||e.peer_factory;var r=n({activityId:e.activity&&e.activity.id,activityType:e.activity&&e.activity.type,type:e.configuration&&e.configuration.type,gwToken:i.gateway_token,configuration:i});r&&r.then&&r.catch&&r.catch((function(n){return t._gw3Session.send({type:nn,request_id:e.request_id,reason:n&&(n.message||JSON.stringify(n))})}))}catch(n){t._gw3Session.send({type:nn,request_id:e.request_id,reason:n&&(n.message||JSON.stringify(n))})}else t._gw3Session.send({type:nn,request_id:e.request_id,reason:"Unknown peer factory "+e.peer_factory})}))},t.prototype.forwardActivityWindowMessagesToEventHandlers=function(){for(var t=this,e=function(e){n.subscribe(e,(function(n){var i=e===un?n.joined_id:n.peer_id,r=e===un?n.joined_type:n.peer_type,o=e===un?n.joined_name:n.peer_name,s=new tn(i,o,r,n.activity_id,t.getAgmInstance(i),void 0,t.generateWindowGetter(i),void 0);t._contextSubscriptions[n.activity_id]?e===cn&&t._activityJoinedPromiseResolve({}):t.subscribeToContext(n).then((function(){e===cn&&t._activityJoinedPromiseResolve({})})),t.invokeCallbacks(t._activityWindowChangeCallbacks,new Ge(s,new qe(Ve.ActivityWindowJoinedActivity)),e)}))},n=this,i=0,r=[un,cn];i<r.length;i++){e(r[i])}this.subscribe(dn,(function(e){var n=new tn(e.left_id,void 0,void 0,null,t.getAgmInstance(e.left_id),void 0,t.generateWindowGetter(e.left_id),void 0);t.invokeCallbacks(t._activityWindowChangeCallbacks,new Ge(n,new qe(Ve.ActivityWindowLeftActivity)),dn)})),this.forwardAddedAndRemovedMessagesToEventHandler(vn,void 0,(function(e){return[new tn(e.created_id,void 0,void 0,void 0,void 0,void 0,t.generateWindowGetter(e.created_id),void 0)]}),this._activityWindowChangeCallbacks)},t.prototype.getAgmInstance=function(t){return this._config.agm.servers().find((function(e){return e.peerId===t||e.windowId===t}))},t.prototype.generateWindowGetter=function(t){var e=this;return function(){var n=e.getAgmInstance(t);if(n){var i=n.windowId;return e._config.windows.list().filter((function(t){return t.id===i}))[0]}}},t.prototype.isOverrideTypeDefinition=function(t){return void 0!==t&&!!t.owner},t}(),gn=function(){function t(t,e){var n=this;this._myAttached=[],this._myDetached=[],this._myAttachedTo=[],this._myDetachedFrom=[],this._myActivityFrameColorChanged=[],this._myActivityJoinedCallbacks=[],this._myActivityRemovedCallbacks=[],this._myContextUpdateCallbacks=[],this._logger=$e.Get(this),this._m=t,t.ready().then((function(t){t.subscribeActivityContextChanged(n._subscribeMyContextChanged.bind(n)),t.subscribeWindowEvents(n._subscribeMyWindowEvent.bind(n)),t.subscribeActivitiesAttached(n._subscribeActivitiesAttached.bind(n)),t.subscribeActivitiesDetached(n._subscribeActivitiesDetached.bind(n)),e&&e.onWindowFrameColorChanged(n._subscribeWindowFrameColorChanged.bind(n))}))}return Object.defineProperty(t.prototype,"window",{get:function(){if(Le(this._w)){var t=this._m.announcedWindows;t.length>0&&(this._w=t[0])}return this._w},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activity",{get:function(){var t=this.window;if(!Le(t))return t.activity},enumerable:!0,configurable:!0}),t.prototype.createWindow=function(t){return this._m.createWindow(this.activity,t)},t.prototype.createStackedWindows=function(t,e){return this._m.createStackedWindows(this.activity,t,e)},Object.defineProperty(t.prototype,"context",{get:function(){var t=this.activity;return Ne(t)?{}:t.context},enumerable:!0,configurable:!0}),t.prototype.updateContext=function(t,e){var n=this.activity;return Ne(n)?new Promise((function(t,e){e("Not in activity")})):n.updateContext(t,e)},t.prototype.setContext=function(t,e){var n=this.activity;return Ne(n)?new Promise((function(t,e){e("Not in activity")})):n.setContext(t,e)},t.prototype.onActivityJoined=function(t){this._myActivityJoinedCallbacks.push(t);var e=this.window;Le(e)||Le(e.activity)||t(e.activity)},t.prototype.onActivityLeft=function(t){this._myActivityRemovedCallbacks.push(t)},t.prototype.onContextChanged=function(t){this._myContextUpdateCallbacks.push(t);var e=this.window;if(!Le(e)){var n=e.activity;Le(n)||t(n.context,n.context,[],n)}},t.prototype.clone=function(t,e){var n=this.activity;return this._m.clone(n,t,e)},t.prototype.attach=function(t,e){var n;return n="string"==typeof t?t:t.id,this._m.attachActivities(n,this.activity.id,e)},t.prototype.onActivityAttached=function(t){this._myAttached.push(t)},t.prototype.onActivityDetached=function(t){this._myDetached.push(t)},t.prototype.onAttachedToActivity=function(t){this._myAttachedTo.push(t)},t.prototype.onDetachedFromActivity=function(t){this._myDetachedFrom.push(t)},Object.defineProperty(t.prototype,"attached",{get:function(){return this.activity?this.activity.attached:[]},enumerable:!0,configurable:!0}),t.prototype.setFrameColor=function(t,e){return this.activity?this.activity.setFrameColor(t,e):Promise.resolve(null)},t.prototype.getFrameColor=function(){return this.activity?this.activity.getFrameColor():""},t.prototype.onFrameColorChanged=function(t){this._myActivityFrameColorChanged.push(t)},t.prototype._subscribeMyContextChanged=function(t,e,n,i){var r=this.window;if(!Le(r)){var o=r.activity;Le(o)||t.id===o.id&&this._notifyMyContextChanged(t,e,n,i)}},t.prototype._subscribeMyWindowEvent=function(t,e,n){Le(this.window)||this.window.id===e.id&&(n===Ve.ActivityWindowJoinedActivity?(this._notifyMyWindowEvent(t,this._myActivityJoinedCallbacks),this._notifyMyContextChanged(t,t.context,null,null)):n===Ve.ActivityWindowLeftActivity&&this._notifyMyWindowEvent(t,this._myActivityRemovedCallbacks))},t.prototype._notifyMyWindowEvent=function(t,e){var n=this;e.forEach((function(e){try{e(t,event)}catch(t){n._logger.warn("error in user callback "+t)}}))},t.prototype._notifyMyContextChanged=function(t,e,n,i){var r=this;n=n||{},i=i||[],this._myContextUpdateCallbacks.forEach((function(o){try{o(e,n,i,t)}catch(t){r._logger.warn("error in user callback "+t)}}))},t.prototype._notifyAttached=function(t){var e=this;this._myAttached.forEach((function(n){try{n(t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyDetached=function(t){var e=this;this._myDetached.forEach((function(n){try{n(t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyAttachedTo=function(t){var e=this;this._myAttachedTo.forEach((function(n){try{n(e.activity,t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyDetachedFrom=function(t,e,n){var i=this;this._myDetachedFrom.forEach((function(r){try{r(t,e,n)}catch(t){i._logger.warn("error in user callback "+t)}}))},t.prototype._subscribeActivitiesAttached=function(t,e){var n=this.window;if(!Le(n)){var i=n.activity;Le(i)||t.id===i.id&&(e.windowIds.indexOf(n.id)>=0?this._notifyAttachedTo(e):this._notifyAttached(e))}},t.prototype._subscribeActivitiesDetached=function(t,e,n){var i=this.window;if(!Le(i)){var r=i.activity;Le(r)||(e.id===r.id&&this._notifyDetached(n),t.id===r.id&&this._notifyDetachedFrom(t,e,n))}},t.prototype._subscribeWindowFrameColorChanged=function(t){var e=this.activity;e&&e.owner&&e.owner.underlyingWindow.id===t.id&&this._myActivityFrameColorChanged.forEach((function(e){e(t.frameColor)}))},t}(),mn=function(){function t(t,e){if(this._logger=$e.Get("ReadyMarker ["+t+"]"),this._logger.debug("Initializing ready marker for '"+t+"' with "+e+" signals to wait"),e<=0)throw new Error("Invalid signal number. Should be > 0");this._signals=e,this._callbacks=[],this._name=t}return t.prototype.setCallback=function(t){this.isSet()?t(void 0):this.isError()?t(this._error):this._callbacks.push(t)},t.prototype.signal=function(t){if(this._logger.debug("Signaled - "+t+" - signals left "+(this._signals-1)),this._signals--,this._signals<0)throw new Error("Error in ready marker '"+this._name+" - signals are "+this._signals);this.isSet()&&this._callbacks.forEach((function(t){t(void 0)}))},t.prototype.error=function(t){this._error=t,this._callbacks.forEach((function(e){e(t)}))},t.prototype.isSet=function(){return!this.isError()&&0===this._signals},t.prototype.isError=function(){return!Ne(this._error)},t.prototype.getError=function(){return this._error},t}(),wn=function(){function t(t){this._items={},this._listeners=[],this._processNew=t}return t.prototype.addOne=function(t){this.add([t])},t.prototype.add=function(t){var e=this;t.forEach((function(t){e.process(new Ge(t,new qe(Ve.Added)))}))},t.prototype.process=function(t){var e=t.context,n=e.type,i=t.entity;if(n===Ve.StatusChange&&!e.oldStatus){var r=this._items[i.id];r&&(e.oldStatus=r.status)}n===Ve.StatusChange&&e.oldStatus&&e.newStatus&&e.oldStatus.state===e.newStatus.state&&(e.type=Ve.Updated),"undefined"==typeof htmlContainer&&(n===Ve.ActivityWindowJoinedActivity&&this._items[i.id]&&this._items[i.id].activity&&(e.type=Ve.Updated),n===Ve.ActivityWindowLeftActivity&&this._items[i.id]&&!this._items[i.id].activity&&(e.type=Ve.Updated));var o=this._updateInternalCollections(i,n,e);return this._notifyListeners(o,e),o},t.prototype.get=function(){var t=[];for(var e in this._items)if(this._items.hasOwnProperty(e)){var n=this._items[e];t.push(n)}return t},t.prototype.getByName=function(t){for(var e in this._items)if(e===t)return this._items[e]},t.prototype.getOrWait=function(t){var e=this;return new Promise((function(n){var i=function(r){r.id===t&&(n(r),e.unsubscribe(i))};e.subscribe(i);var r=e.getByName(t);if(r)return e.unsubscribe(i),void n(r)}))},t.prototype.subscribe=function(t){var e=this;return this._listeners.push(t),Object.keys(this._items).forEach((function(n){var i=e._items[n];t(i,new qe(Ve.Added.toString()))})),function(){e.unsubscribe(t)}},t.prototype.unsubscribe=function(t){var e=this._listeners.indexOf(t);-1!==e&&this._listeners.splice(e,1)},t.prototype._notifyListeners=function(t,e){this._listeners.forEach((function(n){try{n(t,e)}catch(t){return}}))},t.prototype._updateInternalCollections=function(t,e,n){var i=t,r=e===Ve.StatusChange&&i.status&&i.status.state===Je.Destroyed||e===Ve.StatusChange&&n&&n.newStatus&&n.newStatus.state===Je.Destroyed,o=e===Ve.Closed;if(e===Ve.Removed&&void 0===i.isIndependent||o||r){var s=this._items[t.id];return delete this._items[t.id],this._processNew(t),s&&t._beforeDelete(s),t}var a=t.id;return this._items.hasOwnProperty(a)?this._items[t.id]._update(t):(this._processNew(t),this._items[t.id]=t),this._items[t.id]},t}(),bn=function(){function t(t,e,n){var i=this;this._logger=$e.Get("activityManager"),this._announcedWindows=[],this._attachedCallbacks=[],this._detachedCallbacks=[],this._frameColorChangesCallbacks=[],this._windowHandlers=[],this._bridge=t,this._activityTypes=new wn((function(t){return i._grabEntity(t)})),this._windowTypes=new wn((function(t){return i._grabEntity(t)})),this._activities=new wn((function(t){return i._grabEntity(t)})),this._windows=new wn((function(t){return i._grabEntity(t)})),this._dataReadyMarker=new mn("Activity Manager Data",["GetActivityTypes","GetWindowTypes","GetActivities","GetWindows"].length),this._descriptorsMarker=new mn("Attached Activities Descriptors",["GetDescriptors"].length),e?(this._readyMarker=new mn("Activity Manager Announce",["Announcement"].length),this._dataReadyMarker.setCallback((function(t){t&&i._readyMarker.error(t),i._descriptorsMarker.setCallback((function(t){t&&i._readyMarker.error(t),i._logger.debug("Auto announcing window"),i.announceWindow().then((function(t){i._announcedWindows.push(t),i._readyMarker.signal("Successfully announced window with id '"+t.id+"'")})).catch((function(t){i._logger.debug("Will not announce window - "+t),i._readyMarker.signal()}))})),i.refreshDescriptors()}))):this._readyMarker=this._dataReadyMarker,this._bridge.onActivitiesAttached((function(t){i._handleActivitiesAttached(t)})),this._bridge.onActivitiesDetached((function(t){i._handleActivitiesDetached(t)})),this._bridge.onActivityAttachedDescriptorsRefreshed((function(t){i._handleActivityDescriptorsRefreshed(t)})),n&&n.onWindowFrameColorChanged(this._handleWindowFrameColorChanged.bind(this)),this._bridge.init(),this._subscribeForData(),this._bridge.initReady().then((function(t){i._getInitialData()})).catch((function(t){console.log(t)}))}return Object.defineProperty(t.prototype,"usingHc",{get:function(){return"HC"===this._bridge.bridgeType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"announcedWindows",{get:function(){return this._announcedWindows},set:function(t){throw new Error("not allowed")},enumerable:!0,configurable:!0}),t.prototype.ready=function(t){var e=this,n=new Promise((function(t,n){e._readyMarker.setCallback((function(i){i?n(e._readyMarker.getError()):t(e)}))}));return Ze(Promise.all([this._bridge.ready(),n]).then((function(){return e})),t)},t.prototype.getActivityTypes=function(){return this._activityTypes.get()},t.prototype.getActivityType=function(t){return this._activityTypes.getByName(t)},t.prototype.registerActivityType=function(t,e,n,i,r,o){var s=this;return Ze(new Promise((function(o,a){var c;if(Le(t))a("activityTypeName argument can not be undefined");else if(Oe(t))if(Le(s.getActivityType(t)))if(Ne(e))a("Owner window type can not be undefined");else{c=Oe(e)?{type:e,name:"",isIndependent:!1,arguments:{}}:e;var u=[];if(!Ne(n)&&Re(n))for(var d in n){var p=n[d];if(Oe(p)){var h={type:p,name:"",isIndependent:!1,arguments:{},relativeTo:"",relativeDirection:"",windowStyleAttributes:{}};u.push(h)}else u.push(p)}s._bridge.registerActivityType(t,c,u,i,r).then((function(t){s._grabEntity(t),o(t)})).catch((function(t){a(t)}))}else a("Activity type '"+t+"' already exists");else a("activityTypeName should be string")})),o)},t.prototype.unregisterActivityType=function(t,e){var n=this;return Ze(new Promise((function(e,i){var r=n.getActivityType(t);Ne(r)?i("Activity type '"+t+"' does not exists"):n._bridge.unregisterActivityType(t).then((function(){return e(r)}),i)})),e)},t.prototype.initiate=function(t,e,n,i){var r=this;return Ze(new Promise((function(n,o){Ne(r.getActivityType(t))?o("Activity type '"+t+"' does not exists"):r._bridge.initiateActivity(t,e,i).then((function(t){r._activities.getOrWait(t).then((function(t){n(t)})).catch((function(t){return o(t)}))})).catch((function(t){o(t)}))})),n)},t.prototype.subscribeActivityTypeEvents=function(t){this._activityTypes.subscribe((function(e,n){t(e,n.type)}))},t.prototype.getWindowTypes=function(){return this._windowTypes.get()},t.prototype.getWindowType=function(t){return this._windowTypes.getByName(t)},t.prototype.registerWindowFactory=function(t,e,n){var i=this;return Ze(new Promise((function(n,r){if(Le(t))r("no windowType specified");else{if("object"==typeof(o=t)&&null!==o)t=t.getName();else if(!Oe(t))return void r("windowType should be string or object that has getName method");var o;i._bridge.registerWindowFactory(t,e).then((function(t){n(t)})).catch((function(t){r(t)}))}})),n)},t.prototype.unregisterWindowFactory=function(t,e){var n=this;return Ze(new Promise((function(e,i){Le(t)?i("no windowType specified"):Oe(t)?n._bridge.unregisterWindowFactory(t).then((function(t){e(t)})).catch((function(t){i(t)})):i("windowType should be a string")})),e)},t.prototype.getActivities=function(t){var e=this._activities.get();if(e=e.filter((function(t){return t._ownerId})),!t)return e;var n=t;if(Oe(t))n=[t];else if(t instanceof Fe)n=[t.name];else if(!(t instanceof Array))throw new Error("Invalid input argument 'activityType' = "+t);return e.filter((function(t){var e=t.type;return function(t,e){for(var n=0;n<t.length;n++)if(e(t[n],n))return!0;return!1}(n,(function(t){return e.id===t.id}))}))},t.prototype.getActivityById=function(t){return this._activities.getByName(t)},t.prototype.announceWindow=function(t,e){var n=this;return new Promise((function(i,r){var o=n._bridge.getAnnouncementInfo();if(Ne(t)&&(t=o.activityWindowId),Ne(e)&&(e=o.activityWindowType),Le(e))throw new Error("Can not announce - unknown windowType");var s=o&&o.activityId;if(Le(t))n._logger.debug("Registering window with type:'"+e+"', name:'"+o.activityWindowName+"', ind.:'"+o.activityWindowIndependent+"'"),n._bridge.registerWindow(e,o.activityWindowName,o.activityWindowIndependent).then(n._windows.getOrWait.bind(n._windows)).then((function(t){return s?n._activities.getOrWait(s).then((function(e){return t})):t})).then((function(t){i(t)})).catch((function(t){n._logger.error(t)}));else{n._logger.debug("Announcing window with id '"+t+"' and type '"+e+"'");var a=n._windows.getByName(t);if(!Le(a))return n._logger.debug("Window with id '"+t+"' already announced - reusing the window"),void i(a);var c=function(e,o,s){t===o.id&&(s===Ve.ActivityWindowJoinedActivity&&(Ne(o.activity)&&r("UNDEFINED ACTIVITY"),n._logger.trace("Got joined event for id '"+t+"'"),i(o),n.unsubscribeWindowEvents(c)))};n.subscribeWindowEvents(c),n._logger.trace("Waiting for joined event for id '"+t+"'"),n._bridge.announceWindow(e,t)}}))},t.prototype.subscribeWindowTypeEvents=function(t){this._windowTypes.subscribe((function(e,n){t(e,n.type)}))},t.prototype.subscribeActivityEvents=function(t){var e=this;return this._activities.subscribe((function(n,i){if(i.type===Ve.StatusChange){var r=i;t(n,r.newStatus,r.oldStatus)}if(i.type===Ve.Removed||i.type===Ve.StatusChange&&i.newStatus.getState()===Je.Destroyed)for(var o=0,s=e._windows.get();o<s.length;o++){var a=s[o];a.activity&&a.activity.id===n.id&&e._windows.process(new Ge(a,new qe(Ve.ActivityWindowLeftActivity)))}}))},t.prototype.subscribeWindowEvents=function(t){var e=function(e,n){var i=n.type;i===Ve.Added&&(i="opened"),t(e.activity,e,i)};return this._windowHandlers.push([t,e]),this._windows.subscribe(e)},t.prototype.unsubscribeWindowEvents=function(t){var e=this._windowHandlers.find((function(e){return e[0]===t}));e&&(this._windowHandlers.splice(this._windowHandlers.indexOf(e),1),this._windows.unsubscribe(e[1]))},t.prototype.createWindow=function(t,e,n){var i=this;return Ze(new Promise((function(n,r){var o,s;if(Le(e)&&r("windowType is undefined"),Oe(e))o={type:e,name:"",isIndependent:!1,arguments:{}};else if(e instanceof Be)o={type:e.type||e.id,name:e.name||e.type||e.id,isIndependent:!1};else{var a=["url"],c={};Object.keys(e).forEach((function(t){-1===a.indexOf(t)&&(c[t]=e[t])})),o=c}if(!Le(o.relativeTo))if("string"==typeof(s=o.relativeTo))!Le(u=i.getWindows({type:s}))&&u.length>0&&(o.relativeTo=u[0].id);else if(Le(s.type))Le(s.windowId)||(o.relativeTo=s.windowId);else{var u;!Le(u=i.getWindows({type:s.type}))&&u.length>0&&(o.relativeTo=u[0].id)}i._bridge.createWindow(t&&t.id,o).then((function(e){i._logger.debug("Window created, waiting for window entity with id "+e);var r=function(o,s){o.id!==e||t&&!o.activity||(i._logger.debug("Got entity window with id "+e),n(o),i._windows.unsubscribe(r))};i._windows.subscribe(r)})).catch((function(t){r(t)}))})),n)},t.prototype.createStackedWindows=function(t,e,n,i){var r=this;return Ze(new Promise((function(i,o){Le(t)&&o("activity is undefined"),Le(e)&&o("relativeWindowTypes is undefined"),Array.isArray(e)||o("relativeWindowTypes has to be an array"),Le(n)&&(n=2e4);var s=[];e.forEach((function(t){var e,i;if((e=Oe(t)?{type:t,name:"",isIndependent:!1,arguments:{}}:t).stackedWindow=!0,e.timeout=n,!Le(e.relativeTo))if(Le((i=e.relativeTo).type)){if(!Le(i.windowId)){var o=r.getWindows({id:i.windowId});!Le(o)&&o.length>0&&(e.relativeTo=o[0].type.name)}}else e.relativeTo=i.type;s.push(e)}));var a=[];s.forEach((function(e){return a.push(r.createWindow(t,e))})),Promise.all(a).then(i).catch(o)})),i)},t.prototype.addWindowToActivity=function(t,e,n){var i=this._bridge.joinActivity(t.id,e.id).then((function(){return e}));return Ze(i,n),i},t.prototype.leaveWindowFromActivity=function(t,e,n){var i=this._bridge.leaveActivity(t.id,e.id).then((function(){return e}));return Ze(i,n),i},t.prototype.setActivityContext=function(t,e,n){var i=this;return Ze(new Promise((function(n,r){Le(t)&&r("activity can not be null"),i._bridge.updateActivityContext(t,e,!0).then((function(e){n(t)})).catch((function(t){r(t)}))})),n)},t.prototype.updateActivityContext=function(t,e,n){var i=this;return Ze(new Promise((function(n,r){Le(t)&&r("activity can not be null");var o=[];for(var s in e)e.hasOwnProperty(s)&&null===e[s]&&o.push(s);for(var a=0,c=o;a<c.length;a++){var u=c[a];delete e[u]}i._bridge.updateActivityContext(t,e,!1,o).then((function(e){n(t)})).catch((function(t){r(t)}))})),n)},t.prototype.subscribeActivityContextChanged=function(t){this._activities.subscribe((function(e,n){if(n.type===Ve.ActivityContextChange){var i=n;t(e,i.context,i.updated,i.removed)}}))},t.prototype.stopActivity=function(t,e){return Ze(this._bridge.stopActivity(t),e)},t.prototype.getWindows=function(t){return Ne(t)?this._windows.get():Ne(t.id)?this._windows.get().filter((function(e){if(!Ne(t.type)&&e.type.id!==t.type)return!1;if(!Ne(t.name)&&e.name!==t.name)return!1;if(!Ne(t.activityId)){if(Le(e.activity))return!1;if(e.activity.id!==t.activityId)return!1}return!0})):[this._windows.getByName(t.id)]},t.prototype.getWindowBounds=function(t){return this._bridge.getWindowBounds(t)},t.prototype.setWindowBounds=function(t,e,n){var i=this;return Ze(new Promise((function(n,r){i._bridge.setWindowBounds(t,e).then((function(){return n()})).catch((function(t){return r(t)}))})),n)},t.prototype.closeWindow=function(t){return this._bridge.closeWindow(t)},t.prototype.activateWindow=function(t,e){return this._bridge.activateWindow(t,e)},t.prototype.setWindowVisibility=function(t,e){return this._bridge.setWindowVisibility(t,e)},t.prototype.clone=function(t,e,n){var i=this;return Ze(new Promise((function(n,r){t||r("activity can not be null"),i._bridge.cloneActivity(t.id,e).then((function(t){i._activities.getOrWait(t).then((function(t){n(t)})).catch((function(t){return r(t)}))})).catch((function(t){return r(t)}))})),n)},t.prototype.attachActivities=function(t,e,n,i){var r=this;return n=n||{},Ze(new Promise((function(i,o){if(r._activities.getByName(t)){if(r._activities.getByName(e))return r._bridge.attachActivities(t,e,n).then((function(t){var e=t.to,n=t.descriptor,o=t.descriptors;r._activities.getOrWait(e).then((function(t){t._updateDescriptors(o);var e=t.attached.filter((function(t){return t.ownerId===n.ownerId}))[0];i(e)}))})).catch((function(t){o(t)}));o("can not find activity with id "+e)}else o("can not find activity with id "+t)})),i)},t.prototype.detachActivities=function(t,e,n){var i=this;return Ze(new Promise((function(n,r){return i._bridge.detachActivities(t,e).then((function(){i._activities.getOrWait(undefined).then((function(t){t._updateDescriptors(undefined),i._activities.getOrWait(undefined).then((function(t){n(t)}))})).catch((function(t){return r(t)}))})).catch((function(t){r(t)}))})),n)},t.prototype.subscribeActivitiesAttached=function(t){this._attachedCallbacks.push(t)},t.prototype.subscribeActivitiesDetached=function(t){this._detachedCallbacks.push(t)},t.prototype.subscribeActivityFrameColorChanged=function(t){this._frameColorChangesCallbacks.push(t)},t.prototype._grabEntity=function(t){t._manager=this},t.prototype._getInitialData=function(){var t=this;this._logger.debug("Request initial data..."),this._bridge.getActivityTypes().then((function(e){t._activityTypes.add(e),t._dataReadyMarker.signal("Got act types")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity types -"+e)})),this._bridge.getWindowTypes().then((function(e){t._windowTypes.add(e),t._dataReadyMarker.signal("Got window types")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting window types  "+e)})),this._bridge.getActivities().then((function(e){t._activities.add(e),t._dataReadyMarker.signal("Got activities")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity instances -"+e)})),this._bridge.getActivityWindows().then((function(e){t._windows.add(e),t._dataReadyMarker.signal("Got windows")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity windows -"+e)}))},t.prototype._subscribeForData=function(){var t=this;this._logger.debug("Subscribe for data..."),this._bridge.onActivityTypeStatusChange((function(e){t._activityTypes.process(e)})),this._bridge.onWindowTypeStatusChange((function(e){t._windowTypes.process(e)})),this._bridge.onActivityWindowChange((function(e){t._windows.process(e)})),this._bridge.onActivityStatusChange((function(e){t._activities.process(e)}))},t.prototype._handleActivitiesAttached=function(t){var e=this,n=t.to,i=t.descriptor,r=t.descriptors;this._activities.getOrWait(n).then((function(t){t._updateDescriptors(r);var n=t.attached.filter((function(t){return t.ownerId===i.ownerId}))[0];e._attachedCallbacks.forEach((function(e){try{e(t,n)}catch(t){return}}))}))},t.prototype._handleActivitiesDetached=function(t){var e=this,n=t.oldActivityId,i=t.newActivityId,r=t.descriptors,o=t.descriptor;this._activities.getOrWait(n).then((function(t){t._updateDescriptors(r),e._activities.getOrWait(i).then((function(n){e._detachedCallbacks.forEach((function(e){try{e(n,t,o)}catch(t){return}}))}))}))},t.prototype._handleActivityDescriptorsRefreshed=function(t){var e=t.id,n=t.descriptors,i=this._activities.getByName(e);i&&i._updateDescriptors(n)},t.prototype.refreshDescriptors=function(){var t=this;this._bridge.getAttachedDescriptors().then((function(e){e&&Object.keys(e).forEach((function(n){var i=n,r=e[n],o=t._activities.getByName(i);o&&o._updateDescriptors(r)})),t._descriptorsMarker.signal("Successfully got descriptors")})).catch((function(e){t._descriptorsMarker.error("failed to get descriptors - "+e)}))},t.prototype._handleWindowFrameColorChanged=function(t){if(t.activityId){var e=this._activities.getByName(t.activityId);e&&e.owner&&e.owner.underlyingWindow.id===t.id&&this._frameColorChangesCallbacks.forEach((function(n){try{n(e,t.frameColor)}catch(t){return}}))}},t}(),_n=function(){function t(t,e){this._m=t,this._my=e,this.activityTypes={get:this._getActivityTypesWrapper.bind(this),register:this._m.registerActivityType.bind(this._m),unregister:this._m.unregisterActivityType.bind(this._m),subscribe:this._m.subscribeActivityTypeEvents.bind(this._m),unsubscribe:void 0,initiate:this._m.initiate.bind(this._m)},this.windowTypes={get:this._getWindowTypesWrapper.bind(this),registerFactory:this._m.registerWindowFactory.bind(this._m),unregisterFactory:this._m.unregisterWindowFactory.bind(this._m),subscribe:this._m.subscribeWindowTypeEvents.bind(this._m),unsubscribe:void 0},this.windows={get:this._m.getWindows.bind(this._m),subscribe:this._m.subscribeWindowEvents.bind(this._m),announce:this._m.announceWindow.bind(this._m),unsubscribe:void 0,create:this._m.createWindow.bind(this._m)},this.instances={get:this._m.getActivities.bind(this._m),subscribe:this._m.subscribeActivityEvents.bind(this._m),unsubscribe:void 0}}return t.prototype.onAttached=function(t){this._m.subscribeActivitiesAttached(t)},t.prototype.onDetached=function(t){this._m.subscribeActivitiesDetached(t)},t.prototype.onActivityFrameColorChanged=function(t){this._m.subscribeActivityFrameColorChanged(t)},t.prototype._getActivityTypesWrapper=function(t){return Ne(t)?this._m.getActivityTypes():this._m.getActivityType(t)},t.prototype._getWindowTypesWrapper=function(t){return Ne(t)?this._m.getWindowTypes():this._m.getWindowType(t)},t}(),In=function(){function t(t,e){this._mgr=t,this._my=e,this.all=new _n(t,e)}return t.prototype.ready=function(t){var e=this;return Ze(new Promise((function(t,n){e._mgr.ready().then((function(){t(e)})).catch((function(t){n(t)}))})),t)},Object.defineProperty(t.prototype,"my",{get:function(){return this._my},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"aware",{get:function(){return void 0!==this._my.window},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inActivity",{get:function(){return this.aware&&void 0!==this._my.activity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"agm",{get:function(){if(this.aware)return this.inActivity?this._my.activity.agm:new ze(null)},enumerable:!0,configurable:!0}),t.prototype.getAvailableFrameColors=function(){return[]},t}(),Sn=function(){function t(e){var n,i=this;if(!e)throw new Error("config can not be null");if(Ne(e.logLevel)||($e.Level=e.logLevel),Le(e.logger)||($e.GlueLogger=e.logger),this._isUsingHCImplementation=2===e.gdMajorVersion,this._isUsingGW3Implementation=t.checkIsUsingGW3Implementation(e.connection),this._isUsingHCImplementation)throw new Error("GD2 not supported");if(!this._isUsingGW3Implementation)throw new Error("Unable to instantiate activity bridge implementation");if(!(n=new yn(e)))throw new Error("A bridge to native activity is needed to create activity lib.");ze.AGM=e.agm;var r=new bn(n,!e.disableAutoAnnounce,e.windows),o=new gn(r,e.windows);this._api=new In(r,o),this._readyPromise=r.ready().then((function(t){return i}))}return t.checkIsUsingGW3Implementation=function(t){return 3===t.protocolVersion},Object.defineProperty(t.prototype,"api",{get:function(){return this._api},set:function(t){this._api=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUsingHCImplementation",{get:function(){return this._isUsingHCImplementation},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUsingGW3Implementation",{get:function(){return this._isUsingGW3Implementation},enumerable:!0,configurable:!0}),t.prototype.ready=function(t){return Ze(this._readyPromise,t)},t}(),xn="T42.ACS.GetFunctionalEntitlement",kn="T42.ACS.CanI",Cn="T42.ACS.OnEvent";function An(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function i(n,i){var r=n instanceof Error?n:new Error(n);if(e)e(r);else{var o='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+r.stack;if(t)switch(t.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(t,e,r){var o=n[t];return o||(o=[],n[t]=o),o.push(e),r&&setTimeout((function(){r.forEach((function(r){var o;if(null===(o=n[t])||void 0===o?void 0:o.includes(e))try{Array.isArray(r)?e.apply(void 0,r):e.apply(void 0,[r])}catch(e){i(e,t)}}))}),0),function(){var i=n[t];i&&(0===(i=i.reduce((function(t,n,i){return n===e&&t.length===i||t.push(n),t}),[])).length?delete n[t]:n[t]=i)}},execute:function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var o=n[t];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var r=n.apply(void 0,e);s.push(r)}catch(e){s.push(void 0),i(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}An.default=An;var Tn=An;function Pn(t){return t?Object.keys(t).map((function(e){return t[e]})):[]}function Mn(t){var e;try{e=JSON.parse(JSON.stringify(t||{}))}catch(t){e={}}return e}var jn=function(){function t(t,e,n){var i=this;this._appManager=t,this._name=e,this._agm=n,this._registry=Tn(),t.onInstanceStarted((function(t){t.application&&t.application.name!==i._name||i._registry.execute("instanceStarted",t)})),t.onInstanceStopped((function(t){t.application&&t.application.name!==i._name||i._registry.execute("instanceStopped",t)})),t.onAppRemoved((function(t){t.name===i._name&&i._registry.execute("appRemoved",t)})),t.onAppChanged((function(t){t.name===i._name&&i._registry.execute("appChanged",t)})),t.onAppAvailable((function(t){t.name===i._name&&i._registry.execute("appAvailable",t)})),t.onAppUnavailable((function(t){t.name===i._name&&i._registry.execute("appUnavailable",t)}))}return Object.defineProperty(t.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._props.Title},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return this._props.Version},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"autoStart",{get:function(){return this._props.AutoStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isShell",{get:function(){return this._props.IsShell},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"caption",{get:function(){return this._props.Caption},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hidden",{get:function(){return this._props.IsHidden},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"container",{get:function(){return this._props.ApplicationName},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityType",{get:function(){return this._props.ActivityType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityWindowType",{get:function(){return this._props.ActivityWindowType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowSettings",{get:function(){return this._props.Arguments?Mn(this._props.Arguments):{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"allowMultiple",{get:function(){return this._props.AllowMultiple},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"available",{get:function(){return this._props.IsReady||!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"icon",{get:function(){return this._props.Icon},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"iconURL",{get:function(){return this._props.IconUrl},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sortOrder",{get:function(){return this._props.SortOrder},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"userProperties",{get:function(){return this._props.UserProperties?Mn(this._props.UserProperties):{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivity",{get:function(){return void 0!==this._props.ActivityType&&""!==this._props.ActivityType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"configuration",{get:function(){return{autoStart:this._props.AutoStart,caption:this._props.Caption,hidden:this._props.IsHidden,container:this._props.ApplicationName,activityType:this._props.ActivityType,allowMultiple:this._props.AllowMultiple}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return e.application.name===t._name}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"type",{get:function(){return this._props.Type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mode",{get:function(){if(!this._props)return"unknown";if(this._props.Mode&&"string"==typeof this._props.Mode)return this._props.Mode.toLowerCase();if(this.isActivity)return"unknown";if(this._props.Arguments&&this._props.Arguments.mode&&"string"==typeof this._props.Arguments.mode)return this._props.Arguments.mode.toLowerCase();var t=this._props.WindowStyleAttributes;if(t){var e='mode:"',n=(t=t.split(" ").join("")).indexOf(e);if(-1!==n){var i=n+e.length,r=t.indexOf('"',i),o=t.substr(i,r-i);if(o&&"string"==typeof o)return o.toLowerCase()}}return"flat"},enumerable:!0,configurable:!0}),t.prototype.updateFromProps=function(t){var e=this;this._props||(this._props={Name:t.Name}),Object.keys(t).forEach((function(n){e._props[n]=t[n]}))},t.prototype.start=function(t,e){var n=this,i=this._name;return new Promise((function(r,o){e=e||{},t=t||{};n._agm.invoke("T42.ACS.StartApplication",{Name:i,Context:t,Options:e},"best",{methodResponseTimeoutMs:1e4},(function(t){var e=t.returned&&t.returned.Instance_0?t.returned.Instance_0:t.returned;if(e&&e.Id)if("startOnly"===n._appManager.mode){var i=n._appManager.handleInstanceStarted(e);r(i)}else!function(t){var e,i=function(){var e,i=n._appManager.instances().filter((function(e){return e.id===t}));return(e=2===i.length?i[0].isActivityInstance?i[0]:i[1]:i[0])?e.agm?e:void 0:e},s=setTimeout((function(){e&&e(),o("timeout")}),1e4);e=n._appManager.onInstanceAgmServerReady((function(n){n.id===t&&(e&&(e(),e=void 0),clearTimeout(s),setTimeout((function(){r(i())}),1))}));var a=i();a&&(e&&(e(),e=void 0),clearTimeout(s),r(a))}(e.Id);else r(void 0)}),(function(t){o(t)}))}))},t.prototype.onInstanceStarted=function(t){this._registry.add("instanceStarted",t)},t.prototype.onInstanceStopped=function(t){this._registry.add("instanceStopped",t)},t.prototype.onAvailable=function(t){this._registry.add("appAvailable",t)},t.prototype.onUnavailable=function(t){this._registry.add("appUnavailable",t)},t.prototype.onChanged=function(t){this._registry.add("appChanged",t)},t.prototype.onRemoved=function(t){this._registry.add("appRemoved",t)},t}(),En=function(){function t(t,e,n,i,r,o,s){var a=this;this._id=t,this._appName=e,this._appManager=n,this._agm=i,this._activities=r,this._windows=o,this.onAgmReady=this._addToRegistry("agmReady"),this.onStopped=this._addToRegistry("stopped"),this._registry=Tn(),s||(this._unsubscribeInstanceStopped=this._appManager.onInstanceStopped((function(t){t.id===a._id&&a._registry.execute("stopped",t)})),this._unsubscribeInstanceAgmServerReady=this._appManager.onInstanceAgmServerReady((function(t){t.id===a._id&&a._registry.execute("agmReady",t)})))}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"application",{get:function(){return this._appManager.application(this._appName)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activity",{get:function(){var t=this;if(!this._activities)throw new Error("This method requires glue.activities library to be enabled.");return this._activities.all.instances.get().filter((function(e){return e.id===t._activityId}))[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivityOwner",{get:function(){return this._isActivityOwner},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityInstances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return"activity"!==e.application.type&&e.activityId&&e.activityId===t._activityId}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityOwnerInstance",{get:function(){if(this._activityId)return this.activityInstances.filter((function(t){var e;return null===(e=t)||void 0===e?void 0:e.isActivityOwner}))[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"window",{get:function(){var t=this;if(!this._windows)throw new Error("This method requires glue.windows library to be enabled.");var e=this._windows.list().filter((function(e){return e.id===t._id}))[0];return!e&&this.activity&&this.activityOwnerInstance&&(e=this.activityOwnerInstance.window),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){var t,e,n;return null!=(n=null!=(t=this._startUpContext)?t:null===(e=this.window)||void 0===e?void 0:e.context)?n:{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._title},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivityInstance",{get:function(){return this._isActivityInstance},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityId",{get:function(){return this._activityId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inActivity",{get:function(){return this._inActivity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSingleWindowApp",{get:function(){return!this._inActivity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"agm",{get:function(){return this._agmInstance},enumerable:!0,configurable:!0}),t.prototype.updateFromProps=function(t){this._startUpContext=t.Context,this._title=t.Title,this._isActivityInstance=!1,t.ActivityId&&""!==t.ActivityId&&(this._activityId=t.ActivityId,this._isActivityInstance=!0),this._isActivityOwner=t.IsActivityOwner,!this._activityId&&this._startUpContext&&this._startUpContext.activityId&&(this._activityId=this._startUpContext.activityId),this._inActivity=Boolean(this._activityId),this.updateAgmInstanceFromProps(t)},t.prototype.updateAgmInstanceFromProps=function(t){if(t.AgmServers)if(t.GD3){var e=t.AgmServers;e&&(this._agmInstance=e[0])}else{var n=t.AgmServers,i=Object.keys(n)[0];if(!i)return;var r=n[i];this._agmInstance={machine:r.machineName,user:r.userName,environment:r.environment,application:r.applicationName}}},t.prototype.stop=function(){var t=this;return new Promise((function(e,n){var i=t._appManager.onInstanceStopped((function(n){n.id===t._id&&(i(),e())}));t._agm.invoke("T42.ACS.StopApplication",{Name:t._appName,Id:t._id}).then((function(){"startOnly"===t._appManager.mode&&(t._appManager.handleInstanceStopped({Name:t._appName,Id:t.id,Context:void 0,Title:void 0,ActivityId:void 0,IsActivityOwner:void 0,AgmServers:void 0}),e())})).catch((function(t){return n(t)}))}))},t.prototype.activate=function(){return this._agm.invoke("T42.ACS.ActivateApplication",{Name:this._appName,Id:this._id})},t.prototype.done=function(){this._registry.clear(),this._unsubscribeInstanceAgmServerReady(),this._unsubscribeInstanceStopped()},t.prototype.getContext=function(){return Promise.resolve(this.context)},t.prototype._addToRegistry=function(t){var e=this;return function(n){e._registry.add(t,n)}},t}(),On=function(){function t(t,e,n,i,r,o){var s=this;this.mode=t,this._agm=e,this._activities=n,this._windows=i,this._logger=r,this._gdMajorVersion=o,this._apps={},this._instances=[],this._registry=Tn(),this.application=function(t){return s._apps[t]},this.applications=function(){return Object.keys(s._apps).map((function(t){return s._apps[t]}))},this.instances=function(){return s._instances},this.getMyInstance=function(){if(s._gdMajorVersion>=3){var t=window.glue42gd.appInstanceId;return s._instances.filter((function(e){return e.id===t}))[0]}},this.handleAppAdded=function(t){var e=s._getAppId(t);s._logger.trace("adding app "+e),s._apps[e]=new jn(s,e,s._agm);var n=s._updateAppFromProps(t);s._registry.execute("appAdded",n)},this.handleAppUpdated=function(t){var e=s._updateAppFromProps(t);s._registry.execute("appChanged",e)},this.handleAppRemoved=function(t){var e=s._getAppId(t);s._logger.trace("removing app "+e);var n=s.application(e);s._instances=s._instances.filter((function(t){return t.application.name!==n.name})),delete s._apps[e],s._registry.execute("appRemoved",n)},this.handleAppReady=function(t){var e=s._getAppId(t),n=s._getAppOrThrow(e);n.updateFromProps(t),n.available?s._registry.execute("appAvailable",n):s._registry.execute("appUnavailable",n)},this.handleInstanceStarted=function(t){s._logger.trace("started app "+t.Name+" "+t.Id);var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=new En(e,n,s,s._agm,s._activities,s._windows);return s._updateInstanceFromProps(i,t),s._instances.push(i),s._registry.execute("instanceStarted",i),i},this.handleInstanceStopped=function(t){s._logger.trace("failed to start app "+t.Name+" "+t.Id);var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=s._getInstanceOrThrow(e,n);s._instances=s._instances.filter((function(t){return!s._matchInstance(t,e,n)})),s._registry.execute("instanceStopped",i),i.done()},this.handleInstanceAgmServerReady=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=s._getInstanceOrThrow(e,n);i.updateAgmInstanceFromProps(t),s._registry.execute("instanceAgmServerReady",i)},this.handleInstanceStartFailed=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=new En(e,n,void 0,void 0,void 0,void 0,!0);s._updateInstanceFromProps(i,t),s._registry.execute("instanceStartFailed",i)},this.handleInstanceUpdated=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=s._getInstanceOrThrow(e,n);s._updateInstanceFromProps(i,t)},this.onInstanceStarted=function(t){return s._registry.add("instanceStarted",t,s._instances)},this.onInstanceStartFailed=function(t){return s._registry.add("instanceStartFailed",t)},this.onInstanceStopped=function(t){return s._registry.add("instanceStopped",t)},this.onInstanceUpdated=function(t){return s._registry.add("instanceChanged",t)},this.onInstanceAgmServerReady=function(t){return s._registry.add("instanceAgmServerReady",t)},this.onAppAdded=function(t){return s._registry.add("appAdded",t,Object.values(s._apps))},this.onAppRemoved=function(t){return s._registry.add("appRemoved",t)},this.onAppAvailable=function(t){return s._registry.add("appAvailable",t)},this.onAppUnavailable=function(t){return s._registry.add("appUnavailable",t)},this.onAppChanged=function(t){return s._registry.add("appChanged",t)}}return t.prototype._getAppOrThrow=function(t){var e=this.application(t);if(!e)throw Error("app with id "+t+" not found");return e},t.prototype._getAppId=function(t){return t.Name},t.prototype._matchInstance=function(t,e,n){return t.id===e&&t.application.name===n},t.prototype._getInstanceByIdAndName=function(t,e){var n=this;return this._instances.filter((function(i){return n._matchInstance(i,t,e)}))[0]},t.prototype._getInstanceOrThrow=function(t,e){var n=this._getInstanceByIdAndName(t,e);if(!n)throw Error("instance with id "+t+" not found");return n},t.prototype._getInstanceId=function(t){return t.Id},t.prototype._getInstanceAppName=function(t){return t.Name},t.prototype._updateAppFromProps=function(t){var e=this._getAppId(t);this._logger.trace("updating app with  + "+e+", "+t);var n=this._getAppOrThrow(e);return n.updateFromProps(t),n},t.prototype._updateInstanceFromProps=function(t,e){this._logger.trace("updating instance with "+this._getInstanceId(e)+" for app "+this._getInstanceAppName(e)),t.updateFromProps(e)},t}();function Rn(t,e,n){var i=function(t){return!!(t&&t.constructor&&t.call&&t.apply)};if(!i(e)&&!i(n))return t;i(e)?i(n)||(n=function(){}):e=function(){},t.then(e,n)}var Nn=function(t){var e=this;this._agm=t,this._registry=Tn(),this.handleBranchModified=function(t){e._registry.execute("branchChanged",t)},this.handleBranchesModified=function(t){e._registry.execute("branchesChanged",t)},this.getRegion=function(t,n){return Rn(e._agmInvoke("T42.ACS.GetConfigurationRegion",(function(t){return t.returned.Region})),t,n)},this.getBranches=function(t,n){return Rn(e._agmInvoke("T42.ACS.GetBranches",(function(t){var e=t.returned.Branches;return Object.keys(e).map((function(t){return e[t]}))})),t,n)},this.getCurrentBranch=function(t,n){return Rn(e._agmInvoke("T42.ACS.GetCurrentBranch",(function(t){return t.returned.Branch}),void 0),t,n)},this.setRegion=function(t,n,i){return Rn(e._agmInvoke("T42.ACS.SetConfigurationRegion",(function(t){return t.returned.ResultMessage}),{Region:t}),n,i)},this.setCurrentBranch=function(t,n,i){return Rn(e._agmInvoke("T42.ACS.SetCurrentBranch",(function(t){return t.returned.ResultMessage}),{Branch:t}),n,i)},this.currentUser=function(t,n){return Rn(e._agmInvoke("T42.ACS.GetUser"),t,n)},this.getFunctionalEntitlement=function(t,n,i){return Rn(e._agmInvoke(xn,(function(t){return t.returned.Entitlement}),{Function:t}),n,i)},this.getFunctionalEntitlementBranch=function(t,n,i,r){return Rn(e._agmInvoke(xn,(function(t){return t.returned.Entitlement}),{Function:t,Branch:n}),i,r)},this.canI=function(t,n,i){return Rn(e._agmInvoke(kn,(function(t){return t.returned.Result}),{Function:t}),n,i)},this.canIBranch=function(t,n,i,r){return Rn(e._agmInvoke(kn,(function(t){return t.returned.Result}),{Function:t,Branch:n}),i,r)},this.onBranchesChanged=function(t){e._registry.add("branchesChanged",t)},this.onBranchChanged=function(t){e._registry.add("branchChanged",t)},this.exit=function(t){return e._agmInvoke("T42.ACS.Shutdown",null,t)},this.restart=function(t){return e._agmInvoke("T42.ACS.Restart",null,t)},this._agmInvoke=function(t,n,i){return i=i||{},new Promise((function(r,o){e._agm.invoke(t,i).then((function(t){n||(n=function(t){return t.returned}),r(n(t))})).catch((function(t){return o(t)}))}))}};var Ln=function(t){if(!t)throw Error("config not set");if(!t.agm)throw Error("config.agm is missing");var e="startOnly",n="skipIcons",i=t.mode||e;if(i!==e&&i!==n&&"full"!==i)throw new Error("Invalid mode for appManager lib - "+i+" is not supported");var r,o=t.activities,s=t.agm,a=t.logger,c=t.windows,u=new On(i,s,o,c,a.subLogger("applications"),t.gdMajorVersion),d=new Nn(s);if(i===e)r=function(t,e){return new Promise((function(n,i){t.invoke("T42.ACS.GetApplications",{skipIcon:!0}).then((function(t){var i=t.returned;i||n();var r=i.applications;r||n(),Pn(r).map((function(t){return e.handleAppAdded(t)})),n()})).catch((function(t){return i("Error getting application snapshot: "+t.message)}))}))}(s,u);else{var p=function(t,e,n,i){var r;return{start:function(){var o,s,a=new Promise((function(t,e){o=t,s=e}));return t.subscribe(Cn,{arguments:{skipIcon:i},waitTimeoutMs:1e4}).then((function(t){(r=t).onData((function(t){var i=t.data;Pn(i.OnApplicationAdded).map((function(t){return e.handleAppAdded(t)})),Pn(i.OnApplicationChanged).map((function(t){return e.handleAppUpdated(t)})),Pn(i.OnApplicationRemoved).map((function(t){return e.handleAppRemoved(t)})),Pn(i.OnApplicationReady).map((function(t){return e.handleAppReady(t)})),Pn(i.OnApplicationStarted).map((function(t){return e.handleInstanceStarted(t)})),Pn(i.OnApplicationStartFailed).map((function(t){return e.handleInstanceStartFailed(t)})),Pn(i.OnApplicationStopped).map((function(t){return e.handleInstanceStopped(t)})),Pn(i.OnApplicationUpdated).map((function(t){return e.handleInstanceUpdated(t)})),Pn(i.OnApplicationAgmServerReady).map((function(t){return e.handleInstanceAgmServerReady(t)})),Pn(i.OnBranchChanged).map((function(t){return n.handleBranchModified(t)})),Pn(i.OnBranchesModified).map((function(t){return n.handleBranchesModified(t)})),o()})),r.onFailed((function(t){return s(t)}))})).catch((function(t){return s("Error subscribing for T42.ACS.OnEvent stream. Err: "+t)})),a},stop:function(){r&&r.close()}}}(s,u,d,i===n);r=p.start()}return{ready:function(){return r},applications:u.applications,application:u.application,onAppAdded:u.onAppAdded,onAppRemoved:u.onAppRemoved,onAppChanged:u.onAppChanged,onAppAvailable:u.onAppAvailable,onAppUnavailable:u.onAppUnavailable,instances:u.instances,get myInstance(){return u.getMyInstance()},onInstanceStarted:u.onInstanceStarted,onInstanceStopped:u.onInstanceStopped,onInstanceUpdated:u.onInstanceUpdated,onInstanceStartFailed:u.onInstanceStartFailed,getRegion:d.getRegion,getBranches:d.getBranches,getCurrentBranch:d.getCurrentBranch,getFunctionalEntitlement:d.getFunctionalEntitlement,getFunctionalEntitlementBranch:d.getFunctionalEntitlementBranch,setCurrentBranch:d.setCurrentBranch,setRegion:d.setRegion,currentUser:d.currentUser,canI:d.canI,canIBranch:d.canIBranch,onBranchesChanged:d.onBranchesChanged,exit:d.exit,restart:d.restart}},Wn=new(function(){function t(){this.waitForTimeoutInMilliseconds=6e4,this._windows={},this._pendingWindows={},this._pendingWindowsStates={},this._registry=Tn()}return t.prototype.init=function(t){this._logger=t},t.prototype.get=function(t){return this._windows[t]||this._pendingWindows[t]},t.prototype.getIfReady=function(t){return this._windows[t]},Object.defineProperty(t.prototype,"list",{get:function(){return this._windows},enumerable:!0,configurable:!0}),t.prototype.add=function(t){if(!!this._pendingWindows[t.API.id])this._logger.error("trying to add window with id "+t.API.id+" from windowStore, which already exists");else{var e="remote"===t.API.windowType;this._pendingWindows[t.API.id]=t,this._pendingWindowsStates[t.API.id]={ready:!1,urlChanged:e},this._registry.execute("on-added",t)}},t.prototype.remove=function(t){delete this._windows[t.API.id],delete this._pendingWindows[t.API.id],delete this._pendingWindowsStates[t.API.id],this._registry.execute("on-removed",t)},t.prototype.setReadyState=function(t){var e=this._pendingWindowsStates[t];void 0!==e&&(e.ready=!0,e.urlChanged&&this.markReadyToShow(t))},t.prototype.setUrlChangedState=function(t){var e=this._pendingWindowsStates[t];void 0!==e&&(e.urlChanged=!0,e.ready&&this.markReadyToShow(t))},t.prototype.waitFor=function(t){var e=this;return new Promise((function(n,i){var r,o=setTimeout((function(){r(),i("waitFor timed out.")}),e.waitForTimeoutInMilliseconds),s=e._windows[t];s?(clearTimeout(o),n(s)):r=e.onReadyWindow((function(e){e.API.id===t&&(clearTimeout(o),r(),n(e))}))}))},t.prototype.onReadyWindow=function(t){return this._registry.add("on-ready",t)},t.prototype.onAdded=function(t){return this._registry.add("on-added",t)},t.prototype.onRemoved=function(t){return this._registry.add("on-removed",t)},t.prototype.markReadyToShow=function(t){this._pendingWindows[t]&&(this._windows[t]=this._pendingWindows[t],delete this._pendingWindows[t],delete this._pendingWindowsStates[t]),this._registry.execute("on-ready",this._windows[t])},t}()),Dn=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"==typeof window)return-1;if(!window.glueDesktop)return-1;if(!window.glueDesktop.version)return-1;var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?-1:t},t.callbackifyPromise=function(t,e,n){var i=function(t){var e=t;if(t instanceof Error&&(e=t.message),"function"!=typeof n)return Promise.reject(e);n(e)};try{return t().then((function(t){return"function"==typeof e&&e(t),t})).catch((function(t){return i(t)}))}catch(t){return i(t)}},t.getMonitor=function(t,e){var n=this;return e.map((function(e){var i=e.left,r=e.top,o=e.workingAreaWidth,s=e.workingAreaHeight;return{monitor:e,totalOverlap:n.calculateTotalOverlap({left:i,top:r,width:o,height:s},t)}})).sort((function(t,e){return e.totalOverlap-t.totalOverlap}))[0].monitor},t.getDisplayCenterOfScreen=function(t,e){var n=Math.floor(Math.max(e.left,e.left+(e.workingAreaWidth-t.width)/2));return{top:Math.floor(Math.max(e.top,e.top+(e.workingAreaHeight-t.height)/2)),left:n}},t.calculateTotalOverlap=function(t,e){var n=t.left,i=t.top,r=n+t.width,o=i+t.height,s=e.left,a=e.top,c=s+e.width,u=a+e.height;return Math.max(0,Math.min(r,c)-Math.max(n,s))*Math.max(0,Math.min(o,u)-Math.max(i,a))},t}(),Fn=function(t,e,n,i,r,o,s){var a,c,u,d=null!=s?s:Tn(),p=i.subLogger("window "+t),h=e.name,f=e.mode,l=e.url,v=e.title,y=e.context||{},g=e.bounds,m=e.frameColor,_=e.focus,I=e.neighbours||{},S=e.groupId,x=e.isGroupHeaderVisible,k=e.isTabHeaderVisible,C=e.isTabSelected,A=e.settings,T=e.isVisible,P=null===(a=e.settings)||void 0===a?void 0:a.isSticky,M=e.isCollapsed,j=e.state,E=e.tabGroupId,O=e.isLocked,R=[],N=e.zoomFactor;function L(t,e,i){return new Promise((function(r,o){var s,a,c=tt(t,g),d=!1,p=function(){d||(d=!0,"function"==typeof e&&e(u),r(u),a&&(a(),a=void 0),s&&(clearTimeout(s),s=void 0))};c||(a=Y((function(e){e.id===u.id&&tt(t,e.bounds)&&p()}))),n.moveResize(u,t).then((function(){c?p():s=setTimeout((function(){p()}),1e3)})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))}function W(e,i,r){return new Promise((function(o,s){n.setVisible(u,e).then((function(){var n=void 0===e?!0===T:T===e;if(n)return"function"==typeof i&&i(u),o(u);var r=z((function(s){n=void 0===e?!0===s.isVisible:s.isVisible===e,s.id===t&&n&&("function"==typeof i&&i(u),r(),o(u))}))})).catch((function(t){"function"==typeof r&&r(t),s(t)}))}))}function D(t,e,i){return new Promise((function(r,o){n.updateContext(u,t).then((function(){"function"==typeof e&&e(u),r(u)})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))}function F(){return new Promise((function(t){var e=K((function(n){n.id===u.id&&(e(),t())}))}))}function B(t){return d.add("onUrlChanged",t)}function G(t){return M&&t(u),d.add("collapsed",t)}function q(t){return M||t(u),d.add("expanded",t)}function H(t){return"maximized"===j&&t(u),d.add("maximized",t)}function U(t){return"minimized"===j&&t(u),d.add("minimized",t)}function V(t){return"normal"===j&&t(u),d.add("normal",t)}function J(t){return d.add("detached",t)}function z(t){return d.add("visibility-changed",t)}function K(t){return d.add("lock-changed",t)}function Y(t){return d.add("bounds-changed",t)}function Z(t){return d.add("tab-header-visibility-changed",t)}function Q(t){var e=I[t];if(void 0!==e)return e.reduce((function(t,e){var n=Wn.get(e);return n&&t.push(n.API),t}),[])}function X(){if(y._APPLICATION_NAME)return y._APPLICATION_NAME;if(y&&y._t42&&y._t42.application)return y._t42.application;var t=$();return t?t.applicationName:void 0}function $(){if("undefined"!=typeof window&&window.glue42gd&&window.glue42gd.getWindowInfo){var e=window.glue42gd.getWindowInfo(t);return e||void 0}}function tt(t,e){var n=t.height,i=t.width;t.height<A.minHeight&&(n=A.minHeight),t.height>A.maxHeight&&(n=A.maxHeight),t.width<A.minWidth&&(i=A.minWidth),t.width>A.maxWidth&&(i=A.maxWidth);var r=!n||e.height===n,o=!i||e.width===i,s=!t.left||e.left===t.left,a=!t.top||e.top===t.top;return r&&o&&s&&a}var et={handleWindowClose:function(){void 0!==u.id&&(u.id=void 0,d.execute("onClose",u))},handleWindowChangeState:function(t){"collapsed"===t?M=!0:"expanded"===t?M=!1:j=t,d.execute(t,u)},handleTitleChanged:function(t){v=t,d.execute("onTitleChanged",t,u)},handleVisibilityChanged:function(t){t!==T&&(T=t,d.execute("visibility-changed",u))},handleUrlChanged:function(t){l=t,d.execute("onUrlChanged",t,u)},handleWindowSettingsChanged:function(t){A=t,d.execute("settings-changed",u)},handleContextUpdated:function(t){y=t,d.execute("context-updated",y,u)},handleFrameIsLockedChanged:function(t){O=t,d.execute("lock-changed",u)},handleBoundsChanged:function(t){g.top===t.top&&g.left===t.left&&g.width===t.width&&g.height===t.height||(g.top=t.top,g.left=t.left,g.width=t.width,g.height=t.height,d.execute("bounds-changed",u))},handleFocusChanged:function(t){_=t,d.execute("focus-changed",u)},handleFrameButtonAdded:function(t){var e=["buttonId","imageBase64","order","tooltip"].reduce((function(e,n){return e[n]=t[n],e}),{});-1===R.map((function(t){return t.buttonId})).indexOf(t.buttonId)&&R.push(e),d.execute("onFrameButtonAdded",e,u)},handleFrameButtonRemoved:function(t){var e;R=R.reduce((function(n,i){return i.buttonId===t?e=i:n.push(i),n}),[]),void 0!==e&&d.execute("onFrameButtonRemoved",e,u)},handleFrameButtonClicked:function(t){var e=R.filter((function(e){return e.buttonId===t.buttonId}));e.length>0&&d.execute("onFrameButtonClicked",e[0],u)},handleFrameColorChanged:function(t){m=t,d.execute("frame-color-changed",u)},handleFrameAttached:function(t,e){E=t,k=e,d.execute("frame-attached",u)},handleFrameSelectionChanged:function(e,n){var i;void 0!==e&&e===t?(C=!0,i=u):(C=!1,i=Wn.get(e)?Wn.get(e).API:void 0);var r=Wn.get(n)?Wn.get(n).API:void 0;if(C&&r)var o=r.onTabSelectionChanged((function(t,e){(e&&e.id)===r.id&&(o(),d.execute("tab-selection-changed",i,r,u))}));else d.execute("tab-selection-changed",i,r,u)},handleCompositionChanged:function(t,e){I=t||{},S=e},handleGroupHeaderVisibilityChanged:function(t){x=t},handleTabHeaderVisibilityChanged:function(t){k!==t&&(k=t,d.execute("tab-header-visibility-changed",u))},handleGroupChanged:function(e,n){p.trace("handle group changed to win: "+t+" with group id: "+e.id),c=e,S=e.id,d.execute("group-changed",u,e,n)},handleGroupAssociation:function(e){e&&p.trace("setting group to win: "+t+" with group id: "+e.id),c=e},handleAttached:function(t,e){E=t,k=e,d.execute("attached",u)},handleDetached:function(e){E=e;var n=d.add("frame-attached",(function(e){e.id===t&&(n(),d.execute("detached",u))}))},handleWindowAttached:function(t){d.execute("window-attached",t)},handleWindowDetached:function(t){d.execute("window-detached",t)},handleZoomFactorChanged:function(t){N=t,d.execute("zoom-factor-changed",u)},handleIsStickyChanged:function(t){P=t,d.execute("sticky-changed",t,u)}};return{API:u={get name(){return h},get application(){var t=r();return t?t.application(X()):void 0},get hostInstance(){return n.hostInstance},get agmInstance(){var t=this;if("undefined"!=typeof window&&window.glue42gd)return o.servers().find((function(e){return e.windowId===t.id}));var e=X();return e?{application:e}:void 0},get url(){return l},id:t,get title(){return v},get windowStyleAttributes(){return A},get settings(){return A},get tabGroupId(){return"tab"===f.toLowerCase()?E:void 0},get frameButtons(){return R},get mode(){return f},get state(){return j},get isCollapsed(){return M},get isVisible(){return T},get isLocked(){return O},get context(){return y},get bounds(){return g},get minHeight(){return A.minHeight},get maxHeight(){return A.maxHeight},get minWidth(){return A.minWidth},get maxWidth(){return A.maxWidth},get isFocused(){return _},get frameColor(){return m},get opened(){return void 0!==u.id},get group(){return c},get groupId(){return S},get isSticky(){return P},get topNeighbours(){return Q("top")},get leftNeighbours(){return Q("left")},get rightNeighbours(){return Q("right")},get bottomNeighbours(){return Q("bottom")},get isGroupHeaderVisible(){return x},get activityId(){if(y._t42)return y._t42.activityId;var t=$();return t?t.activityId:void 0},get activityWindowId(){if(y._t42)return y._t42.activityWindowId;var t=$();return t?t.activityWindowId:void 0},get windowType(){return e.windowType||"electron"},get zoomFactor(){return N},get screen(){if("undefined"!=typeof window&&window.glue42gd)return Dn.getMonitor(u.bounds,window.glue42gd.monitors)},maximize:function(e,i){return new Promise((function(r,o){n.maximize(u).then((function(){if("maximized"===j)return"function"==typeof e&&e(u),r(u);var n=H((function(i){i.id===t&&"maximized"===i.state&&("function"==typeof e&&e(u),n(),r(u))}))})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},restore:function(e,i){return new Promise((function(r,o){n.restore(u).then((function(){if("normal"===j)return"function"==typeof e&&e(u),r(u);var n=V((function(i){t===i.id&&"normal"===i.state&&("function"==typeof e&&e(u),n(),r(u))}))})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},minimize:function(e,i){return new Promise((function(r,o){n.minimize(u).then((function(){if("minimized"===j)return"function"==typeof e&&e(u),r(u);var n=U((function(i){if(t===i.id&&"minimized"===i.state)return"function"==typeof e&&e(u),n(),r(u)}))})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},maximizeRestore:function(t,e){return new Promise((function(i,r){var o="normal"===j?H:V;n.maximizeRestore(u).then((function(){var e=o((function(){"function"==typeof t&&t(u),e&&e(),i(u)}))})).catch((function(t){"function"==typeof e&&e(t),r(t)}))}))},collapse:function(e,i){return new Promise((function(r,o){if(M)return"function"==typeof e&&e(u),r(u);n.collapse(u).then((function(){if(M)return"function"==typeof e&&e(u),r(u);var n=G((function(i){i.id===t&&("function"==typeof e&&e(u),n(),r(u))}))})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},expand:function(e,i){return new Promise((function(r,o){if(!M)return"function"==typeof e&&e(u),r(u);n.expand(u).then((function(){if(!M)return"function"==typeof e&&e(u),r(u);var n=q((function(i){i.id===t&&("function"==typeof e&&e(u),n(),r(u))}))})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},toggleCollapse:function(e,i){return new Promise((function(r,o){var s=M?q:G;n.toggleCollapse(u).then((function(){s((function(n){n.id===t&&("function"==typeof e&&e(u),r(u))}))})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},focus:function(t,e){return new Promise((function(i,r){n.focus(u).then((function(){"function"==typeof t&&t(u),i(u)})).catch((function(t){"function"==typeof e&&e(t),r(t)}))}))},activate:function(t,e){return new Promise((function(i,r){n.activate(u).then((function(){"function"==typeof t&&t(u),i(u)})).catch((function(t){"function"==typeof e&&e(t),r(t)}))}))},moveResize:L,setTitle:function(t,e,i){return new Promise((function(r,o){n.setTitle(u,t).then((function(){"function"==typeof e&&e(u),r(u)})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},setStyle:function(t,e,i){if(!t||0===Object.keys(t).length||Object.keys(t).every((function(t){return!t})))return i(r="Invalid style arguments: "+JSON.stringify(t)),Promise.reject(new Error(r));if(t&&void 0!==t.focus){var r;if("boolean"!=typeof t.focus)return i(r="Focus must be boolean. Currently only focus true is supported ! "+JSON.stringify(t)),Promise.reject(new Error(r));!1===t.focus&&p.warn("Focus false is not supported ! ")}return t&&void 0!==t.hidden&&"boolean"!=typeof t.hidden?(i(r="Hidden must be boolean ! provided: "+JSON.stringify(t)),Promise.reject(new Error(r))):Dn.callbackifyPromise((function(){return n.setStyle(u,t)}),e,i)},setOnTop:function(t,e,i){if(this.onTop===t){var r="OnTop setting is already set to '"+t+"'";return i(r),Promise.reject(new Error(r))}return Dn.callbackifyPromise((function(){return n.setOnTop(u,t)}),e,i)},resetButtons:function(t,e,i){return Dn.callbackifyPromise((function(){return n.resetButtons(u,t)}),e,i)},setSizeConstraints:function(t,e,i){if(!t||Object.keys(t).every((function(t){return void 0===t}))){var r="Invalid Constraints: "+JSON.stringify(t);return i(r),Promise.reject(new Error(r))}return Dn.callbackifyPromise((function(){return n.setSizeConstraints(u,t)}),e,i)},navigate:function(e,i,r){return new Promise((function(o,s){n.navigate(u,e).then((function(){if(e===l)return"function"==typeof i&&i(u),o(u);var n=B((function(e,r){r.id===t&&e===r.url&&("function"==typeof i&&i(u),n(),o(u))}))})).catch((function(t){"function"==typeof r&&r(t),s(t)}))}))},addFrameButton:function(t,e,i){return new Promise((function(r,o){return void 0===t?"function"==typeof i?void i("No button info"):void o("No button info"):void 0===t.buttonId?"function"==typeof i?void i("No buttonId"):void o("No buttonId"):void 0===t.imageBase64?"function"==typeof i?void i("No imageBase64"):void o("No imageBase64"):void n.addFrameButton(u,t).then((function(){"function"==typeof e&&e(u),r(u)})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},removeFrameButton:function(t,e,i){return new Promise((function(r,o){if(void 0===t||""===t)return"function"==typeof i?void i("No buttonId"):void o("No buttonId");n.removeFrameButton(u,t).then((function(){"function"==typeof e&&e(u),r(u)})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},setVisible:W,show:function(){return W(!0)},hide:function(){return W(!1)},center:function(t){return L(Dn.getDisplayCenterOfScreen(u.bounds,t||u.screen))},close:function(t,e){return new Promise((function(i,r){n.close(u).then((function(){"function"==typeof t&&t(u),i(u)})).catch((function(t){"function"==typeof e&&e(t),r(t)}))}))},snap:function(t,e,i,r){var o,s;if(!t)return Promise.reject("Please specify a target window! calledWith: "+t);if("string"==typeof t){var a=Wn.get(t);if(!a)return Promise.reject(new Error("Invalid target parameter or no such window. Invoked with:  "+t));o=a.API.group}else o=t.group;return Promise.all([(s=o,new Promise((function(t,e){var n=s.onWindowAdded((function(e,i){u.id===i.id&&(n(),t())}))}))),n.snap(u,t,e)]).then((function(){return"function"==typeof i&&i(u),u})).catch((function(t){return"function"==typeof r&&r(t),t}))},showLoader:function(t){return new Promise((function(e,i){n.showLoader(u,t).then((function(){e(u)})).catch((function(t){i(t)}))}))},hideLoader:function(){return new Promise((function(t,e){n.hideLoader(u).then((function(){t(u)})).catch((function(t){e(t)}))}))},updateContext:D,lock:function(t,e){return u.isLocked?("function"==typeof t&&t(u),Promise.resolve(u)):new Promise((function(i,r){n.lock(u).then((function(){return F()})).then((function(){"function"==typeof t&&t(u),i(u)})).catch((function(t){"function"==typeof e&&e(t),r(t)}))}))},unlock:function(t,e){return u.isLocked?new Promise((function(i,r){n.unlock(u).then((function(){return F()})).then((function(){"function"==typeof t&&t(u),i(u)})).catch((function(t){"function"==typeof e&&e(t),r(t)}))})):("function"==typeof t&&t(u),Promise.resolve(u))},getIcon:function(t,e){return new Promise((function(i,r){n.getIcon(u).then((function(e){"function"==typeof t&&t(e),i(e)})).catch((function(t){"function"==typeof e&&e(t),r(t)}))}))},setIcon:function(t,e,i){return new Promise((function(r,o){n.setIcon(u,t).then((function(){"function"==typeof e&&e(u),r(u)})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},setFrameColor:function(t,e,i){return new Promise((function(r,o){n.setFrameColor(u,t).then((function(){"function"==typeof e&&e(u),r(u)})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},setTabTooltip:function(t){return w(this,void 0,void 0,(function(){return b(this,(function(e){if(!t)throw new Error(t+" is null or undefined");return[2,n.setTabTooltip(u,t)]}))}))},attachTab:function(t,e,i,r){return new Promise((function(o,s){var a,c=u.id,d="Invalid tab parameter - should be an object with property id or a string. Invoked for source window id:"+u.id;if(t){if("string"==typeof t)a=t;else{if(void 0===t.id)return void s(d);a=t.id}var p={sourceWindowId:a,targetWindowId:c};e&&(p.index=e);var h=Wn.get(p.sourceWindowId).API,f=h.onAttached((function(t){t.id===h.id&&("function"==typeof i&&i(u),f(),o(u))}));n.attachTab(u,p).catch((function(t){"function"==typeof r&&r(t),f(),s(t)}))}else s(d)}))},detachTab:function(e,i,r){return new Promise((function(o,s){var a={windowId:u.id},c=e||{};void 0!==c.relativeTo&&("string"==typeof c.relativeTo?a.relativeTo=c.relativeTo:void 0!==c.relativeTo.id&&(a.relativeTo=c.relativeTo.id),void 0!==c.relativeDirection&&(a.relativeDirection=c.relativeDirection),void 0!==c.width&&(a.width=c.width),void 0!==c.height&&(a.height=c.height)),void 0!==c.bounds&&(a.bounds=c.bounds),void 0!==c.hideTabHeader&&(a.hideTabHeader=c.hideTabHeader);var p=!1,h=!1,f=d.add("frame-attached",(function(e){var n=void 0===c.hideTabHeader||c.hideTabHeader!==e.isTabHeaderVisible;t===e.id&&n&&(p=!0,f(),h&&("function"==typeof i&&i(u),o(u),"function"==typeof l&&l()))})),l=J((function(e){t===e.id&&(h=!0,l(),p&&("function"==typeof i&&i(u),o(u),"function"==typeof f&&f()))}));n.detachTab(u,a).catch((function(t){"function"==typeof r&&r(t),l(),f(),s(t)}))}))},setTabHeaderVisible:function(e,i,r){return new Promise((function(o,s){n.setTabHeaderVisible(u,e).then((function(){if(k===e)return"function"==typeof i&&i(u),o(u);var n=Z((function(r){r.id===t&&r.isTabHeaderVisible===e&&("function"==typeof i&&i(u),n(),o(u))}))})).catch((function(t){"function"==typeof r&&r(t),s(t)}))}))},showPopup:function(t){return n.showPopup(u,t)},createFlydown:function(t){return n.createFlydown(u.id,t)},setModalState:function(t){return n.setModalState(u.id,t||!1)},setZoomFactor:function(t,e,i){return Dn.callbackifyPromise((function(){if(isNaN(t))throw new Error("zoomFactor is not a number");return n.setZoomFactor(u,t)}),e,i)},zoomIn:function(t,e){return Dn.callbackifyPromise((function(){return n.zoomIn(u)}),t,e)},zoomOut:function(t,e){return Dn.callbackifyPromise((function(){return n.zoomOut(u)}),t,e)},showDevTools:function(){return n.showDevTools(u)},capture:function(t){return n.capture(u,t)},flash:function(t,e){var i={shouldFlash:!0,mode:"auto"};return"boolean"==typeof t&&(i.shouldFlash=t),void 0!==e&&(i.mode=e),n.flash(u,i)},setSticky:function(t,e,i){return new Promise((function(r,o){n.setSticky(u,t).then((function(){"function"==typeof e&&e(u),r(u)})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},print:function(t){return n.print(u,t)},printToPDF:function(t){return n.printToPDF(u,t)},onClose:function(t){return d.add("onClose",t)},onUrlChanged:B,onTitleChanged:function(t){return t(u.title,u),d.add("onTitleChanged",t)},onFrameButtonAdded:function(t){return d.add("onFrameButtonAdded",t)},onFrameButtonRemoved:function(t){return d.add("onFrameButtonRemoved",t)},onFrameButtonClicked:function(t){return d.add("onFrameButtonClicked",t)},onCollapsed:G,onExpanded:q,onMinimized:U,onMaximized:H,onNormal:V,onAttached:function(t){return d.add("attached",t)},onDetached:J,onVisibilityChanged:z,onContextUpdated:function(t){return d.add("context-updated",t)},onLockingChanged:K,onBoundsChanged:Y,onFrameColorChanged:function(t){return d.add("frame-color-changed",t)},onFocusChanged:function(t){return d.add("focus-changed",t)},onStickyChanged:function(t){return d.add("sticky-changed",t)},onGroupChanged:function(t){return d.add("group-changed",t)},onWindowAttached:function(t){return d.add("window-attached",t)},onWindowDetached:function(t){return d.add("window-detached",t)},onTabSelectionChanged:function(t){return d.add("tab-selection-changed",t)},onTabHeaderVisibilityChanged:Z,onClosing:function(e){if(!We(e))throw new Error("callback should be a function");return n.onClosing((function(t,n){var i=e();i&&i.then?i.then(t).catch(n):t()}),t)},onRefreshing:function(e){if(!We(e))throw new Error("callback should be a function");return n.onRefreshing((function(t,n,i){var r=e(i);r&&r.then?r.then(t).catch(n):t()}),t)},onZoomFactorChanged:function(t){if(!We(t))throw new Error("callback should be a function");return d.add("zoom-factor-changed",t)},get tabs(){return t=Wn.list,"tab"!==f.toLowerCase()?[]:Object.keys(t).reduce((function(e,n){var i=t[n];return i&&i.API.tabGroupId&&void 0!==i.API.tabGroupId&&void 0!==u.tabGroupId&&i.API.tabGroupId===u.tabGroupId&&e.push(i.API),e}),[]);var t},get isTabHeaderVisible(){return k},get isTabSelected(){return C},getURL:function(){return Promise.resolve(l)},getTitle:function(){return Promise.resolve(v)},getBounds:function(){return Promise.resolve(g)},getContext:function(){return Promise.resolve(y)},setContext:function(t){return D(t)},resizeTo:function(t,e){return L({width:t,height:e})},moveTo:function(t,e){return L({top:t,left:e})},getParentWindow:function(){var t;return w(this,void 0,void 0,(function(){var e;return b(this,(function(n){return(e=A.parentInstanceId)?[2,null===(t=Wn.list[e])||void 0===t?void 0:t.API]:[2,void 0]}))}))},getChildWindows:function(){return w(this,void 0,void 0,(function(){return b(this,(function(e){return[2,Object.keys(Wn.list).map((function(t){return Wn.list[t].API})).filter((function(e){return e.settings.parentInstanceId===t}))]}))}))}},Events:et,Registry:d}},Bn=new(function(){function t(){this._registry=Tn()}return Object.defineProperty(t.prototype,"hostInstance",{get:function(){return this.agmTarget},enumerable:!0,configurable:!0}),t.prototype.init=function(t,e){this.agm=t,this.agmTarget=e},t.prototype.close=function(t){var e=this;return new Promise((function(n,i){e.execute("close",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.navigate=function(t,e){var n=this;return new Promise((function(i,r){n.execute("navigate",{windowId:t.id,options:{url:e}}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.setStyle=function(t,e){var n;return w(this,void 0,void 0,(function(){var i,r,o,s,a,c,u,d,p,h,f,l,v;return b(this,(function(y){switch(y.label){case 0:return i=[],r=function(t){return i.push(t)},void 0===e.focus||t.isFocused||r(t.focus()),void 0!==e.hidden&&(o=!e.hidden,r(t.setVisible(o))),void 0!==e.onTop&&r(t.setOnTop(e.onTop)),void 0===e.tabTooltip&&void 0===e.tabToolTip||(n=e.tabTooltip,s=null!=n?n:e.tabToolTip,r(t.setTabTooltip(s))),a=e.maxWidth,c=e.maxHeight,u=e.minWidth,d=e.minHeight,p=e.allowClose,h=e.allowCollapse,f=e.allowLockUnlock,l=e.allowMaximize,v=e.allowMinimize,r(t.setSizeConstraints({maxWidth:a,maxHeight:c,minWidth:u,minHeight:d})),r(t.resetButtons({allowClose:p,allowCollapse:h,allowLockUnlock:f,allowMaximize:l,allowMinimize:v})),[4,Promise.all(i)];case 1:return y.sent(),[2,t]}}))}))},t.prototype.setSizeConstraints=function(t,e){var n=this;return new Promise((function(i,r){n.execute("setSizeConstraints",{windowId:t.id,options:e}).then((function(){i(t)})).catch(r)}))},t.prototype.setTabTooltip=function(t,e){return w(this,void 0,void 0,(function(){return b(this,(function(n){switch(n.label){case 0:return[4,this.execute("setTabTooltip",{windowId:t.id,options:{tabToolTip:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.resetButtons=function(t,e){var n=this;return new Promise((function(i,r){n.execute("resetButtons",{windowId:t.id,options:e}).then((function(){i(t)})).catch(r)}))},t.prototype.setOnTop=function(t,e){var n=this;return new Promise((function(i,r){n.execute("setOnTop",{windowId:t.id,options:{onTop:e}}).then((function(){i(t)})).catch(r)}))},t.prototype.setTitle=function(t,e){var n=this;return new Promise((function(i,r){var o={windowId:t.id,options:{title:e}};n.execute("setTitle",o).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.setSticky=function(t,e){var n=this;return new Promise((function(i,r){var o={windowId:t.id,options:{isSticky:e}};n.execute("setSticky",o).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.moveResize=function(t,e){var n=this;return new Promise((function(i,r){n.execute("moveResize",{windowId:t.id,options:{bounds:e}}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.addFrameButton=function(t,e){var n=this;return new Promise((function(i,r){n.execute("addButton",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.removeFrameButton=function(t,e){var n=this;return new Promise((function(i,r){n.execute("removeButton",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.activate=function(t){var e=this;return new Promise((function(n,i){e.execute("activate",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.focus=function(t){var e=this;return new Promise((function(n,i){e.execute("focus",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.maximizeRestore=function(t){var e=this;return new Promise((function(n,i){e.execute("maximizeRestore",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.maximize=function(t){var e=this;return new Promise((function(n,i){e.execute("maximize",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.restore=function(t){var e=this;return new Promise((function(n,i){e.execute("restore",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.minimize=function(t){var e=this;return new Promise((function(n,i){e.execute("minimize",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.collapse=function(t){var e=this;return new Promise((function(n,i){e.execute("collapse",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.expand=function(t){var e=this;return new Promise((function(n,i){e.execute("expand",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.toggleCollapse=function(t){var e=this;return new Promise((function(n,i){e.execute("toggleCollapse",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.snap=function(t,e,n){var i=this;return new Promise((function(r,o){t.id;var s,a="Invalid target parameter - should be an object with property id or a string. Invoked for source window id:"+t.id;if(e){if("string"==typeof e)s=e;else{if(void 0===e.id)return void o(a);s=e.id}var c={targetWindowId:s};n&&(c.snappingEdge=n),i.execute("snap",{windowId:t.id,options:c}).then((function(){r(t)})).catch((function(t){o(t)}))}else o(a)}))},t.prototype.attachTab=function(t,e){var n=this;return new Promise((function(i,r){n.execute("attachTab",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.detachTab=function(t,e){var n=this;return new Promise((function(i,r){n.execute("detachTab",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.setVisible=function(t,e){var n=this;return void 0===e&&(e=!0),new Promise((function(i,r){var o;o=e?"show":"hide",n.execute(o,{windowId:t.id}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.showLoader=function(t,e){var n=this;return new Promise((function(i,r){n.execute("showLoadingAnimation",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.hideLoader=function(t){var e=this;return new Promise((function(n,i){e.execute("hideLoadingAnimation",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.updateContext=function(t,e){var n=this;return new Promise((function(i,r){n.execute("updateContext",{windowId:t.id,context:e,replace:!(Object.keys(t.context).length>0)}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.lock=function(t){var e=this;return new Promise((function(n,i){e.execute("lockUnlock",{windowId:t.id,options:{lock:!0}}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.unlock=function(t){var e=this;return new Promise((function(n,i){e.execute("lockUnlock",{windowId:t.id,options:{lock:!1}}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.getIcon=function(t){var e=this;return new Promise((function(n,i){e.execute("getIcon",{windowId:t.id,options:{}}).then((function(t){n(t.icon)})).catch((function(t){i(t)}))}))},t.prototype.setIcon=function(t,e){var n=this;return new Promise((function(i,r){n.execute("setIcon",{windowId:t.id,options:{dataURL:e}}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.setFrameColor=function(t,e){var n=this;return new Promise((function(i,r){n.execute("setFrameColor",{windowId:t.id,options:{frameColor:e}}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.setTabHeaderVisible=function(t,e){var n=this;return new Promise((function(i,r){n.execute("setTabHeaderVisible",{windowId:t.id,options:{toShow:e}}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.showPopup=function(t,e){return w(this,void 0,void 0,(function(){var n,i;return b(this,(function(r){switch(r.label){case 0:return e?((n=m({},e)).targetLocation||(n.targetLocation="bottom"),i=m(m({},n),{popupBounds:n.size,targetId:t.id,popupId:n.windowId}),[4,this.execute("showPopupWindow",{windowId:t.id,options:i})]):[2,Promise.reject("The options object is not valid!")];case 1:return r.sent(),[2,t]}}))}))},t.prototype.createFlydown=function(t,e){return w(this,void 0,void 0,(function(){var n,i,r=this;return b(this,(function(o){return e?((n=m({},e)).horizontalOffset||(n.horizontalOffset=0),n.verticalOffset||(n.verticalOffset=0),i=this.reformatFlydownOptions(t,n),[2,this.execute("setFlydownArea",{windowId:t,options:i}).then((function(){var t=i.zones.map((function(t){return t.id}));return i.zones.forEach((function(t){var n="function"==typeof t.flydownSize?t.flydownSize:function(){return t.flydownSize};e.size instanceof Function&&t.flydownSize&&(n=function(n,i){return w(r,void 0,void 0,(function(){var r;return b(this,(function(o){switch(o.label){case 0:return e.size instanceof Function?[4,e.size(n,i)]:[3,2];case 1:r=o.sent(),o.label=2;case 2:return t.flydownSize instanceof Function&&t.flydownSize!==e.size?[4,t.flydownSize(n,i)]:[3,4];case 3:return[2,o.sent()||r];case 4:return[2,r||t.flydownSize]}}))}))}),r._registry.clearKey(i.targetId+"_"+t.id),r._registry.add(i.targetId+"_"+t.id,n)})),{destroy:function(){return r.clearFlydownArea(i.targetId,t)},options:n}}))]):[2,Promise.reject("The options object is not valid!")]}))}))},t.prototype.setModalState=function(t,e){return w(this,void 0,void 0,(function(){return b(this,(function(n){return[2,this.execute("setModalState",{windowId:t,options:{isModal:e}})]}))}))},t.prototype.handleFlydownBoundsRequested=function(t,e){return w(this,void 0,void 0,(function(){var n,i,r,o,s;return b(this,(function(a){switch(a.label){case 0:return n=function(){return e.cancel=!0},i={zoneId:e.flydownId,flydownWindowBounds:e.flydownWindowBounds,flydownWindowId:e.flydownWindowId},[4,Promise.all(this._registry.execute(t+"_"+e.flydownId,i,n))];case 1:return 1===(r=a.sent()).length?(o={height:0,width:0,top:0,left:0},s="object"!=typeof r[0]||Array.isArray(r[0])?o:r[0],[2,m(m({},e),{flydownWindowBounds:s})]):[2]}}))}))},t.prototype.zoomIn=function(t){return w(this,void 0,void 0,(function(){return b(this,(function(e){switch(e.label){case 0:return[4,this.execute("zoomIn",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.zoomOut=function(t){return w(this,void 0,void 0,(function(){return b(this,(function(e){switch(e.label){case 0:return[4,this.execute("zoomOut",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.setZoomFactor=function(t,e){return w(this,void 0,void 0,(function(){return b(this,(function(n){switch(n.label){case 0:return[4,this.execute("setZoomFactor",{windowId:t.id,options:{zoomFactor:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.showDevTools=function(t){return w(this,void 0,void 0,(function(){return b(this,(function(e){switch(e.label){case 0:return[4,this.execute("showDevTools",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.capture=function(t,e){return w(this,void 0,void 0,(function(){return b(this,(function(n){switch(n.label){case 0:return[4,this.execute("captureScreenshot",{windowId:t.id,options:m({},e)})];case 1:return[2,n.sent().data]}}))}))},t.prototype.captureGroup=function(t,e){return w(this,void 0,void 0,(function(){return b(this,(function(n){switch(n.label){case 0:return[4,this.execute("captureGroupScreenshot",{windowId:t[0],options:m({groupWindowIds:t},e)})];case 1:return[2,n.sent().data]}}))}))},t.prototype.flash=function(t,e){return w(this,void 0,void 0,(function(){return b(this,(function(n){switch(n.label){case 0:return[4,this.execute("flash",{windowId:t.id,options:m({},e)})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.configure=function(t,e){return w(this,void 0,void 0,(function(){return b(this,(function(n){return[2,this.execute("configure",{windowId:t,options:m({},e)})]}))}))},t.prototype.print=function(t,e){return w(this,void 0,void 0,(function(){return b(this,(function(n){switch(n.label){case 0:return[4,this.execute("print",{windowId:t.id,options:m({},e)})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.printToPDF=function(t,e){return w(this,void 0,void 0,(function(){return b(this,(function(n){switch(n.label){case 0:return[4,this.execute("printToPDF",{windowId:t.id,options:m({},e)})];case 1:return[2,n.sent().filePath]}}))}))},t.prototype.execute=function(t,e){var n=this;return new Promise((function(i,r){var o=m(m({},e),{command:t});n.agm.invoke("T42.Wnd.Execute",o,n.agmTarget).then((function(t){t.returned&&t.returned.errorMsg?r(t):i(t.returned)})).catch((function(t){r(t)}))}))},t.prototype.setGroupHeaderVisible=function(t,e){return this.execute("setGroupHeaderVisibility",{windowId:t,options:{toShow:e}})},t.prototype.getGroupTitle=function(t){return this.execute("getGroupTitle",{windowId:t,options:{}}).then((function(t){return t.title}))},t.prototype.setGroupTitle=function(t,e){return this.execute("setGroupTitle",{windowId:t,options:{title:e}})},t.prototype.onClosing=function(t,e){var n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addCloseHandler(t,e)},t.prototype.onRefreshing=function(t,e){var n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addRefreshHandler(t,e)},t.prototype.reformatFlydownOptions=function(t,e){var n=function(t,n){if(e[n]&&(void 0===t[n]||null===t[n])){var i=e[n];t[n]=i}},i=e.zones.map((function(t){return n(t,"windowId"),n(t,"targetLocation"),!e.size||void 0!==t.flydownSize&&null!==t.flydownSize||(t.flydownSize=e.size),t.flydownBounds=t.flydownSize,t.flydownId=t.windowId,t.targetLocation||(t.targetLocation="bottom"),t}));return m(m({},e),{zones:i,targetId:t,flydownBounds:e.size,flydownActiveArea:e.activeArea})},t.prototype.clearFlydownArea=function(t,e){var n=this;return this.execute("clearFlydownWindowArea",{windowId:t,options:{}}).then((function(){e.forEach((function(e){n._registry.clearKey(t+"_"+e)}))}))},t}());function Gn(t,e){var n=Wn.list;return Object.keys(n).reduce((function(i,r){var o=n[r];return o.API.tabGroupId===e&&o.API.id!==t&&(i[r]=o),i}),{})}var qn=function(){function t(t,e,n,i,r){this._registry=Tn(),this._waitTimeout=1e4,this._agm=t,this._logger=e.subLogger("gd-env"),this._agmInstance=this.normalizeInstance(i),this._windowId=r,this._appManagerGetter=n}return t.prototype.init=function(){var t=this;return new Promise((function(e,n){void 0===t._agmInstance&&(t._agmInstance="best"),t._agm.registerAsync("T42.Wnd.OnEventWithResponse",(function(e,n,i,r){t.respondToEvent(e).then(i).catch(r)}));new Promise((function(i,r){t._agm.subscribe("T42.Wnd.OnEvent",{waitTimeoutMs:t._waitTimeout,target:t._agmInstance,onData:function(n){t.updateWindow(n.data,e)},onConnected:function(e){t._agmInstance=t.normalizeInstance(e),Bn.init(t._agm,t._agmInstance)}}).catch((function(t){n("Can not subscribe for stream T42.Wnd.OnEvent. Err: "+t)}))}))}))},Object.defineProperty(t.prototype,"executor",{get:function(){return Bn},enumerable:!0,configurable:!0}),t.prototype.open=function(t,e,n,i,r){var o=m({},n=n||{});void 0!==t?(void 0!==o.relativeTo&&"string"!=typeof o.relativeTo&&(o.relativeTo=o.relativeTo.id||""),o.name=t,o.url=e,o.windowState=n.windowState||n.state,delete o.state,this._agm.invoke("T42.Wnd.Create",o,this._agmInstance).then((function(t){if(void 0!==t.returned){var e=t.returned.id;i(e)}else r({message:"failed to execute T42.Wnd.Create - unknown reason"})})).catch(r)):r({message:"The name is undefined"})},t.prototype.createFlydown=function(t,e){return this.executor.createFlydown(t,e)},t.prototype.showPopup=function(t,e){return w(this,void 0,void 0,(function(){var n;return b(this,(function(i){switch(i.label){case 0:return n=Wn.get(t),[4,this.executor.showPopup(n.API,e)];case 1:return i.sent(),[2]}}))}))},t.prototype.tabAttached=function(t){return this._registry.add("tab-attached",t)},t.prototype.tabDetached=function(t){return this._registry.add("tab-detached",t)},t.prototype.onWindowFrameColorChanged=function(t){return this._registry.add("frame-color-changed",t)},t.prototype.onEvent=function(t){return this._registry.add("window-event",t)},t.prototype.my=function(){return this._windowId},t.prototype.execute=function(t,e,n){return this._agm.invoke("T42.Wnd.Execute",{command:t,options:n,windowId:e})},t.prototype.setGroupHeaderVisible=function(t,e){return this._agm.invoke("T42.Wnd.SetGroupHeaderVisible",{windowId:t,toShow:e},this._agmInstance)},t.prototype.onCompositionChanged=function(t){return this._registry.add("composition-changed",t)},t.prototype.onGroupHeaderVisibilityChanged=function(t){return this._registry.add("group-header-changed",t)},t.prototype.onWindowGotFocus=function(t){return this._registry.add("got-focus",t)},t.prototype.onWindowLostFocus=function(t){return this._registry.add("lost-focus",t)},t.prototype.normalizeInstance=function(t){if(t)return{application:t.application,machine:t.machine,user:t.user}},t.prototype.respondToEvent=function(t){return"ShowFlydownBoundsRequested"===t.type?this.executor.handleFlydownBoundsRequested(t.data.windowId,t.data):Promise.reject("There isn't a handler for "+t.type)},t.prototype.updateWindow=function(t,e){var n=this,i=this.getExtendedStreamEvent(t);if("Snapshot"===t.type)return t.windows.forEach((function(t){var e=n.createWindow(t.id,t);Wn.markReadyToShow(e.API.id),n._registry.execute("window-event",i)})),void e(this);if("Created"===t.type){var r=t,o=this.createWindow(r.windowId,r.data||{});return Wn.setReadyState(o.API.id),void this._registry.execute("window-event",i)}var s=Wn.get(t.windowId);if(s){var a=s.API,c=s.Events;if("BoundsChanged"===t.type){var u=t;c.handleBoundsChanged(u.data)}if("UrlChanged"===t.type){var d=t;Wn.setUrlChangedState(d.windowId),c.handleUrlChanged(d.data)}if("TitleChanged"===t.type){var p=t;c.handleTitleChanged(p.data)}if("IsStickyChanged"===t.type){var h=t;c.handleIsStickyChanged(h.data)}if("VisibilityChanged"===t.type&&c.handleVisibilityChanged(t.data),"ContextChanged"===t.type&&c.handleContextUpdated(t.data),"StateChanged"===t.type&&c.handleWindowChangeState(t.data),"FrameColorChanged"===t.type&&(c.handleFrameColorChanged(t.data),this._registry.execute("frame-color-changed",a)),"CompositionChanged"===t.type){var f=t;c.handleCompositionChanged(f.data.neighbors,f.data.groupId),this._registry.execute("composition-changed",f.data)}if("GroupHeaderVisibilityChanged"===t.type){var l=t;c.handleGroupHeaderVisibilityChanged(l.data.groupHeaderVisible),this._registry.execute("group-header-changed",l.data)}if("FocusChanged"===t.type){var v=t;this.focusChanged(c,a,v.data)}if("WindowFrameChanged"===t.type&&(c.handleFrameAttached(t.data.frameId,t.data.isTabHeaderVisible),this._registry.execute("frame-changed")),"WindowFrameAdded"===t.type){c.handleAttached(t.data.frameId,t.data.isTabHeaderVisible);var y=Gn(a.id,t.data.frameId);Object.keys(y).forEach((function(t){y[t].Events.handleWindowAttached(a)})),this._registry.execute("tab-attached",a,t.data.frameId,t.data.isTabHeaderVisible)}if("WindowFrameRemoved"===t.type){var g=a.tabGroupId;c.handleDetached(t.data.frameId);var m=Gn(a.id,g);Object.keys(m).forEach((function(t){m[t].Events.handleWindowDetached(a)}));var w=this._registry.add("frame-changed",(function(){w(),n._registry.execute("tab-detached",a,t.data.frameId,a.tabGroupId)}))}"TabHeaderVisibilityChanged"===t.type&&c.handleTabHeaderVisibilityChanged(t.data.isTabHeaderVisible),"FrameSelectionChanged"===t.type&&c.handleFrameSelectionChanged(t.data.newWindowId,t.data.prevWindowId),"ButtonClicked"===t.type&&c.handleFrameButtonClicked(t.data),"ButtonAdded"===t.type&&c.handleFrameButtonAdded(t.data),"ButtonRemoved"===t.type&&c.handleFrameButtonRemoved(t.data),"WindowZoomFactorChanged"===t.type&&c.handleZoomFactorChanged(t.data),"Closed"===t.type&&(Wn.remove(s),c.handleWindowClose()),"FrameIsLockedChanged"===t.type&&c.handleFrameIsLockedChanged(t.data),this._registry.execute("window-event",i)}else this._logger.error("received update for unknown window. Stream:', "+JSON.stringify(t,null,4))},t.prototype.createWindow=function(t,e){var n,i=Wn.get(t),r=Fn(t,this.mapToWindowConstructorOptions(e),Bn,this._logger,this._appManagerGetter,this._agm,null===(n=i)||void 0===n?void 0:n.Registry);return Wn.add(r),r},t.prototype.focusChanged=function(t,e,n){t.handleFocusChanged(n),n?this._registry.execute("got-focus",e):this._registry.execute("lost-focus",e)},t.prototype.mapToWindowConstructorOptions=function(t){return{name:t.name,context:t.context,bounds:t.bounds,url:t.url,title:t.title,isVisible:t.isVisible,focus:t.isFocused,state:t.state,frameColor:t.frameColor,groupId:t.groupId,neighbours:t.neighbors,isFocused:t.isFocused,isGroupHeaderVisible:t.groupHeaderVisible,isCollapsed:t.isCollapsed,tabGroupId:t.frameId,mode:t.mode,isTabHeaderVisible:t.isTabHeaderVisible,isTabSelected:t.isActiveTab,settings:t.settings,windowType:t.windowType,zoomFactor:t.zoomFactor,isLocked:t.isLocked}},t.prototype.getExtendedStreamEvent=function(t){try{var e=m({state:t.type,windowName:Wn.get(t.windowId).API.name},t);return"WindowFrameAdded"===e.state&&(e.state="TabAttached"),"StateChanged"===e.state&&(e.state=e.data.charAt(0).toUpperCase()+e.data.slice(1)),"ButtonAdded"===e.state&&(e.state="FrameButtonAdded"),"ButtonRemoved"===e.state&&(e.state="FrameButtonRemoved"),e}catch(e){return t}},t}(),Hn=function(t,e){var n=Tn(),i=[];function r(){return new Promise((function(t,e){var n=c((function(e){n(),t()}))}))}function o(t,n,i,r){return new Promise((function(r,o){e.execute(t,n).then((function(t){"function"==typeof i&&i(u),r(u)})).catch((function(t){o(t)}))}))}function s(){var t=[];return i.forEach((function(e){var n=a(e);void 0!==n&&t.push(n)})),t}function a(t){return Wn.get(t)?Wn.get(t).API:void 0}function c(t){return n.add("header-visibility-changed",t)}var u={id:t,get windows(){return e=s(),"function"==typeof t&&t(e),e;var t,e},find:function(t,e){var n;n="string"==typeof t?t:t.id;var r=i.indexOf(n);if(-1!==r){var o=a(i[r]);return"function"==typeof e&&e(o),o}},get isHeaderVisible(){return void 0===s().find((function(t){return!t.isGroupHeaderVisible}))},showHeader:function(t,n){return new Promise((function(n,o){Promise.all([e.setGroupHeaderVisible(i[0],!0),r()]).then((function(){"function"==typeof t&&t(u),n(u)})).catch((function(t){o(t)}))}))},hideHeader:function(t,n){return new Promise((function(n,o){Promise.all([e.setGroupHeaderVisible(i[0],!1),r()]).then((function(){"function"==typeof t&&t(u),n(u)})).catch((function(t){}))}))},getTitle:function(){return e.getGroupTitle(i[0])},setTitle:function(t){return e.setGroupTitle(i[0],t)},capture:function(t){return e.captureGroup(i,t)},maximize:function(e,n){return o("maximize",{groupId:t},e)},restore:function(e,n){return o("restore",{groupId:t},e)},onHeaderVisibilityChanged:c,onWindowAdded:function(t){return n.add("window-added",t)},onWindowRemoved:function(t){return n.add("window-removed",t)}};return{groupAPI:u,groupInternal:{addWindow:function(t){if(-1===i.indexOf(t)){i.push(t);var e=Wn.get(t);e.Events.handleGroupAssociation(u),n.execute("window-added",u,e.API)}},removeWindow:function(t){var e=i.indexOf(t);if(-1!==e){i.splice(e,1);var r=a(t);n.execute("window-removed",u,r)}},handleGroupHeaderVisibilityChanged:function(t){n.execute("header-visibility-changed",u)}}}},Un=function(t,e){var n=e.subLogger("groups"),i=Tn(),r={},o=-1,s=Wn.list;function a(t,n){var i,o;if(void 0!==t)return i="string"==typeof t?t:t.id,Object.keys(r).forEach((function(t){var e=r[t].groupAPI;void 0===e.find(i)||(o=e)})),"function"==typeof n&&n(o),o;e.debug("trying to find a group by a window, but winId is undefined")}function c(t){n.trace("Adding new window "+t.API.id+" to win.API.groupId "+t.API.groupId);var e=u(t);e&&(n.trace("handleGroupAssociation "+t.API.id+" to group.groupAPI.id "+e.groupAPI.id),t.Events.handleGroupAssociation(e.groupAPI))}function u(e,i){var o=i||e.API.groupId,s=e.API.id;if(void 0!==o&&void 0!==s){var a=function(e){if(r.hasOwnProperty(e))return r[e];var n=Hn(e,t.executor);return r[e]=n,n}(o);return a.groupInternal.addWindow(s),a}n.debug("trying to add a window without group - winId: "+s)}function d(t,e){var n=t.API.id,i=e||t.API.groupId;void 0!==i&&(r[i].groupInternal.removeWindow(n),t.Events.handleGroupAssociation(void 0),function(t){r.hasOwnProperty(t)&&void 0!==r[t]&&0===r[t].groupAPI.windows.length&&delete r[t]}(i))}return Object.keys(s).forEach((function(t){c(s[t])})),t.onCompositionChanged((function(t){!function(t){var e=t.groupId,r=t.windowId,o=a(r),s=o?o.id:void 0;if(n.trace("handleCompositionChanged newGroupId: "+e+" windowId: "+r+" oldGroup: "+s),s===e)return void n.trace("handleCompositionChanged newGroupId: "+e+" windowId: "+r+" oldGroup: "+s+" are the same - returning...");var c=Wn.get(r)||Wn.get(r),p=u(c,e);o&&(d(c,s),i.execute("window-moved",r,o,e));c.Events.handleGroupChanged(p.groupAPI,o)}(t)})),t.onGroupHeaderVisibilityChanged((function(t){var e=a(t.windowId);if(void 0!==e){var n=r[e.id];-1===o&&(o=e.windows.length),0===--o&&(o=-1,n.groupInternal.handleGroupHeaderVisibilityChanged(t))}})),Wn.onAdded((function(t){c(t)})),Wn.onRemoved((function(t){d(t)})),{groupsAPI:{get my(){return a(t.my())},list:function(t){var e=Object.keys(r).map((function(t){if(r[t])return r[t].groupAPI}));return"function"==typeof t&&t(e),e},findGroupByWindow:a},groupsEvents:{onWindowMoved:function(t){return i.add("window-moved",t)}}}},Vn=function(t,e,n,i){var r,o,s=Tn(),a=e;Wn.init(a);var c=new Promise((function(e,s){(function(t,e,n,i){var r=e;return new Promise((function(e,o){if(2===i)throw r.trace("running in HC"),new Error("GD2 not supported");if(i>=3)r.trace("running in GD 3"),new qn(t,r,n,void 0,window.glue42gd.windowId).init().then(e).catch(o);else{var s=new qn(t,r,n).init();Promise.race([s,(a=1e4,new Promise((function(t,e){return setTimeout((function(){e("timeout waiting for streams")}),a)})))]).then(e).catch(o)}var a}))})(t,a,n,i).then((function(t){o=t,r=Un(t,a),e()})).catch((function(t){var e="Environment detector fails with: "+t;a.error(e),s(e)}))}));function u(){var t=Wn.getIfReady(o.my());return t?t.API:void 0}function d(t){return s.add("window-added",t)}function p(t){return s.add("window-removed",t)}return Wn.onReadyWindow((function(t){s.execute("window-added",t.API)})),Wn.onRemoved((function(t){s.execute("window-removed",t.API)})),{my:u,open:function(t,e,n,i,r){return new Promise((function(s,a){var c=function(t){"function"==typeof r&&r(t),a(t)};o.open(t,e,n,(function(t){Wn.waitFor(t).then((function(t){"function"==typeof i&&i(t.API),s(t.API),"electron"===t.API.windowType&&t.Events.handleUrlChanged(t.API.url)})).catch(c)}),c)}))},find:function(t,e,n){var i=Wn.list,r=Object.keys(i).reduce((function(e,n){var r=i[n];return r&&r.API.name===t&&e.push(r.API),e}),[]);if("function"!=typeof e)return r[0];r.length>0?e(r[0]):"function"==typeof n&&n("There is no window with name:"+t)},findById:function(t,e,n){var i=Wn.list,r=Object.keys(i).reduce((function(e,n){var r=i[n];return void 0!==r&&r.API.id===t&&e.push(r.API),e}),[]);if("function"!=typeof e)return r[0];r.length>0?e(r[0]):"function"==typeof n&&n("There is no window with such id:"+t)},list:function(t){var e=Wn.list,n=Object.keys(e).map((function(t){return e[t].API}));if("function"!=typeof t)return n;t(n)},ready:function(){return c},onWindowAdded:d,windowAdded:d,onWindowRemoved:p,windowRemoved:p,onTabAttached:function(t){return c.then((function(){o.tabAttached(t)}))},onTabDetached:function(t){return c.then((function(){o.tabDetached(t)}))},onWindowFrameColorChanged:function(t){return c.then((function(){return o.onWindowFrameColorChanged(t)}))},get groups(){return r.groupsAPI},onWindowGotFocus:function(t){var e;return c.then((function(){e=o.onWindowGotFocus(t)})),function(){e&&e()}},onWindowLostFocus:function(t){var e;return c.then((function(){e=o.onWindowLostFocus(t)})),function(){e&&e()}},onEvent:function(t){var e,n=!1;return c.then((function(){n||(e=o.onEvent(t))})),function(){n=!0,e&&e()}},createFlydown:function(t,e){return o.createFlydown(t,e)},showPopup:function(t,e){return o.showPopup(t,e)},configure:function(t){var e=u(),n=e?e.id:"";return Bn.configure(n,t)}}},Jn=new(function(){function t(){this.layouts=[]}return t.prototype.removeWhere=function(t){this.layouts=this.layouts.filter(t)},t.prototype.add=function(t){this.layouts.push(t)},Object.defineProperty(t.prototype,"all",{get:function(){return this.layouts},enumerable:!0,configurable:!0}),t.prototype.where=function(t){return this.layouts.filter(t)},t.prototype.first=function(t){return this.where(t)[0]},t}());var zn=1;var Kn,Yn,Zn,Qn={nextValue:function(){return(zn=(9301*zn+49297)%233280)/233280},seed:function(t){zn=t}},Xn="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function $n(){Zn=!1}function ti(t){if(t){if(t!==Kn){if(t.length!==Xn.length)throw new Error("Custom alphabet for shortid must be "+Xn.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+Xn.length+" unique characters. These characters were not unique: "+e.join(", "));Kn=t,$n()}}else Kn!==Xn&&(Kn=Xn,$n())}function ei(){return Zn||(Zn=function(){Kn||ti(Xn);for(var t,e=Kn.split(""),n=[],i=Qn.nextValue();e.length>0;)i=Qn.nextValue(),t=Math.floor(i*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var ni={characters:function(t){return ti(t),Kn},seed:function(t){Qn.seed(t),Yn!==t&&($n(),Yn=t)},lookup:function(t){return ei()[t]},shuffled:ei},ii="object"==typeof window&&(window.crypto||window.msCrypto);var ri=function(){if(!ii||!ii.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return ii.getRandomValues(t),48&t[0]};var oi=function(t,e){for(var n,i=0,r="";!n;)r+=t(e>>4*i&15|ri()),n=e<Math.pow(16,i+1),i++;return r};var si,ai,ci=function(t){var e=ni.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var ui=function(t){var e="",n=Math.floor(.001*(Date.now()-1459707606518));return n===ai?si++:(si=0,ai=n),e+=oi(ni.lookup,6),e+=oi(ni.lookup,t),si>0&&(e+=oi(ni.lookup,si)),e+=oi(ni.lookup,n)};var di=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=ni.characters(),n=t.length,i=0;i<n;i++)if(-1===e.indexOf(t[i]))return!1;return!0},pi=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e=0;function n(){return ui(e)}t.exports=n,t.exports.generate=n,t.exports.seed=function(e){return ni.seed(e),t.exports},t.exports.worker=function(n){return e=n,t.exports},t.exports.characters=function(t){return void 0!==t&&ni.characters(t),ni.shuffled()},t.exports.decode=ci,t.exports.isValid=di})),hi=(pi.generate,pi.seed,pi.worker,pi.characters,pi.decode,pi.isValid,pi),fi=function(){function t(t,e,n,i){this.config=t,this.activitiesGetter=e,this.callbacks=n,this.logger=i,this.interop=t.agm,this.registerRequestMethods()}return t.prototype.onSaveRequested=function(t){return this.callbacks.add("saveRequested",t)},t.prototype.isActivityOwner=function(){if("undefined"!=typeof htmlContainer){var t=htmlContainer.getContext();return t&&t._t42&&t._t42.activityIsOwner}var e=this.activitiesGetter();if(!e)return!1;if(!e.inActivity)return!1;var n=e.my.window,i=e.my.activity;return!(!i&&!n)&&i.owner.id===n.id},t.prototype.registerRequestMethods=function(){var t=this;this.interop.register("T42.HC.GetSaveContext",(function(e){var n,i,r,o=t.callbacks.execute("saveRequested",e);(null===(n=o)||void 0===n?void 0:n.length)>1&&t.logger.warn('Multiple subscriptions for "glue.layouts.onSaveRequested" - only the first one will be used');var s=o[0],a=t.config.autoSaveWindowContext;if(a)return{autoSaveWindowContext:a};var c={windowContext:null===(i=s)||void 0===i?void 0:i.windowContext,activityContext:void 0};return t.isActivityOwner()&&(c.activityContext=null===(r=s)||void 0===r?void 0:r.activityContext),c}))},t}();function li(t){if(!t)return t;if(Array.isArray(t))return t.map((function(t){return li(t)}));if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return t;return Object.keys(t).reduce((function(e,n){var i=li(t[n]),r=n;return n[0].toLowerCase()!==n[0]&&(r=n[0].toLowerCase()+n.substr(1)),e[r]=i,e}),{})}var vi=function(t){this.name=t.name,this.type=t.type,this.components=t.components,this.context=t.context,this.metadata=t.metadata,this.version=t.version},yi=function(){function t(t,e,n,i){this.config=t,this.stream=e,this.callbacks=n,this.appManager=t.appManager,this.onEvent=e.onEvent,this.provider=new fi(t,t.activityGetter,n,i),e.subscribe()}return t.prototype.setDefaultGlobal=function(t){return w(this,void 0,void 0,(function(){return b(this,(function(e){switch(e.label){case 0:return[4,this.config.agm.invoke("T42.ACS.SelectDefaultLayout",{name:t})];case 1:return e.sent(),[2]}}))}))},t.prototype.clearDefaultGlobal=function(){return w(this,void 0,void 0,(function(){return b(this,(function(t){switch(t.label){case 0:return[4,this.config.agm.invoke("T42.ACS.DeselectDefaultLayout")];case 1:return t.sent(),[2]}}))}))},t.prototype.getDefaultGlobal=function(){return w(this,void 0,void 0,(function(){var t,e;return b(this,(function(n){switch(n.label){case 0:return[4,this.config.agm.invoke("T42.ACS.GetDefaultLayout")];case 1:return t=n.sent(),(e=t.returned)?this.isSlimMode()?[2,e]:[2,this.list().find((function(t){return t.name===e.name&&"Global"===t.type}))]:[2,void 0]}}))}))},t.prototype.ready=function(){return"fullWaitSnapshot"===this.config.mode?this.stream.gotSnapshot:this.stream.ready},t.prototype.save=function(t){var e=this;return new Promise((function(n,i){if(e.verifyNotSlimMode(),!t.name)throw Error("layout.name argument is required");t.type||(t.type="Global"),t.activityId&&(t.type="Activity"),void 0===t.ignoreHidden&&(t.ignoreHidden=!0);var r={name:t.name,actIds:[],appIds:[],type:t.type,context:t.context,metadata:t.metadata||{},options:{ignoreLayoutRestrictions:!1}};if("Activity"===t.type){var o=t.activityId;if(!o){if(!e.appManager.myInstance.inActivity)throw new Error("Current application is not in activity. Can not save activity layout for it");o=e.appManager.myInstance.activityId}r.actIds.push(o),r.options={ignoreLayoutRestrictions:!0}}else{if("Global"!==t.type)throw new Error("layout type "+t.type+" not supported");if(2===e.config.gdMajorVersion){var s=e.appManager.instances();t.ignoreHidden&&(s=s.filter((function(t){return e.isVisibleWindow(t)}))),t.ignoreMyInstance&&e.appManager.myInstance&&(s=s.filter((function(t){return t.id!==e.appManager.myInstance.id}))),s.reduce((function(t,e){if(!e.id)return t;if(e.inActivity){var n=e.activityId;-1===t.actIds.indexOf(n)&&t.actIds.push(n)}else t.appIds.push(e.id);return t}),r)}else r.autoCollectApps=!0}e.invokeMethodAndTrack("T42.ACS.SaveLayout",r,n,i)}))},t.prototype.restore=function(t){var e=this;return new Promise((function(n,i){if(e.verifyNotSlimMode(),void 0===t)throw Error("options argument is required");if(!t.name)throw Error("options.name argument is required");t.type||(t.type="Global"),t.activityIdToJoin&&(t.type="Activity"),void 0===t.restoreActivityOwner&&(t.restoreActivityOwner=!1),void 0===t.ignoreActivityWindowTypes&&(t.ignoreActivityWindowTypes=[]),void 0===t.setActivityContext&&(t.setActivityContext=!0),void 0===t.closeRunningInstance&&("Global"===t.type?t.closeRunningInstance=!0:"Activity"===t.type&&(t.closeRunningInstance=!1)),void 0===t.reuseWindows&&(t.reuseWindows=!0),t.context=t.context||{};var r={restoreOptions:{activityToJoin:t.activityIdToJoin,setActivityContext:t.setActivityContext,ignoreActivityWindowTypes:t.ignoreActivityWindowTypes,restoreActivityOwner:t.restoreActivityOwner,closeOldWindows:t.closeRunningInstance,reuseExistingWindows:t.reuseWindows}},o={type:t.type,name:t.name,context:t.context,toClose:[],splash:t.splash};2===e.config.gdMajorVersion&&t.closeRunningInstance&&(o.toClose=e.getInstancesToClose(t)),t.timeout&&(o.timeout=t.timeout),o.context._t42=r,e.invokeMethodAndTrack("T42.ACS.RestoreLayout",o,n,i,!0)}))},t.prototype.remove=function(t,e){var n=this;return new Promise((function(i,r){if(n.verifyNotSlimMode(),!e)throw Error("name argument is required");if(!t)throw Error("type argument is required");var o={type:t,name:e};n.invokeMethodAndTrack("T42.ACS.RemoveLayout",o,i,r)}))},t.prototype.list=function(){return this.verifyNotSlimMode(),Jn.all},t.prototype.import=function(t,e){var n=this;return new Promise((function(i,r){n.verifyNotSlimMode();var o={mode:e||"replace",layouts:t};n.invokeMethodAndTrack("T42.ACS.ImportLayouts",o,i,r,!0)}))},t.prototype.export=function(){var t=this;return new Promise((function(e,n){t.invokeMethodAndTrack("T42.ACS.ExportLayouts",{},(function(n){var i=t.getObjectValues(n.Layouts).map((function(t){return new vi(li(t))}));e(i)}),n,!0)}))},t.prototype.rename=function(t,e){var n=this;return new Promise((function(i,r){if(n.verifyNotSlimMode(),!t)throw Error("layout argument is required");if(!t.name)throw Error("name argument is required");if(!t.type)throw Error("type argument is required");var o={type:t.type,oldName:t.name,newName:e};n.invokeMethodAndTrack("T42.ACS.RenameLayout",o,i,r)}))},t.prototype.updateMetadata=function(t){var e=this;return new Promise((function(n,i){if(!t)throw Error("layout argument is required");if(!t.name)throw Error("name argument is required");if(!t.type)throw Error("type argument is required");if(!t.metadata)throw Error("metadata argument is required");var r={name:t.name,type:t.type,metadata:t.metadata};e.invokeMethodAndTrack("T42.ACS.UpdateMetadata",r,n,i,!0)}))},t.prototype.hibernate=function(t,e){var n=this;return new Promise((function(i,r){if(!t)return r("name cannot be empty");var o={name:t,type:"Global",context:(e=e||{}).context||{},metadata:e.metadata||{}};n.invokeMethodAndTrack("T42.ACS.HibernateLayout",o,i,r,!0)}))},t.prototype.resume=function(t,e,n){var i=this;return new Promise((function(r,o){if(!t)return o("name cannot be empty");var s=m({name:t,type:"Global",context:e},n);i.invokeMethodAndTrack("T42.ACS.ResumeLayout",s,r,o,!0)}))},t.prototype.getCurrentLayout=function(){return w(this,void 0,void 0,(function(){var t,e;return b(this,(function(n){switch(n.label){case 0:return[4,this.config.agm.invoke("T42.ACS.GetCurrentLayout",{},"best",{methodResponseTimeoutMs:12e4})];case 1:return t=n.sent(),(e=t.returned.layout)?(this.isSlimMode()||(e=this.list().find((function(t){return t.name===e.name&&t.type===e.type}))),[2,e]):[2,void 0]}}))}))},t.prototype.onAdded=function(t){var e=this.callbacks.add("added",t);return Jn.all.length>0&&Jn.all.forEach((function(e){try{t(e)}catch(t){}})),e},t.prototype.onRemoved=function(t){return this.callbacks.add("removed",t)},t.prototype.onChanged=function(t){return this.callbacks.add("changed",t)},t.prototype.onRestored=function(t){return this.callbacks.add("restored",t)},t.prototype.onRenamed=function(t){return this.callbacks.add("renamed",t)},t.prototype.onEvent=function(t){return this.stream.onEvent(t)},t.prototype.onSaveRequested=function(t){return this.provider.onSaveRequested(t)},t.prototype.updateAppContextInCurrent=function(t){var e=this;return new Promise((function(n,i){t&&"object"!=typeof t&&i("context must be an object");var r={context:t=null!=t?t:{}};e.invokeMethodAndTrack("T42.ACS.UpdateLayoutComponentContext",r,n,i,!0)}))},t.prototype.updateDefaultContext=function(t){var e=this;return new Promise((function(n,i){t&&"object"!=typeof t&&i("context must be an object");var r={context:t=null!=t?t:{}};e.invokeMethodAndTrack("T42.ACS.UpdateDefaultContext",r,n,i,!0)}))},t.prototype.isSlimMode=function(){return"slim"===this.config.mode},t.prototype.verifyNotSlimMode=function(){if(this.isSlimMode())throw Error("Operation not allowed in slim mode. Run in full mode.")},t.prototype.isVisibleWindow=function(t){return"exe"===t.application.type||"node"===t.application.type||("activity"===t.application.type||!(!t||!t.window)&&t.window.isVisible)},t.prototype.invokeMethodAndTrack=function(t,e,n,i,r){var o,s=r,a=hi();e.token=a;var c=function(){s&&o&&n(o)};r||this.stream.waitFor(a).then((function(){s=!0,c()})).catch((function(t){i(t)}));this.config.agm.invoke(t,e,"best",{methodResponseTimeoutMs:12e4}).then((function(e){e.returned||i("No result from method "+t),e.returned.status&&"Success"!==e.returned.status&&"PartialSuccess"!==e.returned.status&&i(e.returned),o=e.returned,c()})).catch((function(t){return i(t)}))},t.prototype.getInstancesToClose=function(t){var e=this,n=[],i=this.appManager.applications().filter((function(t){return t.isShell}))[0],r=i?i.name:"AppManager";return this.appManager.instances().forEach((function(i){e.appManager.myInstance&&i.id===e.appManager.myInstance.id||i.application.name!==r&&e.isVisibleWindow(i)&&("Activity"===t.type&&i.activityId!==t.activityIdToJoin||n.push({application:i.application.name,instance:i.id}))})),n},t.prototype.getObjectValues=function(t){return t?Object.keys(t).map((function(e){return t[e]})):[]},t}(),gi=function(){function t(t,e){var n=this;this.agm=t,this.callbacks=e,this.ready=new Promise((function(t,e){n.resolveReady=t,n.rejectReady=e})),this.gotSnapshot=new Promise((function(t,e){n.resolveGotSnapshot=t,n.rejectGotSnapshot=e}))}return t.prototype.subscribe=function(t){var e=this,n=function(t){return e.getObjectValues(t).map((function(t){return li(t)}))};this.checkForLayoutEventMethod()?this.agm.subscribe("T42.ACS.OnLayoutEvent",{waitTimeoutMs:1e4}).then((function(t){t.onData((function(t){var i=t.data;i.IsSnapshot&&e.resolveGotSnapshot(),e.addLayouts(n(i.OnLayoutAdded)),e.removeLayouts(n(i.OnLayoutRemoved)),e.changeLayouts(n(i.OnLayoutChanged)),e.renameLayouts(n(i.OnLayoutRenamed)),e.restoredLayout(n(i.OnLayoutRestored)),e.callbacks.execute("streamEvent",i)})),t.onFailed((function(t){var n="can not subscribe to T42.ACS.OnLayoutEvent "+t;e.rejectReady(n),e.rejectGotSnapshot(n)})),e.resolveReady()})).catch((function(t){var n="Error subscribing for T42.ACS.OnLayoutEvent stream. Err: "+t;e.rejectReady(n),e.rejectGotSnapshot(n)})):(t&&this.resolveReady(),setTimeout((function(){e.subscribe(!0)}),500))},t.prototype.onEvent=function(t){return this.callbacks.add("streamEvent",t)},t.prototype.waitFor=function(t,e){var n=this;return e||(e=1e4),new Promise((function(i,r){var o=!1,s=n.onEvent((function(e){e.Token===t&&(o=!0,s(),i())}));setTimeout((function(){o||r("timed out")}),e)}))},t.prototype.checkForLayoutEventMethod=function(){try{return-1!==this.agm.methods().map((function(t){return t.name})).indexOf("T42.ACS.OnLayoutEvent")}catch(t){return!1}},t.prototype.addLayouts=function(t){var e=this;t&&t.forEach((function(t){var n=new vi(t);Jn.add(n),e.callbacks.execute("added",n)}))},t.prototype.removeLayouts=function(t){var e=this;t&&t.forEach((function(t){Jn.removeWhere((function(n){return!e.compareLayouts(n,t)})),e.callbacks.execute("removed",t)}))},t.prototype.changeLayouts=function(t){var e=this;t&&t.forEach((function(t){Jn.removeWhere((function(n){return!e.compareLayouts(n,t)})),Jn.add(new vi(t)),e.callbacks.execute("changed",t)}))},t.prototype.renameLayouts=function(t){var e=this;t&&t.forEach((function(t){var n=Jn.first((function(n){return e.compareLayouts(n,{type:t.type,name:t.oldName})}));if(!n)throw Error("received rename event for unknown layout with type "+t.type+" and name "+t.oldName);n.name=t.newName,e.callbacks.execute("renamed",n)}))},t.prototype.compareLayouts=function(t,e){return t.name===e.name&&t.type===e.type},t.prototype.getObjectValues=function(t){return t?Object.keys(t).map((function(e){return t[e]})):[]},t.prototype.restoredLayout=function(t){var e=this;t&&t.forEach((function(t){var n=Jn.first((function(n){return e.compareLayouts(n,{type:t.type,name:t.name})}));e.callbacks.execute("restored",n)}))},t}();function mi(t){if(!t.agm)throw Error("config.agm is required");if(!t.logger)throw Error("config.logger is required");t.mode=t.mode||"slim";var e,n=t.logger,i=Tn();return t.mode,e=new gi(t.agm,i),new yi(t,e,i,n)}var wi,bi,_i,Ii=function(t,e){var n=this;this._agm=t,this._logger=e,this.all=function(){return w(n,void 0,void 0,(function(){return b(this,(function(t){switch(t.label){case 0:return[4,this.callGD(wi.GetAll,{})];case 1:return[2,t.sent().map(this.decorateDisplay)]}}))}))},this.get=function(t){return w(n,void 0,void 0,(function(){var e;return b(this,(function(n){switch(n.label){case 0:return[4,this.callGD(wi.Get,{id:t})];case 1:return e=n.sent(),[2,this.decorateDisplay(e)]}}))}))},this.getPrimary=function(){return w(n,void 0,void 0,(function(){return b(this,(function(t){switch(t.label){case 0:return[4,this.all()];case 1:return[2,t.sent().find((function(t){return t.isPrimary}))]}}))}))},this.capture=function(t){return w(n,void 0,void 0,(function(){return b(this,(function(e){switch(e.label){case 0:return[4,this.callGD(wi.Capture,m({},t))];case 1:return[2,e.sent()]}}))}))},this.captureAll=function(t){return w(n,void 0,void 0,(function(){return b(this,(function(e){switch(e.label){case 0:return[4,this.callGD(wi.CaptureAll,m({},t))];case 1:return[2,e.sent()]}}))}))},this.getMousePosition=function(){return w(n,void 0,void 0,(function(){return b(this,(function(t){switch(t.label){case 0:return[4,this.callGD(wi.GetMousePosition)];case 1:return[2,t.sent()]}}))}))},this.callGD=function(t,e){return w(n,void 0,void 0,(function(){return b(this,(function(n){switch(n.label){case 0:return[4,this._agm.invoke("T42.Displays.Command",{options:m({},e),command:t})];case 1:return[2,n.sent().returned.data]}}))}))},this.decorateDisplay=function(t){return m(m({},t),{capture:function(e){return n.capture({id:t.id,size:e})}})}};function Si(t,e){return w(this,void 0,void 0,(function(){return b(this,(function(n){return bi.invoke("T42.Channels.Announce",{swId:null!=e?e:_i,command:"switchChannel",data:{newChannel:t}}),[2]}))}))}!function(t){t.Capture="capture",t.CaptureAll="captureAll",t.GetAll="getAll",t.Get="get",t.GetMousePosition="getMousePosition"}(wi||(wi={}));var xi="___channel___",ki=function(){function t(t){this.contexts=t}return t.prototype.subscribe=function(t){this.callback=t},t.prototype.subscribeFor=function(t,e){if(!this.isChannel(t))return Promise.reject(new Error("Channel with name: "+t+" doesn't exist!"));var n=this.createContextName(t);return this.contexts.subscribe(n,(function(t,n,i,r,o){var s;e(t.data,t,null===(s=o)||void 0===s?void 0:s.updaterId)}))},t.prototype.switchChannel=function(t){return w(this,void 0,void 0,(function(){var e,n,i=this;return b(this,(function(r){switch(r.label){case 0:return this.unsubscribe(),e=this.createContextName(t),n=this,[4,this.contexts.subscribe(e,(function(t,e,n,r,o){var s;i.callback&&i.callback(t.data,t,null===(s=o)||void 0===s?void 0:s.updaterId)}))];case 1:return n.unsubscribeFunc=r.sent(),[2]}}))}))},t.prototype.unsubscribe=function(){this.unsubscribeFunc&&this.unsubscribeFunc()},t.prototype.all=function(){return this.contexts.all().filter((function(t){return t.startsWith(xi)})).map((function(t){return t.substr(xi.length)}))},t.prototype.getContextData=function(t){var e=this;return new Promise((function(n,i){if(!e.isChannel(t))return i(new Error("A channel with name: "+t+" doesn't exist!"));var r=e.createContextName(t);e.contexts.subscribe(r,(function(t){n(t)})).then((function(t){return t()}))}))},t.prototype.updateChannel=function(t,e){var n=this.createContextName(t);return this.contexts.update(n,e)},t.prototype.updateData=function(t,e){var n=this.createContextName(t);if(this.contexts.setPathSupported){var i=Object.keys(e).map((function(t){return{path:"data."+t,value:e[t]}}));return this.contexts.setPaths(n,i)}return this.contexts.update(n,{data:e})},t.prototype.isChannel=function(t){return this.all().some((function(e){return e===t}))},t.prototype.createContextName=function(t){return xi+t},t}(),Ci=function(){function t(t){this.shared=t,this.subsKey="subs",this.changedKey="changed",this.registry=Tn(),this.shared.subscribe(this.handler.bind(this))}return t.prototype.subscribe=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.subsKey,t)},t.prototype.subscribeFor=function(t,e){return w(this,void 0,void 0,(function(){return b(this,(function(n){switch(n.label){case 0:if("string"!=typeof t)throw new Error("Please provide the name as a string!");if("function"!=typeof e)throw new Error("Please provide the callback as a function!");return[4,this.shared.subscribeFor(t,e)];case 1:return[2,n.sent()]}}))}))},t.prototype.publish=function(t,e){return w(this,void 0,void 0,(function(){return b(this,(function(n){if("object"!=typeof t)throw new Error("Please provide the data as an object!");if(e){if("string"!=typeof e)throw new Error("Please provide the name as a string!");return this.shared.isChannel(e)?[2,this.shared.updateData(e,t)]:[2,Promise.reject(new Error("A channel with name: "+e+" doesn't exist!"))]}if(!this.currentContext)throw new Error("Not joined to any channel!");return[2,this.shared.updateData(this.currentContext,t)]}))}))},t.prototype.all=function(){var t=this.shared.all();return Promise.resolve(t)},t.prototype.list=function(){return w(this,void 0,void 0,(function(){var t,e=this;return b(this,(function(n){switch(n.label){case 0:return[4,this.all()];case 1:return t=n.sent(),[4,Promise.all(t.map((function(t){return e.get(t)})))];case 2:return[2,n.sent()]}}))}))},t.prototype.get=function(t){return"string"!=typeof t?Promise.reject(new Error("Please provide the channel name as a string!")):this.shared.getContextData(t)},t.prototype.join=function(t){return w(this,void 0,void 0,(function(){return b(this,(function(e){return[2,this.joinCore(t)]}))}))},t.prototype.joinNoSelectorSwitch=function(t){return w(this,void 0,void 0,(function(){return b(this,(function(e){return[2,this.joinCore(t,!1)]}))}))},t.prototype.leave=function(){return this.leaveCore()},t.prototype.leaveNoSelectorSwitch=function(){return this.leaveCore(!1)},t.prototype.current=function(){return this.currentContext},t.prototype.my=function(){return this.current()},t.prototype.changed=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.changedKey,t)},t.prototype.onChanged=function(t){return this.changed(t)},t.prototype.add=function(t){return w(this,void 0,void 0,(function(){var e;return b(this,(function(n){switch(n.label){case 0:if("object"!=typeof t)throw new Error("Please provide the info as an object!");if(void 0===t.name)throw new Error("info.name is missing!");if("string"!=typeof t.name)throw new Error("Please provide the info.name as a string!");if(void 0===t.meta)throw new Error("info.meta is missing!");if("object"!=typeof t.meta)throw new Error("Please provide the info.meta as an object!");if(void 0===t.meta.color)throw new Error("info.meta.color is missing!");if("string"!=typeof t.meta.color)throw new Error("Please provide the info.meta.color as a string!");return e={name:t.name,meta:t.meta||{},data:t.data||{}},[4,this.shared.updateChannel(t.name,e)];case 1:return n.sent(),[2,e]}}))}))},t.prototype.handler=function(t,e,n){this.registry.execute(this.subsKey,t,e,n)},t.prototype.joinCore=function(t,e){return void 0===e&&(e=!0),w(this,void 0,void 0,(function(){var n,i=this;return b(this,(function(r){switch(r.label){case 0:if("string"!=typeof t)throw new Error("Please provide the channel name as a string!");return t===this.currentContext?[2]:(n=function(t){return i.shared.all().includes(t)})(t)?[3,2]:[4,new Promise((function(e,i){var r,o=setInterval((function(){n(t)&&(clearTimeout(r),clearInterval(o),e())}),100);r=setTimeout((function(){return clearInterval(o),i(new Error("A channel with name: "+t+" doesn't exist!"))}),3e3)}))];case 1:r.sent(),r.label=2;case 2:return this.currentContext=t,[4,this.shared.switchChannel(t)];case 3:return r.sent(),e&&Si(t),this.registry.execute(this.changedKey,t),[2]}}))}))},t.prototype.leaveCore=function(t){return void 0===t&&(t=!0),this.currentContext=void 0,this.registry.execute(this.changedKey,void 0),this.shared.unsubscribe(),t&&Si(),Promise.resolve()},t}();function Ai(t,e){var n=new ki(t),i=new Ci(n);return function(t,e){w(this,void 0,void 0,(function(){return b(this,(function(n){switch(n.label){case 0:return bi=t,"undefined"!=typeof window&&window.glue42gd&&(_i=window.glue42gd.windowId),_i?[4,bi.register("T42.Channels.Command",(function(t){var n=t.command;if(!n)throw new Error("missing command argument");if("join"!==n){if("leave"!==n){if("get"===n)return{id:i=e.current()};throw new Error("unknown command "+n)}e.leaveNoSelectorSwitch()}else{var i;if(!(i=t.channel))throw new Error("missing argument id");e.joinNoSelectorSwitch(i)}}))]:[2];case 1:return n.sent(),bi.invoke("T42.Channels.Announce",{swId:_i,instance:bi.instance.instance}),[2]}}))}))}(e,i),{subscribe:i.subscribe.bind(i),subscribeFor:i.subscribeFor.bind(i),publish:i.publish.bind(i),all:i.all.bind(i),list:i.list.bind(i),get:i.get.bind(i),join:i.join.bind(i),leave:i.leave.bind(i),current:i.current.bind(i),my:i.my.bind(i),changed:i.changed.bind(i),onChanged:i.onChanged.bind(i),add:i.add.bind(i),ready:function(){return t.ready()}}}var Ti="T42.Hotkeys.Command",Pi=function(){function t(t){this.agm=t,this.registry=Tn(),this.firstHotkey=!0,this.hotkeys=new Map}return t.prototype.register=function(t,e){return w(this,void 0,void 0,(function(){var n;return b(this,(function(i){switch(i.label){case 0:if(void 0===t)throw new Error("Hotkey parameter missing");if("string"==typeof t)t={hotkey:t};else{if(!t.hotkey)throw new Error("Info's hotkey parameter missing");t={hotkey:t.hotkey,description:t.description}}if(n=this.formatHotkey(t.hotkey),this.hotkeys.has(n))throw new Error("Shortcut for "+n+" already registered");return this.firstHotkey?(this.firstHotkey=!1,[4,this.registerInvokeAGMMethod()]):[3,2];case 1:i.sent(),i.label=2;case 2:return this.registry.add(n,e),[4,this.agm.invoke(Ti,{command:"register",hotkey:n,description:t.description})];case 3:return i.sent(),this.hotkeys.set(n,t),[2]}}))}))},t.prototype.unregister=function(t){return w(this,void 0,void 0,(function(){var e;return b(this,(function(n){switch(n.label){case 0:if(void 0===t)throw new Error("hotkey parameter missing");if("string"!=typeof t)throw new Error("hotkey parameter must be string");return e=this.formatHotkey(t),[4,this.agm.invoke(Ti,{command:"unregister",hotkey:e})];case 1:return n.sent(),this.hotkeys.delete(e),this.registry.clearKey(e),[2]}}))}))},t.prototype.unregisterAll=function(){return w(this,void 0,void 0,(function(){return b(this,(function(t){switch(t.label){case 0:return[4,this.agm.invoke(Ti,{command:"unregisterAll"})];case 1:return t.sent(),this.hotkeys.clear(),this.registry.clear(),[2]}}))}))},t.prototype.isRegistered=function(t){var e=this.formatHotkey(t);return this.hotkeys.has(e)},t.prototype.registerInvokeAGMMethod=function(){var t=this;this.agm.register("T42.Hotkeys.Invoke",(function(e){var n=e.key.toLowerCase(),i=t.hotkeys.get(n);t.registry.execute(n,i)}))},t.prototype.formatHotkey=function(t){if(t)return t.replace(/\s/g,"").toLowerCase()},t}();var Mi="5.3.2",ji=function(t){function e(t,e,i){if("boolean"!=typeof t||t){var r=n(t,e,i);return"object"==typeof t?(t.mode=r,t):{mode:r}}}function n(t,e,i){return"object"==typeof t?n(t.mode,e,i)+"":void 0===t?"boolean"!=typeof e||e?e+"":void 0:"boolean"==typeof t?t?(void 0===i?e:i)+"":void 0:t+""}return{layouts:e(t.layouts,"slim"),activities:e(t.activities,"trackMyTypeAndInitiatedFromMe"),appManager:e(t.appManager,!1,"startOnly"),windows:e(t.windows,!0),channels:e(t.channels||!1,!1),displays:e(t.displays,!0)}},Ei=function(){function t(t){this.options=t,this.callbacks=Tn(),this.actions=t.actions,this.body=t.body,this.badge=t.badge,this.data=t.data,this.dir=t.dir,this.icon=t.icon,this.image=t.image,this.lang=t.lang,this.renotify=t.renotify,this.requireInteraction=t.requireInteraction,this.silent=t.silent,this.tag=t.tag,this.timestamp=t.timestamp,this.title=t.title}return t.prototype.close=function(){throw new Error("Method not implemented.")},t.prototype.addEventListener=function(t,e,n){this.callbacks.add(t,e)},t.prototype.removeEventListener=function(t,e,n){},t.prototype.dispatchEvent=function(t){return this.callbacks.execute(t.type,t),!0},t}(),Oi=function(){function t(t){this.interop=t,this.methodsRegistered=!1,this.methodNameRoot="T42.Notifications.Handler-"+hi(),this.nextId=0,this.notifications={}}return Object.defineProperty(t.prototype,"maxActions",{get:function(){return 2},enumerable:!0,configurable:!0}),t.prototype.raise=function(t){var e,n;return w(this,void 0,void 0,(function(){var i,r,o,s,a,c,u,d,p,h,f;return b(this,(function(l){switch(l.label){case 0:if(!t)throw new Error("invalid options - should be an object");if(!t.title)throw new Error("invalid options - should have title");if(this.methodsRegistered)return[3,2];for(i=[],a=0;a<this.maxActions;a++)i.push(this.interop.register(this.methodNameRoot+"_"+a,this.handleNotificationAction.bind(this)));return[4,Promise.all(i)];case 1:l.sent(),this.methodsRegistered=!0,l.label=2;case 2:if(r=String(this.nextId++),o={title:t.title,severity:"Medium",description:t.body,glueRoutingDetailMethodName:this.methodNameRoot+"_0",actions:[],source:r},t.actions)for(s=t.actions.slice(0,this.maxActions),a=0,c=function(t){var i={g42notificationId:r,g42action:t.action,g42interopMethod:null===(e=t.interop)||void 0===e?void 0:e.method,g42interopTarget:null===(n=t.interop)||void 0===n?void 0:n.target},s=Object.keys(i).map((function(t){return{name:t,value:{stringValue:i[t]}}})),c={name:u.methodNameRoot+"_"+a,description:t.title,displayName:t.title,parameters:s};o.actions.push(c),a++},u=this,d=0,p=s;d<p.length;d++)h=p[d],c(h);return[4,this.interop.invoke("T42.GNS.Publish.RaiseNotification",{notification:o})];case 3:return l.sent(),f=new Ei(t),this.notifications[r]=f,[2,f]}}))}))},t.prototype.handleNotificationAction=function(t){if(t.g42notificationId){var e=t,n=e.g42notificationId;if(!(o=this.notifications[n]))return;var i=new Event("onaction");i.action=e.g42action,o.onaction&&o.onaction(i);var r=(o.actions||[]).find((function(t){return t.action===e.g42action})).interop;r&&this.interop.invoke(r.method,r.arguments||{},r.target||"best"),o.dispatchEvent(i)}else if(t.notification&&t.notification.source){var o;n=t.notification.source;if(!(o=this.notifications[n]))return;var s=new Event("onclick");o.onclick&&o.onclick(s);var a=o.options.clickInterop;a&&this.interop.invoke(a.method,a.arguments||{},a.target||"best"),o.dispatchEvent(s)}},t}(),Ri=function(){function t(t){this.core=t,this.registry=Tn(),this.isSubscribed=!1,this.getConfiguration()}return t.prototype.list=function(){return w(this,void 0,void 0,(function(){return b(this,(function(t){switch(t.label){case 0:return[4,this.getConfiguration()];case 1:if(t.sent(),!this.getMethodName)throw new Error("not supported");return[4,this.getAll()];case 2:return[2,t.sent().returned.all]}}))}))},t.prototype.getCurrent=function(){return w(this,void 0,void 0,(function(){var t;return b(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:if(e.sent(),!this.getMethodName)throw new Error("not supported");return[4,this.getAll()];case 2:return[2,(t=e.sent()).returned.all.find((function(e){return e.name===t.returned.selected}))]}}))}))},t.prototype.select=function(t){return w(this,void 0,void 0,(function(){return b(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:if(e.sent(),!this.setMethodName)throw new Error("not supported");return[4,this.core.interop.invoke(this.setMethodName,{theme:t})];case 2:return e.sent(),[2]}}))}))},t.prototype.onChanged=function(t){return this.subscribe(),this.registry.add("changed",t)},t.prototype.getConfiguration=function(){return w(this,void 0,void 0,(function(){var t;return b(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),this.sharedContextName?[2]:[4,this.core.interop.invoke("T42.Themes.Configuration")];case 1:return t=e.sent(),this.sharedContextName=t.returned.sharedContextName,this.getMethodName=t.returned.getThemesMethodName,this.setMethodName=t.returned.setThemesMethodName,[3,3];case 2:return e.sent(),[2];case 3:return[2]}}))}))},t.prototype.getAll=function(){return w(this,void 0,void 0,(function(){return b(this,(function(t){switch(t.label){case 0:return[4,this.getConfiguration()];case 1:return t.sent(),[4,this.core.interop.invoke(this.getMethodName)];case 2:return[2,t.sent()]}}))}))},t.prototype.subscribe=function(){return w(this,void 0,void 0,(function(){var t=this;return b(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:return e.sent(),this.isSubscribed?[2]:(this.isSubscribed=!0,this.core.contexts.subscribe(this.sharedContextName,(function(e){e&&e.all&&e.selected&&t.registry.execute("changed",e.all.find((function(t){return t.name===e.selected})))})),[2])}}))}))},t}();var Ni="Tick42.FDC3.Intents.",Li=function(){function t(t,e,n){this.interop=t,this.windows=e,this.logger=n}return t.prototype.find=function(t){return w(this,void 0,void 0,(function(){var e,n;return b(this,(function(i){switch(i.label){case 0:return[4,this.all()];case 1:if(e=i.sent(),void 0===t)return[2,e];if("string"==typeof t)return[2,e.filter((function(e){return e.name===t}))];if("object"!=typeof t)throw new Error("Please provide the intentFilter as a string or an object!");return t.contextType&&(n=t.contextType.toLowerCase(),e=e.filter((function(t){return t.handlers.some((function(t){var e;return null===(e=t.contextTypes)||void 0===e?void 0:e.some((function(t){return t.toLowerCase()===n}))}))}))),t.name&&(e=e.filter((function(e){return e.name===t.name}))),[2,e]}}))}))},t.prototype.raise=function(t){return w(this,void 0,void 0,(function(){var e,n,i,r,o,s,a,c,u;return b(this,(function(d){switch(d.label){case 0:if("string"!=typeof t&&"object"!=typeof t||"object"==typeof t&&"string"!=typeof t.intent)throw new Error("Please provide the intent as a string or an object with an intent property!");return"string"==typeof t&&(t={intent:t}),e=t.intent,[4,this.get(e)];case 1:if(void 0===(n=d.sent()))throw new Error("Intent "+e+" not found.");if(i=!n.handlers.some((function(t){return"app"===t.type})),r=t.target||(i?"reuse":"startNew"),s=n.handlers.find((function(t){return"app"===t.type})),"startNew"===r)o=s;else if("reuse"===r)a=n.handlers.find((function(t){return"instance"===t.type})),o=a||s;else if(r.instance)o=n.handlers.find((function(t){return"instance"===t.type&&t.instanceId===r.instance}));else{if(!r.app)throw new Error("Invalid intent target: "+JSON.stringify(r));o=n.handlers.find((function(t){return"app"===t.type&&t.applicationName===r.app}))}if(!o)throw new Error("Can not raise intent for request "+JSON.stringify(t)+" - can not find intent handler.");return c=o.instanceId,"app"!==o.type?[3,3]:[4,this.startApp(o.applicationName,t.options)];case 2:c=d.sent(),d.label=3;case 3:return[4,this.raiseIntentToInstance(c,e,t.context)];case 4:return(u=d.sent()).request=t,u.handler=o,[2,u]}}))}))},t.prototype.all=function(){return w(this,void 0,void 0,(function(){var t,e,n,i,r,o,s,a,c,u,d,p,h,f,l,v,y,g=this;return b(this,(function(m){switch(m.label){case 0:return m.trys.push([0,6,,7]),[4,this.interop.invoke("T42.ACS.GetApplications",{withIntentsInfo:!0})];case 1:for(t=m.sent(),e=t.returned.applications,n={},i=e.filter((function(t){return t.intents&&t.intents.length>0})),r=0,o=i;r<o.length;r++)for(s=o[r],a=0,c=s.intents;a<c.length;a++)u=c[a],(d=n[u.name])||(d={name:u.name,handlers:[]},n[u.name]=d),p={applicationName:s.name,applicationTitle:s.title,applicationDescription:s.caption,displayName:u.displayName,contextTypes:u.contexts,applicationIcon:s.icon,type:"app"},d.handlers.push(p);h=function(t){return b(this,(function(i){switch(i.label){case 0:return[4,Promise.all(t.getMethods().filter((function(t){return t.name.startsWith(Ni)})).map((function(i){return w(g,void 0,void 0,(function(){var r,o,s,a,c,u,d,p,h,f,l,v,y,g,m,w,_,I;return b(this,(function(b){switch(b.label){case 0:if(r=i.name.replace(Ni,""),(o=n[r])||(o={name:r,handlers:[]},n[r]=o),i.description)try{s=JSON.parse(i.description)}catch(t){}return(a=e.find((function(e){return e.name===t.application})))&&a.intents&&(c=a.intents.find((function(t){return t.name===r}))),u=this.windows.findById(t.windowId),[4,null===(h=u)||void 0===h?void 0:h.getTitle()];case 1:return d=b.sent(),p={instanceId:t.instance,applicationName:t.application,applicationIcon:(null===(f=s)||void 0===f?void 0:f.icon)||(null===(l=a)||void 0===l?void 0:l.icon),applicationTitle:null===(v=a)||void 0===v?void 0:v.title,applicationDescription:(null===(y=s)||void 0===y?void 0:y.description)||(null===(g=a)||void 0===g?void 0:g.caption),displayName:(null===(m=s)||void 0===m?void 0:m.displayName)||(null===(w=c)||void 0===w?void 0:w.displayName),contextTypes:(null===(_=s)||void 0===_?void 0:_.contextTypes)||(null===(I=c)||void 0===I?void 0:I.contexts),instanceTitle:d,type:"instance"},o.handlers.push(p),[2]}}))}))})))];case 1:return i.sent(),[2]}}))},f=0,l=this.interop.servers(),m.label=2;case 2:return f<l.length?(v=l[f],[5,h(v)]):[3,5];case 3:m.sent(),m.label=4;case 4:return f++,[3,2];case 5:return[2,Object.values(n)];case 6:return y=m.sent(),this.logger.error("Failed to get the applications!",y),[2,[]];case 7:return[2]}}))}))},t.prototype.addIntentListener=function(t,e){var n=this;if("string"!=typeof t&&"object"!=typeof t||"object"==typeof t&&"string"!=typeof t.intent)throw new Error("Please provide the intent as a string or an object with an intent property!");if("function"!=typeof e)throw new Error("Please provide the handler as a function!");var i={unsubscribe:function(){return console.log("Could not unsubscribe!")}},r="Tick42.FDC3.Intents."+("string"==typeof t?t:t.intent),o="string"==typeof t?void 0:JSON.stringify(t);return this.interop.register({name:r,description:o},(function(t){return e(t)})).then((function(){i.unsubscribe=function(){n.interop.unregister(r)}})),i},t.prototype.get=function(t){return w(this,void 0,void 0,(function(){return b(this,(function(e){switch(e.label){case 0:return[4,this.all()];case 1:return[2,e.sent().find((function(e){return e.name===t}))]}}))}))},t.prototype.startApp=function(t,e){return w(this,void 0,void 0,(function(){return b(this,(function(n){switch(n.label){case 0:return[4,this.interop.invoke("T42.ACS.StartApplication",{Name:t,options:e})];case 1:return[2,n.sent().returned.Id]}}))}))},t.prototype.raiseIntentToInstance=function(t,e,n){return w(this,void 0,void 0,(function(){var i,r,o=this;return b(this,(function(s){switch(s.label){case 0:return i="Tick42.FDC3.Intents."+e,(r=this.interop.servers().find((function(e){return e.instance===t})))?[3,2]:[4,new Promise((function(e,n){var i,s=o.interop.serverAdded((function(n){n.instance===t&&(r=n,e(),clearTimeout(i),s())}));i=setTimeout((function(){s(),n(new Error("Can not find interop server for instance "+t))}),3e4)}))];case 1:s.sent(),s.label=2;case 2:return r.getMethods().find((function(t){return t.name===i}))?[3,4]:[4,new Promise((function(e,n){var r,s=o.interop.methodAdded((function(t){t.name===i&&(e(),clearTimeout(r),s())}));r=setTimeout((function(){s(),n(new Error("Can not find interop method "+i+" for instance "+t))}),1e4)}))];case 3:s.sent(),s.label=4;case 4:return[4,this.interop.invoke(i,n,{instance:t})];case 5:return[2,{result:s.sent().returned}]}}))}))},t}(),Wi=[],Di=function(t){return w(void 0,void 0,void 0,(function(){function e(t){if(v.windows){var e=p("windows",t.logger,v.windows);return h(m=Vn(t.agm,e,(function(){return y}),l)),m}}function n(t){var e,n;if(v.activities&&Sn.checkIsUsingGW3Implementation&&Sn.checkIsUsingGW3Implementation(t.connection)){var i=p("activity",t.logger,v.activities);return h(g=new Sn({connection:t.connection,contexts:t.contexts,agm:t.agm,logger:i,logLevel:"info",disableAutoAnnounce:!1,disposeRequestHandling:"exit",announcementInfo:null,windows:m,appManagerGetter:function(){return y},mode:v.activities.mode,typesToTrack:v.activities.typesToTrack,activityId:null===(n=null===(e=f)||void 0===e?void 0:e.activityInfo)||void 0===n?void 0:n.activityId,gdMajorVersion:l}).api),g}}function i(t){if(v.appManager){var e=p("appManager",t.logger,v.appManager);return h(y=Ln({agm:t.agm,windows:m,logger:e,activities:g,mode:v.appManager.mode,gdMajorVersion:l})),y}}function r(t){var e;if(v.layouts){var n=p("layouts",t.logger,v.layouts),i=v.layouts,r=mi({agm:t.agm,appManager:y,activityGetter:function(){return g},logger:n,mode:i.mode,autoSaveWindowContext:(e=i.autoSaveWindowContext,null!=e&&e),gdMajorVersion:l});return h(r),r}}function o(t){if(v.channels&&t.contexts){var e=Ai(t.contexts,t.agm);return h(e),e}}function s(t){var e,n,i=(e=t.agm,{register:(n=new Pi(e)).register.bind(n),unregister:n.unregister.bind(n),unregisterAll:n.unregisterAll.bind(n),isRegistered:n.isRegistered.bind(n),ready:function(){return Promise.resolve()}});return h(i),i}function a(t){var e=new Li(t.agm,m,t.logger.subLogger("intents"));return h(e),e}function c(t){var e=new Oi(t.interop);return h(e),e}function u(t){if(v.displays){var e=p("displays",t.logger,v.displays);return h(w=new Ii(t.agm,e)),w}}function d(t){if(t.contexts){var e=function(t){var e=new Ri(t);return{list:e.list.bind(e),getCurrent:e.getCurrent.bind(e),select:e.select.bind(e),onChanged:e.onChanged.bind(e),ready:function(){return Promise.resolve()}}}(t);return h(e),e}}function p(t,e,n){var i=e.subLogger(t);if(n&&n.logger){var r=n.logger;r.console&&i.consoleLevel(r.console),r.publish&&i.publishLevel(r.publish)}return i}function h(t){I.push(t)}var f,l,v,y,g,m,w,_,I,S,x;return b(this,(function(p){switch(p.label){case 0:return(f="undefined"!=typeof window&&window.glue42gd)&&Wi.length>0?[2,Wi[0]]:(l=Dn.getGDMajorVersion(),v=ji(t=t||{}),t.gateway=t.gateway||{},_={libs:[{name:"windows",create:e},{name:"activities",create:n},{name:"appManager",create:i},{name:"layouts",create:r},{name:"channels",create:o},{name:"hotkeys",create:s},{name:"displays",create:u},{name:"intents",create:a},{name:"notifications",create:c},{name:"themes",create:d}],version:Mi,enrichGlue:function(t){t.config.activities=v.activities,t.config.windows=v.windows,t.config.appManager=v.appManager,t.config.layouts=v.layouts,t.config.channels=v.channels,t.config.displays=v.displays}},I=[],"undefined"!=typeof window&&(window.glueFactoryLog||(window.glueFactoryLog=[]),window.glueFactoryLog.push(I)),[4,je(t,_)]);case 1:return S=p.sent(),Wi.push(S),Array.isArray(null===(x=t)||void 0===x?void 0:x.libraries)&&t.libraries.length?[4,Promise.all(t.libraries.map((function(e){return e(S,t)})))]:[3,3];case 2:p.sent(),p.label=3;case 3:return[2,S]}}))}))};Di.coreVersion=je.version,Di.version=Mi,Di.instances=Wi;var Fi=Di,Bi=!0;if("undefined"!=typeof window){var Gi=window.glue42gd;Gi&&Gi.autoInjected&&(Fi=window.Glue,Bi=!1),Bi&&(window.Glue=Fi),delete window.GlueCore}Fi.default=Fi;var qi=Fi,Hi=function(t,e){return(Hi=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var Ui=function(){return(Ui=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function Vi(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))}function Ji(t,e){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var zi="1.6.7";var Ki=1;var Yi,Zi,Qi,Xi={nextValue:function(){return(Ki=(9301*Ki+49297)%233280)/233280},seed:function(t){Ki=t}},$i="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function tr(){Qi=!1}function er(t){if(t){if(t!==Yi){if(t.length!==$i.length)throw new Error("Custom alphabet for shortid must be "+$i.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+$i.length+" unique characters. These characters were not unique: "+e.join(", "));Yi=t,tr()}}else Yi!==$i&&(Yi=$i,tr())}function nr(){return Qi||(Qi=function(){Yi||er($i);for(var t,e=Yi.split(""),n=[],i=Xi.nextValue();e.length>0;)i=Xi.nextValue(),t=Math.floor(i*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var ir={get:function(){return Yi||$i},characters:function(t){return er(t),Yi},seed:function(t){Xi.seed(t),Zi!==t&&(tr(),Zi=t)},lookup:function(t){return nr()[t]},shuffled:nr},rr="object"==typeof window&&(window.crypto||window.msCrypto),or=rr&&rr.getRandomValues?function(t){return rr.getRandomValues(new Uint8Array(t))}:function(t){for(var e=[],n=0;n<t;n++)e.push(Math.floor(256*Math.random()));return e},sr=function(t,e,n){for(var i=(2<<Math.log(e.length-1)/Math.LN2)-1,r=-~(1.6*i*n/e.length),o="";;)for(var s=t(r),a=r;a--;)if((o+=e[s[a]&i]||"").length===+n)return o};var ar,cr,ur=function(t){for(var e,n=0,i="";!e;)i+=sr(or,ir.get(),1),e=t<Math.pow(16,n+1),n++;return i};var dr=function(t){var e="",n=Math.floor(.001*(Date.now()-1567752802062));return n===cr?ar++:(ar=0,cr=n),e+=ur(7),e+=ur(t),ar>0&&(e+=ur(ar)),e+=ur(n)};var pr=function(t){return!(!t||"string"!=typeof t||t.length<6)&&!new RegExp("[^"+ir.get().replace(/[|\\{}()[\]^$+*?.-]/g,"\\$&")+"]").test(t)},hr=function(t,e,n){return t(n={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&n.path)}},n.exports),n.exports}((function(t){var e=0;function n(){return dr(e)}t.exports=n,t.exports.generate=n,t.exports.seed=function(e){return ir.seed(e),t.exports},t.exports.worker=function(n){return e=n,t.exports},t.exports.characters=function(t){return void 0!==t&&ir.characters(t),ir.shuffled()},t.exports.isValid=pr})),fr=function(){function t(t,e,n,i){this.id=t,this.name=e,this.control=n,this.windows=i}return t.prototype.getURL=function(){var t;return Vi(this,void 0,void 0,(function(){var e;return Ji(this,(function(n){switch(n.label){case 0:return[4,this.callControl("getURL",{})];case 1:return e=n.sent(),[2,null===(t=null==e?void 0:e.returned)||void 0===t?void 0:t._value]}}))}))},t.prototype.moveResize=function(t){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(e){switch(e.label){case 0:return[4,this.callControl("moveResize",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.close=function(){return Vi(this,void 0,void 0,(function(){var t=this;return Ji(this,(function(e){return[2,new Promise((function(e,n){var i=function(){o&&clearTimeout(o),r&&r()},r=t.windows.onWindowRemoved((function(n){n.id===t.id&&(e(t),i())})),o=setTimeout((function(){n("can not close window - probably not opened by your window"),i()}),5e3);t.callControl("close",{},!0).catch((function(){}))}))]}))}))},t.prototype.setTitle=function(t){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(e){switch(e.label){case 0:return"string"==typeof t&&(t={title:t}),[4,this.callControl("setTitle",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.resizeTo=function(t,e){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(n){switch(n.label){case 0:return[4,this.callControl("moveResize",{width:t,height:e},!0)];case 1:return n.sent(),[2,this]}}))}))},t.prototype.moveTo=function(t,e){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(n){switch(n.label){case 0:return[4,this.callControl("moveResize",{top:t,left:e},!0)];case 1:return n.sent(),[2,this]}}))}))},t.prototype.focus=function(){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(t){switch(t.label){case 0:return[4,this.callControl("focus",{},!0)];case 1:return t.sent(),[2,this]}}))}))},t.prototype.getBounds=function(){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(t){switch(t.label){case 0:return[4,this.callControl("getBounds",{})];case 1:return[2,t.sent().returned]}}))}))},t.prototype.getContext=function(){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(t){switch(t.label){case 0:return[4,this.callControl("getContext",{})];case 1:return[2,t.sent().returned]}}))}))},t.prototype.getTitle=function(){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(t){switch(t.label){case 0:return[4,this.callControl("getTitle",{})];case 1:return[2,t.sent().returned._value]}}))}))},t.prototype.onContextUpdated=function(t){throw new Error("Method not implemented.")},t.prototype.updateContext=function(t){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(e){switch(e.label){case 0:return[4,this.callControl("updateContext",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.setContext=function(t){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(e){switch(e.label){case 0:return[4,this.callControl("setContext",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.callControl=function(t,e,n){return void 0===n&&(n=!1),Vi(this,void 0,void 0,(function(){return Ji(this,(function(i){switch(i.label){case 0:return[4,this.control.send({command:t,domain:"windows",args:e,skipResult:n},{windowId:this.id})];case 1:return[2,i.sent()]}}))}))},t}();function lr(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function i(n,i){var r=n instanceof Error?n:new Error(n);if(e)e(r);else{var o='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+r.stack;if(t)switch(t.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(t,e,r){var o=n[t];return o||(o=[],n[t]=o),o.push(e),r&&setTimeout((function(){r.forEach((function(r){var o;if(null===(o=n[t])||void 0===o?void 0:o.includes(e))try{Array.isArray(r)?e.apply(void 0,r):e.apply(void 0,[r])}catch(e){i(e,t)}}))}),0),function(){var i=n[t];i&&(i=i.reduce((function(t,n,i){return n===e&&t.length===i||t.push(n),t}),[]),n[t]=i)}},execute:function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var o=n[t];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var r=n.apply(void 0,e);s.push(r)}catch(e){s.push(void 0),i(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}lr.default=lr;var vr=lr,yr=function(){function t(){this.callbacks={},this.registry=vr()}return t.prototype.start=function(e,n){return Vi(this,void 0,void 0,(function(){var i=this;return Ji(this,(function(r){switch(r.label){case 0:return this.interop=e,this.logger=n,[4,this.interop.register(t.CONTROL_METHOD,(function(t){return Vi(i,void 0,void 0,(function(){var e,i,r;return Ji(this,(function(o){switch(o.label){case 0:return e=t,n.trace("received control command "+JSON.stringify(e)),"windows"!==e.domain?[3,2]:this.myWindow?[4,this.myWindow[e.command].call(this.myWindow,e.args)]:[2];case 1:return i=o.sent(),e.skipResult?[2,{}]:[2,i];case 2:return"appManager"!==e.domain?[3,4]:this.myInstance?[4,this.myInstance[e.command].call(this.myInstance,e.args)]:[2];case 3:return i=o.sent(),e.skipResult?[2,{}]:[2,i];case 4:return"layouts"===e.domain&&(r=this.callbacks[e.domain])&&r(e),[2]}}))}))}))];case 1:return r.sent(),this.registry.execute("started"),[2]}}))}))},t.prototype.send=function(e,n){if(!this.interop)throw new Error("Control not started");return this.logger.info("sending control command "+JSON.stringify(e)+" to "+JSON.stringify(n)+"}"),this.interop.invoke(t.CONTROL_METHOD,e,n)},t.prototype.subscribe=function(t,e){this.callbacks[t]=e},t.prototype.setLocalWindow=function(t){this.myWindow=t},t.prototype.setLocalInstance=function(t){this.myInstance=t},t.prototype.onStart=function(t){return this.registry.add("started",t)},t.CONTROL_METHOD="GC.Control",t}(),gr=function(){function t(t,e,n,i,r){this.id=t,this.name=e,this.window=n,this.control=i,this.interop=r,this.context={},this.registry=vr(),i.setLocalWindow(this)}return t.prototype.getURL=function(){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(t){return[2,this.window.location.href]}))}))},t.prototype.moveResize=function(t){var e=t.left,n=t.top,i=t.width,r=t.height;return Vi(this,void 0,void 0,(function(){return Ji(this,(function(t){return e=null!=e?e:window.screenLeft,n=null!=n?n:window.screenTop,i=null!=i?i:window.outerWidth,r=null!=r?r:window.outerHeight,window.moveTo(e,n),window.resizeTo(i,r),[2,this]}))}))},t.prototype.close=function(){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(t){if(!this.parent)throw new Error("can not close window if it's not opened by script");try{window.close()}catch(t){console.log("what")}return[2,this]}))}))},t.prototype.setTitle=function(t){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(e){return"object"==typeof t&&null!==t&&(t=t.title),document.title=t,[2,this]}))}))},t.prototype.resizeTo=function(t,e){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(n){switch(n.label){case 0:return[4,this.moveResize({width:t,height:e})];case 1:return n.sent(),[2,this]}}))}))},t.prototype.moveTo=function(t,e){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(n){switch(n.label){case 0:return[4,this.moveResize({top:t,left:e})];case 1:return n.sent(),[2,this]}}))}))},t.prototype.focus=function(){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(t){return window.focus(),[2,this]}))}))},t.prototype.getBounds=function(){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(t){return[2,this.getBoundsSync()]}))}))},t.prototype.getContext=function(){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(t){return[2,this.getContextSync()]}))}))},t.prototype.getContextSync=function(){return this.context},t.prototype.getTitle=function(){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(t){return[2,this.window.document.title]}))}))},t.prototype.onContextUpdated=function(t){return this.registry.add("context-updated",t)},t.prototype.updateContext=function(t){var e=this.context;return this.context=Object.assign({},e,t),this.registry.execute("context-updated",this.context,e),Promise.resolve(this)},t.prototype.setContext=function(t){return Vi(this,void 0,void 0,(function(){var e;return Ji(this,(function(n){return e=this.context,this.context=Object.assign({},t),this.registry.execute("context-updated",t,e),[2,Promise.resolve(this)]}))}))},t.prototype.getBoundsSync=function(){return{left:this.window.screenLeft,top:this.window.screenTop,width:this.window.outerWidth,height:this.window.outerHeight}},t}(),mr=function(t){function e(e,n,i,r,o){var s=t.call(this,n,i,r,o)||this;return s.window=e,s.id=n,s.name=i,s}return function(t,e){function n(){this.constructor=t}Hi(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}(e,t),e}(fr),wr=function(t){return"GC.Wnd."+t},br=function(t,e,n,i,r){return Vi(void 0,void 0,void 0,(function(){var o,s,a;return Ji(this,(function(c){switch(c.label){case 0:return o=wr(n),s={context:null!==(a=null==r?void 0:r.context)&&void 0!==a?a:{},name:i,parent:e},[4,t.register(o,(function(){return s}))];case 1:return c.sent(),[2]}}))}))},_r=function(t,e,n){return Vi(void 0,void 0,void 0,(function(){var i,r,o;return Ji(this,(function(s){switch(s.label){case 0:return i=wr(t.id),e.methods().find((function(t){return t.name===i}))?[4,e.invoke(i)]:[3,2];case 1:r=s.sent(),t&&(o=r.returned.context,t.setContext(o),t.name=r.returned.name,t.parent=r.returned.parent,n&&(n.startedByScript=!0,n.context=o)),s.label=2;case 2:return[2]}}))}))},Ir=function(){function t(t,e){this.interop=t,this.control=e,this.registry=vr(),this.childWindows=[];var n=t.instance.windowId,i="document.title ("+hr()+")";this.myWindow=new gr(n,i,window,this.control,this.interop),this.trackWindowsLifetime()}return t.prototype.list=function(){var t=this,e=this.interop.methods({name:yr.CONTROL_METHOD})[0];return e?(e.getServers?e.getServers():[]).reduce((function(e,n){var i=t.remoteFromServer(n);return i&&e.push(i),e}),[]):[]},t.prototype.findById=function(t){return this.list().find((function(e){return e.id===t}))},t.prototype.my=function(){return this.myWindow},t.prototype.open=function(t,e,n){var i,r,o,s,a;return Vi(this,void 0,void 0,(function(){var c,u,d,p,h,f,l,v,y,g,m,w,b;return Ji(this,(function(_){switch(_.label){case 0:return c=null!==(i=null==n?void 0:n.width)&&void 0!==i?i:400,u=null!==(r=null==n?void 0:n.height)&&void 0!==r?r:400,d=null!==(o=null==n?void 0:n.left)&&void 0!==o?o:window.screen.availWidth-window.screenLeft,p=null!==(s=null==n?void 0:n.top)&&void 0!==s?s:0,h=hr(),[4,br(this.interop,this.my().id,h,t,n)];case 1:return _.sent(),(null==n?void 0:n.relativeTo)?(f=n.relativeTo,(l=this.list().find((function(t){return t.id===f})))?[4,l.getBounds()]:[3,3]):[3,3];case 2:v=_.sent(),y=null!==(a=n.relativeDirection)&&void 0!==a?a:"right",g=this.getRelativeBounds({width:c,height:u,left:d,top:p},v,y),c=g.width,u=g.height,d=g.left,p=g.top,_.label=3;case 3:if(m="width="+c+",height="+u+",left="+d+",top="+p+",scrollbars=none,location=no,status=no,menubar=no",!(w=window.open(e,h,m)))throw new Error("failed to open a window with url="+e+" and options="+m);return w.focus(),w.moveTo(d,p),w.resizeTo(c,u),b=new mr(w,h,t,this.control,this),this.childWindows.push(b),[2,b]}}))}))},t.prototype.onWindowAdded=function(t){return this.registry.add("window-added",t)},t.prototype.onWindowRemoved=function(t){return this.registry.add("window-removed",t)},t.prototype.getChildWindows=function(){return this.childWindows=this.childWindows.filter((function(t){return!t.window.closed})),this.childWindows},t.prototype.remoteFromServer=function(t){var e;if(t.windowId)return new fr(t.windowId,null!==(e=t.application)&&void 0!==e?e:"",this.control,this)},t.prototype.getRelativeBounds=function(t,e,n){switch(n){case"bottom":return{left:e.left,top:e.top+e.height+0,width:e.width,height:t.height};case"top":return{left:e.left,top:e.top-t.height-0,width:e.width,height:t.height};case"right":return{left:e.left+e.width+0,top:e.top,width:t.width,height:e.height};case"left":return{left:e.left-t.width-0,top:e.top,width:t.width,height:e.height};default:throw new Error("invalid relativeDirection")}},t.prototype.trackWindowsLifetime=function(){var t=this;this.interop.serverMethodAdded((function(e){var n=e.server;if(e.method.name===yr.CONTROL_METHOD){var i=t.remoteFromServer(n);i&&t.registry.execute("window-added",i)}})),this.interop.serverRemoved((function(e){var n=t.remoteFromServer(e);n&&t.registry.execute("window-removed",n)}))},t}(),Sr=function(t){return{ok:!0,result:t}},xr=function(t){return{ok:!1,error:t}},kr=function(t){return!0===t.ok?Promise.resolve(t.result):Promise.reject(t.error)},Cr=function(t,e){return!0===e.ok?e.result:t},Ar=function(t){if(!0===t.ok)return t.result;throw t.error},Tr=function(t,e){return!0===e.ok?Sr(t(e.result)):e},Pr=function(t,e,n){return!1===e.ok?e:!1===n.ok?n:Sr(t(e.result,n.result))},Mr=function(t,e){return!0===e.ok?e:xr(t(e.error))},jr=function(t,e){return!0===e.ok?t(e.result):e},Er=(Object.freeze({ok:Sr,isOk:function(t){return!0===t.ok},err:xr,isErr:function(t){return!1===t.ok},asPromise:kr,withDefault:Cr,withException:Ar,successes:function(t){return t.reduce((function(t,e){return!0===e.ok?t.concat(e.result):t}),[])},map:Tr,map2:Pr,mapError:Mr,andThen:jr}),function(){return(Er=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)});function Or(t,e){if(t===e)return!0;if(null===t&&null===e)return!0;if(typeof t!=typeof e)return!1;if("object"==typeof t){if(Array.isArray(t)){if(!Array.isArray(e))return!1;if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!Or(t[n],e[n]))return!1;return!0}var i=Object.keys(t);if(i.length!==Object.keys(e).length)return!1;for(n=0;n<i.length;n++){if(!e.hasOwnProperty(i[n]))return!1;if(!Or(t[i[n]],e[i[n]]))return!1}return!0}}var Rr=function(t){return Array.isArray(t)},Nr=function(t){return"object"==typeof t&&null!==t&&!Rr(t)},Lr=function(t,e){return"expected "+t+", got "+function(t){switch(typeof t){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return t instanceof Array?"an array":null===t?"null":"an object";default:return JSON.stringify(t)}}(e)},Wr=function(t){return t.map((function(t){return"string"==typeof t?"."+t:"["+t+"]"})).join("")},Dr=function(t,e){var n=e.at,i=function(t,e){var n={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(n[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(t);r<i.length;r++)e.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(t,i[r])&&(n[i[r]]=t[i[r]])}return n}(e,["at"]);return Er({at:t+(n||"")},i)},Fr=function(){function t(e){var n=this;this.decode=e,this.run=function(t){return Mr((function(e){return{kind:"DecoderError",input:t,at:"input"+(e.at||""),message:e.message||""}}),n.decode(t))},this.runPromise=function(t){return kr(n.run(t))},this.runWithException=function(t){return Ar(n.run(t))},this.map=function(e){return new t((function(t){return Tr(e,n.decode(t))}))},this.andThen=function(e){return new t((function(t){return jr((function(n){return e(n).decode(t)}),n.decode(t))}))},this.where=function(e,i){return n.andThen((function(n){return e(n)?t.succeed(n):t.fail(i)}))}}return t.string=function(){return new t((function(t){return"string"==typeof t?Sr(t):xr({message:Lr("a string",t)})}))},t.number=function(){return new t((function(t){return"number"==typeof t?Sr(t):xr({message:Lr("a number",t)})}))},t.boolean=function(){return new t((function(t){return"boolean"==typeof t?Sr(t):xr({message:Lr("a boolean",t)})}))},t.constant=function(e){return new t((function(t){return Or(t,e)?Sr(e):xr({message:"expected "+JSON.stringify(e)+", got "+JSON.stringify(t)})}))},t.object=function(e){return new t((function(t){if(Nr(t)&&e){var n={};for(var i in e)if(e.hasOwnProperty(i)){var r=e[i].decode(t[i]);if(!0!==r.ok)return void 0===t[i]?xr({message:"the key '"+i+"' is required but was not present"}):xr(Dr("."+i,r.error));void 0!==r.result&&(n[i]=r.result)}return Sr(n)}return Nr(t)?Sr(t):xr({message:Lr("an object",t)})}))},t.array=function(e){return new t((function(t){if(Rr(t)&&e){return t.reduce((function(t,n,i){return Pr((function(t,e){return t.concat([e])}),t,function(t,n){return Mr((function(t){return Dr("["+n+"]",t)}),e.decode(t))}(n,i))}),Sr([]))}return Rr(t)?Sr(t):xr({message:Lr("an array",t)})}))},t.tuple=function(e){return new t((function(t){if(Rr(t)){if(t.length!==e.length)return xr({message:"expected a tuple of length "+e.length+", got one of length "+t.length});for(var n=[],i=0;i<e.length;i++){var r=e[i].decode(t[i]);if(!r.ok)return xr(Dr("["+i+"]",r.error));n[i]=r.result}return Sr(n)}return xr({message:Lr("a tuple of length "+e.length,t)})}))},t.union=function(e,n){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];return t.oneOf.apply(t,[e,n].concat(i))},t.intersection=function(e,n){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];return new t((function(t){return[e,n].concat(i).reduce((function(e,n){return Pr(Object.assign,e,n.decode(t))}),Sr({}))}))},t.anyJson=function(){return new t((function(t){return Sr(t)}))},t.unknownJson=function(){return new t((function(t){return Sr(t)}))},t.dict=function(e){return new t((function(t){if(Nr(t)){var n={};for(var i in t)if(t.hasOwnProperty(i)){var r=e.decode(t[i]);if(!0!==r.ok)return xr(Dr("."+i,r.error));n[i]=r.result}return Sr(n)}return xr({message:Lr("an object",t)})}))},t.optional=function(e){return new t((function(t){return void 0===t?Sr(void 0):e.decode(t)}))},t.oneOf=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return new t((function(t){for(var n=[],i=0;i<e.length;i++){var r=e[i].decode(t);if(!0===r.ok)return r;n[i]=r.error}var o=n.map((function(t){return"at error"+(t.at||"")+": "+t.message})).join('", "');return xr({message:'expected a value matching one of the decoders, got the errors ["'+o+'"]'})}))},t.withDefault=function(e,n){return new t((function(t){return Sr(Cr(e,n.decode(t)))}))},t.valueAt=function(e,n){return new t((function(t){for(var i=t,r=0;r<e.length;r++){if(void 0===i)return xr({at:Wr(e.slice(0,r+1)),message:"path does not exist"});if("string"==typeof e[r]&&!Nr(i))return xr({at:Wr(e.slice(0,r+1)),message:Lr("an object",i)});if("number"==typeof e[r]&&!Rr(i))return xr({at:Wr(e.slice(0,r+1)),message:Lr("an array",i)});i=i[e[r]]}return Mr((function(t){return void 0===i?{at:Wr(e),message:"path does not exist"}:Dr(Wr(e),t)}),n.decode(i))}))},t.succeed=function(e){return new t((function(t){return Sr(e)}))},t.fail=function(e){return new t((function(t){return xr({message:e})}))},t.lazy=function(e){return new t((function(t){return e().decode(t)}))},t}(),Br=Fr.string,Gr=Fr.number,qr=Fr.boolean,Hr=Fr.anyJson,Ur=Fr.constant,Vr=Fr.object,Jr=Fr.array,zr=Fr.optional,Kr=Fr.oneOf,Yr=Fr.lazy,Zr=Br().where((function(t){return t.length>0}),"Expected a non-empty string"),Qr=Vr({type:Ur("window"),config:Vr({appName:Zr,url:zr(Zr)})}),Xr=Vr({type:Ur("group"),config:Hr(),children:Jr(Kr(Qr))}),$r=Vr({type:Ur("column"),config:Hr(),children:Jr(Kr(Xr,Qr,Yr((function(){return $r})),Yr((function(){return to}))))}),to=Vr({type:Ur("row"),config:Hr(),children:Jr(Kr($r,Xr,Qr,Yr((function(){return to}))))}),eo=Vr({type:Ur("Workspace"),state:Vr({config:Hr(),context:Hr(),children:Jr(Kr(to,$r,Xr,Qr))})}),no=Vr({type:Ur("window"),componentType:Ur("application"),state:Vr({name:Hr(),context:Hr(),url:Zr,bounds:Hr(),id:Zr,parentId:zr(Zr),main:qr()})}),io=Kr(Ur("Global"),Ur("Workspace")),ro=Vr({name:Zr,context:zr(Hr()),metadata:zr(Hr())}),oo=Vr({name:Zr,context:zr(Hr()),closeRunningInstance:zr(qr())}),so=Vr({name:Zr,type:io,context:zr(Hr()),metadata:zr(Hr()),components:Jr(Kr(eo,no))}),ao=function(){function t(t){this.controller=t}return t.prototype.ready=function(){return this.controller.ready()},t.prototype.getAll=function(t){return io.runWithException(t),this.controller.getAll(t)},t.prototype.get=function(t,e){return Zr.runWithException(t),io.runWithException(e),this.controller.get(t,e)},t.prototype.export=function(t){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(e){return t&&io.runWithException(t),[2,this.controller.export(t)]}))}))},t.prototype.import=function(t){return t.forEach((function(t){return so.runWithException(t)})),this.controller.import(t)},t.prototype.save=function(t){return ro.runWithException(t),this.controller.save(t)},t.prototype.restore=function(t){return oo.runWithException(t),this.controller.restore(t)},t.prototype.remove=function(t,e){return Zr.runWithException(e),io.runWithException(t),this.controller.remove(t,e)},t.prototype.onAdded=function(t){if("function"!=typeof t)throw new Error("The provided callback must be of type 'function'");return this.controller.onLayoutAdded(t)},t.prototype.onChanged=function(t){if("function"!=typeof t)throw new Error("The provided callback must be of type 'function'");return this.controller.onLayoutChanged(t)},t.prototype.onRemoved=function(t){if("function"!=typeof t)throw new Error("The provided callback must be of type 'function'");return this.controller.onLayoutRemoved(t)},t}(),co="___channel___",uo=function(){function t(t){this.contexts=t,this.setContextDataToEmptyObjIfMissing=function(t){return Ui(Ui({},t),{data:t.data||{}})}}return t.prototype.subscribe=function(t){this.callback=t},t.prototype.subscribeFor=function(t,e){var n=this;if(!this.isChannel(t))return Promise.reject(new Error("Channel with name: "+t+" doesn't exist!"));var i=this.createContextName(t);return this.contexts.subscribe(i,(function(t,i,r,o,s){var a=n.setContextDataToEmptyObjIfMissing(t);e(a.data,a,null==s?void 0:s.updaterId)}))},t.prototype.switchChannel=function(t){return Vi(this,void 0,void 0,(function(){var e,n,i=this;return Ji(this,(function(r){switch(r.label){case 0:return this.unsubscribe(),e=this.createContextName(t),n=this,[4,this.contexts.subscribe(e,(function(t,e,n,r,o){var s=i.setContextDataToEmptyObjIfMissing(t);i.callback&&i.callback(s.data,s,null==o?void 0:o.updaterId)}))];case 1:return n.unsubscribeFunc=r.sent(),[2]}}))}))},t.prototype.unsubscribe=function(){this.unsubscribeFunc&&this.unsubscribeFunc()},t.prototype.add=function(t,e){var n=this.createContextName(t);return this.contexts.set(n,e)},t.prototype.all=function(){return this.contexts.all().filter((function(t){return t.startsWith(co)})).map((function(t){return t.substr(co.length)}))},t.prototype.getContextData=function(t){var e=this;return new Promise((function(n,i){if(!e.isChannel(t))return i(new Error("A channel with name: "+t+" doesn't exist!"));var r=e.createContextName(t);e.contexts.subscribe(r,(function(t){var i=e.setContextDataToEmptyObjIfMissing(t);n(i)})).then((function(t){return t()}))}))},t.prototype.updateChannel=function(t,e){var n=this.createContextName(t),i={name:e.name,meta:e.meta};return(null==e?void 0:e.data)&&!this.isEmptyObject(e.data)&&(i.data=e.data),this.contexts.update(n,i)},t.prototype.updateData=function(t,e){var n=this.createContextName(t);if(this.contexts.setPathSupported){var i=Object.keys(e).map((function(t){return{path:"data."+t,value:e[t]}}));return this.contexts.setPaths(n,i)}return this.contexts.update(n,{data:e})},t.prototype.isChannel=function(t){return this.all().some((function(e){return e===t}))},t.prototype.createContextName=function(t){return"___channel___"+t},t.prototype.isEmptyObject=function(t){return 0===Object.keys(t).length&&t.constructor===Object},t}(),po=function(){function t(t,e){var n=this;this.subsKey="subs",this.changedKey="changed",this.registry=vr(),this.shared=new uo(t),this.shared.subscribe(this.handler.bind(this)),this.readyPromise=Promise.resolve(null==e?void 0:e.reduce((function(t,e){return t.then((function(){return n.add(e)}))}),Promise.resolve({})))}return t.prototype.subscribe=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.subsKey,t)},t.prototype.subscribeFor=function(t,e){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(n){switch(n.label){case 0:if("string"!=typeof t)throw new Error("Please provide the name as a string!");if("function"!=typeof e)throw new Error("Please provide the callback as a function!");return[4,this.shared.subscribeFor(t,e)];case 1:return[2,n.sent()]}}))}))},t.prototype.publish=function(t,e){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(n){if("object"!=typeof t)throw new Error("Please provide the data as an object!");if(e){if("string"!=typeof e)throw new Error("Please provide the name as a string!");if(!this.shared.isChannel(e))throw new Error("A channel with name: "+e+" doesn't exist!");return[2,this.shared.updateData(e,t)]}if(!this.currentContext)throw new Error("Not joined to any channel!");return[2,this.shared.updateData(this.currentContext,t)]}))}))},t.prototype.all=function(){var t=this.shared.all();return Promise.resolve(t)},t.prototype.list=function(){return Vi(this,void 0,void 0,(function(){var t,e=this;return Ji(this,(function(n){switch(n.label){case 0:return[4,this.all()];case 1:return t=n.sent(),[4,Promise.all(t.map((function(t){return e.get(t)})))];case 2:return[2,n.sent()]}}))}))},t.prototype.get=function(t){return"string"!=typeof t?Promise.reject(new Error("Please provide the channel name as a string!")):this.shared.getContextData(t)},t.prototype.join=function(t){return Vi(this,void 0,void 0,(function(){var e,n=this;return Ji(this,(function(i){switch(i.label){case 0:if("string"!=typeof t)throw new Error("Please provide the channel name as a string!");return(e=function(t){return n.shared.all().includes(t)})(t)?[3,2]:[4,new Promise((function(n,i){var r,o=setInterval((function(){e(t)&&(clearTimeout(r),clearInterval(o),n())}),100);r=setTimeout((function(){return clearInterval(o),i(new Error("A channel with name: "+t+" doesn't exist!"))}),3e3)}))];case 1:i.sent(),i.label=2;case 2:return this.currentContext=t,[4,this.shared.switchChannel(t)];case 3:return i.sent(),this.registry.execute(this.changedKey,t),[2]}}))}))},t.prototype.leave=function(){return this.currentContext=void 0,this.registry.execute(this.changedKey,void 0),this.shared.unsubscribe(),Promise.resolve()},t.prototype.current=function(){return this.currentContext},t.prototype.my=function(){return this.current()},t.prototype.changed=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.changedKey,t)},t.prototype.onChanged=function(t){return this.changed(t)},t.prototype.add=function(t){return Vi(this,void 0,void 0,(function(){var e;return Ji(this,(function(n){switch(n.label){case 0:if("object"!=typeof t)throw new Error("Please provide the info as an object!");if(void 0===t.name)throw new Error("info.name is missing!");if("string"!=typeof t.name)throw new Error("Please provide the info.name as a string!");if(void 0===t.meta)throw new Error("info.meta is missing!");if("object"!=typeof t.meta)throw new Error("Please provide the info.meta as an object!");if(void 0===t.meta.color)throw new Error("info.meta.color is missing!");if("string"!=typeof t.meta.color)throw new Error("Please provide the info.meta.color as a string!");return e={name:t.name,meta:t.meta,data:t.data||{}},[4,this.shared.updateChannel(t.name,e)];case 1:return n.sent(),[2,e]}}))}))},t.prototype.ready=function(){return this.readyPromise},t.prototype.handler=function(t,e,n){this.registry.execute(this.subsKey,t,e,n)},t}(),ho=function(t,e){return void 0===e&&(e=3e3),new Promise((function(n,i){var r=!1,o=setTimeout((function(){r=!0,i(new Error("Fetch request for: "+t+" timed out at: "+e+" milliseconds"))}),e);fetch(t).then((function(t){r||(clearTimeout(o),n(t))})).catch((function(t){r||(clearTimeout(o),i(t))}))}))},fo=function(t,e,n){return new Promise((function(i,r){var o=setTimeout((function(){r(n||"Promise timeout hit: "+e)}),e);t().then((function(t){clearTimeout(o),i(t)})).catch((function(t){clearTimeout(o),r(t)}))}))},lo=function(){function t(t,e,n){var i,r,o,s,a=this;if(this._appManager=t,this._props=e,this._windows=n,this._registry=vr(),this.start=function(t,e){if(void 0!==t&&"object"!=typeof t)throw new Error("Please provide the context as an object!");if(void 0!==e&&"object"!=typeof e)throw new Error("Please provide the options as an object!");return fo((function(){return a.startWithoutTimeout(t,e)}),3e3,'Application "'+a.name+'" start timeout!')},void 0===(null===(i=null==e?void 0:e.userProperties)||void 0===i?void 0:i.manifest))this._url=null===(o=null===(r=null==e?void 0:e.userProperties)||void 0===r?void 0:r.details)||void 0===o?void 0:o.url;else{var c=JSON.parse(e.userProperties.manifest);this._url=(null===(s=c.details)||void 0===s?void 0:s.url)||c.url}t.onInstanceStarted((function(t){t.application.name===a.name&&a._registry.execute("instanceStarted",t)})),t.onInstanceStopped((function(t){t.application.name===a.name&&a._registry.execute("instanceStopped",t)}))}return Object.defineProperty(t.prototype,"name",{get:function(){return this._props.name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._props.title||""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return this._props.version||""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"icon",{get:function(){return this._props.icon||""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"caption",{get:function(){return this._props.caption||""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"userProperties",{get:function(){return this._props.userProperties||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return e.application.name===t.name}))},enumerable:!0,configurable:!0}),t.prototype.onInstanceStarted=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");this._registry.add("instanceStarted",t)},t.prototype.onInstanceStopped=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");this._registry.add("instanceStopped",t)},t.prototype.updateFromProps=function(t){var e,n,i=this,r=void 0!==(null===(e=null==t?void 0:t.userProperties)||void 0===e?void 0:e.manifest)?JSON.parse(null==t?void 0:t.userProperties.manifest).url:null===(n=null==t?void 0:t.userProperties)||void 0===n?void 0:n.details.url;this._url=r,Object.keys(t).forEach((function(e){i._props[e]=t[e]}))},t.prototype.startWithoutTimeout=function(t,e){var n,i;return Vi(this,void 0,void 0,(function(){var r,o,s,a,c,u,d,p=this;return Ji(this,(function(h){switch(h.label){case 0:if(r=Ui(Ui(Ui({},null===(i=null===(n=this._props)||void 0===n?void 0:n.userProperties)||void 0===i?void 0:i.details),e),{context:t||(null==e?void 0:e.context)}),!this._url)throw new Error("Application "+this.name+" doesn't have a URL.");return c={},u=function(){if(void 0!==o){var t=c[o.id];if(void 0!==t)return s(),a(t)}},d=new Promise((function(t){a=t,s=p._appManager.onInstanceStarted((function(t){var e=t.agm.windowId;void 0!==e&&(c[e]=t,u())}))})),[4,this._windows.open(this.name,this._url,r)];case 1:return o=h.sent(),u(),[2,d]}}))}))},t}(),vo=function(){function t(t,e,n,i,r,o){var s=this;this.id=t,this.application=e,this.control=n,this.agm=i,this.appManager=r,this.window=o,this.WINDOW_DID_NOT_HAVE_TIME_TO_RESPOND="Peer has left while waiting for result";var a=n.onStart((function(){var t;null===(t=s.window)||void 0===t||t.getContext().then((function(t){a(),s.context=t}))}))}return t.prototype.stop=function(){var t=this,e=new Promise((function(e,n){t.appManager.onInstanceStopped((function(n){n.id===t.id&&e()})),t.callControl("stop",{},!1).catch((function(e){e.message!==t.WINDOW_DID_NOT_HAVE_TIME_TO_RESPOND&&n(e)}))}));return fo((function(){return e}),1e4,"Instance "+this.id+" stop timeout!")},t.prototype.callControl=function(t,e,n){return void 0===n&&(n=!1),this.control.send({command:t,domain:"appManager",args:e,skipResult:n},{instance:this.id})},t}(),yo=function(){function t(t,e,n){this.id=t,this.control=e,this.agm=n,this.context={},this.startedByScript=!1,this.application=void 0,this.control.setLocalInstance(this)}return t.prototype.stop=function(){var t=this;return new Promise((function(e,n){t.startedByScript?(e(),window.close()):n("Can't close a window that wasn't started by a script.")}))},t}(),go=Br().where((function(t){return t.length>0}),"Expected a non-empty string"),mo=Vr({url:zr(go)}),wo=Vr({icon:zr(go)}),bo=Vr({name:go,displayName:zr(Br()),contexts:zr(Jr(Br())),customConfig:zr(Vr())}),_o=Vr({url:zr(go),top:zr(Gr()),left:zr(Gr()),width:zr(Gr()),height:zr(Gr()),context:zr(Hr()),relativeTo:zr(go),relativeDirection:zr(Kr(Ur("top"),Ur("left"),Ur("right"),Ur("bottom")))}),Io=Vr({name:go,title:zr(Br()),version:zr(Br()),appId:go,manifest:go,manifestType:go,tooltip:zr(Br()),description:zr(Br()),contactEmail:zr(Br()),supportEmail:zr(Br()),publisher:zr(Br()),images:zr(Jr(mo)),icons:zr(Jr(wo)),customConfig:zr(Vr()),intents:zr(Jr(bo))}),So=Vr({name:go,title:zr(Br()),version:zr(Br()),details:_o,customProperties:zr(Vr()),icon:zr(Br()),caption:zr(Br())}),xo=function(){function t(t,e,n,i,r){var o,s,a=this;this.windows=t,this.interop=e,this.control=n,this.config=i,this.appName=r,this._apps={},this._instances=[],this.registry=vr(),this.DEFAULT_POLLING_INTERVAL=3e3,this.DEFAULT_REQUEST_TIMEOUT=3e3,this.OKAY_MESSAGE="OK",this.LOCAL_SOURCE="LOCAL_SOURCE";var c=e.instance.instance;if(this._myInstance=new yo(c,this.control,this.interop.instance),(null===(o=this.config)||void 0===o?void 0:o.remoteSources)&&(this.readyPromise=this.subscribeForRemoteApplications(this.config.remoteSources).then((function(){return a.trackInstanceLifetime()}))),null===(s=this.config)||void 0===s?void 0:s.localApplications){var u=this.getValidatedApplications(this.config.localApplications);this.addApplications(u)}}return Object.defineProperty(t.prototype,"myInstance",{get:function(){return this.appName||console.warn("application wasn't provided to the GlueWeb factory function!"),this._myInstance||console.warn("The application isn't defined in any of the local/remote application sources!"),this._myInstance},enumerable:!0,configurable:!0}),t.prototype.application=function(t){var e;if("string"!=typeof t)throw new Error("Please provide the name as a string!");return null===(e=this._apps[t])||void 0===e?void 0:e.application},t.prototype.applications=function(){var t=this;return Object.keys(this._apps).map((function(e){return t._apps[e].application}))},t.prototype.instances=function(){return this._instances},t.prototype.onAppAdded=function(t){var e=this;if("function"!=typeof t)throw new Error("Please provide the callback as a function!");var n=Object.keys(this._apps).map((function(t){return e._apps[t].application}));return this.registry.add("appAdded",t,n)},t.prototype.onAppRemoved=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add("appRemoved",t)},t.prototype.onAppChanged=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add("appChanged",t)},t.prototype.onInstanceStarted=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add("instanceStarted",t,this._instances)},t.prototype.onInstanceStopped=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add("instanceStopped",t)},t.prototype.ready=function(){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,this.readyPromise];case 1:return t.sent(),[3,3];case 2:return t.sent(),[3,3];case 3:return[2]}}))}))},t.prototype.getValidatedApplications=function(t){return t.filter((function(t){var e;return(e=void 0!==t.manifest?Io.run(t).ok:So.run(t).ok)||console.warn('Validation failed for application "'+t.name+'"!'),e}))},t.prototype.subscribeForRemoteApplications=function(t){return Vi(this,void 0,void 0,(function(){var e,n,i,r,o,s,a=this;return Ji(this,(function(c){switch(c.label){case 0:for(e=[],n=function(t){var n=t.url,r=function(){return Vi(a,void 0,void 0,(function(){var e,i;return Ji(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),[4,ho(n,t.requestTimeout||this.DEFAULT_REQUEST_TIMEOUT)];case 1:return[4,r.sent().json()];case 2:return(e=r.sent()).message===this.OKAY_MESSAGE&&(i=this.getValidatedApplications(e.applications),this.addApplications(i,n)),[3,4];case 3:return r.sent(),console.warn("Failed to fetch apps from "+n),[3,4];case 4:return[2]}}))}))};e.push(r()),setInterval((function(){return r()}),t.pollingInterval||i.DEFAULT_POLLING_INTERVAL)},i=this,r=0,o=t;r<o.length;r++)s=o[r],n(s);return[4,Promise.all(e)];case 1:return c.sent(),[2]}}))}))},t.prototype.getAppProps=function(t){var e=["name","title","version","customProperties","icon","caption"],n=Object.fromEntries(Object.entries(t).filter((function(t){var n=t[0];return!e.includes(n)})));return{name:t.name,title:t.title,version:t.version,icon:t.icon,caption:t.caption,userProperties:Ui(Ui({},n),t.customProperties)}},t.prototype.handleAppsChanged=function(t,e){for(var n=this,i=function(t){var i=Object.keys(r._apps).find((function(i){return i===t.name&&n._apps[i].source===e})),o=Object.keys(r._apps).find((function(i){return i===t.name&&n._apps[i].source!==e}));if(i){var s=r._apps[i],a=r.getAppProps(t);if(JSON.stringify(s.appProps)!==JSON.stringify(a)){var c=new lo(r,a,r.windows);r.registry.execute("appChanged",c),r._apps[t.name]={source:s.source,application:c,appProps:a}}}else o&&console.warn('Application "'+t.name+'" already defined by source "'+r._apps[o].source+'". Skipping application definition from source '+e+".")},r=this,o=0,s=t;o<s.length;o++){i(s[o])}},t.prototype.handleAppsAdded=function(t,e){for(var n=Object.keys(this._apps),i=0,r=t.filter((function(t){return!n.includes(t.name)}));i<r.length;i++){var o=r[i],s=this.getAppProps(o),a=new lo(this,s,this.windows);this.registry.execute("appAdded",a),this._apps[o.name]={source:e||this.LOCAL_SOURCE,application:a,appProps:s}}},t.prototype.handleAppsRemoved=function(t,e){for(var n=this,i=Object.keys(this._apps).filter((function(t){return n._apps[t].source===e})).map((function(t){return n._apps[t].application})),r=t.map((function(t){return t.name})),o=0,s=i.filter((function(t){return!r.includes(t.name)}));o<s.length;o++){var a=s[o];this.registry.execute("appRemoved",a),delete this._apps[a.name]}},t.prototype.tryPopulateMyInstanceApplication=function(){var t,e=this;if(this.appName){var n=null===(t=Object.values(this._apps).find((function(t){return t.application.name===e.appName})))||void 0===t?void 0:t.application;n&&(n.title&&(document.title=n.title),this._myInstance.application=n)}},t.prototype.addApplications=function(t,e){this.handleAppsChanged(t,e),this.handleAppsAdded(t,e),this.handleAppsRemoved(t,e),this._myInstance.application||this.tryPopulateMyInstanceApplication()},t.prototype.remoteFromServer=function(t){var e=t.application;if(t.instance&&e&&this._apps[e]){var n=t.instance,i=this._apps[e].application,r=this.windows.list().find((function(e){return e.id===t.windowId}));return new vo(n,i,this.control,t,this,r)}},t.prototype.trackInstanceLifetime=function(){var t=this;this.interop.serverMethodAdded((function(e){var n=e.server;if(e.method.name===yr.CONTROL_METHOD){var i=t.remoteFromServer(n);if(i){if(t._instances.some((function(t){return t.id===i.id})))return;t._instances.push(i),t.registry.execute("instanceStarted",i)}}})),this.interop.serverRemoved((function(e){var n=e.instance;if(n){var i=t._instances.find((function(t){return t.id===n}));i&&(t._instances=t._instances.filter((function(t){return t.id!==i.id})),t.registry.execute("instanceStopped",i))}}))},t}(),ko=Br().where((function(t){return t.length>0}),"Expected a non-empty string"),Co=Vr({url:zr(ko),top:zr(Gr()),left:zr(Gr()),width:zr(Gr()),height:zr(Gr()),context:zr(Hr()),relativeTo:zr(ko),relativeDirection:zr(Kr(Ur("top"),Ur("left"),Ur("right"),Ur("bottom")))}),Ao=Vr({type:zr(ko),data:zr(Vr())}),To=zr(Kr(Vr({name:zr(Br()),contextType:zr(Br())}),ko)),Po=Kr(Vr({intent:ko,contextTypes:zr(Jr(Br())),displayName:zr(Br())}),ko),Mo=Kr(Vr({intent:ko,target:zr(Kr(Ur("startNew"),Ur("reuse"),Vr({app:zr(Br()),instance:zr(Br())}))),context:zr(Ao),options:zr(Co)}),ko),jo="Tick42.FDC3.Intents.",Eo=function(){function t(t,e,n){this.interop=t,this.windows=e,this.appManager=n}return t.prototype.find=function(t){return Vi(this,void 0,void 0,(function(){var e,n;return Ji(this,(function(i){switch(i.label){case 0:return To.runWithException(t),[4,this.all()];case 1:return e=i.sent(),void 0===t?[2,e]:"string"==typeof t?[2,e.filter((function(e){return e.name===t}))]:(t.contextType&&(n=t.contextType.toLowerCase(),e=e.filter((function(t){return t.handlers.some((function(t){var e;return null===(e=t.contextTypes)||void 0===e?void 0:e.some((function(t){return t.toLowerCase()===n}))}))}))),t.name&&(e=e.filter((function(e){return e.name===t.name}))),[2,e])}}))}))},t.prototype.raise=function(t){return Vi(this,void 0,void 0,(function(){var e,n,i,r,o,s,a,c,u;return Ji(this,(function(d){switch(d.label){case 0:return Mo.runWithException(t),"string"==typeof t&&(t={intent:t}),e=t.intent,[4,this.get(e)];case 1:if(void 0===(n=d.sent()))throw new Error("Intent "+e+" not found.");if(i=!n.handlers.some((function(t){return"app"===t.type})),r=t.target||(i?"reuse":"startNew"),s=n.handlers.find((function(t){return"app"===t.type})),"startNew"===r)o=s;else if("reuse"===r)a=n.handlers.find((function(t){return"instance"===t.type})),o=a||s;else if(r.instance)o=n.handlers.find((function(t){return"instance"===t.type&&t.instanceId===r.instance}));else{if(!r.app)throw new Error("Invalid intent target: "+JSON.stringify(r));o=n.handlers.find((function(t){return"app"===t.type&&t.applicationName===r.app}))}if(!o)throw new Error("Can not raise intent for request "+JSON.stringify(t)+" - can not find intent handler.");return c=o.instanceId,"app"!==o.type?[3,3]:[4,this.startApp(o.applicationName,t.options)];case 2:c=d.sent(),d.label=3;case 3:return[4,this.raiseIntentToInstance(c,e,t.context)];case 4:return(u=d.sent()).request=t,u.handler=o,[2,u]}}))}))},t.prototype.all=function(){return Vi(this,void 0,void 0,(function(){var t,e,n,i,r,o,s,a,c,u,d,p,h,f,l,v=this;return Ji(this,(function(y){switch(y.label){case 0:for(t=this.appManager.applications().map((function(t){return{name:t.name,title:t.title,icon:t.icon,caption:t.caption,intents:t.userProperties.intents}})),e={},n=t.filter((function(t){return t.intents&&t.intents.length>0})),i=0,r=n;i<r.length;i++)for(o=r[i],s=0,a=o.intents;s<a.length;s++)c=a[s],(u=e[c.name])||(u={name:c.name,handlers:[]},e[c.name]=u),d={applicationName:o.name,applicationTitle:o.title,applicationDescription:o.caption,displayName:c.displayName,contextTypes:c.contexts,applicationIcon:o.icon,type:"app"},u.handlers.push(d);p=function(n){return Ji(this,(function(i){switch(i.label){case 0:return[4,Promise.all(n.getMethods().filter((function(t){return t.name.startsWith(jo)})).map((function(i){return Vi(v,void 0,void 0,(function(){var r,o,s,a,c,u,d,p;return Ji(this,(function(h){switch(h.label){case 0:if(r=i.name.replace(jo,""),(o=e[r])||(o={name:r,handlers:[]},e[r]=o),i.description)try{s=JSON.parse(i.description)}catch(t){}return(a=t.find((function(t){return t.name===n.application})))&&a.intents&&(c=a.intents.find((function(t){return t.name===r}))),[4,null==(u=this.windows.findById(n.windowId))?void 0:u.getTitle()];case 1:return d=h.sent(),p={instanceId:n.instance,applicationName:n.application,applicationIcon:(null==s?void 0:s.icon)||(null==a?void 0:a.icon),applicationTitle:null==a?void 0:a.title,applicationDescription:(null==s?void 0:s.description)||(null==a?void 0:a.caption),displayName:(null==s?void 0:s.displayName)||(null==c?void 0:c.displayName),contextTypes:(null==s?void 0:s.contextTypes)||(null==c?void 0:c.contexts),instanceTitle:d,type:"instance"},o.handlers.push(p),[2]}}))}))})))];case 1:return i.sent(),[2]}}))},h=0,f=this.interop.servers(),y.label=1;case 1:return h<f.length?(l=f[h],[5,p(l)]):[3,4];case 2:y.sent(),y.label=3;case 3:return h++,[3,1];case 4:return[2,Object.values(e)]}}))}))},t.prototype.addIntentListener=function(t,e){var n=this;if(Po.runWithException(t),"function"!=typeof e)throw new Error("Please provide the handler as a function!");var i={unsubscribe:function(){return console.log("Could not unsubscribe!")}},r="Tick42.FDC3.Intents."+("string"==typeof t?t:t.intent),o="string"==typeof t?void 0:JSON.stringify(t);return this.interop.register({name:r,description:o},(function(t){return e(t)})).then((function(){i.unsubscribe=function(){n.interop.unregister(r)}})),i},t.prototype.get=function(t){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(e){switch(e.label){case 0:return[4,this.all()];case 1:return[2,e.sent().find((function(e){return e.name===t}))]}}))}))},t.prototype.startApp=function(t,e){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(n){switch(n.label){case 0:return[4,this.appManager.application(t).start({},e)];case 1:return[2,n.sent().id]}}))}))},t.prototype.raiseIntentToInstance=function(t,e,n){return Vi(this,void 0,void 0,(function(){var i,r,o=this;return Ji(this,(function(s){switch(s.label){case 0:return i="Tick42.FDC3.Intents."+e,(r=this.interop.servers().find((function(e){return e.instance===t})))?[3,2]:[4,new Promise((function(e,n){var i,s=o.interop.serverAdded((function(n){n.instance===t&&(r=n,e(),clearTimeout(i),s())}));i=setTimeout((function(){s(),n(new Error("Can not find interop server for instance "+t))}),3e4)}))];case 1:s.sent(),s.label=2;case 2:return r.getMethods().find((function(t){return t.name===i}))?[3,4]:[4,new Promise((function(e,n){var r,s=o.interop.methodAdded((function(t){t.name===i&&(e(),clearTimeout(r),s())}));r=setTimeout((function(){s(),n(new Error("Can not find interop method "+i+" for instance "+t))}),1e4)}))];case 3:s.sent(),s.label=4;case 4:return[4,this.interop.invoke(i,n,{instance:t})];case 5:return[2,{result:s.sent().returned}]}}))}))},t}(),Oo=function(){function t(t){this.interop=t}return t.prototype.raise=function(t){return Vi(this,void 0,void 0,(function(){var e,n,i=this;return Ji(this,(function(r){switch(r.label){case 0:if(!("Notification"in window))throw new Error("this browser does not support desktop notification");return[4,"granted"===Notification.permission?Promise.resolve("granted"):"denied"===Notification.permission?Promise.reject("no permissions from user"):Notification.requestPermission()];case 1:return r.sent(),e=this.raiseUsingWebApi(t),t.clickInterop&&(n=t.clickInterop,e.onclick=function(){var t,e;i.interop.invoke(n.method,null!==(t=null==n?void 0:n.arguments)&&void 0!==t?t:{},null!==(e=null==n?void 0:n.target)&&void 0!==e?e:"best")}),[2,e]}}))}))},t.prototype.raiseUsingWebApi=function(t){return new Notification(t.title,t)},t}(),Ro="/glue",No="worker.js",Lo="glue.config.json",Wo={layouts:{autoRestore:!1,autoSaveWindowContext:!1},logger:"error",assets:{location:Ro},channels:!1,appManager:!1,libraries:[]},Do=function(t){return Vi(void 0,void 0,void 0,(function(){var e,n,i,r,o;return Ji(this,(function(s){switch(s.label){case 0:if(!1===(null===(r=t.assets)||void 0===r?void 0:r.extendConfig)||!1===t.extends)return[2,{}];e=(null===(o=t.assets)||void 0===o?void 0:o.location)?t.assets.location+"/"+Lo:"string"==typeof t.extends?t.extends:"/glue/glue.config.json",s.label=1;case 1:return s.trys.push([1,4,,5]),[4,ho(e)];case 2:return(n=s.sent()).ok?[4,n.json()]:[2,{}];case 3:return[2,null!=(i=s.sent())?i:{}];case 4:return s.sent(),[2,{}];case 5:return[2]}}))}))},Fo="T42.HC.GetSaveContext",Bo="T42.Layouts.Events",Go=function(){function t(t,e,n,i,r){var o,s;this.storage=t,this.windows=e,this.control=n,this.interop=i,this._registry=vr(),this.autoSaveContext=null!==(s=null===(o=null==r?void 0:r.layouts)||void 0===o?void 0:o.autoSaveWindowContext)&&void 0!==s&&s,this.control.subscribe("layouts",this.handleControlMessage.bind(this)),this.readyPromise=Promise.all([this.registerRequestMethods(),this.registerEventsMethod()]).then((function(){console.log("methods are live")}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.export=function(t){return Vi(this,void 0,void 0,(function(){var e,n,i;return Ji(this,(function(r){switch(r.label){case 0:return t?[2,this.storage.getAll(t)]:[4,Promise.all([this.storage.getAll("Global"),this.storage.getAll("Workspace")])];case 1:return e=r.sent(),n=e[0],i=e[1],[2,n.concat(i)]}}))}))},t.prototype.import=function(t){return Vi(this,void 0,void 0,(function(){var e=this;return Ji(this,(function(n){switch(n.label){case 0:return[4,Promise.all(t.map((function(t){return Vi(e,void 0,void 0,(function(){var e,n,i,r,o;return Ji(this,(function(s){switch(s.label){case 0:return[4,this.get(t.name,t.type)];case 1:return e=s.sent()?"layoutChanged":"layoutAdded",[4,this.storage.store(t,t.type)];case 2:s.sent(),n=this.waitHearLayout(t.name,e),i=n.eventPromise,r=n.unsubscribe,this.emitLayoutEvent(e,t),s.label=3;case 3:return s.trys.push([3,5,,6]),[4,i];case 4:return s.sent(),r(),[3,6];case 5:return o=s.sent(),r(),[2,Promise.reject(o)];case 6:return[2]}}))}))})))];case 1:return n.sent(),[2]}}))}))},t.prototype.save=function(t,e){return void 0===e&&(e=!1),Vi(this,void 0,void 0,(function(){var n,i,r,o;return Ji(this,(function(s){switch(s.label){case 0:return n=this.windows.getChildWindows().map((function(t){return t.id})),[4,this.getRemoteWindowsInfo(n)];case 1:return(i=s.sent()).push(this.getLocalLayoutComponent(t.context,!0)),r={type:"Global",name:t.name,components:i,context:t.context||{},metadata:t.metadata||{}},[4,this.get(t.name,"Global")];case 2:return o=s.sent()?"layoutChanged":"layoutAdded",e?(this.storage.storeAutoLayout(r),[3,5]):[3,3];case 3:return[4,this.storage.store(r,"Global")];case 4:s.sent(),s.label=5;case 5:return this.emitLayoutEvent(o,r),[2,r]}}))}))},t.prototype.autoSave=function(t){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(e){return[2,this.save(t,!0)]}))}))},t.prototype.restore=function(t){return Vi(this,void 0,void 0,(function(){var e;return Ji(this,(function(n){switch(n.label){case 0:return[4,this.storage.get(t.name,"Global")];case 1:if(!(e=n.sent()))throw new Error("can not find layout with name "+t.name);return this.restoreComponents(e),[2]}}))}))},t.prototype.restoreAutoSavedLayout=function(){return Vi(this,void 0,void 0,(function(){var t,e,n,i;return Ji(this,(function(r){switch(r.label){case 0:return t="_auto_"+document.location.href,[4,this.storage.getAutoLayout(t)];case 1:if(!(e=r.sent()))return[2,Promise.resolve()];if((n=this.windows.my()).parent)return[2];i=e.components.find((function(t){return t.state.main})),n.setContext(null==i?void 0:i.state.context);try{this.restoreComponents(e)}catch(t){return[2]}return[2]}}))}))},t.prototype.remove=function(t,e){return Vi(this,void 0,void 0,(function(){var n;return Ji(this,(function(i){switch(i.label){case 0:return[4,this.get(e,t)];case 1:return n=i.sent(),[4,this.storage.remove(e,t)];case 2:return i.sent(),n&&this.emitLayoutEvent("layoutRemoved",n),[2]}}))}))},t.prototype.getAll=function(t){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(e){switch(e.label){case 0:return[4,this.storage.getAll(t)];case 1:return[2,e.sent().map((function(t){return{name:t.name,type:t.type,context:t.context,metadata:t.metadata}}))]}}))}))},t.prototype.get=function(t,e){return this.storage.get(t,e)},t.prototype.getLocalLayoutComponent=function(t,e){var n;void 0===e&&(e=!1);var i=this.windows.my();try{this.autoSaveContext&&(n={windowContext:i.getContextSync()})}catch(t){}return{type:"window",componentType:"application",state:{name:i.name,context:(null==n?void 0:n.windowContext)||{},bounds:i.getBoundsSync(),url:window.document.location.href,id:i.id,parentId:i.parent,main:e}}},t.prototype.onLayoutAdded=function(t){return this._registry.add("layoutAdded",t)},t.prototype.onLayoutChanged=function(t){return this._registry.add("layoutChanged",t)},t.prototype.onLayoutRemoved=function(t){return this._registry.add("layoutRemoved",t)},t.prototype.waitHearLayout=function(t,e){var n,i=this;return{eventPromise:fo((function(){return new Promise((function(r){var o=function(e){e.name===t&&r()};n="layoutAdded"===e?i.onLayoutAdded(o):i.onLayoutChanged(o)}))}),5e3,"Timed out waiting to hear "+e+" for layout name: "+t),unsubscribe:n}},t.prototype.restoreComponents=function(t){var e=this;t.components.forEach((function(t){if("window"===t.type){var n=t.state;if(n.main)return;var i=Ui(Ui({},n.bounds),{context:n.context});e.windows.open(n.name,n.url,i)}}))},t.prototype.getRemoteWindowsInfo=function(t){return Vi(this,void 0,void 0,(function(){var e,n,i,r,o,s;return Ji(this,(function(a){switch(a.label){case 0:for(e=[],n=function(t){var n=i.interop.servers().find((function(e){return e.windowId===t}));if(!n||!n.getMethods)return"continue";if(n.getMethods().find((function(t){return t.name===Fo})))try{e.push(i.interop.invoke(Fo,{},{windowId:t}))}catch(t){}},i=this,r=0,o=t;r<o.length;r++)s=o[r],n(s);return[4,Promise.all(e)];case 1:return[2,a.sent().map((function(t){return t.returned}))]}}))}))},t.prototype.registerRequestMethods=function(){var t=this;return this.interop.register(Fo,(function(e){return t.getLocalLayoutComponent(e)}))},t.prototype.handleControlMessage=function(t){return Vi(this,void 0,void 0,(function(){var e,n,i,r=this;return Ji(this,(function(o){switch(o.label){case 0:return"saveLayoutAndClose"!==(e=t).command?[3,3]:(n=e.args,[4,this.getRemoteWindowsInfo(n.childWindows)]);case 1:return(i=o.sent()).push(n.parentInfo),[4,this.storage.storeAutoLayout({type:"Global",name:n.layoutName,components:i,context:n.context||{},metadata:n.metadata||{}})];case 2:o.sent(),n.childWindows.forEach((function(t){var e;null===(e=r.windows.findById(t))||void 0===e||e.close()})),o.label=3;case 3:return[2]}}))}))},t.prototype.registerEventsMethod=function(){var t=this;return this.interop.register(Bo,(function(e){t._registry.execute(e.event,e.layout)}))},t.prototype.emitLayoutEvent=function(t,e){this.interop.methods().some((function(t){return t.name===Bo}))&&this.interop.invoke(Bo,{event:t,layout:e},"all").catch((function(){}))},t}(),qo=function(){function t(t,e,n){this.localStore=t,this.autoStore=e,this.remoteStore=n}return t.prototype.get=function(t,e){var n;return Vi(this,void 0,void 0,(function(){var i,r;return Ji(this,(function(o){switch(o.label){case 0:return[4,null===(n=this.remoteStore)||void 0===n?void 0:n.get(t,e)];case 1:return i=o.sent(),[4,this.localStore.get(t,e)];case 2:return r=o.sent(),i&&r?[2,i]:[2,i||r]}}))}))},t.prototype.getAll=function(t){return Vi(this,void 0,void 0,(function(){var e,n,i,r,o=this;return Ji(this,(function(s){switch(s.label){case 0:return[4,Promise.all([this.localStore.getAll(t),new Promise((function(e){if(o.remoteStore)return o.remoteStore.getAll(t).then(e);e([])}))])];case 1:return e=s.sent(),n=e[0],i=e[1],r=n.filter((function(t){return!i.some((function(e){return e.name===t.name}))})),[2,i.concat(r)]}}))}))},t.prototype.store=function(t,e){var n;return Vi(this,void 0,void 0,(function(){return Ji(this,(function(i){switch(i.label){case 0:return[4,null===(n=this.remoteStore)||void 0===n?void 0:n.get(t.name,e)];case 1:if(i.sent())throw new Error("Cannot save layout with name: "+t.name+" and type: "+e+", because it is present in the remote store and is treated as readonly");return t.metadata?t.metadata.allowSave=!0:t.metadata={allowSave:!0},[4,this.localStore.store(t,e)];case 2:return i.sent(),[2]}}))}))},t.prototype.remove=function(t,e){var n;return Vi(this,void 0,void 0,(function(){return Ji(this,(function(i){switch(i.label){case 0:return[4,null===(n=this.remoteStore)||void 0===n?void 0:n.get(t,e)];case 1:if(i.sent())throw new Error("Cannot remove layout with name: "+t+" and type: "+e+", because it is present in the remote store and is treated as readonly");return[4,this.localStore.delete(t,e)];case 2:return i.sent(),[2]}}))}))},t.prototype.getAutoLayout=function(t){return this.autoStore.get(t,"Global")},t.prototype.storeAutoLayout=function(t){this.autoStore.save(t)},t}();let Ho,Uo;const Vo=new WeakMap,Jo=new WeakMap,zo=new WeakMap,Ko=new WeakMap,Yo=new WeakMap;let Zo={get(t,e,n){if(t instanceof IDBTransaction){if("done"===e)return Jo.get(t);if("objectStoreNames"===e)return t.objectStoreNames||zo.get(t);if("store"===e)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return $o(t[e])},set:(t,e,n)=>(t[e]=n,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function Qo(t){return t!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(Uo||(Uo=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(ts(this),e),$o(Vo.get(this))}:function(...e){return $o(t.apply(ts(this),e))}:function(e,...n){const i=t.call(ts(this),e,...n);return zo.set(i,e.sort?e.sort():[e]),$o(i)}}function Xo(t){return"function"==typeof t?Qo(t):(t instanceof IDBTransaction&&function(t){if(Jo.has(t))return;const e=new Promise(((e,n)=>{const i=()=>{t.removeEventListener("complete",r),t.removeEventListener("error",o),t.removeEventListener("abort",o)},r=()=>{e(),i()},o=()=>{n(t.error||new DOMException("AbortError","AbortError")),i()};t.addEventListener("complete",r),t.addEventListener("error",o),t.addEventListener("abort",o)}));Jo.set(t,e)}(t),((t,e)=>e.some((e=>t instanceof e)))(t,Ho||(Ho=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(t,Zo):t)}function $o(t){if(t instanceof IDBRequest)return function(t){const e=new Promise(((e,n)=>{const i=()=>{t.removeEventListener("success",r),t.removeEventListener("error",o)},r=()=>{e($o(t.result)),i()},o=()=>{n(t.error),i()};t.addEventListener("success",r),t.addEventListener("error",o)}));return e.then((e=>{e instanceof IDBCursor&&Vo.set(e,t)})).catch((()=>{})),Yo.set(e,t),e}(t);if(Ko.has(t))return Ko.get(t);const e=Xo(t);return e!==t&&(Ko.set(t,e),Yo.set(e,t)),e}const ts=t=>Yo.get(t);const es=["get","getKey","getAll","getAllKeys","count"],ns=["put","add","delete","clear"],is=new Map;function rs(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(is.get(e))return is.get(e);const n=e.replace(/FromIndex$/,""),i=e!==n,r=ns.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!r&&!es.includes(n))return;const o=async function(t,...e){const o=this.transaction(t,r?"readwrite":"readonly");let s=o.store;i&&(s=s.index(e.shift()));const a=await s[n](...e);return r&&await o.done,a};return is.set(e,o),o}Zo=(t=>({...t,get:(e,n,i)=>rs(e,n)||t.get(e,n,i),has:(e,n)=>!!rs(e,n)||t.has(e,n)}))(Zo);var os=function(){function t(){if(!("indexedDB"in window))throw new Error("Cannot initialize the local storage, because IndexedDb is not supported")}return Object.defineProperty(t.prototype,"database",{get:function(){var t=this;return this._database?Promise.resolve(this._database):new Promise((function(e){(function(t,e,{blocked:n,upgrade:i,blocking:r,terminated:o}={}){const s=indexedDB.open(t,e),a=$o(s);return i&&s.addEventListener("upgradeneeded",(t=>{i($o(s.result),t.oldVersion,t.newVersion,$o(s.transaction))})),n&&s.addEventListener("blocked",(()=>n())),a.then((t=>{o&&t.addEventListener("close",(()=>o())),r&&t.addEventListener("versionchange",(()=>r()))})).catch((()=>{})),a})("glue42core",1,{upgrade:t.setUpDb.bind(t)}).then((function(n){t._database=n,e(t._database)}))}))},enumerable:!0,configurable:!0}),t.prototype.getAll=function(t){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(e){switch(e.label){case 0:switch(t){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,e.sent().getAll("workspaceLayouts")];case 3:return[4,this.database];case 4:return[2,e.sent().getAll("globalLayouts")];case 5:throw new Error("The provided layout type is not recognized: "+t)}}))}))},t.prototype.delete=function(t,e){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(n){switch(n.label){case 0:switch(e){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,n.sent().delete("workspaceLayouts",t)];case 3:return[4,this.database];case 4:return[2,n.sent().delete("globalLayouts",t)];case 5:throw new Error("The provided layout type is not recognized: "+e)}}))}))},t.prototype.get=function(t,e){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(n){switch(n.label){case 0:switch(e){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,n.sent().get("workspaceLayouts",t)];case 3:return[4,this.database];case 4:return[2,n.sent().get("globalLayouts",t)];case 5:throw new Error("The provided layout type is not recognized: "+e)}}))}))},t.prototype.store=function(t,e){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(n){switch(n.label){case 0:switch(so.runWithException(t),io.runWithException(e),e){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,n.sent().put("workspaceLayouts",t,t.name)];case 3:return[4,this.database];case 4:return[2,n.sent().put("globalLayouts",t,t.name)];case 5:throw new Error("The provided layout type is not recognized: "+e)}}))}))},t.prototype.setUpDb=function(t){t.objectStoreNames.contains("workspaceLayouts")||t.createObjectStore("workspaceLayouts"),t.objectStoreNames.contains("globalLayouts")||t.createObjectStore("globalLayouts")},t}(),ss=function(){function t(t){this.storeBaseUrl=t}return t.prototype.getAll=function(t){return Vi(this,void 0,void 0,(function(){var e,n,i;return Ji(this,(function(r){switch(r.label){case 0:return io.runWithException(t),e=this.storeBaseUrl+"/glue.layouts.json",[4,ho(e)];case 1:if(!(n=r.sent()).ok)return[2,[]];r.label=2;case 2:return r.trys.push([2,4,,5]),[4,n.json()];case 3:return i=r.sent(),[3,5];case 4:return r.sent(),[2,[]];case 5:return i?[2,(i["Global"===t?"globals":"workspaces"]||[]).filter((function(t){var e=so.run(t);return e.ok||console.warn("Fetched layout: "+t.name+" is discarded, because it failed the validation: "+JSON.stringify(e)),e.ok}))]:[2,[]]}}))}))},t.prototype.get=function(t,e){return Vi(this,void 0,void 0,(function(){return Ji(this,(function(n){switch(n.label){case 0:return[4,this.getAll(e)];case 1:return[2,n.sent().find((function(e){return e.name===t}))]}}))}))},t}(),as=function(){function t(){}return t.prototype.get=function(t,e){return this.getObjectFromLocalStorage()[this.getKey(t,e)]},t.prototype.save=function(t){var e=this.getObjectFromLocalStorage();return e[this.getKey(t.name,t.type)]=t,this.setObjectToLocalStorage(e),t},t.prototype.remove=function(t,e){delete this.getObjectFromLocalStorage()[this.getKey(t,e)]},t.prototype.getObjectFromLocalStorage=function(){var e=window.localStorage.getItem(t.KEY);return e?JSON.parse(e):{}},t.prototype.setObjectToLocalStorage=function(e){window.localStorage.setItem(t.KEY,JSON.stringify(e))},t.prototype.getKey=function(t,e){return e+"_"+t},t.KEY="G0_layouts",t}(),cs=function(t,e,n,i){var r=!1;window.addEventListener("beforeunload",(function(){Vi(void 0,void 0,void 0,(function(){var o,s,a,c,u;return Ji(this,(function(d){return r||(r=!0,(null===(u=null==e?void 0:e.layouts)||void 0===u?void 0:u.autoRestore)&&(o=t.windows.getChildWindows().map((function(t){return t.id})),s=o[0],a="_auto_"+document.location.href,o.length>0?(c={domain:"layouts",command:"saveLayoutAndClose",args:{childWindows:o,closeEveryone:!0,layoutName:a,context:{},metadata:{},parentInfo:null==i?void 0:i.getLocalLayoutComponent({},!0)}},n.send(c,{windowId:s})):null==i||i.autoSave({name:a})),t.done()),[2]}))}))}))},us=function(t,e){return(us=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function ds(t,e){function n(){this.constructor=t}us(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var ps=function(){return(ps=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function hs(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){t.done?r(t.value):new n((function(e){e(t.value)})).then(s,a)}c((i=i.apply(t,e||[])).next())}))}function fs(t,e){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function ls(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var i=Array(t),r=0;for(e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,r++)i[r]=o[s];return i}var vs=1,ys=2,gs=3,ms=4;function ws(t){return t.type===gs?"timestamp":t.type===ys?"number":t.type===vs?"string":t.type===ms?"object":"unknown"}function bs(t){return t.constructor===Date?"timestamp":"number"==typeof t?"number":"string"==typeof t?"string":"object"==typeof t?"object":"string"}function _s(t){var e={},n=ws(t);if("object"===n){var i=Object.keys(t.value).reduce((function(e,n){var i=bs(t.value[n]);if("object"===i){var r=Is(t.value[n]);e[n]={type:"object",description:"",context:{},composite:r}}else e[n]={type:i,description:"",context:{}};return e}),{});e.composite=i}return e.name=Ss(t.path.join("/")+"/"+t.name),e.type=n,e.description=t.description,e.context={},e}function Is(t){return Object.keys(t).reduce((function(e,n){var i=bs(t[n]);return e[n]="object"===i?{type:"object",description:"",context:{},composite:Is(t[n])}:{type:i,description:"",context:{}},e}),{})}function Ss(t){return void 0!==t&&t.length>0&&"/"!==t[0]?"/"+t:t}function xs(t){return"timestamp"===ws(t)?Date.now():ks(t.value)}function ks(t){return"object"!=typeof t?t:Object.keys(t).reduce((function(e,n){var i=t[n];return"object"==typeof i&&i.constructor!==Date?e[n]=ks(i):i.constructor===Date?e[n]=new Date(i).getTime():i.constructor===Boolean?e[n]=i.toString():e[n]=i,e}),{})}function Cs(t){return t.reduce((function(t,e){return t.concat(Array.isArray(e)?Cs(e):e)}),[])}function As(t){var e=Cs(t.root.getAggregateState()),n=e.sort((function(t,e){return t.state?e.state?e.state-t.state:-1:1}))[0];return{description:function(t){var e="";return t.forEach((function(t,n,i){var r=t.path.join(".");n===i.length-1?e+=r+"."+t.name+": "+t.description:e+=r+"."+t.name+": "+t.description+","})),e.length>100?e.slice(0,100)+"...":e}(e),value:n.state}}var Ts=function(t,e,n){if(null===t||"object"!=typeof t)throw new Error("Missing definition");if(null===e||"object"!=typeof e)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")},Ps=function(){function t(t,e,n,i,r){this.definition=t,this.system=e,this.transport=n,this.value=i,this.type=r,this.path=[],Ts(t,e,n),this.path=e.path.slice(0),this.path.push(e.name),this.name=t.name,this.description=t.description,n.createMetric(this)}return Object.defineProperty(t.prototype,"repo",{get:function(){var t;return null===(t=this.system)||void 0===t?void 0:t.repo},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),t.prototype.update=function(t){return this.value=t,this.transport.updateMetric(this)},t}(),Ms=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,ys)||this}return ds(e,t),e.prototype.incrementBy=function(t){this.update(this.value+t)},e.prototype.increment=function(){this.incrementBy(1)},e.prototype.decrement=function(){this.incrementBy(-1)},e.prototype.decrementBy=function(t){this.incrementBy(-1*t)},e}(Ps),js=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,ms)||this}return ds(e,t),e.prototype.update=function(t){return this.mergeValues(t),this.transport.updateMetric(this)},e.prototype.mergeValues=function(t){var e=this;return Object.keys(this.value).forEach((function(n){void 0!==t[n]&&(e.value[n]=t[n])}))},e}(Ps),Es=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,vs)||this}return ds(e,t),e}(Ps),Os=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,gs)||this}return ds(e,t),e.prototype.now=function(){this.update(new Date)},e}(Ps);function Rs(t,e,n,i,r){if(!e)throw new Error("Repository is required");if(!n)throw new Error("Transport is required");var o,s,a=n,c=t,u=r||"",d=e,p=i,h=function t(e){if(!e||!e.parent)return[];var n=t(e.parent);return n.push(e.name),n}(i),f={},l=(s="/",((o=h)&&o.length>0?o.join(s):"")+t),v=e.root,y=[],g=[];function m(t,e,n,i){var r={name:""};r="string"==typeof t?{name:t}:t;var o=g.filter((function(t){return t.name===r.name}));if(o.length>0){var s=o[0];if(s.type!==e)throw new Error("A metric named "+r.name+" is already defined with different type.");return void 0!==n&&s.update(n).catch((function(){})),s}var a=i(r);return g.push(a),a}var w={get name(){return c},get description(){return u},get repo(){return d},get parent(){return p},path:h,id:l,root:v,get subSystems(){return y},get metrics(){return g},subSystem:function(t,e){if(!t||0===t.length)throw new Error("name is required");var n=y.filter((function(e){return e.name===t}));if(n.length>0)return n[0];var i=Rs(t,d,a,w,e);return y.push(i),i},getState:function(){return f},setState:function(t,e){f={state:t,description:e},a.updateSystem(w,f)},stringMetric:function(t,e){return m(t,vs,e,(function(t){return new Es(t,w,a,e)}))},timestampMetric:function(t,e){return m(t,gs,e,(function(t){return new Os(t,w,a,e)}))},objectMetric:function(t,e){return m(t,ms,e,(function(t){return new js(t,w,a,e)}))},numberMetric:function(t,e){return m(t,ys,e,(function(t){return new Ms(t,w,a,e)}))},getAggregateState:function(){var t=[];return Object.keys(f).length>0&&t.push({name:c,path:h,state:f.state,description:f.description}),y.forEach((function(e){var n=e.getAggregateState();n.length>0&&t.push.apply(t,n)})),t}};return a.createSystem(w),w}var Ns=function(){function t(t,e){e.init(this),this.root=Rs("",this,e),this.addSystemMetrics(this.root,t.clickStream||void 0===t.clickStream)}return t.prototype.addSystemMetrics=function(t,e){if("undefined"!=typeof navigator&&t.stringMetric("UserAgent",navigator.userAgent),e&&"undefined"!=typeof document){var n=t.subSystem("ClickStream"),i=function(t){if(t.target){var e=t.target;n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:t.target?e.className:"",id:e.id,type:"<"+e.tagName.toLowerCase()+">",href:e.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",i):document.attachEvent("onclick",i)}t.stringMetric("StartTime",(new Date).toString());var r=t.stringMetric("StartURL",""),o=t.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;r.update(s)}void 0!==window.glue42gd&&o.update(window.glue42gd.appName)}},t}(),Ls=function(){function t(){}return t.prototype.init=function(t){},t.prototype.createSystem=function(t){return Promise.resolve()},t.prototype.updateSystem=function(t,e){return Promise.resolve()},t.prototype.createMetric=function(t){return Promise.resolve()},t.prototype.updateMetric=function(t){return Promise.resolve()},t}(),Ws=function(){function t(t,e,n){this.api=t,this.lastCount=0,this.initialPublishTimeout=1e4,this.publishInterval=6e4,this.initialPublishTimeout=null!=e?e:this.initialPublishTimeout,this.publishInterval=null!=n?n:this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}return t.prototype.scheduleCollection=function(){var t=this;setTimeout((function(){t.collect(),setInterval((function(){t.collect()}),t.publishInterval)}),this.initialPublishTimeout)},t.prototype.collect=function(){try{this.collectMemory(),this.collectEntries()}catch(t){}},t.prototype.collectMemory=function(){var t=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:t.totalJSHeapSize,usedJSHeapSize:t.usedJSHeapSize}))},t.prototype.collectEntries=function(){var t=window.performance.getEntries();t.length<=this.lastCount||(this.lastCount=t.length,this.system.stringMetric("entries",JSON.stringify(t)))},t}(),Ds=function(t){var e;e=t.connection&&"object"==typeof t.connection?function(t,e){var n,i,r=this;if(!t||"object"!=typeof t)throw new Error("Connection is required parameter");var o=function(t){s(t.root)},s=function(t){a(t),t.metrics.forEach((function(t){c(t)})),t.subSystems.forEach((function(t){s(t)}))},a=function(t){return hs(r,void 0,void 0,(function(){var e,r;return fs(this,(function(o){switch(o.label){case 0:return void 0===t.parent?[2]:[4,n];case 1:return o.sent(),e={name:Ss(t.path.join("/")+"/"+t.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}},r={type:"define",metrics:[e]},i.send(r),[2]}}))}))},c=function(t){return hs(r,void 0,void 0,(function(){var e,r,o;return fs(this,(function(s){switch(s.label){case 0:return e=d(t),[4,n];case 1:return s.sent(),r=_s(e),o={type:"define",metrics:[r]},i.send(o),void 0!==e.value&&u(e),[2]}}))}))},u=function(t){if(p()){var e=xs(t),n={type:"publish",values:[{name:Ss(t.path.join("/")+"/"+t.name),value:e,timestamp:Date.now()}]};return i.sendFireAndForget(n)}return Promise.resolve()},d=function(t){var e=ps({},t);return"object"==typeof t.value&&null!==t.value&&(e.value=ps({},t.value)),e},p=function(){var t;try{return(null!==(t=e.canUpdateMetric)&&void 0!==t?t:function(){return!0})()}catch(t){return!0}};return{init:function(r){var s;n=new Promise((function(t){s=t})),(i=t.domain("metrics")).onJoined((function(t){!t&&s&&(s(),s=void 0);var e={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};i.send(e),t&&o(r)})),i.join({system:e.system,service:e.service,instance:e.instance})},createSystem:a,updateSystem:function(e,o){return hs(r,void 0,void 0,(function(){var r,s,a;return fs(this,(function(c){switch(c.label){case 0:return[4,n];case 1:return c.sent(),r={type:"publish",values:[{name:Ss(e.path.join("/")+"/"+e.name+"/State"),value:{Description:o.description,Value:o.state},timestamp:Date.now()}]},i.send(r),s=As(e),a={type:"publish",peer_id:t.peerId,values:[{name:"/State",value:{Description:s.description,Value:s.value},timestamp:Date.now()}]},i.send(a),[2]}}))}))},createMetric:c,updateMetric:function(t){return hs(r,void 0,void 0,(function(){var e;return fs(this,(function(i){switch(i.label){case 0:return e=d(t),[4,n];case 1:return i.sent(),u(e),[2]}}))}))}}}(t.connection,t):new Ls;var n=new Ns(t,e).root;t.disableAutoAppSystem||(n=n.subSystem("App"));var i=function(t){var e,n=t.subSystem("reporting"),i={name:"features"},r=function(t,r,o){if(void 0===t||""===t)throw new Error("name is mandatory");if(void 0===r||""===r)throw new Error("action is mandatory");if(void 0===o||""===o)throw new Error("payload is mandatory");e?e.update({name:t,action:r,payload:o}):e=n.objectMetric(i,{name:t,action:r,payload:o})};return t.featureMetric=r,t}(n);return function(t,e){var n,i;if("undefined"==typeof window)return;var r=null===(i=null===(n=null===window||void 0===window?void 0:window.glue42gd)||void 0===n?void 0:n.metrics)||void 0===i?void 0:i.pagePerformanceMetrics;r&&(e=r);(null==e?void 0:e.enabled)&&new Ws(t,e.initialPublishTimeout,e.publishInterval)}(i,t.pagePerformanceMetrics),i};function Fs(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function i(n,i){var r=n instanceof Error?n:new Error(n);if(e)e(r);else{var o='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+r.stack;if(t)switch(t.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(t,e,r){var o=n[t];return o||(o=[],n[t]=o),o.push(e),r&&setTimeout((function(){r.forEach((function(r){var o;if(null===(o=n[t])||void 0===o?void 0:o.includes(e))try{Array.isArray(r)?e.apply(void 0,r):e.apply(void 0,[r])}catch(e){i(e,t)}}))}),0),function(){var i=n[t];i&&(0===(i=i.reduce((function(t,n,i){return n===e&&t.length===i||t.push(n),t}),[])).length?delete n[t]:n[t]=i)}},execute:function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var o=n[t];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var r=n.apply(void 0,e);s.push(r)}catch(e){s.push(void 0),i(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}Fs.default=Fs;var Bs=Fs,Gs=function(){function t(t,e){var n=this;this.registry=Bs(),this.gw=t.facade,this.gw.connect((function(t,e){n.messageHandler(e)})).then((function(t){n.client=t}))}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.client?(this.client.send(t),Promise.resolve(void 0)):Promise.reject("not connected")},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"in-memory"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),qs=function(){function t(t,e){var n=this;this.logger=e,this.registry=Bs(),this.worker=new SharedWorker(t),this.worker.port.onmessage=function(t){n.messageHandler(t.data)}}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.worker.port.postMessage(t),Promise.resolve()},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"shared-worker"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),Hs=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?void 0:t}},t.isNode=function(){if(void 0!==t._isNode)return t._isNode;if("undefined"!=typeof window)return t._isNode=!1,!1;try{t._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(e){t._isNode=!1}return t._isNode},t}(),Us=function(){function t(){var t=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(e,n){t.resolve=function(n){t.resolved=!0,e(n)},t.reject=function(e){t.rejected=!0,n(e)}}))}return t.delay=function(t){return new Promise((function(e){return setTimeout(e,t)}))},Object.defineProperty(t.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),t}(),Vs={};function Js(t){var e=Vs[t];if(e)return e;var n=[];function i(){return(new Date).getTime()}var r,o,s=i();function a(t,e){var r=null!=e?e:i(),o=0;n.length>0&&(o=r-n[n.length-1].time),n.push({name:t,time:r,diff:o})}a("start",s);var c={get startTime(){return s},get endTime(){return r},get period(){return o},stop:function(){return a("end",r=i()),o=r-s},mark:a,marks:n};return Vs[t]=c,c}var zs=Hs.isNode()?require("ws"):window.WebSocket,Ks=function(){function t(t,e){if(this.startupTimer=Js("connection"),this._running=!0,this._registry=Bs(),this.wsRequests=[],this.settings=t,this.logger=e,!this.settings.ws)throw new Error("ws is missing")}return t.prototype.onMessage=function(t){return this._registry.add("onMessage",t)},t.prototype.send=function(t,e){var n=this;return new Promise((function(e,i){n.waitForSocketConnection((function(){var r;try{null===(r=n.ws)||void 0===r||r.send(t),e()}catch(t){i(t)}}),i)}))},t.prototype.open=function(){var t=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(e,n){t.waitForSocketConnection(e,n)}))},t.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},t.prototype.onConnectedChanged=function(t){return this._registry.add("onConnectedChanged",t)},t.prototype.name=function(){return"ws "+this.settings.ws},t.prototype.reconnect=function(){var t;null===(t=this.ws)||void 0===t||t.close();var e=new Us;return this.waitForSocketConnection((function(){e.resolve()})),e.promise},t.prototype.waitForSocketConnection=function(t,e){var n;e=null!=e?e:function(){},this._running?1!==(null===(n=this.ws)||void 0===n?void 0:n.readyState)?(this.wsRequests.push({callback:t,failed:e}),this.wsRequests.length>1||this.openSocket()):t():e("wait for socket on "+this.settings.ws+" failed - socket closed by user")},t.prototype.openSocket=function(t,e){return hs(this,void 0,void 0,(function(){var n=this;return fs(this,(function(i){switch(i.label){case 0:if(this.startupTimer.mark("opening-socket"),void 0===t&&(t=this.settings.reconnectInterval),void 0!==e){if(0===e)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+e+" more times (every "+t+" ms)")}i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return i.sent(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState(),[3,4];case 3:return i.sent(),setTimeout((function(){var i=void 0===e?void 0:e-1;n.openSocket(t,i)}),t),[3,4];case 4:return[2]}}))}))},t.prototype.initiateSocket=function(){var t=this,e=new Us;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new zs(this.settings.ws||""),this.ws.onerror=function(n){var i="";try{i=JSON.stringify(n)}catch(t){var r=new WeakSet;i=JSON.stringify(n,(function(t,e){if("object"==typeof e&&null!==e){if(r.has(e))return;r.add(e)}return e}))}e.reject("error"),t.notifyStatusChanged(!1,i)},this.ws.onclose=function(n){t.logger.info("ws closed "+n),e.reject("closed"),t.notifyStatusChanged(!1)},this.ws.onopen=function(){var n;t.startupTimer.mark("ws-opened"),t.logger.info("ws opened "+(null===(n=t.settings.identity)||void 0===n?void 0:n.application)),e.resolve(),t.notifyStatusChanged(!0)},this.ws.onmessage=function(e){t._registry.execute("onMessage",e.data)},e.promise},t.prototype.notifyForSocketState=function(t){this.wsRequests.forEach((function(e){t?e.failed&&e.failed(t):e.callback()})),this.wsRequests=[]},t.prototype.notifyStatusChanged=function(t,e){this._registry.execute("onConnectedChanged",t,e)},t}();var Ys=1;var Zs,Qs,Xs,$s={nextValue:function(){return(Ys=(9301*Ys+49297)%233280)/233280},seed:function(t){Ys=t}},ta="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function ea(){Xs=!1}function na(t){if(t){if(t!==Zs){if(t.length!==ta.length)throw new Error("Custom alphabet for shortid must be "+ta.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+ta.length+" unique characters. These characters were not unique: "+e.join(", "));Zs=t,ea()}}else Zs!==ta&&(Zs=ta,ea())}function ia(){return Xs||(Xs=function(){Zs||na(ta);for(var t,e=Zs.split(""),n=[],i=$s.nextValue();e.length>0;)i=$s.nextValue(),t=Math.floor(i*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var ra={characters:function(t){return na(t),Zs},seed:function(t){$s.seed(t),Qs!==t&&(ea(),Qs=t)},lookup:function(t){return ia()[t]},shuffled:ia},oa="object"==typeof window&&(window.crypto||window.msCrypto);var sa=function(){if(!oa||!oa.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return oa.getRandomValues(t),48&t[0]};var aa=function(t,e){for(var n,i=0,r="";!n;)r+=t(e>>4*i&15|sa()),n=e<Math.pow(16,i+1),i++;return r};var ca=function(t){var e=ra.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var ua=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=ra.characters(),n=t.length,i=0;i<n;i++)if(-1===e.indexOf(t[i]))return!1;return!0},da=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e,n,i=0;function r(){var t="",r=Math.floor(.001*(Date.now()-1459707606518));return r===n?e++:(e=0,n=r),t+=aa(ra.lookup,6),t+=aa(ra.lookup,i),e>0&&(t+=aa(ra.lookup,e)),t+=aa(ra.lookup,r)}t.exports=r,t.exports.generate=r,t.exports.seed=function(e){return ra.seed(e),t.exports},t.exports.worker=function(e){return i=e,t.exports},t.exports.characters=function(t){return void 0!==t&&ra.characters(t),ra.shuffled()},t.exports.decode=ca,t.exports.isValid=ua})),pa=(da.generate,da.seed,da.worker,da.characters,da.decode,da.isValid,da);function ha(t,e,n,i,r){null==t&&(t="global"),i=i||["success"],r=r||["error"];var o,s=!1,a=!1,c=!1,u=Bs();e.disconnected((function(){c=!1,n.debug("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),e.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),p(o))})),e.on("success",(function(t){return f(t)})),e.on("error",(function(t){return h(t)})),e.on("result",(function(t){return f(t)})),i&&i.forEach((function(t){e.on(t,(function(t){return f(t)}))})),r&&r.forEach((function(t){e.on(t,(function(t){return h(t)}))}));var d={};function p(e){return o=e,new Promise((function(i,r){if(s)i();else{var o;if("global"===t)o=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining domain "+t),o=v({type:"join",destination:t,domain:"global",options:e});o.then((function(){!function(){n.debug("did join "+t),s=!0;var e=a;a=!1,u.execute("onJoined",e)}(),i()})).catch((function(e){n.debug("error joining "+t+" domain: "+JSON.stringify(e)),r(e)}))}}))}function h(e){if(t===e.domain){var n=e.request_id;if(n){var i=d[n];i&&i.error(e)}}}function f(e){if(e.domain===t){var n=e.request_id;if(n){var i=d[n];i&&i.success(e)}}}function l(){return pa()}function v(i,r,o){o=o||{},i.request_id=i.request_id||l(),i.domain=i.domain||t,o.skipPeerId||(i.peer_id=e.peerId);var s=i.request_id;return new Promise((function(t,a){d[s]={success:function(e){delete d[s],e._tag=r,t(e)},error:function(t){n.warn("GW error - "+JSON.stringify(t)+" for request "+JSON.stringify(i)),delete d[s],t._tag=r,a(t)}},e.send(i,o).catch((function(t){d[s].error({err:t})}))}))}return{join:p,leave:function(){return"global"===t?Promise.resolve():(n.debug("stopping session "+t+"..."),a=!1,v({type:"leave",destination:t,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})))},onJoined:function(t){return s&&t(!1),u.add("onJoined",t)},onLeft:function(t){return s||t(),u.add("onLeft",t)},send:v,sendFireAndForget:function(n){return n.request_id=n.request_id?n.request_id:l(),n.domain=n.domain||t,n.peer_id=e.peerId,e.send(n)},on:function(i,r){e.on(i,(function(e){if(e.domain===t)try{r(e)}catch(t){n.error("Callback  failed: "+t+" \n "+t.stack+" \n msg was: "+JSON.stringify(e),t)}}))},loggedIn:function(t){return e.loggedIn(t)},connected:function(t){return e.connected(t)},disconnected:function(t){return e.disconnected(t)},get peerId(){return e.peerId},get domain(){return t}}}var fa=function(){function t(t,e,n){var i=this;this.connection=t,this.settings=e,this.logger=n,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=Bs(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],t.disconnected((function(){i.handleDisconnected()})),this.ping()}return Object.defineProperty(t.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.processStringMessage=function(t){var e=this,n=JSON.parse(t,(function(t,n){if("string"!=typeof n)return n;if(n.length<e.dateMinLen)return n;if(n[0]!==e.datePrefixFirstChar)return n;if(n.substring(0,e.datePrefixLen)!==e.datePrefix)return n;try{var i=parseInt(n.substring(e.datePrefixLen,n.length),10);return isNaN(i)?n:new Date(i)}catch(t){return n}}));return{msg:n,msgType:n.type}},t.prototype.createStringMessage=function(t){var e=Date.prototype.toJSON;try{var n=this.datePrefix;return Date.prototype.toJSON=function(){return n+this.getTime()},JSON.stringify(t)}finally{Date.prototype.toJSON=e}},t.prototype.processObjectMessage=function(t){if(!t.type)throw new Error("Object should have type property");return{msg:t,msgType:t.type}},t.prototype.createObjectMessage=function(t){return t},t.prototype.login=function(t,e){return hs(this,void 0,void 0,(function(){var n,i,r,o,s,a,c,u,d,p;return fs(this,(function(h){switch(h.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=t,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,n={},this.connection.gatewayToken=t.gatewayToken,!t.gatewayToken)return[3,5];if(!e)return[3,4];h.label=1;case 1:return h.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return u=h.sent(),t.gatewayToken=u,[3,4];case 3:return i=h.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==i?void 0:i.message)||i)),[3,4];case 4:return n.method="gateway-token",n.token=t.gatewayToken,this.connection.gatewayToken=t.gatewayToken,[3,10];case 5:return"sspi"!==t.flowName?[3,9]:(n.provider="win",n.method="access-token",t.flowCallback&&t.sessionId?(r=n,[4,t.flowCallback(t.sessionId,null)]):[3,7]);case 6:return r.token=h.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(t.token)n.method="access-token",n.token=t.token;else{if(!t.username)throw new Error("invalid auth message"+JSON.stringify(t));n.method="secret",n.login=t.username,n.secret=t.password}h.label=10;case 10:o={type:"hello",identity:this.settings.identity,authentication:n},t.sessionId&&(o.request_id=t.sessionId),this.globalDomain=ha("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),s={skipPeerId:!0},this.initialLogin&&(s.retryInterval=this.settings.reconnectInterval,s.maxRetries=this.settings.reconnectAttempts),h.label=11;case 11:h.trys.push([11,19,20,21]),a=void 0,h.label=12;case 12:return[4,this.globalDomain.send(o,void 0,s)];case 13:return"authentication-request"!==(c=h.sent()).type?[3,16]:(u=Buffer.from(c.authentication.token,"base64"),t.flowCallback&&t.sessionId?(d=o.authentication,[4,t.flowCallback(t.sessionId,u)]):[3,15]);case 14:d.token=h.sent().data.toString("base64"),h.label=15;case 15:return o.request_id=t.sessionId,[3,12];case 16:if("welcome"===c.type)return a=c,[3,18];throw"error"===c.type?new Error("Authentication failed: "+c.reason):new Error("Unexpected message type during authentication: "+c.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.info("login successful with peerId "+a.peer_id),this.connection.peerId=a.peer_id,this.connection.resolvedIdentity=a.resolved_identity,this.connection.availableDomains=a.available_domains,a.options&&(this.connection.token=a.options.access_token,this.connection.info=a.options.info),this.setLoggedIn(!0),[2,a.resolved_identity];case 19:throw p=h.sent(),this.logger.error("error sending hello message - "+(p.message||p.msg||p.reason||p),p),p;case 20:return t&&t.flowCallback&&t.sessionId&&t.flowCallback(t.sessionId,null),[7];case 21:return[2]}}))}))},t.prototype.logout=function(){return hs(this,void 0,void 0,(function(){var t;return fs(this,(function(e){switch(e.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),t=this.sessions.map((function(t){t.leave()})),[4,Promise.all(t)];case 1:return e.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this._isLoggedIn&&t(),this.registry.add("onLoggedIn",t)},t.prototype.domain=function(t,e,n,i){var r=this.sessions.filter((function(e){return e.domain===t}))[0];return r||(r=ha(t,this.connection,e,n,i),this.sessions.push(r)),r},t.prototype.handleDisconnected=function(){var t=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(t.handleDisconnected.bind(t),t.settings.reconnectInterval||1e3)}))}},t.prototype.setLoggedIn=function(t){this._isLoggedIn=t,this._isLoggedIn&&this.registry.execute("onLoggedIn")},t.prototype.ping=function(){var t=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){t.ping()}),3e4))},t.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(t){return t.token})):Promise.reject(new Error("no global domain session"))},t.prototype.getNewGWToken=function(){if(void 0!==typeof window){var t=window.glue42gd;if(t)return t.getGWToken()}return Promise.reject(new Error("not running in GD"))},t}(),la=function(){function t(t){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var e=0,n=t;e<n.length;e++){var i=n[e];this.specs[i.name]=i,this.specsNames.push(i.name)}}return t.prototype.init=function(t){var e=this;this.connection=t;for(var n=0,i=this.specsNames;n<i.length;n++)for(var r=i[n],o=function(n){var i=s.subsRefCount[n];if(i||(i=0),i+=1,s.subsRefCount[n]=i,i>1)return"continue";var r=t.on(n,(function(t){return e.processMessage(n,t)}));s.subs[n]=r},s=this,a=0,c=this.specs[r].types;a<c.length;a++){o(c[a])}},t.prototype.processMessage=function(t,e){if(!this.isDone&&e)for(var n=0,i=this.specsNames;n<i.length;n++){var r=i[n];if(-1!==this.specs[r].types.indexOf(t)){var o=this.messages[r]||[];this.messages[r]=o,o.push(e)}}},t.prototype.drain=function(t,e){var n;e&&(this.messages[t]||[]).forEach(e),delete this.messages[t];for(var i=0,r=this.specs[t].types;i<r.length;i++){var o=r[i];this.subsRefCount[o]-=1,this.subsRefCount[o]<=0&&(null===(n=this.connection)||void 0===n||n.off(this.subs[o]),delete this.subs[o],delete this.subsRefCount[o])}delete this.specs[t],this.specs.length||(this.isDone=!0)},t}(),va=function(){function t(t,e){if(this.settings=t,this.logger=e,this.messageHandlers={},this.ids=1,this.registry=Bs(),this._connected=!1,this.isTrace=!1,(t=t||{}).reconnectAttempts=t.reconnectAttempts||10,t.reconnectInterval=t.reconnectInterval||1e3,t.inproc)this.transport=new Gs(t.inproc,e.subLogger("inMemory"));else if(t.sharedWorker)this.transport=new qs(t.sharedWorker,e.subLogger("shared-worker"));else{if(void 0===t.ws)throw new Error("No connection information specified");this.transport=new Ks(t,e.subLogger("ws"))}this.isTrace=e.canPublish("trace"),e.info("starting with "+this.transport.name()+" transport"),this.protocol=new fa(this,t,e.subLogger("protocol")),this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this.transport.onMessage(this.handleTransportMessage.bind(this)),t.replaySpecs&&t.replaySpecs.length&&(this.replayer=new la(t.replaySpecs),this.replayer.init(this))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;return null===(t=this.protocol)||void 0===t?void 0:t.protocolVersion},enumerable:!0,configurable:!0}),t.prototype.send=function(t,e){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var n=this.protocol.createObjectMessage(t);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(n)),this.transport.sendObject(n,e)}var i=this.protocol.createStringMessage(t);return this.isTrace&&this.logger.trace(">> "+i),this.transport.send(i,e)},t.prototype.on=function(t,e){t=t.toLowerCase(),void 0===this.messageHandlers[t]&&(this.messageHandlers[t]={});var n=this.ids++;return this.messageHandlers[t][n]=e,{type:t,id:n}},t.prototype.off=function(t){delete this.messageHandlers[t.type.toLowerCase()][t.id]},Object.defineProperty(t.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.connected=function(t){var e=this;return this.protocol.loggedIn((function(){t(e.settings.ws||e.settings.sharedWorker||"")}))},t.prototype.disconnected=function(t){return this.registry.add("disconnected",t)},t.prototype.login=function(t,e){return hs(this,void 0,void 0,(function(){var n;return fs(this,(function(i){switch(i.label){case 0:return[4,this.transport.open()];case 1:return i.sent(),Js("connection").mark("transport-opened"),n=this.protocol.login(t,e),Js("connection").mark("protocol-logged-in"),[2,n]}}))}))},t.prototype.logout=function(){return hs(this,void 0,void 0,(function(){return fs(this,(function(t){switch(t.label){case 0:return[4,this.protocol.logout()];case 1:return t.sent(),[4,this.transport.close()];case 2:return t.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this.protocol.loggedIn(t)},t.prototype.domain=function(t,e,n){return this.protocol.domain(t,this.logger.subLogger("domain="+t),e,n)},t.prototype.authToken=function(){return this.protocol.authToken()},t.prototype.reconnect=function(){return this.transport.reconnect()},t.prototype.distributeMessage=function(t,e){var n=this,i=this.messageHandlers[e.toLowerCase()];void 0!==i&&Object.keys(i).forEach((function(e){var r=i[e];if(void 0!==r)try{r(t)}catch(t){try{n.logger.error("Message handler failed with "+t.stack,t)}catch(e){console.log("Message handler failed",t)}}}))},t.prototype.handleConnectionChanged=function(t){this._connected!==t&&(this._connected=t,t?this.registry.execute("connected"):this.registry.execute("disconnected"))},t.prototype.handleTransportMessage=function(t){var e;e="string"==typeof t?this.protocol.processStringMessage(t):this.protocol.processObjectMessage(t),this.isTrace&&this.logger.trace("<< "+JSON.stringify(e)),this.distributeMessage(e.msg,e.msgType)},t}(),ya=["trace","debug","info","warn","error","off"],ga=function(){function t(t,e,n){this.name=t,this.parent=e,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=t,this.path=e?e.path+"."+t:t,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}return t.prototype.subLogger=function(e){var n=this.subLoggers.filter((function(t){return t.name===e}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(t){if(t===e)throw new Error("This sub logger name is not allowed.")}));var i=new t(e,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(i),i},t.prototype.publishLevel=function(t){var e;return t&&(this._publishLevel=t),this._publishLevel||(null===(e=this.parent)||void 0===e?void 0:e.publishLevel())},t.prototype.consoleLevel=function(t){var e;return t&&(this._consoleLevel=t),this._consoleLevel||(null===(e=this.parent)||void 0===e?void 0:e.consoleLevel())},t.prototype.log=function(t,e,n){this.publishMessage(e||"info",t,n)},t.prototype.trace=function(t){this.log(t,"trace")},t.prototype.debug=function(t){this.log(t,"debug")},t.prototype.info=function(t){this.log(t,"info")},t.prototype.warn=function(t){this.log(t,"warn")},t.prototype.error=function(t,e){this.log(t,"error")},t.prototype.canPublish=function(t,e){return ya.indexOf(t)>=ya.indexOf(e||this.consoleLevel()||"trace")},t.prototype.publishMessage=function(e,n,i){var r=this.loggerFullName;if("error"===e&&!i){var o=new Error;o.stack&&(n=n+"\n"+o.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(e,this.publishLevel())){var s=t.Interop;if(s)try{s.methods({name:t.InteropMethodName}).length>0&&s.invoke(t.InteropMethodName,{msg:""+n,logger:r,level:e})}catch(t){}}if(this.canPublish(e)){var a="";if(this.includeTimeAndLevel){var c=new Date;a="["+(c.getHours()+":"+c.getMinutes()+":"+c.getSeconds()+":"+c.getMilliseconds())+"] ["+e+"] "}var u=""+a+r+": "+n;switch(e){case"trace":this.logFn.debug(u);break;case"debug":this.logFn.debug?this.logFn.debug(u):this.logFn.log(u);break;case"info":this.logFn.info(u);break;case"warn":this.logFn.warn(u);break;case"error":this.logFn.error(u,i)}}},t.InteropMethodName="T42.AppLogger.Log",t}(),ma="create-context",wa="created",ba="destroyed",_a="context-created",Ia="context-added",Sa="subscribe-context",xa="subscribed-context",ka="unsubscribe-context",Ca="destroy-context",Aa="context-destroyed",Ta="update-context",Pa="context-updated",Ma="joined",ja={get name(){return"context"},get types(){return[ma,wa,ba,_a,Ia,Sa,xa,ka,Ca,Aa,Ta,Pa,Ma]}},Ea="5.2.7";var Oa=function(){function t(t,e,n,i){this.updateCallbacks={},this.contextId=t,this.name=e,this.isAnnounced=n,this.activityId=i,this.context={}}return t.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},t.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},t}();function Ra(t,e,n){try{if((null==n?void 0:n.canPublish("trace"))&&(null==n||n.trace("applying context delta "+JSON.stringify(e)+" on context "+JSON.stringify(t))),!e)return t;if(e.reset)return t=ps({},e.reset);if(t=Na(t,void 0),e.commands){for(var i=0,r=e.commands;i<r.length;i++){var o=r[i];"remove"===o.type?Fa(t,o.path):"set"===o.type&&Da(t,o.value,o.path)}return t}var s=e.added,a=e.updated,c=e.removed;return s&&Object.keys(s).forEach((function(e){t[e]=s[e]})),a&&Object.keys(a).forEach((function(e){La(e,t,a)})),c&&c.forEach((function(e){delete t[e]})),t}catch(i){return null==n||n.error("error applying context delta "+JSON.stringify(e)+" on context "+JSON.stringify(t),i),t}}function Na(t,e){if(e=e||new WeakMap,Object(t)!==t)return t;if(t instanceof Set)return new Set(t);if(e.has(t))return e.get(t);var n=t instanceof Date?new Date(t):t instanceof RegExp?new RegExp(t.source,t.flags):t.constructor?new t.constructor:Object.create(null);return e.set(t,n),Object.assign.apply(Object,ls([n],Object.keys(t).map((function(n){var i;return(i={})[n]=Na(t[n],e),i}))))}var La=function(t,e,n){var i=n[t];if(void 0===i)return e;var r=e[t];return r&&i?"string"==typeof r||"number"==typeof r||"boolean"==typeof r||"string"==typeof i||"number"==typeof i||"boolean"==typeof i||Array.isArray(r)||Array.isArray(i)?(e[t]=i,e):(e[t]=Object.assign({},r,i),e):(e[t]=i,e)};function Wa(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;for(var n in t)if(t.hasOwnProperty(n)){if(!e.hasOwnProperty(n))return!1;if(t[n]!==e[n]){if("object"!=typeof t[n])return!1;if(!Wa(t[n],e[n]))return!1}}for(var n in e)if(e.hasOwnProperty(n)&&!t.hasOwnProperty(n))return!1;return!0}function Da(t,e,n){var i,r=n.split(".");for(i=0;i<r.length-1;i++)t[r[i]]||(t[r[i]]={}),"object"!=typeof t[r[i]]&&(t[r[i]]={}),t=t[r[i]];t[r[i]]=e}function Fa(t,e){var n,i=e.split(".");for(n=0;n<i.length-1;n++){if(!t[i[n]])return;t=t[i[n]]}delete t[i[n]]}var Ba,Ga=function(){function t(t){var e,n=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._protocolVersion=void 0,this._connection=t.connection,this._logger=t.logger,this._gw3Session=this._connection.domain("global",[_a,xa,Aa,Pa]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(e=this._connection.replayer)||void 0===e||e.drain(ja.name,(function(t){var e=t.type;e&&(e===_a||e===Ia||e===wa?n.handleContextCreatedMessage(t):e===xa||e===Pa||e===Ma?n.handleContextUpdatedMessage(t):e!==Aa&&e!==ba||n.handleContextDestroyedMessage(t))}))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;if(!this._protocolVersion){var e=this._connection.availableDomains.find((function(t){return"context"===t.uri}));this._protocolVersion=null!==(t=null==e?void 0:e.version)&&void 0!==t?t:1}return this._protocolVersion},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"setPathSupported",{get:function(){return this.protocolVersion>=2},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){for(var t=0,e=this._gw3Subscriptions;t<e.length;t++){var n=e[t];this._connection.off(n)}for(var i in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(i)&&delete this._contextNameToData[i]},t.prototype.createContext=function(t,e){var n=this;return this._gw3Session.send({type:ma,domain:"global",name:t,data:e,lifetime:"retained"}).then((function(i){n._contextNameToId[t]=i.context_id,n._contextIdToName[i.context_id]=t;var r=n._contextNameToData[t]||new Oa(i.context_id,t,!0,void 0);return r.isAnnounced=!0,r.name=t,r.contextId=i.context_id,r.context=e,n._contextNameToData[t]=r,i.context_id}))},t.prototype.all=function(){var t=this;return Object.keys(this._contextNameToData).filter((function(e){return t._contextNameToData[e].isAnnounced}))},t.prototype.update=function(t,e){var n;return hs(this,void 0,void 0,(function(){var i,r,o,s=this;return fs(this,(function(a){switch(a.label){case 0:return(i=this._contextNameToData[t])&&i.isAnnounced?(r=i.context,i.hasCallbacks()?[3,2]:[4,this.get(i.name)]):[2,this.createContext(t,e)];case 1:r=a.sent(),a.label=2;case 2:return o=2===this.protocolVersion?this.calculateContextDeltaV2(r,e):this.calculateContextDeltaV1(r,e),Object.keys(o.added).length||Object.keys(o.updated).length||o.removed.length||(null===(n=o.commands)||void 0===n?void 0:n.length)?[2,this._gw3Session.send({type:Ta,domain:"global",context_id:i.contextId,delta:o},{},{skipPeerId:!1}).then((function(t){s.handleUpdated(i,o,{updaterId:t.peer_id})}))]:[2,Promise.resolve()]}}))}))},t.prototype.set=function(t,e){var n=this,i=this._contextNameToData[t];return i&&i.isAnnounced?this._gw3Session.send({type:Ta,domain:"global",context_id:i.contextId,delta:{reset:e}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(i,{reset:e,added:{},removed:[],updated:{}},{updaterId:t.peer_id})})):this.createContext(t,e)},t.prototype.setPath=function(t,e,n){return this.setPathSupported?this.setPaths(t,[{path:e,value:n}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")},t.prototype.setPaths=function(t,e){var n=this;if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");var i=this._contextNameToData[t];if(!i||!i.isAnnounced){for(var r={},o=0,s=e;o<s.length;o++){Da(r,(d=s[o]).value,d.path)}return this.createContext(t,r)}for(var a=[],c=0,u=e;c<u.length;c++){var d;null===(d=u[c]).value?a.push({type:"remove",path:d.path}):a.push({type:"set",path:d.path,value:d.value})}return this._gw3Session.send({type:Ta,domain:"global",context_id:i.contextId,delta:{commands:a}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(i,{added:{},removed:[],updated:{},commands:a},{updaterId:t.peer_id})}))},t.prototype.get=function(t){var e,n=this,i=this._contextNameToData[t];if(!i||!i.isAnnounced)return Promise.resolve({});if(i&&!i.hasCallbacks())return new Promise((function(e,i){return hs(n,void 0,void 0,(function(){var n=this;return fs(this,(function(i){return this.subscribe(t,(function(t,i,r,o){n.unsubscribe(o),e(t)})),[2]}))}))}));var r=null!==(e=null==i?void 0:i.context)&&void 0!==e?e:{};return Promise.resolve(r)},t.prototype.subscribe=function(t,e){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var i=this._contextNameToData[t];if(!i||!i.isAnnounced)return i=i||new Oa(void 0,t,!1,void 0),this._contextNameToData[t]=i,i.updateCallbacks[n]=e,Promise.resolve(n);var r,o=i.hasCallbacks();return i.updateCallbacks[n]=e,o||i.joinedActivity||i.context&&i.sentExplicitSubscription?(e(r=Na(i.context),r,[],n),Promise.resolve(n)):this.sendSubscribe(i).then((function(){return n}))},t.prototype.unsubscribe=function(t){for(var e=0,n=Object.keys(this._contextNameToData);e<n.length;e++){var i=n[e],r=(this._contextNameToId[i],this._contextNameToData[i]);if(!r)return;var o=r.hasCallbacks();delete r.updateCallbacks[t],r.isAnnounced&&o&&!r.hasCallbacks()&&r.sentExplicitSubscription&&this.sendUnsubscribe(r),r.isAnnounced||r.hasCallbacks()||delete this._contextNameToData[i]}},t.prototype.destroy=function(t){var e=this._contextNameToData[t];return e?this._gw3Session.send({type:Ca,domain:"global",context_id:e.contextId}).then((function(t){})):Promise.reject("context with "+t+" does not exist")},t.prototype.handleUpdated=function(t,e,n){var i=t.context;t.context=Ra(t.context,e,this._logger),this._contextNameToData[t.name]!==t||Wa(i,t.context)||this.invokeUpdateCallbacks(t,e,n)},t.prototype.subscribeToContextCreatedMessages=function(){for(var t=0,e=[Ia,_a,wa];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextCreatedMessage=function(t){var e=t.type;e===wa?(this._contextNameToId[t.activity_id]=t.context_id,this._contextIdToName[t.context_id]=t.activity_id):e===Ia&&(this._contextNameToId[t.name]=t.context_id,this._contextIdToName[t.context_id]=t.name);var n=this._contextIdToName[t.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+t.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+t.context_id);var i=this._contextNameToData[n];if(i){if(i.isAnnounced)return;if(!i.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");i.isAnnounced=!0,i.contextId=t.context_id,i.activityId=t.activity_id,i.sentExplicitSubscription||this.sendSubscribe(i)}else this._contextNameToData[n]=i=new Oa(t.context_id,n,!0,t.activity_id)},t.prototype.subscribeToContextUpdatedMessages=function(){for(var t=0,e=[Pa,xa,Ma];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextUpdatedMessage=function(t){var e=t.type,n=t.context_id,i=this._contextNameToData[this._contextIdToName[n]],r=!i||!i.isAnnounced;if(e===Ma)i?(i.contextId=n,i.isAnnounced=!0,i.activityId=t.activity_id):(i=new Oa(n,t.activity_id,!0,t.activity_id),this._contextNameToData[t.activity_id]=i,this._contextIdToName[n]=t.activity_id,this._contextNameToId[t.activity_id]=n),i.joinedActivity=!0;else if(!i||!i.isAnnounced)return void(e===xa?((i=i||new Oa(n,t.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[t.name]=i,this._contextIdToName[n]=t.name,this._contextNameToId[t.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var o=i.context;if(e===xa)i.context=t.data||{};else if(e===Ma)i.context=t.context_snapshot||{};else{if(e!==Pa)throw new Error("Unrecognized context update message "+e);i.context=Ra(i.context,t.delta,this._logger)}!r&&Wa(i.context,o)&&e!==xa||this.invokeUpdateCallbacks(i,t.delta,{updaterId:t.updater_id})},t.prototype.invokeUpdateCallbacks=function(t,e,n){if((e=e||{added:{},updated:{},reset:{},removed:[]}).commands){e.added=e.updated=e.reset={},e.removed=[];for(var i=0,r=e.commands;i<r.length;i++){var o=r[i];"remove"===o.type?(-1===o.path.indexOf(".")&&e.removed.push(o.path),Da(e.updated,null,o.path)):"set"===o.type&&Da(e.updated,o.value,o.path)}}for(var s in t.updateCallbacks)if(t.updateCallbacks.hasOwnProperty(s))try{(0,t.updateCallbacks[s])(Na(t.context),Object.assign({},e.added||{},e.updated||{},e.reset||{}),e.removed,parseInt(s,10),n)}catch(t){this._logger.debug("callback error: "+JSON.stringify(t))}},t.prototype.subscribeToContextDestroyedMessages=function(){for(var t=0,e=[Aa,ba];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextDestroyedMessage=function(t){var e,n;if(t.type===ba){if(n=t.activity_id,!(e=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+t.activity_id)}else if(e=t.context_id,!(n=this._contextIdToName[e]))return void this._logger.error("Received 'destroyed' for unknown context: "+t.context_id);delete this._contextIdToName[e],delete this._contextNameToId[n];var i=this._contextNameToData[n];delete this._contextNameToData[n],i&&i.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+e)},t.prototype.sendSubscribe=function(t){return t.sentExplicitSubscription=!0,this._gw3Session.send({type:Sa,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.sendUnsubscribe=function(t){return t.sentExplicitSubscription=!1,this._gw3Session.send({type:ka,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.calculateContextDeltaV1=function(t,e){var n={added:{},updated:{},removed:[],reset:void 0};if(t)for(var i=0,r=Object.keys(t);i<r.length;i++){var o=r[i];-1===Object.keys(e).indexOf(o)||null===e[o]||Wa(t[o],e[o])||(n.updated[o]=e[o])}for(var s=0,a=Object.keys(e);s<a.length;s++){o=a[s];t&&-1!==Object.keys(t).indexOf(o)?null===e[o]&&n.removed.push(o):null!==e[o]&&(n.added[o]=e[o])}return n},t.prototype.calculateContextDeltaV2=function(t,e){for(var n,i,r={added:{},updated:{},removed:[],reset:void 0,commands:[]},o=0,s=Object.keys(e);o<s.length;o++){var a=s[o];if(null!==e[a])Wa(t?t[a]:null,e[a])||null===(n=r.commands)||void 0===n||n.push({type:"set",path:a,value:e[a]});else null===(i=r.commands)||void 0===i||i.push({type:"remove",path:a})}return r},t}(),qa=function(){function t(t){this._bridge=new Ga(t)}return t.prototype.all=function(){return this._bridge.all()},t.prototype.update=function(t,e){return this.checkName(t),this.checkData(e),this._bridge.update(t,e)},t.prototype.set=function(t,e){return this.checkName(t),this.checkData(e),this._bridge.set(t,e)},t.prototype.setPath=function(t,e,n){return this.checkName(t),this.checkPath(e),""===e?(this.checkData(n),this.set(t,n)):this._bridge.setPath(t,e,n)},t.prototype.setPaths=function(t,e){if(this.checkName(t),!Array.isArray(e))throw new Error("Please provide the paths as an array of PathValues!");for(var n=0,i=e;n<i.length;n++){var r=i[n],o=r.path,s=r.value;this.checkPath(o),""===o&&this.checkData(s)}return this._bridge.setPaths(t,e)},t.prototype.subscribe=function(t,e){var n=this;if(this.checkName(t),"function"!=typeof e)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(t,(function(t,i,r,o,s){return e(t,i,r,(function(){return n._bridge.unsubscribe(o)}),s)})).then((function(t){return function(){n._bridge.unsubscribe(t)}}))},t.prototype.get=function(t){return this.checkName(t),this._bridge.get(t)},t.prototype.ready=function(){return Promise.resolve(this)},t.prototype.destroy=function(t){return this.checkName(t),this._bridge.destroy(t)},Object.defineProperty(t.prototype,"setPathSupported",{get:function(){return this._bridge.setPathSupported},enumerable:!0,configurable:!0}),t.prototype.checkName=function(t){if("string"!=typeof t||""===t)throw new Error("Please provide the name as a non-empty string!")},t.prototype.checkPath=function(t){if("string"!=typeof t)throw new Error("Please provide the path as a dot delimited string!")},t.prototype.checkData=function(t){if("object"!=typeof t)throw new Error("Please provide the data as an object!")},t}();function Ha(t,e,n){return"function"!=typeof e&&"function"!=typeof n?t:("function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n))}function Ua(t,e,n){var i;return void 0===t&&(t=0),e.finally((function(){i&&clearTimeout(i)})),new Promise((function(e,r){i=setTimeout((function(){return r(n)}),t)}))}!function(t){t[t.Success=0]="Success",t[t.Error=1]="Error"}(Ba||(Ba={}));var Va=function(){function t(t,e,n,i){this.protocol=t,this.repo=e,this.instance=n,this.configuration=i}return t.prototype.subscribe=function(t,e,n,i,r){var o=this,s=function(t,n,i,s){var a;e.methodResponseTimeout=null!==(a=e.methodResponseTimeout)&&void 0!==a?a:e.waitTimeoutMs,o.protocol.client.subscribe(n,e,t,i,s,r)};return Ha(new Promise((function(n,i){var r,a=function(t){n(t)},c=function(t){i(t)};if(t)if((r="string"==typeof t?{name:t}:t).name){void 0===e&&(e={});var u=e.target;if(void 0===u&&(u="best"),"string"!=typeof u||"all"===u||"best"===u){void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=e.method_response_timeout,void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=o.configuration.methodResponseTimeout)),void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=e.wait_for_method_timeout,void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=o.configuration.waitTimeoutMs));var d=0,p=o.getServerMethodsByFilterAndTarget(r,u);if(p.length>0)s(p,p[0].methods[0],a,c);else{var h=function(){if(u&&e.waitTimeoutMs)if(d+=500,(p=o.getServerMethodsByFilterAndTarget(r,u)).length>0){var n=p[0].methods[0];s(p,n,a,c)}else if(d>=e.waitTimeoutMs){s(p,"string"==typeof t?{name:t}:t,a,c)}else setTimeout(h,500)};setTimeout(h,500)}}else i(new Error('"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else i("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");else i("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")})),n,i)},t.prototype.servers=function(t){var e=void 0===t?void 0:ps({},t);return this.getServers(e).map((function(t){return t.server.instance}))},t.prototype.methods=function(t){return t="string"==typeof t?{name:t}:ps({},t),this.getMethods(t)},t.prototype.methodsForInstance=function(t){return this.getMethodsForInstance(t)},t.prototype.methodAdded=function(t){return this.repo.onMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.repo.onMethodRemoved(t)},t.prototype.serverAdded=function(t){return this.repo.onServerAdded(t)},t.prototype.serverRemoved=function(t){return this.repo.onServerRemoved((function(e,n){t(e,n)}))},t.prototype.serverMethodAdded=function(t){return this.repo.onServerMethodAdded((function(e,n){t({server:e,method:n})}))},t.prototype.serverMethodRemoved=function(t){return this.repo.onServerMethodRemoved((function(e,n){t({server:e,method:n})}))},t.prototype.invoke=function(t,e,n,i,r,o){return hs(this,void 0,void 0,(function(){var s=this;return fs(this,(function(a){return[2,Ha(function(){return hs(s,void 0,void 0,(function(){var r,o,s,a,c,u,d,p,h,f,l=this;return fs(this,(function(v){switch(v.label){case 0:if(!(r="string"==typeof t?{name:t}:ps({},t)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")];if(e||(e={}),n||(n="best"),"string"==typeof n&&"all"!==n&&"best"!==n&&"skipMine"!==n)return[2,Promise.reject(new Error('"'+n+'" is not a valid target. Valid targets are "all" and "best".'))];if(i||(i={}),void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=i.method_response_timeout,void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=i.wait_for_method_timeout,void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==i.waitTimeoutMs&&"number"!=typeof i.waitTimeoutMs)return[2,Promise.reject(new Error('"'+i.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof e)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+r.name))];if(0!==(o=this.getServerMethodsByFilterAndTarget(r,n)).length)return[3,4];v.label=1;case 1:return v.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(r,n,i)];case 2:return o=v.sent(),[3,4];case 3:return v.sent(),s=ps(ps({},r),{getServers:function(){return[]},supportsStreaming:!1,objectTypes:null!==(f=r.objectTypes)&&void 0!==f?f:[]}),a={method:s,called_with:e,message:"Can not find a method matching "+JSON.stringify(t)+" with server filter "+JSON.stringify(n),executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(a)];case 4:return c=i.methodResponseTimeoutMs,u=i,d=o.map((function(t){var n=pa(),i=t.methods[0],r=t.server,o=l.protocol.client.invoke(n,i,e,r,u);return Promise.race([o,Ua(c,o,{invocationId:n,message:"Invocation timeout ("+c+" ms) reached for method name: "+(null==i?void 0:i.name)+", target instance: "+JSON.stringify(r.instance)+", options: "+JSON.stringify(u),status:Ba.Error})])})),[4,Promise.all(d)];case 5:return p=v.sent(),h=this.getInvocationResultObj(p,r,e),p.every((function(t){return t.status===Ba.Error}))?[2,Promise.reject(h)]:[2,h]}}))}))}(),r,o)]}))}))},t.prototype.getInvocationResultObj=function(t,e,n){var i=t.filter((function(t){return t.status===Ba.Success})).reduce((function(t,i){return t=ls(t,[{executed_by:i.instance,returned:i.result,called_with:n,method:e,message:i.message,status:i.status}])}),[]),r=t.filter((function(t){return t.status===Ba.Error})).reduce((function(t,i){return t=ls(t,[{executed_by:i.instance,called_with:n,name:e.name,message:i.message}])}),[]),o=t[0];return{method:e,called_with:n,returned:o.result,executed_by:o.instance,all_return_values:i,all_errors:r,message:o.message,status:o.status}},t.prototype.tryToAwaitForMethods=function(t,e,n){var i=this;return new Promise((function(r,o){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=i.getServerMethodsByFilterAndTarget(t,e);if(c.length>0)clearInterval(a),r(c);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(a),void o()}),500);else o()}))},t.prototype.filterByTarget=function(t,e){var n=this;if("string"!=typeof t){return(Array.isArray(t)?t:[t]).reduce((function(t,i){var r=e.filter((function(t){return n.instanceMatch(i,t.server.instance)}));return t.concat(r)}),[])}if("all"===t)return ls(e);if("best"===t){var i=e.find((function(t){return t.server.instance.isLocal}));if(i)return[i];if(void 0!==e[0])return[e[0]]}else if("skipMine"===t)return e.filter((function(t){return t.server.instance.peerId!==n.instance.peerId}));return[]},t.prototype.instanceMatch=function(t,e){return this.containsProps(t,e)},t.prototype.methodMatch=function(t,e){return this.containsProps(t,e)},t.prototype.containsProps=function(t,e){return Object.keys(t).filter((function(e){return void 0!==t[e]&&"function"!=typeof t[e]&&"object_types"!==e&&"display_name"!==e&&"id"!==e&&"gatewayId"!==e&&"identifier"!==e&&"_"!==e[0]})).reduce((function(n,i){var r=t[i],o=e[i];if("objectTypes"===i){(r.length>o.length||!1===function(t,e){var n=t.reduce((function(t,e){return t[e]=!1,t}),{});e.forEach((function(t){void 0!==n[t]&&(n[t]=!0)}));return Object.keys(n).reduce((function(t,e){return n[e]||(t=!1),t}),!0)}(r,o))&&(n=!1)}else String(r).toLowerCase()!==String(o).toLowerCase()&&(n=!1);return n}),!0)},t.prototype.getMethods=function(t){var e=this;return void 0===t?this.repo.getMethods():this.repo.getMethods().filter((function(n){return e.methodMatch(t,n)}))},t.prototype.getMethodsForInstance=function(t){var e=this,n=this.repo.getServers().filter((function(n){return e.instanceMatch(t,n.instance)}));if(0===n.length)return[];var i={};return 1===n.length?i=n[0].methods:n.forEach((function(t){Object.keys(t.methods).forEach((function(e){var n=t.methods[e];i[n.identifier]=n}))})),Object.keys(i).map((function(t){return i[t]}))},t.prototype.getServers=function(t){var e=this,n=this.repo.getServers();return void 0===t?n.map((function(t){return{server:t,methods:[]}})):n.reduce((function(n,i){var r=e.repo.getServerMethodsById(i.id).filter((function(n){return e.methodMatch(t,n)}));return r.length>0&&n.push({server:i,methods:r}),n}),[])},t.prototype.getServerMethodsByFilterAndTarget=function(t,e){var n=this.getServers(t);return this.filterByTarget(e,n)},t}(),Ja=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.subscription=n}return Object.defineProperty(t.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),t.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},t.prototype.push=function(t){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,t)},t}(),za=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return t.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},t.prototype.acceptOnBranch=function(t){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,t)},t.prototype.reject=function(t){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,t)},t}(),Ka=function(){function t(t,e){var n=this;this.protocol=t,this.server=e,t.server.onSubRequest((function(t,e){return n.handleSubRequest(t,e)})),t.server.onSubAdded((function(t,e){return n.handleSubAdded(t,e)})),t.server.onSubRemoved((function(t,e){return n.handleSubRemoved(t,e)}))}return t.prototype.handleSubRequest=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRequestHandler){var n=new za(this.protocol,e,t);e.streamCallbacks.subscriptionRequestHandler(n)}},t.prototype.handleSubAdded=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionAddedHandler){var n=new Ja(this.protocol,e,t);e.streamCallbacks.subscriptionAddedHandler(n)}},t.prototype.handleSubRemoved=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRemovedHandler){var n=new Ja(this.protocol,e,t);e.streamCallbacks.subscriptionRemovedHandler(n)}},t}(),Ya=function(){function t(t,e,n){this.key=t,this.protocol=e,this.repoMethod=n}return t.prototype.subscriptions=function(){var t=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(e){return new Ja(t.protocol,t.repoMethod,e)}))},t.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},t.prototype.push=function(t){this.protocol.server.pushData(this.repoMethod,t,[this.key])},t}(),Za=function(){function t(t,e,n){this._protocol=t,this._repoMethod=e,this._server=n,this.name=this._repoMethod.definition.name}return t.prototype.branches=function(t){var e=this,n=this._protocol.server.getBranchList(this._repoMethod);return t?n.indexOf(t)>-1?new Ya(t,this._protocol,this._repoMethod):void 0:n.map((function(t){return new Ya(t,e._protocol,e._repoMethod)}))},t.prototype.branch=function(t){return this.branches(t)},t.prototype.subscriptions=function(){var t=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(e){return new Ja(t._protocol,t._repoMethod,e)}))},Object.defineProperty(t.prototype,"definition",{get:function(){var t=this._repoMethod.definition;return{accepts:t.accepts,description:t.description,displayName:t.displayName,name:t.name,objectTypes:t.objectTypes,returns:t.returns,supportsStreaming:t.supportsStreaming}},enumerable:!0,configurable:!0}),t.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},t.prototype.push=function(t,e){if("string"!=typeof e&&!Array.isArray(e)&&void 0!==e)throw new Error("invalid branches should be string or string array");if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,t,e)},t.prototype.updateRepoMethod=function(t){this._repoMethod=t},t}(),Qa=function(){function t(t,e){this.protocol=t,this.serverRepository=e,this.invocations=0,this.currentlyUnregistering={},this.streaming=new Ka(t,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return t.prototype.createStream=function(t,e,n,i,r){var o=this;return Ha(new Promise((function(n,i){if(t){var s;if(!(s="string"==typeof t?{name:""+t}:ps({},t)).name)return i("The name property is required for the streamDefinition object and must be unique. Stream definition: "+JSON.stringify(s));if(o.serverRepository.getList().some((function(t){return t.definition.name===s.name})))return i('A stream with the name "'+s.name+'" already exists! Please, provide a unique name for the stream.');s.supportsStreaming=!0,e||(e={}),"function"!=typeof e.subscriptionRequestHandler&&(e.subscriptionRequestHandler=function(t){t.accept()});var a=o.serverRepository.add({definition:s,streamCallbacks:e,protocolState:{}});o.protocol.server.createStream(a).then((function(){var t;r?(t=r,r.updateRepoMethod(a)):t=new Za(o.protocol,a,o),a.stream=t,n(t)})).catch((function(t){a.repoId&&o.serverRepository.remove(a.repoId),i(t)}))}else i("The stream name must be unique! Please, provide either a unique string for a stream name to glue.interop.createStream() or a methodDefinition object with a unique name property for the stream.")})),n,i)},t.prototype.register=function(t,e){var n=this;if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var i=function(t,i){return hs(n,void 0,void 0,(function(){var n,r,o;return fs(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),(n=e(t.args,t.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return r=s.sent(),i(void 0,r),[3,3];case 2:i(void 0,n),s.label=3;case 3:return[3,5];case 4:return(o=s.sent())||(o=""),i(o,o),[3,5];case 5:return[2]}}))}))};return i.userCallback=e,this.registerCore(t,i)},t.prototype.registerAsync=function(t,e){if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var n=function(t,n){try{var i=!1,r=function(t){i||n(void 0,t),i=!0},o=function(t){i||(t||(t=""),n(t,t)),i=!0},s=e(t.args,t.instance,r,o);s&&"function"==typeof s.then&&s.then(r).catch(o)}catch(t){n(t,void 0)}};return n.userCallbackAsync=e,this.registerCore(t,n)},t.prototype.unregister=function(t,e){return void 0===e&&(e=!1),hs(this,void 0,void 0,(function(){var n,i;return fs(this,(function(r){switch(r.label){case 0:return void 0===t?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a name property.")]:"function"!=typeof t?[3,2]:[4,this.unregisterWithPredicate(t,e)];case 1:return r.sent(),[2];case 2:return void 0===(n="string"==typeof t?{name:t}:t).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(i=this.serverRepository.getList().find((function(t){return t.definition.name===n.name&&(t.definition.supportsStreaming||!1)===e})))?[4,this.removeMethodsOrStreams([i])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return r.sent(),[2]}}))}))},t.prototype.unregisterWithPredicate=function(t,e){return hs(this,void 0,void 0,(function(){var n;return fs(this,(function(i){switch(i.label){case 0:return(n=this.serverRepository.getList().filter((function(e){return t(e.definition)})).filter((function(t){return(t.definition.supportsStreaming||!1)===e})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(e?"stream":"method")+" matching the specified condition!")];case 1:return i.sent(),[2]}}))}))},t.prototype.removeMethodsOrStreams=function(t){var e=this,n=[];return t.forEach((function(t){var i=e.protocol.server.unregister(t).then((function(){t.repoId&&e.serverRepository.remove(t.repoId)}));n.push(i),e.addAsCurrentlyUnregistering(t.definition.name,i)})),Promise.all(n)},t.prototype.addAsCurrentlyUnregistering=function(t,e){return hs(this,void 0,void 0,(function(){var n,i=this;return fs(this,(function(r){return n=new Promise((function(t){return setTimeout(t,5e3)})),this.currentlyUnregistering[t]=Promise.race([e,n]).then((function(){delete i.currentlyUnregistering[t]})),[2]}))}))},t.prototype.registerCore=function(t,e){return hs(this,void 0,void 0,(function(){var n,i,r,o=this;return fs(this,(function(s){switch(s.label){case 0:return(n="string"==typeof t?{name:""+t}:ps({},t)).name?(i=this.currentlyUnregistering[n.name])?[4,i]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the name property in the methodDefinition object: "+JSON.stringify(t))];case 1:s.sent(),s.label=2;case 2:return this.serverRepository.getList().some((function(t){return t.definition.name===n.name}))?[2,Promise.reject('A method with the name "'+n.name+'" already exists! Please, provide a unique name for the method.')]:n.supportsStreaming?[2,Promise.reject("When you create methods with glue.interop.register() or glue.interop.registerAsync() the property supportsStreaming cannot be true. If you want "+n.name+" to be a stream, please use the glue.interop.createStream() method.")]:(r=this.serverRepository.add({definition:n,theFunction:e,protocolState:{}}),[2,this.protocol.server.register(r).catch((function(t){throw(null==r?void 0:r.repoId)&&o.serverRepository.remove(r.repoId),t}))])}}))}))},t.prototype.onMethodInvoked=function(t,e,n){var i=this;t&&t.theFunction&&t.theFunction(n,(function(n,r){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(t){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}r?("object"!=typeof r||Array.isArray(r))&&(r={_value:r}):r={},i.protocol.server.methodInvocationResult(t,e,n,r)}))},t}(),Xa=function(){function t(t,e){var n=this;this.wrapped={getMethods:$a,getStreams:tc},t&&this.refreshWrappedObject(t),e&&(e.loggedIn((function(){n.refresh(e)})),this.refresh(e))}return t.prototype.unwrap=function(){return this.wrapped},t.prototype.refresh=function(t){if(t){var e=null==t?void 0:t.resolvedIdentity,n=Object.assign({},null!=e?e:{},{peerId:null==t?void 0:t.peerId});this.refreshWrappedObject(n)}},t.prototype.refreshWrappedObject=function(t){var e,n,i;this.wrapped.user=t.user,this.wrapped.instance=t.instance,this.wrapped.application=null!==(e=t.application)&&void 0!==e?e:pa(),this.wrapped.applicationName=t.applicationName,this.wrapped.pid=null!==(i=null!==(n=t.pid)&&void 0!==n?n:t.process)&&void 0!==i?i:Math.floor(1e10*Math.random()),this.wrapped.machine=t.machine,this.wrapped.environment=t.environment,this.wrapped.region=t.region,this.wrapped.windowId=t.windowId,this.wrapped.isLocal=!0,this.wrapped.api=t.api,this.wrapped.service=t.service,this.wrapped.peerId=t.peerId},t}();function $a(){var t;return null===(t=Xa.API)||void 0===t?void 0:t.methodsForInstance(this)}function tc(){var t;return null===(t=Xa.API)||void 0===t?void 0:t.methodsForInstance(this).filter((function(t){return t.supportsStreaming}))}var ec=function(){function t(t){this.logger=t,this.servers={},this.methodsCount={},this.callbacks=Bs()}return t.prototype.addServer=function(t,e){this.logger.debug("adding server "+e);var n=this.servers[e];if(n)return n.id;var i=new Xa(t),r={id:e,methods:{},instance:i.unwrap(),wrapper:i};return this.servers[e]=r,this.callbacks.execute("onServerAdded",r.instance),e},t.prototype.removeServerById=function(t,e){var n=this,i=this.servers[t];i?(this.logger.debug("removing server "+t),Object.keys(i.methods).forEach((function(e){n.removeServerMethod(t,e)})),delete this.servers[t],this.callbacks.execute("onServerRemoved",i.instance,e)):this.logger.warn("not aware of server "+t+", my state "+JSON.stringify(Object.keys(this.servers)))},t.prototype.addServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");if(!n.methods[e.id]){var i=this.createMethodIdentifier(e),r=this,o={identifier:i,gatewayId:e.id,name:e.name,displayName:e.display_name,description:e.description,version:e.version,objectTypes:e.object_types||[],accepts:e.input_signature,returns:e.result_signature,supportsStreaming:void 0!==e.flags&&e.flags.streaming,getServers:function(){return r.getServersByMethod(i)}};return o.object_types=o.objectTypes,o.display_name=o.displayName,o.version=o.version,n.methods[e.id]=o,this.methodsCount[i]||(this.methodsCount[i]=0,this.callbacks.execute("onMethodAdded",o)),this.methodsCount[i]=this.methodsCount[i]+1,this.callbacks.execute("onServerMethodAdded",n.instance,o),o}},t.prototype.removeServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");var i=n.methods[e];delete n.methods[e],this.methodsCount[i.identifier]=this.methodsCount[i.identifier]-1,0===this.methodsCount[i.identifier]&&this.callbacks.execute("onMethodRemoved",i),this.callbacks.execute("onServerMethodRemoved",n.instance,i)},t.prototype.getMethods=function(){var t=this,e={};return Object.keys(this.servers).forEach((function(n){var i=t.servers[n];Object.keys(i.methods).forEach((function(t){var n=i.methods[t];e[n.identifier]=n}))})),Object.keys(e).map((function(t){return e[t]}))},t.prototype.getServers=function(){var t=this,e=[];return Object.keys(this.servers).forEach((function(n){var i=t.servers[n];e.push(i)})),e},t.prototype.getServerMethodsById=function(t){var e=this.servers[t];return Object.keys(e.methods).map((function(t){return e.methods[t]}))},t.prototype.onServerAdded=function(t){var e=this.callbacks.add("onServerAdded",t),n=this.getServers().map((function(t){return t.instance}));return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onMethodAdded=function(t){var e=this.callbacks.add("onMethodAdded",t),n=this.getMethods();return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onServerMethodAdded=function(t){var e=this.callbacks.add("onServerMethodAdded",t),n=!1,i=this.getServers();return setTimeout((function(){i.forEach((function(e){var i=e.methods;Object.keys(i).forEach((function(r){n||t(e.instance,i[r])}))}))}),0),function(){n=!0,e()}},t.prototype.onMethodRemoved=function(t){return this.callbacks.add("onMethodRemoved",t)},t.prototype.onServerRemoved=function(t){return this.callbacks.add("onServerRemoved",t)},t.prototype.onServerMethodRemoved=function(t){return this.callbacks.add("onServerMethodRemoved",t)},t.prototype.getServerById=function(t){return this.servers[t]},t.prototype.reset=function(){var t=this;Object.keys(this.servers).forEach((function(e){t.removeServerById(e,"reset")})),this.servers={},this.methodsCount={}},t.prototype.createMethodIdentifier=function(t){var e=void 0!==t.input_signature?t.input_signature:"",n=void 0!==t.result_signature?t.result_signature:"";return(t.name+e+n).toLowerCase()},t.prototype.getServersByMethod=function(t){var e=this,n=[];return Object.keys(this.servers).forEach((function(i){var r=e.servers[i];Object.keys(r.methods).forEach((function(e){r.methods[e].identifier===t&&n.push(r.instance)}))})),n},t.prototype.returnUnsubWithDelayedReplay=function(t,e,n){var i=!1;return setTimeout((function(){e.forEach((function(t){i||n(t)}))}),0),function(){i=!0,t()}},t}(),nc=function(){function t(){this.nextId=0,this.methods=[]}return t.prototype.add=function(t){return t.repoId=String(this.nextId),this.nextId+=1,this.methods.push(t),t},t.prototype.remove=function(t){if("string"!=typeof t)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(e){return e.repoId!==t}))},t.prototype.getById=function(t){if("string"==typeof t)return this.methods.find((function(e){return e.repoId===t}))},t.prototype.getList=function(){return this.methods.map((function(t){return t}))},t.prototype.length=function(){return this.methods.length},t.prototype.reset=function(){this.methods=[]},t}(),ic="onSubscriptionRequest",rc="onSubscriptionAdded",oc="onSubscriptionRemoved",sc=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.serverRepository=n,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=Bs(),this.nextStreamId=0,t.on("add-interest",(function(t){i.handleAddInterest(t)})),t.on("remove-interest",(function(t){i.handleRemoveInterest(t)}))}return t.prototype.acceptRequestOnBranch=function(t,e,n){if("string"!=typeof n&&(n=""),"object"!=typeof e.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(e.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var i=this.getStreamId(e,n),r=t.msg.subscription_id,o={id:r,arguments:t.arguments,instance:t.instance,branchKey:n,streamId:i,subscribeMsg:t.msg};e.protocolState.subscriptionsMap[r]=o,this.session.sendFireAndForget({type:"accepted",subscription_id:r,stream_id:i}),this.callbacks.execute(rc,o,e)},t.prototype.rejectRequest=function(t,e,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,t.msg.subscription_id)},t.prototype.pushData=function(t,e,n){var i=this;if("object"==typeof t&&Array.isArray(t.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]),t.protocolState.branchKeyToStreamIdMap.filter((function(t){return!n||0===n.length||n.indexOf(t.key)>=0})).map((function(t){return t.streamId})).forEach((function(t){var n={type:"publish",stream_id:t,data:e};i.session.sendFireAndForget(n)}))}},t.prototype.pushDataToSingle=function(t,e,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var i={type:"post",subscription_id:e.id,data:n};this.session.sendFireAndForget(i)},t.prototype.closeSingleSubscription=function(t,e){t.protocolState.subscriptionsMap&&delete t.protocolState.subscriptionsMap[e.id];var n={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);e.instance;this.callbacks.execute(oc,e,t)},t.prototype.closeMultipleSubscriptions=function(t,e){var n=this;if("object"==typeof t&&"object"==typeof t.protocolState.subscriptionsMap&&t.protocolState.subscriptionsMap){var i=t.protocolState.subscriptionsMap,r=Object.keys(i).map((function(t){return i[t]}));"string"==typeof e&&(r=r.filter((function(t){return t.branchKey===e}))),r.forEach((function(t){delete i[t.id];var e={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping all subscriptions on stream_id: "+t.streamId};n.session.sendFireAndForget(e)}))}},t.prototype.getSubscriptionList=function(t,e){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var n=t.protocolState.subscriptionsMap,i=Object.keys(n).map((function(t){return n[t]}));return"string"!=typeof e?i:i.filter((function(t){return t.branchKey===e}))},t.prototype.getBranchList=function(t){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var e=t.protocolState.subscriptionsMap,n=Object.keys(e).map((function(t){return e[t]})),i=[];return n.forEach((function(t){var e="";"object"==typeof t&&"string"==typeof t.branchKey&&(e=t.branchKey),-1===i.indexOf(e)&&i.push(e)})),i},t.prototype.onSubAdded=function(t){this.onSubscriptionLifetimeEvent(rc,t)},t.prototype.onSubRequest=function(t){this.onSubscriptionLifetimeEvent(ic,t)},t.prototype.onSubRemoved=function(t){this.onSubscriptionLifetimeEvent(oc,t)},t.prototype.handleRemoveInterest=function(t){var e=this.serverRepository.getById(t.method_id);if("string"==typeof t.subscription_id&&"object"==typeof e&&e.protocolState.subscriptionsMap&&"object"==typeof e.protocolState.subscriptionsMap[t.subscription_id]){var n=e.protocolState.subscriptionsMap[t.subscription_id];delete e.protocolState.subscriptionsMap[t.subscription_id],this.callbacks.execute(oc,n,e)}},t.prototype.onSubscriptionLifetimeEvent=function(t,e){this.callbacks.add(t,e)},t.prototype.getNextStreamId=function(){return this.nextStreamId+++""},t.prototype.handleAddInterest=function(t){var e=this.repository.getServerById(t.caller_id).instance,n={msg:t,arguments:t.arguments_kv||{},instance:e},i=this.serverRepository.getById(t.method_id);if(void 0!==i)i.protocolState.subscriptionsMap&&i.protocolState.subscriptionsMap[t.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+t.subscription_id+" already exists.",t.subscription_id):this.callbacks.execute(ic,n,i);else{var r="No method with id "+t.method_id+" on this server.";this.sendSubscriptionFailed(r,t.subscription_id)}},t.prototype.sendSubscriptionFailed=function(t,e){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:t,request_id:e};this.session.sendFireAndForget(n)},t.prototype.getStreamId=function(t,e){if("string"!=typeof e&&(e=""),!t.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+t.definition.name+" method without protocol state");var n=t.protocolState.branchKeyToStreamIdMap.filter((function(t){return t.key===e}))[0],i=n?n.streamId:void 0;return"string"==typeof i&&""!==i||(i=this.getNextStreamId(),t.protocolState.branchKeyToStreamIdMap.push({key:e,streamId:i})),i},t}(),ac=function(){function t(t,e,n,i){var r=this;this.session=t,this.clientRepository=e,this.serverRepository=n,this.logger=i,this.callbacks=Bs(),this.streaming=new sc(t,e,n),this.session.on("invoke",(function(t){return r.handleInvokeMessage(t)}))}return t.prototype.createStream=function(t){return t.protocolState.subscriptionsMap={},t.protocolState.branchKeyToStreamIdMap=[],this.register(t,!0)},t.prototype.register=function(t,e){var n=this,i=t.definition,r={streaming:e||!1},o={type:"register",methods:[{id:t.repoId,name:i.name,display_name:i.displayName,description:i.description,version:i.version,flags:r,object_types:i.objectTypes||i.object_types,input_signature:i.accepts,result_signature:i.returns,restrictions:void 0}]};return this.session.send(o,{methodId:t.repoId}).then((function(){n.logger.debug("registered method "+t.definition.name+" with id "+t.repoId)})).catch((function(e){throw n.logger.warn("failed to register method "+t.definition.name+" with id "+t.repoId+" - "+JSON.stringify(e)),e}))},t.prototype.onInvoked=function(t){this.callbacks.add("onInvoked",t)},t.prototype.methodInvocationResult=function(t,e,n,i){var r;r=n||""===n?{type:"error",request_id:e,reason_uri:"agm.errors.client_error",reason:n,context:i,peer_id:void 0}:{type:"yield",invocation_id:e,peer_id:this.session.peerId,result:i,request_id:void 0},this.session.sendFireAndForget(r)},t.prototype.unregister=function(t){return hs(this,void 0,void 0,(function(){var e;return fs(this,(function(n){switch(n.label){case 0:return e={type:"unregister",methods:[t.repoId]},[4,this.session.send(e)];case 1:return n.sent(),[2]}}))}))},t.prototype.getBranchList=function(t){return this.streaming.getBranchList(t)},t.prototype.getSubscriptionList=function(t,e){return this.streaming.getSubscriptionList(t,e)},t.prototype.closeAllSubscriptions=function(t,e){this.streaming.closeMultipleSubscriptions(t,e)},t.prototype.pushData=function(t,e,n){this.streaming.pushData(t,e,n)},t.prototype.pushDataToSingle=function(t,e,n){this.streaming.pushDataToSingle(t,e,n)},t.prototype.closeSingleSubscription=function(t,e){this.streaming.closeSingleSubscription(t,e)},t.prototype.acceptRequestOnBranch=function(t,e,n){this.streaming.acceptRequestOnBranch(t,e,n)},t.prototype.rejectRequest=function(t,e,n){this.streaming.rejectRequest(t,e,n)},t.prototype.onSubRequest=function(t){this.streaming.onSubRequest(t)},t.prototype.onSubAdded=function(t){this.streaming.onSubAdded(t)},t.prototype.onSubRemoved=function(t){this.streaming.onSubRemoved(t)},t.prototype.handleInvokeMessage=function(t){var e=t.invocation_id,n=t.caller_id,i=t.method_id,r=t.arguments_kv,o=this.serverRepository.getList().filter((function(t){return t.repoId===i}))[0];if(void 0!==o){var s={args:r,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",o,e,s)}},t}(),cc=function(){function t(t,e){this.repository=t,this.subscriptionData=e}return Object.defineProperty(t.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"servers",{get:function(){var t=this;return this.subscriptionData.trackedServers.filter((function(t){return t.subscriptionId})).map((function(e){return t.repository.getServerById(e.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),t.prototype.onData=function(t){if("function"!=typeof t)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(t),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(e){t(e)}))},t.prototype.onClosed=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(t)},t.prototype.onFailed=function(t){},t.prototype.onConnected=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(t)},t.prototype.close=function(){this.subscriptionData.close()},t.prototype.setNewSubscription=function(t){this.subscriptionData=t},t}(),uc="awaitingAccept",dc="subscribed",pc="ClientInitiated",hc=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.logger=n,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(t){var e=t._tag,n=e.subLocalKey,r=i.subscriptionsList[n];if("object"==typeof r&&(r.trackedServers=r.trackedServers.filter((function(t){return t.serverId!==e.serverId})),r.trackedServers.length<=0)){if(clearTimeout(r.timeoutId),r.status===uc){var o="string"==typeof t.reason&&""!==t.reason?' Publisher said "'+t.reason+'".':" No reason given.",s="object"==typeof r.params.arguments?JSON.stringify(r.params.arguments):"{}";r.error({message:"Subscription rejected."+o+" Called with:"+s,called_with:r.params.arguments,method:r.method})}else r.status===dc&&i.callOnClosedHandlers(r);delete i.subscriptionsList[n]}},this.handleSubscribed=function(t){var e=t._tag.subLocalKey,n=i.subscriptionsList[e];if("object"==typeof n){var r=t._tag.serverId,o=n.trackedServers.filter((function(t){return t.serverId===r}))[0];if("object"==typeof o){o.subscriptionId=t.subscription_id,i.subscriptionIdToLocalKeyMap[t.subscription_id]=e;var s=n.status===uc;if(n.status=dc,s){var a=!1,c=n.subscription;c?(c.setNewSubscription(n),n.success(c),a=!0):(c=new cc(i.repository,n),n.subscription=c,n.success(c));for(var u=0,d=n.handlers.onConnected;u<d.length;u++){var p=d[u];try{p(c.serverInstance,a)}catch(t){}}}}}},this.handleEventData=function(t){var e=i.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=i.subscriptionsList[e];if("object"==typeof n){var r=n.trackedServers.filter((function(e){return e.subscriptionId===t.subscription_id}));if(1===r.length){var o=t.oob,s=r[0].serverId,a=function(){return{data:t.data,server:i.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:o}},c=n.handlers.onData,u=n.queued.data;c.length>0?c.forEach((function(t){"function"==typeof t&&t(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(t){var e=i.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=i.subscriptionsList[e];if("object"==typeof n){var r=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(e){return e.subscriptionId!==t.subscription_id||(n.queued.closers.push(e.serverId),!1)})),n.trackedServers.length===r&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),i.callOnClosedHandlers(n),delete i.subscriptionsList[e]),delete i.subscriptionIdToLocalKeyMap[t.subscription_id])}}},t.on("subscribed",this.handleSubscribed),t.on("event",this.handleEventData),t.on("subscription-cancelled",this.handleSubscriptionCancelled)}return t.prototype.subscribe=function(t,e,n,i,r,o){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,t,e,i,r,e.methodResponseTimeout||1e4,o);"object"==typeof c?n.forEach((function(n){var i=n.server.id,r=n.methods.find((function(e){return e.name===t.name}));if(r){c.trackedServers.push({serverId:i,subscriptionId:void 0});var o={type:"subscribe",server_id:i,method_id:r.gatewayId,arguments_kv:e.arguments};s.session.send(o,{serverId:i,subLocalKey:a}).then((function(t){return s.handleSubscribed(t)})).catch((function(t){return s.handleErrorSubscribing(t)}))}else s.logger.error("can not find method "+t.name+" for target "+n.server.id)})):r({method:t,called_with:e.arguments,message:"Subscription failed. Unable to register the user callbacks."})}else r({method:t,called_with:e.arguments,message:"Subscription failed. No available servers matched the target params."})},t.prototype.drainSubscriptions=function(){var t=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},t},t.prototype.getNextSubscriptionLocalKey=function(){var t=this.nextSubLocalKey;return this.nextSubLocalKey+=1,t},t.prototype.registerSubscription=function(t,e,n,i,r,o,s){var a=this,c={localKey:t,status:uc,method:e,params:n,success:i,error:r,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(t)},subscription:null==s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[t]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[t]){var i=a.subscriptionsList[t];i.status===uc?(r({method:e,called_with:n.arguments,message:"Subscription failed. Subscription attempt timed out after "+o+" ms."}),delete a.subscriptionsList[t]):i.status===dc&&i.trackedServers.length>0&&(i.trackedServers=i.trackedServers.filter((function(t){return void 0!==t.subscriptionId})),delete i.timeoutId,i.trackedServers.length<=0&&(a.callOnClosedHandlers(i),delete a.subscriptionsList[t]))}}),o),c},t.prototype.callOnClosedHandlers=function(t,e){var n,i=t.queued.closers.length,r=i>0?t.queued.closers[i-1]:null;void 0!==r&&"string"==typeof r&&(n=this.repository.getServerById(r).instance),t.handlers.onClosed.forEach((function(i){"function"==typeof i&&i({message:e||"ServerInitiated",requestArguments:t.params.arguments||{},server:n,stream:t.method})}))},t.prototype.closeSubscription=function(t){var e=this,n=this.subscriptionsList[t];"object"==typeof n&&(n.trackedServers.forEach((function(t){void 0!==t.subscriptionId&&(n.queued.closers.push(t.serverId),e.session.sendFireAndForget({type:"unsubscribe",subscription_id:t.subscriptionId,reason_uri:"",reason:pc}),delete e.subscriptionIdToLocalKeyMap[t.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,pc),delete this.subscriptionsList[t])},t}(),fc=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.logger=n,t.on("peer-added",(function(t){return i.handlePeerAdded(t)})),t.on("peer-removed",(function(t){return i.handlePeerRemoved(t)})),t.on("methods-added",(function(t){return i.handleMethodsAddedMessage(t)})),t.on("methods-removed",(function(t){return i.handleMethodsRemovedMessage(t)})),this.streaming=new hc(t,e,n)}return t.prototype.subscribe=function(t,e,n,i,r,o){this.streaming.subscribe(t,e,n,i,r,o)},t.prototype.invoke=function(t,e,n,i){var r=this,o=i.id,s={type:"call",server_id:o,method_id:e.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:t,serverId:o}).then((function(t){return r.handleResultMessage(t)})).catch((function(t){return r.handleInvocationError(t)}))},t.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},t.prototype.handlePeerAdded=function(t){var e=t.new_peer_id,n=t.identity,i=!t.meta||t.meta.local,r=Number(n.process),o={machine:n.machine,pid:isNaN(r)?n.process:r,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:e,api:n.api,isLocal:i};this.repository.addServer(o,e)},t.prototype.handlePeerRemoved=function(t){var e=t.removed_id,n=t.reason;this.repository.removeServerById(e,n)},t.prototype.handleMethodsAddedMessage=function(t){var e=this,n=t.server_id;t.methods.forEach((function(t){e.repository.addServerMethod(n,t)}))},t.prototype.handleMethodsRemovedMessage=function(t){var e=this,n=t.server_id,i=t.methods,r=this.repository.getServerById(n);Object.keys(r.methods).forEach((function(t){var o=r.methods[t];i.indexOf(o.gatewayId)>-1&&e.repository.removeServerMethod(n,t)}))},t.prototype.handleResultMessage=function(t){var e=t._tag.invocationId,n=t.result,i=t._tag.serverId;return{invocationId:e,result:n,instance:this.repository.getServerById(i).instance,status:Ba.Success,message:""}},t.prototype.handleInvocationError=function(t){if(this.logger.debug("handle invocation error "+JSON.stringify(t)),"_tag"in t){var e=t._tag.invocationId,n=t._tag.serverId,i=this.repository.getServerById(n),r=t.reason;return{invocationId:e,result:t.context,instance:i.instance,status:Ba.Error,message:r}}return{invocationId:"",message:t.message,status:Ba.Error,error:t}},t}();function lc(t,e,n,i,r,o){var s,a=r.logger.subLogger("gw3-protocol"),c=new Promise((function(t){s=t})),u=e.domain("agm",["subscribed"]),d=new ac(u,n,i,a.subLogger("server")),p=new fc(u,n,a.subLogger("client"));return u.onJoined((function(r){n.addServer(t,e.peerId),r?function(){a.info("reconnected - will replay registered methods and subscriptions");for(var t=0,e=p.drainSubscriptions();t<e.length;t++){var n=e[t],r=n.method,s=Object.assign({},n.params);a.info("trying to re-subscribe to method "+r.name),o.client.subscribe(r,s,void 0,void 0,n)}var c=i.getList();i.reset();for(var u=0,d=c;u<d.length;u++){var h=d[u],f=h.definition;a.info("re-publishing method "+f.name),h.stream?o.server.createStream(f,h.streamCallbacks,void 0,void 0,h.stream):h.theFunction&&h.theFunction.userCallback?o.register(f,h.theFunction.userCallback):h.theFunction&&h.theFunction.userCallbackAsync&&o.registerAsync(f,h.theFunction.userCallbackAsync)}}():s&&(s({client:p,server:d}),s=void 0)})),u.onLeft((function(){n.reset()})),u.join(),c}var vc=function(){function t(t){var e=this;if(void 0===t)throw new Error("configuration is required");if(void 0===t.connection)throw new Error("configuration.connections is required");var n,i=t.connection;if("number"!=typeof t.methodResponseTimeout&&(t.methodResponseTimeout=3e4),"number"!=typeof t.waitTimeoutMs&&(t.waitTimeoutMs=3e4),Xa.API=this,this.instance=new Xa(void 0,i).unwrap(),this.clientRepository=new ec(t.logger.subLogger("cRep")),this.serverRepository=new nc,3!==i.protocolVersion)throw new Error("protocol "+i.protocolVersion+" not supported");n=lc(this.instance,i,this.clientRepository,this.serverRepository,t,this),this.readyPromise=n.then((function(n){return e.protocol=n,e.client=new Va(e.protocol,e.clientRepository,e.instance,t),e.server=new Qa(e.protocol,e.serverRepository),e}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.serverRemoved=function(t){return this.client.serverRemoved(t)},t.prototype.serverAdded=function(t){return this.client.serverAdded(t)},t.prototype.serverMethodRemoved=function(t){return this.client.serverMethodRemoved(t)},t.prototype.serverMethodAdded=function(t){return this.client.serverMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.client.methodRemoved(t)},t.prototype.methodAdded=function(t){return this.client.methodAdded(t)},t.prototype.methodsForInstance=function(t){return this.client.methodsForInstance(t)},t.prototype.methods=function(t){return this.client.methods(t)},t.prototype.servers=function(t){return this.client.servers(t)},t.prototype.subscribe=function(t,e,n,i){return this.client.subscribe(t,e,n,i)},t.prototype.createStream=function(t,e,n,i){return this.server.createStream(t,e,n,i)},t.prototype.unregister=function(t){return this.server.unregister(t)},t.prototype.registerAsync=function(t,e){return this.server.registerAsync(t,e)},t.prototype.register=function(t,e){return this.server.register(t,e)},t.prototype.invoke=function(t,e,n,i,r,o){return this.client.invoke(t,e,n,i,r,o)},t}(),yc=["subscribed","success"],gc=function(){function t(t,e){var n=this;this.publish=function(t,e,i){var r=i||{},o=r.routingKey,s=r.target,a=n.removeEmptyValues({type:"publish",topic:t,data:e,peer_id:n.peerId,routing_key:o,target_identity:s});n.session.send(a)},this.subscribe=function(t,e,i){return new Promise((function(r,o){var s=i||{},a=s.routingKey,c=s.target,u=n.removeEmptyValues({type:"subscribe",topic:t,peer_id:n.peerId,routing_key:a,source:c});n.session.send(u).then((function(i){var o=i.subscription_id;n.subscriptions.push({subscription_id:o,topic:t,callback:e,source:c}),r({unsubscribe:function(){return n.session.send({type:"unsubscribe",subscription_id:o,peer_id:n.peerId}),n.subscriptions=n.subscriptions.filter((function(t){return t.subscription_id!==o})),Promise.resolve()}})})).catch((function(t){return o(t)}))}))},this.watchOnEvent=function(){n.session.on("event",(function(t){var e=t.data,i=t.subscription_id,r=t["publisher-identity"],o=n.subscriptions.find((function(t){return t.subscription_id===i}));o&&(o.source?n.keysMatch(o.source,r)&&o.callback(e,o.topic,r):o.callback(e,o.topic,r))}))},this.connection=t,this.logger=e,this.peerId=t.peerId,this.subscriptions=[],this.session=t.domain("bus",yc),this.readyPromise=this.session.join(),this.readyPromise.then((function(){n.watchOnEvent()}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.removeEmptyValues=function(t){var e={};return Object.keys(t).forEach((function(n){void 0!==t[n]&&null!==t[n]&&(e[n]=t[n])})),e},t.prototype.keysMatch=function(t,e){var n=Object.keys(t),i=!0;return n.forEach((function(n){t[n]!==e[n]&&(i=!1)})),i},t}(),mc=function(t,e){var n,i=Hs.getGDMajorVersion(),r=Promise.resolve();if(i){if(i<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");i>=3&&(n=window.glue42gd,r=window.gdPreloadPromise||r)}var o,s,a,c,u,d,p,h=Js("glue"),f=function(t,e,n){var i,r,o,s,a,c;if(Hs.isNode()){var u=process.env._GD_STARTING_CONTEXT_;if(u)try{c=JSON.parse(u)}catch(t){}}function d(){if(t.application)return t.application;if(n)return n.applicationName;var e=pa();return Hs.isNode()?c?c.applicationConfig.name:"NodeJS"+e:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+" ("+e+")":e}var p=function(){var i,r,o,s,a,u,p,h,f,l=t.gateway,v=null!==(i=null==l?void 0:l.protocolVersion)&&void 0!==i?i:3,y=null==l?void 0:l.reconnectInterval,g=null==l?void 0:l.reconnectAttempts,m=null==l?void 0:l.ws,w=null==l?void 0:l.sharedWorker,b=null==l?void 0:l.inproc;n&&(m=n.gwURL),Hs.isNode()&&c&&c.gwURL&&(m=c.gwURL),m||w||b||(m="ws://localhost:8385");var _=d(),I=_;void 0!==n?(u=n.windowId,p=n.pid,n.env&&(h=n.env.env,f=n.env.region),I=null!==(r=n.application)&&void 0!==r?r:"glue-app",a=n.appInstanceId):Hs.isNode()?(p=process.pid,c&&(h=c.env,f=c.region,a=c.instanceId)):u=window.name||pa();var S=null!==(s=null===(o=t.gateway)||void 0===o?void 0:o.replaySpecs)&&void 0!==s?s:[];return S.push(ja),{identity:{application:I,applicationName:_,windowId:u,instance:a,process:p,region:f,environment:h,api:e.version||Ea},reconnectInterval:y,ws:m,sharedWorker:w,inproc:b,protocolVersion:v,reconnectAttempts:g,replaySpecs:S}}(),h=d();if("undefined"!=typeof window){var f=window,l=f.htmlContainer?f.htmlContainer.containerName+"."+f.htmlContainer.application:null===(i=null==f?void 0:f.glue42gd)||void 0===i?void 0:i.application;l&&(h=l)}return{bus:null!==(r=t.bus)&&void 0!==r&&r,application:h,auth:function(){var e,n;return"string"==typeof t.auth?{token:t.auth}:t.auth?t.auth:Hs.isNode()&&c&&c.gwToken?{gatewayToken:c.gwToken}:(null===(e=t.gateway)||void 0===e?void 0:e.inproc)||(null===(n=t.gateway)||void 0===n?void 0:n.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var e,i,r,o=t.logger,s="warn";return o||(o=s),n&&(r=n.consoleLogLevel),"string"==typeof o?{console:null!=r?r:o,publish:s}:{console:null!==(e=null!=r?r:o.console)&&void 0!==e?e:s,publish:null!==(i=o.publish)&&void 0!==i?i:s}}(),connection:p,metrics:null===(o=t.metrics)||void 0===o||o,contexts:null===(s=t.contexts)||void 0===s||s,version:e.version||Ea,libs:null!==(a=e.libs)&&void 0!==a?a:[],customLogger:t.customLogger}}(t=t||{},e=e||{},n),l={};function v(t,e,n){(p=a.canPublish("trace"))&&a.trace("registering "+t+" module");var i=function(){e.initTime=n.stop(),e.initEndTime=n.endTime,e.marks=n.marks,p&&a.trace(t+" is ready - "+(n.endTime-n.startTime))};e.initStartTime=n.startTime,e.ready?e.ready().then((function(){i()})):i(),Array.isArray(t)||(t=[t]),t.forEach((function(t){l[t]=e,mc[t]=e}))}function y(){var t=Js("interop"),e={connection:o,logger:a.subLogger("interop")};return s=new vc(e),ga.Interop=s,v(["interop","agm"],s,t),Promise.resolve()}function g(){var t=f.activities&&3===o.protocolVersion;if(f.contexts||t){var e=Js("contexts");return v("contexts",u=new qa({connection:o,logger:a.subLogger("contexts")}),e),u}var n=o.replayer;n&&n.drain(ja.name)}function m(){return hs(this,void 0,void 0,(function(){var t;return fs(this,(function(e){return f.bus?(t=Js("bus"),v("bus",d=new gc(o,a.subLogger("bus")),t),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function w(t){try{return t.forEach((function(t){!function(t,e){var n=Js(t),i=e(l);i&&v(t,i,n)}(t.name,t.create)})),Promise.resolve()}catch(t){return Promise.reject(t)}}return r.then((function(){var t,e=Js("logger");return(a=new ga(""+(null===(t=f.connection.identity)||void 0===t?void 0:t.application),void 0,f.customLogger)).consoleLevel(f.logger.console),a.publishLevel(f.logger.publish),a.canPublish("debug")&&a.debug("initializing glue..."),v("logger",a,e),Promise.resolve(void 0)})).then((function(){var t=Js("connection");o=new va(f.connection,a.subLogger("connection"));var e=Promise.resolve(f.auth);return f.connection&&!f.auth&&(e=n?n.getGWToken().then((function(t){return{gatewayToken:t}})):Promise.reject("You need to provide auth information")),e.then((function(e){var n;if(t.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(e))throw new Error("Invalid auth object - "+JSON.stringify(e));return n=e,o.login(n)})).then((function(){return v("connection",o,t),f})).catch((function(t){throw o&&o.logout(),t}))})).then((function(){return Promise.all([(s=Js("metrics"),u=f.metrics,d=null==n?void 0:n.getMetricsPublishingEnabled,p=f.connection.identity,h=d||function(){return!0},l=null!==(t="boolean"!=typeof u&&u.disableAutoAppSystem)&&void 0!==t&&t,v("metrics",c=Ds({connection:u?o:void 0,logger:a.subLogger("metrics"),canUpdateMetric:h,system:"Glue42",service:null!==(e=null==p?void 0:p.service)&&void 0!==e?e:"metrics-service",instance:null!==(r=null!==(i=null==p?void 0:p.instance)&&void 0!==i?i:null==p?void 0:p.windowId)&&void 0!==r?r:pa(),disableAutoAppSystem:l,pagePerformanceMetrics:"boolean"!=typeof u?null==u?void 0:u.pagePerformanceMetrics:void 0}),s),Promise.resolve()),y(),g(),m()]);var t,e,i,r,s,u,d,p,h,l})).then((function(){return s.readyPromise})).then((function(){return w(f.libs||[])})).then((function(){var t=Object.keys(l).map((function(t){var e=l[t];return e.ready?e.ready():Promise.resolve()}));return Promise.all(t)})).then((function(){var i={coreVersion:Ea,version:f.version};h.stop();var r={feedback:function(t){s&&s.invoke("T42.ACS.Feedback",t,"best")},info:i,logger:a,interop:s,agm:s,connection:o,metrics:c,contexts:u,bus:d,version:f.version,userConfig:t,done:function(){return null==a||a.info("done called by user..."),o.logout()}};if(r.performance={get glueVer(){return f.version},get glueConfig(){return JSON.stringify(t)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var t=Vs;return Object.keys(t).map((function(e){var n=t[e];return{name:e,duration:n.endTime-n.startTime,marks:n.marks}}))}},Object.keys(l).forEach((function(t){var e=l[t];r[t]=e})),r.config={},Object.keys(f).forEach((function(t){r.config[t]=f[t]})),e&&e.extOptions&&Object.keys(e.extOptions).forEach((function(t){r.config[t]=null==e?void 0:e.extOptions[t]})),(null==e?void 0:e.enrichGlue)&&e.enrichGlue(r),n&&n.updatePerfData&&n.updatePerfData(r.performance),r.agm){var p=function(t,e,n){return function(){r.logger.warn("glue.js - 'glue.agm."+e+"' method is deprecated, use 'glue.interop."+n+"' instead."),t.apply(r.agm,arguments)}},v=r.agm;v.method_added=p(r.agm.methodAdded,"method_added","methodAdded"),v.method_removed=p(r.agm.methodRemoved,"method_removed","methodRemoved"),v.server_added=p(r.agm.serverAdded,"server_added","serverAdded"),v.server_method_aded=p(r.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),v.server_method_removed=p(r.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return r})).catch((function(t){return Promise.reject({err:t,libs:l})}))};"undefined"!=typeof window&&(window.GlueCore=mc),mc.version=Ea,mc.default=mc;var wc,bc=(wc=mc,function(t){return Vi(void 0,void 0,void 0,(function(){var e,n,i,r,o,s,a,c,u,d,p,h,f,l,v,y,g,m,w,b,_,I,S,x,k,C,A,T,P,M;return Ji(this,(function(j){switch(j.label){case 0:return[4,(E=t,Vi(void 0,void 0,void 0,(function(){var t,e,n,i;return Ji(this,(function(r){switch(r.label){case 0:return[4,Do(E=null!=E?E:{})];case 1:return t=r.sent(),(e=Ui(Ui(Ui({},Wo),t.glue),E)).worker=e.assets.location+"/"+No,"string"==typeof(null==e?void 0:e.extends)&&(n=e.extends.lastIndexOf("/"),i=e.extends.substr(0,n+1)+No,e.worker=i),t.layouts||(t.layouts={remoteType:"json"}),[2,Ui(Ui({},t),{glue:e})]}}))})))];case 1:if(e=j.sent(),n="undefined"!=typeof window,i=(null===(y=e.glue)||void 0===y?void 0:y.channels)||!1,r=(null===(g=e.glue)||void 0===g?void 0:g.appManager)||!1,n&&(null==(o=window)?void 0:o.glue42gd)&&(null==o?void 0:o.Glue))return[2,o.Glue({windows:!0,logger:null===(m=e.glue)||void 0===m?void 0:m.logger,channels:i,layouts:!0,appManager:r,libraries:t.libraries})];if(s=new yr,d={libs:[{name:"notifications",create:function(t){return new Oo(t.interop)}}],version:zi},i&&(p={name:"channels",create:function(t){return new po(t.contexts,e.channels)}},null===(w=d.libs)||void 0===w||w.push(p)),n&&(null===(b=d.libs)||void 0===b||b.push({name:"windows",create:function(t){return a=new Ir(t.interop,s)}},{name:"layouts",create:function(t){var n,i,r;if("json"===(null===(n=e.layouts)||void 0===n?void 0:n.remoteType)){var o=(null===(i=null==e?void 0:e.glue.assets)||void 0===i?void 0:i.location)||Ro;r=new ss(o)}var c=new os,d=new as,p=new qo(c,d,r);return u=new Go(p,a,s,t.interop,null==e?void 0:e.glue),new ao(u)}}),h={name:"appManager",create:function(t){var n;return c=new xo(a,t.interop,s,e.appManager,null===(n=e.glue)||void 0===n?void 0:n.application),r?c:void 0}},f={name:"intents",create:function(t){return new Eo(t.interop,a,c)}},null===(_=d.libs)||void 0===_||_.push(h,f)),l={gateway:{sharedWorker:null!==(S=null===(I=e.glue)||void 0===I?void 0:I.worker)&&void 0!==S?S:"/glue/worker.js",inproc:null===(x=e.glue)||void 0===x?void 0:x.inproc},logger:null===(k=e.glue)||void 0===k?void 0:k.logger,application:null===(C=e.glue)||void 0===C?void 0:C.application},n&&!window.SharedWorker)throw new Error("Cannot initialize Glue Web, because this environment does not support Shared Workers");return[4,fo((function(){return wc(l,d)}),1e4,"Glue Web initialization timed out")];case 2:return v=j.sent(),(null==t?void 0:t.libraries)?[4,Promise.all(t.libraries.map((function(t){return t(v,null==e?void 0:e.glue)})))]:[3,4];case 3:j.sent(),j.label=4;case 4:return n?[4,_r(v.windows.my(),v.interop,null===(A=v.appManager)||void 0===A?void 0:A.myInstance)]:[3,9];case 5:return j.sent(),(null===(P=null===(T=e.glue)||void 0===T?void 0:T.layouts)||void 0===P?void 0:P.autoRestore)?[4,null==u?void 0:u.restoreAutoSavedLayout()]:[3,7];case 6:j.sent(),j.label=7;case 7:return[4,cs(v,null!==(M=e.glue)&&void 0!==M?M:{},s,u)];case 8:j.sent(),j.label=9;case 9:return s.start(v.interop,v.logger.subLogger("control")),[2,v]}var E}))}))});if("undefined"!=typeof window){var _c=window;_c.GlueWeb=bc,delete _c.GlueCore}bc.default=bc,bc.version=zi;const Ic={application:window.fdc3AppName,context:!0,channels:!0,agm:!0},Sc=t=>((t=>{const e=["contexts","intents","channels","agm","appManager"];for(const n of e)if(void 0===t[n])throw new Error(`Failed to initialize @glue42/fdc3. @glue42/fdc3 depends on the Glue42 ${n.replace(/^./,n[0].toUpperCase())} API being available. Ignore this error if you do not plan on using FDC3.`)})(t),window.glue=t,t),xc=()=>{window.fdc3GluePromise=c?bc(Object.assign(Object.assign({},Ic),{appManager:!0})).then((t=>Sc(t))):d((()=>void 0!==window.glue42gd),300).then((()=>window.glue42gd.fdc3InitsGlue?(window.Glue||qi)(Object.assign(Object.assign({},Ic),{appManager:"full"})):d((()=>{var t,e;const n=null===(e=null===(t=window.glue42gd.originalGlue)||void 0===t?void 0:t.instances)||void 0===e?void 0:e.length;return void 0!==n&&n>0}),300,(()=>window.glue42gd.originalGlue.instances[0])))).then((t=>Sc(t)))},kc=()=>{xc();const t=(()=>{const t=v(),e=f();return Object.assign(Object.assign({},t),e)})();return Object.assign(Object.assign({},t),{version:"1.2.10"})};let Cc=window.fdc3;return void 0===Cc?(Cc=kc(),window.fdc3=Cc):console.warn("Defaulting to using the auto-injected fdc3."),Cc}));
//# sourceMappingURL=fdc3-glue42.js.map
