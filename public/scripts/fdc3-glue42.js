!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).web=e()}(this,(function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function t(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))}const e=(t,e)=>{let n=!1;return window.glue.contexts.subscribe(t,(t,i,r,o,s)=>{if(!n)return void(n=!0);s.updaterId===window.glue.interop.instance.instance||e(t,i,r,o,s)})},n=()=>t(void 0,void 0,void 0,(function*(){const t=yield window.glue.channels.all();return yield Promise.all(t.map(t=>window.glue.channels.get(t)))})),i=t=>0===Object.keys(t).length&&t.constructor===Object,r=!navigator.userAgent.toLowerCase().includes(" electron/");class o{constructor(t){this.type="system",this.id=t.name,this.displayMetadata=t.meta}broadcast(t){return window.glue.channels.publish(t,this.id)}getCurrentContext(e){return t(this,void 0,void 0,(function*(){const t=yield window.glue.channels.get(this.id),{data:n}=t;return e?n&&n.type===e?n:null:n}))}addContextListener(t,e){const n=2===arguments.length&&t,i=2===arguments.length?e:t,r=window.glue.channels.subscribeFor(this.id,t=>{n?(null==t?void 0:t.type)===n&&i(t):i(t)});return{unsubscribe(){r.then(t=>t())}}}join(){return window.glue.channels.join(this.id)}leave(){return window.glue.channels.leave()}}class s{constructor(t){this.id=t,this.type="app"}broadcast(t){return window.glue.contexts.update(this.id,t)}getCurrentContext(e){return t(this,void 0,void 0,(function*(){const t=yield window.glue.contexts.get(this.id),{data:n}=t;return e?n&&n.type===e?n:null:n}))}addContextListener(t,n){const i=2===arguments.length&&t,r=2===arguments.length?n:t,o=e(this.id,t=>{i?(null==t?void 0:t.type)===i&&r(t):r(t)});return{unsubscribe:()=>{o.then(t=>t())}}}}const a=t=>({unsubscribe(){t?"function"==typeof t?t():t.then(t=>t()):console.error("Could not unsubscribe!")}}),c=()=>{let c,u;const d={};let p=[];const h=e=>t(void 0,void 0,void 0,(function*(){return(yield window.glue.contexts.all()).some(t=>t===e)})),f=t=>!!t&&p.some(e=>e===t.id),l=t=>new s(t),v=t=>{I(d[t])},g=(t,e)=>{let n=()=>{u=null};return u={contextType:t,handler:e,setActualUnsub:t=>{n=t}},{unsubscribe:n}},y=t(void 0,void 0,void 0,(function*(){yield window.gluePromise,(yield n()).map(t=>{d[t.name]=new o(t)}),p=yield window.glue.channels.all();const t=yield window.glue.channels.current();r||(t&&v(t),window.glue.channels.changed(t=>{v(t)}))})),m=()=>t(void 0,void 0,void 0,(function*(){yield y;return p.map(t=>d[t])})),w=e=>t(void 0,void 0,void 0,(function*(){yield y;return(yield h(e))||(yield(e=>t(void 0,void 0,void 0,(function*(){yield window.glue.contexts.set(e,null)})))(e)),l(e)})),b=()=>t(void 0,void 0,void 0,(function*(){f(c)&&(yield c.leave())}));function _(t,n){const r=2===arguments.length&&t,o=2===arguments.length?n:t;if(!c){console.warn("You will start receiving broadcasts only after you join a channel !");const t=g(r,o);return window.gluePromise.then(()=>{const t=window.glue.appManager.myInstance.context;i(t)||o(t)}),t}const{id:s,type:u}=c,d=t=>"system"===u?window.glue.channels.subscribe(t):e(s,t),p=t=>{r?t.type===r&&o(t):o(t)},h=d(p);return a(h)}const I=t=>{if(c=t,u){const{contextType:t,handler:e,setActualUnsub:n}=u;n(_(t,e).unsubscribe),u=null}};return{getSystemChannels:m,getOrCreateChannel:e=>t(void 0,void 0,void 0,(function*(){const t=(yield m()).find(t=>t.id===e);return void 0===t?w(e):t})),joinChannel:e=>t(void 0,void 0,void 0,(function*(){yield y;const n=d[e]||(yield(e=>t(void 0,void 0,void 0,(function*(){if(yield y,!(yield h(e)))throw new Error("NoChannelFound");const t=l(e);return d[e]=t,t})))(e));if(!n)throw new Error("NoChannelFound");f(n)?n.join():yield b(),I(n)})),getCurrentChannel:()=>t(void 0,void 0,void 0,(function*(){return yield y,c})),leaveCurrentChannel:()=>t(void 0,void 0,void 0,(function*(){yield y,yield b(),c=null})),broadcast:e=>t(void 0,void 0,void 0,(function*(){if(yield y,!c)return void console.error("You must join a channel first.");const{id:t,type:n}=c;"system"===n?window.glue.channels.publish(e):window.glue.contexts.update(t,e)})),addContextListener:_}},u=t=>{const{name:e,handlers:n}=t;return{intent:{name:e,displayName:n[0].displayName},apps:t.handlers.map(t=>{const e=window.glue.appManager.application(t.applicationName);return{name:e.name,title:e.title,tooltip:e.userProperties.tooltip,description:e.userProperties.description,icons:e.userProperties.icons,images:e.userProperties.images}})}},d=(e,n)=>t(void 0,void 0,void 0,(function*(){try{yield e.start()}catch(t){}return new Promise((t,i)=>{const r=setTimeout(()=>{i(`Raise intent ${n} target ${e.name} application did not call addIntentListener after being started.`)},3e3),o=window.glue.interop.serverMethodAdded(e=>{e.method.name==="Tick42.FDC3.Intents."+n&&(clearTimeout(r),o(),t(e.server))})})})),p=()=>({open:(...e)=>t(void 0,void 0,void 0,(function*(){return yield window.gluePromise,((e,n)=>t(void 0,void 0,void 0,(function*(){const t=window.glue.appManager.application(e);if(!t)throw new Error("AppNotFound");try{yield t.start(n)}catch(t){}})))(...e)}))}),h=()=>{const e=(e,n)=>t(void 0,void 0,void 0,(function*(){const i=(yield t(void 0,void 0,void 0,(function*(){const t=(yield window.glue.appManager.applications()).flatMap(t=>{var e;return(null===(e=t.userProperties.intents)||void 0===e?void 0:e.map(e=>({intent:e,app:{name:t.name,title:t.title,tooltip:t.userProperties.tooltip,description:t.userProperties.description,icons:t.userProperties.icons,images:t.userProperties.images}})))||[]});return Array.from(new Set(t.map(t=>t.intent.name))).map(e=>{var n;return{intent:null===(n=t.find(t=>t.intent.name===e))||void 0===n?void 0:n.intent,apps:[...t.filter(t=>t.intent.name===e).map(t=>t.app)]}})}))).find(t=>{var i,r,o;return n?(null===(i=t.intent)||void 0===i?void 0:i.name)===e&&(null===(r=t.intent.contexts)||void 0===r?void 0:r.includes(n.type)):(null===(o=t.intent)||void 0===o?void 0:o.name)===e});if(!i)throw new Error("NoAppsFound");return i})),n=e=>t(void 0,void 0,void 0,(function*(){if(!e.type)throw new Error("Only filtering by context.type is supported.");return(yield(e=>t(void 0,void 0,void 0,(function*(){return(yield window.glue.appManager.applications()).flatMap(t=>{var e;return(null===(e=t.userProperties.intents)||void 0===e?void 0:e.map(e=>({intent:e,app:{name:t.name,title:t.title,tooltip:t.userProperties.tooltip,description:t.userProperties.description,icons:t.userProperties.icons,images:t.userProperties.images}})))||[]}).filter(t=>{var n;return null===(n=t.intent.contexts)||void 0===n?void 0:n.includes(e.type)})})))(e)).map(t=>({intent:t.intent,apps:[t.app]}))}));return{findIntent:(...n)=>t(void 0,void 0,void 0,(function*(){return yield window.gluePromise,e(...n)})),findIntentsByContext:(...e)=>t(void 0,void 0,void 0,(function*(){return yield window.gluePromise,n(...e)})),raiseIntent:(...e)=>t(void 0,void 0,void 0,(function*(){return yield window.gluePromise,((e,n,i)=>t(void 0,void 0,void 0,(function*(){var t,r;let o,s;const a="Tick42.FDC3.Intents."+e;if(i){const t=window.glue.appManager.application(i);if(!t)throw new Error("AppNotFound");o=window.glue.appManager.instances().filter(t=>t.application.name===i).map(t=>t.agm),0===o.length&&(o=[yield d(t,e)])}else if(o=null===(t=window.glue.interop.methods().filter(t=>t.name===a)[0])||void 0===t?void 0:t.getServers(),!o||0===o.length){const t=window.glue.appManager.applications().find(t=>{var n;return null===(n=t.userProperties.intents)||void 0===n?void 0:n.some(t=>t.name===e)});if(!t)throw new Error("AppNotFound");o=[yield d(t,e)]}return s=(yield window.glue.interop.invoke(a,n,o[0]||"best")).all_return_values,s?{source:(null===(r=s[0].executed_by)||void 0===r?void 0:r.applicationName)||"unknown",version:"1.0.0",data:s[0].returned}:{source:"unknown",version:"1.0.0"}})))(...e)})),addIntentListener:(t,e)=>{let n,i;const r="Tick42.FDC3.Intents."+t;return window.gluePromise.then(()=>window.glue.windows.my().getContext()).then(t=>(i=null==t?void 0:t.intentContext,window.glue.interop.register(r,e))).then(()=>{n=()=>window.glue.interop.unregister(r),i&&e(i)}),{unsubscribe:()=>n()}}}},f=()=>({findIntent:(...e)=>t(void 0,void 0,void 0,(function*(){return yield window.gluePromise,((e,n)=>t(void 0,void 0,void 0,(function*(){const t=yield window.glue.intents.find({name:e,contextType:null==n?void 0:n.type});if(!t)throw new Error("NoAppsFound");return u(t)})))(...e)})),findIntentsByContext:(...e)=>t(void 0,void 0,void 0,(function*(){return yield window.gluePromise,(e=>t(void 0,void 0,void 0,(function*(){if(!e.type)throw new Error("Only filtering by context.type is supported.");const t=yield window.glue.intents.findByContext(e.type);if(!t||0===t.length)throw new Error("NoAppsFound");return t.map(t=>u(t))})))(...e)})),raiseIntent:(...e)=>t(void 0,void 0,void 0,(function*(){return yield window.gluePromise,((e,n,i)=>t(void 0,void 0,void 0,(function*(){const t=yield window.glue.intents.raise({intent:e,context:n,target:i});if(!t)throw new Error(`No intent resolution for ${e}, context: ${JSON.stringify(n)}, target: ${i}`);return{source:t.applicationInstance,version:"1.0.0"}})))(...e)})),addIntentListener:(t,e)=>{let n,i;return window.gluePromise.then(()=>window.glue.windows.my().getContext()).then(r=>{i=null==r?void 0:r.intentContext,n=window.glue.intents.addIntentListener(t,e),i&&e(i)}),{unsubscribe:()=>n()}}});
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */
var l=function(t,e){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function v(t,e){function n(){this.constructor=t}l(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var g=function(){return(g=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function y(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){t.done?r(t.value):new n((function(e){e(t.value)})).then(s,a)}c((i=i.apply(t,e||[])).next())}))}function m(t,e){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function w(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var i=Array(t),r=0;for(e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,r++)i[r]=o[s];return i}var b=1,_=2,I=3,S=4;function x(t){return t.type===I?"timestamp":t.type===_?"number":t.type===b?"string":t.type===S?"object":"unknown"}function k(t){return t.constructor===Date?"timestamp":"number"==typeof t?"number":"string"==typeof t?"string":"object"==typeof t?"object":"string"}function C(t){var e={},n=x(t);if("object"===n){var i=Object.keys(t.value).reduce((function(e,n){var i=k(t.value[n]);if("object"===i){var r=function t(e){return Object.keys(e).reduce((function(n,i){var r=k(e[i]);return n[i]="object"===r?{type:"object",description:"",context:{},composite:t(e[i])}:{type:r,description:"",context:{}},n}),{})}(t.value[n]);e[n]={type:"object",description:"",context:{},composite:r}}else e[n]={type:i,description:"",context:{}};return e}),{});e.composite=i}return e.name=A(t.path.join("/")+"/"+t.name),e.type=n,e.description=t.description,e.context={},e}function A(t){return void 0!==t&&t.length>0&&"/"!==t[0]?"/"+t:t}function T(t){return"timestamp"===x(t)?Date.now():function t(e){if("object"!=typeof e)return e;return Object.keys(e).reduce((function(n,i){var r=e[i];return"object"==typeof r&&r.constructor!==Date?n[i]=t(r):r.constructor===Date?n[i]=new Date(r).getTime():r.constructor===Boolean?n[i]=r.toString():n[i]=r,n}),{})}(t.value)}function P(t){var e=function t(e){return e.reduce((function(e,n){return e.concat(Array.isArray(n)?t(n):n)}),[])}(t.root.getAggregateState()),n=e.sort((function(t,e){return t.state?e.state?e.state-t.state:-1:1}))[0];return{description:function(t){var e="";return t.forEach((function(t,n,i){var r=t.path.join(".");n===i.length-1?e+=r+"."+t.name+": "+t.description:e+=r+"."+t.name+": "+t.description+","})),e.length>100?e.slice(0,100)+"...":e}(e),value:n.state}}var M=function(t,e,n){if(null===t||"object"!=typeof t)throw new Error("Missing definition");if(null===e||"object"!=typeof e)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")},j=function(){function t(t,e,n,i,r){this.definition=t,this.system=e,this.transport=n,this.value=i,this.type=r,this.path=[],M(t,e,n),this.path=e.path.slice(0),this.path.push(e.name),this.name=t.name,this.description=t.description,n.createMetric(this)}return Object.defineProperty(t.prototype,"repo",{get:function(){var t;return null===(t=this.system)||void 0===t?void 0:t.repo},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),t.prototype.update=function(t){this.value=t,this.transport.updateMetric(this)},t}(),O=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,_)||this}return v(e,t),e.prototype.incrementBy=function(t){this.update(this.value+t)},e.prototype.increment=function(){this.incrementBy(1)},e.prototype.decrement=function(){this.incrementBy(-1)},e.prototype.decrementBy=function(t){this.incrementBy(-1*t)},e}(j),E=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,S)||this}return v(e,t),e.prototype.update=function(t){this.mergeValues(t),this.transport.updateMetric(this)},e.prototype.mergeValues=function(t){var e=this;return Object.keys(this.value).forEach((function(n){void 0!==t[n]&&(e.value[n]=t[n])}))},e}(j),R=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,b)||this}return v(e,t),e}(j),L=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,I)||this}return v(e,t),e.prototype.now=function(){this.update(new Date)},e}(j);var N=function(){function t(t,e){e.init(this),this.root=function t(e,n,i,r,o){if(!n)throw new Error("Repository is required");if(!i)throw new Error("Transport is required");var s,a,c=i,u=e,d=o||"",p=n,h=r,f=function t(e){if(!e||!e.parent)return[];var n=t(e.parent);return n.push(e.name),n}(r),l={},v=(a="/",((s=f)&&s.length>0?s.join(a):"")+e),g=n.root,y=[],m=[];function w(t,e,n,i){var r={name:""};r="string"==typeof t?{name:t}:t;var o=m.filter((function(t){return t.name===r.name}));if(o.length>0){var s=o[0];if(s.type!==e)throw new Error("A metric named "+r.name+" is already defined with different type.");return void 0!==n&&s.update(n),s}var a=i(r);return m.push(a),a}var x={get name(){return u},get description(){return d},get repo(){return p},get parent(){return h},path:f,id:v,root:g,get subSystems(){return y},get metrics(){return m},subSystem:function(e,n){if(!e||0===e.length)throw new Error("name is required");var i=y.filter((function(t){return t.name===e}));if(i.length>0)return i[0];var r=t(e,p,c,x,n);return y.push(r),r},getState:function(){return l},setState:function(t,e){l={state:t,description:e},c.updateSystem(x,l)},stringMetric:function(t,e){return w(t,b,e,(function(t){return new R(t,x,c,e)}))},timestampMetric:function(t,e){return w(t,I,e,(function(t){return new L(t,x,c,e)}))},objectMetric:function(t,e){return w(t,S,e,(function(t){return new E(t,x,c,e)}))},numberMetric:function(t,e){return w(t,_,e,(function(t){return new O(t,x,c,e)}))},getAggregateState:function(){var t=[];return Object.keys(l).length>0&&t.push({name:u,path:f,state:l.state,description:l.description}),y.forEach((function(e){var n=e.getAggregateState();n.length>0&&t.push.apply(t,n)})),t}};return c.createSystem(x),x}("",this,e),this.addSystemMetrics(this.root,t.clickStream||void 0===t.clickStream)}return t.prototype.addSystemMetrics=function(t,e){if("undefined"!=typeof navigator&&t.stringMetric("UserAgent",navigator.userAgent),e&&"undefined"!=typeof document){var n=t.subSystem("ClickStream"),i=function(t){if(t.target){var e=t.target;n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:t.target?e.className:"",id:e.id,type:"<"+e.tagName.toLowerCase()+">",href:e.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",i):document.attachEvent("onclick",i)}t.stringMetric("StartTime",(new Date).toString());var r=t.stringMetric("StartURL",""),o=t.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;r.update(s)}void 0!==window.glue42gd&&o.update(window.glue42gd.appName)}},t}(),W=function(){function t(){}return t.prototype.init=function(t){},t.prototype.createSystem=function(t){},t.prototype.updateSystem=function(t,e){},t.prototype.createMetric=function(t){},t.prototype.updateMetric=function(t){},t}(),D=function(t){var e;return e=t.connection&&"object"==typeof t.connection?function(t,e){if(!t||"object"!=typeof t)throw new Error("Connection is required parameter");var n,i,r=function(t){o(t.root)},o=function(t){s(t),t.metrics.forEach((function(t){a(t)})),t.subSystems.forEach((function(t){o(t)}))},s=function(t){void 0!==t.parent&&n.then((function(){var e={type:"define",metrics:[{name:A(t.path.join("/")+"/"+t.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};i.send(e)}))},a=function(t){var e=u(t);n.then((function(){var t={type:"define",metrics:[C(e)]};i.send(t),void 0!==e.value&&c(e)}))},c=function(t){if(d()){var e=T(t),n={type:"publish",values:[{name:A(t.path.join("/")+"/"+t.name),value:e,timestamp:Date.now()}]};i.send(n)}},u=function(t){var e=g({},t);return"object"==typeof t.value&&null!==t.value&&(e.value=g({},t.value)),e},d=function(){var t;try{return(null!==(t=e.canUpdateMetric)&&void 0!==t?t:function(){return!0})()}catch(t){return!0}};return{init:function(o){var s;n=new Promise((function(t){s=t})),(i=t.domain("metrics")).onJoined((function(t){!t&&s&&(s(),s=void 0);var e={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};i.send(e),t&&r(o)})),i.join({system:e.system,service:e.service,instance:e.instance})},createSystem:s,updateSystem:function(e,r){n.then((function(){var n={type:"publish",values:[{name:A(e.path.join("/")+"/"+e.name+"/State"),value:{Description:r.description,Value:r.state},timestamp:Date.now()}]};i.send(n);var o=P(e),s={type:"publish",peer_id:t.peerId,values:[{name:"/State",value:{Description:o.description,Value:o.value},timestamp:Date.now()}]};i.send(s)}))},createMetric:a,updateMetric:function(t){var e=u(t);n.then((function(){return c(e)}))}}}(t.connection,t):new W,new N(t,e).root};function F(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function i(n,i){var r=n instanceof Error?n:new Error(n);if(e)e(r);else{var o='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+r.stack;if(t)switch(t.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(t,e){var i=n[t];return i||(i=[],n[t]=i),i.push(e),function(){var i=n[t];i&&(i=i.reduce((function(t,n,i){return n===e&&t.length===i||t.push(n),t}),[]),n[t]=i)}},execute:function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var o=n[t];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var r=n.apply(void 0,e);s.push(r)}catch(e){s.push(void 0),i(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}F.default=F;var B=F,q=function(){function t(t,e){var n=this;this.registry=B(),this.gw=t.facade,this.gw.connect((function(t,e){n.messageHandler(e)})).then((function(t){n.client=t}))}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.client?(this.client.send(t),Promise.resolve(void 0)):Promise.reject("not connected")},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"in-memory"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),G=function(){function t(t,e){var n=this;this.logger=e,this.registry=B(),this.worker=new SharedWorker(t),this.worker.port.onmessage=function(t){n.messageHandler(t.data)}}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.worker.port.postMessage(t),Promise.resolve()},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"shared-worker"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),H=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?void 0:t}},t.isNode=function(){if(void 0!==t._isNode)return t._isNode;if("undefined"!=typeof window)return t._isNode=!1,!1;try{t._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(e){t._isNode=!1}return t._isNode},t}(),U=function(){function t(){var t=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(e,n){t.resolve=function(n){t.resolved=!0,e(n)},t.reject=function(e){t.rejected=!0,n(e)}}))}return t.delay=function(t){return new Promise((function(e){return setTimeout(e,t)}))},Object.defineProperty(t.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),t}(),V=H.isNode()?require("ws"):window.WebSocket,J=function(){function t(t,e){if(this._running=!0,this._registry=B(),this.wsRequests=[],this.settings=t,this.logger=e,!this.settings.ws)throw new Error("ws is missing")}return t.prototype.onMessage=function(t){return this._registry.add("onMessage",t)},t.prototype.send=function(t,e){var n=this;return new Promise((function(e,i){n.waitForSocketConnection((function(){var r;try{null===(r=n.ws)||void 0===r||r.send(t),e()}catch(t){i(t)}}),i)}))},t.prototype.open=function(){var t=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(e,n){t.waitForSocketConnection(e,n)}))},t.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},t.prototype.onConnectedChanged=function(t){return this._registry.add("onConnectedChanged",t)},t.prototype.name=function(){return"ws "+this.settings.ws},t.prototype.reconnect=function(){var t;null===(t=this.ws)||void 0===t||t.close();var e=new U;return this.waitForSocketConnection((function(){e.resolve()})),e.promise},t.prototype.waitForSocketConnection=function(t,e){var n;e=null!=e?e:function(){},this._running?1!==(null===(n=this.ws)||void 0===n?void 0:n.readyState)?(this.wsRequests.push({callback:t,failed:e}),this.wsRequests.length>1||this.openSocket()):t():e("wait for socket on "+this.settings.ws+" failed - socket closed by user")},t.prototype.openSocket=function(t,e){return y(this,void 0,void 0,(function(){var n=this;return m(this,(function(i){switch(i.label){case 0:if(void 0===t&&(t=this.settings.reconnectInterval),void 0!==e){if(0===e)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+e+" more times (every "+t+" ms)")}i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return i.sent(),this.notifyForSocketState(),[3,4];case 3:return i.sent(),setTimeout((function(){var i=void 0===e?void 0:e-1;n.openSocket(t,i)}),t),[3,4];case 4:return[2]}}))}))},t.prototype.initiateSocket=function(){var t=this,e=new U;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new V(this.settings.ws||""),this.ws.onerror=function(n){var i="";try{i=JSON.stringify(n)}catch(t){var r=new WeakSet;i=JSON.stringify(n,(function(t,e){if("object"==typeof e&&null!==e){if(r.has(e))return;r.add(e)}return e}))}e.reject("error"),t.notifyStatusChanged(!1,i)},this.ws.onclose=function(n){t.logger.info("ws closed "+n),e.reject("closed"),t.notifyStatusChanged(!1)},this.ws.onopen=function(){var n;t.logger.info("ws opened "+(null===(n=t.settings.identity)||void 0===n?void 0:n.application)),e.resolve(),t.notifyStatusChanged(!0)},this.ws.onmessage=function(e){t._registry.execute("onMessage",e.data)},e.promise},t.prototype.notifyForSocketState=function(t){this.wsRequests.forEach((function(e){t?e.failed&&e.failed(t):e.callback()})),this.wsRequests=[]},t.prototype.notifyStatusChanged=function(t,e){this._registry.execute("onConnectedChanged",t,e)},t}();var z=1;var K,Y,Z,$={nextValue:function(){return(z=(9301*z+49297)%233280)/233280},seed:function(t){z=t}},X="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function Q(){Z=!1}function tt(t){if(t){if(t!==K){if(t.length!==X.length)throw new Error("Custom alphabet for shortid must be "+X.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+X.length+" unique characters. These characters were not unique: "+e.join(", "));K=t,Q()}}else K!==X&&(K=X,Q())}function et(){return Z||(Z=function(){K||tt(X);for(var t,e=K.split(""),n=[],i=$.nextValue();e.length>0;)i=$.nextValue(),t=Math.floor(i*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var nt={characters:function(t){return tt(t),K},seed:function(t){$.seed(t),Y!==t&&(Q(),Y=t)},lookup:function(t){return et()[t]},shuffled:et},it="object"==typeof window&&(window.crypto||window.msCrypto);var rt=function(){if(!it||!it.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return it.getRandomValues(t),48&t[0]};var ot=function(t,e){for(var n,i=0,r="";!n;)r+=t(e>>4*i&15|rt()),n=e<Math.pow(16,i+1),i++;return r};var st=function(t){var e=nt.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var at=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=nt.characters(),n=t.length,i=0;i<n;i++)if(-1===e.indexOf(t[i]))return!1;return!0},ct=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e,n,i=0;function r(){var t="",r=Math.floor(.001*(Date.now()-1459707606518));return r===n?e++:(e=0,n=r),t+=ot(nt.lookup,6),t+=ot(nt.lookup,i),e>0&&(t+=ot(nt.lookup,e)),t+=ot(nt.lookup,r)}t.exports=r,t.exports.generate=r,t.exports.seed=function(e){return nt.seed(e),t.exports},t.exports.worker=function(e){return i=e,t.exports},t.exports.characters=function(t){return void 0!==t&&nt.characters(t),nt.shuffled()},t.exports.decode=st,t.exports.isValid=at})),ut=(ct.generate,ct.seed,ct.worker,ct.characters,ct.decode,ct.isValid,ct);function dt(t,e,n,i,r){null==t&&(t="global"),i=i||["success"],r=r||["error"];var o,s=!1,a=!1,c=!1,u=B();e.disconnected((function(){c=!1,n.debug("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),e.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),p(o))})),e.on("success",(function(t){return f(t)})),e.on("error",(function(t){return h(t)})),e.on("result",(function(t){return f(t)})),i&&i.forEach((function(t){e.on(t,(function(t){return f(t)}))})),r&&r.forEach((function(t){e.on(t,(function(t){return h(t)}))}));var d={};function p(e){return o=e,new Promise((function(i,r){if(s)i();else{var o;if("global"===t)o=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining domain "+t),o=v({type:"join",destination:t,domain:"global",options:e});o.then((function(){!function(){n.debug("did join "+t),s=!0;var e=a;a=!1,u.execute("onJoined",e)}(),i()})).catch((function(e){n.debug("error joining "+t+" domain: "+JSON.stringify(e)),r(e)}))}}))}function h(e){if(t===e.domain){var n=e.request_id;if(n){var i=d[n];i&&i.error(e)}}}function f(e){if(e.domain===t){var n=e.request_id;if(n){var i=d[n];i&&i.success(e)}}}function l(){return ut()}function v(i,r,o){o=o||{},i.request_id=i.request_id||l(),i.domain=i.domain||t,o.skipPeerId||(i.peer_id=e.peerId);var s=i.request_id;return new Promise((function(t,a){d[s]={success:function(e){delete d[s],e._tag=r,t(e)},error:function(t){n.warn("GW error - "+JSON.stringify(t)+" for request "+JSON.stringify(i)),delete d[s],t._tag=r,a(t)}},e.send(i,o).catch((function(t){d[s].error({err:t})}))}))}return{join:p,leave:function(){return"global"===t?Promise.resolve():(n.debug("stopping session "+t+"..."),a=!1,v({type:"leave",destination:t,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})))},onJoined:function(t){return s&&t(!1),u.add("onJoined",t)},onLeft:function(t){return s||t(),u.add("onLeft",t)},send:v,sendFireAndForget:function(n){n.request_id=n.request_id?n.request_id:l(),n.domain=n.domain||t,n.peer_id=e.peerId,e.send(n)},on:function(i,r){e.on(i,(function(e){if(e.domain===t)try{r(e)}catch(t){n.error("Callback  failed: "+t+" \n "+t.stack+" \n msg was: "+JSON.stringify(e),t)}}))},loggedIn:function(t){return e.loggedIn(t)},connected:function(t){return e.connected(t)},disconnected:function(t){return e.disconnected(t)},get peerId(){return e.peerId},get domain(){return t}}}var pt=function(){function t(t,e,n){var i=this;this.connection=t,this.settings=e,this.logger=n,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=B(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],t.disconnected((function(){i.handleDisconnected()})),this.ping()}return Object.defineProperty(t.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.processStringMessage=function(t){var e=this,n=JSON.parse(t,(function(t,n){if("string"!=typeof n)return n;if(n.length<e.dateMinLen)return n;if(n[0]!==e.datePrefixFirstChar)return n;if(n.substring(0,e.datePrefixLen)!==e.datePrefix)return n;try{var i=parseInt(n.substring(e.datePrefixLen,n.length),10);return isNaN(i)?n:new Date(i)}catch(t){return n}}));return{msg:n,msgType:n.type}},t.prototype.createStringMessage=function(t){var e=Date.prototype.toJSON;try{var n=this.datePrefix;return Date.prototype.toJSON=function(){return n+this.getTime()},JSON.stringify(t)}finally{Date.prototype.toJSON=e}},t.prototype.processObjectMessage=function(t){if(!t.type)throw new Error("Object should have type property");return{msg:t,msgType:t.type}},t.prototype.createObjectMessage=function(t){return t},t.prototype.login=function(t,e){return y(this,void 0,void 0,(function(){var n,i,r,o,s,a,c,u,d,p;return m(this,(function(h){switch(h.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=t,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,n={},this.connection.gatewayToken=t.gatewayToken,!t.gatewayToken)return[3,5];if(!e)return[3,4];h.label=1;case 1:return h.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return u=h.sent(),t.gatewayToken=u,[3,4];case 3:return i=h.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==i?void 0:i.message)||i)),[3,4];case 4:return n.method="gateway-token",n.token=t.gatewayToken,this.connection.gatewayToken=t.gatewayToken,[3,10];case 5:return"sspi"!==t.flowName?[3,9]:(n.provider="win",n.method="access-token",t.flowCallback&&t.sessionId?(r=n,[4,t.flowCallback(t.sessionId,null)]):[3,7]);case 6:return r.token=h.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(t.token)n.method="access-token",n.token=t.token;else{if(!t.username)throw new Error("invalid auth message"+JSON.stringify(t));n.method="secret",n.login=t.username,n.secret=t.password}h.label=10;case 10:o={type:"hello",identity:this.settings.identity,authentication:n},t.sessionId&&(o.request_id=t.sessionId),this.globalDomain=dt("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),s={skipPeerId:!0},this.initialLogin&&(s.retryInterval=this.settings.reconnectInterval,s.maxRetries=this.settings.reconnectAttempts),h.label=11;case 11:h.trys.push([11,19,20,21]),a=void 0,h.label=12;case 12:return[4,this.globalDomain.send(o,void 0,s)];case 13:return"authentication-request"!==(c=h.sent()).type?[3,16]:(u=Buffer.from(c.authentication.token,"base64"),t.flowCallback&&t.sessionId?(d=o.authentication,[4,t.flowCallback(t.sessionId,u)]):[3,15]);case 14:d.token=h.sent().data.toString("base64"),h.label=15;case 15:return o.request_id=t.sessionId,[3,12];case 16:if("welcome"===c.type)return a=c,[3,18];throw"error"===c.type?new Error("Authentication failed: "+c.reason):new Error("Unexpected message type during authentication: "+c.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.info("login successful with peerId "+a.peer_id),this.connection.peerId=a.peer_id,this.connection.resolvedIdentity=a.resolved_identity,this.connection.availableDomains=a.available_domains,a.options&&(this.connection.token=a.options.access_token,this.connection.info=a.options.info),this.setLoggedIn(!0),[2,a.resolved_identity];case 19:throw p=h.sent(),this.logger.error("error sending hello message - "+(p.message||p.msg||p.reason||p),p),p;case 20:return t&&t.flowCallback&&t.sessionId&&t.flowCallback(t.sessionId,null),[7];case 21:return[2]}}))}))},t.prototype.logout=function(){return y(this,void 0,void 0,(function(){var t;return m(this,(function(e){switch(e.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),t=this.sessions.map((function(t){t.leave()})),[4,Promise.all(t)];case 1:return e.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this._isLoggedIn&&t(),this.registry.add("onLoggedIn",t)},t.prototype.domain=function(t,e,n,i){var r=this.sessions.filter((function(e){return e.domain===t}))[0];return r||(r=dt(t,this.connection,e,n,i),this.sessions.push(r)),r},t.prototype.handleDisconnected=function(){var t=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(t.handleDisconnected,1e3)}))}},t.prototype.setLoggedIn=function(t){this._isLoggedIn=t,this._isLoggedIn&&this.registry.execute("onLoggedIn")},t.prototype.ping=function(){var t=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){t.ping()}),3e4))},t.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(t){return t.token})):Promise.reject(new Error("no global domain session"))},t.prototype.getNewGWToken=function(){if(void 0!==typeof window){var t=window.glue42gd;if(t)return t.getGWToken()}return Promise.reject(new Error("not running in GD"))},t}(),ht=function(){function t(t){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var e=0,n=t;e<n.length;e++){var i=n[e];this.specs[i.name]=i,this.specsNames.push(i.name)}}return t.prototype.init=function(t){var e=this;this.connection=t;for(var n=0,i=this.specsNames;n<i.length;n++)for(var r=i[n],o=function(n){var i=s.subsRefCount[n];if(i||(i=0),i+=1,s.subsRefCount[n]=i,i>1)return"continue";var r=t.on(n,(function(t){return e.processMessage(n,t)}));s.subs[n]=r},s=this,a=0,c=this.specs[r].types;a<c.length;a++){o(c[a])}},t.prototype.processMessage=function(t,e){if(!this.isDone&&e)for(var n=0,i=this.specsNames;n<i.length;n++){var r=i[n];if(-1!==this.specs[r].types.indexOf(t)){var o=this.messages[r]||[];this.messages[r]=o,o.push(e)}}},t.prototype.drain=function(t,e){var n;e&&(this.messages[t]||[]).forEach(e),delete this.messages[t];for(var i=0,r=this.specs[t].types;i<r.length;i++){var o=r[i];this.subsRefCount[o]-=1,this.subsRefCount[o]<=0&&(null===(n=this.connection)||void 0===n||n.off(this.subs[o]),delete this.subs[o],delete this.subsRefCount[o])}delete this.specs[t],this.specs.length||(this.isDone=!0)},t}(),ft=function(){function t(t,e){if(this.settings=t,this.logger=e,this.messageHandlers={},this.ids=1,this.registry=B(),this._connected=!1,this.isTrace=!1,(t=t||{}).reconnectAttempts=t.reconnectAttempts||10,t.reconnectInterval=t.reconnectInterval||1e3,t.inproc)this.transport=new q(t.inproc,e.subLogger("inMemory"));else if(t.sharedWorker)this.transport=new G(t.sharedWorker,e.subLogger("shared-worker"));else{if(void 0===t.ws)throw new Error("No connection information specified");this.transport=new J(t,e.subLogger("ws"))}this.isTrace=e.canPublish("trace"),e.info("starting with "+this.transport.name()+" transport"),this.protocol=new pt(this,t,e.subLogger("protocol")),this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this.transport.onMessage(this.handleTransportMessage.bind(this)),t.replaySpecs&&t.replaySpecs.length&&(this.replayer=new ht(t.replaySpecs),this.replayer.init(this))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;return null===(t=this.protocol)||void 0===t?void 0:t.protocolVersion},enumerable:!0,configurable:!0}),t.prototype.send=function(t,e){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var n=this.protocol.createObjectMessage(t);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(n)),this.transport.sendObject(n,e)}var i=this.protocol.createStringMessage(t);return this.isTrace&&this.logger.trace(">> "+i),this.transport.send(i,e)},t.prototype.on=function(t,e){t=t.toLowerCase(),void 0===this.messageHandlers[t]&&(this.messageHandlers[t]={});var n=this.ids++;return this.messageHandlers[t][n]=e,{type:t,id:n}},t.prototype.off=function(t){delete this.messageHandlers[t.type.toLowerCase()][t.id]},Object.defineProperty(t.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.connected=function(t){var e=this;return this.protocol.loggedIn((function(){t(e.settings.ws||e.settings.sharedWorker||"")}))},t.prototype.disconnected=function(t){return this.registry.add("disconnected",t)},t.prototype.login=function(t,e){return y(this,void 0,void 0,(function(){return m(this,(function(n){switch(n.label){case 0:return[4,this.transport.open()];case 1:return n.sent(),[2,this.protocol.login(t,e)]}}))}))},t.prototype.logout=function(){return y(this,void 0,void 0,(function(){return m(this,(function(t){switch(t.label){case 0:return[4,this.protocol.logout()];case 1:return t.sent(),[4,this.transport.close()];case 2:return t.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this.protocol.loggedIn(t)},t.prototype.domain=function(t,e,n){return this.protocol.domain(t,this.logger.subLogger("domain="+t),e,n)},t.prototype.authToken=function(){return this.protocol.authToken()},t.prototype.reconnect=function(){return this.transport.reconnect()},t.prototype.distributeMessage=function(t,e){var n=this,i=this.messageHandlers[e.toLowerCase()];void 0!==i&&Object.keys(i).forEach((function(e){var r=i[e];if(void 0!==r)try{r(t)}catch(t){n.logger.error("Message handler failed with "+t.stack,t)}}))},t.prototype.handleConnectionChanged=function(t){this._connected!==t&&(this._connected=t,t?this.registry.execute("connected"):this.registry.execute("disconnected"))},t.prototype.handleTransportMessage=function(t){var e;e="string"==typeof t?this.protocol.processStringMessage(t):this.protocol.processObjectMessage(t),this.isTrace&&this.logger.trace("<< "+JSON.stringify(e)),this.distributeMessage(e.msg,e.msgType)},t}(),lt=["trace","debug","info","warn","error","off"],vt=function(){function t(t,e,n){this.name=t,this.parent=e,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=t,this.path=e?e.path+"."+t:t,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}return t.prototype.subLogger=function(e){var n=this.subLoggers.filter((function(t){return t.name===e}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(t){if(t===e)throw new Error("This sub logger name is not allowed.")}));var i=new t(e,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(i),i},t.prototype.publishLevel=function(t){var e;return t&&(this._publishLevel=t),this._publishLevel||(null===(e=this.parent)||void 0===e?void 0:e.publishLevel())},t.prototype.consoleLevel=function(t){var e;return t&&(this._consoleLevel=t),this._consoleLevel||(null===(e=this.parent)||void 0===e?void 0:e.consoleLevel())},t.prototype.log=function(t,e,n){this.publishMessage(e||"info",t,n)},t.prototype.trace=function(t){this.log(t,"trace")},t.prototype.debug=function(t){this.log(t,"debug")},t.prototype.info=function(t){this.log(t,"info")},t.prototype.warn=function(t){this.log(t,"warn")},t.prototype.error=function(t,e){this.log(t,"error")},t.prototype.canPublish=function(t,e){return lt.indexOf(t)>=lt.indexOf(e||this.consoleLevel()||"trace")},t.prototype.publishMessage=function(e,n,i){var r,o,s=this.loggerFullName;if("error"===e&&!i){var a=new Error;a.stack&&(n=n+"\n"+a.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(e,this.publishLevel())&&(null===(r=t.Interop)||void 0===r?void 0:r.methods({name:t.InteropMethodName}).length)>0&&(null===(o=t.Interop)||void 0===o||o.invoke(t.InteropMethodName,{msg:""+n,logger:s,level:e})),this.canPublish(e)){var c="";if(this.includeTimeAndLevel){var u=new Date;c="["+(u.getHours()+":"+u.getMinutes()+":"+u.getSeconds()+":"+u.getMilliseconds())+"] ["+e+"] "}var d=""+c+s+": "+n;switch(e){case"trace":this.logFn.debug(d);break;case"debug":this.logFn.debug?this.logFn.debug(d):this.logFn.log(d);break;case"info":this.logFn.info(d);break;case"warn":this.logFn.warn(d);break;case"error":this.logFn.error(d,i)}}},t.InteropMethodName="T42.AppLogger.Log",t}(),gt="create-context",yt="created",mt="destroyed",wt="context-created",bt="context-added",_t="subscribe-context",It="subscribed-context",St="unsubscribe-context",xt="context-destroyed",kt="update-context",Ct="context-updated",At="joined",Tt={get name(){return"context"},get types(){return[gt,yt,mt,wt,bt,_t,It,St,"destroy-context",xt,kt,Ct,At]}},Pt="5.0.7";function Mt(t,e,n){var i,r,o,s,a;if(H.isNode()){var c=process.env._GD_STARTING_CONTEXT_;if(c)try{a=JSON.parse(c)}catch(t){}}var u=function(){var i,r,o,s,c,u,d,p,h,f=t.gateway,l=null!==(i=null==f?void 0:f.protocolVersion)&&void 0!==i?i:3,v=null==f?void 0:f.reconnectInterval,g=null==f?void 0:f.reconnectAttempts,y=null==f?void 0:f.ws,m=null==f?void 0:f.sharedWorker,w=null==f?void 0:f.inproc;n&&(y=n.gwURL),H.isNode()&&a&&a.gwURL&&(y=a.gwURL),y||m||w||(y="ws://localhost:8385");var b=function(){if(t.application)return t.application;if(n)return n.applicationName;var e=ut();if(H.isNode())return a?a.applicationConfig.name:"NodeJS"+e;if("undefined"!=typeof window&&"undefined"!=typeof document)return document.title+" ("+e+")";return e}(),_=b;void 0!==n?(u=n.windowId,d=n.pid,n.env&&(p=n.env.env,h=n.env.region),_=null!==(r=n.application)&&void 0!==r?r:"glue-app",c=n.appInstanceId):H.isNode()?(d=process.pid,a&&(p=a.env,h=a.region,c=a.instanceId)):u=window.name||ut();var I=null!==(s=null===(o=t.gateway)||void 0===o?void 0:o.replaySpecs)&&void 0!==s?s:[];return I.push(Tt),{identity:{application:_,applicationName:b,windowId:u,instance:c,process:d,region:h,environment:p,api:e.version||Pt},reconnectInterval:v,ws:y,sharedWorker:m,inproc:w,protocolVersion:l,reconnectAttempts:g,replaySpecs:I}}();return{bus:null!==(i=t.bus)&&void 0!==i&&i,auth:function(){var e,n;return"string"==typeof t.auth?{token:t.auth}:t.auth?t.auth:H.isNode()&&a&&a.gwToken?{gatewayToken:a.gwToken}:(null===(e=t.gateway)||void 0===e?void 0:e.inproc)||(null===(n=t.gateway)||void 0===n?void 0:n.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var e,n,i=t.logger,r="error";return i||(i=r),"string"==typeof i?{console:i,publish:r}:{console:null!==(e=i.console)&&void 0!==e?e:r,publish:null!==(n=i.publish)&&void 0!==n?n:r}}(),connection:u,metrics:null===(r=t.metrics)||void 0===r||r,contexts:null===(o=t.contexts)||void 0===o||o,version:e.version||Pt,libs:null!==(s=e.libs)&&void 0!==s?s:[],customLogger:t.customLogger}}function jt(){function t(){return(new Date).getTime()}var e,n,i=t();return{get startTime(){return i},get endTime(){return e},get period(){return n},stop:function(){return e=t(),n=t()-i}}}var Ot=function(){function t(t,e,n,i){this.updateCallbacks={},this.contextId=t,this.name=e,this.isAnnounced=n,this.activityId=i,this.context={}}return t.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},t.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},t}();function Et(t,e){if(e){if(e.reset)return t=g({},e.reset);t=Rt(t,void 0);var n=e.added,i=e.updated,r=e.removed;n&&Object.keys(n).forEach((function(e){t[e]=n[e]})),i&&Object.keys(i).forEach((function(e){Lt(e,t,i)})),r&&r.forEach((function(e){delete t[e]}))}return t}function Rt(t,e){if(e=e||new WeakMap,Object(t)!==t)return t;if(t instanceof Set)return new Set(t);if(e.has(t))return e.get(t);var n=t instanceof Date?new Date(t):t instanceof RegExp?new RegExp(t.source,t.flags):t.constructor?new t.constructor:Object.create(null);return e.set(t,n),Object.assign.apply(Object,w([n],Object.keys(t).map((function(n){var i;return(i={})[n]=Rt(t[n],e),i}))))}var Lt=function(t,e,n){var i=n[t];if(void 0===i)return e;var r=e[t];return r&&i?"string"==typeof r||"number"==typeof r||"boolean"==typeof r||"string"==typeof i||"number"==typeof i||"boolean"==typeof i||Array.isArray(r)||Array.isArray(i)?(e[t]=i,e):(e[t]=Object.assign({},r,i),e):(e[t]=i,e)};function Nt(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;for(var n in t)if(t.hasOwnProperty(n)){if(!e.hasOwnProperty(n))return!1;if(t[n]!==e[n]){if("object"!=typeof t[n])return!1;if(!Nt(t[n],e[n]))return!1}}for(var n in e)if(e.hasOwnProperty(n)&&!t.hasOwnProperty(n))return!1;return!0}var Wt,Dt=function(){function t(t){var e,n=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._connection=t.connection,this._logger=t.logger,this._gw3Session=this._connection.domain("global",[wt,It,xt,Ct]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(e=this._connection.replayer)||void 0===e||e.drain(Tt.name,(function(t){var e=t.type;e&&(e===wt||e===bt||e===yt?n.handleContextCreatedMessage(t):e===It||e===Ct||e===At?n.handleContextUpdatedMessage(t):e!==xt&&e!==mt||n.handleContextDestroyedMessage(t))}))}return t.prototype.dispose=function(){for(var t=0,e=this._gw3Subscriptions;t<e.length;t++){var n=e[t];this._connection.off(n)}for(var i in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(i)&&delete this._contextNameToData[i]},t.prototype.createContext=function(t,e){var n=this;return this._gw3Session.send({type:gt,domain:"global",name:t,data:e,lifetime:"retained"}).then((function(i){if(n._contextNameToId[t]=i.context_id,!n._contextIdToName[i.context_id]){n._contextIdToName[i.context_id]=t;var r=n._contextNameToData[t]||new Ot(i.context_id,t,!0,void 0);return r.isAnnounced=!0,r.name=t,r.contextId=i.context_id,n._contextNameToData[t]=r,r.context=i.data,r.sentExplicitSubscription=!0,r.context&&n.invokeUpdateCallbacks(r,r.context,void 0),n.update(t,e).then((function(){return i.context_id}))}return i.context_id}))},t.prototype.all=function(){var t=this;return Object.keys(this._contextNameToData).filter((function(e){return t._contextNameToData[e].isAnnounced}))},t.prototype.update=function(t,e){return y(this,void 0,void 0,(function(){var n,i,r,o=this;return m(this,(function(s){switch(s.label){case 0:return(n=this._contextNameToData[t])&&n.isAnnounced?(i=n.context,n.hasCallbacks()?[3,2]:[4,this.get(n.name,!1)]):[2,this.createContext(t,e)];case 1:i=s.sent(),s.label=2;case 2:return r=this.calculateContextDelta(i,e),Object.keys(r.added).length||Object.keys(r.updated).length||r.removed.length?[2,this._gw3Session.send({type:kt,domain:"global",context_id:n.contextId,delta:r},{},{skipPeerId:!1}).then((function(t){o.handleUpdated(n,r,{updaterId:t.peer_id})}))]:[2,Promise.resolve()]}}))}))},t.prototype.set=function(t,e){var n=this,i=this._contextNameToData[t];return i&&i.isAnnounced?this._gw3Session.send({type:kt,domain:"global",context_id:i.contextId,delta:{reset:e}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(i,{reset:e,added:{},removed:[],updated:{}},{updaterId:t.peer_id})})):this.createContext(t,e)},t.prototype.get=function(t,e){var n=this;void 0===e&&(e=!0);var i=this._contextNameToData[t];return i&&i.isAnnounced&&i.hasCallbacks()||e?Promise.resolve(i&&i.context):new Promise((function(e,i){return y(n,void 0,void 0,(function(){var n=this;return m(this,(function(i){return this.subscribe(t,(function(t,i,r,o){n.unsubscribe(o),e(t)})),[2]}))}))}))},t.prototype.subscribe=function(t,e){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var i=this._contextNameToData[t];if(!i||!i.isAnnounced)return i=i||new Ot(void 0,t,!1,void 0),this._contextNameToData[t]=i,i.updateCallbacks[n]=e,Promise.resolve(n);var r=i.hasCallbacks();return i.updateCallbacks[n]=e,r||i.joinedActivity||i.context&&i.sentExplicitSubscription?(e(i.context,i.context,[],n),Promise.resolve(n)):this.sendSubscribe(i).then((function(){return n}))},t.prototype.unsubscribe=function(t){for(var e=0,n=Object.keys(this._contextNameToData);e<n.length;e++){var i=n[e],r=(this._contextNameToId[i],this._contextNameToData[i]);if(!r)return;var o=r.hasCallbacks();delete r.updateCallbacks[t],r.isAnnounced&&o&&!r.hasCallbacks()&&r.sentExplicitSubscription&&this.sendUnsubscribe(r),r.isAnnounced||r.hasCallbacks()||delete this._contextNameToData[i]}},t.prototype.handleUpdated=function(t,e,n){var i=t.context;t.context=Et(t.context,e),this._contextNameToData[t.name]!==t||Nt(i,t.context)||this.invokeUpdateCallbacks(t,t.context,e,n)},t.prototype.subscribeToContextCreatedMessages=function(){for(var t=0,e=[bt,wt,yt];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextCreatedMessage=function(t){var e=t.type;e===yt?(this._contextNameToId[t.activity_id]=t.context_id,this._contextIdToName[t.context_id]=t.activity_id):e===bt&&(this._contextNameToId[t.name]=t.context_id,this._contextIdToName[t.context_id]=t.name);var n=this._contextIdToName[t.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+t.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+t.context_id);var i=this._contextNameToData[n];if(i){if(i.isAnnounced)return;if(!i.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");i.isAnnounced=!0,i.contextId=t.context_id,i.activityId=t.activity_id,i.sentExplicitSubscription||this.sendSubscribe(i)}else this._contextNameToData[n]=i=new Ot(t.context_id,n,!0,t.activity_id)},t.prototype.subscribeToContextUpdatedMessages=function(){for(var t=0,e=[Ct,It,At];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextUpdatedMessage=function(t){var e=t.type,n=t.context_id,i=this._contextNameToData[this._contextIdToName[n]],r=!i||!i.isAnnounced;if(e===At)i?(i.contextId=n,i.isAnnounced=!0,i.activityId=t.activity_id):(i=new Ot(n,t.activity_id,!0,t.activity_id),this._contextNameToData[t.activity_id]=i,this._contextIdToName[n]=t.activity_id,this._contextNameToId[t.activity_id]=n),i.joinedActivity=!0;else if(!i||!i.isAnnounced)return void(e===It?((i=i||new Ot(n,t.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[t.name]=i,this._contextIdToName[n]=t.name,this._contextNameToId[t.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var o=i.context;if(e===It)i.context=t.data||{};else if(e===At)i.context=t.context_snapshot||{};else{if(e!==Ct)throw new Error("Unrecognized context update message "+e);i.context=Et(i.context,t.delta)}!r&&Nt(i.context,o)&&e!==It||this.invokeUpdateCallbacks(i,i.context,t.delta,{updaterId:t.updater_id})},t.prototype.invokeUpdateCallbacks=function(t,e,n,i){for(var r in n=n||{added:{},updated:{},reset:{},removed:[]},t.updateCallbacks)if(t.updateCallbacks.hasOwnProperty(r))try{(0,t.updateCallbacks[r])(Rt(e),Object.assign({},n.added||{},n.updated||{},n.reset||{}),n.removed,parseInt(r,10),i)}catch(t){this._logger.debug("callback error: "+JSON.stringify(t))}},t.prototype.subscribeToContextDestroyedMessages=function(){for(var t=0,e=[xt,mt];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextDestroyedMessage=function(t){var e,n;if(t.type===mt){if(n=t.activity_id,!(e=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+t.activity_id)}else if(e=t.context_id,!(n=this._contextIdToName[e]))return void this._logger.error("Received 'destroyed' for unknown context: "+t.context_id);delete this._contextIdToName[e],delete this._contextNameToId[n];var i=this._contextNameToData[n];delete this._contextNameToData[n],i&&i.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+e)},t.prototype.sendSubscribe=function(t){return t.sentExplicitSubscription=!0,this._gw3Session.send({type:_t,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.sendUnsubscribe=function(t){return t.sentExplicitSubscription=!1,this._gw3Session.send({type:St,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.calculateContextDelta=function(t,e){var n={added:{},updated:{},removed:[],reset:void 0};if(t)for(var i=0,r=Object.keys(t);i<r.length;i++){var o=r[i];-1===Object.keys(e).indexOf(o)||null===e[o]||Nt(t[o],e[o])||(n.updated[o]=e[o])}for(var s=0,a=Object.keys(e);s<a.length;s++){o=a[s];t&&-1!==Object.keys(t).indexOf(o)?null===e[o]&&n.removed.push(o):null!==e[o]&&(n.added[o]=e[o])}return n},t}(),Ft=function(){function t(t){this._bridge=new Dt(t)}return t.prototype.all=function(){return this._bridge.all()},t.prototype.update=function(t,e){return this.checkName(t),this._bridge.update(t,e)},t.prototype.set=function(t,e){return this.checkName(t),this._bridge.set(t,e)},t.prototype.subscribe=function(t,e){var n=this;return this.checkName(t),this._bridge.subscribe(t,(function(t,i,r,o,s){return e(t,i,r,(function(){return n._bridge.unsubscribe(o)}),s)})).then((function(t){return function(){n._bridge.unsubscribe(t)}}))},t.prototype.get=function(t,e){return void 0===e&&(e=!0),this._bridge.get(t,e)},t.prototype.ready=function(){return Promise.resolve(this)},t.prototype.checkName=function(t){if("string"!=typeof t||""===t)throw new Error("'name' must be non-empty string, got '"+t+"'")},t}();function Bt(t,e,n){return"function"!=typeof e&&"function"!=typeof n?t:("function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n))}function qt(t,e){return void 0===t&&(t=0),new Promise((function(n,i){return setTimeout((function(){return i(e)}),t)}))}!function(t){t[t.Success=0]="Success",t[t.Error=1]="Error"}(Wt||(Wt={}));var Gt=function(){function t(t,e,n,i){this.protocol=t,this.repo=e,this.instance=n,this.configuration=i}return t.prototype.subscribe=function(t,e,n,i,r){var o=this,s=function(t,n,i,s){var a;e.methodResponseTimeout=null!==(a=e.methodResponseTimeout)&&void 0!==a?a:e.waitTimeoutMs,o.protocol.client.subscribe(n,e,t,i,s,r)};return Bt(new Promise((function(n,i){var r,a=function(t){n(t)},c=function(t){i(t)};if(t)if((r="string"==typeof t?{name:t}:t).name){void 0===e&&(e={});var u=e.target;if(void 0===u&&(u="best"),"string"!=typeof u||"all"===u||"best"===u){void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=e.method_response_timeout,void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=o.configuration.methodResponseTimeout)),void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=e.wait_for_method_timeout,void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=o.configuration.waitTimeoutMs));var d=0,p=o.getServerMethodsByFilterAndTarget(r,u);if(p.length>0)s(p,p[0].methods[0],a,c);else{var h=function(){if(u&&e.waitTimeoutMs)if(d+=500,(p=o.getServerMethodsByFilterAndTarget(r,u)).length>0){var n=p[0].methods[0];s(p,n,a,c)}else if(d>=e.waitTimeoutMs){s(p,"string"==typeof t?{name:t}:t,a,c)}else setTimeout(h,500)};setTimeout(h,500)}}else i(new Error('"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else i("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");else i("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.")})),n,i)},t.prototype.servers=function(t){var e=void 0===t?void 0:g({},t);return this.getServers(e).map((function(t){return t.server.instance}))},t.prototype.methods=function(t){return t="string"==typeof t?{name:t}:g({},t),this.getMethods(t)},t.prototype.methodsForInstance=function(t){return this.getMethodsForInstance(t)},t.prototype.methodAdded=function(t){return this.repo.onMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.repo.onMethodRemoved(t)},t.prototype.serverAdded=function(t){return this.repo.onServerAdded(t)},t.prototype.serverRemoved=function(t){return this.repo.onServerRemoved((function(e,n){t(e,n)}))},t.prototype.serverMethodAdded=function(t){return this.repo.onServerMethodAdded((function(e,n){t({server:e,method:n})}))},t.prototype.serverMethodRemoved=function(t){return this.repo.onServerMethodRemoved((function(e,n){t({server:e,method:n})}))},t.prototype.invoke=function(t,e,n,i,r,o){return y(this,void 0,void 0,(function(){var s=this;return m(this,(function(a){return[2,Bt(function(){return y(s,void 0,void 0,(function(){var r,o,s,a,c,u,d,p,h,f,l=this;return m(this,(function(v){switch(v.label){case 0:if(!(r="string"==typeof t?{name:t}:g({},t)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.")];if(e||(e={}),n||(n="best"),"string"==typeof n&&"all"!==n&&"best"!==n&&"skipMine"!==n)return[2,Promise.reject(new Error('"'+n+'" is not a valid target. Valid targets are "all" and "best".'))];if(i||(i={}),void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=i.method_response_timeout,void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=i.wait_for_method_timeout,void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==i.waitTimeoutMs&&"number"!=typeof i.waitTimeoutMs)return[2,Promise.reject(new Error('"'+i.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof e)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+r.name))];if(0!==(o=this.getServerMethodsByFilterAndTarget(r,n)).length)return[3,4];v.label=1;case 1:return v.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(r,n,i)];case 2:return o=v.sent(),[3,4];case 3:return v.sent(),s=g(g({},r),{getServers:function(){return[]},supportsStreaming:!1,objectTypes:null!==(f=r.objectTypes)&&void 0!==f?f:[]}),a={method:s,called_with:e,message:"Can not find a method matching "+JSON.stringify(t)+" with server filter "+JSON.stringify(n),executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(a)];case 4:return c=i.methodResponseTimeoutMs,u=i,d=o.map((function(t){var n=ut(),i=l.protocol.client.invoke(n,t.methods[0],e,t.server,u);return Promise.race([i,qt(c,{invocationId:n,message:"Invocation timeout ("+c+" ms) reached",status:Wt.Error})])})),[4,Promise.all(d)];case 5:return p=v.sent(),h=this.getInvocationResultObj(p,r,e),p.every((function(t){return t.status===Wt.Error}))?[2,Promise.reject(h)]:[2,h]}}))}))}(),r,o)]}))}))},t.prototype.getInvocationResultObj=function(t,e,n){var i=t.filter((function(t){return t.status===Wt.Success})).reduce((function(t,i){return t=w(t,[{executed_by:i.instance,returned:i.result,called_with:n,method:e,message:i.message,status:i.status}])}),[]),r=t.filter((function(t){return t.status===Wt.Error})).reduce((function(t,i){return t=w(t,[{executed_by:i.instance,called_with:n,name:e.name,message:i.message}])}),[]),o=t[0];return{method:e,called_with:n,returned:o.result,executed_by:o.instance,all_return_values:i,all_errors:r,message:o.message,status:o.status}},t.prototype.tryToAwaitForMethods=function(t,e,n){var i=this;return new Promise((function(r,o){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=i.getServerMethodsByFilterAndTarget(t,e);if(c.length>0)clearInterval(a),r(c);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(a),void o()}),500);else o()}))},t.prototype.filterByTarget=function(t,e){var n=this;if("string"!=typeof t){return(Array.isArray(t)?t:[t]).reduce((function(t,i){var r=e.filter((function(t){return n.instanceMatch(i,t.server.instance)}));return t.concat(r)}),[])}if("all"===t)return w(e);if("best"===t){var i=e.find((function(t){return t.server.instance.isLocal}));if(i)return[i];if(void 0!==e[0])return[e[0]]}else if("skipMine"===t)return e.filter((function(t){return t.server.instance.peerId!==n.instance.peerId}));return[]},t.prototype.instanceMatch=function(t,e){return this.containsProps(t,e)},t.prototype.methodMatch=function(t,e){return this.containsProps(t,e)},t.prototype.containsProps=function(t,e){return Object.keys(t).filter((function(e){return void 0!==t[e]&&"function"!=typeof t[e]&&"object_types"!==e&&"display_name"!==e&&"id"!==e&&"gatewayId"!==e&&"identifier"!==e&&"_"!==e[0]})).reduce((function(n,i){var r=t[i],o=e[i];if("objectTypes"===i){(r.length>o.length||!1===function(t,e){var n=t.reduce((function(t,e){return t[e]=!1,t}),{});e.forEach((function(t){void 0!==n[t]&&(n[t]=!0)}));return Object.keys(n).reduce((function(t,e){return n[e]||(t=!1),t}),!0)}(r,o))&&(n=!1)}else String(r).toLowerCase()!==String(o).toLowerCase()&&(n=!1);return n}),!0)},t.prototype.getMethods=function(t){var e=this;return void 0===t?this.repo.getMethods():this.repo.getMethods().filter((function(n){return e.methodMatch(t,n)}))},t.prototype.getMethodsForInstance=function(t){var e=this,n=this.repo.getServers().filter((function(n){return e.instanceMatch(t,n.instance)}));if(0===n.length)return[];var i={};return 1===n.length?i=n[0].methods:n.forEach((function(t){Object.keys(t.methods).forEach((function(e){var n=t.methods[e];i[n.identifier]=n}))})),Object.keys(i).map((function(t){return i[t]}))},t.prototype.getServers=function(t){var e=this,n=this.repo.getServers();return void 0===t?n.map((function(t){return{server:t,methods:[]}})):n.reduce((function(n,i){var r=e.repo.getServerMethodsById(i.id).filter((function(n){return e.methodMatch(t,n)}));return r.length>0&&n.push({server:i,methods:r}),n}),[])},t.prototype.getServerMethodsByFilterAndTarget=function(t,e){var n=this.getServers(t);return this.filterByTarget(e,n)},t}(),Ht=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.subscription=n}return Object.defineProperty(t.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),t.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},t.prototype.push=function(t){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,t)},t}(),Ut=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return t.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},t.prototype.acceptOnBranch=function(t){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,t)},t.prototype.reject=function(t){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,t)},t}(),Vt=function(){function t(t,e){var n=this;this.protocol=t,this.server=e,t.server.onSubRequest((function(t,e){return n.handleSubRequest(t,e)})),t.server.onSubAdded((function(t,e){return n.handleSubAdded(t,e)})),t.server.onSubRemoved((function(t,e){return n.handleSubRemoved(t,e)}))}return t.prototype.handleSubRequest=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRequestHandler){var n=new Ut(this.protocol,e,t);e.streamCallbacks.subscriptionRequestHandler(n)}},t.prototype.handleSubAdded=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionAddedHandler){var n=new Ht(this.protocol,e,t);e.streamCallbacks.subscriptionAddedHandler(n)}},t.prototype.handleSubRemoved=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRemovedHandler){var n=new Ht(this.protocol,e,t);e.streamCallbacks.subscriptionRemovedHandler(n)}},t}(),Jt=function(){function t(t,e,n){this.key=t,this.protocol=e,this.repoMethod=n}return t.prototype.subscriptions=function(){var t=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(e){return new Ht(t.protocol,t.repoMethod,e)}))},t.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},t.prototype.push=function(t){this.protocol.server.pushData(this.repoMethod,t,[this.key])},t}(),zt=function(){function t(t,e,n){this._protocol=t,this._repoMethod=e,this._server=n,this.name=this._repoMethod.definition.name}return t.prototype.branches=function(t){var e=this,n=this._protocol.server.getBranchList(this._repoMethod);return t?n.indexOf(t)>-1?new Jt(t,this._protocol,this._repoMethod):void 0:n.map((function(t){return new Jt(t,e._protocol,e._repoMethod)}))},t.prototype.branch=function(t){return this.branches(t)},t.prototype.subscriptions=function(){var t=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(e){return new Ht(t._protocol,t._repoMethod,e)}))},Object.defineProperty(t.prototype,"definition",{get:function(){var t=this._repoMethod.definition;return{accepts:t.accepts,description:t.description,displayName:t.displayName,name:t.name,objectTypes:t.objectTypes,returns:t.returns,supportsStreaming:t.supportsStreaming}},enumerable:!0,configurable:!0}),t.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},t.prototype.push=function(t,e){if("string"!=typeof e&&!Array.isArray(e)&&void 0!==e)throw new Error("invalid branches should be string or string array");if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,t,e)},t.prototype.updateRepoMethod=function(t){this._repoMethod=t},t}(),Kt=function(){function t(t,e){this.protocol=t,this.serverRepository=e,this.invocations=0,this.currentlyUnregistering={},this.streaming=new Vt(t,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return t.prototype.createStream=function(t,e,n,i,r){var o=this;return Bt(new Promise((function(n,i){if(t){var s;if(!(s="string"==typeof t?{name:""+t}:g({},t)).name)return i("The “name” property is required for the “streamDefinition” object and must be unique. Stream definition: "+JSON.stringify(s));if(o.serverRepository.getList().some((function(t){return t.definition.name===s.name})))return i('A stream with the name "'+s.name+'" already exists! Please, provide a unique name for the stream.');s.supportsStreaming=!0,e||(e={}),"function"!=typeof e.subscriptionRequestHandler&&(e.subscriptionRequestHandler=function(t){t.accept()});var a=o.serverRepository.add({definition:s,streamCallbacks:e,protocolState:{}});o.protocol.server.createStream(a).then((function(){var t;r?(t=r,r.updateRepoMethod(a)):t=new zt(o.protocol,a,o),a.stream=t,n(t)})).catch((function(t){a.repoId&&o.serverRepository.remove(a.repoId),i(t)}))}else i("The stream name must be unique! Please, provide either a unique string for a stream name to “glue.interop.createStream()” or a “methodDefinition” object with a unique “name” property for the stream.")})),n,i)},t.prototype.register=function(t,e){var n=this;if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var i=function(t,i){return y(n,void 0,void 0,(function(){var n,r,o;return m(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),(n=e(t.args,t.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return r=s.sent(),i(void 0,r),[3,3];case 2:i(void 0,n),s.label=3;case 3:return[3,5];case 4:return(o=s.sent())||(o=""),i(o,o),[3,5];case 5:return[2]}}))}))};return i.userCallback=e,this.registerCore(t,i)},t.prototype.registerAsync=function(t,e){if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var n=function(t,n){try{var i=!1,r=function(t){i||n(void 0,t),i=!0},o=function(t){i||(t||(t=""),n(t,t)),i=!0},s=e(t.args,t.instance,r,o);s&&"function"==typeof s.then&&s.then(r).catch(o)}catch(t){n(t,void 0)}};return n.userCallbackAsync=e,this.registerCore(t,n)},t.prototype.unregister=function(t,e){return void 0===e&&(e=!1),y(this,void 0,void 0,(function(){var n,i;return m(this,(function(r){switch(r.label){case 0:return void 0===t?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a “name” property.")]:"function"!=typeof t?[3,2]:[4,this.unregisterWithPredicate(t,e)];case 1:return r.sent(),[2];case 2:return void 0===(n="string"==typeof t?{name:t}:t).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(i=this.serverRepository.getList().find((function(t){return t.definition.name===n.name&&(t.definition.supportsStreaming||!1)===e})))?[4,this.removeMethodsOrStreams([i])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return r.sent(),[2]}}))}))},t.prototype.unregisterWithPredicate=function(t,e){return y(this,void 0,void 0,(function(){var n;return m(this,(function(i){switch(i.label){case 0:return(n=this.serverRepository.getList().filter((function(e){return t(e.definition)})).filter((function(t){return(t.definition.supportsStreaming||!1)===e})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(e?"stream":"method")+" matching the specified condition!")];case 1:return i.sent(),[2]}}))}))},t.prototype.removeMethodsOrStreams=function(t){var e=this,n=[];return t.forEach((function(t){var i=e.protocol.server.unregister(t).then((function(){t.repoId&&e.serverRepository.remove(t.repoId)}));n.push(i),e.addAsCurrentlyUnregistering(t.definition.name,i)})),Promise.all(n)},t.prototype.addAsCurrentlyUnregistering=function(t,e){return y(this,void 0,void 0,(function(){var n,i=this;return m(this,(function(r){return n=new Promise((function(t){return setTimeout(t,5e3)})),this.currentlyUnregistering[t]=Promise.race([e,n]).then((function(){delete i.currentlyUnregistering[t]})),[2]}))}))},t.prototype.registerCore=function(t,e){return y(this,void 0,void 0,(function(){var n,i,r,o=this;return m(this,(function(s){switch(s.label){case 0:return(n="string"==typeof t?{name:""+t}:g({},t)).name?(i=this.currentlyUnregistering[n.name])?[4,i]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the “name” property in the “methodDefinition” object: "+JSON.stringify(t))];case 1:s.sent(),s.label=2;case 2:return this.serverRepository.getList().some((function(t){return t.definition.name===n.name}))?[2,Promise.reject('A method with the name "'+n.name+'" already exists! Please, provide a unique name for the method.')]:n.supportsStreaming?[2,Promise.reject("When you create methods with “glue.interop.register()” or “glue.interop.registerAsync()” the property “supportsStreaming” cannot be “true”. If you want “"+n.name+"” to be a stream, please use the “glue.interop.createStream()” method.")]:(r=this.serverRepository.add({definition:n,theFunction:e,protocolState:{}}),[2,this.protocol.server.register(r).catch((function(t){throw(null==r?void 0:r.repoId)&&o.serverRepository.remove(r.repoId),t}))])}}))}))},t.prototype.onMethodInvoked=function(t,e,n){var i=this;t&&t.theFunction&&t.theFunction(n,(function(n,r){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(t){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}r?("object"!=typeof r||Array.isArray(r))&&(r={_value:r}):r={},i.protocol.server.methodInvocationResult(t,e,n,r)}))},t}(),Yt=function(){function t(t,e){var n=this;this.wrapped={getMethods:Zt,getStreams:$t},t&&this.refreshWrappedObject(t),e&&(e.loggedIn((function(){n.refresh(e)})),this.refresh(e))}return t.prototype.unwrap=function(){return this.wrapped},t.prototype.refresh=function(t){if(t){var e=null==t?void 0:t.resolvedIdentity,n=Object.assign({},null!=e?e:{},{peerId:null==t?void 0:t.peerId});this.refreshWrappedObject(n)}},t.prototype.refreshWrappedObject=function(t){var e,n,i;this.wrapped.user=t.user,this.wrapped.instance=t.instance,this.wrapped.application=null!==(e=t.application)&&void 0!==e?e:ut(),this.wrapped.applicationName=t.applicationName,this.wrapped.pid=null!==(i=null!==(n=t.pid)&&void 0!==n?n:t.process)&&void 0!==i?i:Math.floor(1e10*Math.random()),this.wrapped.machine=t.machine,this.wrapped.environment=t.environment,this.wrapped.region=t.region,this.wrapped.windowId=t.windowId,this.wrapped.isLocal=!0,this.wrapped.api=t.api,this.wrapped.service=t.service,this.wrapped.peerId=t.peerId},t}();function Zt(){var t;return null===(t=Yt.API)||void 0===t?void 0:t.methodsForInstance(this)}function $t(){var t;return null===(t=Yt.API)||void 0===t?void 0:t.methodsForInstance(this).filter((function(t){return t.supportsStreaming}))}var Xt=function(){function t(t){this.logger=t,this.servers={},this.methodsCount={},this.callbacks=B()}return t.prototype.addServer=function(t,e){this.logger.debug("adding server "+e);var n=this.servers[e];if(n)return n.id;var i=new Yt(t),r={id:e,methods:{},instance:i.unwrap(),wrapper:i};return this.servers[e]=r,this.callbacks.execute("onServerAdded",r.instance),e},t.prototype.removeServerById=function(t,e){var n=this,i=this.servers[t];i?(this.logger.debug("removing server "+t),Object.keys(i.methods).forEach((function(e){n.removeServerMethod(t,e)})),delete this.servers[t],this.callbacks.execute("onServerRemoved",i.instance,e)):this.logger.warn("not aware of server "+t+", my state "+JSON.stringify(Object.keys(this.servers)))},t.prototype.addServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");if(!n.methods[e.id]){var i=this.createMethodIdentifier(e),r=this,o={identifier:i,gatewayId:e.id,name:e.name,displayName:e.display_name,description:e.description,version:e.version,objectTypes:e.object_types||[],accepts:e.input_signature,returns:e.result_signature,supportsStreaming:void 0!==e.flags&&e.flags.streaming,getServers:function(){return r.getServersByMethod(i)}};return o.object_types=o.objectTypes,o.display_name=o.displayName,o.version=o.version,n.methods[e.id]=o,this.methodsCount[i]||(this.methodsCount[i]=0,this.callbacks.execute("onMethodAdded",o)),this.methodsCount[i]=this.methodsCount[i]+1,this.callbacks.execute("onServerMethodAdded",n.instance,o),o}},t.prototype.removeServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");var i=n.methods[e];delete n.methods[e],this.methodsCount[i.identifier]=this.methodsCount[i.identifier]-1,0===this.methodsCount[i.identifier]&&this.callbacks.execute("onMethodRemoved",i),this.callbacks.execute("onServerMethodRemoved",n.instance,i)},t.prototype.getMethods=function(){var t=this,e={};return Object.keys(this.servers).forEach((function(n){var i=t.servers[n];Object.keys(i.methods).forEach((function(t){var n=i.methods[t];e[n.identifier]=n}))})),Object.keys(e).map((function(t){return e[t]}))},t.prototype.getServers=function(){var t=this,e=[];return Object.keys(this.servers).forEach((function(n){var i=t.servers[n];e.push(i)})),e},t.prototype.getServerMethodsById=function(t){var e=this.servers[t];return Object.keys(e.methods).map((function(t){return e.methods[t]}))},t.prototype.onServerAdded=function(t){var e=this.callbacks.add("onServerAdded",t),n=this.getServers().map((function(t){return t.instance}));return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onMethodAdded=function(t){var e=this.callbacks.add("onMethodAdded",t),n=this.getMethods();return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onServerMethodAdded=function(t){var e=this.callbacks.add("onServerMethodAdded",t),n=!1,i=this.getServers();return setTimeout((function(){i.forEach((function(e){var i=e.methods;Object.keys(i).forEach((function(r){n||t(e.instance,i[r])}))}))}),0),function(){n=!0,e()}},t.prototype.onMethodRemoved=function(t){return this.callbacks.add("onMethodRemoved",t)},t.prototype.onServerRemoved=function(t){return this.callbacks.add("onServerRemoved",t)},t.prototype.onServerMethodRemoved=function(t){return this.callbacks.add("onServerMethodRemoved",t)},t.prototype.getServerById=function(t){return this.servers[t]},t.prototype.reset=function(){var t=this;Object.keys(this.servers).forEach((function(e){t.removeServerById(e,"reset")})),this.servers={},this.methodsCount={}},t.prototype.createMethodIdentifier=function(t){var e=void 0!==t.input_signature?t.input_signature:"",n=void 0!==t.result_signature?t.result_signature:"";return(t.name+e+n).toLowerCase()},t.prototype.getServersByMethod=function(t){var e=this,n=[];return Object.keys(this.servers).forEach((function(i){var r=e.servers[i];Object.keys(r.methods).forEach((function(e){r.methods[e].identifier===t&&n.push(r.instance)}))})),n},t.prototype.returnUnsubWithDelayedReplay=function(t,e,n){var i=!1;return setTimeout((function(){e.forEach((function(t){i||n(t)}))}),0),function(){i=!0,t()}},t}(),Qt=function(){function t(){this.nextId=0,this.methods=[]}return t.prototype.add=function(t){return t.repoId=String(this.nextId),this.nextId+=1,this.methods.push(t),t},t.prototype.remove=function(t){if("string"!=typeof t)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(e){return e.repoId!==t}))},t.prototype.getById=function(t){if("string"==typeof t)return this.methods.find((function(e){return e.repoId===t}))},t.prototype.getList=function(){return this.methods.map((function(t){return t}))},t.prototype.length=function(){return this.methods.length},t.prototype.reset=function(){this.methods=[]},t}(),te="onSubscriptionRequest",ee="onSubscriptionAdded",ne="onSubscriptionRemoved",ie=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.serverRepository=n,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=B(),this.nextStreamId=0,t.on("add-interest",(function(t){i.handleAddInterest(t)})),t.on("remove-interest",(function(t){i.handleRemoveInterest(t)}))}return t.prototype.acceptRequestOnBranch=function(t,e,n){if("string"!=typeof n&&(n=""),"object"!=typeof e.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(e.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var i=this.getStreamId(e,n),r=t.msg.subscription_id,o={id:r,arguments:t.arguments,instance:t.instance,branchKey:n,streamId:i,subscribeMsg:t.msg};e.protocolState.subscriptionsMap[r]=o,this.session.sendFireAndForget({type:"accepted",subscription_id:r,stream_id:i}),this.callbacks.execute(ee,o,e)},t.prototype.rejectRequest=function(t,e,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,t.msg.subscription_id)},t.prototype.pushData=function(t,e,n){var i=this;if("object"==typeof t&&Array.isArray(t.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]),t.protocolState.branchKeyToStreamIdMap.filter((function(t){return!n||0===n.length||n.indexOf(t.key)>=0})).map((function(t){return t.streamId})).forEach((function(t){var n={type:"publish",stream_id:t,data:e};i.session.sendFireAndForget(n)}))}},t.prototype.pushDataToSingle=function(t,e,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var i={type:"post",subscription_id:e.id,data:n};this.session.sendFireAndForget(i)},t.prototype.closeSingleSubscription=function(t,e){t.protocolState.subscriptionsMap&&delete t.protocolState.subscriptionsMap[e.id];var n={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);e.instance;this.callbacks.execute(ne,e,t)},t.prototype.closeMultipleSubscriptions=function(t,e){var n=this;if("object"==typeof t&&"object"==typeof t.protocolState.subscriptionsMap&&t.protocolState.subscriptionsMap){var i=t.protocolState.subscriptionsMap,r=Object.keys(i).map((function(t){return i[t]}));"string"==typeof e&&(r=r.filter((function(t){return t.branchKey===e}))),r.forEach((function(t){delete i[t.id];var e={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping all subscriptions on stream_id: "+t.streamId};n.session.sendFireAndForget(e)}))}},t.prototype.getSubscriptionList=function(t,e){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var n=t.protocolState.subscriptionsMap,i=Object.keys(n).map((function(t){return n[t]}));return"string"!=typeof e?i:i.filter((function(t){return t.branchKey===e}))},t.prototype.getBranchList=function(t){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var e=t.protocolState.subscriptionsMap,n=Object.keys(e).map((function(t){return e[t]})),i=[];return n.forEach((function(t){var e="";"object"==typeof t&&"string"==typeof t.branchKey&&(e=t.branchKey),-1===i.indexOf(e)&&i.push(e)})),i},t.prototype.onSubAdded=function(t){this.onSubscriptionLifetimeEvent(ee,t)},t.prototype.onSubRequest=function(t){this.onSubscriptionLifetimeEvent(te,t)},t.prototype.onSubRemoved=function(t){this.onSubscriptionLifetimeEvent(ne,t)},t.prototype.handleRemoveInterest=function(t){var e=this.serverRepository.getById(t.method_id);if("string"==typeof t.subscription_id&&"object"==typeof e&&e.protocolState.subscriptionsMap&&"object"==typeof e.protocolState.subscriptionsMap[t.subscription_id]){var n=e.protocolState.subscriptionsMap[t.subscription_id];delete e.protocolState.subscriptionsMap[t.subscription_id],this.callbacks.execute(ne,n,e)}},t.prototype.onSubscriptionLifetimeEvent=function(t,e){this.callbacks.add(t,e)},t.prototype.getNextStreamId=function(){return this.nextStreamId+++""},t.prototype.handleAddInterest=function(t){var e=this.repository.getServerById(t.caller_id).instance,n={msg:t,arguments:t.arguments_kv||{},instance:e},i=this.serverRepository.getById(t.method_id);if(void 0!==i)i.protocolState.subscriptionsMap&&i.protocolState.subscriptionsMap[t.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+t.subscription_id+" already exists.",t.subscription_id):this.callbacks.execute(te,n,i);else{var r="No method with id "+t.method_id+" on this server.";this.sendSubscriptionFailed(r,t.subscription_id)}},t.prototype.sendSubscriptionFailed=function(t,e){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:t,request_id:e};this.session.sendFireAndForget(n)},t.prototype.getStreamId=function(t,e){if("string"!=typeof e&&(e=""),!t.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+t.definition.name+" method without protocol state");var n=t.protocolState.branchKeyToStreamIdMap.filter((function(t){return t.key===e}))[0],i=n?n.streamId:void 0;return"string"==typeof i&&""!==i||(i=this.getNextStreamId(),t.protocolState.branchKeyToStreamIdMap.push({key:e,streamId:i})),i},t}(),re=function(){function t(t,e,n,i){var r=this;this.session=t,this.clientRepository=e,this.serverRepository=n,this.logger=i,this.callbacks=B(),this.streaming=new ie(t,e,n),this.session.on("invoke",(function(t){return r.handleInvokeMessage(t)}))}return t.prototype.createStream=function(t){return t.protocolState.subscriptionsMap={},t.protocolState.branchKeyToStreamIdMap=[],this.register(t,!0)},t.prototype.register=function(t,e){var n=this,i=t.definition,r={streaming:e||!1},o={type:"register",methods:[{id:t.repoId,name:i.name,display_name:i.displayName,description:i.description,version:i.version,flags:r,object_types:i.objectTypes||i.object_types,input_signature:i.accepts,result_signature:i.returns,restrictions:void 0}]};return this.session.send(o,{methodId:t.repoId}).then((function(){n.logger.debug("registered method "+t.definition.name+" with id "+t.repoId)})).catch((function(e){throw n.logger.warn("failed to register method "+t.definition.name+" with id "+t.repoId+" - "+JSON.stringify(e)),e}))},t.prototype.onInvoked=function(t){this.callbacks.add("onInvoked",t)},t.prototype.methodInvocationResult=function(t,e,n,i){var r;r=n||""===n?{type:"error",request_id:e,reason_uri:"agm.errors.client_error",reason:n,context:i,peer_id:void 0}:{type:"yield",invocation_id:e,peer_id:this.session.peerId,result:i,request_id:void 0},this.session.sendFireAndForget(r)},t.prototype.unregister=function(t){return y(this,void 0,void 0,(function(){var e;return m(this,(function(n){switch(n.label){case 0:return e={type:"unregister",methods:[t.repoId]},[4,this.session.send(e)];case 1:return n.sent(),[2]}}))}))},t.prototype.getBranchList=function(t){return this.streaming.getBranchList(t)},t.prototype.getSubscriptionList=function(t,e){return this.streaming.getSubscriptionList(t,e)},t.prototype.closeAllSubscriptions=function(t,e){this.streaming.closeMultipleSubscriptions(t,e)},t.prototype.pushData=function(t,e,n){this.streaming.pushData(t,e,n)},t.prototype.pushDataToSingle=function(t,e,n){this.streaming.pushDataToSingle(t,e,n)},t.prototype.closeSingleSubscription=function(t,e){this.streaming.closeSingleSubscription(t,e)},t.prototype.acceptRequestOnBranch=function(t,e,n){this.streaming.acceptRequestOnBranch(t,e,n)},t.prototype.rejectRequest=function(t,e,n){this.streaming.rejectRequest(t,e,n)},t.prototype.onSubRequest=function(t){this.streaming.onSubRequest(t)},t.prototype.onSubAdded=function(t){this.streaming.onSubAdded(t)},t.prototype.onSubRemoved=function(t){this.streaming.onSubRemoved(t)},t.prototype.handleInvokeMessage=function(t){var e=t.invocation_id,n=t.caller_id,i=t.method_id,r=t.arguments_kv,o=this.serverRepository.getList().filter((function(t){return t.repoId===i}))[0];if(void 0!==o){var s={args:r,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",o,e,s)}},t}(),oe=function(){function t(t,e){this.repository=t,this.subscriptionData=e}return Object.defineProperty(t.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"servers",{get:function(){var t=this;return this.subscriptionData.trackedServers.filter((function(t){return t.subscriptionId})).map((function(e){return t.repository.getServerById(e.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),t.prototype.onData=function(t){if("function"!=typeof t)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(t),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(e){t(e)}))},t.prototype.onClosed=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(t)},t.prototype.onFailed=function(t){},t.prototype.onConnected=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(t)},t.prototype.close=function(){this.subscriptionData.close()},t.prototype.setNewSubscription=function(t){this.subscriptionData=t},t}(),se="awaitingAccept",ae="subscribed",ce="Subscription failed.",ue="ClientInitiated",de=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.logger=n,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(t){var e=t._tag,n=e.subLocalKey,r=i.subscriptionsList[n];if("object"==typeof r&&(r.trackedServers=r.trackedServers.filter((function(t){return t.serverId!==e.serverId})),r.trackedServers.length<=0)){if(clearTimeout(r.timeoutId),r.status===se){var o="string"==typeof t.reason&&""!==t.reason?' Publisher said "'+t.reason+'".':" No reason given.",s="object"==typeof r.params.arguments?JSON.stringify(r.params.arguments):"{}";r.error({message:"Subscription rejected."+o+" Called with:"+s,called_with:r.params.arguments,method:r.method})}else r.status===ae&&i.callOnClosedHandlers(r);delete i.subscriptionsList[n]}},this.handleSubscribed=function(t){var e=t._tag.subLocalKey,n=i.subscriptionsList[e];if("object"==typeof n){var r=t._tag.serverId,o=n.trackedServers.filter((function(t){return t.serverId===r}))[0];if("object"==typeof o){o.subscriptionId=t.subscription_id,i.subscriptionIdToLocalKeyMap[t.subscription_id]=e;var s=n.status===se;if(n.status=ae,s){var a=!1,c=n.subscription;c?(c.setNewSubscription(n),n.success(c),a=!0):(c=new oe(i.repository,n),n.subscription=c,n.success(c));for(var u=0,d=n.handlers.onConnected;u<d.length;u++){var p=d[u];try{p(c.serverInstance,a)}catch(t){}}}}}},this.handleEventData=function(t){var e=i.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=i.subscriptionsList[e];if("object"==typeof n){var r=n.trackedServers.filter((function(e){return e.subscriptionId===t.subscription_id}));if(1===r.length){var o=t.oob,s=r[0].serverId,a=function(){return{data:t.data,server:i.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:o}},c=n.handlers.onData,u=n.queued.data;c.length>0?c.forEach((function(t){"function"==typeof t&&t(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(t){var e=i.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=i.subscriptionsList[e];if("object"==typeof n){var r=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(e){return e.subscriptionId!==t.subscription_id||(n.queued.closers.push(e.serverId),!1)})),n.trackedServers.length===r&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),i.callOnClosedHandlers(n),delete i.subscriptionsList[e]),delete i.subscriptionIdToLocalKeyMap[t.subscription_id])}}},t.on("subscribed",this.handleSubscribed),t.on("event",this.handleEventData),t.on("subscription-cancelled",this.handleSubscriptionCancelled)}return t.prototype.subscribe=function(t,e,n,i,r,o){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,t,e,i,r,e.methodResponseTimeout||1e4,o);"object"==typeof c?n.forEach((function(n){var i=n.server.id,r=n.methods.find((function(e){return e.name===t.name}));if(r){c.trackedServers.push({serverId:i,subscriptionId:void 0});var o={type:"subscribe",server_id:i,method_id:r.gatewayId,arguments_kv:e.arguments};s.session.send(o,{serverId:i,subLocalKey:a}).then((function(t){return s.handleSubscribed(t)})).catch((function(t){return s.handleErrorSubscribing(t)}))}else s.logger.error("can not find method "+t.name+" for target "+n.server.id)})):r({method:t,called_with:e.arguments,message:ce+" Unable to register the user callbacks."})}else r({method:t,called_with:e.arguments,message:ce+" No available servers matched the target params."})},t.prototype.drainSubscriptions=function(){var t=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},t},t.prototype.getNextSubscriptionLocalKey=function(){var t=this.nextSubLocalKey;return this.nextSubLocalKey+=1,t},t.prototype.registerSubscription=function(t,e,n,i,r,o,s){var a=this,c={localKey:t,status:se,method:e,params:n,success:i,error:r,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(t)},subscription:null==s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[t]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[t]){var i=a.subscriptionsList[t];i.status===se?(r({method:e,called_with:n.arguments,message:ce+" Subscription attempt timed out after "+o+" ms."}),delete a.subscriptionsList[t]):i.status===ae&&i.trackedServers.length>0&&(i.trackedServers=i.trackedServers.filter((function(t){return void 0!==t.subscriptionId})),delete i.timeoutId,i.trackedServers.length<=0&&(a.callOnClosedHandlers(i),delete a.subscriptionsList[t]))}}),o),c},t.prototype.callOnClosedHandlers=function(t,e){var n,i=t.queued.closers.length,r=i>0?t.queued.closers[i-1]:null;void 0!==r&&"string"==typeof r&&(n=this.repository.getServerById(r).instance),t.handlers.onClosed.forEach((function(i){"function"==typeof i&&i({message:e||"ServerInitiated",requestArguments:t.params.arguments||{},server:n,stream:t.method})}))},t.prototype.closeSubscription=function(t){var e=this,n=this.subscriptionsList[t];"object"==typeof n&&(n.trackedServers.forEach((function(t){void 0!==t.subscriptionId&&(n.queued.closers.push(t.serverId),e.session.sendFireAndForget({type:"unsubscribe",subscription_id:t.subscriptionId,reason_uri:"",reason:ue}),delete e.subscriptionIdToLocalKeyMap[t.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,ue),delete this.subscriptionsList[t])},t}(),pe=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.logger=n,t.on("peer-added",(function(t){return i.handlePeerAdded(t)})),t.on("peer-removed",(function(t){return i.handlePeerRemoved(t)})),t.on("methods-added",(function(t){return i.handleMethodsAddedMessage(t)})),t.on("methods-removed",(function(t){return i.handleMethodsRemovedMessage(t)})),this.streaming=new de(t,e,n)}return t.prototype.subscribe=function(t,e,n,i,r,o){this.streaming.subscribe(t,e,n,i,r,o)},t.prototype.invoke=function(t,e,n,i){var r=this,o=i.id,s={type:"call",server_id:o,method_id:e.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:t,serverId:o}).then((function(t){return r.handleResultMessage(t)})).catch((function(t){return r.handleInvocationError(t)}))},t.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},t.prototype.handlePeerAdded=function(t){var e=t.new_peer_id,n=t.identity,i=!t.meta||t.meta.local,r=Number(n.process),o={machine:n.machine,pid:isNaN(r)?n.process:r,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:e,api:n.api,isLocal:i};this.repository.addServer(o,e)},t.prototype.handlePeerRemoved=function(t){var e=t.removed_id,n=t.reason;this.repository.removeServerById(e,n)},t.prototype.handleMethodsAddedMessage=function(t){var e=this,n=t.server_id;t.methods.forEach((function(t){e.repository.addServerMethod(n,t)}))},t.prototype.handleMethodsRemovedMessage=function(t){var e=this,n=t.server_id,i=t.methods,r=this.repository.getServerById(n);Object.keys(r.methods).forEach((function(t){var o=r.methods[t];i.indexOf(o.gatewayId)>-1&&e.repository.removeServerMethod(n,t)}))},t.prototype.handleResultMessage=function(t){var e=t._tag.invocationId,n=t.result,i=t._tag.serverId;return{invocationId:e,result:n,instance:this.repository.getServerById(i).instance,status:Wt.Success,message:""}},t.prototype.handleInvocationError=function(t){if(this.logger.debug("handle invocation error "+JSON.stringify(t)),"_tag"in t){var e=t._tag.invocationId,n=t._tag.serverId,i=this.repository.getServerById(n),r=t.reason;return{invocationId:e,result:t.context,instance:i.instance,status:Wt.Error,message:r}}return{invocationId:"",message:t.message,status:Wt.Error,error:t}},t}();function he(t,e,n,i,r,o){var s,a=r.logger.subLogger("gw3-protocol"),c=new Promise((function(t){s=t})),u=e.domain("agm",["subscribed"]),d=new re(u,n,i,a.subLogger("server")),p=new pe(u,n,a.subLogger("client"));return u.onJoined((function(r){n.addServer(t,e.peerId),r?function(){a.info("reconnected - will replay registered methods and subscriptions");for(var t=0,e=p.drainSubscriptions();t<e.length;t++){var n=e[t],r=n.method,s=Object.assign({},n.params);a.info("trying to re-subscribe to method "+r.name),o.client.subscribe(r,s,void 0,void 0,n)}var c=i.getList();i.reset();for(var u=0,d=c;u<d.length;u++){var h=d[u],f=h.definition;a.info("re-publishing method "+f.name),h.stream?o.server.createStream(f,h.streamCallbacks,void 0,void 0,h.stream):h.theFunction&&h.theFunction.userCallback?o.register(f,h.theFunction.userCallback):h.theFunction&&h.theFunction.userCallbackAsync&&o.registerAsync(f,h.theFunction.userCallbackAsync)}}():s&&(s({client:p,server:d}),s=void 0)})),u.onLeft((function(){n.reset()})),u.join(),c}var fe=function(){function t(t){var e=this;if(void 0===t)throw new Error("configuration is required");if(void 0===t.connection)throw new Error("configuration.connections is required");var n,i=t.connection;if("number"!=typeof t.methodResponseTimeout&&(t.methodResponseTimeout=3e4),"number"!=typeof t.waitTimeoutMs&&(t.waitTimeoutMs=3e4),Yt.API=this,this.instance=new Yt(void 0,i).unwrap(),this.clientRepository=new Xt(t.logger.subLogger("cRep")),this.serverRepository=new Qt,3!==i.protocolVersion)throw new Error("protocol "+i.protocolVersion+" not supported");n=he(this.instance,i,this.clientRepository,this.serverRepository,t,this),this.readyPromise=n.then((function(n){return e.protocol=n,e.client=new Gt(e.protocol,e.clientRepository,e.instance,t),e.server=new Kt(e.protocol,e.serverRepository),e}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.serverRemoved=function(t){return this.client.serverRemoved(t)},t.prototype.serverAdded=function(t){return this.client.serverAdded(t)},t.prototype.serverMethodRemoved=function(t){return this.client.serverMethodRemoved(t)},t.prototype.serverMethodAdded=function(t){return this.client.serverMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.client.methodRemoved(t)},t.prototype.methodAdded=function(t){return this.client.methodAdded(t)},t.prototype.methodsForInstance=function(t){return this.client.methodsForInstance(t)},t.prototype.methods=function(t){return this.client.methods(t)},t.prototype.servers=function(t){return this.client.servers(t)},t.prototype.subscribe=function(t,e,n,i){return this.client.subscribe(t,e,n,i)},t.prototype.createStream=function(t,e,n,i){return this.server.createStream(t,e,n,i)},t.prototype.unregister=function(t){return this.server.unregister(t)},t.prototype.registerAsync=function(t,e){return this.server.registerAsync(t,e)},t.prototype.register=function(t,e){return this.server.register(t,e)},t.prototype.invoke=function(t,e,n,i,r,o){return this.client.invoke(t,e,n,i,r,o)},t}(),le=["subscribed","success"],ve=function(){function t(t,e){var n=this;this.publish=function(t,e,i){var r=i||{},o=r.routingKey,s=r.target,a=n.removeEmptyValues({type:"publish",topic:t,data:e,peer_id:n.peerId,routing_key:o,target_identity:s});n.session.send(a)},this.subscribe=function(t,e,i){return new Promise((function(r,o){var s=i||{},a=s.routingKey,c=s.target,u=n.removeEmptyValues({type:"subscribe",topic:t,peer_id:n.peerId,routing_key:a,source:c});n.session.send(u).then((function(i){var o=i.subscription_id;n.subscriptions.push({subscription_id:o,topic:t,callback:e,source:c}),r({unsubscribe:function(){return n.session.send({type:"unsubscribe",subscription_id:o,peer_id:n.peerId}),n.subscriptions=n.subscriptions.filter((function(t){return t.subscription_id!==o})),Promise.resolve()}})})).catch((function(t){return o(t)}))}))},this.watchOnEvent=function(){n.session.on("event",(function(t){var e=t.data,i=t.subscription_id,r=t["publisher-identity"],o=n.subscriptions.find((function(t){return t.subscription_id===i}));o&&(o.source?n.keysMatch(o.source,r)&&o.callback(e,o.topic,r):o.callback(e,o.topic,r))}))},this.connection=t,this.logger=e,this.peerId=t.peerId,this.subscriptions=[],this.session=t.domain("bus",le),this.readyPromise=this.session.join(),this.readyPromise.then((function(){n.watchOnEvent()}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.removeEmptyValues=function(t){var e={};return Object.keys(t).forEach((function(n){void 0!==t[n]&&null!==t[n]&&(e[n]=t[n])})),e},t.prototype.keysMatch=function(t,e){var n=Object.keys(t),i=!0;return n.forEach((function(n){t[n]!==e[n]&&(i=!1)})),i},t}(),ge=function(t,e){var n,i=H.getGDMajorVersion(),r=Promise.resolve();if(i){if(i<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");i>=3&&(n=window.glue42gd,r=window.gdPreloadPromise||r)}var o,s,a,c,u,d,p=jt(),h=Mt(t=t||{},e=e||{},n),f={};function l(t,e,n){a.canPublish("trace")&&a.trace("registering "+t+" module");var i=function(){e.initTime=n.stop(),e.initEndTime=n.endTime,a.trace(t+" is ready")};e.initStartTime=n.startTime,e.ready?e.ready().then((function(){i()})):i(),Array.isArray(t)||(t=[t]),t.forEach((function(t){f[t]=e,ge[t]=e}))}function v(){var t,e,i,r=jt(),s=h.metrics,u=null==n?void 0:n.getMetricsPublishingEnabled,d=h.connection.identity,p=u||function(){return!0},f=D({connection:s?o:void 0,logger:a.subLogger("metrics"),canUpdateMetric:p,system:"Glue42",service:null!==(t=null==d?void 0:d.service)&&void 0!==t?t:"metrics-service",instance:null!==(i=null!==(e=null==d?void 0:d.instance)&&void 0!==e?e:null==d?void 0:d.windowId)&&void 0!==i?i:ut()}),v=f;return v="boolean"!=typeof s&&s.disableAutoAppSystem?f:f.subSystem("App"),l("metrics",c=function(t){var e,n=t.subSystem("reporting"),i={name:"features"};return t.featureMetric=function(t,r,o){if(void 0===t||""===t)throw new Error("name is mandatory");if(void 0===r||""===r)throw new Error("action is mandatory");if(void 0===o||""===o)throw new Error("payload is mandatory");e?e.update({name:t,action:r,payload:o}):e=n.objectMetric(i,{name:t,action:r,payload:o})},t}(v),r),Promise.resolve()}function g(){var t=h.activities&&3===o.protocolVersion;if(h.contexts||t){var e=jt();return l("contexts",u=new Ft({connection:o,logger:a.subLogger("contexts")}),e),u}var n=o.replayer;n&&n.drain(Tt.name)}function w(){return y(this,void 0,void 0,(function(){var t;return m(this,(function(e){return h.bus?(t=jt(),l("bus",d=new ve(o,a.subLogger("bus")),t),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function b(t){try{return t.forEach((function(t){!function(t,e){var n=jt(),i=e(f);i&&l(t,i,n)}(t.name,t.create)})),Promise.resolve()}catch(t){return Promise.reject(t)}}return r.then((function(){var t,e=jt();return(a=new vt(""+(null===(t=h.connection.identity)||void 0===t?void 0:t.application),void 0,h.customLogger)).consoleLevel(h.logger.console),a.publishLevel(h.logger.publish),l("logger",a,e),Promise.resolve(void 0)})).then((function(){var t=jt();o=new ft(h.connection,a.subLogger("connection"));var e=Promise.resolve(h.auth);return h.connection&&!h.auth&&(n?(a.trace("trying to get gw token..."),e=n.getGWToken().then((function(t){return a.trace("got GW token "+(null==t?void 0:t.substring(t.length-10))),{gatewayToken:t}}))):e=Promise.reject("You need to provide auth information")),e.then((function(t){var e;if("[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));return e=t,o.login(e)})).then((function(){return l("connection",o,t),h})).catch((function(t){throw o&&o.logout(),t}))})).then((function(){return Promise.all([v(),(t=jt(),e={connection:o,logger:a.subLogger("interop")},s=new fe(e),vt.Interop=s,l(["interop","agm"],s,t),Promise.resolve()),g(),w()]);var t,e})).then((function(){return s.readyPromise})).then((function(){return b(h.libs||[])})).then((function(){var t=Object.keys(f).map((function(t){var e=f[t];return e.ready?e.ready():Promise.resolve()}));return Promise.all(t)})).then((function(){var i={coreVersion:Pt,version:h.version};p.stop();var r={feedback:function(t){s&&s.invoke("T42.ACS.Feedback",t,"best")},info:i,logger:a,interop:s,agm:s,connection:o,metrics:c,contexts:u,bus:d,version:h.version,userConfig:t,done:function(){return null==a||a.info("done called by user..."),o.logout()}};return r.performance={get glueVer(){return h.version},get glueConfig(){return JSON.stringify(t)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var t=Object.keys(r).filter((function(t){var e;return"initTimes"!==t&&"agm"!==t&&(null===(e=r[t])||void 0===e?void 0:e.initTime)})).map((function(t){return{name:t,time:r[t].initTime,startTime:r[t].initStartTime,endTime:r[t].initEndTime}}));return t.push({name:"glue",startTime:p.startTime,endTime:p.endTime,time:p.period}),t}},Object.keys(f).forEach((function(t){var e=f[t];r[t]=e})),r.config={},Object.keys(h).forEach((function(t){r.config[t]=h[t]})),e&&e.extOptions&&Object.keys(e.extOptions).forEach((function(t){r.config[t]=null==e?void 0:e.extOptions[t]})),(null==e?void 0:e.enrichGlue)&&e.enrichGlue(r),n&&n.updatePerfData&&n.updatePerfData(r.performance),r})).catch((function(t){return Promise.reject({err:t,libs:f})}))};"undefined"!=typeof window&&(window.GlueCore=ge),ge.version=Pt,ge.default=ge;
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */
var ye=function(t,e){return(ye=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function me(t,e){function n(){this.constructor=t}ye(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var we=function(){return(we=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function be(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){t.done?r(t.value):new n((function(e){e(t.value)})).then(s,a)}c((i=i.apply(t,e||[])).next())}))}function _e(t,e){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var Ie=function(){function t(t){this._id=t}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),t.prototype._update=function(t){if(t._id!==this._id)throw Error("Can not update from entity with different id.");this._updateCore(t)},t.prototype._updateCore=function(t){},t.prototype._beforeDelete=function(t){},t}();function Se(t){return"string"==typeof t}function xe(t){return Array.isArray?Array.isArray(t):"[object Array]"===toString.call(t)}function ke(t){return void 0===t}function Ce(t){return!t||void 0===t}function Ae(t){return!!(t&&t.constructor&&t.call&&t.apply)}function Te(t,e){void 0!==t&&e(t)}var Pe=function(t){function e(e,n,i,r){var o=t.call(this,e)||this;return o._name=e,o._description=r,o._ownerWindow=n,o._helperWindows=i||[],o}return me(e,t),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"description",{get:function(){return this._description},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"helperWindows",{get:function(){return this._helperWindows},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ownerWindow",{get:function(){return this._ownerWindow},enumerable:!0,configurable:!0}),e.prototype.initiate=function(t,e,n){return this._manager.initiate(this._name,t,e,n)},e.prototype._updateCore=function(e){var n=this;t.prototype._updateCore.call(this,e),Te(e._description,(function(t){return n._description=t})),Te(e._ownerWindow,(function(t){return n._ownerWindow=t})),Te(e._helperWindows,(function(t){return n._helperWindows=t}))},e}(Ie),Me=function(t){function e(e,n){var i=t.call(this,e)||this;return i._name=e,i._appByWindowTypeGetter=n,i}return me(e,t),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"config",{get:function(){return this._appByWindowTypeGetter(this._name)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windows",{get:function(){return this._manager.getWindows({type:this._name})},enumerable:!0,configurable:!0}),e.prototype.create=function(t,e){var n=Object.assign({type:this.name,name:this.name,isIndependent:!1},e);return this._manager.createWindow(t,n)},e}(Ie),je=function(t,e){this.entity=t,this.context=e},Oe=function(t){this.type=t},Ee=function(t){function e(e,n){var i=t.call(this,Le.StatusChange)||this;return i.newStatus=e,i.oldStatus=n,i}return me(e,t),e}(Oe),Re=function(t){function e(e,n,i){var r=t.call(this,Le.ActivityContextChange)||this;return r.context="string"==typeof e?JSON.parse(e):e,r.updated=n,r.removed=i,r}return me(e,t),e}(Oe),Le=function(){function t(){}return t.Added="added",t.Removed="removed",t.Updated="updated",t.Closed="closed",t.StatusChange="statusChange",t.ActivityContextChange="activityContextUpdate",t.ActivityWindowEvent="activityWindowEvent",t.ActivityWindowJoinedActivity="joined",t.ActivityWindowLeftActivity="left",t}(),Ne=function(){function t(){}return t.Created="created",t.Started="started",t.Destroyed="destroyed",t}(),We=function(){function t(t){this._activity=t}return t.prototype.register=function(e,n){this._ensureHasAgm(),t.AGM.register(e,n)},t.prototype.servers=function(){return this._ensureHasAgm(),Ce(this._activity)?[]:this._activity.windows.map((function(t){return t.instance}))},t.prototype.methods=function(){var t=this;if(this._ensureHasAgm(),Ce(this._activity))return[];var e=this._activity.windows,n=[],i=[];return e.forEach((function(e){t.methodsForWindow(e).forEach((function(t){-1===n.indexOf(t.name)&&(n.push(t.name),i.push(t))}))})),i},t.prototype.methodsForWindow=function(e){return this._ensureHasAgm(),e.instance?t.AGM.methodsForInstance(e.instance):[]},t.prototype.invoke=function(e,n,i,r,o,s){this._ensureHasAgm();var a=this.servers();if(Ce(i)&&(i="activity.all"),Se(i))if("activity.all"===i)a;else{if("activity.best"!==i){if("all"===i||"best"===i)return function(t,e,n){if("function"!=typeof e&&"function"!=typeof n)return t;"function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n)}(t.AGM.invoke(e,n,i,r),o,s);throw new Error("Invalid invoke target "+i)}var c=a.filter((function(n){return t.AGM.methodsForInstance(n).filter((function(t){return t.name===e})).length>0}));c.length>0&&[c[0]]}else if(xe(i)){if(i.length>=0){var u=i[0];if(this._isInstance(u))i.map((function(t){return t}));else{if(!this._isActivityWindow(u))throw new Error("Unknown target object");i.map((function(t){return t.instance}))}}}else if(this._isInstance(i))[i];else{if(!this._isActivityWindow(i))throw new Error("Unknown target object");[i.instance]}throw new Error("Not implemented")},t.prototype.unregister=function(e){return this._ensureHasAgm(),t.AGM.unregister(e)},t.prototype.createStream=function(e,n,i){this._ensureHasAgm(),t.AGM.createStream(e,{subscriptionAddedHandler:n,subscriptionRemovedHandler:i,subscriptionRequestHandler:void 0})},t.prototype.subscribe=function(e,n,i){return this._ensureHasAgm(),t.AGM.subscribe(e,n)},t.prototype._ensureHasAgm=function(){if(Ce(t.AGM))throw new Error("Agm should be configured to be used in activity")},t.prototype._isInstance=function(t){return void 0!==t.application},t.prototype._isActivityWindow=function(t){return void 0!==t.instance},t}(),De=function(){function t(t,e,n){this._manager=t,this._ownerActivityId=e,this._state=n}return Object.defineProperty(t.prototype,"ownerId",{get:function(){return this._state.ownerId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowIds",{get:function(){return this._state.windowIds},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frameColor",{get:function(){return this._state.frameColor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this._state.context},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tag",{get:function(){return this._state.tag},enumerable:!0,configurable:!0}),t.prototype.detach=function(t){var e=this;t=t||{};var n={};return Object.keys(this._state).forEach((function(t){n[t]=e._state[t]})),n.context=t.context||n.context,n.frameColor=t.frameColor||n.frameColor,this._manager.detachActivities(this._ownerActivityId,n)},t}(),Fe=function(t){setTimeout(t,0)};function Be(t,e){if(!Ae(e))return t;t.then((function(t){Fe((function(){e(null,t)}))}),(function(t){Fe((function(){e(t,null)}))}))}var qe=function(t){function e(e,n,i,r,o){var s=t.call(this,e)||this;return s._id=e,s._actType=n,s._status=i,s._context=r,s._ownerId=o,s._agm=new We(s),s}return me(e,t),Object.defineProperty(e.prototype,"type",{get:function(){if(this._manager)return this._manager.getActivityType(this._actType)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return this._context},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"status",{get:function(){return this._status},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"owner",{get:function(){return this._ownerId?this._manager.getWindows({id:this._ownerId})[0]:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"windows",{get:function(){return this._manager.getWindows({activityId:this._id})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"agm",{get:function(){return this._agm},enumerable:!0,configurable:!0}),e.prototype.addWindow=function(t,e){return this._manager.addWindowToActivity(this,t,e)},e.prototype.createWindow=function(t,e){return this._manager.createWindow(this,t,e)},e.prototype.createStackedWindows=function(t,e,n){return this._manager.createStackedWindows(this,t,e,n)},e.prototype.leave=function(t,e){return this._manager.leaveWindowFromActivity(this,t,e)},e.prototype.getWindowsByType=function(t){var e={activityId:this._id,type:t};return this._manager.getWindows(e)},e.prototype.setContext=function(t,e){return this._manager.setActivityContext(this,t,e)},e.prototype.updateContext=function(t,e){return this._manager.updateActivityContext(this,t,e)},e.prototype.onStatusChange=function(t){var e=this;return this._manager.subscribeActivityEvents((function(n,i,r){n.id===e.id&&t(n,i,r)}))},e.prototype.onWindowEvent=function(t){var e=this;return this._manager.subscribeWindowEvents((function(n,i,r){n.id===e.id&&t(n,i,r)}))},e.prototype.onContextChanged=function(t){var e=this;this._manager.subscribeActivityContextChanged((function(n,i,r,o){n.id===e.id&&t(i,r,o,n)}));try{t(this.context,this.context,[],this)}catch(t){return}},e.prototype.stop=function(){this._manager.stopActivity(this)},e.prototype.clone=function(t){return this._manager.clone(this,t)},e.prototype.attach=function(t,e){var n;return n="string"==typeof t?t:t.id,this._manager.attachActivities(n,this.id,e)},e.prototype.onActivityAttached=function(t){var e=this;this._manager.subscribeActivitiesAttached((function(n,i,r){n===e._id&&t(r)}))},e.prototype.onDetached=function(t){var e=this;this._manager.subscribeActivitiesDetached((function(n,i,r){i.id===e._id&&t(n,r)}))},e.prototype._updateCore=function(e){var n=this;t.prototype._updateCore.call(this,e),Te(e._actType,(function(t){return n._actType=t})),Te(e._context,(function(t){return n._context=t})),Te(e._ownerId,(function(t){return n._ownerId=t})),!e._status||this._status&&this._status.state===e._status.state||(this._status=e._status)},e.prototype._updateDescriptors=function(t){var e=this;this._attached=t.map((function(t){return new De(e._manager,e._id,t)}))},Object.defineProperty(e.prototype,"attached",{get:function(){return this._attached},enumerable:!0,configurable:!0}),e.prototype.setFrameColor=function(t,e){var n=this;return Be(new Promise((function(e,i){var r=n.windows.length;0===r&&e(n),n.windows.forEach((function(i){i.underlyingWindow.setFrameColor(t,(function(){--r<=0&&e(n)}))})),setTimeout((function(){r>0&&i(n.id+" - timed out waiting for setFrameColor with"+t)}),5e3)})),e)},e.prototype.getFrameColor=function(){return this.windows&&0!==this.windows.length?this.windows[0].underlyingWindow.frameColor:""},e}(Ie),Ge=function(){function t(){}return t.Trace="trace",t.Debug="debug",t.Info="info",t.Warn="warn",t.Error="error",t}(),He=function(){function t(e){this._name=e,Ce(t.GlueLogger)||(this._glueLogger=t.GlueLogger.subLogger(e))}return t.GetNamed=function(e){return new t(e)},t.Get=function(e){return new t(t.GetTypeName(e))},t.prototype.trace=function(e){Ce(this._glueLogger)?t.Level===Ge.Trace&&console.info(this._getMessage(e,Ge.Trace)):this._glueLogger.trace(e)},t.prototype.debug=function(e){Ce(this._glueLogger)?t.Level!==Ge.Debug&&t.Level!==Ge.Trace||console.info(this._getMessage(e,Ge.Debug)):this._glueLogger.debug(e)},t.prototype.info=function(e){Ce(this._glueLogger)?t.Level!==Ge.Debug&&t.Level!==Ge.Trace&&t.Level!==Ge.Info||console.info(this._getMessage(e,Ge.Info)):this._glueLogger.info(e)},t.prototype.warn=function(e){Ce(this._glueLogger)?t.Level!==Ge.Debug&&t.Level!==Ge.Trace&&t.Level!==Ge.Info&&t.Level!==Ge.Warn||console.info(this._getMessage(e,Ge.Info)):this._glueLogger.warn(e)},t.prototype.error=function(t){Ce(this._glueLogger)?(console.error(this._getMessage(t,Ge.Error)),console.trace()):this._glueLogger.error(t)},t.prototype._getMessage=function(t,e){return"["+e+"] "+this._name+" - "+t},t.GetTypeName=function(t){var e=/function (.{1,})\(/.exec(t.constructor.toString());return e&&e.length>1?e[1]:""},t.Level=Ge.Info,t}(),Ue=function(t){function e(e,n,i,r,o,s,a,c){var u=t.call(this,e)||this;return u._logger=He.Get("window"),u._type=i,u._activityId=r,u._name=n,u._instance=o,u._isIndependent=s,u._windowGetter=a,u._hcWindowId=c,u}return me(e,t),e.prototype.getBounds=function(){return this._manager.getWindowBounds(this.id)},Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isIndependent",{get:function(){return this._isIndependent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"type",{get:function(){if(this._manager)return this._manager.getWindowType(this._type)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"activity",{get:function(){if(!ke(this._activityId))return this._manager.getActivityById(this._activityId)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isOwner",{get:function(){var t=this.activity;return!ke(t)&&t.owner.id===this.id},enumerable:!0,configurable:!0}),e.prototype.setVisible=function(t,e){return this._manager.setWindowVisibility(this.id,t)},e.prototype.activate=function(t){return this._manager.activateWindow(this.id,t)},e.prototype.setBounds=function(t,e){return this._manager.setWindowBounds(this.id,t,e)},e.prototype.close=function(){return this._manager.closeWindow(this.id)},Object.defineProperty(e.prototype,"instance",{get:function(){return this._instance},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"underlyingWindow",{get:function(){var t=this._windowGetter();return t||{id:this._hcWindowId}},enumerable:!0,configurable:!0}),e.prototype.onActivityJoined=function(t){this._subscribeForActivityWindowEvent(Le.ActivityWindowJoinedActivity,t)},e.prototype.onActivityRemoved=function(t){this._subscribeForActivityWindowEvent(Le.ActivityWindowLeftActivity,t)},e.prototype._updateCore=function(t){var e=this;Te(t._activityId,(function(t){return e._activityId=t})),Te(t._isIndependent,(function(t){return e._isIndependent=t})),Te(t._hcWindowId,(function(t){return e._hcWindowId=t})),Te(t._type,(function(t){return e._type=t})),Te(t._name,(function(t){return e._name=t})),Ce(t._instance)||(this._instance=t._instance)},e.prototype._subscribeForActivityWindowEvent=function(t,e){var n=this;this._manager.subscribeWindowEvents((function(i,r,o){r.id===n.id&&o===t&&e(i)}))},e.prototype._beforeDelete=function(t){this._hcWindowId=t._hcWindowId},e}(Ie),Ve=function(){function t(t,e,n){this.state=t,this.message=e,this.time=n}return t.prototype.getState=function(){return this.state},t.prototype.getMessage=function(){return this.message},t.prototype.getTime=function(){return this.time},t}(),Je="error",ze="add-types",Ke="created",Ye="destroyed",Ze="initiated",$e="joined",Xe="activity-joined",Qe="left",tn="owner-changed",en="add-peer-factories",nn="peer-factories-added",rn="peer-factories-removed",on="peer-created",sn=function(){function t(t,e,n,i){var r=this;if(this._activityChangeCallbacks=[],this._activityTypeStatusChangeCallbacks=[],this._activityWindowChangeCallbacks=[],this._windowTypeStatusChangeCallbacks=[],this._peerIdAndFactoryIdToPeerType={},this._peerFactoriesRegisteredByUs={},this._gw3Subscriptions=[],this._contextSubscriptions={},this._activityTypesInitiatedFromMe={},this._config=i,this._connection=t,this._logger=e,this._contexts=n,this._sessionJoinedPromise=new Promise((function(t){r._sessionJoinedPromiseResolve=t})),this._activityJoinedPromise=new Promise((function(t){r._activityJoinedPromiseResolve=t})),this._config.activityId||this._activityJoinedPromiseResolve({}),this._gw3Session=t.domain("activity",["joined","initiated","peer-created","token"]),"undefined"!=typeof window){var o=window.glue42gd;o&&"function"==typeof o.addRefreshHandler&&o.addRefreshHandler((function(t,e){r._gw3Session.send({type:"reload"}).then((function(n){if(n.token){try{o.setGWToken(n.token)}catch(t){return void e(t.message||t)}t()}else e("Expected gateway token for refreshing.")}),e)}))}}return t.activityTypeGwMessageEntityToActivityType=function(t,e){var n=function(t){return new Me(t,void 0)};return new Pe(t.name,t.owner_type&&n(t.owner_type),t.helper_types&&t.helper_types.map(n),e)},t.peerFactoryGwMessageEntityToWindowType=function(t){return new Me(t.peer_type,(function(t){}))},t.activityGwMessageToActivity=function(t,e){var n=void 0!==t.owner?t.owner.peer_id:t.owner_id;return new qe(t.activity_id,t.activity_type,e,t.context_snapshot,n)},t.activityToActivityStatusChangeEvent=function(t){return new je(t,new Ee(t.status,void 0))},Object.defineProperty(t.prototype,"bridgeType",{get:function(){return"GW3"},enumerable:!0,configurable:!0}),t.prototype.init=function(){var t=this;this.forwardActivityTypeMessagesToStatusEventHandlers(),this.subscribe(Ke,this.handleActivityCreatedMessage),this.subscribe(Ye,this.handleActivityDestroyedMessage),this.forwardActivityMessagesToStatusEventHandlers(),this.forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers(),this.forwardPeerFactoryMessagesToStatusEventHandlers(),this.forwardPeerFactoryMessagesToPeerFactoryRequests(),this.subscribe(nn,this.handlePeerFactoriesAdded),this.subscribe(rn,this.handlePeerFactoriesRemoved),this.forwardActivityWindowMessagesToEventHandlers(),this.subscribe("dispose-peer",(function(){if("dispose"!==t._config.disposeRequestHandling){if("exit"===t._config.disposeRequestHandling){if("undefined"!=typeof window&&"function"==typeof window.close)return void window.close();if("undefined"!=typeof process&&"function"==typeof process.exit)return void process.exit()}}else t.dispose()})),this._gw3Session.onJoined((function(){"trackMyOnly"===t._config.mode||"trackMyTypeAndInitiatedFromMe"===t._config.mode?t._sessionJoinedPromiseResolve(t):t._gw3Session.send({type:"subscribe",activity_types:"trackAll"===t._config.mode?[]:"trackTypes"===t._config.mode?t._config.typesToTrack:[]}).then((function(){t._sessionJoinedPromiseResolve(t)}))})),this._gw3Session.join()},t.prototype.dispose=function(){var t=this;this._gw3Subscriptions.forEach((function(e){return e&&t._connection.off(e)})),this._gw3Subscriptions.length=0},t.prototype.ready=function(){return Promise.all([this._sessionJoinedPromise,this._activityJoinedPromise])},t.prototype.initReady=function(){return this._sessionJoinedPromise},t.prototype.onActivityTypeStatusChange=function(t){this._activityTypeStatusChangeCallbacks.push(t)},t.prototype.registerActivityType=function(e,n,i,r,o){var s=this,a={};a.name=e;var c=function(t){return{type:t.type,name:t.name,configuration:t}};return a.owner_type=c(n),a.helper_types=i.map(c),this._gw3Session.send({type:ze,types:[a]}).then((function(){var e=t.activityTypeGwMessageEntityToActivityType(a,o);return s.invokeCallbacks(s._activityTypeStatusChangeCallbacks,new je(e,new Oe(Le.Added)),ze),e}))},t.prototype.unregisterActivityType=function(t){var e=this;return this._gw3Session.send({type:"remove-types",types:[t]}).then((function(){var n=new Pe(t,void 0,void 0,void 0);e.invokeCallbacks(e._activityTypeStatusChangeCallbacks,new je(n,new Oe(Le.Removed)),ze)}))},t.prototype.onWindowTypeStatusChange=function(t){this._windowTypeStatusChangeCallbacks.push(t)},t.prototype.registerWindowFactory=function(e,n,i){var r=this;if(this._peerFactoriesRegisteredByUs[e])return Promise.reject(new Error("Factory for windowType "+e+" already registered."));this._peerFactoriesRegisteredByUs[e]=n;var o={id:e,peer_type:e,configuration:i};return this._gw3Session.send({type:en,factories:[o]}).then((function(){r.invokeCallbacks(r._windowTypeStatusChangeCallbacks,new je(t.peerFactoryGwMessageEntityToWindowType(o),new Oe(Le.Added)),en)})).catch((function(){delete r._peerFactoriesRegisteredByUs[e]}))},t.prototype.unregisterWindowFactory=function(t){var e=this;return this._peerFactoriesRegisteredByUs[t]?(delete this._peerFactoriesRegisteredByUs[t],this._gw3Session.send({type:"remove-peer-factories",factory_ids:[t]}).then((function(){e.invokeCallbacks(e._windowTypeStatusChangeCallbacks,new je(new Me(t,void 0),new Oe(Le.Removed)),en)}))):Promise.reject(new Error("Factory for windowType "+t+" not registered."))},t.prototype.onActivityStatusChange=function(t){this._activityChangeCallbacks.push(t)},t.prototype.initiateActivity=function(t,e,n){var i=this,r={type:"create",activity_type:t,initial_context:e};return this.isOverrideTypeDefinition(n)?r.types_override={owner_type:{type:n.owner.type,name:n.owner.name,configuration:n.owner},helper_types:n.helpers&&n.helpers.map((function(t){return{type:t.type,name:t.name,configuration:t}}))}:r.configuration=n&&n.map((function(t){return{type:t.type,name:t.name,configuration:t}})),this.sendCreateAndMapResultingMessagesToPromise(r,Ze,(function(t,e){return t.request_id===e}),Ke,(function(t,e,n){return t.activity_id===n.activity_id}),Ye,(function(t,e,n){return t.activity_id===n.activity_id}),(function(t){return t.activity_id})).then((function(e){return"trackMyTypeAndInitiatedFromMe"!==i._config.mode||i._activityTypesInitiatedFromMe[t]?e:(i._activityTypesInitiatedFromMe[t]=!0,i._gw3Session.send({type:"subscribe",activity_types:[t]}).then((function(){return e})))}))},t.prototype.stopActivity=function(t){return this._gw3Session.send({type:"destroy",activity_id:t.id,reason_uri:"com.tick42.glue.activity.constants.destroyReason.general",reason:"Destroying activity"}).then((function(t){return!0}))},t.prototype.updateActivityContext=function(t,e,n,i){if(n)return this._contexts.set(t.id,e);for(var r=0,o=i=i||[];r<o.length;r++){e[o[r]]=null}return this._contexts.update(t.id,e)},t.prototype.announceWindow=function(t,e){throw new Error("Invalid operation 'announceWindow' for GW3 protocol")},t.prototype.registerWindow=function(t,e,n){var i=void 0!==this._connection.gatewayToken,r=this._connection.peerId;if("undefined"!=typeof window){var o=window.glue42gd;o&&(i=void 0!==o.activityInfo)}return i&&this._gw3Session.send({type:"ready"}),this.invokeCallbacks(this._activityWindowChangeCallbacks,new je(new Ue(r,e,t,void 0,this.getAgmInstance(r),n,this.generateWindowGetter(r),void 0),new Oe(Le.Added)),"register window"),Promise.resolve(r)},t.prototype.onActivityWindowChange=function(t){this._activityWindowChangeCallbacks.push(t)},t.prototype.createWindow=function(t,e){var n=this;return e.layout||(e.left||e.width||e.height||e.top)&&(e.layout={mode:"pixels",cellSize:1}),this.sendCreateAndMapResultingMessagesToPromise({type:"create-peer",peer_type:e.type,peer_name:e.name||e.type,configuration:e,activity_id:t},void 0,void 0,on,(function(t,e){return t.request_id===e}),void 0,void 0,(function(t){return t.created_id})).then((function(i){if(t)return n.joinActivity(t,i,e.name).then((function(){return i}))}))},t.prototype.closeWindow=function(t){return this._gw3Session.send({destroy_peer_id:t}).then((function(t){}))},t.prototype.getAnnouncementInfo=function(){var t=this._config.activityId||this._config.announcementInfo&&this._config.announcementInfo.activityId,e=this._config.announcementInfo&&this._config.announcementInfo.activityWindowType,n=this._config.announcementInfo&&this._config.announcementInfo.activityWindowIndependent,i=this._config.announcementInfo&&this._config.announcementInfo.activityWindowName;if("undefined"!=typeof window&&void 0!==window.location&&window.location.search&&"function"==typeof URLSearchParams){var r=new URLSearchParams(location.search.slice(1));e=(e=e||r.get("t42PeerType"))||r.get("t42ActivityWindowType"),void 0===n&&(n=r.get("t42ActivityWindowIndependent")),i=i||r.get("t42ActivityWindowName"),t=t||r.get("t42ActivityId")}return{activityWindowId:void 0,activityId:t,activityWindowType:e=e||"unknown",activityWindowIndependent:n=n||!1,activityWindowName:i=i||this._connection.peerId}},t.prototype.joinActivity=function(t,e,n){var i=this,r=n&&{name:n}||{};return this._gw3Session.send(we({type:"join-activity",target_id:e,activity_id:t},r)).then((function(){i.invokeCallbacks(i._activityWindowChangeCallbacks,new je(new Ue(e,void 0,void 0,t,i.getAgmInstance(e),void 0,i.generateWindowGetter(e),void 0),new Oe(Le.ActivityWindowJoinedActivity)),"activity joined - ActivityWindow"),i.invokeCallbacks(i._activityChangeCallbacks,new je(new qe(t,void 0,new Ve("created",void 0,void 0),void 0,void 0),new Oe(Le.Updated)),"activity joined - Activity")}))},t.prototype.leaveActivity=function(t,e){var n=this;return this._gw3Session.send({type:"leave-activity",target_id:e,activity_id:t}).then((function(){n.invokeCallbacks(n._activityWindowChangeCallbacks,new je(new Ue(e,void 0,void 0,null,n.getAgmInstance(e),void 0,n.generateWindowGetter(e),void 0),new Oe(Le.ActivityWindowLeftActivity)),"activity left - ActivityWindow"),n.invokeCallbacks(n._activityChangeCallbacks,new je(new qe(t,void 0,new Ve("created",void 0,void 0),void 0,void 0),new Oe(Le.Updated)),"activity left - Activity")}))},t.prototype.getActivityTypes=function(){return Promise.resolve([])},t.prototype.getWindowTypes=function(){return Promise.resolve([])},t.prototype.getActivities=function(){return Promise.resolve([])},t.prototype.getActivityWindows=function(){return Promise.resolve([])},t.prototype.createStackedWindows=function(t,e,n){},t.prototype.getWindowBounds=function(t){},t.prototype.setWindowBounds=function(t,e){},t.prototype.activateWindow=function(t,e){},t.prototype.setWindowVisibility=function(t,e){},t.prototype.cloneActivity=function(t,e){},t.prototype.attachActivities=function(t,e,n){return this._gw3Session.send({type:"merge",into:e,merge:t})},t.prototype.detachActivities=function(t,e){return this._gw3Session.send({type:"split",from:t}).then((function(){return""}))},t.prototype.onActivitiesAttached=function(t){},t.prototype.onActivitiesDetached=function(t){},t.prototype.onActivityAttachedDescriptorsRefreshed=function(t){},t.prototype.getAttachedDescriptors=function(){return Promise.resolve([])},t.prototype.getRandomRequestId=function(){return this._connection.peerId+":"+Math.floor(1e9*Math.random())},t.prototype.forwardAddedAndRemovedMessagesToEventHandler=function(t,e,n,i){var r=function(t){return function(e){return new je(e,new Oe(t?Le.Added:Le.Removed))}};return[t&&this.forwardMessageToEventHandler(t,(function(t){return n(t,!0)}),r(!0),i),e&&this.forwardMessageToEventHandler(e,(function(t){return n(t,!1)}),r(!1),i)].filter((function(t){return t}))},t.prototype.forwardMessageToEventHandler=function(t,e,n,i){return this.subscribe(t,(function(t){e(t).forEach((function(e){return i.forEach((function(i){return i(n(e,t))}))}))}))},t.prototype.sendCreateAndMapResultingMessagesToPromise=function(t,e,n,i,r,o,s,a){var c,u,d,p,h,f,l=this,v=this.getRandomRequestId(),g=new Promise((function(t,e){c=t,u=e})),y=null,m=function(){l.dropSubscription(d),l.dropSubscription(p),l.dropSubscription(h),l.dropSubscription(f)};d=e&&this.subscribe(e,(function(t){n(t,v)&&(y=t,l.dropSubscription(d))})),p=this.subscribe(i,(function(t){r(t,v,y)&&c(a(t))})),h=o&&this.subscribe(o,(function(t){s(t,v,y)&&u(t)})),f=o&&this.subscribe(Je,(function(t){t.request_id===v&&u(t)})),t.request_id=v;var w=this._gw3Session.send(t).then((function(){return g}));return w.then(m,m),w},t.prototype.peerFactoryIdAndOwnerIdToWindowType=function(t,e){var n=this._peerIdAndFactoryIdToPeerType[e+":"+t];return n?new Me(n,void 0):null},t.prototype.subscribe=function(t,e){var n=this,i=this._connection.on(t,(function(t){return e.bind(n)(t)}));return this._gw3Subscriptions.push(i),i},t.prototype.dropSubscription=function(t){t&&(this._connection.off(t),delete this._gw3Subscriptions[this._gw3Subscriptions.indexOf(t)])},t.prototype.invokeCallbacks=function(t,e,n){var i=this;t.forEach((function(t){try{t(e)}catch(t){i._logger.error("Error in "+(n||e.context.type)+" callback: "+JSON.stringify(t))}}))},t.prototype.handleActivityCreatedMessage=function(t){t.context_id?this._contextSubscriptions[t.activity_id]||this.subscribeToContext(t):this._logger.error("Activity created with unknown context_id: "+t.activity_id)},t.prototype.subscribeToContext=function(t){return be(this,void 0,void 0,(function(){var e,n,i,r=this;return _e(this,(function(o){switch(o.label){case 0:return e=t.activity_id,n=this._contextSubscriptions,i=e,[4,this._contexts.subscribe(e,(function(t,n,i){var o=new je(new qe(e,void 0,void 0,t,void 0),new Re(t,n,i));r.invokeCallbacks(r._activityChangeCallbacks,o,"context updated")}))];case 1:return n[i]=o.sent(),[2]}}))}))},t.prototype.handleActivityDestroyedMessage=function(t){var e=this._contextSubscriptions[t.activity_id];"function"==typeof e&&e(),delete this._contextSubscriptions[t.activity_id]},t.prototype.handlePeerFactoriesAdded=function(t){var e=this;t.factories.forEach((function(n){e._peerIdAndFactoryIdToPeerType[t.owner_id+":"+n.id]=n.peer_type}))},t.prototype.handlePeerFactoriesRemoved=function(t){var e=this;t.factory_ids.forEach((function(n){delete e._peerIdAndFactoryIdToPeerType[t.owner_id+":"+n]}))},t.prototype.forwardActivityTypeMessagesToStatusEventHandlers=function(){this.forwardAddedAndRemovedMessagesToEventHandler("types-added","types-removed",(function(e,n){return n?e.types.map((function(e){return t.activityTypeGwMessageEntityToActivityType(e,void 0)})):e.types.map((function(t){return new Pe(t.name,void 0,void 0,void 0)}))}),this._activityTypeStatusChangeCallbacks)},t.prototype.forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers=function(){for(var t=this,e=0,n=[Ke,$e,tn];e<n.length;e++){var i=n[e];this.forwardMessageToEventHandler(i,(function(e){return[e.owner||we(we({},e),{type:e.peer_type,name:e.peer_name,peer_id:e.owner_id})].concat(e.participants||[]).map((function(n){return new Ue(n.peer_id,n.name,n.type,e.activity_id,t.getAgmInstance(n.peer_id),void 0,t.generateWindowGetter(n.peer_id),void 0)}))}),(function(t,e){return new je(t,new Oe(Le.ActivityWindowJoinedActivity))}),this._activityWindowChangeCallbacks)}},t.prototype.forwardActivityMessagesToStatusEventHandlers=function(){for(var e=0,n=[Ke,$e];e<n.length;e++){var i=n[e];this.forwardMessageToEventHandler(i,(function(e){return[t.activityGwMessageToActivity(e,new Ve("started","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks)}this.forwardMessageToEventHandler(Ye,(function(e){return[t.activityGwMessageToActivity(e,new Ve("destroyed",e.reason,new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks),this.forwardMessageToEventHandler(Ze,(function(e){return[t.activityGwMessageToActivity(e,new Ve("created","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks),this.forwardMessageToEventHandler(tn,(function(e){return[t.activityGwMessageToActivity(e,new Ve("created","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks)},t.prototype.forwardPeerFactoryMessagesToStatusEventHandlers=function(){var e=this;this.forwardAddedAndRemovedMessagesToEventHandler(nn,rn,(function(n,i){return i?n.factories.map(t.peerFactoryGwMessageEntityToWindowType):n.factory_ids.map((function(t){return e.peerFactoryIdAndOwnerIdToWindowType(t,n.owner_id)})).filter((function(t){return null!=t}))}),this._windowTypeStatusChangeCallbacks)},t.prototype.forwardPeerFactoryMessagesToPeerFactoryRequests=function(){var t=this;this.subscribe("peer-requested",(function(e){var n=t._peerFactoriesRegisteredByUs[e.peer_factory];if(n)try{var i=e.configuration||{};i.gateway_token=i.gateway_token||e.gateway_token,i.peer_factory=i.peer_factory||e.peer_factory;var r=n({activityId:e.activity&&e.activity.id,activityType:e.activity&&e.activity.type,type:e.configuration&&e.configuration.type,gwToken:i.gateway_token,configuration:i});r&&r.then&&r.catch&&r.catch((function(n){return t._gw3Session.send({type:Je,request_id:e.request_id,reason:n&&(n.message||JSON.stringify(n))})}))}catch(n){t._gw3Session.send({type:Je,request_id:e.request_id,reason:n&&(n.message||JSON.stringify(n))})}else t._gw3Session.send({type:Je,request_id:e.request_id,reason:"Unknown peer factory "+e.peer_factory})}))},t.prototype.forwardActivityWindowMessagesToEventHandlers=function(){for(var t=this,e=function(e){n.subscribe(e,(function(n){var i=e===Xe?n.joined_id:n.peer_id,r=e===Xe?n.joined_type:n.peer_type,o=e===Xe?n.joined_name:n.peer_name,s=new Ue(i,o,r,n.activity_id,t.getAgmInstance(i),void 0,t.generateWindowGetter(i),void 0);t._contextSubscriptions[n.activity_id]?e===$e&&t._activityJoinedPromiseResolve({}):t.subscribeToContext(n).then((function(){e===$e&&t._activityJoinedPromiseResolve({})})),t.invokeCallbacks(t._activityWindowChangeCallbacks,new je(s,new Oe(Le.ActivityWindowJoinedActivity)),e)}))},n=this,i=0,r=[Xe,$e];i<r.length;i++){e(r[i])}this.subscribe(Qe,(function(e){var n=new Ue(e.left_id,void 0,void 0,null,t.getAgmInstance(e.left_id),void 0,t.generateWindowGetter(e.left_id),void 0);t.invokeCallbacks(t._activityWindowChangeCallbacks,new je(n,new Oe(Le.ActivityWindowLeftActivity)),Qe)})),this.forwardAddedAndRemovedMessagesToEventHandler(on,void 0,(function(e){return[new Ue(e.created_id,void 0,void 0,void 0,void 0,void 0,t.generateWindowGetter(e.created_id),void 0)]}),this._activityWindowChangeCallbacks)},t.prototype.getAgmInstance=function(t){return this._config.agm.servers().find((function(e){return e.peerId===t||e.windowId===t}))},t.prototype.generateWindowGetter=function(t){var e=this;return function(){var n=e.getAgmInstance(t);if(n){var i=n.windowId;return e._config.windows.list().filter((function(t){return t.id===i}))[0]}}},t.prototype.isOverrideTypeDefinition=function(t){return void 0!==t&&!!t.owner},t}(),an=function(){function t(t,e){var n=this;this._myAttached=[],this._myDetached=[],this._myAttachedTo=[],this._myDetachedFrom=[],this._myActivityFrameColorChanged=[],this._myActivityJoinedCallbacks=[],this._myActivityRemovedCallbacks=[],this._myContextUpdateCallbacks=[],this._logger=He.Get(this),this._m=t,t.ready().then((function(t){t.subscribeActivityContextChanged(n._subscribeMyContextChanged.bind(n)),t.subscribeWindowEvents(n._subscribeMyWindowEvent.bind(n)),t.subscribeActivitiesAttached(n._subscribeActivitiesAttached.bind(n)),t.subscribeActivitiesDetached(n._subscribeActivitiesDetached.bind(n)),e&&e.onWindowFrameColorChanged(n._subscribeWindowFrameColorChanged.bind(n))}))}return Object.defineProperty(t.prototype,"window",{get:function(){if(Ce(this._w)){var t=this._m.announcedWindows;t.length>0&&(this._w=t[0])}return this._w},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activity",{get:function(){var t=this.window;if(!Ce(t))return t.activity},enumerable:!0,configurable:!0}),t.prototype.createWindow=function(t){return this._m.createWindow(this.activity,t)},t.prototype.createStackedWindows=function(t,e){return this._m.createStackedWindows(this.activity,t,e)},Object.defineProperty(t.prototype,"context",{get:function(){var t=this.activity;return ke(t)?{}:t.context},enumerable:!0,configurable:!0}),t.prototype.updateContext=function(t,e){var n=this.activity;return ke(n)?new Promise((function(t,e){e("Not in activity")})):n.updateContext(t,e)},t.prototype.setContext=function(t,e){var n=this.activity;return ke(n)?new Promise((function(t,e){e("Not in activity")})):n.setContext(t,e)},t.prototype.onActivityJoined=function(t){this._myActivityJoinedCallbacks.push(t);var e=this.window;Ce(e)||Ce(e.activity)||t(e.activity)},t.prototype.onActivityLeft=function(t){this._myActivityRemovedCallbacks.push(t)},t.prototype.onContextChanged=function(t){this._myContextUpdateCallbacks.push(t);var e=this.window;if(!Ce(e)){var n=e.activity;Ce(n)||t(n.context,n.context,[],n)}},t.prototype.clone=function(t,e){var n=this.activity;return this._m.clone(n,t,e)},t.prototype.attach=function(t,e){var n;return n="string"==typeof t?t:t.id,this._m.attachActivities(n,this.activity.id,e)},t.prototype.onActivityAttached=function(t){this._myAttached.push(t)},t.prototype.onActivityDetached=function(t){this._myDetached.push(t)},t.prototype.onAttachedToActivity=function(t){this._myAttachedTo.push(t)},t.prototype.onDetachedFromActivity=function(t){this._myDetachedFrom.push(t)},Object.defineProperty(t.prototype,"attached",{get:function(){return this.activity?this.activity.attached:[]},enumerable:!0,configurable:!0}),t.prototype.setFrameColor=function(t,e){return this.activity?this.activity.setFrameColor(t,e):Promise.resolve(null)},t.prototype.getFrameColor=function(){return this.activity?this.activity.getFrameColor():""},t.prototype.onFrameColorChanged=function(t){this._myActivityFrameColorChanged.push(t)},t.prototype._subscribeMyContextChanged=function(t,e,n,i){var r=this.window;if(!Ce(r)){var o=r.activity;Ce(o)||t.id===o.id&&this._notifyMyContextChanged(t,e,n,i)}},t.prototype._subscribeMyWindowEvent=function(t,e,n){Ce(this.window)||this.window.id===e.id&&(n===Le.ActivityWindowJoinedActivity?(this._notifyMyWindowEvent(t,this._myActivityJoinedCallbacks),this._notifyMyContextChanged(t,t.context,null,null)):n===Le.ActivityWindowLeftActivity&&this._notifyMyWindowEvent(t,this._myActivityRemovedCallbacks))},t.prototype._notifyMyWindowEvent=function(t,e){var n=this;e.forEach((function(e){try{e(t,event)}catch(t){n._logger.warn("error in user callback "+t)}}))},t.prototype._notifyMyContextChanged=function(t,e,n,i){var r=this;n=n||{},i=i||[],this._myContextUpdateCallbacks.forEach((function(o){try{o(e,n,i,t)}catch(t){r._logger.warn("error in user callback "+t)}}))},t.prototype._notifyAttached=function(t){var e=this;this._myAttached.forEach((function(n){try{n(t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyDetached=function(t){var e=this;this._myDetached.forEach((function(n){try{n(t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyAttachedTo=function(t){var e=this;this._myAttachedTo.forEach((function(n){try{n(e.activity,t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyDetachedFrom=function(t,e,n){var i=this;this._myDetachedFrom.forEach((function(r){try{r(t,e,n)}catch(t){i._logger.warn("error in user callback "+t)}}))},t.prototype._subscribeActivitiesAttached=function(t,e){var n=this.window;if(!Ce(n)){var i=n.activity;Ce(i)||t.id===i.id&&(e.windowIds.indexOf(n.id)>=0?this._notifyAttachedTo(e):this._notifyAttached(e))}},t.prototype._subscribeActivitiesDetached=function(t,e,n){var i=this.window;if(!Ce(i)){var r=i.activity;Ce(r)||(e.id===r.id&&this._notifyDetached(n),t.id===r.id&&this._notifyDetachedFrom(t,e,n))}},t.prototype._subscribeWindowFrameColorChanged=function(t){var e=this.activity;e&&e.owner&&e.owner.underlyingWindow.id===t.id&&this._myActivityFrameColorChanged.forEach((function(e){e(t.frameColor)}))},t}(),cn=function(){function t(t,e){if(this._logger=He.Get("ReadyMarker ["+t+"]"),this._logger.debug("Initializing ready marker for '"+t+"' with "+e+" signals to wait"),e<=0)throw new Error("Invalid signal number. Should be > 0");this._signals=e,this._callbacks=[],this._name=t}return t.prototype.setCallback=function(t){this.isSet()?t(void 0):this.isError()?t(this._error):this._callbacks.push(t)},t.prototype.signal=function(t){if(this._logger.debug("Signaled - "+t+" - signals left "+(this._signals-1)),this._signals--,this._signals<0)throw new Error("Error in ready marker '"+this._name+" - signals are "+this._signals);this.isSet()&&this._callbacks.forEach((function(t){t(void 0)}))},t.prototype.error=function(t){this._error=t,this._callbacks.forEach((function(e){e(t)}))},t.prototype.isSet=function(){return!this.isError()&&0===this._signals},t.prototype.isError=function(){return!ke(this._error)},t.prototype.getError=function(){return this._error},t}(),un=function(){function t(t){this._items={},this._listeners=[],this._processNew=t}return t.prototype.addOne=function(t){this.add([t])},t.prototype.add=function(t){var e=this;t.forEach((function(t){e.process(new je(t,new Oe(Le.Added)))}))},t.prototype.process=function(t){var e=t.context,n=e.type,i=t.entity;if(n===Le.StatusChange&&!e.oldStatus){var r=this._items[i.id];r&&(e.oldStatus=r.status)}n===Le.StatusChange&&e.oldStatus&&e.newStatus&&e.oldStatus.state===e.newStatus.state&&(e.type=Le.Updated),"undefined"==typeof htmlContainer&&(n===Le.ActivityWindowJoinedActivity&&this._items[i.id]&&this._items[i.id].activity&&(e.type=Le.Updated),n===Le.ActivityWindowLeftActivity&&this._items[i.id]&&!this._items[i.id].activity&&(e.type=Le.Updated));var o=this._updateInternalCollections(i,n,e);return this._notifyListeners(o,e),o},t.prototype.get=function(){var t=[];for(var e in this._items)if(this._items.hasOwnProperty(e)){var n=this._items[e];t.push(n)}return t},t.prototype.getByName=function(t){for(var e in this._items)if(e===t)return this._items[e]},t.prototype.getOrWait=function(t){var e=this;return new Promise((function(n){var i=function(r){r.id===t&&(n(r),e.unsubscribe(i))};e.subscribe(i);var r=e.getByName(t);if(r)return e.unsubscribe(i),void n(r)}))},t.prototype.subscribe=function(t){var e=this;return this._listeners.push(t),Object.keys(this._items).forEach((function(n){var i=e._items[n];t(i,new Oe(Le.Added.toString()))})),function(){e.unsubscribe(t)}},t.prototype.unsubscribe=function(t){var e=this._listeners.indexOf(t);-1!==e&&this._listeners.splice(e,1)},t.prototype._notifyListeners=function(t,e){this._listeners.forEach((function(n){try{n(t,e)}catch(t){return}}))},t.prototype._updateInternalCollections=function(t,e,n){var i=t,r=e===Le.StatusChange&&i.status&&i.status.state===Ne.Destroyed||e===Le.StatusChange&&n&&n.newStatus&&n.newStatus.state===Ne.Destroyed,o=e===Le.Closed;if(e===Le.Removed&&void 0===i.isIndependent||o||r){var s=this._items[t.id];return delete this._items[t.id],this._processNew(t),s&&t._beforeDelete(s),t}var a=t.id;return this._items.hasOwnProperty(a)?this._items[t.id]._update(t):(this._processNew(t),this._items[t.id]=t),this._items[t.id]},t}(),dn=function(){function t(t,e,n){var i=this;this._logger=He.Get("activityManager"),this._announcedWindows=[],this._attachedCallbacks=[],this._detachedCallbacks=[],this._frameColorChangesCallbacks=[],this._windowHandlers=[],this._bridge=t,this._activityTypes=new un((function(t){return i._grabEntity(t)})),this._windowTypes=new un((function(t){return i._grabEntity(t)})),this._activities=new un((function(t){return i._grabEntity(t)})),this._windows=new un((function(t){return i._grabEntity(t)})),this._dataReadyMarker=new cn("Activity Manager Data",["GetActivityTypes","GetWindowTypes","GetActivities","GetWindows"].length),this._descriptorsMarker=new cn("Attached Activities Descriptors",["GetDescriptors"].length),e?(this._readyMarker=new cn("Activity Manager Announce",["Announcement"].length),this._dataReadyMarker.setCallback((function(t){t&&i._readyMarker.error(t),i._descriptorsMarker.setCallback((function(t){t&&i._readyMarker.error(t),i._logger.debug("Auto announcing window"),i.announceWindow().then((function(t){i._announcedWindows.push(t),i._readyMarker.signal("Successfully announced window with id '"+t.id+"'")})).catch((function(t){i._logger.debug("Will not announce window - "+t),i._readyMarker.signal()}))})),i.refreshDescriptors()}))):this._readyMarker=this._dataReadyMarker,this._bridge.onActivitiesAttached((function(t){i._handleActivitiesAttached(t)})),this._bridge.onActivitiesDetached((function(t){i._handleActivitiesDetached(t)})),this._bridge.onActivityAttachedDescriptorsRefreshed((function(t){i._handleActivityDescriptorsRefreshed(t)})),n&&n.onWindowFrameColorChanged(this._handleWindowFrameColorChanged.bind(this)),this._bridge.init(),this._subscribeForData(),this._bridge.initReady().then((function(t){i._getInitialData()})).catch((function(t){console.log(t)}))}return Object.defineProperty(t.prototype,"usingHc",{get:function(){return"HC"===this._bridge.bridgeType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"announcedWindows",{get:function(){return this._announcedWindows},set:function(t){throw new Error("not allowed")},enumerable:!0,configurable:!0}),t.prototype.ready=function(t){var e=this,n=new Promise((function(t,n){e._readyMarker.setCallback((function(i){i?n(e._readyMarker.getError()):t(e)}))}));return Be(Promise.all([this._bridge.ready(),n]).then((function(){return e})),t)},t.prototype.getActivityTypes=function(){return this._activityTypes.get()},t.prototype.getActivityType=function(t){return this._activityTypes.getByName(t)},t.prototype.registerActivityType=function(t,e,n,i,r,o){var s=this;return Be(new Promise((function(o,a){var c;if(Ce(t))a("activityTypeName argument can not be undefined");else if(Se(t))if(Ce(s.getActivityType(t)))if(ke(e))a("Owner window type can not be undefined");else{c=Se(e)?{type:e,name:"",isIndependent:!1,arguments:{}}:e;var u=[];if(!ke(n)&&xe(n))for(var d in n){var p=n[d];if(Se(p)){var h={type:p,name:"",isIndependent:!1,arguments:{},relativeTo:"",relativeDirection:"",windowStyleAttributes:{}};u.push(h)}else u.push(p)}s._bridge.registerActivityType(t,c,u,i,r).then((function(t){s._grabEntity(t),o(t)})).catch((function(t){a(t)}))}else a("Activity type '"+t+"' already exists");else a("activityTypeName should be string")})),o)},t.prototype.unregisterActivityType=function(t,e){var n=this;return Be(new Promise((function(e,i){var r=n.getActivityType(t);ke(r)?i("Activity type '"+t+"' does not exists"):n._bridge.unregisterActivityType(t).then((function(){return e(r)}),i)})),e)},t.prototype.initiate=function(t,e,n,i){var r=this;return Be(new Promise((function(n,o){ke(r.getActivityType(t))?o("Activity type '"+t+"' does not exists"):r._bridge.initiateActivity(t,e,i).then((function(t){r._activities.getOrWait(t).then((function(t){n(t)})).catch((function(t){return o(t)}))})).catch((function(t){o(t)}))})),n)},t.prototype.subscribeActivityTypeEvents=function(t){this._activityTypes.subscribe((function(e,n){t(e,n.type)}))},t.prototype.getWindowTypes=function(){return this._windowTypes.get()},t.prototype.getWindowType=function(t){return this._windowTypes.getByName(t)},t.prototype.registerWindowFactory=function(t,e,n){var i=this;return Be(new Promise((function(n,r){if(Ce(t))r("no windowType specified");else{if("object"==typeof(o=t)&&null!==o)t=t.getName();else if(!Se(t))return void r("windowType should be string or object that has getName method");var o;i._bridge.registerWindowFactory(t,e).then((function(t){n(t)})).catch((function(t){r(t)}))}})),n)},t.prototype.unregisterWindowFactory=function(t,e){var n=this;return Be(new Promise((function(e,i){Ce(t)?i("no windowType specified"):Se(t)?n._bridge.unregisterWindowFactory(t).then((function(t){e(t)})).catch((function(t){i(t)})):i("windowType should be a string")})),e)},t.prototype.getActivities=function(t){var e=this._activities.get();if(e=e.filter((function(t){return t._ownerId})),!t)return e;var n=t;if(Se(t))n=[t];else if(t instanceof Pe)n=[t.name];else if(!(t instanceof Array))throw new Error("Invalid input argument 'activityType' = "+t);return e.filter((function(t){var e=t.type;return function(t,e){for(var n=0;n<t.length;n++)if(e(t[n],n))return!0;return!1}(n,(function(t){return e.id===t.id}))}))},t.prototype.getActivityById=function(t){return this._activities.getByName(t)},t.prototype.announceWindow=function(t,e){var n=this;return new Promise((function(i,r){var o=n._bridge.getAnnouncementInfo();if(ke(t)&&(t=o.activityWindowId),ke(e)&&(e=o.activityWindowType),Ce(e))throw new Error("Can not announce - unknown windowType");var s=o&&o.activityId;if(Ce(t))n._logger.debug("Registering window with type:'"+e+"', name:'"+o.activityWindowName+"', ind.:'"+o.activityWindowIndependent+"'"),n._bridge.registerWindow(e,o.activityWindowName,o.activityWindowIndependent).then(n._windows.getOrWait.bind(n._windows)).then((function(t){return s?n._activities.getOrWait(s).then((function(e){return t})):t})).then((function(t){i(t)})).catch((function(t){n._logger.error(t)}));else{n._logger.debug("Announcing window with id '"+t+"' and type '"+e+"'");var a=n._windows.getByName(t);if(!Ce(a))return n._logger.debug("Window with id '"+t+"' already announced - reusing the window"),void i(a);var c=function(e,o,s){t===o.id&&(s===Le.ActivityWindowJoinedActivity&&(ke(o.activity)&&r("UNDEFINED ACTIVITY"),n._logger.trace("Got joined event for id '"+t+"'"),i(o),n.unsubscribeWindowEvents(c)))};n.subscribeWindowEvents(c),n._logger.trace("Waiting for joined event for id '"+t+"'"),n._bridge.announceWindow(e,t)}}))},t.prototype.subscribeWindowTypeEvents=function(t){this._windowTypes.subscribe((function(e,n){t(e,n.type)}))},t.prototype.subscribeActivityEvents=function(t){var e=this;return this._activities.subscribe((function(n,i){if(i.type===Le.StatusChange){var r=i;t(n,r.newStatus,r.oldStatus)}if(i.type===Le.Removed||i.type===Le.StatusChange&&i.newStatus.getState()===Ne.Destroyed)for(var o=0,s=e._windows.get();o<s.length;o++){var a=s[o];a.activity&&a.activity.id===n.id&&e._windows.process(new je(a,new Oe(Le.ActivityWindowLeftActivity)))}}))},t.prototype.subscribeWindowEvents=function(t){var e=function(e,n){var i=n.type;i===Le.Added&&(i="opened"),t(e.activity,e,i)};return this._windowHandlers.push([t,e]),this._windows.subscribe(e)},t.prototype.unsubscribeWindowEvents=function(t){var e=this._windowHandlers.find((function(e){return e[0]===t}));e&&(this._windowHandlers.splice(this._windowHandlers.indexOf(e),1),this._windows.unsubscribe(e[1]))},t.prototype.createWindow=function(t,e,n){var i=this;return Be(new Promise((function(n,r){var o,s;if(Ce(e)&&r("windowType is undefined"),!Ce((o=Se(e)?{type:e,name:"",isIndependent:!1,arguments:{}}:e instanceof Me?{type:e.type||e.id,name:e.name||e.type||e.id,isIndependent:!1}:e).relativeTo))if("string"==typeof(s=o.relativeTo))!Ce(a=i.getWindows({type:s}))&&a.length>0&&(o.relativeTo=a[0].id);else if(Ce(s.type))Ce(s.windowId)||(o.relativeTo=s.windowId);else{var a;!Ce(a=i.getWindows({type:s.type}))&&a.length>0&&(o.relativeTo=a[0].id)}i._bridge.createWindow(t&&t.id,o).then((function(e){i._logger.debug("Window created, waiting for window entity with id "+e);var r=function(o,s){o.id!==e||t&&!o.activity||(i._logger.debug("Got entity window with id "+e),n(o),i._windows.unsubscribe(r))};i._windows.subscribe(r)})).catch((function(t){r(t)}))})),n)},t.prototype.createStackedWindows=function(t,e,n,i){var r=this;return Be(new Promise((function(i,o){Ce(t)&&o("activity is undefined"),Ce(e)&&o("relativeWindowTypes is undefined"),Array.isArray(e)||o("relativeWindowTypes has to be array"),Ce(n)&&(n=2e4);var s=[];e.forEach((function(t){var e,n;if(!Ce((e=Se(t)?{type:t,name:"",isIndependent:!1,arguments:{}}:t).relativeTo))if(Ce((n=e.relativeTo).type)){if(!Ce(n.windowId)){var i=r.getWindows({id:n.windowId});!Ce(i)&&i.length>0&&(e.relativeTo=i[0].type.name,e.useExisting=!0)}}else e.relativeTo=n.type;s.push(e)})),r._bridge.createStackedWindows(t.id,s,n).then((function(t){var e=[],n=[],o=function(r,s){t.indexOf(r.id)>=0&&n.indexOf(r.id)<0&&r.activity&&(this._logger.debug("Got entity window with id "+t),e.push(r),n.push(r.id),e.length===t.length&&(i(e),this._windows.unsubscribe(o)))}.bind(r);r._windows.subscribe(o)})).catch((function(t){o(t)}))})),i)},t.prototype.addWindowToActivity=function(t,e,n){var i=this._bridge.joinActivity(t.id,e.id).then((function(){return e}));return Be(i,n),i},t.prototype.leaveWindowFromActivity=function(t,e,n){var i=this._bridge.leaveActivity(t.id,e.id).then((function(){return e}));return Be(i,n),i},t.prototype.setActivityContext=function(t,e,n){var i=this;return Be(new Promise((function(n,r){Ce(t)&&r("activity can not be null"),i._bridge.updateActivityContext(t,e,!0).then((function(e){n(t)})).catch((function(t){r(t)}))})),n)},t.prototype.updateActivityContext=function(t,e,n){var i=this;return Be(new Promise((function(n,r){Ce(t)&&r("activity can not be null");var o=[];for(var s in e)e.hasOwnProperty(s)&&null===e[s]&&o.push(s);for(var a=0,c=o;a<c.length;a++){var u=c[a];delete e[u]}i._bridge.updateActivityContext(t,e,!1,o).then((function(e){n(t)})).catch((function(t){r(t)}))})),n)},t.prototype.subscribeActivityContextChanged=function(t){this._activities.subscribe((function(e,n){if(n.type===Le.ActivityContextChange){var i=n;t(e,i.context,i.updated,i.removed)}}))},t.prototype.stopActivity=function(t,e){return Be(this._bridge.stopActivity(t),e)},t.prototype.getWindows=function(t){return ke(t)?this._windows.get():ke(t.id)?this._windows.get().filter((function(e){if(!ke(t.type)&&e.type.id!==t.type)return!1;if(!ke(t.name)&&e.name!==t.name)return!1;if(!ke(t.activityId)){if(Ce(e.activity))return!1;if(e.activity.id!==t.activityId)return!1}return!0})):[this._windows.getByName(t.id)]},t.prototype.getWindowBounds=function(t){return this._bridge.getWindowBounds(t)},t.prototype.setWindowBounds=function(t,e,n){var i=this;return Be(new Promise((function(n,r){i._bridge.setWindowBounds(t,e).then((function(){return n()})).catch((function(t){return r(t)}))})),n)},t.prototype.closeWindow=function(t){return this._bridge.closeWindow(t)},t.prototype.activateWindow=function(t,e){return this._bridge.activateWindow(t,e)},t.prototype.setWindowVisibility=function(t,e){return this._bridge.setWindowVisibility(t,e)},t.prototype.clone=function(t,e,n){var i=this;return Be(new Promise((function(n,r){t||r("activity can not be null"),i._bridge.cloneActivity(t.id,e).then((function(t){i._activities.getOrWait(t).then((function(t){n(t)})).catch((function(t){return r(t)}))})).catch((function(t){return r(t)}))})),n)},t.prototype.attachActivities=function(t,e,n,i){var r=this;return n=n||{},Be(new Promise((function(i,o){if(r._activities.getByName(t)){if(r._activities.getByName(e))return r._bridge.attachActivities(t,e,n).then((function(t){var e=t.to,n=t.descriptor,o=t.descriptors;r._activities.getOrWait(e).then((function(t){t._updateDescriptors(o);var e=t.attached.filter((function(t){return t.ownerId===n.ownerId}))[0];i(e)}))})).catch((function(t){o(t)}));o("can not find activity with id "+e)}else o("can not find activity with id "+t)})),i)},t.prototype.detachActivities=function(t,e,n){var i=this;return Be(new Promise((function(n,r){return i._bridge.detachActivities(t,e).then((function(){i._activities.getOrWait(undefined).then((function(t){t._updateDescriptors(undefined),i._activities.getOrWait(undefined).then((function(t){n(t)}))})).catch((function(t){return r(t)}))})).catch((function(t){r(t)}))})),n)},t.prototype.subscribeActivitiesAttached=function(t){this._attachedCallbacks.push(t)},t.prototype.subscribeActivitiesDetached=function(t){this._detachedCallbacks.push(t)},t.prototype.subscribeActivityFrameColorChanged=function(t){this._frameColorChangesCallbacks.push(t)},t.prototype._grabEntity=function(t){t._manager=this},t.prototype._getInitialData=function(){var t=this;this._logger.debug("Request initial data..."),this._bridge.getActivityTypes().then((function(e){t._activityTypes.add(e),t._dataReadyMarker.signal("Got act types")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity types -"+e)})),this._bridge.getWindowTypes().then((function(e){t._windowTypes.add(e),t._dataReadyMarker.signal("Got window types")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting window types  "+e)})),this._bridge.getActivities().then((function(e){t._activities.add(e),t._dataReadyMarker.signal("Got activities")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity instances -"+e)})),this._bridge.getActivityWindows().then((function(e){t._windows.add(e),t._dataReadyMarker.signal("Got windows")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity windows -"+e)}))},t.prototype._subscribeForData=function(){var t=this;this._logger.debug("Subscribe for data..."),this._bridge.onActivityTypeStatusChange((function(e){t._activityTypes.process(e)})),this._bridge.onWindowTypeStatusChange((function(e){t._windowTypes.process(e)})),this._bridge.onActivityWindowChange((function(e){t._windows.process(e)})),this._bridge.onActivityStatusChange((function(e){t._activities.process(e)}))},t.prototype._handleActivitiesAttached=function(t){var e=this,n=t.to,i=t.descriptor,r=t.descriptors;this._activities.getOrWait(n).then((function(t){t._updateDescriptors(r);var n=t.attached.filter((function(t){return t.ownerId===i.ownerId}))[0];e._attachedCallbacks.forEach((function(e){try{e(t,n)}catch(t){return}}))}))},t.prototype._handleActivitiesDetached=function(t){var e=this,n=t.oldActivityId,i=t.newActivityId,r=t.descriptors,o=t.descriptor;this._activities.getOrWait(n).then((function(t){t._updateDescriptors(r),e._activities.getOrWait(i).then((function(n){e._detachedCallbacks.forEach((function(e){try{e(n,t,o)}catch(t){return}}))}))}))},t.prototype._handleActivityDescriptorsRefreshed=function(t){var e=t.id,n=t.descriptors,i=this._activities.getByName(e);i&&i._updateDescriptors(n)},t.prototype.refreshDescriptors=function(){var t=this;this._bridge.getAttachedDescriptors().then((function(e){e&&Object.keys(e).forEach((function(n){var i=n,r=e[n],o=t._activities.getByName(i);o&&o._updateDescriptors(r)})),t._descriptorsMarker.signal("Successfully got descriptors")})).catch((function(e){t._descriptorsMarker.error("failed to get descriptors - "+e)}))},t.prototype._handleWindowFrameColorChanged=function(t){if(t.activityId){var e=this._activities.getByName(t.activityId);e&&e.owner&&e.owner.underlyingWindow.id===t.id&&this._frameColorChangesCallbacks.forEach((function(n){try{n(e,t.frameColor)}catch(t){return}}))}},t}(),pn=function(){function t(t,e){this._m=t,this._my=e,this.activityTypes={get:this._getActivityTypesWrapper.bind(this),register:this._m.registerActivityType.bind(this._m),unregister:this._m.unregisterActivityType.bind(this._m),subscribe:this._m.subscribeActivityTypeEvents.bind(this._m),unsubscribe:void 0,initiate:this._m.initiate.bind(this._m)},this.windowTypes={get:this._getWindowTypesWrapper.bind(this),registerFactory:this._m.registerWindowFactory.bind(this._m),unregisterFactory:this._m.unregisterWindowFactory.bind(this._m),subscribe:this._m.subscribeWindowTypeEvents.bind(this._m),unsubscribe:void 0},this.windows={get:this._m.getWindows.bind(this._m),subscribe:this._m.subscribeWindowEvents.bind(this._m),announce:this._m.announceWindow.bind(this._m),unsubscribe:void 0,create:this._m.createWindow.bind(this._m)},this.instances={get:this._m.getActivities.bind(this._m),subscribe:this._m.subscribeActivityEvents.bind(this._m),unsubscribe:void 0}}return t.prototype.onAttached=function(t){this._m.subscribeActivitiesAttached(t)},t.prototype.onDetached=function(t){this._m.subscribeActivitiesDetached(t)},t.prototype.onActivityFrameColorChanged=function(t){this._m.subscribeActivityFrameColorChanged(t)},t.prototype._getActivityTypesWrapper=function(t){return ke(t)?this._m.getActivityTypes():this._m.getActivityType(t)},t.prototype._getWindowTypesWrapper=function(t){return ke(t)?this._m.getWindowTypes():this._m.getWindowType(t)},t}(),hn=function(){function t(t,e){this._mgr=t,this._my=e,this.all=new pn(t,e)}return t.prototype.ready=function(t){var e=this;return Be(new Promise((function(t,n){e._mgr.ready().then((function(){t(e)})).catch((function(t){n(t)}))})),t)},Object.defineProperty(t.prototype,"my",{get:function(){return this._my},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"aware",{get:function(){return void 0!==this._my.window},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inActivity",{get:function(){return this.aware&&void 0!==this._my.activity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"agm",{get:function(){if(this.aware)return this.inActivity?this._my.activity.agm:new We(null)},enumerable:!0,configurable:!0}),t.prototype.getAvailableFrameColors=function(){return[]},t}(),fn=function(){function t(e){var n,i=this;if(!e)throw new Error("config can not be null");if(ke(e.logLevel)||(He.Level=e.logLevel),Ce(e.logger)||(He.GlueLogger=e.logger),this._isUsingHCImplementation=2===e.gdMajorVersion,this._isUsingGW3Implementation=t.checkIsUsingGW3Implementation(e.connection),this._isUsingHCImplementation)throw new Error("GD2 not supported");if(!this._isUsingGW3Implementation)throw new Error("Unable to instantiate activity bridge implementation");if(!(n=new sn(e.connection,e.logger,e.contexts,e)))throw new Error("A bridge to native activity is needed to create activity lib.");We.AGM=e.agm;var r=new dn(n,!e.disableAutoAnnounce,e.windows),o=new an(r,e.windows);this._api=new hn(r,o),this._readyPromise=r.ready().then((function(t){return i}))}return t.checkIsUsingGW3Implementation=function(t){return 3===t.protocolVersion},Object.defineProperty(t.prototype,"api",{get:function(){return this._api},set:function(t){this._api=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUsingHCImplementation",{get:function(){return this._isUsingHCImplementation},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUsingGW3Implementation",{get:function(){return this._isUsingGW3Implementation},enumerable:!0,configurable:!0}),t.prototype.ready=function(t){return Be(this._readyPromise,t)},t}(),ln="T42.ACS.GetFunctionalEntitlement",vn="T42.ACS.CanI",gn="T42.ACS.OnEvent";function yn(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function i(n,i){var r=n instanceof Error?n:new Error(n);if(e)e(r);else{var o='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+r.stack;if(t)switch(t.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(t,e){var i=n[t];return i||(i=[],n[t]=i),i.push(e),function(){var i=n[t];i&&(i=i.reduce((function(t,n,i){return n===e&&t.length===i||t.push(n),t}),[]),n[t]=i)}},execute:function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var o=n[t];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var r=n.apply(void 0,e);s.push(r)}catch(e){s.push(void 0),i(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}yn.default=yn;var mn=yn;function wn(t){return t?Object.keys(t).map((function(e){return t[e]})):[]}function bn(t){var e;try{e=JSON.parse(JSON.stringify(t||{}))}catch(t){e={}}return e}var _n=function(){function t(t,e,n){var i=this;this._appManager=t,this._name=e,this._agm=n,this._registry=mn(),t.onInstanceStarted((function(t){t.application&&t.application.name!==i._name||i._registry.execute("instanceStarted",t)})),t.onInstanceStopped((function(t){t.application&&t.application.name!==i._name||i._registry.execute("instanceStopped",t)})),t.onAppRemoved((function(t){t.name===i._name&&i._registry.execute("appRemoved",t)})),t.onAppChanged((function(t){t.name===i._name&&i._registry.execute("appChanged",t)})),t.onAppAvailable((function(t){t.name===i._name&&i._registry.execute("appAvailable",t)})),t.onAppUnavailable((function(t){t.name===i._name&&i._registry.execute("appUnavailable",t)}))}return Object.defineProperty(t.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._props.Title},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return this._props.Version},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"autoStart",{get:function(){return this._props.AutoStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isShell",{get:function(){return this._props.IsShell},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"caption",{get:function(){return this._props.Caption},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hidden",{get:function(){return this._props.IsHidden},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"container",{get:function(){return this._props.ApplicationName},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityType",{get:function(){return this._props.ActivityType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityWindowType",{get:function(){return this._props.ActivityWindowType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowSettings",{get:function(){return this._props.Arguments?bn(this._props.Arguments):{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"allowMultiple",{get:function(){return this._props.AllowMultiple},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"available",{get:function(){return this._props.IsReady||!1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"icon",{get:function(){return this._props.Icon},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"iconURL",{get:function(){return this._props.IconUrl},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sortOrder",{get:function(){return this._props.SortOrder},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"userProperties",{get:function(){return this._props.UserProperties?bn(this._props.UserProperties):{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivity",{get:function(){return void 0!==this._props.ActivityType&&""!==this._props.ActivityType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"configuration",{get:function(){return{autoStart:this._props.AutoStart,caption:this._props.Caption,hidden:this._props.IsHidden,container:this._props.ApplicationName,activityType:this._props.ActivityType,allowMultiple:this._props.AllowMultiple}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return e.application.name===t._name}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"type",{get:function(){return this._props.Type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mode",{get:function(){if(!this._props)return"unknown";if(this._props.Mode&&"string"==typeof this._props.Mode)return this._props.Mode.toLowerCase();if(this.isActivity)return"unknown";if(this._props.Arguments&&this._props.Arguments.mode&&"string"==typeof this._props.Arguments.mode)return this._props.Arguments.mode.toLowerCase();var t=this._props.WindowStyleAttributes;if(t){var e='mode:"',n=(t=t.split(" ").join("")).indexOf(e);if(-1!==n){var i=n+e.length,r=t.indexOf('"',i),o=t.substr(i,r-i);if(o&&"string"==typeof o)return o.toLowerCase()}}return"flat"},enumerable:!0,configurable:!0}),t.prototype.updateFromProps=function(t){var e=this;this._props||(this._props={Name:t.Name}),Object.keys(t).forEach((function(n){e._props[n]=t[n]}))},t.prototype.start=function(t,e){var n=this,i=this._name;return new Promise((function(r,o){e=e||{},t=t||{};n._agm.invoke("T42.ACS.StartApplication",{Name:i,Context:t,Options:e},"best",{methodResponseTimeoutMs:1e4},(function(t){var e=t.returned&&t.returned.Instance_0?t.returned.Instance_0:t.returned;if(e&&e.Id)if("startOnly"===n._appManager.mode){var i=n._appManager.handleInstanceStarted(e);r(i)}else!function(t){var e,i=function(){var e,i=n._appManager.instances().filter((function(e){return e.id===t}));return(e=2===i.length?i[0].isActivityInstance?i[0]:i[1]:i[0])?e.agm?e:void 0:e},s=setTimeout((function(){e&&e(),o("timeout")}),1e4);e=n._appManager.onInstanceAgmServerReady((function(n){n.id===t&&(e&&(e(),e=void 0),clearTimeout(s),setTimeout((function(){r(i())}),1))}));var a=i();a&&(e&&(e(),e=void 0),clearTimeout(s),r(a))}(e.Id);else r(void 0)}),(function(t){o(t)}))}))},t.prototype.onInstanceStarted=function(t){this._registry.add("instanceStarted",t)},t.prototype.onInstanceStopped=function(t){this._registry.add("instanceStopped",t)},t.prototype.onAvailable=function(t){this._registry.add("appAvailable",t)},t.prototype.onUnavailable=function(t){this._registry.add("appUnavailable",t)},t.prototype.onChanged=function(t){this._registry.add("appChanged",t)},t.prototype.onRemoved=function(t){this._registry.add("appRemoved",t)},t}(),In=function(){function t(t,e,n,i,r,o,s){var a=this;this._id=t,this._appName=e,this._appManager=n,this._agm=i,this._activities=r,this._windows=o,this.onAgmReady=this._addToRegistry("agmReady"),this.onStopped=this._addToRegistry("stopped"),this._registry=mn(),s||(this._unsubscribeInstanceStopped=this._appManager.onInstanceStopped((function(t){t.id===a._id&&a._registry.execute("stopped",t)})),this._unsubscribeInstanceAgmServerReady=this._appManager.onInstanceAgmServerReady((function(t){t.id===a._id&&a._registry.execute("agmReady",t)})))}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"application",{get:function(){return this._appManager.application(this._appName)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activity",{get:function(){var t=this;if(!this._activities)throw new Error("This method requires glue.activities library to be enabled.");return this._activities.all.instances.get().filter((function(e){return e.id===t._activityId}))[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityInstances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return e.context&&e.context.activityId===t._activityId}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityOwnerInstance",{get:function(){return this._appManager.instances().filter((function(t){if(t.window&&t.window.context){var e=t.window.context;if(e._t42&&e._t42.activityIsOwner)return!0}return!1}))[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"window",{get:function(){var t=this;if(!this._windows)throw new Error("This method requires glue.windows library to be enabled.");var e=this._windows.list().filter((function(e){return e.id===t._id}))[0];return!e&&this.activity&&this.activityOwnerInstance&&(e=this.activityOwnerInstance.window),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){var t,e,n;return null!=(n=null!=(t=this._startUpContext)?t:null===(e=this.window)||void 0===e?void 0:e.context)?n:{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._title},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivityInstance",{get:function(){return this._isActivityInstance},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityId",{get:function(){return this._activityId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inActivity",{get:function(){return this._inActivity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSingleWindowApp",{get:function(){return!this._inActivity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"agm",{get:function(){return this._agmInstance},enumerable:!0,configurable:!0}),t.prototype.updateFromProps=function(t){this._startUpContext=t.Context,this._title=t.Title,this._isActivityInstance=!1,t.ActivityId&&""!==t.ActivityId&&(this._activityId=t.ActivityId,this._isActivityInstance=!0),!this._activityId&&this._startUpContext&&this._startUpContext.activityId&&(this._activityId=this._startUpContext.activityId),this._inActivity=Boolean(this._activityId),this.updateAgmInstanceFromProps(t)},t.prototype.updateAgmInstanceFromProps=function(t){if(t.AgmServers)if(t.GD3){var e=t.AgmServers;e&&(this._agmInstance=e[0])}else{var n=t.AgmServers,i=Object.keys(n)[0];if(!i)return;var r=n[i];this._agmInstance={machine:r.machineName,user:r.userName,environment:r.environment,application:r.applicationName}}},t.prototype.stop=function(){var t=this;return new Promise((function(e,n){var i=t._appManager.onInstanceStopped((function(n){n.id===t._id&&(i(),e())}));t._agm.invoke("T42.ACS.StopApplication",{Name:t._appName,Id:t._id}).then((function(){"startOnly"===t._appManager.mode&&(t._appManager.handleInstanceStopped({Name:t._appName,Id:t.id,Context:void 0,Title:void 0,ActivityId:void 0,AgmServers:void 0}),e())})).catch((function(t){return n(t)}))}))},t.prototype.activate=function(){return this._agm.invoke("T42.ACS.ActivateApplication",{Name:this._appName,Id:this._id})},t.prototype.done=function(){this._registry.clear(),this._unsubscribeInstanceAgmServerReady(),this._unsubscribeInstanceStopped()},t.prototype._addToRegistry=function(t){var e=this;return function(n){e._registry.add(t,n)}},t}(),Sn=function(){function t(t,e,n,i,r,o){var s=this;this.mode=t,this._agm=e,this._activities=n,this._windows=i,this._logger=r,this._gdMajorVersion=o,this._apps={},this._instances=[],this._registry=mn(),this.application=function(t){return s._apps[t]},this.applications=function(){return Object.keys(s._apps).map((function(t){return s._apps[t]}))},this.instances=function(){return s._instances},this.getMyInstance=function(){if(s._gdMajorVersion>=3){var t=window.glue42gd.appInstanceId;return s._instances.filter((function(e){return e.id===t}))[0]}},this.handleAppAdded=function(t){var e=s._getAppId(t);s._logger.trace("adding app "+e),s._apps[e]=new _n(s,e,s._agm);var n=s._updateAppFromProps(t);s._registry.execute("appAdded",n)},this.handleAppUpdated=function(t){var e=s._updateAppFromProps(t);s._registry.execute("appChanged",e)},this.handleAppRemoved=function(t){var e=s._getAppId(t);s._logger.trace("removing app "+e);var n=s.application(e);s._instances=s._instances.filter((function(t){return t.application.name!==n.name})),delete s._apps[e],s._registry.execute("appRemoved",n)},this.handleAppReady=function(t){var e=s._getAppId(t),n=s._getAppOrThrow(e);n.updateFromProps(t),n.available?s._registry.execute("appAvailable",n):s._registry.execute("appUnavailable",n)},this.handleInstanceStarted=function(t){s._logger.trace("started app "+t.Name+" "+t.Id);var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=new In(e,n,s,s._agm,s._activities,s._windows);return s._updateInstanceFromProps(i,t),s._instances.push(i),s._registry.execute("instanceStarted",i),i},this.handleInstanceStopped=function(t){s._logger.trace("failed to start app "+t.Name+" "+t.Id);var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=s._getInstanceOrThrow(e,n);s._instances=s._instances.filter((function(t){return!s._matchInstance(t,e,n)})),s._registry.execute("instanceStopped",i),i.done()},this.handleInstanceAgmServerReady=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=s._getInstanceOrThrow(e,n);i.updateAgmInstanceFromProps(t),s._registry.execute("instanceAgmServerReady",i)},this.handleInstanceStartFailed=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=new In(e,n,void 0,void 0,void 0,void 0,!0);s._updateInstanceFromProps(i,t),s._registry.execute("instanceStartFailed",i)},this.handleInstanceUpdated=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=s._getInstanceOrThrow(e,n);s._updateInstanceFromProps(i,t)},this.onInstanceStarted=function(t){return s._replay(s._instances,t),s._registry.add("instanceStarted",t)},this.onInstanceStartFailed=function(t){return s._registry.add("instanceStartFailed",t)},this.onInstanceStopped=function(t){return s._registry.add("instanceStopped",t)},this.onInstanceUpdated=function(t){return s._registry.add("instanceChanged",t)},this.onInstanceAgmServerReady=function(t){return s._registry.add("instanceAgmServerReady",t)},this.onAppAdded=function(t){return s._replay(s._apps,t),s._registry.add("appAdded",t)},this.onAppRemoved=function(t){return s._registry.add("appRemoved",t)},this.onAppAvailable=function(t){return s._registry.add("appAvailable",t)},this.onAppUnavailable=function(t){return s._registry.add("appUnavailable",t)},this.onAppChanged=function(t){return s._registry.add("appChanged",t)}}return t.prototype._getAppOrThrow=function(t){var e=this.application(t);if(!e)throw Error("app with id "+t+" not found");return e},t.prototype._getAppId=function(t){return t.Name},t.prototype._matchInstance=function(t,e,n){return t.id===e&&t.application.name===n},t.prototype._getInstanceByIdAndName=function(t,e){var n=this;return this._instances.filter((function(i){return n._matchInstance(i,t,e)}))[0]},t.prototype._getInstanceOrThrow=function(t,e){var n=this._getInstanceByIdAndName(t,e);if(!n)throw Error("instance with id "+t+" not found");return n},t.prototype._getInstanceId=function(t){return t.Id},t.prototype._getInstanceAppName=function(t){return t.Name},t.prototype._updateAppFromProps=function(t){var e=this._getAppId(t);this._logger.trace("updating app with  + "+e+", "+t);var n=this._getAppOrThrow(e);return n.updateFromProps(t),n},t.prototype._updateInstanceFromProps=function(t,e){this._logger.trace("updating instance with "+this._getInstanceId(e)+" for app "+this._getInstanceAppName(e)),t.updateFromProps(e)},t.prototype._replay=function(t,e){t&&(Array.isArray(t)?t.forEach((function(t){return e(t)})):Object.keys(t).map((function(e){return t[e]})).forEach((function(t){return e(t)})))},t}();function xn(t,e,n){var i=function(t){return!!(t&&t.constructor&&t.call&&t.apply)};if(!i(e)&&!i(n))return t;i(e)?i(n)||(n=function(){}):e=function(){},t.then(e,n)}var kn=function(t){var e=this;this._agm=t,this._registry=mn(),this.handleBranchModified=function(t){e._registry.execute("branchChanged",t)},this.handleBranchesModified=function(t){e._registry.execute("branchesChanged",t)},this.getRegion=function(t,n){return xn(e._agmInvoke("T42.ACS.GetConfigurationRegion",(function(t){return t.returned.Region})),t,n)},this.getBranches=function(t,n){return xn(e._agmInvoke("T42.ACS.GetBranches",(function(t){var e=t.returned.Branches;return Object.keys(e).map((function(t){return e[t]}))})),t,n)},this.getCurrentBranch=function(t,n){return xn(e._agmInvoke("T42.ACS.GetCurrentBranch",(function(t){return t.returned.Branch}),void 0),t,n)},this.setRegion=function(t,n,i){return xn(e._agmInvoke("T42.ACS.SetConfigurationRegion",(function(t){return t.returned.ResultMessage}),{Region:t}),n,i)},this.setCurrentBranch=function(t,n,i){return xn(e._agmInvoke("T42.ACS.SetCurrentBranch",(function(t){return t.returned.ResultMessage}),{Branch:t}),n,i)},this.currentUser=function(t,n){return xn(e._agmInvoke("T42.ACS.GetUser"),t,n)},this.getFunctionalEntitlement=function(t,n,i){return xn(e._agmInvoke(ln,(function(t){return t.returned.Entitlement}),{Function:t}),n,i)},this.getFunctionalEntitlementBranch=function(t,n,i,r){return xn(e._agmInvoke(ln,(function(t){return t.returned.Entitlement}),{Function:t,Branch:n}),i,r)},this.canI=function(t,n,i){return xn(e._agmInvoke(vn,(function(t){return t.returned.Result}),{Function:t}),n,i)},this.canIBranch=function(t,n,i,r){return xn(e._agmInvoke(vn,(function(t){return t.returned.Result}),{Function:t,Branch:n}),i,r)},this.onBranchesChanged=function(t){e._registry.add("branchesChanged",t)},this.onBranchChanged=function(t){e._registry.add("branchChanged",t)},this.exit=function(t){return e._agmInvoke("T42.ACS.Shutdown",null,t)},this.restart=function(t){return e._agmInvoke("T42.ACS.Restart",null,t)},this._agmInvoke=function(t,n,i){return i=i||{},new Promise((function(r,o){e._agm.invoke(t,i).then((function(t){n||(n=function(t){return t.returned}),r(n(t))})).catch((function(t){return o(t)}))}))}};var Cn=function(t){if(!t)throw Error("config not set");if(!t.agm)throw Error("config.agm is missing");var e="startOnly",n="skipIcons",i=t.mode||e;if(i!==e&&i!==n&&"full"!==i)throw new Error("Invalid mode for appManager lib - "+i+" is not supported");var r,o=t.activities,s=t.agm,a=t.logger,c=t.windows,u=new Sn(i,s,o,c,a.subLogger("applications"),t.gdMajorVersion),d=new kn(s);if(i===e)r=function(t,e){return new Promise((function(n,i){t.invoke("T42.ACS.GetApplications",{skipIcon:!0}).then((function(t){var i=t.returned;i||n();var r=i.applications;r||n(),wn(r).map((function(t){return e.handleAppAdded(t)})),n()})).catch((function(t){return i("Error getting application snapshot: "+t.message)}))}))}(s,u);else{var p=function(t,e,n,i){var r;return{start:function(){var o,s,a=new Promise((function(t,e){o=t,s=e}));return t.subscribe(gn,{arguments:{skipIcon:i},waitTimeoutMs:1e4}).then((function(t){(r=t).onData((function(t){var i=t.data;wn(i.OnApplicationAdded).map((function(t){return e.handleAppAdded(t)})),wn(i.OnApplicationChanged).map((function(t){return e.handleAppUpdated(t)})),wn(i.OnApplicationRemoved).map((function(t){return e.handleAppRemoved(t)})),wn(i.OnApplicationReady).map((function(t){return e.handleAppReady(t)})),wn(i.OnApplicationStarted).map((function(t){return e.handleInstanceStarted(t)})),wn(i.OnApplicationStartFailed).map((function(t){return e.handleInstanceStartFailed(t)})),wn(i.OnApplicationStopped).map((function(t){return e.handleInstanceStopped(t)})),wn(i.OnApplicationUpdated).map((function(t){return e.handleInstanceUpdated(t)})),wn(i.OnApplicationAgmServerReady).map((function(t){return e.handleInstanceAgmServerReady(t)})),wn(i.OnBranchChanged).map((function(t){return n.handleBranchModified(t)})),wn(i.OnBranchesModified).map((function(t){return n.handleBranchesModified(t)})),o()})),r.onFailed((function(t){return s(t)}))})).catch((function(t){return s("Error subscribing for T42.ACS.OnEvent stream. Err: "+t)})),a},stop:function(){r&&r.close()}}}(s,u,d,i===n);r=p.start()}return{ready:function(){return r},applications:u.applications,application:u.application,onAppAdded:u.onAppAdded,onAppRemoved:u.onAppRemoved,onAppChanged:u.onAppChanged,onAppAvailable:u.onAppAvailable,onAppUnavailable:u.onAppUnavailable,instances:u.instances,get myInstance(){return u.getMyInstance()},onInstanceStarted:u.onInstanceStarted,onInstanceStopped:u.onInstanceStopped,onInstanceUpdated:u.onInstanceUpdated,onInstanceStartFailed:u.onInstanceStartFailed,getRegion:d.getRegion,getBranches:d.getBranches,getCurrentBranch:d.getCurrentBranch,getFunctionalEntitlement:d.getFunctionalEntitlement,getFunctionalEntitlementBranch:d.getFunctionalEntitlementBranch,setCurrentBranch:d.setCurrentBranch,setRegion:d.setRegion,currentUser:d.currentUser,canI:d.canI,canIBranch:d.canIBranch,onBranchesChanged:d.onBranchesChanged,exit:d.exit,restart:d.restart}},An=new(function(){function t(){this.waitForTimeoutInMilliseconds=6e4,this._windows={},this._pendingWindows={},this._pendingWindowsStates={},this._registry=mn()}return t.prototype.init=function(t){this._logger=t},t.prototype.get=function(t){return this._windows[t]||this._pendingWindows[t]},t.prototype.getIfReady=function(t){return this._windows[t]},Object.defineProperty(t.prototype,"list",{get:function(){return this._windows},enumerable:!0,configurable:!0}),t.prototype.add=function(t){if(!!this._pendingWindows[t.API.id])this._logger.error("trying to add window with id "+t.API.id+" from windowStore, which already exists");else{var e="remote"===t.API.windowType;this._pendingWindows[t.API.id]=t,this._pendingWindowsStates[t.API.id]={ready:!1,urlChanged:e},this._registry.execute("on-added",t)}},t.prototype.remove=function(t){delete this._windows[t.API.id],delete this._pendingWindows[t.API.id],delete this._pendingWindowsStates[t.API.id],this._registry.execute("on-removed",t)},t.prototype.setReadyState=function(t){var e=this._pendingWindowsStates[t];void 0!==e&&(e.ready=!0,e.urlChanged&&this.markReadyToShow(t))},t.prototype.setUrlChangedState=function(t){var e=this._pendingWindowsStates[t];void 0!==e&&(e.urlChanged=!0,e.ready&&this.markReadyToShow(t))},t.prototype.waitFor=function(t){var e=this;return new Promise((function(n,i){var r,o=setTimeout((function(){r(),i("waitFor timed out.")}),e.waitForTimeoutInMilliseconds),s=e._windows[t];s?(clearTimeout(o),n(s)):r=e.onReadyWindow((function(e){e.API.id===t&&(clearTimeout(o),r(),n(e))}))}))},t.prototype.onReadyWindow=function(t){return this._registry.add("on-ready",t)},t.prototype.onAdded=function(t){return this._registry.add("on-added",t)},t.prototype.onRemoved=function(t){return this._registry.add("on-removed",t)},t.prototype.markReadyToShow=function(t){this._pendingWindows[t]&&(this._windows[t]=this._pendingWindows[t],delete this._pendingWindows[t],delete this._pendingWindowsStates[t]),this._registry.execute("on-ready",this._windows[t])},t}()),Tn=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"==typeof window)return-1;if(!window.glueDesktop)return-1;if(!window.glueDesktop.version)return-1;var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?-1:t},t.callbackifyPromise=function(t,e,n){var i=function(t){var e=t;if(t instanceof Error&&(e=t.message),"function"!=typeof n)return Promise.reject(e);n(e)};try{return t().then((function(t){return"function"==typeof e&&e(t),t})).catch((function(t){return i(t)}))}catch(t){return i(t)}},t.getMonitor=function(t,e){var n=this;return e.map((function(e){var i=e.left,r=e.top,o=e.workingAreaWidth,s=e.workingAreaHeight;return{monitor:e,totalOverlap:n.calculateTotalOverlap({left:i,top:r,width:o,height:s},t)}})).sort((function(t,e){return e.totalOverlap-t.totalOverlap}))[0].monitor},t.getDisplayCenterOfScreen=function(t,e){var n=Math.floor(Math.max(e.left,e.left+(e.workingAreaWidth-t.width)/2));return{top:Math.floor(Math.max(e.top,e.top+(e.workingAreaHeight-t.height)/2)),left:n}},t.calculateTotalOverlap=function(t,e){var n=t.left,i=t.top,r=n+t.width,o=i+t.height,s=e.left,a=e.top,c=s+e.width,u=a+e.height;return Math.max(0,Math.min(r,c)-Math.max(n,s))*Math.max(0,Math.min(o,u)-Math.max(i,a))},t}(),Pn=function(t,e,n,i,r,o){var s,a,c=mn(),u=i.subLogger("window "+t),d=e.name,p=e.mode,h=e.url,f=e.title,l=e.context||{},v=e.bounds,g=e.frameColor,y=e.focus,m=e.neighbours||{},w=e.groupId,b=e.isGroupHeaderVisible,_=e.isTabHeaderVisible,I=e.isTabSelected,S=e.settings,x=e.isVisible,k=e.isCollapsed,C=e.state,A=e.tabGroupId,T=e.isLocked,P=[],M=e.zoomFactor;function j(t,e,i){return new Promise((function(r,o){var s,c,u=Y(t,v),d=!1,p=function(){d||(d=!0,"function"==typeof e&&e(a),r(a),c&&(c(),c=void 0),s&&(clearTimeout(s),s=void 0))};u||(c=U((function(e){e.id===a.id&&Y(t,e.bounds)&&p()}))),n.moveResize(a,t).then((function(){u?p():s=setTimeout((function(){p()}),1e3)})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))}function O(e,i,r){return new Promise((function(o,s){n.setVisible(a,e).then((function(){var n=void 0===e?!0===x:x===e;if(n)return"function"==typeof i&&i(a),o(a);var r=G((function(s){n=void 0===e?!0===s.isVisible:s.isVisible===e,s.id===t&&n&&("function"==typeof i&&i(a),r(),o(a))}))})).catch((function(t){"function"==typeof r&&r(t),s(t)}))}))}function E(t,e,i){return new Promise((function(r,o){n.updateContext(a,t).then((function(){"function"==typeof e&&e(a),r(a)})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))}function R(){return new Promise((function(t){var e=H((function(n){n.id===a.id&&(e(),t())}))}))}function L(t){return c.add("onUrlChanged",t)}function N(t){return k&&t(a),c.add("collapsed",t)}function W(t){return k||t(a),c.add("expanded",t)}function D(t){return"maximized"===C&&t(a),c.add("maximized",t)}function F(t){return"minimized"===C&&t(a),c.add("minimized",t)}function B(t){return"normal"===C&&t(a),c.add("normal",t)}function q(t){return c.add("detached",t)}function G(t){return c.add("visibility-changed",t)}function H(t){return c.add("lock-changed",t)}function U(t){return c.add("bounds-changed",t)}function V(t){return c.add("tab-header-visibility-changed",t)}function J(t){var e=m[t];if(void 0!==e)return e.reduce((function(t,e){var n=An.get(e);return n&&t.push(n.API),t}),[])}function z(){if(l._APPLICATION_NAME)return l._APPLICATION_NAME;if(l&&l._t42&&l._t42.application)return l._t42.application;var t=K();return t?t.applicationName:void 0}function K(){if(void 0!==window.glue42gd&&window.glue42gd.getWindowInfo){var e=window.glue42gd.getWindowInfo(t);return e||void 0}}function Y(t,e){var n=t.height,i=t.width;t.height<S.minHeight&&(n=S.minHeight),t.height>S.maxHeight&&(n=S.maxHeight),t.width<S.minWidth&&(i=S.minWidth),t.width>S.maxWidth&&(i=S.maxWidth);var r=!n||e.height===n,o=!i||e.width===i,s=!t.left||e.left===t.left,a=!t.top||e.top===t.top;return r&&o&&s&&a}var Z={handleWindowClose:function(){void 0!==a.id&&(a.id=void 0,c.execute("onClose",a))},handleWindowChangeState:function(t){"collapsed"===t?k=!0:"expanded"===t?k=!1:C=t,c.execute(t,a)},handleTitleChanged:function(t){f=t,c.execute("onTitleChanged",t,a)},handleVisibilityChanged:function(t){t!==x&&(x=t,c.execute("visibility-changed",a))},handleUrlChanged:function(t){h=t,c.execute("onUrlChanged",t,a)},handleWindowSettingsChanged:function(t){S=t,c.execute("settings-changed",a)},handleContextUpdated:function(t){l=t,c.execute("context-updated",l,a)},handleFrameIsLockedChanged:function(t){T=t,c.execute("lock-changed",a)},handleBoundsChanged:function(t){v.top===t.top&&v.left===t.left&&v.width===t.width&&v.height===t.height||(v.top=t.top,v.left=t.left,v.width=t.width,v.height=t.height,c.execute("bounds-changed",a))},handleFocusChanged:function(t){y=t,c.execute("focus-changed",a)},handleFrameButtonAdded:function(t){var e=["buttonId","imageBase64","order","tooltip"].reduce((function(e,n){return e[n]=t[n],e}),{});-1===P.map((function(t){return t.buttonId})).indexOf(t.buttonId)&&P.push(e),c.execute("onFrameButtonAdded",e,a)},handleFrameButtonRemoved:function(t){var e;P=P.reduce((function(n,i){return i.buttonId===t?e=i:n.push(i),n}),[]),void 0!==e&&c.execute("onFrameButtonRemoved",e,a)},handleFrameButtonClicked:function(t){var e=P.filter((function(e){return e.buttonId===t.buttonId}));e.length>0&&c.execute("onFrameButtonClicked",e[0],a)},handleFrameColorChanged:function(t){g=t,c.execute("frame-color-changed",a)},handleFrameAttached:function(t,e){A=t,_=e,c.execute("frame-attached",a)},handleFrameSelectionChanged:function(e,n){var i;void 0!==e&&e===t?(I=!0,i=a):(I=!1,i=An.get(e)?An.get(e).API:void 0);var r=An.get(n)?An.get(n).API:void 0;if(I&&r)var o=r.onTabSelectionChanged((function(t,e){(e&&e.id)===r.id&&(o(),c.execute("tab-selection-changed",i,r,a))}));else c.execute("tab-selection-changed",i,r,a)},handleCompositionChanged:function(t,e){m=t||{},w=e},handleGroupHeaderVisibilityChanged:function(t){b=t},handleTabHeaderVisibilityChanged:function(t){_!==t&&(_=t,c.execute("tab-header-visibility-changed",a))},handleGroupChanged:function(e,n){i.trace("handle group changed to win: "+t+" with group id: "+e.id),s=e,w=e.id,c.execute("group-changed",a,e,n)},handleGroupAssociation:function(e){e&&u.trace("setting group to win: "+t+" with group id: "+e.id),s=e},handleAttached:function(t,e){A=t,_=e,c.execute("attached",a)},handleDetached:function(e){A=e;var n=c.add("frame-attached",(function(e){e.id===t&&(n(),c.execute("detached",a))}))},handleWindowAttached:function(t){c.execute("window-attached",t)},handleWindowDetached:function(t){c.execute("window-detached",t)},handleZoomFactorChanged:function(t){M=t,c.execute("zoom-factor-changed",a)}};return{API:a={get name(){return d},get application(){var t=r();return t?t.application(z()):void 0},get hostInstance(){return n.hostInstance},get agmInstance(){var t=this;if(window.glue42gd)return o.servers().find((function(e){return e.windowId===t.id}));var e=z();return e?{application:e}:void 0},get url(){return h},id:t,get title(){return f},get windowStyleAttributes(){return S},get settings(){return S},get tabGroupId(){return"tab"===p.toLowerCase()?A:void 0},get frameButtons(){return P},get mode(){return p},get state(){return C},get isCollapsed(){return k},get isVisible(){return x},get isLocked(){return T},get context(){return l},get bounds(){return v},get minHeight(){return S.minHeight},get maxHeight(){return S.maxHeight},get minWidth(){return S.minWidth},get maxWidth(){return S.maxWidth},get isFocused(){return y},get frameColor(){return g},get opened(){return void 0!==a.id},get group(){return s},get groupId(){return w},get topNeighbours(){return J("top")},get leftNeighbours(){return J("left")},get rightNeighbours(){return J("right")},get bottomNeighbours(){return J("bottom")},get isGroupHeaderVisible(){return b},get activityId(){if(l._t42)return l._t42.activityId;var t=K();return t?t.activityId:void 0},get activityWindowId(){if(l._t42)return l._t42.activityWindowId;var t=K();return t?t.activityWindowId:void 0},get windowType(){return e.windowType||"electron"},get zoomFactor(){return M},get screen(){return Tn.getMonitor(a.bounds,window.glue42gd.monitors)},maximize:function(e,i){return new Promise((function(r,o){n.maximize(a).then((function(){if("maximized"===C)return"function"==typeof e&&e(a),r(a);var n=D((function(i){i.id===t&&"maximized"===i.state&&("function"==typeof e&&e(a),n(),r(a))}))})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},restore:function(e,i){return new Promise((function(r,o){n.restore(a).then((function(){if("normal"===C)return"function"==typeof e&&e(a),r(a);var n=B((function(i){t===i.id&&"normal"===i.state&&("function"==typeof e&&e(a),n(),r(a))}))})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},minimize:function(e,i){return new Promise((function(r,o){n.minimize(a).then((function(){if("minimized"===C)return"function"==typeof e&&e(a),r(a);var n=F((function(i){if(t===i.id&&"minimized"===i.state)return"function"==typeof e&&e(a),n(),r(a)}))})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},maximizeRestore:function(t,e){return new Promise((function(i,r){var o="normal"===C?D:B;n.maximizeRestore(a).then((function(){var e=o((function(){"function"==typeof t&&t(a),e&&e(),i(a)}))})).catch((function(t){"function"==typeof e&&e(t),r(t)}))}))},collapse:function(e,i){return new Promise((function(r,o){if(k)return"function"==typeof e&&e(a),r(a);n.collapse(a).then((function(){if(k)return"function"==typeof e&&e(a),r(a);var n=N((function(i){i.id===t&&("function"==typeof e&&e(a),n(),r(a))}))})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},expand:function(e,i){return new Promise((function(r,o){if(!k)return"function"==typeof e&&e(a),r(a);n.expand(a).then((function(){if(!k)return"function"==typeof e&&e(a),r(a);var n=W((function(i){i.id===t&&("function"==typeof e&&e(a),n(),r(a))}))})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},toggleCollapse:function(e,i){return new Promise((function(r,o){var s=k?W:N;n.toggleCollapse(a).then((function(){s((function(n){n.id===t&&("function"==typeof e&&e(a),r(a))}))})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},focus:function(t,e){return new Promise((function(i,r){n.focus(a).then((function(){"function"==typeof t&&t(a),i(a)})).catch((function(t){"function"==typeof e&&e(t),r(t)}))}))},activate:function(t,e){return new Promise((function(i,r){n.activate(a).then((function(){"function"==typeof t&&t(a),i(a)})).catch((function(t){"function"==typeof e&&e(t),r(t)}))}))},moveResize:j,setTitle:function(t,e,i){return new Promise((function(r,o){n.setTitle(a,t).then((function(){"function"==typeof e&&e(a),r(a)})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},setStyle:function(t,e,i){if(!t||0===Object.keys(t).length||Object.keys(t).every((function(t){return!t})))return i(r="Invalid style arguments: "+JSON.stringify(t)),Promise.reject(new Error(r));if(t&&void 0!==t.focus){var r;if("boolean"!=typeof t.focus)return i(r="Focus must be boolean. Currently only focus true is supported ! "+JSON.stringify(t)),Promise.reject(new Error(r));!1===t.focus&&console.warn("Focus false is not supported ! ")}return t&&void 0!==t.hidden&&"boolean"!=typeof t.hidden?(i(r="Hidden must be boolean ! provided: "+JSON.stringify(t)),Promise.reject(new Error(r))):Tn.callbackifyPromise((function(){return n.setStyle(a,t)}),e,i)},setOnTop:function(t,e,i){if(this.onTop===t){var r="OnTop setting is already set to '"+t+"'";return i(r),Promise.reject(new Error(r))}return Tn.callbackifyPromise((function(){return n.setOnTop(a,t)}),e,i)},resetButtons:function(t,e,i){return Tn.callbackifyPromise((function(){return n.resetButtons(a,t)}),e,i)},setSizeConstraints:function(t,e,i){if(!t||Object.keys(t).every((function(t){return void 0===t}))){var r="Invalid Constraints: "+JSON.stringify(t);return i(r),Promise.reject(new Error(r))}return Tn.callbackifyPromise((function(){return n.setSizeConstraints(a,t)}),e,i)},navigate:function(e,i,r){return new Promise((function(o,s){n.navigate(a,e).then((function(){if(e===h)return"function"==typeof i&&i(a),o(a);var n=L((function(e,r){r.id===t&&e===r.url&&("function"==typeof i&&i(a),n(),o(a))}))})).catch((function(t){"function"==typeof r&&r(t),s(t)}))}))},addFrameButton:function(t,e,i){return new Promise((function(r,o){return void 0===t?"function"==typeof i?void i("No button info"):void o("No button info"):void 0===t.buttonId?"function"==typeof i?void i("No buttonId"):void o("No buttonId"):void 0===t.imageBase64?"function"==typeof i?void i("No imageBase64"):void o("No imageBase64"):void n.addFrameButton(a,t).then((function(){"function"==typeof e&&e(a),r(a)})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},removeFrameButton:function(t,e,i){return new Promise((function(r,o){if(void 0===t||""===t)return"function"==typeof i?void i("No buttonId"):void o("No buttonId");n.removeFrameButton(a,t).then((function(){"function"==typeof e&&e(a),r(a)})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},setVisible:O,show:function(){return O(!0)},hide:function(){return O(!1)},center:function(t){return j(Tn.getDisplayCenterOfScreen(a.bounds,t||a.screen))},close:function(t,e){return new Promise((function(i,r){n.close(a).then((function(){"function"==typeof t&&t(a),i(a)})).catch((function(t){"function"==typeof e&&e(t),r(t)}))}))},snap:function(t,e,i,r){var o,s;if(!t)return Promise.reject("Please specify a target window! calledWith: "+t);if("string"==typeof t){var c=An.get(t);if(!c)return Promise.reject(new Error("Invalid target parameter or no such window. Invoked with:  "+t));o=c.API.group}else o=t.group;return Promise.all([(s=o,new Promise((function(t,e){var n=s.onWindowAdded((function(e,i){a.id===i.id&&(n(),t())}))}))),n.snap(a,t,e)]).then((function(){return"function"==typeof i&&i(a),a})).catch((function(t){return"function"==typeof r&&r(t),t}))},showLoader:function(t){return new Promise((function(e,i){n.showLoader(a,t).then((function(){e(a)})).catch((function(t){i(t)}))}))},hideLoader:function(){return new Promise((function(t,e){n.hideLoader(a).then((function(){t(a)})).catch((function(t){e(t)}))}))},updateContext:E,lock:function(t,e){return a.isLocked?("function"==typeof t&&t(a),Promise.resolve(a)):new Promise((function(i,r){n.lock(a).then((function(){return R()})).then((function(){"function"==typeof t&&t(a),i(a)})).catch((function(t){"function"==typeof e&&e(t),r(t)}))}))},unlock:function(t,e){return a.isLocked?new Promise((function(i,r){n.unlock(a).then((function(){return R()})).then((function(){"function"==typeof t&&t(a),i(a)})).catch((function(t){"function"==typeof e&&e(t),r(t)}))})):("function"==typeof t&&t(a),Promise.resolve(a))},getIcon:function(t,e){return new Promise((function(i,r){n.getIcon(a).then((function(e){"function"==typeof t&&t(e),i(e)})).catch((function(t){"function"==typeof e&&e(t),r(t)}))}))},setIcon:function(t,e,i){return new Promise((function(r,o){n.setIcon(a,t).then((function(){"function"==typeof e&&e(a),r(a)})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},setFrameColor:function(t,e,i){return new Promise((function(r,o){n.setFrameColor(a,t).then((function(){"function"==typeof e&&e(a),r(a)})).catch((function(t){"function"==typeof i&&i(t),o(t)}))}))},setTabTooltip:function(t){return be(this,void 0,void 0,(function(){return _e(this,(function(e){if(!t)throw new Error(t+" is null or undefined");return[2,n.setTabTooltip(a,t)]}))}))},attachTab:function(t,e,i,r){return new Promise((function(o,s){var c,u=a.id,d="Invalid tab parameter - should be an object with property id or a string. Invoked for source window id:"+a.id;if(t){if("string"==typeof t)c=t;else{if(void 0===t.id)return void s(d);c=t.id}var p={sourceWindowId:c,targetWindowId:u};e&&(p.index=e);var h=An.get(p.sourceWindowId).API,f=h.onAttached((function(t){t.id===h.id&&("function"==typeof i&&i(a),f(),o(a))}));n.attachTab(a,p).catch((function(t){"function"==typeof r&&r(t),f(),s(t)}))}else s(d)}))},detachTab:function(e,i,r){return new Promise((function(o,s){var u={windowId:a.id},d=e||{};void 0!==d.relativeTo&&("string"==typeof d.relativeTo?u.relativeTo=d.relativeTo:void 0!==d.relativeTo.id&&(u.relativeTo=d.relativeTo.id),void 0!==d.relativeDirection&&(u.relativeDirection=d.relativeDirection),void 0!==d.width&&(u.width=d.width),void 0!==d.height&&(u.height=d.height)),void 0!==d.bounds&&(u.bounds=d.bounds),void 0!==d.hideTabHeader&&(u.hideTabHeader=d.hideTabHeader);var p=!1,h=!1,f=c.add("frame-attached",(function(e){var n=void 0===d.hideTabHeader||d.hideTabHeader!==e.isTabHeaderVisible;t===e.id&&n&&(p=!0,f(),h&&("function"==typeof i&&i(a),o(a),"function"==typeof l&&l()))})),l=q((function(e){t===e.id&&(h=!0,l(),p&&("function"==typeof i&&i(a),o(a),"function"==typeof f&&f()))}));n.detachTab(a,u).catch((function(t){"function"==typeof r&&r(t),l(),f(),s(t)}))}))},setTabHeaderVisible:function(e,i,r){return new Promise((function(o,s){n.setTabHeaderVisible(a,e).then((function(){if(_===e)return"function"==typeof i&&i(a),o(a);var n=V((function(r){r.id===t&&r.isTabHeaderVisible===e&&("function"==typeof i&&i(a),n(),o(a))}))})).catch((function(t){"function"==typeof r&&r(t),s(t)}))}))},showPopup:function(t){return n.showPopup(a,t)},createFlydown:function(t){return n.createFlydown(a.id,t)},setModalState:function(t){return n.setModalState(a.id,t||!1)},setZoomFactor:function(t,e,i){return Tn.callbackifyPromise((function(){if(isNaN(t))throw new Error("zoomFactor is not a number");return n.setZoomFactor(a,t)}),e,i)},zoomIn:function(t,e){return Tn.callbackifyPromise((function(){return n.zoomIn(a)}),t,e)},zoomOut:function(t,e){return Tn.callbackifyPromise((function(){return n.zoomOut(a)}),t,e)},showDevTools:function(){return n.showDevTools(a)},capture:function(t){return n.capture(a,t)},flash:function(t){var e={shouldFlash:!0};return"boolean"==typeof t&&(e.shouldFlash=t),n.flash(a,e)},onClose:function(t){return c.add("onClose",t)},onUrlChanged:L,onTitleChanged:function(t){return t(a.title,a),c.add("onTitleChanged",t)},onFrameButtonAdded:function(t){return c.add("onFrameButtonAdded",t)},onFrameButtonRemoved:function(t){return c.add("onFrameButtonRemoved",t)},onFrameButtonClicked:function(t){return c.add("onFrameButtonClicked",t)},onCollapsed:N,onExpanded:W,onMinimized:F,onMaximized:D,onNormal:B,onAttached:function(t){return c.add("attached",t)},onDetached:q,onVisibilityChanged:G,onContextUpdated:function(t){return c.add("context-updated",t)},onLockingChanged:H,onBoundsChanged:U,onFrameColorChanged:function(t){return c.add("frame-color-changed",t)},onFocusChanged:function(t){return c.add("focus-changed",t)},onGroupChanged:function(t){return c.add("group-changed",t)},onWindowAttached:function(t){return c.add("window-attached",t)},onWindowDetached:function(t){return c.add("window-detached",t)},onTabSelectionChanged:function(t){return c.add("tab-selection-changed",t)},onTabHeaderVisibilityChanged:V,onClosing:function(e){if(!Ae(e))throw new Error("callback should be a function");return n.onClosing((function(t,n){var i=e();i&&i.then?i.then(t).catch(n):t()}),t)},onRefreshing:function(e){if(!Ae(e))throw new Error("callback should be a function");return n.onRefreshing((function(t,n,i){var r=e(i);r&&r.then?r.then(t).catch(n):t()}),t)},onZoomFactorChanged:function(t){if(!Ae(t))throw new Error("callback should be a function");return c.add("zoom-factor-changed",t)},get tabs(){return t=An.list,"tab"!==p.toLowerCase()?[]:Object.keys(t).reduce((function(e,n){var i=t[n];return i&&i.API.tabGroupId&&void 0!==i.API.tabGroupId&&void 0!==a.tabGroupId&&i.API.tabGroupId===a.tabGroupId&&e.push(i.API),e}),[]);var t},get isTabHeaderVisible(){return _},get isTabSelected(){return I},getURL:function(){return Promise.resolve(h)},getTitle:function(){return Promise.resolve(f)},getBounds:function(){return Promise.resolve(v)},getContext:function(){return Promise.resolve(l)},setContext:function(t){return E(t)},resizeTo:function(t,e){return j({width:t,height:e})},moveTo:function(t,e){return j({top:t,left:e})},getParentWindow:function(){var t;return be(this,void 0,void 0,(function(){var e;return _e(this,(function(n){return(e=S.parentInstanceId)?[2,null===(t=An.list[e])||void 0===t?void 0:t.API]:[2,void 0]}))}))},getChildWindows:function(){return be(this,void 0,void 0,(function(){return _e(this,(function(e){return[2,Object.keys(An.list).map((function(t){return An.list[t].API})).filter((function(e){return e.settings.parentInstanceId===t}))]}))}))}},Events:Z}},Mn=new(function(){function t(){this._registry=mn()}return Object.defineProperty(t.prototype,"hostInstance",{get:function(){return this.agmTarget},enumerable:!0,configurable:!0}),t.prototype.init=function(t,e){this.agm=t,this.agmTarget=e},t.prototype.close=function(t){var e=this;return new Promise((function(n,i){e.execute("close",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.navigate=function(t,e){var n=this;return new Promise((function(i,r){n.execute("navigate",{windowId:t.id,options:{url:e}}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.setStyle=function(t,e){var n;return be(this,void 0,void 0,(function(){var i,r,o,s,a,c,u,d,p,h,f,l,v;return _e(this,(function(g){switch(g.label){case 0:return i=[],r=function(t){return i.push(t)},void 0===e.focus||t.isFocused||r(t.focus()),void 0!==e.hidden&&(o=!e.hidden,r(t.setVisible(o))),void 0!==e.onTop&&r(t.setOnTop(e.onTop)),void 0===e.tabTooltip&&void 0===e.tabToolTip||(n=e.tabTooltip,s=null!=n?n:e.tabToolTip,r(t.setTabTooltip(s))),a=e.maxWidth,c=e.maxHeight,u=e.minWidth,d=e.minHeight,p=e.allowClose,h=e.allowCollapse,f=e.allowLockUnlock,l=e.allowMaximize,v=e.allowMinimize,r(t.setSizeConstraints({maxWidth:a,maxHeight:c,minWidth:u,minHeight:d})),r(t.resetButtons({allowClose:p,allowCollapse:h,allowLockUnlock:f,allowMaximize:l,allowMinimize:v})),[4,Promise.all(i)];case 1:return g.sent(),[2,t]}}))}))},t.prototype.setSizeConstraints=function(t,e){var n=this;return new Promise((function(i,r){n.execute("setSizeConstraints",{windowId:t.id,options:e}).then((function(){i(t)})).catch(r)}))},t.prototype.setTabTooltip=function(t,e){return be(this,void 0,void 0,(function(){return _e(this,(function(n){switch(n.label){case 0:return[4,this.execute("setTabTooltip",{windowId:t.id,options:{tabToolTip:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.resetButtons=function(t,e){var n=this;return new Promise((function(i,r){n.execute("resetButtons",{windowId:t.id,options:e}).then((function(){i(t)})).catch(r)}))},t.prototype.setOnTop=function(t,e){var n=this;return new Promise((function(i,r){n.execute("setOnTop",{windowId:t.id,options:{onTop:e}}).then((function(){i(t)})).catch(r)}))},t.prototype.setTitle=function(t,e){var n=this;return new Promise((function(i,r){var o={windowId:t.id,options:{title:e}};n.execute("setTitle",o).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.moveResize=function(t,e){var n=this;return new Promise((function(i,r){n.execute("moveResize",{windowId:t.id,options:{bounds:e}}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.addFrameButton=function(t,e){var n=this;return new Promise((function(i,r){n.execute("addButton",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.removeFrameButton=function(t,e){var n=this;return new Promise((function(i,r){n.execute("removeButton",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.activate=function(t){var e=this;return new Promise((function(n,i){e.execute("activate",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.focus=function(t){var e=this;return new Promise((function(n,i){e.execute("focus",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.maximizeRestore=function(t){var e=this;return new Promise((function(n,i){e.execute("maximizeRestore",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.maximize=function(t){var e=this;return new Promise((function(n,i){e.execute("maximize",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.restore=function(t){var e=this;return new Promise((function(n,i){e.execute("restore",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.minimize=function(t){var e=this;return new Promise((function(n,i){e.execute("minimize",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.collapse=function(t){var e=this;return new Promise((function(n,i){e.execute("collapse",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.expand=function(t){var e=this;return new Promise((function(n,i){e.execute("expand",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.toggleCollapse=function(t){var e=this;return new Promise((function(n,i){e.execute("toggleCollapse",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.snap=function(t,e,n){var i=this;return new Promise((function(r,o){t.id;var s,a="Invalid target parameter - should be an object with property id or a string. Invoked for source window id:"+t.id;if(e){if("string"==typeof e)s=e;else{if(void 0===e.id)return void o(a);s=e.id}var c={targetWindowId:s};n&&(c.snappingEdge=n),i.execute("snap",{windowId:t.id,options:c}).then((function(){r(t)})).catch((function(t){o(t)}))}else o(a)}))},t.prototype.attachTab=function(t,e){var n=this;return new Promise((function(i,r){n.execute("attachTab",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.detachTab=function(t,e){var n=this;return new Promise((function(i,r){n.execute("detachTab",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.setVisible=function(t,e){var n=this;return void 0===e&&(e=!0),new Promise((function(i,r){var o;o=e?"show":"hide",n.execute(o,{windowId:t.id}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.showLoader=function(t,e){var n=this;return new Promise((function(i,r){n.execute("showLoadingAnimation",{windowId:t.id,options:e}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.hideLoader=function(t){var e=this;return new Promise((function(n,i){e.execute("hideLoadingAnimation",{windowId:t.id}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.updateContext=function(t,e){var n=this;return new Promise((function(i,r){n.execute("updateContext",{windowId:t.id,context:e,replace:!(Object.keys(t.context).length>0)}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.lock=function(t){var e=this;return new Promise((function(n,i){e.execute("lockUnlock",{windowId:t.id,options:{lock:!0}}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.unlock=function(t){var e=this;return new Promise((function(n,i){e.execute("lockUnlock",{windowId:t.id,options:{lock:!1}}).then((function(){n(t)})).catch((function(t){i(t)}))}))},t.prototype.getIcon=function(t){var e=this;return new Promise((function(n,i){e.execute("getIcon",{windowId:t.id,options:{}}).then((function(t){n(t.icon)})).catch((function(t){i(t)}))}))},t.prototype.setIcon=function(t,e){var n=this;return new Promise((function(i,r){n.execute("setIcon",{windowId:t.id,options:{dataURL:e}}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.setFrameColor=function(t,e){var n=this;return new Promise((function(i,r){n.execute("setFrameColor",{windowId:t.id,options:{frameColor:e}}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.setTabHeaderVisible=function(t,e){var n=this;return new Promise((function(i,r){n.execute("setTabHeaderVisible",{windowId:t.id,options:{toShow:e}}).then((function(){i(t)})).catch((function(t){r(t)}))}))},t.prototype.showPopup=function(t,e){return be(this,void 0,void 0,(function(){var n,i;return _e(this,(function(r){switch(r.label){case 0:return e?((n=we({},e)).targetLocation||(n.targetLocation="bottom"),i=we(we({},n),{popupBounds:n.size,targetId:t.id,popupId:n.windowId}),[4,this.execute("showPopupWindow",{windowId:t.id,options:i})]):[2,Promise.reject("The options object is not valid!")];case 1:return r.sent(),[2,t]}}))}))},t.prototype.createFlydown=function(t,e){return be(this,void 0,void 0,(function(){var n,i,r=this;return _e(this,(function(o){return e?((n=we({},e)).horizontalOffset||(n.horizontalOffset=0),n.verticalOffset||(n.verticalOffset=0),i=this.reformatFlydownOptions(t,n),[2,this.execute("setFlydownArea",{windowId:t,options:i}).then((function(){var t=i.zones.map((function(t){return t.id}));return i.zones.forEach((function(t){var n="function"==typeof t.flydownSize?t.flydownSize:function(){return t.flydownSize};e.size instanceof Function&&t.flydownSize&&(n=function(n,i){return be(r,void 0,void 0,(function(){var r;return _e(this,(function(o){switch(o.label){case 0:return e.size instanceof Function?[4,e.size(n,i)]:[3,2];case 1:r=o.sent(),o.label=2;case 2:return t.flydownSize instanceof Function&&t.flydownSize!==e.size?[4,t.flydownSize(n,i)]:[3,4];case 3:return[2,o.sent()||r];case 4:return[2,r||t.flydownSize]}}))}))}),r._registry.clearKey(i.targetId+"_"+t.id),r._registry.add(i.targetId+"_"+t.id,n)})),{destroy:function(){return r.clearFlydownArea(i.targetId,t)},options:n}}))]):[2,Promise.reject("The options object is not valid!")]}))}))},t.prototype.setModalState=function(t,e){return be(this,void 0,void 0,(function(){return _e(this,(function(n){return[2,this.execute("setModalState",{windowId:t,options:{isModal:e}})]}))}))},t.prototype.handleFlydownBoundsRequested=function(t,e){return be(this,void 0,void 0,(function(){var n,i,r,o,s;return _e(this,(function(a){switch(a.label){case 0:return n=function(){return e.cancel=!0},i={zoneId:e.flydownId,flydownWindowBounds:e.flydownWindowBounds,flydownWindowId:e.flydownWindowId},[4,Promise.all(this._registry.execute(t+"_"+e.flydownId,i,n))];case 1:return 1===(r=a.sent()).length?(o={height:0,width:0,top:0,left:0},s="object"!=typeof r[0]||Array.isArray(r[0])?o:r[0],[2,we(we({},e),{flydownWindowBounds:s})]):[2]}}))}))},t.prototype.zoomIn=function(t){return be(this,void 0,void 0,(function(){return _e(this,(function(e){switch(e.label){case 0:return[4,this.execute("zoomIn",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.zoomOut=function(t){return be(this,void 0,void 0,(function(){return _e(this,(function(e){switch(e.label){case 0:return[4,this.execute("zoomOut",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.setZoomFactor=function(t,e){return be(this,void 0,void 0,(function(){return _e(this,(function(n){switch(n.label){case 0:return[4,this.execute("setZoomFactor",{windowId:t.id,options:{zoomFactor:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.showDevTools=function(t){return be(this,void 0,void 0,(function(){return _e(this,(function(e){switch(e.label){case 0:return[4,this.execute("showDevTools",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.capture=function(t,e){return be(this,void 0,void 0,(function(){return _e(this,(function(n){switch(n.label){case 0:return[4,this.execute("captureScreenshot",{windowId:t.id,options:we({},e)})];case 1:return[2,n.sent().data]}}))}))},t.prototype.captureGroup=function(t,e){return be(this,void 0,void 0,(function(){return _e(this,(function(n){switch(n.label){case 0:return[4,this.execute("captureGroupScreenshot",{windowId:t[0],options:we({groupWindowIds:t},e)})];case 1:return[2,n.sent().data]}}))}))},t.prototype.flash=function(t,e){return be(this,void 0,void 0,(function(){return _e(this,(function(n){switch(n.label){case 0:return[4,this.execute("flash",{windowId:t.id,options:we({},e)})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.execute=function(t,e){var n=this;return new Promise((function(i,r){var o=we(we({},e),{command:t});n.agm.invoke("T42.Wnd.Execute",o,n.agmTarget).then((function(t){t.returned&&t.returned.errorMsg?r(t):i(t.returned)})).catch((function(t){r(t)}))}))},t.prototype.setGroupHeaderVisible=function(t,e){return this.execute("setGroupHeaderVisibility",{windowId:t,options:{toShow:e}})},t.prototype.getGroupTitle=function(t){return this.execute("getGroupTitle",{windowId:t,options:{}}).then((function(t){return t.title}))},t.prototype.setGroupTitle=function(t,e){return this.execute("setGroupTitle",{windowId:t,options:{title:e}})},t.prototype.onClosing=function(t,e){var n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addCloseHandler(t,e)},t.prototype.onRefreshing=function(t,e){var n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addRefreshHandler(t,e)},t.prototype.reformatFlydownOptions=function(t,e){var n=function(t,n){if(e[n]&&(void 0===t[n]||null===t[n])){var i=e[n];t[n]=i}},i=e.zones.map((function(t){return n(t,"windowId"),n(t,"targetLocation"),!e.size||void 0!==t.flydownSize&&null!==t.flydownSize||(t.flydownSize=e.size),t.flydownBounds=t.flydownSize,t.flydownId=t.windowId,t.targetLocation||(t.targetLocation="bottom"),t}));return we(we({},e),{zones:i,targetId:t,flydownBounds:e.size,flydownActiveArea:e.activeArea})},t.prototype.clearFlydownArea=function(t,e){var n=this;return this.execute("clearFlydownWindowArea",{windowId:t,options:{}}).then((function(){e.forEach((function(e){n._registry.clearKey(t+"_"+e)}))}))},t}());function jn(t,e){var n=An.list;return Object.keys(n).reduce((function(i,r){var o=n[r];return o.API.tabGroupId===e&&o.API.id!==t&&(i[r]=o),i}),{})}var On=function(){function t(t,e,n,i,r){this._registry=mn(),this._waitTimeout=1e4,this._agm=t,this._logger=e.subLogger("gd-env"),this._agmInstance=this.normalizeInstance(i),this._windowId=r,this._appManagerGetter=n}return t.prototype.init=function(){var t=this;return new Promise((function(e,n){void 0===t._agmInstance&&(t._agmInstance="best"),t._agm.registerAsync("T42.Wnd.OnEventWithResponse",(function(e,n,i,r){t.respondToEvent(e).then(i).catch(r)}));new Promise((function(i,r){t._agm.subscribe("T42.Wnd.OnEvent",{waitTimeoutMs:t._waitTimeout,target:t._agmInstance,onData:function(n){t.updateWindow(n.data,e)},onConnected:function(e){t._agmInstance=t.normalizeInstance(e),Mn.init(t._agm,t._agmInstance)}}).catch((function(t){n("Can not subscribe for stream T42.Wnd.OnEvent. Err: "+t)}))}))}))},Object.defineProperty(t.prototype,"executor",{get:function(){return Mn},enumerable:!0,configurable:!0}),t.prototype.open=function(t,e,n,i,r){var o=we({},n=n||{});void 0!==t?(void 0!==o.relativeTo&&"string"!=typeof o.relativeTo&&(o.relativeTo=o.relativeTo.id||""),o.name=t,o.url=e,o.windowState=n.windowState||n.state,delete o.state,this._agm.invoke("T42.Wnd.Create",o,this._agmInstance).then((function(t){if(void 0!==t.returned){var e=t.returned.id;i(e)}else r({message:"failed to execute T42.Wnd.Create - unknown reason"})})).catch(r)):r({message:"The name is undefined"})},t.prototype.createFlydown=function(t,e){return this.executor.createFlydown(t,e)},t.prototype.showPopup=function(t,e){return be(this,void 0,void 0,(function(){var n;return _e(this,(function(i){switch(i.label){case 0:return n=An.get(t),[4,this.executor.showPopup(n.API,e)];case 1:return i.sent(),[2]}}))}))},t.prototype.tabAttached=function(t){return this._registry.add("tab-attached",t)},t.prototype.tabDetached=function(t){return this._registry.add("tab-detached",t)},t.prototype.onWindowFrameColorChanged=function(t){return this._registry.add("frame-color-changed",t)},t.prototype.onEvent=function(t){return this._registry.add("window-event",t)},t.prototype.my=function(){return this._windowId},t.prototype.execute=function(t,e,n){return this._agm.invoke("T42.Wnd.Execute",{command:t,options:n,windowId:e})},t.prototype.setGroupHeaderVisible=function(t,e){return this._agm.invoke("T42.Wnd.SetGroupHeaderVisible",{windowId:t,toShow:e},this._agmInstance)},t.prototype.onCompositionChanged=function(t){return this._registry.add("composition-changed",t)},t.prototype.onGroupHeaderVisibilityChanged=function(t){return this._registry.add("group-header-changed",t)},t.prototype.onWindowGotFocus=function(t){return this._registry.add("got-focus",t)},t.prototype.onWindowLostFocus=function(t){return this._registry.add("lost-focus",t)},t.prototype.normalizeInstance=function(t){if(t)return{application:t.application,machine:t.machine,user:t.user}},t.prototype.respondToEvent=function(t){return"ShowFlydownBoundsRequested"===t.type?this.executor.handleFlydownBoundsRequested(t.data.windowId,t.data):Promise.reject("There isn't a handler for "+t.type)},t.prototype.updateWindow=function(t,e){var n=this,i=this.getExtendedStreamEvent(t);if("Snapshot"===t.type)return t.windows.forEach((function(t){var e=n.createWindow(t.id,t);An.markReadyToShow(e.API.id),n._registry.execute("window-event",i)})),void e(this);if("Created"===t.type){var r=t,o=this.createWindow(r.windowId,r.data||{});return An.setReadyState(o.API.id),void this._registry.execute("window-event",i)}var s=An.get(t.windowId);if(s){var a=s.API,c=s.Events;if("BoundsChanged"===t.type){var u=t;c.handleBoundsChanged(u.data)}if("UrlChanged"===t.type){var d=t;An.setUrlChangedState(d.windowId),c.handleUrlChanged(d.data)}if("TitleChanged"===t.type){var p=t;c.handleTitleChanged(p.data)}if("VisibilityChanged"===t.type&&c.handleVisibilityChanged(t.data),"ContextChanged"===t.type&&c.handleContextUpdated(t.data),"StateChanged"===t.type&&c.handleWindowChangeState(t.data),"FrameColorChanged"===t.type&&(c.handleFrameColorChanged(t.data),this._registry.execute("frame-color-changed",a)),"CompositionChanged"===t.type){var h=t;c.handleCompositionChanged(h.data.neighbors,h.data.groupId),this._registry.execute("composition-changed",h.data)}if("GroupHeaderVisibilityChanged"===t.type){var f=t;c.handleGroupHeaderVisibilityChanged(f.data.groupHeaderVisible),this._registry.execute("group-header-changed",f.data)}if("FocusChanged"===t.type){var l=t;this.focusChanged(c,a,l.data)}if("WindowFrameChanged"===t.type&&(c.handleFrameAttached(t.data.frameId,t.data.isTabHeaderVisible),this._registry.execute("frame-changed")),"WindowFrameAdded"===t.type){c.handleAttached(t.data.frameId,t.data.isTabHeaderVisible);var v=jn(a.id,t.data.frameId);Object.keys(v).forEach((function(t){v[t].Events.handleWindowAttached(a)})),this._registry.execute("tab-attached",a,t.data.frameId,t.data.isTabHeaderVisible)}if("WindowFrameRemoved"===t.type){var g=a.tabGroupId;c.handleDetached(t.data.frameId);var y=jn(a.id,g);Object.keys(y).forEach((function(t){y[t].Events.handleWindowDetached(a)}));var m=this._registry.add("frame-changed",(function(){m(),n._registry.execute("tab-detached",a,t.data.frameId,a.tabGroupId)}))}"TabHeaderVisibilityChanged"===t.type&&c.handleTabHeaderVisibilityChanged(t.data.isTabHeaderVisible),"FrameSelectionChanged"===t.type&&c.handleFrameSelectionChanged(t.data.newWindowId,t.data.prevWindowId),"ButtonClicked"===t.type&&c.handleFrameButtonClicked(t.data),"ButtonAdded"===t.type&&c.handleFrameButtonAdded(t.data),"ButtonRemoved"===t.type&&c.handleFrameButtonRemoved(t.data),"WindowZoomFactorChanged"===t.type&&c.handleZoomFactorChanged(t.data),"Closed"===t.type&&(An.remove(s),c.handleWindowClose()),"FrameIsLockedChanged"===t.type&&c.handleFrameIsLockedChanged(t.data),this._registry.execute("window-event",i)}else this._logger.error("received update for unknown window. Stream:', "+JSON.stringify(t,null,4))},t.prototype.createWindow=function(t,e){var n=Pn(t,this.mapToWindowConstructorOptions(e),Mn,this._logger,this._appManagerGetter,this._agm);return An.add(n),n},t.prototype.focusChanged=function(t,e,n){t.handleFocusChanged(n),n?this._registry.execute("got-focus",e):this._registry.execute("lost-focus",e)},t.prototype.mapToWindowConstructorOptions=function(t){return{name:t.name,context:t.context,bounds:t.bounds,url:t.url,title:t.title,isVisible:t.isVisible,focus:t.isFocused,state:t.state,frameColor:t.frameColor,groupId:t.groupId,neighbours:t.neighbors,isFocused:t.isFocused,isGroupHeaderVisible:t.groupHeaderVisible,isCollapsed:t.isCollapsed,tabGroupId:t.frameId,mode:t.mode,isTabHeaderVisible:t.isTabHeaderVisible,isTabSelected:t.isActiveTab,settings:t.settings,windowType:t.windowType,zoomFactor:t.zoomFactor,isLocked:t.isLocked}},t.prototype.getExtendedStreamEvent=function(t){try{var e=we({state:t.type,windowName:An.get(t.windowId).API.name},t);return"WindowFrameAdded"===e.state&&(e.state="TabAttached"),"StateChanged"===e.state&&(e.state=e.data.charAt(0).toUpperCase()+e.data.slice(1)),"ButtonAdded"===e.state&&(e.state="FrameButtonAdded"),"ButtonRemoved"===e.state&&(e.state="FrameButtonRemoved"),e}catch(e){return t}},t}(),En=function(t,e){var n=mn(),i=[];function r(){return new Promise((function(t,e){var n=c((function(e){n(),t()}))}))}function o(t,n,i,r){return new Promise((function(r,o){e.execute(t,n).then((function(t){"function"==typeof i&&i(u),r(u)})).catch((function(t){o(t)}))}))}function s(){var t=[];return i.forEach((function(e){var n=a(e);void 0!==n&&t.push(n)})),t}function a(t){return An.get(t)?An.get(t).API:void 0}function c(t){return n.add("header-visibility-changed",t)}var u={id:t,get windows(){return e=s(),"function"==typeof t&&t(e),e;var t,e},find:function(t,e){var n;n="string"==typeof t?t:t.id;var r=i.indexOf(n);if(-1!==r){var o=a(i[r]);return"function"==typeof e&&e(o),o}},get isHeaderVisible(){return void 0===s().find((function(t){return!t.isGroupHeaderVisible}))},showHeader:function(t,n){return new Promise((function(n,o){Promise.all([e.setGroupHeaderVisible(i[0],!0),r()]).then((function(){"function"==typeof t&&t(u),n(u)})).catch((function(t){o(t)}))}))},hideHeader:function(t,n){return new Promise((function(n,o){Promise.all([e.setGroupHeaderVisible(i[0],!1),r()]).then((function(){"function"==typeof t&&t(u),n(u)})).catch((function(t){}))}))},getTitle:function(){return e.getGroupTitle(i[0])},setTitle:function(t){return e.setGroupTitle(i[0],t)},capture:function(t){return e.captureGroup(i,t)},maximize:function(e,n){return o("maximize",{groupId:t},e)},restore:function(e,n){return o("restore",{groupId:t},e)},onHeaderVisibilityChanged:c,onWindowAdded:function(t){return n.add("window-added",t)},onWindowRemoved:function(t){return n.add("window-removed",t)}};return{groupAPI:u,groupInternal:{addWindow:function(t){if(-1===i.indexOf(t)){i.push(t);var e=An.get(t);e.Events.handleGroupAssociation(u),n.execute("window-added",u,e.API)}},removeWindow:function(t){var e=i.indexOf(t);if(-1!==e){i.splice(e,1);var r=a(t);n.execute("window-removed",u,r)}},handleGroupHeaderVisibilityChanged:function(t){n.execute("header-visibility-changed",u)}}}},Rn=function(t,e){var n=e.subLogger("groups"),i=mn(),r={},o=-1,s=An.list;function a(t,n){var i,o;if(void 0!==t)return i="string"==typeof t?t:t.id,Object.keys(r).forEach((function(t){var e=r[t].groupAPI;void 0===e.find(i)||(o=e)})),"function"==typeof n&&n(o),o;e.debug("trying to find a group by a window, but winId is undefined")}function c(t){n.trace("Adding new window "+t.API.id+" to win.API.groupId "+t.API.groupId);var e=u(t);e&&(n.trace("handleGroupAssociation "+t.API.id+" to group.groupAPI.id "+e.groupAPI.id),t.Events.handleGroupAssociation(e.groupAPI))}function u(e,i){var o=i||e.API.groupId,s=e.API.id;if(void 0!==o&&void 0!==s){var a=function(e){if(r.hasOwnProperty(e))return r[e];var n=En(e,t.executor);return r[e]=n,n}(o);return a.groupInternal.addWindow(s),a}n.debug("trying to add a window without group - winId: "+s)}function d(t,e){var n=t.API.id,i=e||t.API.groupId;void 0!==i&&(r[i].groupInternal.removeWindow(n),t.Events.handleGroupAssociation(void 0),function(t){r.hasOwnProperty(t)&&void 0!==r[t]&&0===r[t].groupAPI.windows.length&&delete r[t]}(i))}return Object.keys(s).forEach((function(t){c(s[t])})),t.onCompositionChanged((function(t){!function(t){var e=t.groupId,r=t.windowId,o=a(r),s=o?o.id:void 0;if(n.trace("handleCompositionChanged newGroupId: "+e+" windowId: "+r+" oldGroup: "+s),s===e)return void n.trace("handleCompositionChanged newGroupId: "+e+" windowId: "+r+" oldGroup: "+s+" are the same - returning...");var c=An.get(r)||An.get(r),p=u(c,e);o&&(d(c,s),i.execute("window-moved",r,o,e));c.Events.handleGroupChanged(p.groupAPI,o)}(t)})),t.onGroupHeaderVisibilityChanged((function(t){var e=a(t.windowId);if(void 0!==e){var n=r[e.id];-1===o&&(o=e.windows.length),0===--o&&(o=-1,n.groupInternal.handleGroupHeaderVisibilityChanged(t))}})),An.onAdded((function(t){c(t)})),An.onRemoved((function(t){d(t)})),{groupsAPI:{get my(){return a(t.my())},list:function(t){var e=Object.keys(r).map((function(t){if(r[t])return r[t].groupAPI}));return"function"==typeof t&&t(e),e},findGroupByWindow:a},groupsEvents:{onWindowMoved:function(t){return i.add("window-moved",t)}}}},Ln=function(t,e,n,i){var r,o,s=mn(),a=e;An.init(a);var c=new Promise((function(e,s){(function(t,e,n,i){var r=e;return new Promise((function(e,o){if(2===i)throw r.trace("running in HC"),new Error("GD2 not supported");if(i>=3)r.trace("running in GD 3"),new On(t,r,n,void 0,window.glue42gd.windowId).init().then(e).catch(o);else{var s=new On(t,r,n).init();Promise.race([s,(a=1e4,new Promise((function(t,e){return setTimeout((function(){e("timeout waiting for streams")}),a)})))]).then(e).catch(o)}var a}))})(t,a,n,i).then((function(t){o=t,r=Rn(t,a),e()})).catch((function(t){var e="Environment detector fails with: "+t;a.error(e),s(e)}))}));function u(t){return s.add("window-added",t)}function d(t){return s.add("window-removed",t)}return An.onReadyWindow((function(t){s.execute("window-added",t.API)})),An.onRemoved((function(t){s.execute("window-removed",t.API)})),{my:function(){var t=An.getIfReady(o.my());return t?t.API:void 0},open:function(t,e,n,i,r){return new Promise((function(s,a){var c=function(t){"function"==typeof r&&r(t),a(t)};o.open(t,e,n,(function(t){An.waitFor(t).then((function(t){"function"==typeof i&&i(t.API),s(t.API),"electron"===t.API.windowType&&t.Events.handleUrlChanged(t.API.url)})).catch(c)}),c)}))},find:function(t,e,n){var i=An.list,r=Object.keys(i).reduce((function(e,n){var r=i[n];return r&&r.API.name===t&&e.push(r.API),e}),[]);if("function"!=typeof e)return r[0];r.length>0?e(r[0]):"function"==typeof n&&n("There is no window with name:"+t)},findById:function(t,e,n){var i=An.list,r=Object.keys(i).reduce((function(e,n){var r=i[n];return void 0!==r&&r.API.id===t&&e.push(r.API),e}),[]);if("function"!=typeof e)return r[0];r.length>0?e(r[0]):"function"==typeof n&&n("There is no window with such id:"+t)},list:function(t){var e=An.list,n=Object.keys(e).map((function(t){return e[t].API}));if("function"!=typeof t)return n;t(n)},ready:function(){return c},onWindowAdded:u,windowAdded:u,onWindowRemoved:d,windowRemoved:d,onTabAttached:function(t){return c.then((function(){o.tabAttached(t)}))},onTabDetached:function(t){return c.then((function(){o.tabDetached(t)}))},onWindowFrameColorChanged:function(t){return c.then((function(){return o.onWindowFrameColorChanged(t)}))},get groups(){return r.groupsAPI},onWindowGotFocus:function(t){var e;return c.then((function(){e=o.onWindowGotFocus(t)})),function(){e&&e()}},onWindowLostFocus:function(t){var e;return c.then((function(){e=o.onWindowLostFocus(t)})),function(){e&&e()}},onEvent:function(t){var e,n=!1;return c.then((function(){n||(e=o.onEvent(t))})),function(){n=!0,e&&e()}},createFlydown:function(t,e){return o.createFlydown(t,e)},showPopup:function(t,e){return o.showPopup(t,e)}}},Nn=new(function(){function t(){this.layouts=[]}return t.prototype.removeWhere=function(t){this.layouts=this.layouts.filter(t)},t.prototype.add=function(t){this.layouts.push(t)},Object.defineProperty(t.prototype,"all",{get:function(){return this.layouts},enumerable:!0,configurable:!0}),t.prototype.where=function(t){return this.layouts.filter(t)},t.prototype.first=function(t){return this.where(t)[0]},t}());var Wn=1;var Dn,Fn,Bn,qn={nextValue:function(){return(Wn=(9301*Wn+49297)%233280)/233280},seed:function(t){Wn=t}},Gn="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function Hn(){Bn=!1}function Un(t){if(t){if(t!==Dn){if(t.length!==Gn.length)throw new Error("Custom alphabet for shortid must be "+Gn.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+Gn.length+" unique characters. These characters were not unique: "+e.join(", "));Dn=t,Hn()}}else Dn!==Gn&&(Dn=Gn,Hn())}function Vn(){return Bn||(Bn=function(){Dn||Un(Gn);for(var t,e=Dn.split(""),n=[],i=qn.nextValue();e.length>0;)i=qn.nextValue(),t=Math.floor(i*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var Jn={characters:function(t){return Un(t),Dn},seed:function(t){qn.seed(t),Fn!==t&&(Hn(),Fn=t)},lookup:function(t){return Vn()[t]},shuffled:Vn},zn="object"==typeof window&&(window.crypto||window.msCrypto);var Kn=function(){if(!zn||!zn.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return zn.getRandomValues(t),48&t[0]};var Yn=function(t,e){for(var n,i=0,r="";!n;)r+=t(e>>4*i&15|Kn()),n=e<Math.pow(16,i+1),i++;return r};var Zn,$n,Xn=function(t){var e=Jn.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var Qn=function(t){var e="",n=Math.floor(.001*(Date.now()-1459707606518));return n===$n?Zn++:(Zn=0,$n=n),e+=Yn(Jn.lookup,6),e+=Yn(Jn.lookup,t),Zn>0&&(e+=Yn(Jn.lookup,Zn)),e+=Yn(Jn.lookup,n)};var ti=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=Jn.characters(),n=t.length,i=0;i<n;i++)if(-1===e.indexOf(t[i]))return!1;return!0},ei=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e=0;function n(){return Qn(e)}t.exports=n,t.exports.generate=n,t.exports.seed=function(e){return Jn.seed(e),t.exports},t.exports.worker=function(n){return e=n,t.exports},t.exports.characters=function(t){return void 0!==t&&Jn.characters(t),Jn.shuffled()},t.exports.decode=Xn,t.exports.isValid=ti})),ni=(ei.generate,ei.seed,ei.worker,ei.characters,ei.decode,ei.isValid,ei),ii=function(){function t(t,e,n){this.agm=t,this.activitiesGetter=e,this.callbacks=n,this.registeredRequestsMethods=!1}return t.prototype.onSaveRequested=function(t){return this.registeredRequestsMethods||(this.registerRequestMethods(),this.registeredRequestsMethods=!0),this.callbacks.add("saveRequested",t)},t.prototype.isActivityOwner=function(){if("undefined"!=typeof htmlContainer){var t=htmlContainer.getContext();return t&&t._t42&&t._t42.activityIsOwner}var e=this.activitiesGetter();if(!e)return!1;if(!e.inActivity)return!1;var n=e.my.window,i=e.my.activity;return!(!i&&!n)&&i.owner.id===n.id},t.prototype.registerRequestMethods=function(){var t=this;this.agm.register("T42.HC.GetSaveContext",(function(e){var n=t.callbacks.execute("saveRequested",e)[0];if(!n)return{};n.activityContext=n.activityContext||{},n.windowContext=n.windowContext||{};var i={windowContext:n.windowContext,activityContext:void 0};return t.isActivityOwner()&&(i.activityContext=n.activityContext),i}))},t}();function ri(t){if(!t)return t;if(Array.isArray(t))return t.map((function(t){return ri(t)}));if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return t;return Object.keys(t).reduce((function(e,n){var i=ri(t[n]),r=n;return n[0].toLowerCase()!==n[0]&&(r=n[0].toLowerCase()+n.substr(1)),e[r]=i,e}),{})}var oi=function(t){this.name=t.name,this.type=t.type,this.components=t.components,this.context=t.context,this.metadata=t.metadata},si=function(){function t(t,e,n){this.config=t,this.stream=e,this.callbacks=n,this.appManager=t.appManager,this.onEvent=e.onEvent,this.provider=new ii(t.agm,t.activityGetter,n),e.subscribe()}return t.prototype.setDefaultGlobal=function(t){return be(this,void 0,void 0,(function(){return _e(this,(function(e){switch(e.label){case 0:return[4,this.config.agm.invoke("T42.ACS.SelectDefaultLayout",{name:t})];case 1:return e.sent(),[2]}}))}))},t.prototype.clearDefaultGlobal=function(){return be(this,void 0,void 0,(function(){return _e(this,(function(t){switch(t.label){case 0:return[4,this.config.agm.invoke("T42.ACS.DeselectDefaultLayout")];case 1:return t.sent(),[2]}}))}))},t.prototype.getDefaultGlobal=function(){return be(this,void 0,void 0,(function(){var t,e;return _e(this,(function(n){switch(n.label){case 0:return[4,this.config.agm.invoke("T42.ACS.GetDefaultLayout")];case 1:return t=n.sent(),(e=t.returned)?this.isSlimMode()?[2,e]:[2,this.list().find((function(t){return t.name===e.name&&"Global"===t.type}))]:[2,void 0]}}))}))},t.prototype.ready=function(){return"fullWaitSnapshot"===this.config.mode?this.stream.gotSnapshot:this.stream.ready},t.prototype.save=function(t){var e=this;return new Promise((function(n,i){if(e.verifyNotSlimMode(),!t.name)throw Error("layout.name argument is required");t.type||(t.type="Global"),t.activityId&&(t.type="Activity"),void 0===t.ignoreHidden&&(t.ignoreHidden=!0);var r={name:t.name,actIds:[],appIds:[],type:t.type,context:t.context,metadata:t.metadata||{},options:{ignoreLayoutRestrictions:!1}};if("Activity"===t.type){var o=t.activityId;if(!o){if(!e.appManager.myInstance.inActivity)throw new Error("Current application is not in activity. Can not save activity layout for it");o=e.appManager.myInstance.activityId}r.actIds.push(o),r.options={ignoreLayoutRestrictions:!0}}else{if("Global"!==t.type)throw new Error("layout type "+t.type+" not supported");if(2===e.config.gdMajorVersion){var s=e.appManager.instances();t.ignoreHidden&&(s=s.filter((function(t){return e.isVisibleWindow(t)}))),t.ignoreMyInstance&&e.appManager.myInstance&&(s=s.filter((function(t){return t.id!==e.appManager.myInstance.id}))),s.reduce((function(t,e){if(!e.id)return t;if(e.inActivity){var n=e.activityId;-1===t.actIds.indexOf(n)&&t.actIds.push(n)}else t.appIds.push(e.id);return t}),r)}else r.autoCollectApps=!0}e.invokeMethodAndTrack("T42.ACS.SaveLayout",r,n,i)}))},t.prototype.restore=function(t){var e=this;return new Promise((function(n,i){if(e.verifyNotSlimMode(),void 0===t)throw Error("options argument is required");if(!t.name)throw Error("options.name argument is required");t.type||(t.type="Global"),t.activityIdToJoin&&(t.type="Activity"),void 0===t.restoreActivityOwner&&(t.restoreActivityOwner=!1),void 0===t.ignoreActivityWindowTypes&&(t.ignoreActivityWindowTypes=[]),void 0===t.setActivityContext&&(t.setActivityContext=!0),void 0===t.closeRunningInstance&&("Global"===t.type?t.closeRunningInstance=!0:"Activity"===t.type&&(t.closeRunningInstance=!1)),void 0===t.reuseWindows&&(t.reuseWindows=!0),t.context=t.context||{};var r={restoreOptions:{activityToJoin:t.activityIdToJoin,setActivityContext:t.setActivityContext,ignoreActivityWindowTypes:t.ignoreActivityWindowTypes,restoreActivityOwner:t.restoreActivityOwner,closeOldWindows:t.closeRunningInstance,reuseExistingWindows:t.reuseWindows}},o={type:t.type,name:t.name,context:t.context,toClose:[],splash:t.splash};2===e.config.gdMajorVersion&&t.closeRunningInstance&&(o.toClose=e.getInstancesToClose(t)),t.timeout&&(o.timeout=t.timeout),o.context._t42=r,e.invokeMethodAndTrack("T42.ACS.RestoreLayout",o,n,i,!0)}))},t.prototype.remove=function(t,e){var n=this;return new Promise((function(i,r){if(n.verifyNotSlimMode(),!e)throw Error("name argument is required");if(!t)throw Error("type argument is required");var o={type:t,name:e};n.invokeMethodAndTrack("T42.ACS.RemoveLayout",o,i,r)}))},t.prototype.list=function(){return this.verifyNotSlimMode(),Nn.all},t.prototype.import=function(t,e){var n=this;return new Promise((function(i,r){n.verifyNotSlimMode();var o={mode:e||"replace",layouts:t};n.invokeMethodAndTrack("T42.ACS.ImportLayouts",o,i,r)}))},t.prototype.export=function(){var t=this;return new Promise((function(e,n){t.invokeMethodAndTrack("T42.ACS.ExportLayouts",{},(function(n){var i=t.getObjectValues(n.Layouts).map((function(t){return new oi(ri(t))}));e(i)}),n,!0)}))},t.prototype.rename=function(t,e){var n=this;return new Promise((function(i,r){if(n.verifyNotSlimMode(),!t)throw Error("layout argument is required");if(!t.name)throw Error("name argument is required");if(!t.type)throw Error("type argument is required");var o={type:t.type,oldName:t.name,newName:e};n.invokeMethodAndTrack("T42.ACS.RenameLayout",o,i,r)}))},t.prototype.updateMetadata=function(t){var e=this;return new Promise((function(n,i){if(!t)throw Error("layout argument is required");if(!t.name)throw Error("name argument is required");if(!t.type)throw Error("type argument is required");if(!t.metadata)throw Error("metadata argument is required");var r={name:t.name,type:t.type,metadata:t.metadata};e.invokeMethodAndTrack("T42.ACS.UpdateMetadata",r,n,i,!0)}))},t.prototype.hibernate=function(t,e){var n=this;return new Promise((function(i,r){if(!t)return r("name cannot be empty");var o={name:t,type:"Global",context:(e=e||{}).context||{},metadata:e.metadata||{}};n.invokeMethodAndTrack("T42.ACS.HibernateLayout",o,i,r,!0)}))},t.prototype.resume=function(t,e,n){var i=this;return new Promise((function(r,o){if(!t)return o("name cannot be empty");var s=we({name:t,type:"Global",context:e},n);i.invokeMethodAndTrack("T42.ACS.ResumeLayout",s,r,o,!0)}))},t.prototype.getCurrentLayout=function(){return be(this,void 0,void 0,(function(){var t,e;return _e(this,(function(n){switch(n.label){case 0:return[4,this.config.agm.invoke("T42.ACS.GetCurrentLayout",{},"best",{methodResponseTimeoutMs:12e4})];case 1:return t=n.sent(),(e=t.returned.layout)?(this.isSlimMode()||(e=this.list().find((function(t){return t.name===e.name&&t.type===e.type}))),[2,e]):[2,void 0]}}))}))},t.prototype.onAdded=function(t){var e=this.callbacks.add("added",t);return Nn.all.length>0&&Nn.all.forEach((function(e){try{t(e)}catch(t){}})),e},t.prototype.onRemoved=function(t){return this.callbacks.add("removed",t)},t.prototype.onChanged=function(t){return this.callbacks.add("changed",t)},t.prototype.onRestored=function(t){return this.callbacks.add("restored",t)},t.prototype.onRenamed=function(t){return this.callbacks.add("renamed",t)},t.prototype.onEvent=function(t){return this.stream.onEvent(t)},t.prototype.onSaveRequested=function(t){return this.provider.onSaveRequested(t)},t.prototype.updateAppContextInCurrent=function(t){var e=this;return new Promise((function(n,i){t&&"object"!=typeof t&&i("context must be an object");var r={context:t=null!=t?t:{}};e.invokeMethodAndTrack("T42.ACS.UpdateLayoutComponentContext",r,n,i,!1)}))},t.prototype.isSlimMode=function(){return"slim"===this.config.mode},t.prototype.verifyNotSlimMode=function(){if(this.isSlimMode())throw Error("Operation not allowed in slim mode. Run in full mode.")},t.prototype.isVisibleWindow=function(t){return"exe"===t.application.type||"node"===t.application.type||("activity"===t.application.type||!(!t||!t.window)&&t.window.isVisible)},t.prototype.invokeMethodAndTrack=function(t,e,n,i,r){var o,s=r,a=ni();e.token=a;var c=function(){s&&o&&n(o)};r||this.stream.waitFor(a).then((function(){s=!0,c()})).catch((function(t){i(t)}));this.config.agm.invoke(t,e,"best",{methodResponseTimeoutMs:12e4}).then((function(e){e.returned||i("No result from method "+t),e.returned.status&&"Success"!==e.returned.status&&"PartialSuccess"!==e.returned.status&&i(e.returned),o=e.returned,c()})).catch((function(t){return i(t)}))},t.prototype.getInstancesToClose=function(t){var e=this,n=[],i=this.appManager.applications().filter((function(t){return t.isShell}))[0],r=i?i.name:"AppManager";return this.appManager.instances().forEach((function(i){e.appManager.myInstance&&i.id===e.appManager.myInstance.id||i.application.name!==r&&e.isVisibleWindow(i)&&("Activity"===t.type&&i.activityId!==t.activityIdToJoin||n.push({application:i.application.name,instance:i.id}))})),n},t.prototype.getObjectValues=function(t){return t?Object.keys(t).map((function(e){return t[e]})):[]},t}(),ai=function(){function t(t,e){var n=this;this.agm=t,this.callbacks=e,this.ready=new Promise((function(t,e){n.resolveReady=t,n.rejectReady=e})),this.gotSnapshot=new Promise((function(t,e){n.resolveGotSnapshot=t,n.rejectGotSnapshot=e}))}return t.prototype.subscribe=function(t){var e=this,n=function(t){return e.getObjectValues(t).map((function(t){return ri(t)}))};this.checkForLayoutEventMethod()?this.agm.subscribe("T42.ACS.OnLayoutEvent",{waitTimeoutMs:1e4}).then((function(t){t.onData((function(t){var i=t.data;i.IsSnapshot&&e.resolveGotSnapshot(),e.addLayouts(n(i.OnLayoutAdded)),e.removeLayouts(n(i.OnLayoutRemoved)),e.changeLayouts(n(i.OnLayoutChanged)),e.renameLayouts(n(i.OnLayoutRenamed)),e.restoredLayout(n(i.OnLayoutRestored)),e.callbacks.execute("streamEvent",i)})),t.onFailed((function(t){var n="can not subscribe to T42.ACS.OnLayoutEvent "+t;e.rejectReady(n),e.rejectGotSnapshot(n)})),e.resolveReady()})).catch((function(t){var n="Error subscribing for T42.ACS.OnLayoutEvent stream. Err: "+t;e.rejectReady(n),e.rejectGotSnapshot(n)})):(t&&this.resolveReady(),setTimeout((function(){e.subscribe(!0)}),500))},t.prototype.onEvent=function(t){return this.callbacks.add("streamEvent",t)},t.prototype.waitFor=function(t,e){var n=this;return e||(e=1e4),new Promise((function(i,r){var o=!1,s=n.onEvent((function(e){e.Token===t&&(o=!0,s(),i())}));setTimeout((function(){o||r("timed out")}),e)}))},t.prototype.checkForLayoutEventMethod=function(){try{return-1!==this.agm.methods().map((function(t){return t.name})).indexOf("T42.ACS.OnLayoutEvent")}catch(t){return!1}},t.prototype.addLayouts=function(t){var e=this;t&&t.forEach((function(t){var n=new oi(t);Nn.add(n),e.callbacks.execute("added",n)}))},t.prototype.removeLayouts=function(t){var e=this;t&&t.forEach((function(t){Nn.removeWhere((function(n){return!e.compareLayouts(n,t)})),e.callbacks.execute("removed",t)}))},t.prototype.changeLayouts=function(t){var e=this;t&&t.forEach((function(t){Nn.removeWhere((function(n){return!e.compareLayouts(n,t)})),Nn.add(new oi(t)),e.callbacks.execute("changed",t)}))},t.prototype.renameLayouts=function(t){var e=this;t&&t.forEach((function(t){var n=Nn.first((function(n){return e.compareLayouts(n,{type:t.type,name:t.oldName})}));if(!n)throw Error("received rename event for unknown layout with type "+t.type+" and name "+t.oldName);n.name=t.newName,e.callbacks.execute("renamed",n)}))},t.prototype.compareLayouts=function(t,e){return t.name===e.name&&t.type===e.type},t.prototype.getObjectValues=function(t){return t?Object.keys(t).map((function(e){return t[e]})):[]},t.prototype.restoredLayout=function(t){var e=this;t&&t.forEach((function(t){var n=Nn.first((function(n){return e.compareLayouts(n,{type:t.type,name:t.name})}));e.callbacks.execute("restored",n)}))},t}();function ci(t){if(!t.agm)throw Error("config.agm is required");if(!t.logger)throw Error("config.logger is required");t.mode=t.mode||"slim";t.logger;var e,n=mn();return t.mode,e=new ai(t.agm,n),new si(t,e,n)}var ui,di,pi,hi=function(t,e){var n=this;this._agm=t,this._logger=e,this.all=function(){return be(n,void 0,void 0,(function(){return _e(this,(function(t){switch(t.label){case 0:return[4,this.callGD(ui.GetAll,{})];case 1:return[2,t.sent().map(this.decorateDisplay)]}}))}))},this.get=function(t){return be(n,void 0,void 0,(function(){var e;return _e(this,(function(n){switch(n.label){case 0:return[4,this.callGD(ui.Get,{id:t})];case 1:return e=n.sent(),[2,this.decorateDisplay(e)]}}))}))},this.getPrimary=function(){return be(n,void 0,void 0,(function(){return _e(this,(function(t){switch(t.label){case 0:return[4,this.all()];case 1:return[2,t.sent().find((function(t){return t.isPrimary}))]}}))}))},this.capture=function(t){return be(n,void 0,void 0,(function(){return _e(this,(function(e){switch(e.label){case 0:return[4,this.callGD(ui.Capture,we({},t))];case 1:return[2,e.sent()]}}))}))},this.captureAll=function(t){return be(n,void 0,void 0,(function(){return _e(this,(function(e){switch(e.label){case 0:return[4,this.callGD(ui.CaptureAll,we({},t))];case 1:return[2,e.sent()]}}))}))},this.getMousePosition=function(){return be(n,void 0,void 0,(function(){return _e(this,(function(t){switch(t.label){case 0:return[4,this.callGD(ui.GetMousePosition)];case 1:return[2,t.sent()]}}))}))},this.callGD=function(t,e){return be(n,void 0,void 0,(function(){return _e(this,(function(n){switch(n.label){case 0:return[4,this._agm.invoke("T42.Displays.Command",{options:we({},e),command:t})];case 1:return[2,n.sent().returned.data]}}))}))},this.decorateDisplay=function(t){return we(we({},t),{capture:function(e){return n.capture({id:t.id,size:e})}})}};function fi(t,e){return be(this,void 0,void 0,(function(){return _e(this,(function(n){return di.invoke("T42.Channels.Announce",{swId:null!=e?e:pi,command:"switchChannel",data:{newChannel:t}}),[2]}))}))}!function(t){t.Capture="capture",t.CaptureAll="captureAll",t.GetAll="getAll",t.Get="get",t.GetMousePosition="getMousePosition"}(ui||(ui={}));var li="___channel___",vi=function(){function t(t){this.contexts=t}return t.prototype.subscribe=function(t){this.callback=t},t.prototype.subscribeFor=function(t,e){if(!this.isChannel(t))return Promise.reject(new Error("Channel with name: "+t+" doesn't exist!"));var n=this.createContextName(t);return this.contexts.subscribe(n,(function(t,n,i,r,o){var s;e(t.data,t,null===(s=o)||void 0===s?void 0:s.updaterId)}))},t.prototype.switchChannel=function(t){return be(this,void 0,void 0,(function(){var e,n,i=this;return _e(this,(function(r){switch(r.label){case 0:return this.unsubscribe(),e=this.createContextName(t),n=this,[4,this.contexts.subscribe(e,(function(t,e,n,r,o){var s;i.callback&&i.callback(t.data,t,null===(s=o)||void 0===s?void 0:s.updaterId)}))];case 1:return n.unsubscribeFunc=r.sent(),[2]}}))}))},t.prototype.unsubscribe=function(){this.unsubscribeFunc&&this.unsubscribeFunc()},t.prototype.add=function(t,e){var n=this.createContextName(t);return this.contexts.set(n,e)},t.prototype.all=function(){return this.contexts.all().filter((function(t){return t.startsWith(li)})).map((function(t){return t.substr(li.length)}))},t.prototype.getContextData=function(t){var e=this;return new Promise((function(n,i){if(!e.isChannel(t))return i(new Error("A channel with name: "+t+" doesn't exist!"));var r=e.createContextName(t);e.contexts.subscribe(r,(function(t){n(t)})).then((function(t){return t()}))}))},t.prototype.update=function(t,e){var n=this.createContextName(t);return this.contexts.update(n,e)},t.prototype.createContextName=function(t){return li+t},t.prototype.isChannel=function(t){return this.all().some((function(e){return e===t}))},t}(),gi=function(){function t(t){this.shared=t,this.subsKey="subs",this.changedKey="changed",this.registry=mn(),this.shared.subscribe(this.handler.bind(this))}return t.prototype.subscribe=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.subsKey,t)},t.prototype.subscribeFor=function(t,e){return be(this,void 0,void 0,(function(){return _e(this,(function(n){switch(n.label){case 0:if("string"!=typeof t)throw new Error("Please provide the name as a string!");if("function"!=typeof e)throw new Error("Please provide the callback as a function!");return[4,this.shared.subscribeFor(t,e)];case 1:return[2,n.sent()]}}))}))},t.prototype.publish=function(t,e){return be(this,void 0,void 0,(function(){var n;return _e(this,(function(i){switch(i.label){case 0:if("object"!=typeof t)throw new Error("Please provide the data as an object!");if(!e)return[3,2];if("string"!=typeof e)throw new Error("Please provide the name as a string!");return[4,this.get(e)];case 1:return n=i.sent(),[2,this.shared.update(n.name,{data:t})];case 2:if(!this.currentContext)throw new Error("Not joined to any channel!");return[2,this.shared.update(this.currentContext,{data:t})]}}))}))},t.prototype.all=function(){var t=this.shared.all();return Promise.resolve(t)},t.prototype.list=function(){return be(this,void 0,void 0,(function(){var t,e=this;return _e(this,(function(n){switch(n.label){case 0:return[4,this.all()];case 1:return t=n.sent(),[4,Promise.all(t.map((function(t){return e.get(t)})))];case 2:return[2,n.sent()]}}))}))},t.prototype.get=function(t){return"string"!=typeof t?Promise.reject(new Error("Please provide the channel name as a string!")):this.shared.getContextData(t)},t.prototype.join=function(t){return be(this,void 0,void 0,(function(){return _e(this,(function(e){return[2,this.joinCore(t)]}))}))},t.prototype.joinNoSelectorSwitch=function(t){return be(this,void 0,void 0,(function(){return _e(this,(function(e){return[2,this.joinCore(t,!1)]}))}))},t.prototype.leave=function(){return this.leaveCore()},t.prototype.leaveNoSelectorSwitch=function(){return this.leaveCore(!1)},t.prototype.current=function(){return this.currentContext},t.prototype.my=function(){return this.current()},t.prototype.changed=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.changedKey,t)},t.prototype.onChanged=function(t){return this.changed(t)},t.prototype.add=function(t){return be(this,void 0,void 0,(function(){var e;return _e(this,(function(n){switch(n.label){case 0:if("object"!=typeof t)throw new Error("Please provide the info as an object!");if(void 0===t.name)throw new Error("info.name is missing!");if("string"!=typeof t.name)throw new Error("Please provide the info.name as a string!");if(void 0===t.meta)throw new Error("info.meta is missing!");if("object"!=typeof t.meta)throw new Error("Please provide the info.meta as an object!");if(void 0===t.meta.color)throw new Error("info.meta.color is missing!");if("string"!=typeof t.meta.color)throw new Error("Please provide the info.meta.color as a string!");return e={name:t.name,meta:t.meta||{},data:t.data||{}},[4,this.shared.update(t.name,e)];case 1:return n.sent(),[2,e]}}))}))},t.prototype.handler=function(t,e,n){this.registry.execute(this.subsKey,t,e,n)},t.prototype.joinCore=function(t,e){return void 0===e&&(e=!0),be(this,void 0,void 0,(function(){var n,i=this;return _e(this,(function(r){switch(r.label){case 0:if("string"!=typeof t)throw new Error("Please provide the channel name as a string!");return t===this.currentContext?[2]:(n=function(t){return i.shared.all().includes(t)})(t)?[3,2]:[4,new Promise((function(e,i){var r,o=setInterval((function(){n(t)&&(clearTimeout(r),clearInterval(o),e())}),100);r=setTimeout((function(){return clearInterval(o),i(new Error("A channel with name: "+t+" doesn't exist!"))}),3e3)}))];case 1:r.sent(),r.label=2;case 2:return[4,this.shared.switchChannel(t)];case 3:return r.sent(),e&&fi(t),this.currentContext=t,this.registry.execute(this.changedKey,t),[2]}}))}))},t.prototype.leaveCore=function(t){return void 0===t&&(t=!0),this.currentContext=void 0,this.registry.execute(this.changedKey,void 0),this.shared.unsubscribe(),t&&fi(),Promise.resolve()},t}();function yi(t,e){var n=new vi(t),i=new gi(n);return function(t,e){be(this,void 0,void 0,(function(){return _e(this,(function(n){switch(n.label){case 0:return di=t,"undefined"!=typeof window&&window.glue42gd&&(pi=window.glue42gd.windowId),pi?[4,di.register("T42.Channels.Command",(function(t){var n=t.command;if(!n)throw new Error("missing command argument");if("join"!==n){if("leave"!==n){if("get"===n)return{id:i=e.current()};throw new Error("unknown command "+n)}e.leaveNoSelectorSwitch()}else{var i;if(!(i=t.channel))throw new Error("missing argument id");e.joinNoSelectorSwitch(i)}}))]:[2];case 1:return n.sent(),di.invoke("T42.Channels.Announce",{swId:pi,instance:di.instance.instance}),[2]}}))}))}(e,i),{subscribe:i.subscribe.bind(i),subscribeFor:i.subscribeFor.bind(i),publish:i.publish.bind(i),all:i.all.bind(i),list:i.list.bind(i),get:i.get.bind(i),join:i.join.bind(i),leave:i.leave.bind(i),current:i.current.bind(i),my:i.my.bind(i),changed:i.changed.bind(i),onChanged:i.onChanged.bind(i),add:i.add.bind(i),ready:function(){return t.ready()}}}var mi="T42.Hotkeys.Command",wi=function(){function t(t){this.agm=t,this.registry=mn(),this.firstHotkey=!0,this.hotkeys=new Map}return t.prototype.register=function(t,e){return be(this,void 0,void 0,(function(){var n;return _e(this,(function(i){switch(i.label){case 0:if(void 0===t)throw new Error("Hotkey parameter missing");if("string"==typeof t)t={hotkey:t};else{if(!t.hotkey)throw new Error("Info's hotkey parameter missing");t={hotkey:t.hotkey,description:t.description}}if(n=this.formatHotkey(t.hotkey),this.hotkeys.has(n))throw new Error("Shortcut for "+n+" already registered");return this.firstHotkey?(this.firstHotkey=!1,[4,this.registerInvokeAGMMethod()]):[3,2];case 1:i.sent(),i.label=2;case 2:return this.registry.add(n,e),[4,this.agm.invoke(mi,{command:"register",hotkey:n,description:t.description})];case 3:return i.sent(),this.hotkeys.set(n,t),[2]}}))}))},t.prototype.unregister=function(t){return be(this,void 0,void 0,(function(){var e;return _e(this,(function(n){switch(n.label){case 0:if(void 0===t)throw new Error("hotkey parameter missing");if("string"!=typeof t)throw new Error("hotkey parameter must be string");return e=this.formatHotkey(t),[4,this.agm.invoke(mi,{command:"unregister",hotkey:e})];case 1:return n.sent(),this.hotkeys.delete(e),this.registry.clearKey(e),[2]}}))}))},t.prototype.unregisterAll=function(){return be(this,void 0,void 0,(function(){return _e(this,(function(t){switch(t.label){case 0:return[4,this.agm.invoke(mi,{command:"unregisterAll"})];case 1:return t.sent(),this.hotkeys.clear(),this.registry.clear(),[2]}}))}))},t.prototype.isRegistered=function(t){var e=this.formatHotkey(t);return this.hotkeys.has(e)},t.prototype.registerInvokeAGMMethod=function(){var t=this;this.agm.register("T42.Hotkeys.Invoke",(function(e){var n=e.key.toLowerCase(),i=t.hotkeys.get(n);t.registry.execute(n,i)}))},t.prototype.formatHotkey=function(t){if(t)return t.replace(/\s/g,"").toLowerCase()},t}();var bi,_i,Ii="5.1.4",Si=function(t){function e(t,e,n){if("boolean"!=typeof t||t){var i=function t(e,n,i){if("object"==typeof e)return t(e.mode,n,i)+"";if(void 0===e)return"boolean"!=typeof n||n?n+"":void 0;if("boolean"==typeof e)return e?(void 0===i?n:i)+"":void 0;return e+""}(t,e,n);return"object"==typeof t?(t.mode=i,t):{mode:i}}}return{layouts:e(t.layouts,"slim"),activities:e(t.activities,"trackMyTypeAndInitiatedFromMe"),appManager:e(t.appManager,!1,"startOnly"),windows:e(t.windows,!0),channels:e(t.channels||!1,!1),displays:e(t.displays,!0)}};!function(t){t.Find="find",t.FindByContext="findByContext",t.GetAll="all",t.Raise="raise"}(_i||(_i={}));var xi,ki={};function Ci(t){return be(this,void 0,void 0,(function(){return _e(this,(function(e){return"string"==typeof t&&(t={intent:t}),[2,ji(_i.Raise,t)]}))}))}function Ai(t){return be(this,void 0,void 0,(function(){return _e(this,(function(e){return"string"==typeof t&&(t={name:t}),[2,ji(_i.Find,{intentFilter:t})]}))}))}function Ti(t){return be(this,void 0,void 0,(function(){return _e(this,(function(e){return t&&"string"==typeof t?[2,ji(_i.FindByContext,{contextType:t})]:[2,Promise.reject(Error("findByContext called with invalid contextType: "+t))]}))}))}function Pi(){return be(this,void 0,void 0,(function(){return _e(this,(function(t){return[2,ji(_i.GetAll)]}))}))}function Mi(t,e){ki[t]||(ki[t]=[]);var n=ni();return ki[t].push({unsubId:n,callback:e}),function(){ki[t]=ki[t].filter((function(t){return t.unsubId!==n}))}}function ji(t,e){return be(this,void 0,void 0,(function(){return _e(this,(function(n){switch(n.label){case 0:return[4,bi.invoke("T42.Intents.Command",{options:we({},e),command:t})];case 1:return[2,n.sent().returned.result]}}))}))}function Oi(t){var e,n=t.type,i=t.intent,r=t.context;switch(n){case xi.IntentListenerRaised:var o=null===(e=ki[i])||void 0===e?void 0:e.map((function(t){return t.callback}));o&&o.length>0&&o.forEach((function(t){return t(r)}))}}!function(t){t.IntentListenerRaised="intentListenerRaised"}(xi||(xi={}));var Ei=function(){function t(t){this.options=t,this.callbacks=mn(),this.actions=t.actions,this.body=t.body,this.badge=t.badge,this.data=t.data,this.dir=t.dir,this.icon=t.icon,this.image=t.image,this.lang=t.lang,this.renotify=t.renotify,this.requireInteraction=t.requireInteraction,this.silent=t.silent,this.tag=t.tag,this.timestamp=t.timestamp,this.title=t.title}return t.prototype.close=function(){throw new Error("Method not implemented.")},t.prototype.addEventListener=function(t,e,n){this.callbacks.add(t,e)},t.prototype.removeEventListener=function(t,e,n){},t.prototype.dispatchEvent=function(t){return this.callbacks.execute(t.type,t),!0},t}(),Ri=function(){function t(t){this.interop=t,this.methodRegistered=!1,this.methodName="T42.Notifications.Handler-"+ni(),this.nextId=0,this.notifications={}}return t.prototype.raise=function(t){var e,n;return be(this,void 0,void 0,(function(){var i,r,o,s,a,c,u,d;return _e(this,(function(p){switch(p.label){case 0:if(!t)throw new Error("invalid options - should be an object");if(!t.title)throw new Error("invalid options - should have title");return this.methodRegistered?[3,2]:[4,this.interop.register(this.methodName,this.handleNotificationAction.bind(this))];case 1:p.sent(),this.methodRegistered=!0,p.label=2;case 2:if(i=String(this.nextId++),r={title:t.title,severity:"Medium",description:t.body,glueRoutingDetailMethodName:this.methodName,actions:[],source:i},t.actions)for(o=function(t){var o={g42notificationId:i,g42action:t.action,g42interopMethod:null===(e=t.interop)||void 0===e?void 0:e.method,g42interopTarget:null===(n=t.interop)||void 0===n?void 0:n.target},a=Object.keys(o).map((function(t){return{name:t,value:{stringValue:o[t]}}})),c={name:s.methodName,description:t.title,displayName:t.title,parameters:a};r.actions.push(c)},s=this,a=0,c=t.actions;a<c.length;a++)u=c[a],o(u);return[4,this.interop.invoke("T42.GNS.Publish.RaiseNotification",{notification:r})];case 3:return p.sent(),d=new Ei(t),this.notifications[i]=d,[2,d]}}))}))},t.prototype.handleNotificationAction=function(t){if(t.g42notificationId){var e=t,n=e.g42notificationId;if(!(o=this.notifications[n]))return;var i=new Event("onaction");i.action=e.g42action,o.onaction&&o.onaction(i);var r=(o.actions||[]).find((function(t){return t.action===e.g42action})).interop;r&&this.interop.invoke(r.method,r.arguments||{},r.target||"best"),o.dispatchEvent(i)}else if(t.notification&&t.notification.source){var o;n=t.notification.source;if(!(o=this.notifications[n]))return;var s=new Event("onclick");o.onclick&&o.onclick(s);var a=o.options.clickInterop;a&&this.interop.invoke(a.method,a.arguments||{},a.target||"best"),o.dispatchEvent(s)}},t}(),Li=function(){function t(t){this.core=t,this.registry=mn(),this.getConfiguration()}return t.prototype.list=function(){return be(this,void 0,void 0,(function(){return _e(this,(function(t){switch(t.label){case 0:return[4,this.getConfiguration()];case 1:if(t.sent(),!this.getMethodName)throw new Error("not supported");return[4,this.getAll()];case 2:return[2,t.sent().returned.all]}}))}))},t.prototype.getCurrent=function(){return be(this,void 0,void 0,(function(){var t;return _e(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:if(e.sent(),!this.getMethodName)throw new Error("not supported");return[4,this.getAll()];case 2:return[2,(t=e.sent()).returned.all.find((function(e){return e.name===t.returned.selected}))]}}))}))},t.prototype.select=function(t){return be(this,void 0,void 0,(function(){return _e(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:if(e.sent(),!this.setMethodName)throw new Error("not supported");return[4,this.core.interop.invoke(this.setMethodName,{theme:t})];case 2:return e.sent(),[2]}}))}))},t.prototype.onChanged=function(t){return this.subscribe(),this.registry.add("changed",t)},t.prototype.getConfiguration=function(){return be(this,void 0,void 0,(function(){var t;return _e(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),this.sharedContextName?[2]:[4,this.core.interop.invoke("T42.Themes.Configuration")];case 1:return t=e.sent(),this.sharedContextName=t.returned.sharedContextName,this.getMethodName=t.returned.getThemesMethodName,this.setMethodName=t.returned.setThemesMethodName,[3,3];case 2:return e.sent(),[2];case 3:return[2]}}))}))},t.prototype.getAll=function(){return be(this,void 0,void 0,(function(){return _e(this,(function(t){switch(t.label){case 0:return[4,this.getConfiguration()];case 1:return t.sent(),[4,this.core.interop.invoke(this.getMethodName)];case 2:return[2,t.sent()]}}))}))},t.prototype.subscribe=function(){return be(this,void 0,void 0,(function(){var t=this;return _e(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:return e.sent(),this.core.contexts.subscribe(this.sharedContextName,(function(e){e&&e.all&&e.selected&&t.registry.execute("changed",e.all.find((function(t){return t.name===e.selected})))})),[2]}}))}))},t}();var Ni=function(t){var e,n,i,r,o=Tn.getGDMajorVersion(),s=Si(t=t||{});function a(t,e,n){var i=e.subLogger(t);if(n&&n.logger){var r=n.logger;r.console&&i.consoleLevel(r.console),r.publish&&i.publishLevel(r.publish)}return i}t.gateway=t.gateway||{};var c={libs:[{name:"windows",create:function(t){if(s.windows){var n=a("windows",t.logger,s.windows);return d(i=Ln(t.agm,n,(function(){return e}),o)),i}}},{name:"activities",create:function(t){if(s.activities&&fn.checkIsUsingGW3Implementation&&fn.checkIsUsingGW3Implementation(t.connection)){var r=a("activity",t.logger,s.activities);return d(n=new fn({connection:t.connection,contexts:t.contexts,agm:t.agm,logger:r,logLevel:"info",disableAutoAnnounce:!1,disposeRequestHandling:"ignore",announcementInfo:null,windows:i,appManagerGetter:function(){return e},mode:s.activities.mode,typesToTrack:s.activities.typesToTrack,activityId:"undefined"!=typeof window&&window.glue42gd&&window.glue42gd.activityInfo&&window.glue42gd.activityInfo.activityId,gdMajorVersion:o}).api),n}}},{name:"appManager",create:function(t){if(s.appManager){var r=a("appManager",t.logger,s.appManager);return d(e=Cn({agm:t.agm,windows:i,logger:r,activities:n,mode:s.appManager.mode,gdMajorVersion:o})),e}}},{name:"layouts",create:function(t){if(s.layouts){var i=a("layouts",t.logger,s.layouts),r=ci({agm:t.agm,appManager:e,activityGetter:function(){return n},logger:i,mode:s.layouts.mode,gdMajorVersion:o});return d(r),r}}},{name:"channels",create:function(t){if(s.channels&&t.contexts){var e=yi(t.contexts,t.agm);return d(e),e}}},{name:"hotkeys",create:function(t){var e=function(t){var e=new wi(t);return{register:e.register.bind(e),unregister:e.unregister.bind(e),unregisterAll:e.unregisterAll.bind(e),isRegistered:e.isRegistered.bind(e),ready:function(){return Promise.resolve()}}}(t.agm);return d(e),e}},{name:"displays",create:function(t){if(s.displays){var e=a("displays",t.logger,s.displays);return d(r=new hi(t.agm,e)),r}}},{name:"intents",create:function(t){var e,n=(e=t.agm,(bi=e).register("T42.Intents.Events",Oi),{raise:Ci,find:Ai,findByContext:Ti,all:Pi,addIntentListener:Mi,ready:function(){return Promise.resolve()}});return d(n),n}},{name:"notifications",create:function(t){var e=new Ri(t.interop);return d(e),e}},{name:"themes",create:function(t){if(t.contexts){var e=function(t){var e=new Li(t);return{list:e.list.bind(e),getCurrent:e.getCurrent.bind(e),select:e.select.bind(e),onChanged:e.onChanged.bind(e),ready:function(){return Promise.resolve()}}}(t);return d(e),e}}}],version:Ii,enrichGlue:function(t){t.config.activities=s.activities,t.config.windows=s.windows,t.config.appManager=s.appManager,t.config.layouts=s.layouts,t.config.channels=s.channels,t.config.displays=s.displays}},u=[];function d(t){u.push(t)}return"undefined"!=typeof window&&(window.glueFactoryLog||(window.glueFactoryLog=[]),window.glueFactoryLog.push(u)),ge(t,c)};Ni.coreVersion=ge.version,Ni.version=Ii;var Wi=Ni,Di=!0;if("undefined"!=typeof window){var Fi=window.glue42gd;Fi&&Fi.autoInjected&&(Wi=window.Glue,Di=!1),Di&&(window.Glue=Wi),delete window.GlueCore}Wi.default=Wi;var Bi=Wi,qi=function(t,e){return(qi=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var Gi=function(){return(Gi=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function Hi(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))}function Ui(t,e){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var Vi="1.4.2";var Ji=1;var zi,Ki,Yi,Zi={nextValue:function(){return(Ji=(9301*Ji+49297)%233280)/233280},seed:function(t){Ji=t}},$i="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function Xi(){Yi=!1}function Qi(t){if(t){if(t!==zi){if(t.length!==$i.length)throw new Error("Custom alphabet for shortid must be "+$i.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+$i.length+" unique characters. These characters were not unique: "+e.join(", "));zi=t,Xi()}}else zi!==$i&&(zi=$i,Xi())}function tr(){return Yi||(Yi=function(){zi||Qi($i);for(var t,e=zi.split(""),n=[],i=Zi.nextValue();e.length>0;)i=Zi.nextValue(),t=Math.floor(i*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var er={get:function(){return zi||$i},characters:function(t){return Qi(t),zi},seed:function(t){Zi.seed(t),Ki!==t&&(Xi(),Ki=t)},lookup:function(t){return tr()[t]},shuffled:tr},nr="object"==typeof window&&(window.crypto||window.msCrypto),ir=nr&&nr.getRandomValues?function(t){return nr.getRandomValues(new Uint8Array(t))}:function(t){for(var e=[],n=0;n<t;n++)e.push(Math.floor(256*Math.random()));return e},rr=function(t,e,n){for(var i=(2<<Math.log(e.length-1)/Math.LN2)-1,r=-~(1.6*i*n/e.length),o="";;)for(var s=t(r),a=r;a--;)if((o+=e[s[a]&i]||"").length===+n)return o};var or,sr,ar=function(t){for(var e,n=0,i="";!e;)i+=rr(ir,er.get(),1),e=t<Math.pow(16,n+1),n++;return i};var cr=function(t){var e="",n=Math.floor(.001*(Date.now()-1567752802062));return n===sr?or++:(or=0,sr=n),e+=ar(7),e+=ar(t),or>0&&(e+=ar(or)),e+=ar(n)};var ur=function(t){return!(!t||"string"!=typeof t||t.length<6)&&!new RegExp("[^"+er.get().replace(/[|\\{}()[\]^$+*?.-]/g,"\\$&")+"]").test(t)},dr=function(t,e,n){return t(n={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&n.path)}},n.exports),n.exports}((function(t){var e=0;function n(){return cr(e)}t.exports=n,t.exports.generate=n,t.exports.seed=function(e){return er.seed(e),t.exports},t.exports.worker=function(n){return e=n,t.exports},t.exports.characters=function(t){return void 0!==t&&er.characters(t),er.shuffled()},t.exports.isValid=ur})),pr=function(){function t(t,e,n,i){this.id=t,this.name=e,this.control=n,this.windows=i}return t.prototype.getURL=function(){var t;return Hi(this,void 0,void 0,(function(){var e;return Ui(this,(function(n){switch(n.label){case 0:return[4,this.callControl("getURL",{})];case 1:return e=n.sent(),[2,null===(t=null==e?void 0:e.returned)||void 0===t?void 0:t._value]}}))}))},t.prototype.moveResize=function(t){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(e){switch(e.label){case 0:return[4,this.callControl("moveResize",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.close=function(){return Hi(this,void 0,void 0,(function(){var t=this;return Ui(this,(function(e){return[2,new Promise((function(e,n){var i=function(){o&&clearTimeout(o),r&&r()},r=t.windows.onWindowRemoved((function(n){n.id===t.id&&(e(t),i())})),o=setTimeout((function(){n("can not close window - probably not opened by your window"),i()}),1e3);t.callControl("close",{},!0).catch((function(){}))}))]}))}))},t.prototype.setTitle=function(t){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(e){switch(e.label){case 0:return"string"==typeof t&&(t={title:t}),[4,this.callControl("setTitle",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.resizeTo=function(t,e){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(n){switch(n.label){case 0:return[4,this.callControl("moveResize",{width:t,height:e},!0)];case 1:return n.sent(),[2,this]}}))}))},t.prototype.moveTo=function(t,e){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(n){switch(n.label){case 0:return[4,this.callControl("moveResize",{top:t,left:e},!0)];case 1:return n.sent(),[2,this]}}))}))},t.prototype.focus=function(){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(t){switch(t.label){case 0:return[4,this.callControl("focus",{},!0)];case 1:return t.sent(),[2,this]}}))}))},t.prototype.getBounds=function(){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(t){switch(t.label){case 0:return[4,this.callControl("getBounds",{})];case 1:return[2,t.sent().returned]}}))}))},t.prototype.getContext=function(){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(t){switch(t.label){case 0:return[4,this.callControl("getContext",{})];case 1:return[2,t.sent().returned]}}))}))},t.prototype.getTitle=function(){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(t){switch(t.label){case 0:return[4,this.callControl("getTitle",{})];case 1:return[2,t.sent().returned._value]}}))}))},t.prototype.onContextUpdated=function(t){throw new Error("Method not implemented.")},t.prototype.updateContext=function(t){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(e){switch(e.label){case 0:return[4,this.callControl("updateContext",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.setContext=function(t){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(e){switch(e.label){case 0:return[4,this.callControl("setContext",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.callControl=function(t,e,n){return void 0===n&&(n=!1),Hi(this,void 0,void 0,(function(){return Ui(this,(function(i){switch(i.label){case 0:return[4,this.control.send({command:t,domain:"windows",args:e,skipResult:n},{windowId:this.id})];case 1:return[2,i.sent()]}}))}))},t}();function hr(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function i(n,i){var r=n instanceof Error?n:new Error(n);if(e)e(r);else{var o='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+r.stack;if(t)switch(t.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(t,e){var i=n[t];return i||(i=[],n[t]=i),i.push(e),function(){var i=n[t];i&&(i=i.reduce((function(t,n,i){return n===e&&t.length===i||t.push(n),t}),[]),n[t]=i)}},execute:function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var o=n[t];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var r=n.apply(void 0,e);s.push(r)}catch(e){s.push(void 0),i(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}hr.default=hr;var fr=hr,lr=function(){function t(){this.callbacks={},this.registry=fr()}return t.prototype.start=function(e,n){return Hi(this,void 0,void 0,(function(){var i=this;return Ui(this,(function(r){switch(r.label){case 0:return this.interop=e,this.logger=n,[4,this.interop.register(t.CONTROL_METHOD,(function(t){return Hi(i,void 0,void 0,(function(){var e,i,r;return Ui(this,(function(o){return e=t,n.trace("received control command "+JSON.stringify(e)),"windows"===e.domain?this.myWindow?(i=this.myWindow[e.command].call(this.myWindow,e.args),e.skipResult?[2,{}]:[2,i]):[2]:"appManager"===e.domain?this.myInstance?(i=this.myInstance[e.command].call(this.myInstance,e.args),e.skipResult?[2,{}]:[2,i]):[2]:("layouts"===e.domain&&(r=this.callbacks[e.domain])&&r(e),[2])}))}))}))];case 1:return r.sent(),this.registry.execute("started"),[2]}}))}))},t.prototype.send=function(e,n){if(!this.interop)throw new Error("Control not started");return this.logger.info("sending control command "+JSON.stringify(e)+" to "+JSON.stringify(n)+"}"),this.interop.invoke(t.CONTROL_METHOD,e,n)},t.prototype.subscribe=function(t,e){this.callbacks[t]=e},t.prototype.setLocalWindow=function(t){this.myWindow=t},t.prototype.setLocalInstance=function(t){this.myInstance=t},t.prototype.onStart=function(t){return this.registry.add("started",t)},t.CONTROL_METHOD="GC.Control",t}(),vr=function(){function t(t,e,n,i,r){this.id=t,this.name=e,this.window=n,this.control=i,this.interop=r,this.context={},this.registry=fr(),i.setLocalWindow(this)}return t.prototype.getURL=function(){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(t){return[2,this.window.location.href]}))}))},t.prototype.moveResize=function(t){var e=t.left,n=t.top,i=t.width,r=t.height;return Hi(this,void 0,void 0,(function(){return Ui(this,(function(t){return e=null!=e?e:window.screenLeft,n=null!=n?n:window.screenTop,i=null!=i?i:window.outerWidth,r=null!=r?r:window.outerHeight,window.moveTo(e,n),window.resizeTo(i,r),[2,this]}))}))},t.prototype.close=function(){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(t){if(!this.parent)throw new Error("can not close window if it's not opened by script");try{window.close()}catch(t){console.log("what")}return[2,this]}))}))},t.prototype.setTitle=function(t){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(e){return"object"==typeof t&&null!==t&&(t=t.title),document.title=t,[2,this]}))}))},t.prototype.resizeTo=function(t,e){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(n){switch(n.label){case 0:return[4,this.moveResize({width:t,height:e})];case 1:return n.sent(),[2,this]}}))}))},t.prototype.moveTo=function(t,e){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(n){switch(n.label){case 0:return[4,this.moveResize({top:t,left:e})];case 1:return n.sent(),[2,this]}}))}))},t.prototype.focus=function(){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(t){return window.focus(),[2,this]}))}))},t.prototype.getBounds=function(){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(t){return[2,this.getBoundsSync()]}))}))},t.prototype.getContext=function(){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(t){return[2,this.getContextSync()]}))}))},t.prototype.getContextSync=function(){return this.context},t.prototype.getTitle=function(){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(t){return[2,this.window.document.title]}))}))},t.prototype.onContextUpdated=function(t){return this.registry.add("context-updated",t)},t.prototype.updateContext=function(t){var e=this.context;return this.context=Object.assign({},e,t),this.registry.execute("context-updated",this.context,e),Promise.resolve(this)},t.prototype.setContext=function(t){return Hi(this,void 0,void 0,(function(){var e;return Ui(this,(function(n){return e=this.context,this.context=Object.assign({},t),this.registry.execute("context-updated",t,e),[2,Promise.resolve(this)]}))}))},t.prototype.getBoundsSync=function(){return{left:this.window.screenLeft,top:this.window.screenTop,width:this.window.outerWidth,height:this.window.outerHeight}},t}(),gr=function(t){function e(e,n,i,r,o){var s=t.call(this,n,i,r,o)||this;return s.window=e,s.id=n,s.name=i,s}return function(t,e){function n(){this.constructor=t}qi(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}(e,t),e}(pr),yr=function(t){return'"GC.Wnd."'+t},mr=function(t,e,n){return Hi(void 0,void 0,void 0,(function(){var i,r;return Ui(this,(function(o){switch(o.label){case 0:return i=yr(t.id),e.methods().find((function(t){return t.name===i}))?[4,e.invoke(i)]:[3,2];case 1:r=o.sent(),t&&(t.setContext(r.returned.context),t.name=r.returned.name,t.parent=r.returned.parent,n&&(n.startedByScript=!0,n.context=r.returned.context)),o.label=2;case 2:return[2]}}))}))},wr=function(){function t(t,e){this.interop=t,this.control=e,this.registry=fr(),this.childWindows=[];var n=t.instance.windowId,i="document.title ("+dr()+")";this.myWindow=new vr(n,i,window,this.control,this.interop),this.trackWindowsLifetime()}return t.prototype.list=function(){var t=this,e=this.interop.methods({name:lr.CONTROL_METHOD})[0];return e?(e.getServers?e.getServers():[]).reduce((function(e,n){var i=t.remoteFromServer(n);return i&&e.push(i),e}),[]):[]},t.prototype.findById=function(t){return this.list().find((function(e){return e.id===t}))},t.prototype.my=function(){return this.myWindow},t.prototype.open=function(t,e,n){var i,r,o,s,a;return Hi(this,void 0,void 0,(function(){var c,u,d,p,h,f,l,v,g,y,m,w,b;return Ui(this,(function(_){switch(_.label){case 0:return c=null!==(i=null==n?void 0:n.width)&&void 0!==i?i:400,u=null!==(r=null==n?void 0:n.height)&&void 0!==r?r:400,d=null!==(o=null==n?void 0:n.left)&&void 0!==o?o:window.screen.availWidth-window.screenLeft,p=null!==(s=null==n?void 0:n.top)&&void 0!==s?s:0,h=dr(),function(t,e,n,i,r){var o,s=yr(n),a={context:null!==(o=null==r?void 0:r.context)&&void 0!==o?o:{},name:i,parent:e};t.register(s,(function(){return a}))}(this.interop,this.my().id,h,t,n),(null==n?void 0:n.relativeTo)?(f=n.relativeTo,(l=this.list().find((function(t){return t.id===f})))?[4,l.getBounds()]:[3,2]):[3,2];case 1:v=_.sent(),g=null!==(a=n.relativeDirection)&&void 0!==a?a:"right",y=this.getRelativeBounds({width:c,height:u,left:d,top:p},v,g),c=y.width,u=y.height,d=y.left,p=y.top,_.label=2;case 2:if(m="width="+c+",height="+u+",left="+d+",top="+p+",scrollbars=none,location=no,status=no,menubar=no",!(w=window.open(e,h,m)))throw new Error("failed to open a window with url="+e+" and options="+m);return w.focus(),w.moveTo(d,p),w.resizeTo(c,u),b=new gr(w,h,t,this.control,this),this.childWindows.push(b),[2,b]}}))}))},t.prototype.onWindowAdded=function(t){return this.registry.add("window-added",t)},t.prototype.onWindowRemoved=function(t){return this.registry.add("window-removed",t)},t.prototype.getChildWindows=function(){return this.childWindows=this.childWindows.filter((function(t){return!t.window.closed})),this.childWindows},t.prototype.remoteFromServer=function(t){var e;if(t.windowId)return new pr(t.windowId,null!==(e=t.application)&&void 0!==e?e:"",this.control,this)},t.prototype.getRelativeBounds=function(t,e,n){switch(n){case"bottom":return{left:e.left,top:e.top+e.height+0,width:e.width,height:t.height};case"top":return{left:e.left,top:e.top-t.height-0,width:e.width,height:t.height};case"right":return{left:e.left+e.width+0,top:e.top,width:t.width,height:e.height};case"left":return{left:e.left-t.width-0,top:e.top,width:t.width,height:e.height}}throw new Error("invalid relativeDirection")},t.prototype.trackWindowsLifetime=function(){var t=this;this.interop.serverMethodAdded((function(e){var n=e.server;if(e.method.name===lr.CONTROL_METHOD){var i=t.remoteFromServer(n);i&&t.registry.execute("window-added",i)}})),this.interop.serverRemoved((function(e){var n=t.remoteFromServer(e);n&&t.registry.execute("window-removed",n)}))},t}(),br=function(t){return{ok:!0,result:t}},_r=function(t){return{ok:!1,error:t}},Ir=function(t){return!0===t.ok?Promise.resolve(t.result):Promise.reject(t.error)},Sr=function(t,e){return!0===e.ok?e.result:t},xr=function(t){if(!0===t.ok)return t.result;throw t.error},kr=function(t,e){return!0===e.ok?br(t(e.result)):e},Cr=function(t,e,n){return!1===e.ok?e:!1===n.ok?n:br(t(e.result,n.result))},Ar=function(t,e){return!0===e.ok?e:_r(t(e.error))},Tr=function(t,e){return!0===e.ok?t(e.result):e},Pr=(Object.freeze({ok:br,isOk:function(t){return!0===t.ok},err:_r,isErr:function(t){return!1===t.ok},asPromise:Ir,withDefault:Sr,withException:xr,successes:function(t){return t.reduce((function(t,e){return!0===e.ok?t.concat(e.result):t}),[])},map:kr,map2:Cr,mapError:Ar,andThen:Tr}),function(){return(Pr=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)});var Mr=function(t){return Array.isArray(t)},jr=function(t){return"object"==typeof t&&null!==t&&!Mr(t)},Or=function(t,e){return"expected "+t+", got "+function(t){switch(typeof t){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return t instanceof Array?"an array":null===t?"null":"an object";default:return JSON.stringify(t)}}(e)},Er=function(t){return t.map((function(t){return"string"==typeof t?"."+t:"["+t+"]"})).join("")},Rr=function(t,e){var n=e.at,i=function(t,e){var n={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(n[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(t);r<i.length;r++)e.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(t,i[r])&&(n[i[r]]=t[i[r]])}return n}(e,["at"]);return Pr({at:t+(n||"")},i)},Lr=function(){function t(e){var n=this;this.decode=e,this.run=function(t){return Ar((function(e){return{kind:"DecoderError",input:t,at:"input"+(e.at||""),message:e.message||""}}),n.decode(t))},this.runPromise=function(t){return Ir(n.run(t))},this.runWithException=function(t){return xr(n.run(t))},this.map=function(e){return new t((function(t){return kr(e,n.decode(t))}))},this.andThen=function(e){return new t((function(t){return Tr((function(n){return e(n).decode(t)}),n.decode(t))}))},this.where=function(e,i){return n.andThen((function(n){return e(n)?t.succeed(n):t.fail(i)}))}}return t.string=function(){return new t((function(t){return"string"==typeof t?br(t):_r({message:Or("a string",t)})}))},t.number=function(){return new t((function(t){return"number"==typeof t?br(t):_r({message:Or("a number",t)})}))},t.boolean=function(){return new t((function(t){return"boolean"==typeof t?br(t):_r({message:Or("a boolean",t)})}))},t.constant=function(e){return new t((function(t){return function t(e,n){if(e===n)return!0;if(null===e&&null===n)return!0;if(typeof e!=typeof n)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(n))return!1;if(e.length!==n.length)return!1;for(var i=0;i<e.length;i++)if(!t(e[i],n[i]))return!1;return!0}var r=Object.keys(e);if(r.length!==Object.keys(n).length)return!1;for(i=0;i<r.length;i++){if(!n.hasOwnProperty(r[i]))return!1;if(!t(e[r[i]],n[r[i]]))return!1}return!0}}(t,e)?br(e):_r({message:"expected "+JSON.stringify(e)+", got "+JSON.stringify(t)})}))},t.object=function(e){return new t((function(t){if(jr(t)&&e){var n={};for(var i in e)if(e.hasOwnProperty(i)){var r=e[i].decode(t[i]);if(!0!==r.ok)return void 0===t[i]?_r({message:"the key '"+i+"' is required but was not present"}):_r(Rr("."+i,r.error));void 0!==r.result&&(n[i]=r.result)}return br(n)}return jr(t)?br(t):_r({message:Or("an object",t)})}))},t.array=function(e){return new t((function(t){if(Mr(t)&&e){return t.reduce((function(t,n,i){return Cr((function(t,e){return t.concat([e])}),t,function(t,n){return Ar((function(t){return Rr("["+n+"]",t)}),e.decode(t))}(n,i))}),br([]))}return Mr(t)?br(t):_r({message:Or("an array",t)})}))},t.tuple=function(e){return new t((function(t){if(Mr(t)){if(t.length!==e.length)return _r({message:"expected a tuple of length "+e.length+", got one of length "+t.length});for(var n=[],i=0;i<e.length;i++){var r=e[i].decode(t[i]);if(!r.ok)return _r(Rr("["+i+"]",r.error));n[i]=r.result}return br(n)}return _r({message:Or("a tuple of length "+e.length,t)})}))},t.union=function(e,n){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];return t.oneOf.apply(t,[e,n].concat(i))},t.intersection=function(e,n){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];return new t((function(t){return[e,n].concat(i).reduce((function(e,n){return Cr(Object.assign,e,n.decode(t))}),br({}))}))},t.anyJson=function(){return new t((function(t){return br(t)}))},t.unknownJson=function(){return new t((function(t){return br(t)}))},t.dict=function(e){return new t((function(t){if(jr(t)){var n={};for(var i in t)if(t.hasOwnProperty(i)){var r=e.decode(t[i]);if(!0!==r.ok)return _r(Rr("."+i,r.error));n[i]=r.result}return br(n)}return _r({message:Or("an object",t)})}))},t.optional=function(e){return new t((function(t){return void 0===t?br(void 0):e.decode(t)}))},t.oneOf=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return new t((function(t){for(var n=[],i=0;i<e.length;i++){var r=e[i].decode(t);if(!0===r.ok)return r;n[i]=r.error}var o=n.map((function(t){return"at error"+(t.at||"")+": "+t.message})).join('", "');return _r({message:'expected a value matching one of the decoders, got the errors ["'+o+'"]'})}))},t.withDefault=function(e,n){return new t((function(t){return br(Sr(e,n.decode(t)))}))},t.valueAt=function(e,n){return new t((function(t){for(var i=t,r=0;r<e.length;r++){if(void 0===i)return _r({at:Er(e.slice(0,r+1)),message:"path does not exist"});if("string"==typeof e[r]&&!jr(i))return _r({at:Er(e.slice(0,r+1)),message:Or("an object",i)});if("number"==typeof e[r]&&!Mr(i))return _r({at:Er(e.slice(0,r+1)),message:Or("an array",i)});i=i[e[r]]}return Ar((function(t){return void 0===i?{at:Er(e),message:"path does not exist"}:Rr(Er(e),t)}),n.decode(i))}))},t.succeed=function(e){return new t((function(t){return br(e)}))},t.fail=function(e){return new t((function(t){return _r({message:e})}))},t.lazy=function(e){return new t((function(t){return e().decode(t)}))},t}(),Nr=Lr.string,Wr=Lr.number,Dr=Lr.boolean,Fr=Lr.anyJson,Br=Lr.constant,qr=Lr.object,Gr=Lr.array,Hr=Lr.optional,Ur=Lr.oneOf,Vr=Lr.lazy,Jr=Nr().where((function(t){return t.length>0}),"Expected a non-empty string"),zr=qr({type:Br("window"),config:qr({appName:Jr,url:Hr(Jr)})}),Kr=qr({type:Br("group"),config:Fr(),children:Gr(Ur(zr))}),Yr=qr({type:Br("column"),config:Fr(),children:Gr(Ur(Kr,zr,Vr((function(){return Yr})),Vr((function(){return Zr}))))}),Zr=qr({type:Br("row"),config:Fr(),children:Gr(Ur(Yr,Kr,zr,Vr((function(){return Zr}))))}),$r=qr({type:Br("Workspace"),state:qr({config:Fr(),children:Gr(Ur(Zr,Yr,Kr,zr))})}),Xr=qr({type:Br("window"),componentType:Br("application"),state:qr({name:Fr(),context:Fr(),url:Jr,bounds:Fr(),id:Jr,parentId:Hr(Jr),main:Dr()})}),Qr=Ur(Br("Global"),Br("Workspace")),to=qr({name:Jr,context:Hr(Fr()),metadata:Hr(Fr())}),eo=qr({name:Jr,context:Hr(Fr()),closeRunningInstance:Hr(Dr())}),no=qr({name:Jr,type:Qr,context:Hr(Fr()),metadata:Hr(Fr()),components:Gr(Ur($r,Xr))}),io=function(){function t(t){this.controller=t}return t.prototype.getAll=function(t){return Qr.runWithException(t),this.controller.getAll(t)},t.prototype.get=function(t,e){return Jr.runWithException(t),Qr.runWithException(e),this.controller.get(t,e)},t.prototype.export=function(t){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(e){return t&&Qr.runWithException(t),[2,this.controller.export(t)]}))}))},t.prototype.import=function(t){return t.forEach((function(t){return no.runWithException(t)})),this.controller.import(t)},t.prototype.save=function(t){return to.runWithException(t),this.controller.save(t)},t.prototype.restore=function(t){return eo.runWithException(t),this.controller.restore(t)},t.prototype.remove=function(t,e){return Jr.runWithException(e),Qr.runWithException(t),this.controller.remove(t,e)},t}(),ro="___channel___",oo=function(){function t(t){this.contexts=t,this.setContextDataToEmptyObjIfMissing=function(t){return Gi(Gi({},t),{data:t.data||{}})}}return t.prototype.subscribe=function(t){this.callback=t},t.prototype.subscribeFor=function(t,e){var n=this;if(!this.isChannel(t))return Promise.reject(new Error("Channel with name: "+t+" doesn't exist!"));var i=this.createContextName(t);return this.contexts.subscribe(i,(function(t,i,r,o,s){var a=n.setContextDataToEmptyObjIfMissing(t);e(a.data,a,null==s?void 0:s.updaterId)}))},t.prototype.switchChannel=function(t){return Hi(this,void 0,void 0,(function(){var e,n,i=this;return Ui(this,(function(r){switch(r.label){case 0:return this.unsubscribe(),e=this.createContextName(t),n=this,[4,this.contexts.subscribe(e,(function(t,e,n,r,o){var s=i.setContextDataToEmptyObjIfMissing(t);i.callback&&i.callback(s.data,s,null==o?void 0:o.updaterId)}))];case 1:return n.unsubscribeFunc=r.sent(),[2]}}))}))},t.prototype.unsubscribe=function(){this.unsubscribeFunc&&this.unsubscribeFunc()},t.prototype.add=function(t,e){var n=this.createContextName(t);return this.contexts.set(n,e)},t.prototype.all=function(){return this.contexts.all().filter((function(t){return t.startsWith(ro)})).map((function(t){return t.substr(ro.length)}))},t.prototype.getContextData=function(t){var e=this;return new Promise((function(n,i){if(!e.isChannel(t))return i(new Error("A channel with name: "+t+" doesn't exist!"));var r=e.createContextName(t);e.contexts.subscribe(r,(function(t){var i=e.setContextDataToEmptyObjIfMissing(t);n(i)})).then((function(t){return t()}))}))},t.prototype.updateChannel=function(t,e){var n=this.createContextName(t),i={name:e.name,meta:e.meta};return(null==e?void 0:e.data)&&!this.isEmptyObject(e.data)&&(i.data=e.data),this.contexts.update(n,i)},t.prototype.updateData=function(t,e){var n=this.createContextName(t);if(this.contexts.setPathSupported){var i=Object.keys(e).map((function(t){return{path:"data."+t,value:e[t]}}));return this.contexts.setPaths(n,i)}return this.contexts.update(n,{data:e})},t.prototype.isChannel=function(t){return this.all().some((function(e){return e===t}))},t.prototype.createContextName=function(t){return"___channel___"+t},t.prototype.isEmptyObject=function(t){return 0===Object.keys(t).length&&t.constructor===Object},t}(),so=function(){function t(t,e){var n=this;this.subsKey="subs",this.changedKey="changed",this.registry=fr(),this.shared=new oo(t),this.shared.subscribe(this.handler.bind(this)),this.readyPromise=Promise.resolve(null==e?void 0:e.reduce((function(t,e){return t.then((function(){return n.add(e)}))}),Promise.resolve({})))}return t.prototype.subscribe=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.subsKey,t)},t.prototype.subscribeFor=function(t,e){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(n){switch(n.label){case 0:if("string"!=typeof t)throw new Error("Please provide the name as a string!");if("function"!=typeof e)throw new Error("Please provide the callback as a function!");return[4,this.shared.subscribeFor(t,e)];case 1:return[2,n.sent()]}}))}))},t.prototype.publish=function(t,e){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(n){if("object"!=typeof t)throw new Error("Please provide the data as an object!");if(e){if("string"!=typeof e)throw new Error("Please provide the name as a string!");if(!this.shared.isChannel(e))throw new Error("A channel with name: "+e+" doesn't exist!");return[2,this.shared.updateData(e,t)]}if(!this.currentContext)throw new Error("Not joined to any channel!");return[2,this.shared.updateData(this.currentContext,t)]}))}))},t.prototype.all=function(){var t=this.shared.all();return Promise.resolve(t)},t.prototype.list=function(){return Hi(this,void 0,void 0,(function(){var t,e=this;return Ui(this,(function(n){switch(n.label){case 0:return[4,this.all()];case 1:return t=n.sent(),[4,Promise.all(t.map((function(t){return e.get(t)})))];case 2:return[2,n.sent()]}}))}))},t.prototype.get=function(t){return"string"!=typeof t?Promise.reject(new Error("Please provide the channel name as a string!")):this.shared.getContextData(t)},t.prototype.join=function(t){return Hi(this,void 0,void 0,(function(){var e,n=this;return Ui(this,(function(i){switch(i.label){case 0:if("string"!=typeof t)throw new Error("Please provide the channel name as a string!");return(e=function(t){return n.shared.all().includes(t)})(t)?[3,2]:[4,new Promise((function(n,i){var r,o=setInterval((function(){e(t)&&(clearTimeout(r),clearInterval(o),n())}),100);r=setTimeout((function(){return clearInterval(o),i(new Error("A channel with name: "+t+" doesn't exist!"))}),3e3)}))];case 1:i.sent(),i.label=2;case 2:return this.currentContext=t,[4,this.shared.switchChannel(t)];case 3:return i.sent(),this.registry.execute(this.changedKey,t),[2]}}))}))},t.prototype.leave=function(){return this.currentContext=void 0,this.registry.execute(this.changedKey,void 0),this.shared.unsubscribe(),Promise.resolve()},t.prototype.current=function(){return this.currentContext},t.prototype.my=function(){return this.current()},t.prototype.changed=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.changedKey,t)},t.prototype.onChanged=function(t){return this.changed(t)},t.prototype.add=function(t){return Hi(this,void 0,void 0,(function(){var e;return Ui(this,(function(n){switch(n.label){case 0:if("object"!=typeof t)throw new Error("Please provide the info as an object!");if(void 0===t.name)throw new Error("info.name is missing!");if("string"!=typeof t.name)throw new Error("Please provide the info.name as a string!");if(void 0===t.meta)throw new Error("info.meta is missing!");if("object"!=typeof t.meta)throw new Error("Please provide the info.meta as an object!");if(void 0===t.meta.color)throw new Error("info.meta.color is missing!");if("string"!=typeof t.meta.color)throw new Error("Please provide the info.meta.color as a string!");return e={name:t.name,meta:t.meta,data:t.data||{}},[4,this.shared.updateChannel(t.name,e)];case 1:return n.sent(),[2,e]}}))}))},t.prototype.ready=function(){return this.readyPromise},t.prototype.handler=function(t,e,n){this.registry.execute(this.subsKey,t,e,n)},t}(),ao=function(t,e){return void 0===e&&(e=1e3),new Promise((function(n,i){var r=!1,o=setTimeout((function(){r=!0,i(new Error("Fetch request for: "+t+" timed out at: "+e+" milliseconds"))}),e);fetch(t).then((function(t){r||(clearTimeout(o),n(t))})).catch((function(t){r||(clearTimeout(o),i(t))}))}))},co=function(t,e,n){return new Promise((function(i,r){var o=setTimeout((function(){r(n||"Promise timeout hit: "+e)}),e);t().then((function(t){clearTimeout(o),i(t)})).catch((function(t){clearTimeout(o),r(t)}))}))},uo=function(){function t(t,e,n){var i,r,o,s,a=this;if(this._appManager=t,this._props=e,this._windows=n,this._registry=fr(),this.start=function(t,e){return co((function(){return a.startWithoutTimeout(t,e)}),3e3,'Application "'+a.name+'" start timeout!')},void 0===(null===(i=null==e?void 0:e.userProperties)||void 0===i?void 0:i.manifest))this._url=null===(o=null===(r=null==e?void 0:e.userProperties)||void 0===r?void 0:r.details)||void 0===o?void 0:o.url;else{var c=JSON.parse(e.userProperties.manifest);this._url=(null===(s=c.details)||void 0===s?void 0:s.url)||c.url}t.onInstanceStarted((function(t){t.application.name===a.name&&a._registry.execute("instanceStarted",t)})),t.onInstanceStopped((function(t){t.application.name===a.name&&a._registry.execute("instanceStopped",t)}))}return Object.defineProperty(t.prototype,"name",{get:function(){return this._props.name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._props.title||""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return this._props.version||""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"userProperties",{get:function(){return this._props.userProperties||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return e.application.name===t.name}))},enumerable:!0,configurable:!0}),t.prototype.onInstanceStarted=function(t){this._registry.add("instanceStarted",t)},t.prototype.onInstanceStopped=function(t){this._registry.add("instanceStopped",t)},t.prototype.updateFromProps=function(t){var e,n,i=this,r=void 0!==(null===(e=null==t?void 0:t.userProperties)||void 0===e?void 0:e.manifest)?JSON.parse(null==t?void 0:t.userProperties.manifest).url:null===(n=null==t?void 0:t.userProperties)||void 0===n?void 0:n.details.url;this._url=r,Object.keys(t).forEach((function(e){i._props[e]=t[e]}))},t.prototype.startWithoutTimeout=function(t,e){var n,i;return Hi(this,void 0,void 0,(function(){var r,o,s,a,c,u,d,p=this;return Ui(this,(function(h){switch(h.label){case 0:if(r=Gi(Gi(Gi({},null===(i=null===(n=this._props)||void 0===n?void 0:n.userProperties)||void 0===i?void 0:i.details),e),{context:t||(null==e?void 0:e.context)}),!this._url)throw new Error("Application "+this.name+" doesn't have a URL.");return c={},u=function(){if(void 0!==o){var t=c[o.id];if(void 0!==t)return s(),a(t)}},d=new Promise((function(t){a=t,s=p._appManager.onInstanceStarted((function(t){var e=t.agm.windowId;void 0!==e&&(c[e]=t,u())}))})),[4,this._windows.open(this.name,this._url,r)];case 1:return o=h.sent(),u(),[2,d]}}))}))},t}(),po=function(){function t(t,e,n,i,r){this.id=t,this.application=e,this.control=n,this.context=i,this.agm=r,this.WINDOW_DID_NOT_HAVE_TIME_TO_RESPOND="Peer has left while waiting for result"}return t.prototype.stop=function(){return Hi(this,void 0,void 0,(function(){var t;return Ui(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.callControl("stop",{},!1)];case 1:return e.sent(),[3,3];case 2:if((t=e.sent()).message!==this.WINDOW_DID_NOT_HAVE_TIME_TO_RESPOND)throw new Error(t);return[3,3];case 3:return[2]}}))}))},t.prototype.callControl=function(t,e,n){return void 0===n&&(n=!1),this.control.send({command:t,domain:"appManager",args:e,skipResult:n},{instance:this.id})},t}(),ho=function(){function t(t,e,n,i){this.id=t,this.control=e,this._appManager=n,this.agm=i,this.context={},this.startedByScript=!1,this.application=void 0,e.setLocalInstance(this)}return t.prototype.stop=function(){var t=this;return new Promise((function(e,n){if(t.startedByScript){var i=t._appManager.onInstanceStopped((function(n){n.id===t.id&&(i(),e())}));window.close()}else n("Can't close a window that wasn't started by a script.")}))},t}(),fo=Nr().where((function(t){return t.length>0}),"Expected a non-empty string"),lo=qr({url:Hr(fo)}),vo=qr({icon:Hr(fo)}),go=qr({name:fo,displayName:Hr(Nr()),contexts:Hr(Gr(Nr())),customConfig:Hr(qr())}),yo=qr({url:fo,top:Hr(Wr()),left:Hr(Wr()),width:Hr(Wr()),height:Hr(Wr()),context:Hr(Fr()),relativeTo:Hr(fo),relativeDirection:Hr(Ur(Br("top"),Br("left"),Br("right"),Br("bottom")))}),mo=qr({name:fo,title:Hr(Nr()),version:Hr(Nr()),appId:fo,manifest:fo,manifestType:fo,tooltip:Hr(Nr()),description:Hr(Nr()),contactEmail:Hr(Nr()),supportEmail:Hr(Nr()),publisher:Hr(Nr()),images:Hr(Gr(lo)),icons:Hr(Gr(vo)),customConfig:Hr(qr()),intents:Hr(Gr(go))}),wo=qr({name:fo,title:Hr(Nr()),version:Hr(Nr()),details:yo,customProperties:Hr(qr())}),bo=function(){function t(t,e,n,i,r){var o=this;this.windows=t,this.interop=e,this.control=n,this.config=i,this.appName=r,this._apps={},this._instances=[],this.registry=fr(),this.DEFAULT_POLLING_INTERVAL=3e3,this.OKAY_MESSAGE="OK",this.LOCAL_SOURCE="LOCAL_SOURCE";var s=e.instance.instance;if(this._myInstance=new ho(s,this.control,this,this.interop.instance),(null==i?void 0:i.remoteSources)&&(this.readyPromise=this.subscribeForRemoteApplications(i.remoteSources)),null==i?void 0:i.localApplications){var a=this.getValidatedApplications(i.localApplications);this.addApplications(a)}n.onStart((function(){o.trackInstanceLifetime()}))}return Object.defineProperty(t.prototype,"myInstance",{get:function(){return this.appName||console.warn("application wasn't provided to the GlueWeb factory function!"),this._myInstance||console.warn("The application isn't defined in any of the local/remote application sources!"),this._myInstance},enumerable:!0,configurable:!0}),t.prototype.application=function(t){var e;return null===(e=this._apps[t])||void 0===e?void 0:e.application},t.prototype.applications=function(){var t=this;return Object.keys(this._apps).map((function(e){return t._apps[e].application}))},t.prototype.instances=function(){return this._instances},t.prototype.onAppAdded=function(t){var e=this,n=Object.keys(this._apps).map((function(t){return e._apps[t].application}));return this.replay(n,t),this.registry.add("appAdded",t)},t.prototype.onAppRemoved=function(t){return this.registry.add("appRemoved",t)},t.prototype.onAppChanged=function(t){return this.registry.add("appChanged",t)},t.prototype.onInstanceStarted=function(t){return this.registry.add("instanceStarted",t)},t.prototype.onInstanceStopped=function(t){return this.registry.add("instanceStopped",t)},t.prototype.ready=function(){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,this.readyPromise];case 1:return t.sent(),[3,3];case 2:return t.sent(),[3,3];case 3:return[2]}}))}))},t.prototype.getValidatedApplications=function(t){return t.filter((function(t){var e;return(e=void 0!==t.manifest?mo.run(t).ok:wo.run(t).ok)||console.warn('Validation failed for application "'+t.name+'"!'),e}))},t.prototype.subscribeForRemoteApplications=function(t){return Hi(this,void 0,void 0,(function(){var e,n,i,r,o,s,a=this;return Ui(this,(function(c){switch(c.label){case 0:for(e=[],n=function(t){var n=t.url,r=function(){return Hi(a,void 0,void 0,(function(){var t,e;return Ui(this,(function(i){switch(i.label){case 0:return[4,ao(n,1e3)];case 1:return[4,i.sent().json()];case 2:return(t=i.sent()).message===this.OKAY_MESSAGE&&(e=this.getValidatedApplications(t.applications),this.addApplications(e,n)),[2]}}))}))};e.push(r()),setInterval((function(){return r().catch(console.warn)}),t.pollingInterval||i.DEFAULT_POLLING_INTERVAL)},i=this,r=0,o=t;r<o.length;r++)s=o[r],n(s);return[4,Promise.all(e)];case 1:return c.sent(),[2]}}))}))},t.prototype.getAppProps=function(t){var e=["name","title","version"],n=Object.fromEntries(Object.entries(t).filter((function(t){var n=t[0];return!e.includes(n)})));return{name:t.name,title:t.title,version:t.version,userProperties:n}},t.prototype.handleAppsChanged=function(t,e){for(var n=this,i=function(t){var i=Object.keys(r._apps).find((function(i){return i===t.name&&n._apps[i].source===e})),o=Object.keys(r._apps).find((function(i){return i===t.name&&n._apps[i].source!==e}));if(i){var s=r._apps[i],a=r.getAppProps(t);if(JSON.stringify(s.appProps)!==JSON.stringify(a)){var c=new uo(r,a,r.windows);r.registry.execute("appChanged",c),r._apps[t.name]={source:s.source,application:c,appProps:a}}}else o&&console.warn('Application "'+t.name+'" already defined by source "'+r._apps[o].source+'". Skipping application definition from source '+e+".")},r=this,o=0,s=t;o<s.length;o++){i(s[o])}},t.prototype.handleAppsAdded=function(t,e){for(var n=Object.keys(this._apps),i=0,r=t.filter((function(t){return!n.includes(t.name)}));i<r.length;i++){var o=r[i],s=this.getAppProps(o),a=new uo(this,s,this.windows);this.registry.execute("appAdded",a),this._apps[o.name]={source:e||this.LOCAL_SOURCE,application:a,appProps:s}}},t.prototype.handleAppsRemoved=function(t,e){for(var n=this,i=Object.keys(this._apps).filter((function(t){return n._apps[t].source===e})).map((function(t){return n._apps[t].application})),r=t.map((function(t){return t.name})),o=0,s=i.filter((function(t){return!r.includes(t.name)}));o<s.length;o++){var a=s[o];this.registry.execute("appRemoved",a),delete this._apps[a.name]}},t.prototype.tryPopulateMyInstanceApplication=function(){var t,e=this;if(this.appName){var n=null===(t=Object.values(this._apps).find((function(t){return t.application.name===e.appName})))||void 0===t?void 0:t.application;n&&(n.title&&(document.title=n.title),this._myInstance.application=n)}},t.prototype.addApplications=function(t,e){this.handleAppsChanged(t,e),this.handleAppsAdded(t,e),this.handleAppsRemoved(t,e),this._myInstance.application||this.tryPopulateMyInstanceApplication()},t.prototype.replay=function(t,e){(Array.isArray(t)?t:Object.values(t)).forEach((function(t){return e(t)}))},t.prototype.remoteFromServer=function(t){return Hi(this,void 0,void 0,(function(){var e,n,i,r,o;return Ui(this,(function(s){switch(s.label){case 0:return e=t.application,t.instance&&e&&this._apps[e]?(n=t.instance,i=this._apps[e].application,[4,null==(r=this.windows.list().find((function(e){return e.id===t.windowId})))?void 0:r.getContext()]):[2,void 0];case 1:return o=s.sent(),[2,new po(n,i,this.control,o,t)]}}))}))},t.prototype.trackInstanceLifetime=function(){var t=this;this.interop.serverMethodAdded((function(e){var n=e.server,i=e.method;return Hi(t,void 0,void 0,(function(){var t;return Ui(this,(function(e){switch(e.label){case 0:return i.name!==lr.CONTROL_METHOD?[2]:[4,this.remoteFromServer(n)];case 1:return(t=e.sent())&&(this._instances.push(t),this.registry.execute("instanceStarted",t)),[2]}}))}))})),this.interop.serverRemoved((function(e){return Hi(t,void 0,void 0,(function(){var t;return Ui(this,(function(n){switch(n.label){case 0:return[4,this.remoteFromServer(e)];case 1:return(t=n.sent())&&(this._instances=this._instances.filter((function(e){return e.id!==t.id})),this.registry.execute("instanceStopped",t)),[2]}}))}))}))},t}(),_o=function(){function t(t){this.interop=t}return t.prototype.raise=function(t){return Hi(this,void 0,void 0,(function(){var e,n,i=this;return Ui(this,(function(r){switch(r.label){case 0:if(!("Notification"in window))throw new Error("this browser does not support desktop notification");return[4,"granted"===Notification.permission?Promise.resolve("granted"):"denied"===Notification.permission?Promise.reject("no permissions from user"):Notification.requestPermission()];case 1:return r.sent(),e=this.raiseUsingWebApi(t),t.clickInterop&&(n=t.clickInterop,e.onclick=function(){var t,e;i.interop.invoke(n.method,null!==(t=null==n?void 0:n.arguments)&&void 0!==t?t:{},null!==(e=null==n?void 0:n.target)&&void 0!==e?e:"best")}),[2,e]}}))}))},t.prototype.raiseUsingWebApi=function(t){return new Notification(t.title,t)},t}(),Io="/glue",So="worker.js",xo="glue.config.json",ko={layouts:{autoRestore:!1,autoSaveWindowContext:!1},logger:"error",assets:{location:Io},channels:!1,appManager:!1,libraries:[]},Co=function(t){return Hi(void 0,void 0,void 0,(function(){var e,n,i,r,o;return Ui(this,(function(s){switch(s.label){case 0:if(!1===(null===(r=t.assets)||void 0===r?void 0:r.extendConfig)||!1===t.extends)return[2,{}];e=(null===(o=t.assets)||void 0===o?void 0:o.location)?t.assets.location+"/"+xo:"string"==typeof t.extends?t.extends:"/glue/glue.config.json",s.label=1;case 1:return s.trys.push([1,4,,5]),[4,ao(e)];case 2:return(n=s.sent()).ok?[4,n.json()]:[2,{}];case 3:return[2,null!=(i=s.sent())?i:{}];case 4:return s.sent(),[2,{}];case 5:return[2]}}))}))},Ao="T42.HC.GetSaveContext",To=function(){function t(t,e,n,i,r){var o,s;this.storage=t,this.windows=e,this.control=n,this.interop=i,this.autoSaveContext=null!==(s=null===(o=null==r?void 0:r.layouts)||void 0===o?void 0:o.autoSaveWindowContext)&&void 0!==s&&s,this.control.subscribe("layouts",this.handleControlMessage.bind(this)),this.registerRequestMethods()}return t.prototype.export=function(t){return Hi(this,void 0,void 0,(function(){var e,n,i;return Ui(this,(function(r){switch(r.label){case 0:return t?[2,this.storage.getAll(t)]:[4,Promise.all([this.storage.getAll("Global"),this.storage.getAll("Workspace")])];case 1:return e=r.sent(),n=e[0],i=e[1],[2,n.concat(i)]}}))}))},t.prototype.import=function(t){return Hi(this,void 0,void 0,(function(){var e=this;return Ui(this,(function(n){switch(n.label){case 0:return[4,Promise.all(t.map((function(t){return e.storage.store(t,t.type)})))];case 1:return n.sent(),[2]}}))}))},t.prototype.save=function(t,e){return void 0===e&&(e=!1),Hi(this,void 0,void 0,(function(){var n,i,r;return Ui(this,(function(o){switch(o.label){case 0:return n=this.windows.getChildWindows().map((function(t){return t.id})),[4,this.getRemoteWindowsInfo(n)];case 1:return(i=o.sent()).push(this.getLocalLayoutComponent(t.context,!0)),r={type:"Global",name:t.name,components:i,context:t.context||{},metadata:t.metadata||{}},e?(this.storage.storeAutoLayout(r),[3,4]):[3,2];case 2:return[4,this.storage.store(r,"Global")];case 3:o.sent(),o.label=4;case 4:return[2,r]}}))}))},t.prototype.autoSave=function(t){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(e){return[2,this.save(t,!0)]}))}))},t.prototype.restore=function(t){return Hi(this,void 0,void 0,(function(){var e;return Ui(this,(function(n){switch(n.label){case 0:return[4,this.storage.get(t.name,"Global")];case 1:if(!(e=n.sent()))throw new Error("can not find layout with name "+t.name);return this.restoreComponents(e),[2]}}))}))},t.prototype.restoreAutoSavedLayout=function(){return Hi(this,void 0,void 0,(function(){var t,e,n,i;return Ui(this,(function(r){switch(r.label){case 0:return t="_auto_"+document.location.href,[4,this.storage.getAutoLayout(t)];case 1:if(!(e=r.sent()))return[2,Promise.resolve()];if((n=this.windows.my()).parent)return[2];i=e.components.find((function(t){return t.state.main})),n.setContext(null==i?void 0:i.state.context);try{this.restoreComponents(e)}catch(t){return[2]}return[2]}}))}))},t.prototype.remove=function(t,e){return this.storage.remove(e,t)},t.prototype.getAll=function(t){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(e){switch(e.label){case 0:return[4,this.storage.getAll(t)];case 1:return[2,e.sent().map((function(t){return{name:t.name,type:t.type,context:t.context,metadata:t.metadata}}))]}}))}))},t.prototype.get=function(t,e){return this.storage.get(t,e)},t.prototype.getLocalLayoutComponent=function(t,e){var n;void 0===e&&(e=!1);var i=this.windows.my();try{this.autoSaveContext&&(n={windowContext:i.getContextSync()})}catch(t){}return{type:"window",componentType:"application",state:{name:i.name,context:(null==n?void 0:n.windowContext)||{},bounds:i.getBoundsSync(),url:window.document.location.href,id:i.id,parentId:i.parent,main:e}}},t.prototype.restoreComponents=function(t){var e=this;t.components.forEach((function(t){if("window"===t.type){var n=t.state;if(n.main)return;var i=Gi(Gi({},n.bounds),{context:n.context});e.windows.open(n.name,n.url,i)}}))},t.prototype.getRemoteWindowsInfo=function(t){return Hi(this,void 0,void 0,(function(){var e,n,i,r,o,s;return Ui(this,(function(a){switch(a.label){case 0:for(e=[],n=function(t){var n=i.interop.servers().find((function(e){return e.windowId===t}));if(!n||!n.getMethods)return"continue";if(n.getMethods().find((function(t){return t.name===Ao})))try{e.push(i.interop.invoke(Ao,{},{windowId:t}))}catch(t){}},i=this,r=0,o=t;r<o.length;r++)s=o[r],n(s);return[4,Promise.all(e)];case 1:return[2,a.sent().map((function(t){return t.returned}))]}}))}))},t.prototype.registerRequestMethods=function(){var t=this;this.interop.register(Ao,(function(e){return t.getLocalLayoutComponent(e)}))},t.prototype.handleControlMessage=function(t){return Hi(this,void 0,void 0,(function(){var e,n,i,r=this;return Ui(this,(function(o){switch(o.label){case 0:return"saveLayoutAndClose"!==(e=t).command?[3,3]:(n=e.args,[4,this.getRemoteWindowsInfo(n.childWindows)]);case 1:return(i=o.sent()).push(n.parentInfo),[4,this.storage.storeAutoLayout({type:"Global",name:n.layoutName,components:i,context:n.context||{},metadata:n.metadata||{}})];case 2:o.sent(),n.childWindows.forEach((function(t){var e;null===(e=r.windows.findById(t))||void 0===e||e.close()})),o.label=3;case 3:return[2]}}))}))},t}(),Po=function(){function t(t,e,n){this.localStore=t,this.autoStore=e,this.remoteStore=n}return t.prototype.get=function(t,e){var n;return Hi(this,void 0,void 0,(function(){var i,r;return Ui(this,(function(o){switch(o.label){case 0:return[4,null===(n=this.remoteStore)||void 0===n?void 0:n.get(t,e)];case 1:return i=o.sent(),[4,this.localStore.get(t,e)];case 2:return r=o.sent(),i&&r?[2,i]:[2,i||r]}}))}))},t.prototype.getAll=function(t){return Hi(this,void 0,void 0,(function(){var e,n,i,r,o=this;return Ui(this,(function(s){switch(s.label){case 0:return[4,Promise.all([this.localStore.getAll(t),new Promise((function(e){if(o.remoteStore)return o.remoteStore.getAll(t).then(e);e([])}))])];case 1:return e=s.sent(),n=e[0],i=e[1],r=n.filter((function(t){return!i.some((function(e){return e.name===t.name}))})),[2,i.concat(r)]}}))}))},t.prototype.store=function(t,e){var n;return Hi(this,void 0,void 0,(function(){return Ui(this,(function(i){switch(i.label){case 0:return[4,null===(n=this.remoteStore)||void 0===n?void 0:n.get(t.name,e)];case 1:if(i.sent())throw new Error("Cannot save layout with name: "+t.name+" and type: "+e+", because it is present in the remote store and is treated as readonly");return t.metadata?t.metadata.allowSave=!0:t.metadata={allowSave:!0},[4,this.localStore.store(t,e)];case 2:return i.sent(),[2]}}))}))},t.prototype.remove=function(t,e){var n;return Hi(this,void 0,void 0,(function(){return Ui(this,(function(i){switch(i.label){case 0:return[4,null===(n=this.remoteStore)||void 0===n?void 0:n.get(t,e)];case 1:if(i.sent())throw new Error("Cannot remove layout with name: "+t+" and type: "+e+", because it is present in the remote store and is treated as readonly");return[4,this.localStore.delete(t,e)];case 2:return i.sent(),[2]}}))}))},t.prototype.getAutoLayout=function(t){return this.autoStore.get(t,"Global")},t.prototype.storeAutoLayout=function(t){this.autoStore.save(t)},t}();let Mo,jo;const Oo=new WeakMap,Eo=new WeakMap,Ro=new WeakMap,Lo=new WeakMap,No=new WeakMap;let Wo={get(t,e,n){if(t instanceof IDBTransaction){if("done"===e)return Eo.get(t);if("objectStoreNames"===e)return t.objectStoreNames||Ro.get(t);if("store"===e)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return Bo(t[e])},set:(t,e,n)=>(t[e]=n,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function Do(t){return t!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(jo||(jo=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(qo(this),e),Bo(Oo.get(this))}:function(...e){return Bo(t.apply(qo(this),e))}:function(e,...n){const i=t.call(qo(this),e,...n);return Ro.set(i,e.sort?e.sort():[e]),Bo(i)}}function Fo(t){return"function"==typeof t?Do(t):(t instanceof IDBTransaction&&function(t){if(Eo.has(t))return;const e=new Promise((e,n)=>{const i=()=>{t.removeEventListener("complete",r),t.removeEventListener("error",o),t.removeEventListener("abort",o)},r=()=>{e(),i()},o=()=>{n(t.error||new DOMException("AbortError","AbortError")),i()};t.addEventListener("complete",r),t.addEventListener("error",o),t.addEventListener("abort",o)});Eo.set(t,e)}(t),((t,e)=>e.some(e=>t instanceof e))(t,Mo||(Mo=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(t,Wo):t)}function Bo(t){if(t instanceof IDBRequest)return function(t){const e=new Promise((e,n)=>{const i=()=>{t.removeEventListener("success",r),t.removeEventListener("error",o)},r=()=>{e(Bo(t.result)),i()},o=()=>{n(t.error),i()};t.addEventListener("success",r),t.addEventListener("error",o)});return e.then(e=>{e instanceof IDBCursor&&Oo.set(e,t)}).catch(()=>{}),No.set(e,t),e}(t);if(Lo.has(t))return Lo.get(t);const e=Fo(t);return e!==t&&(Lo.set(t,e),No.set(e,t)),e}const qo=t=>No.get(t);const Go=["get","getKey","getAll","getAllKeys","count"],Ho=["put","add","delete","clear"],Uo=new Map;function Vo(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(Uo.get(e))return Uo.get(e);const n=e.replace(/FromIndex$/,""),i=e!==n,r=Ho.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!r&&!Go.includes(n))return;const o=async function(t,...e){const o=this.transaction(t,r?"readwrite":"readonly");let s=o.store;i&&(s=s.index(e.shift()));const a=await s[n](...e);return r&&await o.done,a};return Uo.set(e,o),o}Wo=(t=>({...t,get:(e,n,i)=>Vo(e,n)||t.get(e,n,i),has:(e,n)=>!!Vo(e,n)||t.has(e,n)}))(Wo);var Jo=function(){function t(){if(!("indexedDB"in window))throw new Error("Cannot initialize the local storage, because IndexedDb is not supported")}return Object.defineProperty(t.prototype,"database",{get:function(){var t=this;return this._database?Promise.resolve(this._database):new Promise((function(e){(function(t,e,{blocked:n,upgrade:i,blocking:r,terminated:o}={}){const s=indexedDB.open(t,e),a=Bo(s);return i&&s.addEventListener("upgradeneeded",t=>{i(Bo(s.result),t.oldVersion,t.newVersion,Bo(s.transaction))}),n&&s.addEventListener("blocked",()=>n()),a.then(t=>{o&&t.addEventListener("close",()=>o()),r&&t.addEventListener("versionchange",()=>r())}).catch(()=>{}),a})("glue42core",1,{upgrade:t.setUpDb.bind(t)}).then((function(n){t._database=n,e(t._database)}))}))},enumerable:!0,configurable:!0}),t.prototype.getAll=function(t){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(e){switch(e.label){case 0:switch(t){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,e.sent().getAll("workspaceLayouts")];case 3:return[4,this.database];case 4:return[2,e.sent().getAll("globalLayouts")];case 5:throw new Error("The provided layout type is not recognized: "+t)}}))}))},t.prototype.delete=function(t,e){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(n){switch(n.label){case 0:switch(e){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,n.sent().delete("workspaceLayouts",t)];case 3:return[4,this.database];case 4:return[2,n.sent().delete("globalLayouts",t)];case 5:throw new Error("The provided layout type is not recognized: "+e)}}))}))},t.prototype.get=function(t,e){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(n){switch(n.label){case 0:switch(e){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,n.sent().get("workspaceLayouts",t)];case 3:return[4,this.database];case 4:return[2,n.sent().get("globalLayouts",t)];case 5:throw new Error("The provided layout type is not recognized: "+e)}}))}))},t.prototype.store=function(t,e){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(n){switch(n.label){case 0:switch(no.runWithException(t),Qr.runWithException(e),e){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,n.sent().put("workspaceLayouts",t,t.name)];case 3:return[4,this.database];case 4:return[2,n.sent().put("globalLayouts",t,t.name)];case 5:throw new Error("The provided layout type is not recognized: "+e)}}))}))},t.prototype.setUpDb=function(t){t.objectStoreNames.contains("workspaceLayouts")||t.createObjectStore("workspaceLayouts"),t.objectStoreNames.contains("globalLayouts")||t.createObjectStore("globalLayouts")},t}(),zo=function(){function t(t){this.storeBaseUrl=t}return t.prototype.getAll=function(t){return Hi(this,void 0,void 0,(function(){var e,n,i;return Ui(this,(function(r){switch(r.label){case 0:return Qr.runWithException(t),e=this.storeBaseUrl+"/glue.layouts.json",[4,this.fetchTimeout(e)];case 1:if(!(n=r.sent()).ok)return[2,[]];r.label=2;case 2:return r.trys.push([2,4,,5]),[4,n.json()];case 3:return i=r.sent(),[3,5];case 4:return r.sent(),[2,[]];case 5:return i?[2,(i["Global"===t?"globals":"workspaces"]||[]).filter((function(t){var e=no.run(t);return e.ok||console.warn("Fetched layout: "+t.name+" is discarded, because it failed the validation: "+JSON.stringify(e)),e.ok}))]:[2,[]]}}))}))},t.prototype.get=function(t,e){return Hi(this,void 0,void 0,(function(){return Ui(this,(function(n){switch(n.label){case 0:return[4,this.getAll(e)];case 1:return[2,n.sent().find((function(e){return e.name===t}))]}}))}))},t.prototype.fetchTimeout=function(t,e){return void 0===e&&(e=1e3),new Promise((function(n,i){var r=!1,o=setTimeout((function(){r=!0,i(new Error("Fetch request for: "+t+" timed out at: "+e+" milliseconds"))}),e);fetch(t).then((function(t){r||(clearTimeout(o),n(t))})).catch((function(t){r||(clearTimeout(o),i(t))}))}))},t}(),Ko=function(){function t(){}return t.prototype.get=function(t,e){return this.getObjectFromLocalStorage()[this.getKey(t,e)]},t.prototype.save=function(t){var e=this.getObjectFromLocalStorage();return e[this.getKey(t.name,t.type)]=t,this.setObjectToLocalStorage(e),t},t.prototype.remove=function(t,e){delete this.getObjectFromLocalStorage()[this.getKey(t,e)]},t.prototype.getObjectFromLocalStorage=function(){var e=window.localStorage.getItem(t.KEY);return e?JSON.parse(e):{}},t.prototype.setObjectToLocalStorage=function(e){window.localStorage.setItem(t.KEY,JSON.stringify(e))},t.prototype.getKey=function(t,e){return e+"_"+t},t.KEY="G0_layouts",t}(),Yo=function(t,e,n,i){var r=!1;window.addEventListener("beforeunload",(function(){Hi(void 0,void 0,void 0,(function(){var o,s,a,c,u;return Ui(this,(function(d){return r||(r=!0,(null===(u=null==e?void 0:e.layouts)||void 0===u?void 0:u.autoRestore)&&(o=t.windows.getChildWindows().map((function(t){return t.id})),s=o[0],a="_auto_"+document.location.href,o.length>0?(c={domain:"layouts",command:"saveLayoutAndClose",args:{childWindows:o,closeEveryone:!0,layoutName:a,context:{},metadata:{},parentInfo:null==i?void 0:i.getLocalLayoutComponent({},!0)}},n.send(c,{windowId:s})):null==i||i.autoSave({name:a})),t.done()),[2]}))}))}))},Zo=function(t,e){return(Zo=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function $o(t,e){function n(){this.constructor=t}Zo(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var Xo=function(){return(Xo=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function Qo(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){t.done?r(t.value):new n((function(e){e(t.value)})).then(s,a)}c((i=i.apply(t,e||[])).next())}))}function ts(t,e){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function es(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var i=Array(t),r=0;for(e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,r++)i[r]=o[s];return i}var ns=1,is=2,rs=3,os=4;function ss(t){return t.type===rs?"timestamp":t.type===is?"number":t.type===ns?"string":t.type===os?"object":"unknown"}function as(t){return t.constructor===Date?"timestamp":"number"==typeof t?"number":"string"==typeof t?"string":"object"==typeof t?"object":"string"}function cs(t){var e={},n=ss(t);if("object"===n){var i=Object.keys(t.value).reduce((function(e,n){var i=as(t.value[n]);if("object"===i){var r=function t(e){return Object.keys(e).reduce((function(n,i){var r=as(e[i]);return n[i]="object"===r?{type:"object",description:"",context:{},composite:t(e[i])}:{type:r,description:"",context:{}},n}),{})}(t.value[n]);e[n]={type:"object",description:"",context:{},composite:r}}else e[n]={type:i,description:"",context:{}};return e}),{});e.composite=i}return e.name=us(t.path.join("/")+"/"+t.name),e.type=n,e.description=t.description,e.context={},e}function us(t){return void 0!==t&&t.length>0&&"/"!==t[0]?"/"+t:t}function ds(t){return"timestamp"===ss(t)?Date.now():function t(e){if("object"!=typeof e)return e;return Object.keys(e).reduce((function(n,i){var r=e[i];return"object"==typeof r&&r.constructor!==Date?n[i]=t(r):r.constructor===Date?n[i]=new Date(r).getTime():r.constructor===Boolean?n[i]=r.toString():n[i]=r,n}),{})}(t.value)}function ps(t){var e=function t(e){return e.reduce((function(e,n){return e.concat(Array.isArray(n)?t(n):n)}),[])}(t.root.getAggregateState()),n=e.sort((function(t,e){return t.state?e.state?e.state-t.state:-1:1}))[0];return{description:function(t){var e="";return t.forEach((function(t,n,i){var r=t.path.join(".");n===i.length-1?e+=r+"."+t.name+": "+t.description:e+=r+"."+t.name+": "+t.description+","})),e.length>100?e.slice(0,100)+"...":e}(e),value:n.state}}var hs=function(t,e,n){if(null===t||"object"!=typeof t)throw new Error("Missing definition");if(null===e||"object"!=typeof e)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")},fs=function(){function t(t,e,n,i,r){this.definition=t,this.system=e,this.transport=n,this.value=i,this.type=r,this.path=[],hs(t,e,n),this.path=e.path.slice(0),this.path.push(e.name),this.name=t.name,this.description=t.description,n.createMetric(this)}return Object.defineProperty(t.prototype,"repo",{get:function(){var t;return null===(t=this.system)||void 0===t?void 0:t.repo},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),t.prototype.update=function(t){this.value=t,this.transport.updateMetric(this)},t}(),ls=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,is)||this}return $o(e,t),e.prototype.incrementBy=function(t){this.update(this.value+t)},e.prototype.increment=function(){this.incrementBy(1)},e.prototype.decrement=function(){this.incrementBy(-1)},e.prototype.decrementBy=function(t){this.incrementBy(-1*t)},e}(fs),vs=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,os)||this}return $o(e,t),e.prototype.update=function(t){this.mergeValues(t),this.transport.updateMetric(this)},e.prototype.mergeValues=function(t){var e=this;return Object.keys(this.value).forEach((function(n){void 0!==t[n]&&(e.value[n]=t[n])}))},e}(fs),gs=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,ns)||this}return $o(e,t),e}(fs),ys=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,rs)||this}return $o(e,t),e.prototype.now=function(){this.update(new Date)},e}(fs);var ms=function(){function t(t,e){e.init(this),this.root=function t(e,n,i,r,o){if(!n)throw new Error("Repository is required");if(!i)throw new Error("Transport is required");var s,a,c=i,u=e,d=o||"",p=n,h=r,f=function t(e){if(!e||!e.parent)return[];var n=t(e.parent);return n.push(e.name),n}(r),l={},v=(a="/",((s=f)&&s.length>0?s.join(a):"")+e),g=n.root,y=[],m=[];function w(t,e,n,i){var r={name:""};r="string"==typeof t?{name:t}:t;var o=m.filter((function(t){return t.name===r.name}));if(o.length>0){var s=o[0];if(s.type!==e)throw new Error("A metric named "+r.name+" is already defined with different type.");return void 0!==n&&s.update(n),s}var a=i(r);return m.push(a),a}var b={get name(){return u},get description(){return d},get repo(){return p},get parent(){return h},path:f,id:v,root:g,get subSystems(){return y},get metrics(){return m},subSystem:function(e,n){if(!e||0===e.length)throw new Error("name is required");var i=y.filter((function(t){return t.name===e}));if(i.length>0)return i[0];var r=t(e,p,c,b,n);return y.push(r),r},getState:function(){return l},setState:function(t,e){l={state:t,description:e},c.updateSystem(b,l)},stringMetric:function(t,e){return w(t,ns,e,(function(t){return new gs(t,b,c,e)}))},timestampMetric:function(t,e){return w(t,rs,e,(function(t){return new ys(t,b,c,e)}))},objectMetric:function(t,e){return w(t,os,e,(function(t){return new vs(t,b,c,e)}))},numberMetric:function(t,e){return w(t,is,e,(function(t){return new ls(t,b,c,e)}))},getAggregateState:function(){var t=[];return Object.keys(l).length>0&&t.push({name:u,path:f,state:l.state,description:l.description}),y.forEach((function(e){var n=e.getAggregateState();n.length>0&&t.push.apply(t,n)})),t}};return c.createSystem(b),b}("",this,e),this.addSystemMetrics(this.root,t.clickStream||void 0===t.clickStream)}return t.prototype.addSystemMetrics=function(t,e){if("undefined"!=typeof navigator&&t.stringMetric("UserAgent",navigator.userAgent),e&&"undefined"!=typeof document){var n=t.subSystem("ClickStream"),i=function(t){if(t.target){var e=t.target;n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:t.target?e.className:"",id:e.id,type:"<"+e.tagName.toLowerCase()+">",href:e.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",i):document.attachEvent("onclick",i)}t.stringMetric("StartTime",(new Date).toString());var r=t.stringMetric("StartURL",""),o=t.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;r.update(s)}void 0!==window.glue42gd&&o.update(window.glue42gd.appName)}},t}(),ws=function(){function t(){}return t.prototype.init=function(t){},t.prototype.createSystem=function(t){},t.prototype.updateSystem=function(t,e){},t.prototype.createMetric=function(t){},t.prototype.updateMetric=function(t){},t}(),bs=function(){function t(t,e,n){this.api=t,this.lastCount=0,this.initialPublishTimeout=1e4,this.publishInterval=6e4,this.initialPublishTimeout=null!=e?e:this.initialPublishTimeout,this.publishInterval=null!=n?n:this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}return t.prototype.scheduleCollection=function(){var t=this;setTimeout((function(){t.collect(),setInterval((function(){t.collect()}),t.publishInterval)}),this.initialPublishTimeout)},t.prototype.collect=function(){try{this.collectMemory(),this.collectEntries()}catch(t){}},t.prototype.collectMemory=function(){var t=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:t.totalJSHeapSize,usedJSHeapSize:t.usedJSHeapSize}))},t.prototype.collectEntries=function(){var t=window.performance.getEntries();t.length<=this.lastCount||(this.lastCount=t.length,this.system.stringMetric("entries",JSON.stringify(t)))},t}(),_s=function(t){var e;e=t.connection&&"object"==typeof t.connection?function(t,e){if(!t||"object"!=typeof t)throw new Error("Connection is required parameter");var n,i,r=function(t){o(t.root)},o=function(t){s(t),t.metrics.forEach((function(t){a(t)})),t.subSystems.forEach((function(t){o(t)}))},s=function(t){void 0!==t.parent&&n.then((function(){var e={type:"define",metrics:[{name:us(t.path.join("/")+"/"+t.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};i.send(e)}))},a=function(t){var e=u(t);n.then((function(){var t={type:"define",metrics:[cs(e)]};i.send(t),void 0!==e.value&&c(e)}))},c=function(t){if(d()){var e=ds(t),n={type:"publish",values:[{name:us(t.path.join("/")+"/"+t.name),value:e,timestamp:Date.now()}]};i.send(n)}},u=function(t){var e=Xo({},t);return"object"==typeof t.value&&null!==t.value&&(e.value=Xo({},t.value)),e},d=function(){var t;try{return(null!==(t=e.canUpdateMetric)&&void 0!==t?t:function(){return!0})()}catch(t){return!0}};return{init:function(o){var s;n=new Promise((function(t){s=t})),(i=t.domain("metrics")).onJoined((function(t){!t&&s&&(s(),s=void 0);var e={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};i.send(e),t&&r(o)})),i.join({system:e.system,service:e.service,instance:e.instance})},createSystem:s,updateSystem:function(e,r){n.then((function(){var n={type:"publish",values:[{name:us(e.path.join("/")+"/"+e.name+"/State"),value:{Description:r.description,Value:r.state},timestamp:Date.now()}]};i.send(n);var o=ps(e),s={type:"publish",peer_id:t.peerId,values:[{name:"/State",value:{Description:o.description,Value:o.value},timestamp:Date.now()}]};i.send(s)}))},createMetric:a,updateMetric:function(t){var e=u(t);n.then((function(){return c(e)}))}}}(t.connection,t):new ws;var n=new ms(t,e).root;t.disableAutoAppSystem||(n=n.subSystem("App"));var i=function(t){var e,n=t.subSystem("reporting"),i={name:"features"},r=function(t,r,o){if(void 0===t||""===t)throw new Error("name is mandatory");if(void 0===r||""===r)throw new Error("action is mandatory");if(void 0===o||""===o)throw new Error("payload is mandatory");e?e.update({name:t,action:r,payload:o}):e=n.objectMetric(i,{name:t,action:r,payload:o})};return t.featureMetric=r,t}(n);return function(t,e){var n,i;if("undefined"==typeof window)return;var r=null===(i=null===(n=null===window||void 0===window?void 0:window.glue42gd)||void 0===n?void 0:n.metrics)||void 0===i?void 0:i.pagePerformanceMetrics;r&&(e=r);(null==e?void 0:e.enabled)&&new bs(t,e.initialPublishTimeout,e.publishInterval)}(i,t.pagePerformanceMetrics),i};function Is(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function i(n,i){var r=n instanceof Error?n:new Error(n);if(e)e(r);else{var o='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+r.stack;if(t)switch(t.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(t,e,r){var o=n[t];return o||(o=[],n[t]=o),o.push(e),r&&setTimeout((function(){r.forEach((function(r){var o;if(null===(o=n[t])||void 0===o?void 0:o.includes(e))try{Array.isArray(r)?e.apply(void 0,r):e.apply(void 0,[r])}catch(e){i(e,t)}}))}),0),function(){var i=n[t];i&&(i=i.reduce((function(t,n,i){return n===e&&t.length===i||t.push(n),t}),[]),n[t]=i)}},execute:function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var o=n[t];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var r=n.apply(void 0,e);s.push(r)}catch(e){s.push(void 0),i(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}Is.default=Is;var Ss=Is,xs=function(){function t(t,e){var n=this;this.registry=Ss(),this.gw=t.facade,this.gw.connect((function(t,e){n.messageHandler(e)})).then((function(t){n.client=t}))}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.client?(this.client.send(t),Promise.resolve(void 0)):Promise.reject("not connected")},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"in-memory"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),ks=function(){function t(t,e){var n=this;this.logger=e,this.registry=Ss(),this.worker=new SharedWorker(t),this.worker.port.onmessage=function(t){n.messageHandler(t.data)}}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.worker.port.postMessage(t),Promise.resolve()},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"shared-worker"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),Cs=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?void 0:t}},t.isNode=function(){if(void 0!==t._isNode)return t._isNode;if("undefined"!=typeof window)return t._isNode=!1,!1;try{t._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(e){t._isNode=!1}return t._isNode},t}(),As=function(){function t(){var t=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(e,n){t.resolve=function(n){t.resolved=!0,e(n)},t.reject=function(e){t.rejected=!0,n(e)}}))}return t.delay=function(t){return new Promise((function(e){return setTimeout(e,t)}))},Object.defineProperty(t.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),t}(),Ts={};function Ps(t){var e=Ts[t];if(e)return e;var n=[];function i(){return(new Date).getTime()}var r,o,s=i();function a(t,e){var r=null!=e?e:i(),o=0;n.length>0&&(o=r-n[n.length-1].time),n.push({name:t,time:r,diff:o})}a("start",s);var c={get startTime(){return s},get endTime(){return r},get period(){return o},stop:function(){return a("end",r=i()),o=r-s},mark:a,marks:n};return Ts[t]=c,c}var Ms=Cs.isNode()?require:function(){},js=Cs.isNode()?Ms("ws"):window.WebSocket,Os=function(){function t(t,e){if(this.startupTimer=Ps("connection"),this._running=!0,this._registry=Ss(),this.wsRequests=[],this.settings=t,this.logger=e,!this.settings.ws)throw new Error("ws is missing")}return t.prototype.onMessage=function(t){return this._registry.add("onMessage",t)},t.prototype.send=function(t,e){var n=this;return new Promise((function(e,i){n.waitForSocketConnection((function(){var r;try{null===(r=n.ws)||void 0===r||r.send(t),e()}catch(t){i(t)}}),i)}))},t.prototype.open=function(){var t=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(e,n){t.waitForSocketConnection(e,n)}))},t.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},t.prototype.onConnectedChanged=function(t){return this._registry.add("onConnectedChanged",t)},t.prototype.name=function(){return"ws "+this.settings.ws},t.prototype.reconnect=function(){var t;null===(t=this.ws)||void 0===t||t.close();var e=new As;return this.waitForSocketConnection((function(){e.resolve()})),e.promise},t.prototype.waitForSocketConnection=function(t,e){var n;e=null!=e?e:function(){},this._running?1!==(null===(n=this.ws)||void 0===n?void 0:n.readyState)?(this.wsRequests.push({callback:t,failed:e}),this.wsRequests.length>1||this.openSocket()):t():e("wait for socket on "+this.settings.ws+" failed - socket closed by user")},t.prototype.openSocket=function(t,e){return Qo(this,void 0,void 0,(function(){var n=this;return ts(this,(function(i){switch(i.label){case 0:if(this.startupTimer.mark("opening-socket"),void 0===t&&(t=this.settings.reconnectInterval),void 0!==e){if(0===e)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+e+" more times (every "+t+" ms)")}i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return i.sent(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState(),[3,4];case 3:return i.sent(),setTimeout((function(){var i=void 0===e?void 0:e-1;n.openSocket(t,i)}),t),[3,4];case 4:return[2]}}))}))},t.prototype.initiateSocket=function(){var t=this,e=new As;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new js(this.settings.ws||""),this.ws.onerror=function(n){var i="";try{i=JSON.stringify(n)}catch(t){var r=new WeakSet;i=JSON.stringify(n,(function(t,e){if("object"==typeof e&&null!==e){if(r.has(e))return;r.add(e)}return e}))}e.reject("error"),t.notifyStatusChanged(!1,i)},this.ws.onclose=function(n){t.logger.info("ws closed "+n),e.reject("closed"),t.notifyStatusChanged(!1)},this.ws.onopen=function(){var n;t.startupTimer.mark("ws-opened"),t.logger.info("ws opened "+(null===(n=t.settings.identity)||void 0===n?void 0:n.application)),e.resolve(),t.notifyStatusChanged(!0)},this.ws.onmessage=function(e){t._registry.execute("onMessage",e.data)},e.promise},t.prototype.notifyForSocketState=function(t){this.wsRequests.forEach((function(e){t?e.failed&&e.failed(t):e.callback()})),this.wsRequests=[]},t.prototype.notifyStatusChanged=function(t,e){this._registry.execute("onConnectedChanged",t,e)},t}();var Es=1;var Rs,Ls,Ns,Ws={nextValue:function(){return(Es=(9301*Es+49297)%233280)/233280},seed:function(t){Es=t}},Ds="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function Fs(){Ns=!1}function Bs(t){if(t){if(t!==Rs){if(t.length!==Ds.length)throw new Error("Custom alphabet for shortid must be "+Ds.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+Ds.length+" unique characters. These characters were not unique: "+e.join(", "));Rs=t,Fs()}}else Rs!==Ds&&(Rs=Ds,Fs())}function qs(){return Ns||(Ns=function(){Rs||Bs(Ds);for(var t,e=Rs.split(""),n=[],i=Ws.nextValue();e.length>0;)i=Ws.nextValue(),t=Math.floor(i*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var Gs={characters:function(t){return Bs(t),Rs},seed:function(t){Ws.seed(t),Ls!==t&&(Fs(),Ls=t)},lookup:function(t){return qs()[t]},shuffled:qs},Hs="object"==typeof window&&(window.crypto||window.msCrypto);var Us=function(){if(!Hs||!Hs.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return Hs.getRandomValues(t),48&t[0]};var Vs=function(t,e){for(var n,i=0,r="";!n;)r+=t(e>>4*i&15|Us()),n=e<Math.pow(16,i+1),i++;return r};var Js=function(t){var e=Gs.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var zs=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=Gs.characters(),n=t.length,i=0;i<n;i++)if(-1===e.indexOf(t[i]))return!1;return!0},Ks=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e,n,i=0;function r(){var t="",r=Math.floor(.001*(Date.now()-1459707606518));return r===n?e++:(e=0,n=r),t+=Vs(Gs.lookup,6),t+=Vs(Gs.lookup,i),e>0&&(t+=Vs(Gs.lookup,e)),t+=Vs(Gs.lookup,r)}t.exports=r,t.exports.generate=r,t.exports.seed=function(e){return Gs.seed(e),t.exports},t.exports.worker=function(e){return i=e,t.exports},t.exports.characters=function(t){return void 0!==t&&Gs.characters(t),Gs.shuffled()},t.exports.decode=Js,t.exports.isValid=zs})),Ys=(Ks.generate,Ks.seed,Ks.worker,Ks.characters,Ks.decode,Ks.isValid,Ks);function Zs(t,e,n,i,r){null==t&&(t="global"),i=i||["success"],r=r||["error"];var o,s=!1,a=!1,c=!1,u=Ss();e.disconnected((function(){c=!1,n.debug("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),e.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),p(o))})),e.on("success",(function(t){return f(t)})),e.on("error",(function(t){return h(t)})),e.on("result",(function(t){return f(t)})),i&&i.forEach((function(t){e.on(t,(function(t){return f(t)}))})),r&&r.forEach((function(t){e.on(t,(function(t){return h(t)}))}));var d={};function p(e){return o=e,new Promise((function(i,r){if(s)i();else{var o;if("global"===t)o=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining domain "+t),o=v({type:"join",destination:t,domain:"global",options:e});o.then((function(){!function(){n.debug("did join "+t),s=!0;var e=a;a=!1,u.execute("onJoined",e)}(),i()})).catch((function(e){n.debug("error joining "+t+" domain: "+JSON.stringify(e)),r(e)}))}}))}function h(e){if(t===e.domain){var n=e.request_id;if(n){var i=d[n];i&&i.error(e)}}}function f(e){if(e.domain===t){var n=e.request_id;if(n){var i=d[n];i&&i.success(e)}}}function l(){return Ys()}function v(i,r,o){o=o||{},i.request_id=i.request_id||l(),i.domain=i.domain||t,o.skipPeerId||(i.peer_id=e.peerId);var s=i.request_id;return new Promise((function(t,a){d[s]={success:function(e){delete d[s],e._tag=r,t(e)},error:function(t){n.warn("GW error - "+JSON.stringify(t)+" for request "+JSON.stringify(i)),delete d[s],t._tag=r,a(t)}},e.send(i,o).catch((function(t){d[s].error({err:t})}))}))}return{join:p,leave:function(){return"global"===t?Promise.resolve():(n.debug("stopping session "+t+"..."),a=!1,v({type:"leave",destination:t,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})))},onJoined:function(t){return s&&t(!1),u.add("onJoined",t)},onLeft:function(t){return s||t(),u.add("onLeft",t)},send:v,sendFireAndForget:function(n){n.request_id=n.request_id?n.request_id:l(),n.domain=n.domain||t,n.peer_id=e.peerId,e.send(n)},on:function(i,r){e.on(i,(function(e){if(e.domain===t)try{r(e)}catch(t){n.error("Callback  failed: "+t+" \n "+t.stack+" \n msg was: "+JSON.stringify(e),t)}}))},loggedIn:function(t){return e.loggedIn(t)},connected:function(t){return e.connected(t)},disconnected:function(t){return e.disconnected(t)},get peerId(){return e.peerId},get domain(){return t}}}var $s=function(){function t(t,e,n){var i=this;this.connection=t,this.settings=e,this.logger=n,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=Ss(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],t.disconnected((function(){i.handleDisconnected()})),this.ping()}return Object.defineProperty(t.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.processStringMessage=function(t){var e=this,n=JSON.parse(t,(function(t,n){if("string"!=typeof n)return n;if(n.length<e.dateMinLen)return n;if(n[0]!==e.datePrefixFirstChar)return n;if(n.substring(0,e.datePrefixLen)!==e.datePrefix)return n;try{var i=parseInt(n.substring(e.datePrefixLen,n.length),10);return isNaN(i)?n:new Date(i)}catch(t){return n}}));return{msg:n,msgType:n.type}},t.prototype.createStringMessage=function(t){var e=Date.prototype.toJSON;try{var n=this.datePrefix;return Date.prototype.toJSON=function(){return n+this.getTime()},JSON.stringify(t)}finally{Date.prototype.toJSON=e}},t.prototype.processObjectMessage=function(t){if(!t.type)throw new Error("Object should have type property");return{msg:t,msgType:t.type}},t.prototype.createObjectMessage=function(t){return t},t.prototype.login=function(t,e){return Qo(this,void 0,void 0,(function(){var n,i,r,o,s,a,c,u,d,p;return ts(this,(function(h){switch(h.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=t,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,n={},this.connection.gatewayToken=t.gatewayToken,!t.gatewayToken)return[3,5];if(!e)return[3,4];h.label=1;case 1:return h.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return u=h.sent(),t.gatewayToken=u,[3,4];case 3:return i=h.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==i?void 0:i.message)||i)),[3,4];case 4:return n.method="gateway-token",n.token=t.gatewayToken,this.connection.gatewayToken=t.gatewayToken,[3,10];case 5:return"sspi"!==t.flowName?[3,9]:(n.provider="win",n.method="access-token",t.flowCallback&&t.sessionId?(r=n,[4,t.flowCallback(t.sessionId,null)]):[3,7]);case 6:return r.token=h.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(t.token)n.method="access-token",n.token=t.token;else{if(!t.username)throw new Error("invalid auth message"+JSON.stringify(t));n.method="secret",n.login=t.username,n.secret=t.password}h.label=10;case 10:o={type:"hello",identity:this.settings.identity,authentication:n},t.sessionId&&(o.request_id=t.sessionId),this.globalDomain=Zs("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),s={skipPeerId:!0},this.initialLogin&&(s.retryInterval=this.settings.reconnectInterval,s.maxRetries=this.settings.reconnectAttempts),h.label=11;case 11:h.trys.push([11,19,20,21]),a=void 0,h.label=12;case 12:return[4,this.globalDomain.send(o,void 0,s)];case 13:return"authentication-request"!==(c=h.sent()).type?[3,16]:(u=Buffer.from(c.authentication.token,"base64"),t.flowCallback&&t.sessionId?(d=o.authentication,[4,t.flowCallback(t.sessionId,u)]):[3,15]);case 14:d.token=h.sent().data.toString("base64"),h.label=15;case 15:return o.request_id=t.sessionId,[3,12];case 16:if("welcome"===c.type)return a=c,[3,18];throw"error"===c.type?new Error("Authentication failed: "+c.reason):new Error("Unexpected message type during authentication: "+c.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.info("login successful with peerId "+a.peer_id),this.connection.peerId=a.peer_id,this.connection.resolvedIdentity=a.resolved_identity,this.connection.availableDomains=a.available_domains,a.options&&(this.connection.token=a.options.access_token,this.connection.info=a.options.info),this.setLoggedIn(!0),[2,a.resolved_identity];case 19:throw p=h.sent(),this.logger.error("error sending hello message - "+(p.message||p.msg||p.reason||p),p),p;case 20:return t&&t.flowCallback&&t.sessionId&&t.flowCallback(t.sessionId,null),[7];case 21:return[2]}}))}))},t.prototype.logout=function(){return Qo(this,void 0,void 0,(function(){var t;return ts(this,(function(e){switch(e.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),t=this.sessions.map((function(t){t.leave()})),[4,Promise.all(t)];case 1:return e.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this._isLoggedIn&&t(),this.registry.add("onLoggedIn",t)},t.prototype.domain=function(t,e,n,i){var r=this.sessions.filter((function(e){return e.domain===t}))[0];return r||(r=Zs(t,this.connection,e,n,i),this.sessions.push(r)),r},t.prototype.handleDisconnected=function(){var t=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(t.handleDisconnected,1e3)}))}},t.prototype.setLoggedIn=function(t){this._isLoggedIn=t,this._isLoggedIn&&this.registry.execute("onLoggedIn")},t.prototype.ping=function(){var t=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){t.ping()}),3e4))},t.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(t){return t.token})):Promise.reject(new Error("no global domain session"))},t.prototype.getNewGWToken=function(){if(void 0!==typeof window){var t=window.glue42gd;if(t)return t.getGWToken()}return Promise.reject(new Error("not running in GD"))},t}(),Xs=function(){function t(t){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var e=0,n=t;e<n.length;e++){var i=n[e];this.specs[i.name]=i,this.specsNames.push(i.name)}}return t.prototype.init=function(t){var e=this;this.connection=t;for(var n=0,i=this.specsNames;n<i.length;n++)for(var r=i[n],o=function(n){var i=s.subsRefCount[n];if(i||(i=0),i+=1,s.subsRefCount[n]=i,i>1)return"continue";var r=t.on(n,(function(t){return e.processMessage(n,t)}));s.subs[n]=r},s=this,a=0,c=this.specs[r].types;a<c.length;a++){o(c[a])}},t.prototype.processMessage=function(t,e){if(!this.isDone&&e)for(var n=0,i=this.specsNames;n<i.length;n++){var r=i[n];if(-1!==this.specs[r].types.indexOf(t)){var o=this.messages[r]||[];this.messages[r]=o,o.push(e)}}},t.prototype.drain=function(t,e){var n;e&&(this.messages[t]||[]).forEach(e),delete this.messages[t];for(var i=0,r=this.specs[t].types;i<r.length;i++){var o=r[i];this.subsRefCount[o]-=1,this.subsRefCount[o]<=0&&(null===(n=this.connection)||void 0===n||n.off(this.subs[o]),delete this.subs[o],delete this.subsRefCount[o])}delete this.specs[t],this.specs.length||(this.isDone=!0)},t}(),Qs=function(){function t(t,e){if(this.settings=t,this.logger=e,this.messageHandlers={},this.ids=1,this.registry=Ss(),this._connected=!1,this.isTrace=!1,(t=t||{}).reconnectAttempts=t.reconnectAttempts||10,t.reconnectInterval=t.reconnectInterval||1e3,t.inproc)this.transport=new xs(t.inproc,e.subLogger("inMemory"));else if(t.sharedWorker)this.transport=new ks(t.sharedWorker,e.subLogger("shared-worker"));else{if(void 0===t.ws)throw new Error("No connection information specified");this.transport=new Os(t,e.subLogger("ws"))}this.isTrace=e.canPublish("trace"),e.info("starting with "+this.transport.name()+" transport"),this.protocol=new $s(this,t,e.subLogger("protocol")),this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this.transport.onMessage(this.handleTransportMessage.bind(this)),t.replaySpecs&&t.replaySpecs.length&&(this.replayer=new Xs(t.replaySpecs),this.replayer.init(this))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;return null===(t=this.protocol)||void 0===t?void 0:t.protocolVersion},enumerable:!0,configurable:!0}),t.prototype.send=function(t,e){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var n=this.protocol.createObjectMessage(t);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(n)),this.transport.sendObject(n,e)}var i=this.protocol.createStringMessage(t);return this.isTrace&&this.logger.trace(">> "+i),this.transport.send(i,e)},t.prototype.on=function(t,e){t=t.toLowerCase(),void 0===this.messageHandlers[t]&&(this.messageHandlers[t]={});var n=this.ids++;return this.messageHandlers[t][n]=e,{type:t,id:n}},t.prototype.off=function(t){delete this.messageHandlers[t.type.toLowerCase()][t.id]},Object.defineProperty(t.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.connected=function(t){var e=this;return this.protocol.loggedIn((function(){t(e.settings.ws||e.settings.sharedWorker||"")}))},t.prototype.disconnected=function(t){return this.registry.add("disconnected",t)},t.prototype.login=function(t,e){return Qo(this,void 0,void 0,(function(){var n;return ts(this,(function(i){switch(i.label){case 0:return[4,this.transport.open()];case 1:return i.sent(),Ps("connection").mark("transport-opened"),n=this.protocol.login(t,e),Ps("connection").mark("protocol-logged-in"),[2,n]}}))}))},t.prototype.logout=function(){return Qo(this,void 0,void 0,(function(){return ts(this,(function(t){switch(t.label){case 0:return[4,this.protocol.logout()];case 1:return t.sent(),[4,this.transport.close()];case 2:return t.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this.protocol.loggedIn(t)},t.prototype.domain=function(t,e,n){return this.protocol.domain(t,this.logger.subLogger("domain="+t),e,n)},t.prototype.authToken=function(){return this.protocol.authToken()},t.prototype.reconnect=function(){return this.transport.reconnect()},t.prototype.distributeMessage=function(t,e){var n=this,i=this.messageHandlers[e.toLowerCase()];void 0!==i&&Object.keys(i).forEach((function(e){var r=i[e];if(void 0!==r)try{r(t)}catch(t){try{n.logger.error("Message handler failed with "+t.stack,t)}catch(e){console.log("Message handler failed",t)}}}))},t.prototype.handleConnectionChanged=function(t){this._connected!==t&&(this._connected=t,t?this.registry.execute("connected"):this.registry.execute("disconnected"))},t.prototype.handleTransportMessage=function(t){var e;e="string"==typeof t?this.protocol.processStringMessage(t):this.protocol.processObjectMessage(t),this.isTrace&&this.logger.trace("<< "+JSON.stringify(e)),this.distributeMessage(e.msg,e.msgType)},t}(),ta=["trace","debug","info","warn","error","off"],ea=function(){function t(t,e,n){this.name=t,this.parent=e,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=t,this.path=e?e.path+"."+t:t,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}return t.prototype.subLogger=function(e){var n=this.subLoggers.filter((function(t){return t.name===e}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(t){if(t===e)throw new Error("This sub logger name is not allowed.")}));var i=new t(e,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(i),i},t.prototype.publishLevel=function(t){var e;return t&&(this._publishLevel=t),this._publishLevel||(null===(e=this.parent)||void 0===e?void 0:e.publishLevel())},t.prototype.consoleLevel=function(t){var e;return t&&(this._consoleLevel=t),this._consoleLevel||(null===(e=this.parent)||void 0===e?void 0:e.consoleLevel())},t.prototype.log=function(t,e,n){this.publishMessage(e||"info",t,n)},t.prototype.trace=function(t){this.log(t,"trace")},t.prototype.debug=function(t){this.log(t,"debug")},t.prototype.info=function(t){this.log(t,"info")},t.prototype.warn=function(t){this.log(t,"warn")},t.prototype.error=function(t,e){this.log(t,"error")},t.prototype.canPublish=function(t,e){return ta.indexOf(t)>=ta.indexOf(e||this.consoleLevel()||"trace")},t.prototype.publishMessage=function(e,n,i){var r=this.loggerFullName;if("error"===e&&!i){var o=new Error;o.stack&&(n=n+"\n"+o.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(e,this.publishLevel())){var s=t.Interop;if(s)try{s.methods({name:t.InteropMethodName}).length>0&&s.invoke(t.InteropMethodName,{msg:""+n,logger:r,level:e})}catch(t){}}if(this.canPublish(e)){var a="";if(this.includeTimeAndLevel){var c=new Date;a="["+(c.getHours()+":"+c.getMinutes()+":"+c.getSeconds()+":"+c.getMilliseconds())+"] ["+e+"] "}var u=""+a+r+": "+n;switch(e){case"trace":this.logFn.debug(u);break;case"debug":this.logFn.debug?this.logFn.debug(u):this.logFn.log(u);break;case"info":this.logFn.info(u);break;case"warn":this.logFn.warn(u);break;case"error":this.logFn.error(u,i)}}},t.InteropMethodName="T42.AppLogger.Log",t}(),na="create-context",ia="created",ra="destroyed",oa="context-created",sa="context-added",aa="subscribe-context",ca="subscribed-context",ua="unsubscribe-context",da="destroy-context",pa="context-destroyed",ha="update-context",fa="context-updated",la="joined",va={get name(){return"context"},get types(){return[na,ia,ra,oa,sa,aa,ca,ua,da,pa,ha,fa,la]}},ga="5.2.1";function ya(t,e,n){var i,r,o,s,a;if(Cs.isNode()){var c=process.env._GD_STARTING_CONTEXT_;if(c)try{a=JSON.parse(c)}catch(t){}}var u=function(){var i,r,o,s,c,u,d,p,h,f=t.gateway,l=null!==(i=null==f?void 0:f.protocolVersion)&&void 0!==i?i:3,v=null==f?void 0:f.reconnectInterval,g=null==f?void 0:f.reconnectAttempts,y=null==f?void 0:f.ws,m=null==f?void 0:f.sharedWorker,w=null==f?void 0:f.inproc;n&&(y=n.gwURL),Cs.isNode()&&a&&a.gwURL&&(y=a.gwURL),y||m||w||(y="ws://localhost:8385");var b=function(){if(t.application)return t.application;if(n)return n.applicationName;var e=Ys();if(Cs.isNode())return a?a.applicationConfig.name:"NodeJS"+e;if("undefined"!=typeof window&&"undefined"!=typeof document)return document.title+" ("+e+")";return e}(),_=b;void 0!==n?(u=n.windowId,d=n.pid,n.env&&(p=n.env.env,h=n.env.region),_=null!==(r=n.application)&&void 0!==r?r:"glue-app",c=n.appInstanceId):Cs.isNode()?(d=process.pid,a&&(p=a.env,h=a.region,c=a.instanceId)):u=window.name||Ys();var I=null!==(s=null===(o=t.gateway)||void 0===o?void 0:o.replaySpecs)&&void 0!==s?s:[];return I.push(va),{identity:{application:_,applicationName:b,windowId:u,instance:c,process:d,region:h,environment:p,api:e.version||ga},reconnectInterval:v,ws:y,sharedWorker:m,inproc:w,protocolVersion:l,reconnectAttempts:g,replaySpecs:I}}();return{bus:null!==(i=t.bus)&&void 0!==i&&i,auth:function(){var e,n;return"string"==typeof t.auth?{token:t.auth}:t.auth?t.auth:Cs.isNode()&&a&&a.gwToken?{gatewayToken:a.gwToken}:(null===(e=t.gateway)||void 0===e?void 0:e.inproc)||(null===(n=t.gateway)||void 0===n?void 0:n.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var e,i,r,o=t.logger,s="warn";return o||(o=s),n&&(r=n.consoleLogLevel),"string"==typeof o?{console:null!=r?r:o,publish:s}:{console:null!==(e=null!=r?r:o.console)&&void 0!==e?e:s,publish:null!==(i=o.publish)&&void 0!==i?i:s}}(),connection:u,metrics:null===(r=t.metrics)||void 0===r||r,contexts:null===(o=t.contexts)||void 0===o||o,version:e.version||ga,libs:null!==(s=e.libs)&&void 0!==s?s:[],customLogger:t.customLogger}}var ma=function(){function t(t,e,n,i){this.updateCallbacks={},this.contextId=t,this.name=e,this.isAnnounced=n,this.activityId=i,this.context={}}return t.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},t.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},t}();function wa(t,e,n){try{if((null==n?void 0:n.canPublish("trace"))&&(null==n||n.trace("applying context delta "+JSON.stringify(e)+" on context "+JSON.stringify(t))),!e)return t;if(e.reset)return t=Xo({},e.reset);if(t=ba(t,void 0),e.commands){for(var i=0,r=e.commands;i<r.length;i++){var o=r[i];"remove"===o.type?xa(t,o.path):"set"===o.type&&Sa(t,o.value,o.path)}return t}var s=e.added,a=e.updated,c=e.removed;return s&&Object.keys(s).forEach((function(e){t[e]=s[e]})),a&&Object.keys(a).forEach((function(e){_a(e,t,a)})),c&&c.forEach((function(e){delete t[e]})),t}catch(i){return null==n||n.error("error applying context delta "+JSON.stringify(e)+" on context "+JSON.stringify(t),i),t}}function ba(t,e){if(e=e||new WeakMap,Object(t)!==t)return t;if(t instanceof Set)return new Set(t);if(e.has(t))return e.get(t);var n=t instanceof Date?new Date(t):t instanceof RegExp?new RegExp(t.source,t.flags):t.constructor?new t.constructor:Object.create(null);return e.set(t,n),Object.assign.apply(Object,es([n],Object.keys(t).map((function(n){var i;return(i={})[n]=ba(t[n],e),i}))))}var _a=function(t,e,n){var i=n[t];if(void 0===i)return e;var r=e[t];return r&&i?"string"==typeof r||"number"==typeof r||"boolean"==typeof r||"string"==typeof i||"number"==typeof i||"boolean"==typeof i||Array.isArray(r)||Array.isArray(i)?(e[t]=i,e):(e[t]=Object.assign({},r,i),e):(e[t]=i,e)};function Ia(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;for(var n in t)if(t.hasOwnProperty(n)){if(!e.hasOwnProperty(n))return!1;if(t[n]!==e[n]){if("object"!=typeof t[n])return!1;if(!Ia(t[n],e[n]))return!1}}for(var n in e)if(e.hasOwnProperty(n)&&!t.hasOwnProperty(n))return!1;return!0}function Sa(t,e,n){var i,r=n.split(".");for(i=0;i<r.length-1;i++)t[r[i]]||(t[r[i]]={}),"object"!=typeof t[r[i]]&&(t[r[i]]={}),t=t[r[i]];t[r[i]]=e}function xa(t,e){var n,i=e.split(".");for(n=0;n<i.length-1;n++){if(!t[i[n]])return;t=t[i[n]]}delete t[i[n]]}var ka,Ca=function(){function t(t){var e,n=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._protocolVersion=void 0,this._connection=t.connection,this._logger=t.logger,this._gw3Session=this._connection.domain("global",[oa,ca,pa,fa]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(e=this._connection.replayer)||void 0===e||e.drain(va.name,(function(t){var e=t.type;e&&(e===oa||e===sa||e===ia?n.handleContextCreatedMessage(t):e===ca||e===fa||e===la?n.handleContextUpdatedMessage(t):e!==pa&&e!==ra||n.handleContextDestroyedMessage(t))}))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;if(!this._protocolVersion){var e=this._connection.availableDomains.find((function(t){return"context"===t.uri}));this._protocolVersion=null!==(t=null==e?void 0:e.version)&&void 0!==t?t:1}return this._protocolVersion},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"setPathSupported",{get:function(){return this.protocolVersion>=2},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){for(var t=0,e=this._gw3Subscriptions;t<e.length;t++){var n=e[t];this._connection.off(n)}for(var i in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(i)&&delete this._contextNameToData[i]},t.prototype.createContext=function(t,e){var n=this;return this._gw3Session.send({type:na,domain:"global",name:t,data:e,lifetime:"retained"}).then((function(i){n._contextNameToId[t]=i.context_id,n._contextIdToName[i.context_id]=t;var r=n._contextNameToData[t]||new ma(i.context_id,t,!0,void 0);return r.isAnnounced=!0,r.name=t,r.contextId=i.context_id,r.context=e,n._contextNameToData[t]=r,i.context_id}))},t.prototype.all=function(){var t=this;return Object.keys(this._contextNameToData).filter((function(e){return t._contextNameToData[e].isAnnounced}))},t.prototype.update=function(t,e){var n;return Qo(this,void 0,void 0,(function(){var i,r,o,s=this;return ts(this,(function(a){switch(a.label){case 0:return(i=this._contextNameToData[t])&&i.isAnnounced?(r=i.context,i.hasCallbacks()?[3,2]:[4,this.get(i.name)]):[2,this.createContext(t,e)];case 1:r=a.sent(),a.label=2;case 2:return o=2===this.protocolVersion?this.calculateContextDeltaV2(r,e):this.calculateContextDeltaV1(r,e),Object.keys(o.added).length||Object.keys(o.updated).length||o.removed.length||(null===(n=o.commands)||void 0===n?void 0:n.length)?[2,this._gw3Session.send({type:ha,domain:"global",context_id:i.contextId,delta:o},{},{skipPeerId:!1}).then((function(t){s.handleUpdated(i,o,{updaterId:t.peer_id})}))]:[2,Promise.resolve()]}}))}))},t.prototype.set=function(t,e){var n=this,i=this._contextNameToData[t];return i&&i.isAnnounced?this._gw3Session.send({type:ha,domain:"global",context_id:i.contextId,delta:{reset:e}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(i,{reset:e,added:{},removed:[],updated:{}},{updaterId:t.peer_id})})):this.createContext(t,e)},t.prototype.setPath=function(t,e,n){return this.setPathSupported?this.setPaths(t,[{path:e,value:n}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")},t.prototype.setPaths=function(t,e){var n=this;if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");var i=this._contextNameToData[t];if(!i||!i.isAnnounced){for(var r={},o=0,s=e;o<s.length;o++){Sa(r,(d=s[o]).value,d.path)}return this.createContext(t,r)}for(var a=[],c=0,u=e;c<u.length;c++){var d;null===(d=u[c]).value?a.push({type:"remove",path:d.path}):a.push({type:"set",path:d.path,value:d.value})}return this._gw3Session.send({type:ha,domain:"global",context_id:i.contextId,delta:{commands:a}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(i,{added:{},removed:[],updated:{},commands:a},{updaterId:t.peer_id})}))},t.prototype.get=function(t){var e,n=this,i=this._contextNameToData[t];if(!i||!i.isAnnounced)return Promise.resolve({});if(i&&!i.hasCallbacks())return new Promise((function(e,i){return Qo(n,void 0,void 0,(function(){var n=this;return ts(this,(function(i){return this.subscribe(t,(function(t,i,r,o){n.unsubscribe(o),e(t)})),[2]}))}))}));var r=null!==(e=null==i?void 0:i.context)&&void 0!==e?e:{};return Promise.resolve(r)},t.prototype.subscribe=function(t,e){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var i=this._contextNameToData[t];if(!i||!i.isAnnounced)return i=i||new ma(void 0,t,!1,void 0),this._contextNameToData[t]=i,i.updateCallbacks[n]=e,Promise.resolve(n);var r=i.hasCallbacks();return i.updateCallbacks[n]=e,r||i.joinedActivity||i.context&&i.sentExplicitSubscription?(e(i.context,i.context,[],n),Promise.resolve(n)):this.sendSubscribe(i).then((function(){return n}))},t.prototype.unsubscribe=function(t){for(var e=0,n=Object.keys(this._contextNameToData);e<n.length;e++){var i=n[e],r=(this._contextNameToId[i],this._contextNameToData[i]);if(!r)return;var o=r.hasCallbacks();delete r.updateCallbacks[t],r.isAnnounced&&o&&!r.hasCallbacks()&&r.sentExplicitSubscription&&this.sendUnsubscribe(r),r.isAnnounced||r.hasCallbacks()||delete this._contextNameToData[i]}},t.prototype.destroy=function(t){var e=this._contextNameToData[t];return e?this._gw3Session.send({type:da,domain:"global",context_id:e.contextId}).then((function(t){})):Promise.reject("context with "+t+" does not exist")},t.prototype.handleUpdated=function(t,e,n){var i=t.context;t.context=wa(t.context,e,this._logger),this._contextNameToData[t.name]!==t||Ia(i,t.context)||this.invokeUpdateCallbacks(t,t.context,e,n)},t.prototype.subscribeToContextCreatedMessages=function(){for(var t=0,e=[sa,oa,ia];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextCreatedMessage=function(t){var e=t.type;e===ia?(this._contextNameToId[t.activity_id]=t.context_id,this._contextIdToName[t.context_id]=t.activity_id):e===sa&&(this._contextNameToId[t.name]=t.context_id,this._contextIdToName[t.context_id]=t.name);var n=this._contextIdToName[t.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+t.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+t.context_id);var i=this._contextNameToData[n];if(i){if(i.isAnnounced)return;if(!i.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");i.isAnnounced=!0,i.contextId=t.context_id,i.activityId=t.activity_id,i.sentExplicitSubscription||this.sendSubscribe(i)}else this._contextNameToData[n]=i=new ma(t.context_id,n,!0,t.activity_id)},t.prototype.subscribeToContextUpdatedMessages=function(){for(var t=0,e=[fa,ca,la];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextUpdatedMessage=function(t){var e=t.type,n=t.context_id,i=this._contextNameToData[this._contextIdToName[n]],r=!i||!i.isAnnounced;if(e===la)i?(i.contextId=n,i.isAnnounced=!0,i.activityId=t.activity_id):(i=new ma(n,t.activity_id,!0,t.activity_id),this._contextNameToData[t.activity_id]=i,this._contextIdToName[n]=t.activity_id,this._contextNameToId[t.activity_id]=n),i.joinedActivity=!0;else if(!i||!i.isAnnounced)return void(e===ca?((i=i||new ma(n,t.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[t.name]=i,this._contextIdToName[n]=t.name,this._contextNameToId[t.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var o=i.context;if(e===ca)i.context=t.data||{};else if(e===la)i.context=t.context_snapshot||{};else{if(e!==fa)throw new Error("Unrecognized context update message "+e);i.context=wa(i.context,t.delta,this._logger)}!r&&Ia(i.context,o)&&e!==ca||this.invokeUpdateCallbacks(i,i.context,t.delta,{updaterId:t.updater_id})},t.prototype.invokeUpdateCallbacks=function(t,e,n,i){for(var r in n=n||{added:{},updated:{},reset:{},removed:[]},t.updateCallbacks)if(t.updateCallbacks.hasOwnProperty(r))try{(0,t.updateCallbacks[r])(ba(e),Object.assign({},n.added||{},n.updated||{},n.reset||{}),n.removed,parseInt(r,10),i)}catch(t){this._logger.debug("callback error: "+JSON.stringify(t))}},t.prototype.subscribeToContextDestroyedMessages=function(){for(var t=0,e=[pa,ra];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextDestroyedMessage=function(t){var e,n;if(t.type===ra){if(n=t.activity_id,!(e=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+t.activity_id)}else if(e=t.context_id,!(n=this._contextIdToName[e]))return void this._logger.error("Received 'destroyed' for unknown context: "+t.context_id);delete this._contextIdToName[e],delete this._contextNameToId[n];var i=this._contextNameToData[n];delete this._contextNameToData[n],i&&i.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+e)},t.prototype.sendSubscribe=function(t){return t.sentExplicitSubscription=!0,this._gw3Session.send({type:aa,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.sendUnsubscribe=function(t){return t.sentExplicitSubscription=!1,this._gw3Session.send({type:ua,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.calculateContextDeltaV1=function(t,e){var n={added:{},updated:{},removed:[],reset:void 0};if(t)for(var i=0,r=Object.keys(t);i<r.length;i++){var o=r[i];-1===Object.keys(e).indexOf(o)||null===e[o]||Ia(t[o],e[o])||(n.updated[o]=e[o])}for(var s=0,a=Object.keys(e);s<a.length;s++){o=a[s];t&&-1!==Object.keys(t).indexOf(o)?null===e[o]&&n.removed.push(o):null!==e[o]&&(n.added[o]=e[o])}return n},t.prototype.calculateContextDeltaV2=function(t,e){for(var n,i,r={added:{},updated:{},removed:[],reset:void 0,commands:[]},o=0,s=Object.keys(e);o<s.length;o++){var a=s[o];if(null!==e[a])Ia(t?t[a]:null,e[a])||null===(n=r.commands)||void 0===n||n.push({type:"set",path:a,value:e[a]});else null===(i=r.commands)||void 0===i||i.push({type:"remove",path:a})}return r},t}(),Aa=function(){function t(t){this._bridge=new Ca(t)}return t.prototype.all=function(){return this._bridge.all()},t.prototype.update=function(t,e){return this.checkName(t),this.checkData(e),this._bridge.update(t,e)},t.prototype.set=function(t,e){return this.checkName(t),this.checkData(e),this._bridge.set(t,e)},t.prototype.setPath=function(t,e,n){return this.checkName(t),this.checkPath(e),""===e?(this.checkData(n),this.set(t,n)):this._bridge.setPath(t,e,n)},t.prototype.setPaths=function(t,e){if(this.checkName(t),!Array.isArray(e))throw new Error("Please provide the paths as an array of PathValues!");for(var n=0,i=e;n<i.length;n++){var r=i[n],o=r.path,s=r.value;this.checkPath(o),""===o&&this.checkData(s)}return this._bridge.setPaths(t,e)},t.prototype.subscribe=function(t,e){var n=this;if(this.checkName(t),"function"!=typeof e)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(t,(function(t,i,r,o,s){return e(t,i,r,(function(){return n._bridge.unsubscribe(o)}),s)})).then((function(t){return function(){n._bridge.unsubscribe(t)}}))},t.prototype.get=function(t){return this.checkName(t),this._bridge.get(t)},t.prototype.ready=function(){return Promise.resolve(this)},t.prototype.destroy=function(t){return this.checkName(t),this._bridge.destroy(t)},Object.defineProperty(t.prototype,"setPathSupported",{get:function(){return this._bridge.setPathSupported},enumerable:!0,configurable:!0}),t.prototype.checkName=function(t){if("string"!=typeof t||""===t)throw new Error("Please provide the name as a non-empty string!")},t.prototype.checkPath=function(t){if("string"!=typeof t)throw new Error("Please provide the path as a dot delimited string!")},t.prototype.checkData=function(t){if("object"!=typeof t)throw new Error("Please provide the data as an object!")},t}();function Ta(t,e,n){return"function"!=typeof e&&"function"!=typeof n?t:("function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n))}function Pa(t,e,n){var i;return void 0===t&&(t=0),e.finally((function(){i&&clearTimeout(i)})),new Promise((function(e,r){i=setTimeout((function(){return r(n)}),t)}))}!function(t){t[t.Success=0]="Success",t[t.Error=1]="Error"}(ka||(ka={}));var Ma=function(){function t(t,e,n,i){this.protocol=t,this.repo=e,this.instance=n,this.configuration=i}return t.prototype.subscribe=function(t,e,n,i,r){var o=this,s=function(t,n,i,s){var a;e.methodResponseTimeout=null!==(a=e.methodResponseTimeout)&&void 0!==a?a:e.waitTimeoutMs,o.protocol.client.subscribe(n,e,t,i,s,r)};return Ta(new Promise((function(n,i){var r,a=function(t){n(t)},c=function(t){i(t)};if(t)if((r="string"==typeof t?{name:t}:t).name){void 0===e&&(e={});var u=e.target;if(void 0===u&&(u="best"),"string"!=typeof u||"all"===u||"best"===u){void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=e.method_response_timeout,void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=o.configuration.methodResponseTimeout)),void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=e.wait_for_method_timeout,void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=o.configuration.waitTimeoutMs));var d=0,p=o.getServerMethodsByFilterAndTarget(r,u);if(p.length>0)s(p,p[0].methods[0],a,c);else{var h=function(){if(u&&e.waitTimeoutMs)if(d+=500,(p=o.getServerMethodsByFilterAndTarget(r,u)).length>0){var n=p[0].methods[0];s(p,n,a,c)}else if(d>=e.waitTimeoutMs){s(p,"string"==typeof t?{name:t}:t,a,c)}else setTimeout(h,500)};setTimeout(h,500)}}else i(new Error('"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else i("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");else i("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.")})),n,i)},t.prototype.servers=function(t){var e=void 0===t?void 0:Xo({},t);return this.getServers(e).map((function(t){return t.server.instance}))},t.prototype.methods=function(t){return t="string"==typeof t?{name:t}:Xo({},t),this.getMethods(t)},t.prototype.methodsForInstance=function(t){return this.getMethodsForInstance(t)},t.prototype.methodAdded=function(t){return this.repo.onMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.repo.onMethodRemoved(t)},t.prototype.serverAdded=function(t){return this.repo.onServerAdded(t)},t.prototype.serverRemoved=function(t){return this.repo.onServerRemoved((function(e,n){t(e,n)}))},t.prototype.serverMethodAdded=function(t){return this.repo.onServerMethodAdded((function(e,n){t({server:e,method:n})}))},t.prototype.serverMethodRemoved=function(t){return this.repo.onServerMethodRemoved((function(e,n){t({server:e,method:n})}))},t.prototype.invoke=function(t,e,n,i,r,o){return Qo(this,void 0,void 0,(function(){var s=this;return ts(this,(function(a){return[2,Ta(function(){return Qo(s,void 0,void 0,(function(){var r,o,s,a,c,u,d,p,h,f,l=this;return ts(this,(function(v){switch(v.label){case 0:if(!(r="string"==typeof t?{name:t}:Xo({},t)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.")];if(e||(e={}),n||(n="best"),"string"==typeof n&&"all"!==n&&"best"!==n&&"skipMine"!==n)return[2,Promise.reject(new Error('"'+n+'" is not a valid target. Valid targets are "all" and "best".'))];if(i||(i={}),void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=i.method_response_timeout,void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=i.wait_for_method_timeout,void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==i.waitTimeoutMs&&"number"!=typeof i.waitTimeoutMs)return[2,Promise.reject(new Error('"'+i.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof e)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+r.name))];if(0!==(o=this.getServerMethodsByFilterAndTarget(r,n)).length)return[3,4];v.label=1;case 1:return v.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(r,n,i)];case 2:return o=v.sent(),[3,4];case 3:return v.sent(),s=Xo(Xo({},r),{getServers:function(){return[]},supportsStreaming:!1,objectTypes:null!==(f=r.objectTypes)&&void 0!==f?f:[]}),a={method:s,called_with:e,message:"Can not find a method matching "+JSON.stringify(t)+" with server filter "+JSON.stringify(n),executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(a)];case 4:return c=i.methodResponseTimeoutMs,u=i,d=o.map((function(t){var n=Ys(),i=t.methods[0],r=t.server,o=l.protocol.client.invoke(n,i,e,r,u);return Promise.race([o,Pa(c,o,{invocationId:n,message:"Invocation timeout ("+c+" ms) reached for method name: "+(null==i?void 0:i.name)+", target instance: "+JSON.stringify(r.instance)+", options: "+JSON.stringify(u),status:ka.Error})])})),[4,Promise.all(d)];case 5:return p=v.sent(),h=this.getInvocationResultObj(p,r,e),p.every((function(t){return t.status===ka.Error}))?[2,Promise.reject(h)]:[2,h]}}))}))}(),r,o)]}))}))},t.prototype.getInvocationResultObj=function(t,e,n){var i=t.filter((function(t){return t.status===ka.Success})).reduce((function(t,i){return t=es(t,[{executed_by:i.instance,returned:i.result,called_with:n,method:e,message:i.message,status:i.status}])}),[]),r=t.filter((function(t){return t.status===ka.Error})).reduce((function(t,i){return t=es(t,[{executed_by:i.instance,called_with:n,name:e.name,message:i.message}])}),[]),o=t[0];return{method:e,called_with:n,returned:o.result,executed_by:o.instance,all_return_values:i,all_errors:r,message:o.message,status:o.status}},t.prototype.tryToAwaitForMethods=function(t,e,n){var i=this;return new Promise((function(r,o){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=i.getServerMethodsByFilterAndTarget(t,e);if(c.length>0)clearInterval(a),r(c);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(a),void o()}),500);else o()}))},t.prototype.filterByTarget=function(t,e){var n=this;if("string"!=typeof t){return(Array.isArray(t)?t:[t]).reduce((function(t,i){var r=e.filter((function(t){return n.instanceMatch(i,t.server.instance)}));return t.concat(r)}),[])}if("all"===t)return es(e);if("best"===t){var i=e.find((function(t){return t.server.instance.isLocal}));if(i)return[i];if(void 0!==e[0])return[e[0]]}else if("skipMine"===t)return e.filter((function(t){return t.server.instance.peerId!==n.instance.peerId}));return[]},t.prototype.instanceMatch=function(t,e){return this.containsProps(t,e)},t.prototype.methodMatch=function(t,e){return this.containsProps(t,e)},t.prototype.containsProps=function(t,e){return Object.keys(t).filter((function(e){return void 0!==t[e]&&"function"!=typeof t[e]&&"object_types"!==e&&"display_name"!==e&&"id"!==e&&"gatewayId"!==e&&"identifier"!==e&&"_"!==e[0]})).reduce((function(n,i){var r=t[i],o=e[i];if("objectTypes"===i){(r.length>o.length||!1===function(t,e){var n=t.reduce((function(t,e){return t[e]=!1,t}),{});e.forEach((function(t){void 0!==n[t]&&(n[t]=!0)}));return Object.keys(n).reduce((function(t,e){return n[e]||(t=!1),t}),!0)}(r,o))&&(n=!1)}else String(r).toLowerCase()!==String(o).toLowerCase()&&(n=!1);return n}),!0)},t.prototype.getMethods=function(t){var e=this;return void 0===t?this.repo.getMethods():this.repo.getMethods().filter((function(n){return e.methodMatch(t,n)}))},t.prototype.getMethodsForInstance=function(t){var e=this,n=this.repo.getServers().filter((function(n){return e.instanceMatch(t,n.instance)}));if(0===n.length)return[];var i={};return 1===n.length?i=n[0].methods:n.forEach((function(t){Object.keys(t.methods).forEach((function(e){var n=t.methods[e];i[n.identifier]=n}))})),Object.keys(i).map((function(t){return i[t]}))},t.prototype.getServers=function(t){var e=this,n=this.repo.getServers();return void 0===t?n.map((function(t){return{server:t,methods:[]}})):n.reduce((function(n,i){var r=e.repo.getServerMethodsById(i.id).filter((function(n){return e.methodMatch(t,n)}));return r.length>0&&n.push({server:i,methods:r}),n}),[])},t.prototype.getServerMethodsByFilterAndTarget=function(t,e){var n=this.getServers(t);return this.filterByTarget(e,n)},t}(),ja=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.subscription=n}return Object.defineProperty(t.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),t.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},t.prototype.push=function(t){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,t)},t}(),Oa=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return t.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},t.prototype.acceptOnBranch=function(t){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,t)},t.prototype.reject=function(t){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,t)},t}(),Ea=function(){function t(t,e){var n=this;this.protocol=t,this.server=e,t.server.onSubRequest((function(t,e){return n.handleSubRequest(t,e)})),t.server.onSubAdded((function(t,e){return n.handleSubAdded(t,e)})),t.server.onSubRemoved((function(t,e){return n.handleSubRemoved(t,e)}))}return t.prototype.handleSubRequest=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRequestHandler){var n=new Oa(this.protocol,e,t);e.streamCallbacks.subscriptionRequestHandler(n)}},t.prototype.handleSubAdded=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionAddedHandler){var n=new ja(this.protocol,e,t);e.streamCallbacks.subscriptionAddedHandler(n)}},t.prototype.handleSubRemoved=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRemovedHandler){var n=new ja(this.protocol,e,t);e.streamCallbacks.subscriptionRemovedHandler(n)}},t}(),Ra=function(){function t(t,e,n){this.key=t,this.protocol=e,this.repoMethod=n}return t.prototype.subscriptions=function(){var t=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(e){return new ja(t.protocol,t.repoMethod,e)}))},t.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},t.prototype.push=function(t){this.protocol.server.pushData(this.repoMethod,t,[this.key])},t}(),La=function(){function t(t,e,n){this._protocol=t,this._repoMethod=e,this._server=n,this.name=this._repoMethod.definition.name}return t.prototype.branches=function(t){var e=this,n=this._protocol.server.getBranchList(this._repoMethod);return t?n.indexOf(t)>-1?new Ra(t,this._protocol,this._repoMethod):void 0:n.map((function(t){return new Ra(t,e._protocol,e._repoMethod)}))},t.prototype.branch=function(t){return this.branches(t)},t.prototype.subscriptions=function(){var t=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(e){return new ja(t._protocol,t._repoMethod,e)}))},Object.defineProperty(t.prototype,"definition",{get:function(){var t=this._repoMethod.definition;return{accepts:t.accepts,description:t.description,displayName:t.displayName,name:t.name,objectTypes:t.objectTypes,returns:t.returns,supportsStreaming:t.supportsStreaming}},enumerable:!0,configurable:!0}),t.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},t.prototype.push=function(t,e){if("string"!=typeof e&&!Array.isArray(e)&&void 0!==e)throw new Error("invalid branches should be string or string array");if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,t,e)},t.prototype.updateRepoMethod=function(t){this._repoMethod=t},t}(),Na=function(){function t(t,e){this.protocol=t,this.serverRepository=e,this.invocations=0,this.currentlyUnregistering={},this.streaming=new Ea(t,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return t.prototype.createStream=function(t,e,n,i,r){var o=this;return Ta(new Promise((function(n,i){if(t){var s;if(!(s="string"==typeof t?{name:""+t}:Xo({},t)).name)return i("The “name” property is required for the “streamDefinition” object and must be unique. Stream definition: "+JSON.stringify(s));if(o.serverRepository.getList().some((function(t){return t.definition.name===s.name})))return i('A stream with the name "'+s.name+'" already exists! Please, provide a unique name for the stream.');s.supportsStreaming=!0,e||(e={}),"function"!=typeof e.subscriptionRequestHandler&&(e.subscriptionRequestHandler=function(t){t.accept()});var a=o.serverRepository.add({definition:s,streamCallbacks:e,protocolState:{}});o.protocol.server.createStream(a).then((function(){var t;r?(t=r,r.updateRepoMethod(a)):t=new La(o.protocol,a,o),a.stream=t,n(t)})).catch((function(t){a.repoId&&o.serverRepository.remove(a.repoId),i(t)}))}else i("The stream name must be unique! Please, provide either a unique string for a stream name to “glue.interop.createStream()” or a “methodDefinition” object with a unique “name” property for the stream.")})),n,i)},t.prototype.register=function(t,e){var n=this;if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var i=function(t,i){return Qo(n,void 0,void 0,(function(){var n,r,o;return ts(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),(n=e(t.args,t.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return r=s.sent(),i(void 0,r),[3,3];case 2:i(void 0,n),s.label=3;case 3:return[3,5];case 4:return(o=s.sent())||(o=""),i(o,o),[3,5];case 5:return[2]}}))}))};return i.userCallback=e,this.registerCore(t,i)},t.prototype.registerAsync=function(t,e){if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var n=function(t,n){try{var i=!1,r=function(t){i||n(void 0,t),i=!0},o=function(t){i||(t||(t=""),n(t,t)),i=!0},s=e(t.args,t.instance,r,o);s&&"function"==typeof s.then&&s.then(r).catch(o)}catch(t){n(t,void 0)}};return n.userCallbackAsync=e,this.registerCore(t,n)},t.prototype.unregister=function(t,e){return void 0===e&&(e=!1),Qo(this,void 0,void 0,(function(){var n,i;return ts(this,(function(r){switch(r.label){case 0:return void 0===t?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a “name” property.")]:"function"!=typeof t?[3,2]:[4,this.unregisterWithPredicate(t,e)];case 1:return r.sent(),[2];case 2:return void 0===(n="string"==typeof t?{name:t}:t).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(i=this.serverRepository.getList().find((function(t){return t.definition.name===n.name&&(t.definition.supportsStreaming||!1)===e})))?[4,this.removeMethodsOrStreams([i])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return r.sent(),[2]}}))}))},t.prototype.unregisterWithPredicate=function(t,e){return Qo(this,void 0,void 0,(function(){var n;return ts(this,(function(i){switch(i.label){case 0:return(n=this.serverRepository.getList().filter((function(e){return t(e.definition)})).filter((function(t){return(t.definition.supportsStreaming||!1)===e})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(e?"stream":"method")+" matching the specified condition!")];case 1:return i.sent(),[2]}}))}))},t.prototype.removeMethodsOrStreams=function(t){var e=this,n=[];return t.forEach((function(t){var i=e.protocol.server.unregister(t).then((function(){t.repoId&&e.serverRepository.remove(t.repoId)}));n.push(i),e.addAsCurrentlyUnregistering(t.definition.name,i)})),Promise.all(n)},t.prototype.addAsCurrentlyUnregistering=function(t,e){return Qo(this,void 0,void 0,(function(){var n,i=this;return ts(this,(function(r){return n=new Promise((function(t){return setTimeout(t,5e3)})),this.currentlyUnregistering[t]=Promise.race([e,n]).then((function(){delete i.currentlyUnregistering[t]})),[2]}))}))},t.prototype.registerCore=function(t,e){return Qo(this,void 0,void 0,(function(){var n,i,r,o=this;return ts(this,(function(s){switch(s.label){case 0:return(n="string"==typeof t?{name:""+t}:Xo({},t)).name?(i=this.currentlyUnregistering[n.name])?[4,i]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the “name” property in the “methodDefinition” object: "+JSON.stringify(t))];case 1:s.sent(),s.label=2;case 2:return this.serverRepository.getList().some((function(t){return t.definition.name===n.name}))?[2,Promise.reject('A method with the name "'+n.name+'" already exists! Please, provide a unique name for the method.')]:n.supportsStreaming?[2,Promise.reject("When you create methods with “glue.interop.register()” or “glue.interop.registerAsync()” the property “supportsStreaming” cannot be “true”. If you want “"+n.name+"” to be a stream, please use the “glue.interop.createStream()” method.")]:(r=this.serverRepository.add({definition:n,theFunction:e,protocolState:{}}),[2,this.protocol.server.register(r).catch((function(t){throw(null==r?void 0:r.repoId)&&o.serverRepository.remove(r.repoId),t}))])}}))}))},t.prototype.onMethodInvoked=function(t,e,n){var i=this;t&&t.theFunction&&t.theFunction(n,(function(n,r){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(t){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}r?("object"!=typeof r||Array.isArray(r))&&(r={_value:r}):r={},i.protocol.server.methodInvocationResult(t,e,n,r)}))},t}(),Wa=function(){function t(t,e){var n=this;this.wrapped={getMethods:Da,getStreams:Fa},t&&this.refreshWrappedObject(t),e&&(e.loggedIn((function(){n.refresh(e)})),this.refresh(e))}return t.prototype.unwrap=function(){return this.wrapped},t.prototype.refresh=function(t){if(t){var e=null==t?void 0:t.resolvedIdentity,n=Object.assign({},null!=e?e:{},{peerId:null==t?void 0:t.peerId});this.refreshWrappedObject(n)}},t.prototype.refreshWrappedObject=function(t){var e,n,i;this.wrapped.user=t.user,this.wrapped.instance=t.instance,this.wrapped.application=null!==(e=t.application)&&void 0!==e?e:Ys(),this.wrapped.applicationName=t.applicationName,this.wrapped.pid=null!==(i=null!==(n=t.pid)&&void 0!==n?n:t.process)&&void 0!==i?i:Math.floor(1e10*Math.random()),this.wrapped.machine=t.machine,this.wrapped.environment=t.environment,this.wrapped.region=t.region,this.wrapped.windowId=t.windowId,this.wrapped.isLocal=!0,this.wrapped.api=t.api,this.wrapped.service=t.service,this.wrapped.peerId=t.peerId},t}();function Da(){var t;return null===(t=Wa.API)||void 0===t?void 0:t.methodsForInstance(this)}function Fa(){var t;return null===(t=Wa.API)||void 0===t?void 0:t.methodsForInstance(this).filter((function(t){return t.supportsStreaming}))}var Ba=function(){function t(t){this.logger=t,this.servers={},this.methodsCount={},this.callbacks=Ss()}return t.prototype.addServer=function(t,e){this.logger.debug("adding server "+e);var n=this.servers[e];if(n)return n.id;var i=new Wa(t),r={id:e,methods:{},instance:i.unwrap(),wrapper:i};return this.servers[e]=r,this.callbacks.execute("onServerAdded",r.instance),e},t.prototype.removeServerById=function(t,e){var n=this,i=this.servers[t];i?(this.logger.debug("removing server "+t),Object.keys(i.methods).forEach((function(e){n.removeServerMethod(t,e)})),delete this.servers[t],this.callbacks.execute("onServerRemoved",i.instance,e)):this.logger.warn("not aware of server "+t+", my state "+JSON.stringify(Object.keys(this.servers)))},t.prototype.addServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");if(!n.methods[e.id]){var i=this.createMethodIdentifier(e),r=this,o={identifier:i,gatewayId:e.id,name:e.name,displayName:e.display_name,description:e.description,version:e.version,objectTypes:e.object_types||[],accepts:e.input_signature,returns:e.result_signature,supportsStreaming:void 0!==e.flags&&e.flags.streaming,getServers:function(){return r.getServersByMethod(i)}};return o.object_types=o.objectTypes,o.display_name=o.displayName,o.version=o.version,n.methods[e.id]=o,this.methodsCount[i]||(this.methodsCount[i]=0,this.callbacks.execute("onMethodAdded",o)),this.methodsCount[i]=this.methodsCount[i]+1,this.callbacks.execute("onServerMethodAdded",n.instance,o),o}},t.prototype.removeServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");var i=n.methods[e];delete n.methods[e],this.methodsCount[i.identifier]=this.methodsCount[i.identifier]-1,0===this.methodsCount[i.identifier]&&this.callbacks.execute("onMethodRemoved",i),this.callbacks.execute("onServerMethodRemoved",n.instance,i)},t.prototype.getMethods=function(){var t=this,e={};return Object.keys(this.servers).forEach((function(n){var i=t.servers[n];Object.keys(i.methods).forEach((function(t){var n=i.methods[t];e[n.identifier]=n}))})),Object.keys(e).map((function(t){return e[t]}))},t.prototype.getServers=function(){var t=this,e=[];return Object.keys(this.servers).forEach((function(n){var i=t.servers[n];e.push(i)})),e},t.prototype.getServerMethodsById=function(t){var e=this.servers[t];return Object.keys(e.methods).map((function(t){return e.methods[t]}))},t.prototype.onServerAdded=function(t){var e=this.callbacks.add("onServerAdded",t),n=this.getServers().map((function(t){return t.instance}));return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onMethodAdded=function(t){var e=this.callbacks.add("onMethodAdded",t),n=this.getMethods();return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onServerMethodAdded=function(t){var e=this.callbacks.add("onServerMethodAdded",t),n=!1,i=this.getServers();return setTimeout((function(){i.forEach((function(e){var i=e.methods;Object.keys(i).forEach((function(r){n||t(e.instance,i[r])}))}))}),0),function(){n=!0,e()}},t.prototype.onMethodRemoved=function(t){return this.callbacks.add("onMethodRemoved",t)},t.prototype.onServerRemoved=function(t){return this.callbacks.add("onServerRemoved",t)},t.prototype.onServerMethodRemoved=function(t){return this.callbacks.add("onServerMethodRemoved",t)},t.prototype.getServerById=function(t){return this.servers[t]},t.prototype.reset=function(){var t=this;Object.keys(this.servers).forEach((function(e){t.removeServerById(e,"reset")})),this.servers={},this.methodsCount={}},t.prototype.createMethodIdentifier=function(t){var e=void 0!==t.input_signature?t.input_signature:"",n=void 0!==t.result_signature?t.result_signature:"";return(t.name+e+n).toLowerCase()},t.prototype.getServersByMethod=function(t){var e=this,n=[];return Object.keys(this.servers).forEach((function(i){var r=e.servers[i];Object.keys(r.methods).forEach((function(e){r.methods[e].identifier===t&&n.push(r.instance)}))})),n},t.prototype.returnUnsubWithDelayedReplay=function(t,e,n){var i=!1;return setTimeout((function(){e.forEach((function(t){i||n(t)}))}),0),function(){i=!0,t()}},t}(),qa=function(){function t(){this.nextId=0,this.methods=[]}return t.prototype.add=function(t){return t.repoId=String(this.nextId),this.nextId+=1,this.methods.push(t),t},t.prototype.remove=function(t){if("string"!=typeof t)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(e){return e.repoId!==t}))},t.prototype.getById=function(t){if("string"==typeof t)return this.methods.find((function(e){return e.repoId===t}))},t.prototype.getList=function(){return this.methods.map((function(t){return t}))},t.prototype.length=function(){return this.methods.length},t.prototype.reset=function(){this.methods=[]},t}(),Ga="onSubscriptionRequest",Ha="onSubscriptionAdded",Ua="onSubscriptionRemoved",Va=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.serverRepository=n,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=Ss(),this.nextStreamId=0,t.on("add-interest",(function(t){i.handleAddInterest(t)})),t.on("remove-interest",(function(t){i.handleRemoveInterest(t)}))}return t.prototype.acceptRequestOnBranch=function(t,e,n){if("string"!=typeof n&&(n=""),"object"!=typeof e.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(e.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var i=this.getStreamId(e,n),r=t.msg.subscription_id,o={id:r,arguments:t.arguments,instance:t.instance,branchKey:n,streamId:i,subscribeMsg:t.msg};e.protocolState.subscriptionsMap[r]=o,this.session.sendFireAndForget({type:"accepted",subscription_id:r,stream_id:i}),this.callbacks.execute(Ha,o,e)},t.prototype.rejectRequest=function(t,e,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,t.msg.subscription_id)},t.prototype.pushData=function(t,e,n){var i=this;if("object"==typeof t&&Array.isArray(t.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]),t.protocolState.branchKeyToStreamIdMap.filter((function(t){return!n||0===n.length||n.indexOf(t.key)>=0})).map((function(t){return t.streamId})).forEach((function(t){var n={type:"publish",stream_id:t,data:e};i.session.sendFireAndForget(n)}))}},t.prototype.pushDataToSingle=function(t,e,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var i={type:"post",subscription_id:e.id,data:n};this.session.sendFireAndForget(i)},t.prototype.closeSingleSubscription=function(t,e){t.protocolState.subscriptionsMap&&delete t.protocolState.subscriptionsMap[e.id];var n={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);e.instance;this.callbacks.execute(Ua,e,t)},t.prototype.closeMultipleSubscriptions=function(t,e){var n=this;if("object"==typeof t&&"object"==typeof t.protocolState.subscriptionsMap&&t.protocolState.subscriptionsMap){var i=t.protocolState.subscriptionsMap,r=Object.keys(i).map((function(t){return i[t]}));"string"==typeof e&&(r=r.filter((function(t){return t.branchKey===e}))),r.forEach((function(t){delete i[t.id];var e={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping all subscriptions on stream_id: "+t.streamId};n.session.sendFireAndForget(e)}))}},t.prototype.getSubscriptionList=function(t,e){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var n=t.protocolState.subscriptionsMap,i=Object.keys(n).map((function(t){return n[t]}));return"string"!=typeof e?i:i.filter((function(t){return t.branchKey===e}))},t.prototype.getBranchList=function(t){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var e=t.protocolState.subscriptionsMap,n=Object.keys(e).map((function(t){return e[t]})),i=[];return n.forEach((function(t){var e="";"object"==typeof t&&"string"==typeof t.branchKey&&(e=t.branchKey),-1===i.indexOf(e)&&i.push(e)})),i},t.prototype.onSubAdded=function(t){this.onSubscriptionLifetimeEvent(Ha,t)},t.prototype.onSubRequest=function(t){this.onSubscriptionLifetimeEvent(Ga,t)},t.prototype.onSubRemoved=function(t){this.onSubscriptionLifetimeEvent(Ua,t)},t.prototype.handleRemoveInterest=function(t){var e=this.serverRepository.getById(t.method_id);if("string"==typeof t.subscription_id&&"object"==typeof e&&e.protocolState.subscriptionsMap&&"object"==typeof e.protocolState.subscriptionsMap[t.subscription_id]){var n=e.protocolState.subscriptionsMap[t.subscription_id];delete e.protocolState.subscriptionsMap[t.subscription_id],this.callbacks.execute(Ua,n,e)}},t.prototype.onSubscriptionLifetimeEvent=function(t,e){this.callbacks.add(t,e)},t.prototype.getNextStreamId=function(){return this.nextStreamId+++""},t.prototype.handleAddInterest=function(t){var e=this.repository.getServerById(t.caller_id).instance,n={msg:t,arguments:t.arguments_kv||{},instance:e},i=this.serverRepository.getById(t.method_id);if(void 0!==i)i.protocolState.subscriptionsMap&&i.protocolState.subscriptionsMap[t.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+t.subscription_id+" already exists.",t.subscription_id):this.callbacks.execute(Ga,n,i);else{var r="No method with id "+t.method_id+" on this server.";this.sendSubscriptionFailed(r,t.subscription_id)}},t.prototype.sendSubscriptionFailed=function(t,e){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:t,request_id:e};this.session.sendFireAndForget(n)},t.prototype.getStreamId=function(t,e){if("string"!=typeof e&&(e=""),!t.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+t.definition.name+" method without protocol state");var n=t.protocolState.branchKeyToStreamIdMap.filter((function(t){return t.key===e}))[0],i=n?n.streamId:void 0;return"string"==typeof i&&""!==i||(i=this.getNextStreamId(),t.protocolState.branchKeyToStreamIdMap.push({key:e,streamId:i})),i},t}(),Ja=function(){function t(t,e,n,i){var r=this;this.session=t,this.clientRepository=e,this.serverRepository=n,this.logger=i,this.callbacks=Ss(),this.streaming=new Va(t,e,n),this.session.on("invoke",(function(t){return r.handleInvokeMessage(t)}))}return t.prototype.createStream=function(t){return t.protocolState.subscriptionsMap={},t.protocolState.branchKeyToStreamIdMap=[],this.register(t,!0)},t.prototype.register=function(t,e){var n=this,i=t.definition,r={streaming:e||!1},o={type:"register",methods:[{id:t.repoId,name:i.name,display_name:i.displayName,description:i.description,version:i.version,flags:r,object_types:i.objectTypes||i.object_types,input_signature:i.accepts,result_signature:i.returns,restrictions:void 0}]};return this.session.send(o,{methodId:t.repoId}).then((function(){n.logger.debug("registered method "+t.definition.name+" with id "+t.repoId)})).catch((function(e){throw n.logger.warn("failed to register method "+t.definition.name+" with id "+t.repoId+" - "+JSON.stringify(e)),e}))},t.prototype.onInvoked=function(t){this.callbacks.add("onInvoked",t)},t.prototype.methodInvocationResult=function(t,e,n,i){var r;r=n||""===n?{type:"error",request_id:e,reason_uri:"agm.errors.client_error",reason:n,context:i,peer_id:void 0}:{type:"yield",invocation_id:e,peer_id:this.session.peerId,result:i,request_id:void 0},this.session.sendFireAndForget(r)},t.prototype.unregister=function(t){return Qo(this,void 0,void 0,(function(){var e;return ts(this,(function(n){switch(n.label){case 0:return e={type:"unregister",methods:[t.repoId]},[4,this.session.send(e)];case 1:return n.sent(),[2]}}))}))},t.prototype.getBranchList=function(t){return this.streaming.getBranchList(t)},t.prototype.getSubscriptionList=function(t,e){return this.streaming.getSubscriptionList(t,e)},t.prototype.closeAllSubscriptions=function(t,e){this.streaming.closeMultipleSubscriptions(t,e)},t.prototype.pushData=function(t,e,n){this.streaming.pushData(t,e,n)},t.prototype.pushDataToSingle=function(t,e,n){this.streaming.pushDataToSingle(t,e,n)},t.prototype.closeSingleSubscription=function(t,e){this.streaming.closeSingleSubscription(t,e)},t.prototype.acceptRequestOnBranch=function(t,e,n){this.streaming.acceptRequestOnBranch(t,e,n)},t.prototype.rejectRequest=function(t,e,n){this.streaming.rejectRequest(t,e,n)},t.prototype.onSubRequest=function(t){this.streaming.onSubRequest(t)},t.prototype.onSubAdded=function(t){this.streaming.onSubAdded(t)},t.prototype.onSubRemoved=function(t){this.streaming.onSubRemoved(t)},t.prototype.handleInvokeMessage=function(t){var e=t.invocation_id,n=t.caller_id,i=t.method_id,r=t.arguments_kv,o=this.serverRepository.getList().filter((function(t){return t.repoId===i}))[0];if(void 0!==o){var s={args:r,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",o,e,s)}},t}(),za=function(){function t(t,e){this.repository=t,this.subscriptionData=e}return Object.defineProperty(t.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"servers",{get:function(){var t=this;return this.subscriptionData.trackedServers.filter((function(t){return t.subscriptionId})).map((function(e){return t.repository.getServerById(e.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),t.prototype.onData=function(t){if("function"!=typeof t)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(t),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(e){t(e)}))},t.prototype.onClosed=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(t)},t.prototype.onFailed=function(t){},t.prototype.onConnected=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(t)},t.prototype.close=function(){this.subscriptionData.close()},t.prototype.setNewSubscription=function(t){this.subscriptionData=t},t}(),Ka="awaitingAccept",Ya="subscribed",Za="ClientInitiated",$a=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.logger=n,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(t){var e=t._tag,n=e.subLocalKey,r=i.subscriptionsList[n];if("object"==typeof r&&(r.trackedServers=r.trackedServers.filter((function(t){return t.serverId!==e.serverId})),r.trackedServers.length<=0)){if(clearTimeout(r.timeoutId),r.status===Ka){var o="string"==typeof t.reason&&""!==t.reason?' Publisher said "'+t.reason+'".':" No reason given.",s="object"==typeof r.params.arguments?JSON.stringify(r.params.arguments):"{}";r.error({message:"Subscription rejected."+o+" Called with:"+s,called_with:r.params.arguments,method:r.method})}else r.status===Ya&&i.callOnClosedHandlers(r);delete i.subscriptionsList[n]}},this.handleSubscribed=function(t){var e=t._tag.subLocalKey,n=i.subscriptionsList[e];if("object"==typeof n){var r=t._tag.serverId,o=n.trackedServers.filter((function(t){return t.serverId===r}))[0];if("object"==typeof o){o.subscriptionId=t.subscription_id,i.subscriptionIdToLocalKeyMap[t.subscription_id]=e;var s=n.status===Ka;if(n.status=Ya,s){var a=!1,c=n.subscription;c?(c.setNewSubscription(n),n.success(c),a=!0):(c=new za(i.repository,n),n.subscription=c,n.success(c));for(var u=0,d=n.handlers.onConnected;u<d.length;u++){var p=d[u];try{p(c.serverInstance,a)}catch(t){}}}}}},this.handleEventData=function(t){var e=i.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=i.subscriptionsList[e];if("object"==typeof n){var r=n.trackedServers.filter((function(e){return e.subscriptionId===t.subscription_id}));if(1===r.length){var o=t.oob,s=r[0].serverId,a=function(){return{data:t.data,server:i.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:o}},c=n.handlers.onData,u=n.queued.data;c.length>0?c.forEach((function(t){"function"==typeof t&&t(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(t){var e=i.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=i.subscriptionsList[e];if("object"==typeof n){var r=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(e){return e.subscriptionId!==t.subscription_id||(n.queued.closers.push(e.serverId),!1)})),n.trackedServers.length===r&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),i.callOnClosedHandlers(n),delete i.subscriptionsList[e]),delete i.subscriptionIdToLocalKeyMap[t.subscription_id])}}},t.on("subscribed",this.handleSubscribed),t.on("event",this.handleEventData),t.on("subscription-cancelled",this.handleSubscriptionCancelled)}return t.prototype.subscribe=function(t,e,n,i,r,o){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,t,e,i,r,e.methodResponseTimeout||1e4,o);"object"==typeof c?n.forEach((function(n){var i=n.server.id,r=n.methods.find((function(e){return e.name===t.name}));if(r){c.trackedServers.push({serverId:i,subscriptionId:void 0});var o={type:"subscribe",server_id:i,method_id:r.gatewayId,arguments_kv:e.arguments};s.session.send(o,{serverId:i,subLocalKey:a}).then((function(t){return s.handleSubscribed(t)})).catch((function(t){return s.handleErrorSubscribing(t)}))}else s.logger.error("can not find method "+t.name+" for target "+n.server.id)})):r({method:t,called_with:e.arguments,message:"Subscription failed. Unable to register the user callbacks."})}else r({method:t,called_with:e.arguments,message:"Subscription failed. No available servers matched the target params."})},t.prototype.drainSubscriptions=function(){var t=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},t},t.prototype.getNextSubscriptionLocalKey=function(){var t=this.nextSubLocalKey;return this.nextSubLocalKey+=1,t},t.prototype.registerSubscription=function(t,e,n,i,r,o,s){var a=this,c={localKey:t,status:Ka,method:e,params:n,success:i,error:r,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(t)},subscription:null==s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[t]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[t]){var i=a.subscriptionsList[t];i.status===Ka?(r({method:e,called_with:n.arguments,message:"Subscription failed. Subscription attempt timed out after "+o+" ms."}),delete a.subscriptionsList[t]):i.status===Ya&&i.trackedServers.length>0&&(i.trackedServers=i.trackedServers.filter((function(t){return void 0!==t.subscriptionId})),delete i.timeoutId,i.trackedServers.length<=0&&(a.callOnClosedHandlers(i),delete a.subscriptionsList[t]))}}),o),c},t.prototype.callOnClosedHandlers=function(t,e){var n,i=t.queued.closers.length,r=i>0?t.queued.closers[i-1]:null;void 0!==r&&"string"==typeof r&&(n=this.repository.getServerById(r).instance),t.handlers.onClosed.forEach((function(i){"function"==typeof i&&i({message:e||"ServerInitiated",requestArguments:t.params.arguments||{},server:n,stream:t.method})}))},t.prototype.closeSubscription=function(t){var e=this,n=this.subscriptionsList[t];"object"==typeof n&&(n.trackedServers.forEach((function(t){void 0!==t.subscriptionId&&(n.queued.closers.push(t.serverId),e.session.sendFireAndForget({type:"unsubscribe",subscription_id:t.subscriptionId,reason_uri:"",reason:Za}),delete e.subscriptionIdToLocalKeyMap[t.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,Za),delete this.subscriptionsList[t])},t}(),Xa=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.logger=n,t.on("peer-added",(function(t){return i.handlePeerAdded(t)})),t.on("peer-removed",(function(t){return i.handlePeerRemoved(t)})),t.on("methods-added",(function(t){return i.handleMethodsAddedMessage(t)})),t.on("methods-removed",(function(t){return i.handleMethodsRemovedMessage(t)})),this.streaming=new $a(t,e,n)}return t.prototype.subscribe=function(t,e,n,i,r,o){this.streaming.subscribe(t,e,n,i,r,o)},t.prototype.invoke=function(t,e,n,i){var r=this,o=i.id,s={type:"call",server_id:o,method_id:e.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:t,serverId:o}).then((function(t){return r.handleResultMessage(t)})).catch((function(t){return r.handleInvocationError(t)}))},t.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},t.prototype.handlePeerAdded=function(t){var e=t.new_peer_id,n=t.identity,i=!t.meta||t.meta.local,r=Number(n.process),o={machine:n.machine,pid:isNaN(r)?n.process:r,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:e,api:n.api,isLocal:i};this.repository.addServer(o,e)},t.prototype.handlePeerRemoved=function(t){var e=t.removed_id,n=t.reason;this.repository.removeServerById(e,n)},t.prototype.handleMethodsAddedMessage=function(t){var e=this,n=t.server_id;t.methods.forEach((function(t){e.repository.addServerMethod(n,t)}))},t.prototype.handleMethodsRemovedMessage=function(t){var e=this,n=t.server_id,i=t.methods,r=this.repository.getServerById(n);Object.keys(r.methods).forEach((function(t){var o=r.methods[t];i.indexOf(o.gatewayId)>-1&&e.repository.removeServerMethod(n,t)}))},t.prototype.handleResultMessage=function(t){var e=t._tag.invocationId,n=t.result,i=t._tag.serverId;return{invocationId:e,result:n,instance:this.repository.getServerById(i).instance,status:ka.Success,message:""}},t.prototype.handleInvocationError=function(t){if(this.logger.debug("handle invocation error "+JSON.stringify(t)),"_tag"in t){var e=t._tag.invocationId,n=t._tag.serverId,i=this.repository.getServerById(n),r=t.reason;return{invocationId:e,result:t.context,instance:i.instance,status:ka.Error,message:r}}return{invocationId:"",message:t.message,status:ka.Error,error:t}},t}();function Qa(t,e,n,i,r,o){var s,a=r.logger.subLogger("gw3-protocol"),c=new Promise((function(t){s=t})),u=e.domain("agm",["subscribed"]),d=new Ja(u,n,i,a.subLogger("server")),p=new Xa(u,n,a.subLogger("client"));return u.onJoined((function(r){n.addServer(t,e.peerId),r?function(){a.info("reconnected - will replay registered methods and subscriptions");for(var t=0,e=p.drainSubscriptions();t<e.length;t++){var n=e[t],r=n.method,s=Object.assign({},n.params);a.info("trying to re-subscribe to method "+r.name),o.client.subscribe(r,s,void 0,void 0,n)}var c=i.getList();i.reset();for(var u=0,d=c;u<d.length;u++){var h=d[u],f=h.definition;a.info("re-publishing method "+f.name),h.stream?o.server.createStream(f,h.streamCallbacks,void 0,void 0,h.stream):h.theFunction&&h.theFunction.userCallback?o.register(f,h.theFunction.userCallback):h.theFunction&&h.theFunction.userCallbackAsync&&o.registerAsync(f,h.theFunction.userCallbackAsync)}}():s&&(s({client:p,server:d}),s=void 0)})),u.onLeft((function(){n.reset()})),u.join(),c}var tc=function(){function t(t){var e=this;if(void 0===t)throw new Error("configuration is required");if(void 0===t.connection)throw new Error("configuration.connections is required");var n,i=t.connection;if("number"!=typeof t.methodResponseTimeout&&(t.methodResponseTimeout=3e4),"number"!=typeof t.waitTimeoutMs&&(t.waitTimeoutMs=3e4),Wa.API=this,this.instance=new Wa(void 0,i).unwrap(),this.clientRepository=new Ba(t.logger.subLogger("cRep")),this.serverRepository=new qa,3!==i.protocolVersion)throw new Error("protocol "+i.protocolVersion+" not supported");n=Qa(this.instance,i,this.clientRepository,this.serverRepository,t,this),this.readyPromise=n.then((function(n){return e.protocol=n,e.client=new Ma(e.protocol,e.clientRepository,e.instance,t),e.server=new Na(e.protocol,e.serverRepository),e}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.serverRemoved=function(t){return this.client.serverRemoved(t)},t.prototype.serverAdded=function(t){return this.client.serverAdded(t)},t.prototype.serverMethodRemoved=function(t){return this.client.serverMethodRemoved(t)},t.prototype.serverMethodAdded=function(t){return this.client.serverMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.client.methodRemoved(t)},t.prototype.methodAdded=function(t){return this.client.methodAdded(t)},t.prototype.methodsForInstance=function(t){return this.client.methodsForInstance(t)},t.prototype.methods=function(t){return this.client.methods(t)},t.prototype.servers=function(t){return this.client.servers(t)},t.prototype.subscribe=function(t,e,n,i){return this.client.subscribe(t,e,n,i)},t.prototype.createStream=function(t,e,n,i){return this.server.createStream(t,e,n,i)},t.prototype.unregister=function(t){return this.server.unregister(t)},t.prototype.registerAsync=function(t,e){return this.server.registerAsync(t,e)},t.prototype.register=function(t,e){return this.server.register(t,e)},t.prototype.invoke=function(t,e,n,i,r,o){return this.client.invoke(t,e,n,i,r,o)},t}(),ec=["subscribed","success"],nc=function(){function t(t,e){var n=this;this.publish=function(t,e,i){var r=i||{},o=r.routingKey,s=r.target,a=n.removeEmptyValues({type:"publish",topic:t,data:e,peer_id:n.peerId,routing_key:o,target_identity:s});n.session.send(a)},this.subscribe=function(t,e,i){return new Promise((function(r,o){var s=i||{},a=s.routingKey,c=s.target,u=n.removeEmptyValues({type:"subscribe",topic:t,peer_id:n.peerId,routing_key:a,source:c});n.session.send(u).then((function(i){var o=i.subscription_id;n.subscriptions.push({subscription_id:o,topic:t,callback:e,source:c}),r({unsubscribe:function(){return n.session.send({type:"unsubscribe",subscription_id:o,peer_id:n.peerId}),n.subscriptions=n.subscriptions.filter((function(t){return t.subscription_id!==o})),Promise.resolve()}})})).catch((function(t){return o(t)}))}))},this.watchOnEvent=function(){n.session.on("event",(function(t){var e=t.data,i=t.subscription_id,r=t["publisher-identity"],o=n.subscriptions.find((function(t){return t.subscription_id===i}));o&&(o.source?n.keysMatch(o.source,r)&&o.callback(e,o.topic,r):o.callback(e,o.topic,r))}))},this.connection=t,this.logger=e,this.peerId=t.peerId,this.subscriptions=[],this.session=t.domain("bus",ec),this.readyPromise=this.session.join(),this.readyPromise.then((function(){n.watchOnEvent()}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.removeEmptyValues=function(t){var e={};return Object.keys(t).forEach((function(n){void 0!==t[n]&&null!==t[n]&&(e[n]=t[n])})),e},t.prototype.keysMatch=function(t,e){var n=Object.keys(t),i=!0;return n.forEach((function(n){t[n]!==e[n]&&(i=!1)})),i},t}(),ic=function(t,e){var n,i=Cs.getGDMajorVersion(),r=Promise.resolve();if(i){if(i<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");i>=3&&(n=window.glue42gd,r=window.gdPreloadPromise||r)}var o,s,a,c,u,d,p,h=Ps("glue"),f=ya(t=t||{},e=e||{},n),l={};function v(t,e,n){(p=a.canPublish("trace"))&&a.trace("registering "+t+" module");var i=function(){e.initTime=n.stop(),e.initEndTime=n.endTime,e.marks=n.marks,p&&a.trace(t+" is ready - "+(n.endTime-n.startTime))};e.initStartTime=n.startTime,e.ready?e.ready().then((function(){i()})):i(),Array.isArray(t)||(t=[t]),t.forEach((function(t){l[t]=e,ic[t]=e}))}function g(){var t=Ps("interop"),e={connection:o,logger:a.subLogger("interop")};return s=new tc(e),ea.Interop=s,v(["interop","agm"],s,t),Promise.resolve()}function y(){var t=f.activities&&3===o.protocolVersion;if(f.contexts||t){var e=Ps("contexts");return v("contexts",u=new Aa({connection:o,logger:a.subLogger("contexts")}),e),u}var n=o.replayer;n&&n.drain(va.name)}function m(){return Qo(this,void 0,void 0,(function(){var t;return ts(this,(function(e){return f.bus?(t=Ps("bus"),v("bus",d=new nc(o,a.subLogger("bus")),t),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function w(t){try{return t.forEach((function(t){!function(t,e){var n=Ps(t),i=e(l);i&&v(t,i,n)}(t.name,t.create)})),Promise.resolve()}catch(t){return Promise.reject(t)}}return r.then((function(){var t,e=Ps("logger");return(a=new ea(""+(null===(t=f.connection.identity)||void 0===t?void 0:t.application),void 0,f.customLogger)).consoleLevel(f.logger.console),a.publishLevel(f.logger.publish),a.canPublish("debug")&&a.debug("initializing glue..."),v("logger",a,e),Promise.resolve(void 0)})).then((function(){var t=Ps("connection");o=new Qs(f.connection,a.subLogger("connection"));var e=Promise.resolve(f.auth);return f.connection&&!f.auth&&(e=n?n.getGWToken().then((function(t){return{gatewayToken:t}})):Promise.reject("You need to provide auth information")),e.then((function(e){var n;if(t.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(e))throw new Error("Invalid auth object - "+JSON.stringify(e));return n=e,o.login(n)})).then((function(){return v("connection",o,t),f})).catch((function(t){throw o&&o.logout(),t}))})).then((function(){return Promise.all([(s=Ps("metrics"),u=f.metrics,d=null==n?void 0:n.getMetricsPublishingEnabled,p=f.connection.identity,h=d||function(){return!0},l=null!==(t="boolean"!=typeof u&&u.disableAutoAppSystem)&&void 0!==t&&t,v("metrics",c=_s({connection:u?o:void 0,logger:a.subLogger("metrics"),canUpdateMetric:h,system:"Glue42",service:null!==(e=null==p?void 0:p.service)&&void 0!==e?e:"metrics-service",instance:null!==(r=null!==(i=null==p?void 0:p.instance)&&void 0!==i?i:null==p?void 0:p.windowId)&&void 0!==r?r:Ys(),disableAutoAppSystem:l,pagePerformanceMetrics:"boolean"!=typeof u?null==u?void 0:u.pagePerformanceMetrics:void 0}),s),Promise.resolve()),g(),y(),m()]);var t,e,i,r,s,u,d,p,h,l})).then((function(){return s.readyPromise})).then((function(){return w(f.libs||[])})).then((function(){var t=Object.keys(l).map((function(t){var e=l[t];return e.ready?e.ready():Promise.resolve()}));return Promise.all(t)})).then((function(){var i={coreVersion:ga,version:f.version};h.stop();var r={feedback:function(t){s&&s.invoke("T42.ACS.Feedback",t,"best")},info:i,logger:a,interop:s,agm:s,connection:o,metrics:c,contexts:u,bus:d,version:f.version,userConfig:t,done:function(){return null==a||a.info("done called by user..."),o.logout()}};if(r.performance={get glueVer(){return f.version},get glueConfig(){return JSON.stringify(t)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var t=Ts;return Object.keys(t).map((function(e){var n=t[e];return{name:e,duration:n.endTime-n.startTime,marks:n.marks}}))}},Object.keys(l).forEach((function(t){var e=l[t];r[t]=e})),r.config={},Object.keys(f).forEach((function(t){r.config[t]=f[t]})),e&&e.extOptions&&Object.keys(e.extOptions).forEach((function(t){r.config[t]=null==e?void 0:e.extOptions[t]})),(null==e?void 0:e.enrichGlue)&&e.enrichGlue(r),n&&n.updatePerfData&&n.updatePerfData(r.performance),r.agm){var p=function(t,e,n){return function(){r.logger.warn("glue.js - 'glue.agm."+e+"' method is deprecated, use 'glue.interop."+n+"' instead."),t.apply(r.agm,arguments)}},v=r.agm;v.method_added=p(r.agm.methodAdded,"method_added","methodAdded"),v.method_removed=p(r.agm.methodRemoved,"method_removed","methodRemoved"),v.server_added=p(r.agm.serverAdded,"server_added","serverAdded"),v.server_method_aded=p(r.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),v.server_method_removed=p(r.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return r})).catch((function(t){return Promise.reject({err:t,libs:l})}))};"undefined"!=typeof window&&(window.GlueCore=ic),ic.version=ga,ic.default=ic;var rc,oc=(rc=ic,function(t){return Hi(void 0,void 0,void 0,(function(){var e,n,i,r,o,s,a,c,u,d,p,h,f,l,v,g,y,m,w,b,_,I,S,x,k,C,A,T;return Ui(this,(function(P){switch(P.label){case 0:return[4,(M=t,Hi(void 0,void 0,void 0,(function(){var t,e,n,i;return Ui(this,(function(r){switch(r.label){case 0:return[4,Co(M=null!=M?M:{})];case 1:return t=r.sent(),(e=Gi(Gi(Gi({},ko),t.glue),M)).worker=e.assets.location+"/"+So,"string"==typeof(null==e?void 0:e.extends)&&(n=e.extends.lastIndexOf("/"),i=e.extends.substr(0,n+1)+So,e.worker=i),t.layouts||(t.layouts={remoteType:"json"}),[2,Gi(Gi({},t),{glue:e})]}}))})))];case 1:if(e=P.sent(),n="undefined"!=typeof window,i=(null===(l=e.glue)||void 0===l?void 0:l.channels)||!1,r=(null===(v=e.glue)||void 0===v?void 0:v.appManager)||!1,n&&(null==(o=window)?void 0:o.glue42gd)&&(null==o?void 0:o.Glue))return[2,o.Glue({windows:!0,logger:null===(g=e.glue)||void 0===g?void 0:g.logger,channels:i,layouts:!0,appManager:r,libraries:t.libraries})];if(s=new lr,u={libs:[{name:"notifications",create:function(t){return new _o(t.interop)}}],version:Vi},i&&(d={name:"channels",create:function(t){return new so(t.contexts,e.channels)}},null===(y=u.libs)||void 0===y||y.push(d)),n&&(null===(m=u.libs)||void 0===m||m.push({name:"windows",create:function(t){return a=new wr(t.interop,s)}},{name:"layouts",create:function(t){var n,i,r;if("json"===(null===(n=e.layouts)||void 0===n?void 0:n.remoteType)){var o=(null===(i=null==e?void 0:e.glue.assets)||void 0===i?void 0:i.location)||Io;r=new zo(o)}var u=new Jo,d=new Ko,p=new Po(u,d,r);return c=new To(p,a,s,t.interop,null==e?void 0:e.glue),new io(c)}}),r&&(p={name:"appManager",create:function(t){var n;return new bo(a,t.interop,s,e.appManager,null===(n=e.glue)||void 0===n?void 0:n.application)}},null===(w=u.libs)||void 0===w||w.push(p))),h={gateway:{sharedWorker:null!==(_=null===(b=e.glue)||void 0===b?void 0:b.worker)&&void 0!==_?_:"/glue/worker.js",inproc:null===(I=e.glue)||void 0===I?void 0:I.inproc},logger:null===(S=e.glue)||void 0===S?void 0:S.logger,application:null===(x=e.glue)||void 0===x?void 0:x.application},n&&!window.SharedWorker)throw new Error("Cannot initialize Glue Web, because this environment does not support Shared Workers");return[4,co((function(){return rc(h,u)}),1e4,"Glue Web initialization timed out")];case 2:return f=P.sent(),(null==t?void 0:t.libraries)?[4,Promise.all(t.libraries.map((function(t){return t(f,null==e?void 0:e.glue)})))]:[3,4];case 3:P.sent(),P.label=4;case 4:return s.start(f.interop,f.logger.subLogger("control")),n?[4,mr(f.windows.my(),f.interop,null===(k=f.appManager)||void 0===k?void 0:k.myInstance)]:[3,9];case 5:return P.sent(),(null===(A=null===(C=e.glue)||void 0===C?void 0:C.layouts)||void 0===A?void 0:A.autoRestore)?[4,null==c?void 0:c.restoreAutoSavedLayout()]:[3,7];case 6:P.sent(),P.label=7;case 7:return[4,Yo(f,null!==(T=e.glue)&&void 0!==T?T:{},s,c)];case 8:P.sent(),P.label=9;case 9:return[2,f]}var M}))}))});if("undefined"!=typeof window){var sc=window;sc.GlueWeb=oc,delete sc.GlueCore}oc.default=oc,oc.version=Vi;const ac={application:window.fdc3AppName,appManager:!0,context:!0,intents:!0,channels:!0,agm:!0},cc=()=>new Promise(e=>{let r;const o=()=>t(void 0,void 0,void 0,(function*(){const t=yield n();0!==t.length&&i(t[0])||(clearInterval(r),e())}));r=setInterval(o,300),o()}),uc=(()=>{(t=>{if(r)window.gluePromise=oc(ac).then(t=>(window.glue=t,cc())).then(()=>window.glue);else{const e=new Promise(t=>{let e;const n=()=>{window.glue42gd&&(clearInterval(e),t())};e=setInterval(n,300),n()});window.gluePromise=e.then(()=>(window.Glue||Bi)(t||ac)).then(t=>(window.glue=t,cc())).then(()=>window.glue)}})();const t=(()=>{const t=p(),e=r?h():f(),n=c();return Object.assign(Object.assign(Object.assign({},t),e),n)})();return Object.assign(Object.assign({},t),{version:"1.1.4"})})();return window.fdc3=uc,uc.default=uc,uc}));
//# sourceMappingURL=fdc3-glue42.js.map
